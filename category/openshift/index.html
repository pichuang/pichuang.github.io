
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/category/openshift/">
      
      
        <link rel="prev" href="../openai/">
      
      
        <link rel="next" href="../personal/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>openshift - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#openshift" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel 🎥 </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              openshift
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-4-etcd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之二
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-4-etcd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-pod-container" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift Pod 與 Container 的愛恨情仇
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-v4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift v4 東西南北向網路流
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-v311" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift v3.11 東西南北向網路探討
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-services-pods" class="md-nav__link">
    <span class="md-ellipsis">
      
        從 Red Hat OpenShift 外部訪問 Services 或 Pods
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="openshift">openshift</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-29 00:00:00">May 29, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-4-etcd"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之二</a></h2>
<p>承襲上文 <a href="https://blog.pichuang.com.tw/20200528-openshift-etcd-operator-1/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a>，繼續針對硬碟的部分進行調整，畢竟 etcd 對<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/hardware.md#disks">硬碟</a> IOPS 相當要求，建議用 SSD 比較好</p>
<p>沒意外的，開場分享個 <a href="https://www.openshift.com/blog/deploying-openshift-4.4-to-vmware-vsphere-7">Deploying OpenShift 4.4 to VMware vSphere 7</a>，整體上比較重要的是利用 VMware vSphere 7 裡面的 DRS (Dynamic Resource Scheduler) 及 NSX-T 的部分，之後有機會再說</p>
<p>{% youtube PdyNQXpYknI %}</p>
<!--more-->

<h3 id="etcd"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#etcd">etcd 節點硬碟調教</a></h3>
<blockquote>
<p>ionice: set or get process I/O scheduling class and priority</p>
</blockquote>
<p>這邊使用 <a href="https://www.systutorials.com/docs/linux/man/1-ionice/">ionice (1) - Linux Man Pages</a> 來完成這件事，剛好 CoreOS 內建有支援這個指令 XD，差點就要包一個 Container 而且要蠻高的權限 (需要 root) 去定期執行了</p>
<h4 id="before"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#before">Before</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>pgrep<span class="w"> </span>etcd
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="m">740369</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="m">740441</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ps<span class="w"> </span>uax<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="m">740369</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>root<span class="w">      </span><span class="m">740369</span><span class="w">  </span><span class="m">7</span>.6<span class="w">  </span><span class="m">8</span>.4<span class="w"> </span><span class="m">9672968</span><span class="w"> </span><span class="m">1382392</span><span class="w"> </span>?<span class="w">     </span>Ssl<span class="w">  </span><span class="m">17</span>:05<span class="w">   </span><span class="m">4</span>:25<span class="w"> </span>etcd<span class="w"> </span>--initial-advertise-peer-urls<span class="o">=</span>https://10.0.97.3:2380<span class="w"> </span>--cert-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving/etcd-serving-control-plane-2.crt<span class="w"> </span>--key-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving/etcd-serving-control-plane-2.key<span class="w"> </span>--trusted-ca-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/configmaps/etcd-serving-ca/ca-bundle.crt<span class="w"> </span>--client-cert-auth<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--peer-cert-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.crt<span class="w"> </span>--peer-key-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.key<span class="w"> </span>--peer-trusted-ca-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/configmaps/etcd-peer-client-ca/ca-bundle.crt<span class="w"> </span>--peer-client-cert-auth<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--advertise-client-urls<span class="o">=</span>https://10.0.97.3:2379<span class="w"> </span>--listen-client-urls<span class="o">=</span>https://0.0.0.0:2379<span class="w"> </span>--listen-peer-urls<span class="o">=</span>https://0.0.0.0:2380<span class="w"> </span>--listen-metrics-urls<span class="o">=</span>https://0.0.0.0:9978
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>core<span class="w">      </span><span class="m">901685</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12760</span><span class="w">  </span><span class="m">1076</span><span class="w"> </span>pts/0<span class="w">    </span>S+<span class="w">   </span><span class="m">18</span>:03<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span><span class="m">740369</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ps<span class="w"> </span>uax<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>root<span class="w">      </span><span class="m">740441</span><span class="w">  </span><span class="m">0</span>.9<span class="w">  </span><span class="m">0</span>.1<span class="w"> </span><span class="m">124764</span><span class="w"> </span><span class="m">25288</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">17</span>:05<span class="w">   </span><span class="m">0</span>:32<span class="w"> </span>etcd<span class="w"> </span>grpc-proxy<span class="w"> </span>start<span class="w"> </span>--endpoints<span class="w"> </span>https://10.0.97.3:9978<span class="w"> </span>--metrics-addr<span class="w"> </span>https://0.0.0.0:9979<span class="w"> </span>--listen-addr<span class="w"> </span><span class="m">127</span>.0.0.1:9977<span class="w"> </span>--key<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.key<span class="w"> </span>--key-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving-metrics/etcd-serving-metrics-control-plane-2.key<span class="w"> </span>--cert<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.crt<span class="w"> </span>--cert-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving-metrics/etcd-serving-metrics-control-plane-2.crt<span class="w"> </span>--cacert<span class="w"> </span>/etc/kubernetes/static-pod-certs/configmaps/etcd-peer-client-ca/ca-bundle.crt<span class="w"> </span>--trusted-ca-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/configmaps/etcd-metrics-proxy-serving-ca/ca-bundle.crt
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>core<span class="w">      </span><span class="m">902165</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12760</span><span class="w">  </span><span class="m">1060</span><span class="w"> </span>pts/0<span class="w">    </span>S+<span class="w">   </span><span class="m">18</span>:03<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1"># Get priority and class</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-p<span class="w"> </span><span class="m">740369</span><span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>none:<span class="w"> </span>prio<span class="w"> </span><span class="m">4</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>none:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h4 id="tuning"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#tuning">Tuning</a></h4>
<p>我們可以直接登入 CoreOS 後下 <code>ionice</code> 對特定 PID 和硬碟處理權限拉高，可以搭配 ansible 來針對 master node 執行</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Set priority and class</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-c2<span class="w"> </span>-n0<span class="w"> </span>-p<span class="w"> </span><span class="sb">`</span>pgrep<span class="w"> </span>etcd<span class="sb">`</span>
</code></pre></div>
  - <code>-c2</code>: best-effort
  - <code>-n0</code>: the highest priority level</p>
<h4 id="after"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#after">After</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>pgrep<span class="w"> </span>etcd
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="m">740369</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="m">740441</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-p<span class="w"> </span><span class="m">740369</span><span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>best-effort:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>best-effort:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h3 id="_1"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#_1">後話</a></h3>
<p>恩...反正裝 etcd 的那個節點之硬碟選用高 IOPS，例如用 SSD，效率和穩定性會提升不少</p>
<h3 id="references"><a class="toclink" href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#references">References</a></h3>
<ul>
<li><a href="https://www.systutorials.com/docs/linux/man/1-ionice/">ionice (1) - Linux Man Pages</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/architecture/architecture-rhcos.html">machineconfig</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/111245626">etcd 性能测试与调优</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/nodes/jobs/nodes-pods-daemonsets.html">Running background tasks on nodes automatically with daemonsets</a></li>
<li><a href="https://rancher.com/docs/rancher/v2.x/en/installation/options/etcd/">Tuning etcd for Large Installations - Rancher</a></li>
<li><a href="https://blog.pichuang.com.tw/20200528-openshift-etcd-operator-1/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/hardware.md#disks">etcd - hardware</a></li>
<li><a href="https://www.openshift.com/blog/deploying-openshift-4.4-to-vmware-vsphere-7">Deploying OpenShift 4.4 to VMware vSphere 7</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-28 00:00:00">May 28, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-4-etcd"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a></h2>
<p>打從 OpenShift 4 之後，etcd 的安裝變成是透過 <code>etcd-operator</code> 來進行安裝的，預設狀況下一次會建立 3 個 etcd instances，然後把他們弄成一個 etcd cluster，本文會記錄一些關於 OpenShift 跟 etcd 之間的一些操作記錄</p>
<p><img alt="" src="/images/etcd-operator-overview.png" /></p>
<!--more-->

<h3 id="oc-etcd"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#oc-etcd">透過 oc 檢查 etcd 狀態</a></h3>
<p>核心中的核心，正常狀態下一定是要好的，它的穩定性會直接關聯到 etcd 叢集的穩定性，兩點之間建議須低於 <code>&gt;100ms</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>openshift-etcd<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>etcd
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>etcd-control-plane-0<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.1<span class="w">     </span>control-plane-0<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>etcd-control-plane-1<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.2<span class="w">     </span>control-plane-1<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>etcd-control-plane-2<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.3<span class="w">     </span>control-plane-2<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<h3 id="etcd"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcd">檢查 etcd 叢集狀態</a></h3>
<p>採用跟前一篇介紹的方法 <a href="https://blog.pichuang.com.tw/20200521-openshift-with-coreos-part-7/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a> 進行 <code>etcdctl</code> 的基礎操作</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-n<span class="w"> </span>openshift-etcd<span class="w"> </span>etcd-control-plane-0
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Defaulting<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>etcdctl.
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Use<span class="w"> </span><span class="s1">&#39;oc describe pod/etcd-control-plane-0 -n openshift-etcd&#39;</span><span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>all<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>containers<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span>pod.
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>version
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>etcdctl<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3.18
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>API<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>status<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="p">|</span><span class="w">        </span>ENDPOINT<span class="w">        </span><span class="p">|</span><span class="w">        </span>ID<span class="w">        </span><span class="p">|</span><span class="w"> </span>VERSION<span class="w"> </span><span class="p">|</span><span class="w"> </span>DB<span class="w"> </span>SIZE<span class="w"> </span><span class="p">|</span><span class="w"> </span>IS<span class="w"> </span>LEADER<span class="w"> </span><span class="p">|</span><span class="w"> </span>RAFT<span class="w"> </span>TERM<span class="w"> </span><span class="p">|</span><span class="w"> </span>RAFT<span class="w"> </span>INDEX<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>8e7cdeadd4c04bd3<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>65124c220e1d1efa<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="nb">false</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>23675b8f347a5bea<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="nb">false</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>health<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="p">|</span><span class="w">        </span>ENDPOINT<span class="w">        </span><span class="p">|</span><span class="w"> </span>HEALTH<span class="w"> </span><span class="p">|</span><span class="w">    </span>TOOK<span class="w">     </span><span class="p">|</span><span class="w"> </span>ERROR<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">12</span>.52718ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">16</span>.830977ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">21</span>.484222ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>list<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>+------------------+---------+-----------------+------------------------+------------------------+
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="p">|</span><span class="w">        </span>ID<span class="w">        </span><span class="p">|</span><span class="w"> </span>STATUS<span class="w">  </span><span class="p">|</span><span class="w">      </span>NAME<span class="w">       </span><span class="p">|</span><span class="w">       </span>PEER<span class="w"> </span>ADDRS<span class="w">       </span><span class="p">|</span><span class="w">      </span>CLIENT<span class="w"> </span>ADDRS<span class="w">      </span><span class="p">|</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>+------------------+---------+-----------------+------------------------+------------------------+
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="p">|</span><span class="w"> </span>23675b8f347a5bea<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-2<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="p">|</span><span class="w"> </span>65124c220e1d1efa<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="p">|</span><span class="w"> </span>8e7cdeadd4c04bd3<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-0<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>+------------------+---------+-----------------+------------------------+------------------------+
</code></pre></div>
<h3 id="etcdctl"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcdctl">使用 etcdctl 原生效能檢查</a></h3>
<p>承上，你也可以直接使用 etcdctl 做一個 60 秒的檢測，
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>check<span class="w"> </span>perf<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w"> </span><span class="m">60</span><span class="w"> </span>/<span class="w"> </span><span class="m">60</span><span class="w"> </span>Boooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo!<span class="w"> </span><span class="m">100</span>.00%1m0s
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>PASS:<span class="w"> </span>Throughput<span class="w"> </span>is<span class="w"> </span><span class="m">150</span><span class="w"> </span>writes/s
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>PASS:<span class="w"> </span>Slowest<span class="w"> </span>request<span class="w"> </span>took<span class="w"> </span><span class="m">0</span>.134647s
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>PASS:<span class="w"> </span>Stddev<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.003738s
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>PASS
</code></pre></div></p>
<h3 id="_1"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#_1">關於預設參數</a></h3>
<p>透過 <code>oc describe pod/etcd-control-plane-0 -n openshift-etcd</code> 可知，</p>
<ol>
<li>ETCD 選舉超時預設時間 (ETCD_ELECTION_TIMEOUT): 1000ms</li>
<li>ETCD 心跳間隔預設時間 (ETCD_HEARTBEAT_INTERVAL): 100ms</li>
</ol>
<p>etcd 的分散式一致性協定仰賴上述 2 個參數來保證節點之間能夠在部分節點斷線的狀況下依然能夠正確處理 Leader Node 的選舉。</p>
<p>依據 <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a> 及個人經驗可知，<code>ETCD_HEARTBEAT_INTERVAL</code>，即由 Leader 節點通知其他節點 <code>它還是 Leader</code> 的頻率，建議設定為 2 個節點之間 RTT 最大值時間 * 1 ~ 1.5 倍，若該值設定太短，etcd 會發送無用的心跳確認訊息，反而增加 CPU / Network / Disk 無謂的資源消耗；若該值設定太長，就會導致監控節點異常時間過長，會有重新選舉的事情發生。判斷 RTT 的最簡單方式就是使用 ping，如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># 登入節點</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>node/control-plane-0
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Starting<span class="w"> </span>pod/control-plane-0-debug<span class="w"> </span>...
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>To<span class="w"> </span>use<span class="w"> </span>host<span class="w"> </span>binaries,<span class="w"> </span>run<span class="w"> </span><span class="sb">`</span>chroot<span class="w"> </span>/host<span class="sb">`</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.0.97.1
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>sh-4.2#<span class="w"> </span>chroot<span class="w"> </span>/host
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>sh-4.4#<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span>-c60
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>PING<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span><span class="o">(</span><span class="m">10</span>.0.97.5<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.191<span class="w"> </span>ms
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.151<span class="w"> </span>ms
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.213<span class="w"> </span>ms
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>...omit...
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">59</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.142<span class="w"> </span>ms
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">60</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.204<span class="w"> </span>ms
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>---<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="m">60</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">60</span><span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss,<span class="w"> </span><span class="nb">time</span><span class="w"> </span>59000ms
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>rtt<span class="w"> </span>min/avg/max/mdev<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.112/0.212/0.435/0.054<span class="w"> </span>ms
</code></pre></div>
<p>如上面數字表現，RTT 測試出來是 <code>0.435ms</code>，遠低於預設值 <code>100ms</code>，所以就不用特別改</p>
<p><code>ETCD_ELECTION_TIMEOUT</code>，則是表示如果節點等待多久沒收到 Leader 的心跳確認的話，就會開始嘗試去競選 Leader 的位子，建議設定為 2 個節點之間 RTT 最大值時間 * 10，以應對網路變化，故如果原有 RTT 為 100ms 的話，則選舉超時設定則為 1000ms。</p>
<p>另外選舉超時建議上限值為 50,000 ms，心跳間隔上限值為 5,000 ms</p>
<h3 id="etcd-database"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcd-database">備份 etcd database</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>core@control-plane-1<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa_ocp4_vcenter.pub
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>Last<span class="w"> </span>login:<span class="w"> </span>Wed<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">16</span>:49:17<span class="w"> </span><span class="m">2020</span><span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.100
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1"># Backup</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>-E<span class="w"> </span>/usr/local/bin/cluster-backup.sh<span class="w"> </span>./assets/backup
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>385e44c057e47b6fe0b02d534dc4cb452056d33f9174271d1ecced45bc317e50
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>etcdctl<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3.18
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>API<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-apiserver-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-apiserver-pod-131
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-controller-manager-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-controller-manager-pod-13
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-scheduler-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-scheduler-pod-17
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>found<span class="w"> </span>latest<span class="w"> </span>etcd-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/etcd-pod-139
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>Snapshot<span class="w"> </span>saved<span class="w"> </span>at<span class="w"> </span>./assets/backup/snapshot_2020-05-27_165016.db
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>snapshot<span class="w"> </span>db<span class="w"> </span>and<span class="w"> </span>kube<span class="w"> </span>resources<span class="w"> </span>are<span class="w"> </span>successfully<span class="w"> </span>saved<span class="w"> </span>to<span class="w"> </span>./assets/backup
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="c1"># Check</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>./assets/backup/
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>backup<span class="o">]</span>$<span class="w"> </span>ls
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>snapshot_2020-05-27_165016.db<span class="w">  </span>static_kuberesources_2020-05-27_165016.tar.gz
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="c1"># Copy to outside</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>backup<span class="o">]</span>$<span class="w"> </span>scp<span class="w"> </span>snapshot_2020-05-27_165016.db<span class="w"> </span>static_kuberesources_2020-05-27_165016.tar.gz<span class="w"> </span>root@bastion.ocp4.internal:~/
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>snapshot_2020-05-27_165016.db<span class="w">                                                                                                             </span><span class="m">100</span>%<span class="w">  </span>171MB<span class="w"> </span><span class="m">135</span>.1MB/s<span class="w">   </span><span class="m">00</span>:01
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>static_kuberesources_2020-05-27_165016.tar.gz<span class="w">                                                                                             </span><span class="m">100</span>%<span class="w">   </span>64KB<span class="w">  </span><span class="m">56</span>.1MB/s<span class="w">   </span><span class="m">00</span>:00
</code></pre></div>
<p>有圖有真相</p>
<p><img alt="" src="/images/etcd-backup.png" /></p>
<h3 id="_2"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#_2">後話</a></h3>
<p>下回待續</p>
<h3 id="references"><a class="toclink" href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20200521-openshift-with-coreos-part-7/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a></li>
<li><a href="https://www.huweihuang.com/kubernetes-notes/etcd/etcdctl-v3.html">etcdctl 常用命令</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/backup_and_restore/backing-up-etcd.html">Backing up etcd</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/backup_and_restore/replacing-unhealthy-etcd-member.html#restore-replace-stopped-etcd-member_replacing-unhealthy-etcd-member">Replacing an unhealthy etcd member</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-21 00:00:00">May 21, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-pod-container"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a></h2>
<p>這幾天有位客戶問了一個很不錯的問題</p>
<blockquote>
<p>如果在 1 個 Pod 裡面，有 2 個 Containers 的狀況下，OpenShift 該如何針對特定的 Container 進行操作?</p>
</blockquote>
<p>按照 Kuberentes 的設計，Kubernetes 最小單位是 Pod，而不是 Container，然而 1 個 Pod，可以有 1 個或多個的 Container 被包含在裡面，圖示可以參考 <a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking?slide=6">20190817 Container Bare Metal for Networking</a>，但實際上遇到多個 Container 被包含在 1 個 Pods 的時候，在 OpenShift 裡面是怎麼操作的呢? 秉持著本人遵循客戶驅動服務 (Customer Driven Service)，特別寫一篇記錄</p>
<p>因為最近太累，懶得想梗圖，所以附上一個近期我覺得相當不錯的 Demo，在 OpenShift 裡面開 Windows Server 2019 起來做使用</p>
<p>{% youtube Kx110kqoHo0 %}</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#_1">走馬看花之旅: 第七天</a></h3>
<h4 id="pods-container"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#pods-container">顯示一個 Pods 裡面所包含的 Container</a></h4>
<p>預設狀況下，其實內建的 <code>api-resources</code> 並沒有包含一個類型是 <code>container</code>，所以如果要知道一個 Pod 裡面有包含多少個 Container 能用下列 2 個方式找</p>
<ol>
<li>
<p>透過 oc 指令 filter 出來
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># 先獲得到 Pod 清單，這邊選擇 productpage-v1-597b74b4c-x2pgk</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>NAME<span class="w">                             </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>details-v1-6657b8bdf-mm4r4<span class="w">       </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>productpage-v1-597b74b4c-x2pgk<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>ratings-v1-66cddbfb8f-wvpbz<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>reviews-v1-6788566f98-slm9q<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>reviews-v2-7c4bffdcc4-6wmg2<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>reviews-v3-69b6d8786-rbhw5<span class="w">       </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="c1"># oc get pods &lt;PDO NAME&gt; -o jsonpath=&#39;{.spec.containers[*].name}&#39;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>productpage-v1-597b74b4c-x2pgk<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.containers[*].name}&#39;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>productpage<span class="w"> </span>istio-proxy
</code></pre></div></p>
</li>
<li>
<p>透過 OpenShift Web Console</p>
</li>
</ol>
<p>這個做法是直接透過相當好用的 Web Console 直接觀察，直觀方便</p>
<p><img alt="" src="/images/show-containes.png" /></p>
<h4 id="container"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#container">登入其中一個 Container 裡面</a></h4>
<p>一樣也是 2 種方式</p>
<ol>
<li>透過 oc rsh 指令</li>
</ol>
<p>Red Hat OpenShift 有一個內建的指令可以做到 - <code>oc rsh</code></p>
<blockquote>
<p>oc rsh = Open a remote shell session to a container</p>
</blockquote>
<p>一般狀況下，<code>oc rsh &lt;PDO NAME&gt;</code> 都是直接連到<code>第一個</code> Container，如果要選擇裡面的第二個，更甚至是第三個的容器，則需要特別多一個 <code>--container</code> 指定，更多內容可以直接參考 <code>oc rsh -h</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Open a shell session on the container named &#39;index&#39; inside a pod</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1"># oc rsh -c &lt;CONTAINER NAME&gt; pod/&lt;PDO NAME&gt;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-c<span class="w"> </span>istio-proxy<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>sh-4.4$<span class="w"> </span>ls
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>bin<span class="w">   </span>dev<span class="w">  </span>home<span class="w">  </span>lib64<span class="w">       </span>media<span class="w">  </span>opt<span class="w">   </span>root<span class="w">  </span>sbin<span class="w">  </span>sys<span class="w">  </span>usr
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>boot<span class="w">  </span>etc<span class="w">  </span>lib<span class="w">   </span>lost+found<span class="w">  </span>mnt<span class="w">    </span>proc<span class="w">  </span>run<span class="w">   </span>srv<span class="w">   </span>tmp<span class="w">  </span>var
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-c<span class="w"> </span>productpage<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>$<span class="w"> </span>ls
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>__pycache__<span class="w">       </span>productpage.py<span class="w">    </span>static<span class="w">      </span>stdout.log<span class="w">  </span>test_productpage.py
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>microservice.log<span class="w">  </span>requirements.txt<span class="w">  </span>stderr.log<span class="w">  </span>templates
</code></pre></div>
<p>好我知道各位一定看不懂，下面有截圖</p>
<p><img alt="" src="/images/rsh-container.png" /></p>
<ol>
<li>透過 OpenShift Web Console</li>
</ol>
<p>相當直觀就是直接對 Web Console 操作，如下圖示表現</p>
<p><img alt="" src="/images/terminal-container.gif" /></p>
<h4 id="container_1"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#container_1">針對其中一個 Container 除錯</a></h4>
<p>只有一個作法，透過 Red Hat OpenShift 內建的指令 - <code>oc debug</code></p>
<blockquote>
<p>oc debug = Launch a command shell to debug a running application</p>
</blockquote>
<p>一般狀況下，如同 <code>oc rsh</code>，使用 <code>oc debug</code> 時，都是直接連到<code>第一個</code> Container，如果要選擇裡面的第二個，更甚至是第三個的容器，則需要特別多一個 <code>--container</code> 指定，更多內容可以直接參考 <code>oc debug -h</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>-c<span class="w"> </span>istio-proxy<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Starting<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk-debug<span class="w"> </span>...
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.128.2.27
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>sh-4.4$<span class="w"> </span>ls
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>bin<span class="w">   </span>dev<span class="w">  </span>home<span class="w">  </span>lib64<span class="w">       </span>media<span class="w">  </span>opt<span class="w">   </span>root<span class="w">  </span>sbin<span class="w">  </span>sys<span class="w">  </span>usr
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>boot<span class="w">  </span>etc<span class="w">  </span>lib<span class="w">   </span>lost+found<span class="w">  </span>mnt<span class="w">    </span>proc<span class="w">  </span>run<span class="w">   </span>srv<span class="w">   </span>tmp<span class="w">  </span>var
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>sh-4.4$
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>-c<span class="w"> </span>productpage<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>Starting<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk-debug<span class="w"> </span>...
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.128.2.28
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>$<span class="w"> </span>ls
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>__pycache__<span class="w">       </span>productpage.py<span class="w">    </span>static<span class="w">     </span>test_productpage.py
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>microservice.log<span class="w">  </span>requirements.txt<span class="w">  </span>templates
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>$
</code></pre></div>
<p>一樣我知道各位還是看不懂，截圖如下</p>
<p><img alt="" src="/images/debug-container.png" /></p>
<h3 id="_2"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#_2">後話</a></h3>
<p>如果有仔細看內容的話，其實我的操作環境就是建好一個 bookinfo 之後，Service Mesh 自動注入 (inject) Sidecard 進去到每一個 Pod，所以才會有 1 個 Pod 會有 2 個 Container 的現象發生，除此之外，個人經驗還有如果需要整合網路廠商所提供的 CNI Plugin，也有機會會遇到這種等級的操作</p>
<p>結論上來說，雖然 Kubernetes 最小單位是 Pod，一般操作的層級都是在這個層級，但若想在 OpenShift 上針對特定的 Container 進行指令操作、除錯，都還是可以很輕鬆地辦到，也相當的直覺</p>
<p>最後，請大家多多訂閱 Red Hat 服務、分享開源技術及開啟技術友善好環境，我們宅宅們就靠各位客戶養了 XD</p>
<h3 id="references"><a class="toclink" href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#references">References</a></h3>
<ul>
<li><a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking?slide=6">20190817 Container Bare Metal for Networking</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-13 00:00:00">April 13, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-v4"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/">Red Hat OpenShift v4 東西南北向網路流</a></h2>
<p>去年 2019/04 的時候有釋放出 <a href="https://blog.pichuang.com.tw/20190404-openshift-network-traffic-overview/">Red Hat OpenShift v3.11 東西南北向網路探討 - Phil Huang</a> 一文，過了一年後，Red Hat OpenShift 4 出了，那兩個不同大版本的網路設計有什麼樣子差異呢?</p>
<p>{% youtube DMb4L92Z7z8 %}</p>
<!--more-->

<h3 id="red-hat-openshift-4"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#red-hat-openshift-4">Red Hat OpenShift 4 東西南北向網路流</a></h3>
<p>首先先來張針對 v4 的架構圖</p>
<p><img alt="" src="/images/ocp4-network-traffic.png" /></p>
<p>以 Red Hat OpenShift 為核心視角，可以分為三段網路流</p>
<ol>
<li>北向網路流 Ingress Traffic</li>
<li>東西向網路流</li>
<li>南向網路流 Egress Traffic</li>
</ol>
<p>另外，以上這些流量，實際上都是透過每一台節點上的 <code>Node IP</code> 進行溝通的，也就是你只需要提供這些節點<code>一個 IP</code> 即可使用，意指<code>不需要指派多網卡於單一節點上</code>，那具體是哪個 IP 呢? 主要是看 <code>INTERNAL-IP</code> 那個欄位的 IP</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>NAME<span class="w">              </span>STATUS<span class="w">   </span>ROLES<span class="w">    </span>AGE<span class="w">   </span>VERSION<span class="w">   </span>INTERNAL-IP<span class="w">   </span>EXTERNAL-IP<span class="w">   </span>OS-IMAGE<span class="w">                                                       </span>KERNEL-VERSION<span class="w">                </span>CONTAINER-RUNTIME
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>compute-0<span class="w">         </span>Ready<span class="w">    </span>worker<span class="w">   </span>26d<span class="w">   </span>v1.16.2<span class="w">   </span><span class="m">10</span>.0.97.4<span class="w">     </span><span class="m">10</span>.0.97.4<span class="w">     </span>Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>CoreOS<span class="w"> </span><span class="m">43</span>.81.202003230848.0<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span><span class="w">   </span><span class="m">4</span>.18.0-147.5.1.el8_1.x86_64<span class="w">   </span>cri-o://1.16.3-28.dev.rhaos4.3.git9aad8e4.el8
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>compute-1<span class="w">         </span>Ready<span class="w">    </span>worker<span class="w">   </span>26d<span class="w">   </span>v1.16.2<span class="w">   </span><span class="m">10</span>.0.97.5<span class="w">     </span><span class="m">10</span>.0.97.5<span class="w">     </span>Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>CoreOS<span class="w"> </span><span class="m">43</span>.81.202003230848.0<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span><span class="w">   </span><span class="m">4</span>.18.0-147.5.1.el8_1.x86_64<span class="w">   </span>cri-o://1.16.3-28.dev.rhaos4.3.git9aad8e4.el8
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>control-plane-0<span class="w">   </span>Ready<span class="w">    </span>master<span class="w">   </span>26d<span class="w">   </span>v1.16.2<span class="w">   </span><span class="m">10</span>.0.97.1<span class="w">     </span><span class="m">10</span>.0.97.1<span class="w">     </span>Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>CoreOS<span class="w"> </span><span class="m">43</span>.81.202003230848.0<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span><span class="w">   </span><span class="m">4</span>.18.0-147.5.1.el8_1.x86_64<span class="w">   </span>cri-o://1.16.3-28.dev.rhaos4.3.git9aad8e4.el8
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>control-plane-1<span class="w">   </span>Ready<span class="w">    </span>master<span class="w">   </span>26d<span class="w">   </span>v1.16.2<span class="w">   </span><span class="m">10</span>.0.97.2<span class="w">     </span><span class="m">10</span>.0.97.2<span class="w">     </span>Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>CoreOS<span class="w"> </span><span class="m">43</span>.81.202003230848.0<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span><span class="w">   </span><span class="m">4</span>.18.0-147.5.1.el8_1.x86_64<span class="w">   </span>cri-o://1.16.3-28.dev.rhaos4.3.git9aad8e4.el8
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>control-plane-2<span class="w">   </span>Ready<span class="w">    </span>master<span class="w">   </span>26d<span class="w">   </span>v1.16.2<span class="w">   </span><span class="m">10</span>.0.97.3<span class="w">     </span><span class="m">10</span>.0.97.3<span class="w">     </span>Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>CoreOS<span class="w"> </span><span class="m">43</span>.81.202003230848.0<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span><span class="w">   </span><span class="m">4</span>.18.0-147.5.1.el8_1.x86_64<span class="w">   </span>cri-o://1.16.3-28.dev.rhaos4.3.git9aad8e4.el8
</code></pre></div>
<h4 id="ingress-traffic"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#ingress-traffic">北向: Ingress Traffic</a></h4>
<p>Ingress 主要的目的就是讓外部使用者可以透過 Ingress Controller 以接觸到 Kubernestes 裡面的 Service，而在 Red Hat OpenShift 裡面的術語則是使用 Router 來做闡述</p>
<p>隨著各式各樣的服務都在 OpenShift 4 上都被實作成 Operator Framework，當然連 Ingress Controller 也不例外，詳細可以參考<a href="https://docs.openshift.com/container-platform/4.3/networking/configuring_ingress_cluster_traffic/overview-traffic.html">Configuring ingress cluster traffic overview - OpenShift 4.3</a></p>
<p>從外部連到到 OpenShift 上 Service 的方式主要有 4 種方式</p>
<ol>
<li>使用 OpenShift Router</li>
<li>使用 Service Type: LoadBalancer</li>
<li>使用 externalIngressIP</li>
<li>使用 nodePort</li>
</ol>
<p>詳細可以參考 <a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></p>
<h4 id="east-west-traffic"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#east-west-traffic">東西向: East-West Traffic</a></h4>
<p>在 Red Hat OpenShift 平台底下，無論是要跨 Pod / Service / Host 進行橫向的溝通，都是需要有 CNI (Cotainer Network Interface) 的實踐才能將不同主機之間的連線建立起來。CNI 本身是一套標準，實作上就會有百花齊放的專案可供使用，詳細可參考 <a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking">20190817 Container Bare Metal for Networking</a></p>
<p><img alt="" src="/images/ocp-multus.png" /></p>
<p>預設安裝下，<code>Multus CNI</code> 會被安裝在 OpenShift 4 裡面，當然也可以不安裝把它關掉，請參考 <a href="https://access.redhat.com/solutions/4850181">KB4850181: How to install OpenShift 4 without Multus in place</a></p>
<p>而原生必須安裝的 OpenShift SDN CNI 主要有 2 個可以使用:</p>
<ol>
<li>OpenShiftSDN (預設)</li>
<li>OVNKubernetes (4.5 GA)</li>
</ol>
<p>其他第三方供應商的 CNI Plugin 就不細列了</p>
<p>而如果有需要實踐 <a href="https://docs.openshift.com/container-platform/4.3/networking/multiple_networks/understanding-multiple-networks.html">Multiple Networks</a> 則可以選擇 5 種 CNI Plugin 之一掛載</p>
<ol>
<li>bridge</li>
<li>host-device</li>
<li>macvlan</li>
<li>ipvlan</li>
<li><a href="https://docs.openshift.com/container-platform/4.3/networking/hardware_networks/about-sriov.html">SR-IOV</a></li>
</ol>
<h3 id="openshift-311"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#openshift-311">與 OpenShift 3.11 的網路差異</a></h3>
<ol>
<li>於 4 代，Web Console 由 <code>Infra Node</code> 上的 <code>OpenShift Router</code> 提供，而不是透過 <code>Master Node</code> 提供</li>
<li>於 4 代，OpenShift Router 的功能，放置在 <code>openshift-ingress-operator</code>，而不是放置在 <code>default</code></li>
<li>於 4 代，OpenShift CNI 提供 <code>OpenShiftSDN</code> 及 <code>OVNKubernetes</code> 和預設提供 <code>multus</code> 提供 Pod 多網卡能力</li>
</ol>
<h3 id="openshift-4"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#openshift-4">實務上在 OpenShift 4 的網路設定</a></h3>
<p>實際上對應到 Red Hat OpenShift 4 的設定檔 <a href="https://docs.openshift.com/container-platform/4.3/installing/installing_bare_metal/installing-bare-metal.html#installation-bare-metal-config-yaml_installing-bare-metal">install-config.yaml</a></p>
<p><code>yaml install-config.yaml
apiVersion: v1
baseDomain: example.com
...omit...
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
...omit...</code></p>
<p>實際上，需要設定 3 大段網路，</p>
<ol>
<li>Node Subnet: 主要給<code>北向</code>或<code>南向</code>溝通用</li>
<li>Service Subnet: 主要給<code>東西向</code>網路流用</li>
<li>Pod Subnet: Kubernetes Pod 實際上拿到的 IP，溝通主要都是使用 <code>Service Subnet</code> 進行溝通</li>
</ol>
<p>其他詳細參數解釋請看 <a href="https://blog.pichuang.com.tw/20200403-openshift-with-coreos-part-2/#%E4%BA%86%E8%A7%A3%E7%95%B6%E4%B8%8B%E7%B6%B2%E8%B7%AF%E8%B3%87%E8%A8%8A-Cluster-Network-Operator">愛的走馬看花 Red Hat CoreOS 與 Red Hat OpenShift Part 2 - Cluster Network Operator</a></p>
<h3 id="references"><a class="toclink" href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20190404-openshift-network-traffic-overview/">Red Hat OpenShift v3.11 東西南北向網路探討 - Phil Huang</a></li>
<li><a href="https://blog.pichuang.com.tw/20200403-openshift-with-coreos-part-2/#%E4%BA%86%E8%A7%A3%E7%95%B6%E4%B8%8B%E7%B6%B2%E8%B7%AF%E8%B3%87%E8%A8%8A-Cluster-Network-Operator">愛的走馬看花 Red Hat CoreOS 與 Red Hat OpenShift Part 2 - Cluster Network Operator</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/installing/installing_bare_metal/installing-bare-metal.html#installation-bare-metal-config-yaml_installing-bare-metal">Sample install-config.yaml file for bare metal - OpenShift 4.3</a></li>
<li><a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking">20190817 Container Bare Metal for Networking</a></li>
<li><a href="https://access.redhat.com/solutions/4850181">KB4850181: How to install OpenShift 4 without Multus in place</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/networking/multiple_networks/understanding-multiple-networks.html">Understanding multiple networks - OpenShift 4.3</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/networking/hardware_networks/about-sriov.html">About Single Root I/O Virtualization (SR-IOV) hardware networks</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/networking/configuring_ingress_cluster_traffic/overview-traffic.html">Configuring ingress cluster traffic overview - OpenShift 4.3</a></li>
<li><a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2020/04/13/red-hat-openshift-v4-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%B5%81/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-04-04 00:00:00">April 4, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-v311"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/">Red Hat OpenShift v3.11 東西南北向網路探討</a></h2>
<h3 id="_1"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#_1">資料中心東西南北向網路流</a></h3>
<p>一般討論的資料中心資料流量，主要分為兩大流向
- 南北向 (North-South Traffic):  Client 與 Server 之間的網路流量
- 東西向 (East-West Traffic): Server 與 Server 之間的網路流量</p>
<p><img alt="" src="/images/network-traffic.png" /></p>
<p>那如果套用在 Red Hat OpenShift v3.11 容器平台架構下，那實際網路流量是如何對應?</p>
<!--more-->

<h3 id="red-hat-openshift-311"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#red-hat-openshift-311">Red Hat OpenShift 3.11 東西南北向網路流</a></h3>
<p>首先先來張常見的架構圖</p>
<p><img alt="" src="/images/openshift-network-traffic-1.png" /></p>
<p>以 Red Hat OpenShift 為核心視角，可以分為三段網路
1. 北向網路流 Ingress Traffic
2. 東西向網路流
3. 南向網路流 Egress Traffic</p>
<h4 id="ingress-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#ingress-traffic">北向: Ingress Traffic</a></h4>
<p>從 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">What is Ingress? - Kubernetes</a> 定義上來說，可以了解到 Ingress 主要的目的就是讓外部使用者可以透過 <code>Ingress Controller</code> 接觸到 Kubernestes 裡面的 Service，而在 Red Hat OpenShift 裡面的術語則是使用 <code>Router</code> 來做闡述</p>
<p>故在 <a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html">Routes - OpenShift Docs v3.11</a> 裡面所描述的內容，可以用下表進行術語上的對應</p>
<table>
<thead>
<tr>
<th>Kubernetes</th>
<th>OpenShift</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ingress resource (rules)</td>
<td>Route (rules)</td>
</tr>
<tr>
<td>Ingress controller (Nginx/Ambassador/...)</td>
<td>Router (HAProxy)</td>
</tr>
</tbody>
</table>
<p>而 Ingress Controller 其實是一個統稱，在 OpenShift Router 具體實踐上主要有<a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/assembly_available_router_plugins.html#architecture-additional-concepts-router-plugins">支援兩種類型</a>
1. OpenShift Router (預設)
2. F5 BIG-IP Controller (要搭 F5)</p>
<p>有些人會問說同一平台內，能不能存在多個 Ingress Controller? 答案是可以，但要留意各 Ingress Controller 的實作方式，譬如說 OpenShift Router 的方式是採用 <code>hostnetwork</code> 的走法，所以每一台 host 僅能安裝一個，詳細可參考 <a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods - Phil Workspace</a></p>
<h4 id="east-west-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#east-west-traffic">東西向: East-West Traffic</a></h4>
<p>在 Red Hat OpenShift 平台底下，無論是要跨 Pod / Service / Host 進行橫向的溝通，都是需要有 CNI (Cotainer Network Interface) 的實踐才能將不同主機之間的連線建立起來。CNI 本身是一套標準，實作上就會有百花齊放的專案可供使用，詳細可參考 <a href="https://www.hwchiu.com/cni-compare.html">常見 CNI (Container Network Interface) Plugin 介紹 - hwchiu</a></p>
<p>而預設上，Red Hat OpenShift 提供三個 CNI Plugin 可供使用
1. ovs-subnet: 單純 L2，類同 flat network
2. ovs-multitenant: 可針對不同的 namespace/project 進行隔離
3. ovs-networkpolicy: 控制細粒度最細，可以使用 <code>NetworkPolicy</code> object，類同於寫 iptables rules 一樣</p>
<p>當然如果遠遠覺得這三個功能不符合需求的話，還可以介接第三方廠商的 CNI Plugin，譬如 Juniper Contrail、VMWare NSX-T 等專業網路廠商的方案進行虛實整合 (Overlay + Underlay Integration)</p>
<h4 id="egress-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#egress-traffic">南向: Egress Traffic</a></h4>
<p>Egress 顧名思義可以了解到是從 OpenShift 的 Pod 向外去存取外部服務 (例: Database)，在沒有任何限制之下，在 OpenShift 底下的任何 Pod 當然是可以隨意地去存取外部服務，以下圖表接節錄 <a href="https://www.redhat.com/files/summit/session-assets/2018/Network-security-for-apps-on-OpenShift.pdf">Network Security for Apps on OpenShift - Red Hat Summit</a></p>
<p><img alt="" src="/images/egress-network.png" /></p>
<p>試想若你的外部服務有需要為了資安保護進行存取限制，而你的 Compute Node 卻有複數台以上的話，是不是要特別把這些 Compute Node 的 IP 收集起來後，在外部服務中設定白名單開啟? 倘若環境又是經常性變動的話，是不是每次變動都要進行一次修改呢? 所以這時候就會有針對 Egress Traffic 的三種做法</p>
<ol>
<li>OpenShift Egress Firewall</li>
<li>OpenShift Egress Routers</li>
<li>Egress static IP</li>
</ol>
<p><img alt="" src="/images/egress-firewall.png" />
<img alt="" src="/images/egress-router.png" />
<img alt="" src="/images/egress-static.png" /></p>
<p>其中 OpenShift Egress Routers 的技術細節跟上面所討論的 Ingress Controller: OpenShift Router 是很類似的，而模式上也有三種做法可以選擇，分別是 Redirect、HTTP Proxy、DNS Proxy</p>
<table>
<thead>
<tr>
<th>分類</th>
<th>Redirect mode</th>
<th>HTTP Proxy mode</th>
<th>DNS Proxy mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>Support Protocols</td>
<td>TCP/UDP</td>
<td>HTTP/HTTPS</td>
<td>TCP</td>
</tr>
<tr>
<td>Image</td>
<td>ose-pod</td>
<td>ose-egress-http-proxy</td>
<td>ose-egress-dns-proxy</td>
</tr>
<tr>
<td>Technology</td>
<td>Netfilter rules</td>
<td>Squid</td>
<td>HAProxy</td>
</tr>
</tbody>
</table>
<h3 id="summary"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#summary">Summary</a></h3>
<p>無論是 Kubernetes / OpenShift 一般在討論容器平台網路的不外乎都是在討論 Pod / Service / NodePort 等等的應用，但實際上使用的時候會蠻推薦用資料流 (Data Flow) 的觀點下去做每一個點的討論，這樣在技術選型上才不會思考太久，當然整體網路考慮不會只有單單這一篇文章就可以全部講完的，其實有非常多細節可以做探討，尤其是如何跟現有網路做對接、防火牆環境隔離等等都得一併考慮進去。</p>
<p>希望這篇能幫助大家用高視角的方式來理解整個 Red Hat OpenShift v3.11 網路流量走向</p>
<h3 id="appendix-openshift-v3-f5"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#appendix-openshift-v3-f5">Appendix: 針對 OpenShift v3 版本之 F5 設定</a></h3>
<p><img alt="" src="/images/ocp3_f5.png" /></p>
<h3 id="references"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#references">References</a></h3>
<ul>
<li><a href="https://www.cisco.com/c/en/us/products/collateral/switches/nexus-7000-series-switches/white-paper-c11-737022.html">Cisco Data Center Spine-and-Leaf Architecture: Design Overview White Paper</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">What is Ingress? - Kubernetes</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/assembly_available_router_plugins.html#architecture-additional-concepts-router-plugins">Available router plug-ins - OpenShift Docs v3.11</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html">Routes - OpenShift Docs v3.11</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/sdn.html">OpenShift SDN - OpenShift Docs v3.11</a></li>
<li><a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></li>
<li><a href="https://www.hwchiu.com/cni-compare.html">常見 CNI (Container Network Interface) Plugin 介紹 - hwchiu</a></li>
<li><a href="https://www.redhat.com/files/summit/session-assets/2018/Network-security-for-apps-on-OpenShift.pdf">Network Security for Apps on OpenShift - Red Hat Summit</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/admin_guide/managing_networking.html#admin-guide-controlling-egress-traffic">Controlling Egress Traffic - OpenShift Docs v3.11</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-03-21 00:00:00">March 21, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-services-pods"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></h2>
<p>Red Hat OpenShift v3.11 架構裡網路主要分為三大塊:</p>
<ol>
<li>Hosts subnet</li>
<li>Service subnet</li>
<li>Pod subnet</li>
</ol>
<!--more-->

<p>Host subnet 毫無懸念指的就是主機所使用的 IP，也就是對外可以接觸到主機的網路; 而 Service 和 Pods subnet 在 OpenShift 裡面是一個虛擬概念，正常狀況下外部網路無法透過 Pod IP/Port 和 Service IP/Port 接觸到服務</p>
<p>那如果我想要讓 Pod 或 Service IP 可以被外面接觸到呢? 以下分為兩個層級來討論:
1. Pod mapping to host
2. Service mapping to host</p>
<h3 id="pod-port-mapping-to-host-port"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#pod-port-mapping-to-host-port">Pod port Mapping to Host port</a></h3>
<h4 id="hostnetworktrue"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#hostnetworktrue">使用 <code>hostNetwork=true</code></a></h4>
<p>若沒有特別指定的話，預設 <code>hostPort</code> 等於 <code>containerPort</code>，意思是說 Pod 裡面的容器開了什麼 Port 就會直接對應到 host 上面的 Port，而 Pod IP 則會理所當然地等於 Host IP</p>
<p>外面訪問服務的 IP/Port，請求會直接轉到和 Pod 相同的 IP/Port ，途中不經過 iptables 及 service 處理</p>
<p>優點: 直接可以從外面直接接觸到 Pod 層級服務，網路轉發效率會比 nodePort 好
缺點: 不能在同一台主機 (Host) 開啟第二個相同的 Pod，因為會有 Port 衝突的問題，也不能跨主機建立服務</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nn">---</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true &lt;----</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h4 id="hostport"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#hostport">使用 <code>hostPort</code></a></h4>
<p>概念跟前者很像，差異會在可以指定特定的 <code>hostPort</code> 對應到 <code>containerPort</code>，但並不需要全部的 Pod Port 都跟 Host 做對應，可以有限度的開放出去</p>
<p>優點: 直接可以從外面直接接觸到 Pod 層級服務
缺點: 不能在同一台主機 (Host) 開啟第二個相同的 Pod，因為會有 Port 衝突的問題，也不能跨主機建立服務</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nn">---</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080 &lt;----</span>
</code></pre></div>
<h3 id="service-port-mapping-to-host-port"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#service-port-mapping-to-host-port">Service port Mapping to Host port</a></h3>
<h4 id="nodeport"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#nodeport">使用 <code>nodePort</code></a></h4>
<p>廣泛應用的服務揭露方式，在預設情況下，每啟動一個 Service 都會搭配一個 <code>ClusterIP</code>，而這個 <code>ClusterIP</code> 僅能在同一個集群內部被訪問，外面不能接觸到，倘若想要讓他被接觸的話，就要指定 <code>nodePort</code> 對外揭露</p>
<p>hostPort 跟 nodePort 的差異在，前者是針對單一主機裡的單一容器進行設定，後者則是以一個集群來看待，服務可以跨主機</p>
<p>優點: 可跨主機，直接可以從外面直接接觸到 Service 層級服務，且能透過所產生的 ClusterIP 對後端的 Pod 做負載均衡
缺點: 所有集群的 Port 都會同時被開起來，讓外部做接觸</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nn">---</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8086</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000 &lt;---</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</code></pre></div>
<p>建議可以搭一個外部 Reverse Proxy 來做使用，譬如像是 F5 / A10 / HAProxy</p>
<h4 id="ingress-controller-openshift-router"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#ingress-controller-openshift-router">使用 Ingress Controller: OpenShift Router</a></h4>
<p>綜合 Pod 跟 Service 的優點的改良作法，也是普遍建立對外服務時的最佳實踐。你不需要自己對所有的 Service 去新增 <code>nodePort</code>，而可以直接在 OpenShift 上建立一個 Reverse Proxy 的服務，直接進行對外服務揭露及對內服務負載平衡，依據不同的 Ingress Controller 實作，通常功能都會包含 HTTP 路徑揭露、Session Sticky、SSL Transparent/Re-encrypt/Terminated 等等負載平衡的功能</p>
<p>OpenShift Router 是採用 <code>hostnetwork</code> 的方式建立，所以每一台主機至多只能安裝一個，同時 80 / 443 /1936 這三個 Port 會被預設佔走</p>
<p>想了解於 OpenShift 對於 Ingress Controller 的實作 <code>Router</code> 可以參考 <a href="https://docs.openshift.com/container-platform/3.11/install_config/router/index.html">Router Overview - OpenShift v3.11 Docs</a></p>
<h4 id="service-type-loadbalancer"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#service-type-loadbalancer">使用 Service Type: <code>LoadBalancer</code></a></h4>
<p>正常使用下，這功能僅限於公有雲，但在 OpenShift 裡面有支援一個功能叫做 <code>ingress IP</code>，效果就是給 OpenShift 僅一個特定的網段 (Subnet) 之後，可以從中選取任一 IP，並使用 <code>type: LoadBalancer</code> 對外揭露服務，詳細可以參考 <a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></p>
<h4 id="external-ingressip"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#external-ingressip">使用 External IngressIP</a></h4>
<p>倘若一定要走 non-HTTP/HTTPS 的服務，又想要有類似於使用 <code>Service Type: LoadBalancer</code>，那可以考慮使用 IngressIP 來做使用，<a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></p>
<p>可以做成下面的效果</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>openshift-ingress
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>NAME<span class="w">                      </span>TYPE<span class="w">           </span>CLUSTER-IP<span class="w">      </span>EXTERNAL-IP<span class="w">      </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">                      </span>AGE
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>router-default<span class="w">            </span>LoadBalancer<span class="w">   </span><span class="m">172</span>.30.16.119<span class="w">   </span><span class="m">52</span>.230.228.163<span class="w">   </span><span class="m">80</span>:30745/TCP,443:32561/TCP<span class="w">   </span>2d6h
</code></pre></div>
<h3 id="summary"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#summary">Summary</a></h3>
<p>在 OpenShift 的環境之下</p>
<ol>
<li>對於 http/https 的服務，對外透過 Ingress Controller: OpenShift Router 揭露 FQDN 讓外面使用</li>
<li>對於非 http/https 的服務，如 mysql，有下列兩種做法:</li>
<li>若不需要提供對外服務，僅使用 <code>ClusterIP</code> 在內部進行使用</li>
<li>若需要提供對外服務，有下列三種做法:<ol>
<li>Single Instance，不需要在多個 node 上面運行，使用 <code>hostnetwork</code> 或 <code>hostPort</code></li>
<li>Multiple Instance，需要在多個 node 上面運行，做到 scale-out 的效果，則使用 <code>ingress IP</code> 為佳</li>
</ol>
</li>
</ol>
<h3 id="references"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#references">References</a></h3>
<ul>
<li><a href="https://blog.csdn.net/huqigang/article/details/76428017">kubernetes学习记录（3）——集群外部访问Pod或Service</a></li>
<li><a href="https://www.slideshare.net/erhwenkuo/cncf-k8snetworkpart1/erhwenkuo/cncf-k8snetworkpart1">Kubernetes 網路是如何運作? Part 1- Erhwen Kuo</a></li>
<li><a href="https://www.slideshare.net/erhwenkuo/cncf-k8snetwork02-137938815">Kubernetes 網路是如何運作? Part 2- Erhwen Kuo</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/accessing-kubernetes-pods-from-outside-of-the-cluster.html">从外部访问Kubernetes中的Pod - JimmySong</a></li>
<li><a href="http://alesnosek.com/blog/2017/02/14/accessing-kubernetes-pods-from-outside-of-the-cluster/">Accessing Kubernetes Pods from Outside of the Cluster</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/install_config/router/index.html">Router Overview - OpenShift v3.11 Docs</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1101219">深度理解：Openshift端口方式全解析 - 大衛分享</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1375943">OpenShift 网络分析-(容器网络选型和方案建议) - 大衛分享</a></li>
<li><a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>