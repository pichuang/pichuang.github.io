
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/category/kubernetes/">
      
      
        <link rel="prev" href="../homecloud/">
      
      
        <link rel="next" href="../linux/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>kubernetes - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel ğŸ¥ </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#azure-kubernetes-services-c1000k" class="md-nav__link">
    <span class="md-ellipsis">
      
        æªç«Ÿ...Azure Kubernetes Services çš„ç¯€é»èƒ½ä¸èƒ½æä¾› C1000K çš„èƒ½åŠ›å‘¢?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        äººå®¶éƒ½åœ¨æŠ“ç¥å¥‡å¯¶è²ï¼Œè€Œæˆ‘åœ¨æŠ“ Kubernetes å°åŒ…
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distroless-container-kubectl-debug" class="md-nav__link">
    <span class="md-ellipsis">
      
        ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-probe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Probe é¡å‹åŠå¯¦ä½œæ–¹å¼çš„ä½¿ç”¨èªªæ˜èˆ‡å°å»ºè­°
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sig-kubernetes-scability" class="md-nav__link">
    <span class="md-ellipsis">
      
        SIG Kubernetes Scability å¤šç¶­åº¦åˆ†æ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openai-kubernetes-7500" class="md-nav__link">
    <span class="md-ellipsis">
      
        çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›æ‹›å–š Kubernetes 7500 å°ç¯€é»!!!
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pod" class="md-nav__link">
    <span class="md-ellipsis">
      
        å¯¦ç¾ä¸åœæ©Ÿçš„ Pod æ›´æ–°æ–¹å¼
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-kubernetes-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        æˆ‘è¦ 1 åº§ Kubernetes é‚„æ˜¯è¦å¤šåº§ Kubernetes? é‚„æ˜¯éƒ½å¯ä»¥?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-app" class="md-nav__link">
    <span class="md-ellipsis">
      
        å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="kubernetes">kubernetes</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-17 00:00:00">October 17, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-kubernetes-services-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">æªç«Ÿ...Azure Kubernetes Services çš„ç¯€é»èƒ½ä¸èƒ½æä¾› C1000K çš„èƒ½åŠ›å‘¢?</a></h2>
<blockquote>
<p>Kubernetes is Cloud OS, Containers are Linux</p>
</blockquote>
<p><img alt="" src="/images/t2.jpg" /></p>
<p>æ—¢å‰ç¯‡æ–‡ç«  <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a> æœ‰æåˆ°é™ä½ä¸å¿…è¦ç¶²è·¯å‚³è¼¸æˆæœ¬å¯æœ‰æ•ˆæ¸›å°‘ç¢³æ’æ”¾ï¼Œé‚£æˆ‘ç¹¼çºŒåŸºæ–¼ Green Foundation æ‰€æå‡ºçš„<a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">ç¶ è‰²è»Ÿé«”å¯¦è¸è€… (Green Software Practitioner)</a> ç•¶ä¸­çš„åŸå‰‡æå‡è¨­å‚™åˆ©ç”¨ç‡ (Increasing device utilization) ä¾†ç¹¼çºŒå»¶ä¼¸é€™å€‹å¤§è­°é¡Œ</p>
<p>ç›¡åŠ›åœ°æå‡å–®å°ç¯€é»æ‰€èƒ½æœå‹™çš„é‡é«”ï¼Œæ¸›å°‘è³‡æºæµªè²»ï¼Œå¾é€™å€‹è§’åº¦çœ‹ï¼Œå…¶å¯¦å°±æ˜¯éœ€è¦ä¾†æ¢è¨ Azure Kuberenetes Service é è¨­æä¾›çš„é€™äº›ç¯€é»ï¼Œæœ¬é«”åˆ°åº•å¤ ä¸å¤ æä¾›æˆ‘å€‘åœ¨å¤§æµé‡å’Œé«˜æ€§èƒ½è¨ˆç®—ä¸Šæ‰€éœ€çš„è³‡æºå’Œèª¿æ•™ï¼Œé€™é‚Šå°±å¾ç¶“å…¸çš„ç™¾è¬ä¸¦è¡Œé€£ç·š C1000K (Concurrent 1000K Connections) ä¾†åšç‚ºåŸºæº–ä¾†æ¢è¨</p>
<!--more-->

<h3 id="cncf-sustainability-week-taiwan-x-green-software-foundation"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#cncf-sustainability-week-taiwan-x-green-software-foundation">[æ´»å‹•å®£å‚³] CNCF Sustainability Week - Taiwan x Green Software Foundation</a></h3>
<p><img alt="" src="/images/cnsw.png" /></p>
<p>æœ€è¿‘çš„æˆ‘è¦ºå¾—é€™å€‹é¡Œç›®æ¯”è¼ƒåœ¨è€ƒé©— Linux é«˜æ€§èƒ½èª¿æ•™ï¼Œæ­¡è¿å¤§å®¶å ±å <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">2023/10/24 18:30-21:30</a> ä¾†åƒåƒå–å–æ¢è¨</p>
<h3 id="azure-kubernetes-service"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#azure-kubernetes-service">ç™»å…¥ Azure Kubernetes Service ç•¶ä¸­çš„ä¸€å€‹ç¯€é»</a></h3>
<p>é€™é‚Šä½¿ç”¨ v1.25 å¾Œï¼Œé–‹å§‹å¯ä½¿ç”¨çš„ <code>kubectl debug</code> ä½œç‚ºä½¿ç”¨åŸºç¤ï¼Œä¹‹å‰æœ‰äº›éä¸€ç¯‡ <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a> æœ‰å°ˆæ–‡è§£é‡‹é€™å€‹æŒ‡ä»¤çš„æ•ˆæœï¼Œä½†ä»Šå¤©æ¯”è¼ƒç‰¹åˆ¥æ˜¯ï¼Œå°è±¡æ˜¯ Node è€Œé Pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.28.1
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.4-0.20230601165947-6ce0bf390ce3
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1"># ç²å¾— node åç¨±</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>NAME<span class="w">                                </span>STATUS<span class="w">   </span>ROLES<span class="w">   </span>AGE<span class="w">     </span>VERSION
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>aks-agentpool-14864487-vmss000000<span class="w">   </span>Ready<span class="w">    </span>agent<span class="w">   </span>6d14h<span class="w">   </span>v1.27.3
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="c1"># kubectl debug node/&lt;node name&gt; -it --image-pull-policy=Always --quiet --image=&lt;image name&gt; -- &lt;command&gt;</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>debug<span class="w"> </span>node/aks-agentpool-14864487-vmss000000<span class="w"> </span>-it<span class="w"> </span>--image-pull-policy<span class="o">=</span>Always<span class="w"> </span>--quiet<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="c1"># å‹™å¿…è¦è¨˜å¾—ä½¿ç”¨ chroot /host åˆ‡åˆ°æ­£ç¢ºçš„ç’°å¢ƒå»</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="o">[</span>root@aks-agentpool-14864487-vmss000000<span class="w"> </span>/<span class="o">]</span><span class="c1"># chroot /host /bin/bash</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="c1"># ç¢ºä¿ä½ å¯ä»¥çœ‹åˆ°ä½œæ¥­ç³»çµ±è³‡è¨Š</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /etc/os-release</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="nv">NAME</span><span class="o">=</span><span class="s2">&quot;Common Base Linux Mariner&quot;</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="nv">VERSION</span><span class="o">=</span><span class="s2">&quot;2.0.20230924&quot;</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="nv">ID</span><span class="o">=</span>mariner
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&quot;CBL-Mariner/Linux&quot;</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="nv">ANSI_COLOR</span><span class="o">=</span><span class="s2">&quot;1;34&quot;</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
</code></pre></div>
<p><img alt="" src="/images/t1.png" /></p>
<h3 id="aks-node-cbl-mariner"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-node-cbl-mariner">è§£å‰– AKS Node è£¡çš„ CBL-Mariner ä½œæ¥­ç³»çµ±</a></h3>
<p>å…ˆè²æ˜ï¼Œä¸‹é¢çš„çœ¾å¤šæ“ä½œéƒ½å¯ä»¥é©ç”¨æ–¼ä»»ä½•ä¸€å®¶çš„ Kubernetes ç™¼è¡Œç‰ˆå’Œä»¥ Linux ç‚ºåŸºç¤çš„ç¯€é»ï¼Œä½†ç•¶ä¸­çš„è¨­å®šæœƒéš¨è‘—ä¸‹åˆ— 3 å€‹ç‹€æ³æœ‰æ‰€å·®ç•°ï¼Œä½†åŸºæœ¬ä¸Šå¤§åŒå°ç•°</p>
<ol>
<li>å» å•†ä¸åŒï¼Œå¦‚ Azure å’Œ Red Hat</li>
<li>OS é¸æ“‡ä¸åŒï¼Œå¦‚ Mariner 2.0ã€Red Hat CoreOSã€Ubuntu 20.04</li>
<li>Kernel ç‰ˆæœ¬ä¸åŒï¼Œå¦‚ 5.15.131ã€5.x.xã€3.11.x</li>
</ol>
<h4 id="aks-environment"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-environment">AKS Environment</a></h4>
<ul>
<li>Azure Kubernetes Service 1.27.3</li>
<li>VM Instance: Standard D4as v5 (4 vcpus, 16 GiB memory)</li>
<li>OS: <a href="https://github.com/microsoft/CBL-Mariner">CBL-Mariner 2.0</a>ï¼Œé€™å€‹æ˜¯ Azure è¦ªå¤§ç‹å­ï¼Œæœ€è¿‘é‚„æœ‰ä¸€å€‹ Azure Linux è¦ªå°ç‹å­å‡ºä¾†ï¼Œä½†é‚„æ²’æ­£å¼ç”¨é</li>
<li>CNI: Azure CNI</li>
<li>(Azure é™å®š) æœ‰ä½¿ç”¨ UDR å¼·åˆ¶æ§åˆ¶ Egress æ–¹å‘</li>
</ul>
<h4 id="1-cpu"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#1-cpu">1. CPU ç›¸é—œ</a></h4>
<h5 id="a-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-hardware">a. Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">#</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="c1"># CPU</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c1">#</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="c1"># æŸ¥è©¢ CPU å‹è™Ÿ</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="c1"># Standard D4as v5 (4 vcpus, 16 GiB memory)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="c1"># https://azureprice.net/vm/Standard_D4as_v5</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;model name&quot; | cut -f2 -d: | uniq</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>AMD<span class="w"> </span>EPYC<span class="w"> </span><span class="m">7763</span><span class="w"> </span><span class="m">64</span>-Core<span class="w"> </span>Processor
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="c1"># æŸ¥è©¢ç‰©ç† CPU å€‹æ•¸</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;physical id&quot; | sort | uniq | wc -l</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="m">1</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="c1"># æŸ¥è©¢æ¯å€‹ç‰©ç† CPU çš„ Core æ•¸</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="c1"># è‹¥æ–¼ Azure Portal è¨­å®š `platformsettings.host_environment.disablehyperthreading: true` çš„è©±ï¼Œå‰‡ä¸æœƒé–‹å•Ÿ HT çš„èƒ½åŠ›</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="m">2</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="c1"># æŸ¥è©¢æ¯å€‹é‚è¼¯ vCPUs çš„å€‹æ•¸</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="c1"># é‚è¼¯ vCPUs å€‹æ•¸ = ç‰©ç† CPU å€‹æ•¸ * æ¯å€‹ç‰©ç† CPU çš„ Core å€‹æ•¸ * 2 (é è¨­ Azure VM æœƒé–‹å•Ÿ HTï¼Œæ„æ—¨é è¨­ç‹€æ³ä¸‹ï¼Œplatformsettings.host_environment.disablehyperthreading: false)</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="c1"># https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="c1"># æ ¹æ“šåŠ ç¸½ processor æ•¸é‡ï¼Œæ•…çŸ¥é“è©² VM ç‚º 4 vcpus</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="m">4</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="c1"># https://www.amd.com/en/products/cpu/amd-epyc-7763</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="c1"># Base Clock 2.45GHz, Max. Boost Clock Up to 3.5GHz</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu MHz&quot; | uniq</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2946</span>.906
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
</code></pre></div>
<p>ä¸»è¦é€™é‚Šæ˜¯è¦è¬›æœ‰é–‹ HT å’Œæ²’é–‹ HT çš„ç‹€æ³ä¸‹ï¼ŒvCPU å‘ˆç¾æœƒä¸åŒï¼Œè€Œ Azure VM é è¨­ç‹€æ³ä¸‹éƒ½æ˜¯æœƒæŠŠ HT é–‹èµ·ä¾†çš„ã€‚å€˜è‹¥è¦è·‘ HPC æˆ–å…¶ä»–ä½ å°±æ˜¯è¦æŠŠé€™å°æ©Ÿå™¨æ•ˆèƒ½æ¦¨åˆ°æ¥µé™ï¼Œå‰‡è¦æŠŠ HT é—œæ‰ï¼Œå¯ä½¿ç”¨ <code>platformsettings.host_environment.disablehyperthreading=true</code></p>
<h5 id="b-numa-non-uniform-memeory-acces"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-numa-non-uniform-memeory-acces">b. NUMA (Non-uniform memeory acces)</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># numa</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># yum install numactl -y # é è¨­æ²’æœ‰ï¼Œéœ€è¦è£</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># å¦‚ä¸‹é¡¯ç¤ºï¼Œåªæœ‰ä¸€å€‹ NUMA Nodeï¼Œè£¡é¢æœ‰ 4 å€‹ vcpus ä¸”è¢«åˆ†é…åˆ° 15734 MB çš„ Memory</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl -H</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>available:<span class="w"> </span><span class="m">1</span><span class="w"> </span>nodes<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="o">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>cpus:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>size:<span class="w"> </span><span class="m">15734</span><span class="w"> </span>MB
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>free:<span class="w"> </span><span class="m">7277</span><span class="w"> </span>MB
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>node<span class="w"> </span>distances:
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>node<span class="w">   </span><span class="m">0</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">  </span><span class="m">0</span>:<span class="w">  </span><span class="m">10</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl --show</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>policy:<span class="w"> </span>default
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>preferred<span class="w"> </span>node:<span class="w"> </span>current
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>physcpubind:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>cpubind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>nodebind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>membind:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>é †ä¾¿ä¸€æï¼Œé›–ç„¶è·Ÿç¯€é»æœ¬èº«æ²’å•¥é—œä¿‚ï¼Œé‡å° Kubernetes Pod å°æ–¼ CPU çš„å„ªåŒ–ï¼Œé™¤äº†èŠ±éŒ¢ç ¸è²·æ›´å¥½çš„ CPU ä»¥å¤–ï¼Œæ¯”è¼ƒæœ‰ç­–ç•¥æˆ–å¾ˆ Kubernetes çš„æ–¹å¼æ˜¯ï¼Œæ¡ç”¨ Topology Manager å˜—è©¦èª¿æ•´å‡ºæœ€ä½³åŒ– NUMAï¼Œ<a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a>ã€‚ç¾è¡Œå…±æœ‰ 4 å€‹ç­–ç•¥å¯ç”¨: none, best-effort, restricted, single-numa-nodeï¼ŒAKS é è¨­æ˜¯æ¡ç”¨ <code>none</code>ï¼Œè©²åŠŸèƒ½å¸¸è¦‹æ–¼ 5G / CNF ç­‰å°æ–¼ Pod ä¹‹æ–¼ NUMA çš„ä½¿ç”¨æ•ˆç‡æœ‰ç‰¹åˆ¥è¦æ±‚çš„å ´æ™¯ï¼Œå¦‚ UPF æœå‹™æœƒå‡ºç¾ï¼Œå¯åƒè€ƒ <a href="https://speakerdeck.com/pichuang/qian-tan-azure-private-5g-core-he-kubernetes?slide=15">20221028 æ·ºè«‡ Azure Private 5G Core å’Œ Kubernetes</a></p>
<h4 id="2-memory"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#2-memory">2. Memory ç›¸é—œ</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">#</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="c1"># Memory</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="c1">#</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="c1"># ä¾æ“š MemAvailable æ‰€ç¤ºï¼Œé€™å°æ©Ÿå™¨æœ‰ 13479504 kB çš„ Memory å¯ç”¨</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/meminfo</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>MemTotal:<span class="w">       </span><span class="m">16112256</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># æ‰€æœ‰ Memory å¤§å°, æ•…ç‚º 16 GB</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>MemFree:<span class="w">         </span><span class="m">7317172</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># å®Œå…¨æ²’åˆ°çš„ Memory å¤§å°ï¼Œå¾ˆé¡¯ç„¶æˆ‘é€™å°æ©Ÿå™¨é–‹å¤ªå¤§äº†ï¼Œå¤ªé–’</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>MemAvailable:<span class="w">   </span><span class="m">13479504</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># å¯¦éš›ä¸Šå¯ç”¨çš„ Memory å¤§å°ï¼ŒMemAvailable &lt;= MemFree + Active(file) + Inactive(file) + SReclaimable</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>Active<span class="o">(</span>file<span class="o">)</span>:<span class="w">    </span><span class="m">1067108</span><span class="w"> </span>kB
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>Inactive<span class="o">(</span>file<span class="o">)</span>:<span class="w">  </span><span class="m">5021812</span><span class="w"> </span>kB
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>Slab:<span class="w">             </span><span class="m">486692</span><span class="w"> </span>kB
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>SReclaimable:<span class="w">     </span><span class="m">334712</span><span class="w"> </span>kB
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>HugePages_Total:<span class="w">       </span><span class="m">0</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="c1"># MemTotal ç‚º 16112256 kB = 719104 kB + 15393152 kB</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/zoneinfo</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">    </span>DMA32
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">179568</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">179776</span><span class="w"> </span><span class="c1"># çµ¦ DMA32 ä½¿ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ç‚º 702.25 MB = 719104 KB = 179776 * 4 KB</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">   </span>Normal
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">1974218</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">3848288</span><span class="w"> </span><span class="c1"># çµ¦ Normal ä½¿ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ç‚º 14.68 GB = 15393152 KB = 3848288 * 4 KB</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="c1"># ä¸€å€‹ Slab page å¯ç”¨ç©ºé–“ 32768 Bytes = 4096 Bytes * pagesperslab 8</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="c1"># TCP å¯¦éš› Slab page å…§æœ‰ 31360 Bytes è¢«ä½¿ç”¨ = objsize 2240 Bytes * objperslab 14</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="c1"># Slab page ç¢ç‰‡ 1408 Bytes = 32768 - 31360</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="c1"># TCP å¯¦éš›å ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ 470400 Bytes = num_objs 210 * objsize 2240 Bytes</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/slabinfo | grep TCP</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="c1"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>TCP<span class="w">                  </span><span class="m">210</span><span class="w">    </span><span class="m">210</span><span class="w">   </span><span class="m">2240</span><span class="w">   </span><span class="m">14</span><span class="w">    </span><span class="m">8</span><span class="w"> </span>:<span class="w"> </span>tunables<span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span>slabdata<span class="w">     </span><span class="m">15</span><span class="w">     </span><span class="m">15</span><span class="w">      </span><span class="m">0</span>
</code></pre></div>
<p>è¨˜æ†¶é«”æ˜¯ä¸å¯è¢«å£“ç¸®è³‡æºï¼Œè·Ÿ CPU ä¸ä¸€æ¨£ï¼Œå¦‚æœ MemAvailable çœŸçš„ç”¨åˆ° 0 çš„ç‹€æ³ä¸‹ï¼Œå°±ä»£è¡¨ä½ çš„ç¯€é»è¨˜æ†¶é«”çœŸçš„æ˜¯å¤ªå°äº†ï¼Œå®Œå…¨ä¸å¤ åˆ†é…å‡ºå»ï¼Œä¸Šé¢çš„ Pod å¾ˆå®¹æ˜“æœ‰æ»¿æ»¿ OOM çš„ç‹€æ³ã€‚</p>
<p>å¦‚æœä½ æƒ³è¦ Pod æœ‰ä¿éšœçš„è³‡æºå¯ä»¥ç”¨ï¼Œä½ éœ€è¦å¾ k8s çš„è§’åº¦å»æ§åˆ¶ cpu.request / cpu.limit / memory.request / memory.limitï¼Œå¯åƒè€ƒå°å¼ŸèˆŠæ–‡ <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a>ï¼Œé€™ç¯‡ä¸æœƒç‰¹åˆ¥æ¶‰åŠï¼Œä¹‹å¾Œæœƒè¬›ä¸€ç¯‡ç”±ä¸‹è€Œä¸Šçš„ Node å’Œç”±ä¸Šè€Œä¸‹çš„ç®¡ç† Kubernetes è§’åº¦ä¸Šçš„è³‡æºå°ç…§</p>
<p>é †ä¾¿ä¸€æï¼Œç¶­æŒä¸€å€‹ Long Lived TCP Connection ï¼Œä¸”ä¸åŒ…å«å…¶ä»–çš„è³‡æ–™å‚³è¼¸ï¼Œæ¶ˆè€—çš„è¨˜æ†¶é«”å¤§ç´„ç‚º ~3.3 KBï¼Œè‹¥å…¨éƒ¨éƒ½æ˜¯ Long Lived TCP Connection ä¸”ç„¡å¯¦éš›è³‡æ–™é‹ä½œæˆ–å‚³è¼¸çš„è©±ï¼Œå¤§æ¦‚å°±æ˜¯æ¶ˆè€— 3.3 GB è¨˜æ†¶é«”å­˜é€™äº›è³‡è¨Šï¼Œå¯åƒè€ƒ <code>Q5: å–®å° C1000K æ˜¯æ€éº¼ç®—å‡ºä¾†çš„? é è¨­å•¥éƒ½æ²’åšçš„ç‹€æ³ä¸‹è¨˜æ†¶é«”æ¶ˆè€—ç‚ºä½•?</code> çš„å…§å®¹</p>
<h4 id="3-linux-kernel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#3-linux-kernel">3. Linux Kernel ç›¸é—œ</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">#</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1"># Kernel Paraemters</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1">#</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># uname -a</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>Linux<span class="w"> </span>aks-agentpool-14864487-vmss000000<span class="w"> </span><span class="m">5</span>.15.131.1-2.cm2<span class="w"> </span><span class="c1">#1 SMP Sun Sep 24 03:38:45 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="c1"># ä¸‹åˆ—éƒ½æ˜¯ CBL-Mariner çš„é è¨­å€¼</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># sysctl -a</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>net.ipv4.ip_local_port_range<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32768</span><span class="w">    </span><span class="m">60999</span><span class="w"> </span><span class="c1"># è©² VM å¯ä½¿ç”¨çš„ Port Rangeï¼Œé è¨­ç¯„åœç‚º 32768 ~ 60999ï¼Œå…± 28232 å€‹ Portï¼Œå¯èª¿æ•´</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>net.ipv4.tcp_syn_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>net.ipv4.tcp_synack_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>net.ipv4.tcp_syncookies<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># é è¨­å¯é˜²æ­¢éƒ¨åˆ† SYN Flood æ”»æ“Š</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>net.ipv4.tcp_tw_reuse<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>net.ipv4.tcp_max_syn_backlog<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>net.ipv4.tcp_max_tw_buckets<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">65536</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>net.core.somaxconn<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>fs.file-max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9223372036854775807</span><span class="w"> </span><span class="c1"># OS Levelï¼Œç‚º Int64.MaxValue æœ€å¤§ä½æ•¸ï¼Œåå…­é€²ä½0x7FFFFFFFFFFFFFFF</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>fs.nr_open<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1073741816</span><span class="w"> </span><span class="c1"># Progess Levelï¼Œéœ€è¦æ¯” * hard nofile (1048576) å¤§ï¼Œä¸ç„¶æœƒé–‹ä¸èµ·ä¾†</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>net.ipv4.tcp_congestion_control<span class="w"> </span><span class="o">=</span><span class="w"> </span>cubic
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>net.ipv4.tcp_mtu_probing<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>net.ipv4.tcp_fastopen<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># ulimit -a</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>real-time<span class="w"> </span>non-blocking<span class="w"> </span><span class="nb">time</span><span class="w">  </span><span class="o">(</span>microseconds,<span class="w"> </span>-R<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>core<span class="w"> </span>file<span class="w"> </span>size<span class="w">              </span><span class="o">(</span>blocks,<span class="w"> </span>-c<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>data<span class="w"> </span>seg<span class="w"> </span>size<span class="w">               </span><span class="o">(</span>kbytes,<span class="w"> </span>-d<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>scheduling<span class="w"> </span>priority<span class="w">                 </span><span class="o">(</span>-e<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>file<span class="w"> </span>size<span class="w">                   </span><span class="o">(</span>blocks,<span class="w"> </span>-f<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>pending<span class="w"> </span>signals<span class="w">                     </span><span class="o">(</span>-i<span class="o">)</span><span class="w"> </span><span class="m">62863</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>max<span class="w"> </span>locked<span class="w"> </span>memory<span class="w">           </span><span class="o">(</span>kbytes,<span class="w"> </span>-l<span class="o">)</span><span class="w"> </span><span class="m">64</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>max<span class="w"> </span>memory<span class="w"> </span>size<span class="w">             </span><span class="o">(</span>kbytes,<span class="w"> </span>-m<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>open<span class="w"> </span>files<span class="w">                          </span><span class="o">(</span>-n<span class="o">)</span><span class="w"> </span><span class="m">1048576</span><span class="w"> </span><span class="c1"># åŒæ™‚å¯æ‰“é–‹çš„æª”æ¡ˆæ•¸é‡ï¼ŒAzure æä¾›çš„ CBL-Mariner ä½œæ¥­ç³»çµ±é è¨­æ˜¯ 2^20 å€‹ï¼Œå–®å° VM å¸³é¢é è¨­æ•¸å­—æ˜¯æ”¯æ´åšåˆ° C1000K ç­‰ç´š</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>pipe<span class="w"> </span>size<span class="w">                </span><span class="o">(</span><span class="m">512</span><span class="w"> </span>bytes,<span class="w"> </span>-p<span class="o">)</span><span class="w"> </span><span class="m">8</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>POSIX<span class="w"> </span>message<span class="w"> </span>queues<span class="w">         </span><span class="o">(</span>bytes,<span class="w"> </span>-q<span class="o">)</span><span class="w"> </span><span class="m">819200</span>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>real-time<span class="w"> </span>priority<span class="w">                  </span><span class="o">(</span>-r<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>stack<span class="w"> </span>size<span class="w">                  </span><span class="o">(</span>kbytes,<span class="w"> </span>-s<span class="o">)</span><span class="w"> </span><span class="m">8192</span>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a>cpu<span class="w"> </span><span class="nb">time</span><span class="w">                   </span><span class="o">(</span>seconds,<span class="w"> </span>-t<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>max<span class="w"> </span>user<span class="w"> </span>processes<span class="w">                  </span><span class="o">(</span>-u<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a>virtual<span class="w"> </span>memory<span class="w">              </span><span class="o">(</span>kbytes,<span class="w"> </span>-v<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a>file<span class="w"> </span>locks<span class="w">                          </span><span class="o">(</span>-x<span class="o">)</span><span class="w"> </span>unlimited
</code></pre></div>
<p>å‰é™£å­ CNCF æœ‰ä¸€ç¯‡éƒ¨è½æ ¼ <a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a> å°±åœ¨è¬›å¦‚ä½•èª¿æ•´ç¯€é»å…§çš„ Linux Kernel åƒæ•¸ä¾†é”åˆ° 1 ç™¾è¬ Concurrent Connections</p>
<p>é€™é‚Šä¾†æ¯”å°ä¸€ä¸‹ CBL-Mariner é è¨­åƒæ•¸è·Ÿ <a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a> çš„å·®ç•°</p>
<table>
<thead>
<tr>
<th style="text-align: center;">sysctl</th>
<th style="text-align: center;">CBL-Mariner 2.0</th>
<th style="text-align: center;">EMQX</th>
<th style="text-align: center;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">æ•´å€‹ OS æœ€å¤§é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">fs.fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">å–®ä¸€ç¨‹åºæœ€å¤§é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">net.core.somaxconn</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">32768</td>
<td style="text-align: center;">å…¨é€£æ¥ä½‡åˆ—é•·åº¦: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_syn_backlog</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">å…¨é€£æ¥ä½‡åˆ—é•·åº¦: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.core.netdev_max_backlog</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.ip_local_port_range</td>
<td style="text-align: center;">32768 60999</td>
<td style="text-align: center;">1000 65535</td>
<td style="text-align: center;">VM å¯ç”¨ Port ç¯„åœï¼Œä½†å–®ç´”ä»¥ Server ç«¯è§’åº¦ä¾†èªªèª¿é€™å€‹æ²’å•¥å¤ªå¤§ç”¨è™•ï¼Œå¤šåŠéƒ½ 80, 443 ç‚ºä¸»ï¼Œä½†ç•¶ Client ä¾†è¬›å°±æœ‰æ•ˆæœäº†ï¼Œè­¬å¦‚èªªä½ è¦å¤–é€£ DB é‚„æ˜¯æœ‰çš„æ²’çš„å¤–éƒ¨æœå‹™ä¹‹é¡çš„ï¼Œé€™å€‹èª¿å¤§æœƒæ¯”è¼ƒå¥½</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.optmem_max</td>
<td style="text-align: center;">20480</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">ç·©è¡å€å¤§å°</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_rmem</td>
<td style="text-align: center;">4096 131072 6291456</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">å› ç‚º MQï¼Œè¨Šæ¯é‡å°ï¼Œå¯ä»¥ 1KB å°±ç™¼é€ä¸€æ¬¡</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_wmem</td>
<td style="text-align: center;">4096 16384 4194304</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">å› ç‚º MQï¼Œè¨Šæ¯é‡å°ï¼Œå¯ä»¥ 1KB å°±ç™¼é€ä¸€æ¬¡</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_max</td>
<td style="text-align: center;">131072</td>
<td style="text-align: center;">1000000</td>
<td style="text-align: center;">èª¿é«˜ nf_conntrack_max çš„æ¥å—ä¸Šé™</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_tcp_timeout_time_wait</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">30</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_tw_buckets</td>
<td style="text-align: center;">65536</td>
<td style="text-align: center;">1048576</td>
<td style="text-align: center;">è¶…é TIME_WAIT è¨­å®šå€¼å‰‡æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_fin_timeout</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">èª¿é™ TCP åœ¨ FIN-WAIT-2 çš„æ™‚é–“</td>
</tr>
</tbody>
</table>
<p>å¦‚æœè¦é‡å°ä¸Šè¿°çš„åƒæ•¸é€²è¡Œèª¿æ•´ï¼Œåœ¨ AKS è£¡é¢ï¼Œä½ éœ€è¦ä¾å¾ª <a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#os-configuration">è‡ªè¨‚ Azure Kubernetes Service (AKS) ç¯€é»é›†å€çš„ç¯€é»è¨­å®š</a> é€²è¡Œè¨­å®šï¼Œè€Œä¸æ˜¯ç›´æ¥é€²å»ç”¨ sysctl æ”¹æ•¸å€¼ï¼Œä½†ç›®å‰ az aks update æ²’æ”¯æ´ --linux-os-config</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>az<span class="w"> </span>aks<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>myAKSCluster<span class="w"> </span>--resource-group<span class="w"> </span>myResourceGroup<span class="w"> </span>--linux-os-config<span class="w"> </span>./linuxosconfig.json
</code></pre></div>
<p>å¦‚æœä½ æ˜¯è‡ªå»ºä½œæ¥­ç³»çµ±çš„è©±ï¼Œå°±å° /etc/sysctl.conf é€²è¡Œä¿®æ”¹å³å¯</p>
<h4 id="4-networking"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#4-networking">4. Networking</a></h4>
<h5 id="a-networking-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-networking-hardware">a. Networking Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">#</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="c1"># Networking Hardware</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="c1">#</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="c1"># é¡¯ç¤ºé è¨­ç¶²å¡ eth0 æ”¯æ´æœ€å¤§çš„ Channel å¤§å°å’Œç¾è¡Œè¨­å®šçš„å¤§å°</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -l eth0</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>Channel<span class="w"> </span>parameters<span class="w"> </span><span class="k">for</span><span class="w"> </span>eth0:
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>Pre-set<span class="w"> </span>maximums:
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>Combined:<span class="w">       </span><span class="m">4</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>Current<span class="w"> </span>hardware<span class="w"> </span>settings:
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>Combined:<span class="w">       </span><span class="m">4</span><span class="w"> </span><span class="c1"># ç”¨æ»¿äº†ï¼Œä»£è¡¨ RSS (Receive Side Scaling) æ²’å•é¡Œï¼Œåœ¨ CBL-Mariner ä¸Šå·²ç¶“æ˜¯ç¶²è·¯æœ€ä½³åŒ–ç”¨æ³•</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="c1"># ä¸‹é¢çš„ interrupts çµ±ä¸€æœƒç”± irqbalance è‡ªå‹•æ§åˆ¶ï¼Œæ­£å¸¸ç‹€æ³ä¸‹ä½ ä¸éœ€è¦æ‰‹å‹•å»ç¶­è­·ä¸‹é¢çš„ /proc/irq/25,26,27,28/smp_affinity è¨­å®š</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="c1"># systemctl status irqbalance</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/interrupts | grep mlx5_comp</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">           </span>CPU0<span class="w">       </span>CPU1<span class="w">       </span>CPU2<span class="w">       </span>CPU3
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w"> </span><span class="m">25</span>:<span class="w">   </span><span class="m">14332354</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129153</span>-edge<span class="w">      </span>mlx5_comp0@pci:3ffc:00:02.0
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w"> </span><span class="m">26</span>:<span class="w">          </span><span class="m">0</span><span class="w">         </span><span class="m">14</span><span class="w">   </span><span class="m">13861183</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129154</span>-edge<span class="w">      </span>mlx5_comp1@pci:3ffc:00:02.0
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w"> </span><span class="m">27</span>:<span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">17419688</span><span class="w">         </span><span class="m">12</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129155</span>-edge<span class="w">      </span>mlx5_comp2@pci:3ffc:00:02.0
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w"> </span><span class="m">28</span>:<span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">10673131</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129156</span>-edge<span class="w">      </span>mlx5_comp3@pci:3ffc:00:02.0
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a>...
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="c1"># é è¨­æ˜¯ä½¿ç”¨ GRO åœ¨ Linux Kernel ä¸ŠæŠŠåˆä½µå°åŒ…çš„äº‹æƒ…çµ¦è§£æ±ºäº†ï¼Œè€Œé LRO åœ¨ç¶²å¡ä¸ŠæŠŠåˆä½µå°åŒ…çš„äº‹æƒ…çµ¦è§£æ±ºäº†</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -k eth0</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a>generic-receive-offload:<span class="w"> </span>on
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a>large-receive-offload:<span class="w"> </span>off
</code></pre></div>
<h5 id="b-routing"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-routing">b. Routing</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">#</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="c1"># Linux Networking</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="c1">#</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="c1"># é¡¯ç¤ºé€™å°ç¯€é»ä¸Šçš„è·¯ç”±</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ip route</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="c1"># é€™é‚Šè¦æ³¨æ„çš„æ˜¯ï¼Œå…¶å¯¦æˆ‘æœ‰è¨­å®š UDR å¼·åˆ¶æŠŠ egress (a.k.a outbound traffic) æ‰€æœ‰æµé‡å°åˆ° Firewall (10.99.x.x) ä¸Šï¼Œä½†å¾è·¯ç”±è¡¨ä¸Šæœƒçœ‹ä¸å‡ºä¾†ï¼Œå¾—å¾ Azure Portal ä¸Šçœ‹</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="c1"># ä»¥ä¸‹æ˜¯ Node IP çš„è·¯ç”± 10.0.128.0/24ï¼ŒDefault Gateway ç‚ºè©²ç¶²æ®µçš„ç¬¬ä¸€å€‹ IPï¼Œä¹Ÿå°±æ˜¯ 10.0.128.1</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="m">10</span>.0.128.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="c1"># ä»¥ä¸‹æ˜¯ Pod IP çš„è·¯ç”±ï¼Œ10.0.129.0/24</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="m">10</span>.0.129.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="m">10</span>.0.129.5<span class="w"> </span>dev<span class="w"> </span>azv7d24922a083<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="m">10</span>.0.129.8<span class="w"> </span>dev<span class="w"> </span>azv9da73473eb2<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="m">10</span>.0.129.9<span class="w"> </span>dev<span class="w"> </span>azv6f0c6f1ef57<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="m">10</span>.0.129.10<span class="w"> </span>dev<span class="w"> </span>azvaa6ccb05bb5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="m">10</span>.0.129.13<span class="w"> </span>dev<span class="w"> </span>azvcdfece9bfdf<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="m">10</span>.0.129.14<span class="w"> </span>dev<span class="w"> </span>azvf893453cbc5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="m">10</span>.0.129.15<span class="w"> </span>dev<span class="w"> </span>azv1f6d5d20426<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="m">10</span>.0.129.16<span class="w"> </span>dev<span class="w"> </span>azvf85308aa314<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="m">10</span>.0.129.17<span class="w"> </span>dev<span class="w"> </span>azva9b3f83744f<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="m">10</span>.0.129.21<span class="w"> </span>dev<span class="w"> </span>azv224fa8c56a6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="m">10</span>.0.129.22<span class="w"> </span>dev<span class="w"> </span>azvbb0334487e3<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="m">10</span>.0.129.25<span class="w"> </span>dev<span class="w"> </span>azvca12febb7ce<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="m">10</span>.0.129.27<span class="w"> </span>dev<span class="w"> </span>azv0867699d9ac<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="m">10</span>.0.129.28<span class="w"> </span>dev<span class="w"> </span>azva412bba2170<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="m">10</span>.0.129.29<span class="w"> </span>dev<span class="w"> </span>azvd4c029379b6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="m">10</span>.0.129.30<span class="w"> </span>dev<span class="w"> </span>azv9a46f9ec6ea<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="m">10</span>.0.129.35<span class="w"> </span>dev<span class="w"> </span>azvd96d575dd35<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="m">10</span>.0.129.36<span class="w"> </span>dev<span class="w"> </span>azvee4ae66e969<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="c1"># ä¸‹é¢æ˜¯é€™å°ç¯€é»èˆ‡ Azure å¹³å°è³‡æº 168.63.129.16 æºé€šç”¨çš„è·¯ç”±</span>
<a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="m">168</span>.63.129.16<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="c1"># ä¸‹é¢æ˜¯è·Ÿ Azure Instance Metadata Service æºé€šç”¨çš„è·¯ç”±</span>
<a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="m">169</span>.254.169.254<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p>çœ‹è·¯ç”±è¡¨ä¸»è¦çš„ç›®çš„æ˜¯è¨è«– Kubernetes Egressï¼Œä¹Ÿå°±æ˜¯ Pod å¾ç¯€é»å‡ºå»çš„è·¯å¾‘æ˜¯æ€éº¼èµ°çš„ã€‚å› ç‚ºæˆ‘ä½¿ç”¨çš„ CNI (Container Networking Interface) ç‚º Azure-CNIï¼Œè€Œéä½¿ç”¨ kubenet æˆ– overlay CNI ç­‰ï¼Œæ‰€ä»¥ Pod IP å…¶å¯¦å°±æ˜¯æˆ‘æŒ‡æ´¾çš„æŸä¸€æ®µ Azure Subnet ç¶²æ®µï¼ŒæŒ‰ç…§è©²è·¯ç”±ï¼Œæ˜¯å¯ä»¥å¾åˆ¥çš„ Azure Subnet æˆ–å·²é–‹å•Ÿ VNet Peering çš„æœå‹™ç›´æ¥æ‘¸åˆ° Pod IPã€‚</p>
<p>è‹¥ä½ çš„ kube-proxy æ˜¯èµ° iptables çš„è©±ï¼Œå…¶å¯¦æ˜¯å¯ä»¥å° Node å¥— iptables rule å½±éŸ¿ä¸Šé¢çš„ Pod è·¯ç”±ï¼Œè­¬å¦‚èªªæ‹¿ ansible å°æ‰€æœ‰ç¯€é»ç›´æ¥ä¸Šè·¯ç”±ï¼Œä½†é€™å·²ç¶“é Kubernetes èƒ½ç®¡æ§çš„ç¯„åœäº†ï¼Œæ‰€ä»¥æ­£å¸¸ç‹€æ³ä¸‹éƒ½ä¸å»ºè­°åœ¨ä¸æ¸…æ¥šä¸æ˜ç™½çš„ç‹€æ³ä¸‹é€²è¡Œé€™ä»¶äº‹</p>
<h3 id="_1"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#_1">å¾Œè©±</a></h3>
<ol>
<li>å…¶å¯¦ä¸€é–‹å§‹æˆ‘åªæ˜¯æƒ³è¦ç´€éŒ„ä¸€ä¸‹ AKS Node ä¸Šçš„ä¸€äº›é è¨­åƒæ•¸ï¼Œä¸çŸ¥é“ç‚ºå•¥è¶Šå¯«è¶Šå¤šã€‚</li>
<li>å¦‚æœä½ æœ‰çœ‹æ‡‚ä¸Šé¢çš„å…§å®¹ï¼Œä½ æœƒç™¼ç¾åˆ°å…¶å¯¦ç ”ç©¶ Kubernetes å°±è·Ÿç ”ç©¶ Linux ä½œæ¥­ç³»çµ±æ˜¯æ²’ä»€éº¼å¤ªå¤§å€åˆ¥çš„ï¼Œä¸å¦‚èªª Kubernetes å¹«ä½ æŠ½è±¡åŒ–äº†å¾ˆå¤šäº‹æƒ…ï¼Œè®“ä½ ä¸ç”¨çŸ¥é“å¾—å¤ªç´°ï¼Œé›–ç„¶è®Šç›¸ä½ éœ€è¦å­¸ç¿’çš„å°±æ˜¯ Kubernetes çš„èªè¨€ï¼Œå¾å­¸ç¿’ shell æ”¹æˆåˆ° kubectl çš„æ“ä½œ</li>
<li>çœ‹è‘—ä¸Šé¢çš„å…§å®¹ï¼Œæ‰€ä»¥æˆ‘å¹³æ™‚æ‰æœƒå¾ˆå¸¸èªªï¼Œä½œæ¥­ç³»çµ±çš„ç©©å®šèˆ‡å¦æœƒç›´æ¥å½±éŸ¿ Kubernetes çš„ç©©å®šæ€§ï¼Œæ»¿æ»¿åœ°ä½œæ¥­ç³»çµ±åƒæ•¸ç´°ç¯€</li>
<li>AKS Node æ˜¯æœ‰è€ƒæ…®åˆ°å¤§éƒ¨åˆ†çš„ä½¿ç”¨è€…éƒ½ä¸æœƒå»çœ‹é€™äº›åƒæ•¸ï¼Œèª¿æ•™æ˜¯ä»¥ C1000K ç‚ºç›®æ¨™åŸºæº–å…ˆå¹«å¤§å®¶èª¿å¥½äº†ï¼Œæ‰€ä»¥æ²’ç‰¹æ®Šç‹€æ³ä¸‹éƒ½å¯ä»¥é †é †ç”¨ï¼Œä¹Ÿä¸å¤ªæœƒæœ‰ç¯€é»ç¡¬é«”+ä½œæ¥­ç³»çµ±æ•ˆèƒ½å•é¡Œï¼Œè‡ªå»ºçš„å°±è¦è‡ªå·±åŠ æ²¹äº†</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#qa">Q&amp;A</a></h3>
<h4 id="q1-azure-vm-ht"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q1-azure-vm-ht">Q1: å¦‚ä½•é‡å° Azure VM é—œé–‰ HT åŠŸèƒ½?</a></h4>
<p>é‡é–‹æ‰æœƒç”Ÿæ•ˆ</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>az<span class="w"> </span>resource<span class="w"> </span>tag<span class="w"> </span>--ids<span class="w"> </span>/subscriptions/<span class="o">{</span>SubID<span class="o">}</span>/resourceGroups/<span class="o">{</span>ResourceGroup<span class="o">}</span>/providers/Microsoft.Compute/virtualMachines/<span class="o">{</span>VM<span class="o">}</span><span class="w"> </span>--tags<span class="w"> </span>platformsettings.host_environment.disablehyperthreading<span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>az<span class="w"> </span>vm<span class="w"> </span>restart<span class="w"> </span>-g<span class="w"> </span><span class="o">{</span>ResourceGroup<span class="o">}</span><span class="w"> </span>-n<span class="w"> </span><span class="o">{</span>VM<span class="o">}</span>
</code></pre></div>
<h4 id="q2-azure-vm-instance-metadata"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q2-azure-vm-instance-metadata">Q2: å¦‚ä½•ç²å–è©² Azure VM çš„ Instance Metadata?</a></h4>
<p>æ ¹æ“šæ­¤æ–‡ <a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a>ï¼Œå¯é€éä»¥ä¸‹æ–¹å¼ç²å–</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># curl -s -H Metadata:true --noproxy &quot;*&quot; &quot;http://169.254.169.254/metadata/instance?api-version=2021-02-01&quot; | jq</span>
</code></pre></div>
<h4 id="q3-eth0-channel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q3-eth0-channel">Q3: å¦‚æœæœ‰è¦èª¿æ•´ eth0 çš„ channel å¤§å°è©²æ€éº¼åš?</a></h4>
<p>å¦‚æœä½ æ˜¯ç”¨ AKS çš„ä½¿ç”¨è€…ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¸ç”¨æ”¹ï¼Œé è¨­ä¸€é–‹å§‹éƒ½å¼„å¥½äº†</p>
<p>æš«æ™‚è™•ç†æ–¹å¼ï¼Œå› ç‚ºé€™å€‹æ˜¯æš«æ™‚æ€§è¨­å®šï¼Œå¦‚æœè©² AKS ç¯€é»è¢«ç§»é™¤äº†ï¼Œæ–°å¢ç¯€é»æˆ–æ—¢æœ‰çš„ç¯€é»ä¸¦ä¸æœƒæœ‰é€™å€‹åŠŸèƒ½</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>$<span class="w"> </span>ethtool<span class="w"> </span>-L<span class="w"> </span>eth0<span class="w"> </span>combined<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<h4 id="q4-platformsettingshost_environmentdisablehyperthreading-true"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q4-platformsettingshost_environmentdisablehyperthreading-true">Q4: ä½•æ™‚æœƒé¸æ“‡æŠŠ <code>platformsettings.host_environment.disablehyperthreading: true</code> åƒæ•¸å¥—ä¸Šå»</a></h4>
<p>è·‘ HPC é«˜æ•ˆèƒ½è¨ˆç®—é¡å‹çš„éƒ½è »é©åˆçš„ï¼Œä½ æœƒéœ€è¦å®Œæ•´çš„æ ¸å¿ƒè¨ˆç®—èƒ½åŠ›ï¼Œè­¬å¦‚èªª EDA / ç®—åœ– ç­‰</p>
<h4 id="q5-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q5-c1000k">Q5: å–®å° C1000K æ˜¯æ€éº¼ç®—å‡ºä¾†çš„? é è¨­å•¥éƒ½æ²’åšçš„ç‹€æ³ä¸‹è¨˜æ†¶é«”æ¶ˆè€—ç‚ºä½•?</a></h4>
<p>Linux é–‹æª”é™åˆ¶ä¸»è¦å¡ 3 å€‹é»ï¼Œä¸‰è€…ç¼ºä¸€ä¸å¯ï¼Œä»¥ CBL-Mariner ä¾†çœ‹çš„è©±ï¼Œé è¨­å€¼å¦‚ä¸‹æ‰€åˆ—ï¼Œæ•…å–®å°æœ€å¤§å¯é–‹æª”æ•¸é‡ç‚º 1048576ï¼Œç´„ C1000K</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Level</th>
<th style="text-align: center;">Parameters</th>
<th style="text-align: center;">Value</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OS</td>
<td style="text-align: center;">sysctl -n fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td>ç•¶å‰ç³»çµ±æœ€å¤§å¯é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">Process</td>
<td style="text-align: center;">sysctl -n fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td>å–®ä¸€ç¨‹åºå¯é–‹æª”æœ€å¤§æ•¸é‡ï¼Œä¸€å®šè¦æ¯” hard nofile å¤§</td>
</tr>
<tr>
<td style="text-align: center;">User</td>
<td style="text-align: center;">ulimit -n</td>
<td style="text-align: center;">1048576</td>
<td>ç•¶å‰ä½¿ç”¨è€…å¯é–‹æª”æœ€å¤§æ•¸é‡</td>
</tr>
</tbody>
</table>
<p>ç¶­æŒ 1 å€‹ TCP Connection ç´„ç•¥æ¶ˆè€— 3.3 KB çš„è¨˜æ†¶é«”ï¼Œæ•…å‡è¨­å…¨éƒ¨ 1048576 éƒ½é–‹èµ·ä¾†çš„è©±ï¼Œä¿æŒ Long Lived TCP Connectionï¼Œä½†éƒ½æ²’å‚³è¼¸å…¶ä»–æ±è¥¿çš„è©±ï¼Œå¤§æ¦‚å°± 3.3 GB = 1048576 * 3.3 KBï¼Œä½†é€™æ˜¯ç†æƒ³å€¼ï¼Œå¯¦éš›ä¸Šæœƒå¤§ä¸€é»ï¼Œç”±æ­¤å¯çŸ¥ï¼Œé€£ç·šæ•¸é‡çš„å¤šå¯¡å…¶å¯¦é‚„æœ‰å—é™æ–¼è¨˜æ†¶é«”çš„å¤šå¯¡ï¼Œè€Œéåƒ…å—ä¸Šè¿°çš„é–‹æª”æ•¸é‡é™åˆ¶</p>
<h4 id="q6-1048576-50-tcp-connection-tcp-connection-1-kbs"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q6-1048576-50-tcp-connection-tcp-connection-1-kbs">Q6: å¦‚æœ 1048576 æœ‰ 50% æ´»èº TCP Connectionï¼Œæ¯å€‹ TCP Connection éœ€è¦å‚³ 1 KB/s çš„è³‡æ–™ï¼Œé€™æ¨£ç¶²å¡éœ€è¦å¤šå¤§?</a></h4>
<p>é€™å€‹è¦ç®—é »å¯¬ (Bandwidth)ï¼Œä¹Ÿå°±æ˜¯è¦ç®—æ°´ç®¡çš„å¤§å°ï¼Œé€™ç¯‡æœ‰ä¸€å€‹å°å¼Ÿæ—©æœŸå¸¸ç”¨çš„è¡¨ <a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></p>
<p><img alt="" src="/images/throughput-bandwidth.png" /></p>
<p>[(1048576 TCP Connection * 50% * 1KB/s) / 1024] = 512 MB/s * 8 bits = 4096 Mbps = 4 Gbps</p>
<p>æœ€å°‘ä½ ä¹Ÿè¦æœ‰ 4 Gbps Bandwidth æ‰èƒ½æ‰¿å—é€™å€‹é‡é«”ï¼Œè€Œ Azure VM çš„ç¶²è·¯é »å¯¬æ˜¯åŸºæ–¼ Instance çš„é¸æ“‡ä¸åŒï¼Œè€Œä¸æ˜¯çœ‹å…§å»ºç¶²å¡çš„è¨­å®š (ethtool eth0)ï¼Œæ‰€ä»¥å¯å¾ <a href="https://learn.microsoft.com/zh-tw/azure/virtual-machines/dasv5-dadsv5-series">Dasv5 å’Œ Dadsv5 ç³»åˆ—</a> ä¸­çš„ <code>Standard_D4as_v5</code> çš„æœ€å¤§ç¶²è·¯é »å¯¬ (Max network bandwidth) å¯å¾—çŸ¥ç‚º 12500 Mbpsï¼Œé å¤§æ–¼æ‰€éœ€çš„ 4096 Mbpsï¼Œæ•…é€™å° Standard_D4as_v5 æ˜¯å¯ä»¥æ”¯æ´å•é¡Œæ‰€éœ€çš„è³‡æ–™å‚³è¼¸é‡</p>
<p>æ­¤å¤–ï¼Œå¦‚æœä½ åœ¨ AKS é›†ç¾¤å¤–é¢æœ‰ç”¨ UDR ä¸Ÿçµ¦ Azure Firewall çš„è©±ï¼Œæ ¹æ“š <a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a> çš„æ¯”è¼ƒè¡¨ï¼Œä½ éœ€è¦é¸æ“‡ SKU æœ€å°ç‚º Standard (30 Gbps) æˆ– Premium (100 Gbps)ï¼Œè€Œä¸èƒ½é¸ Basicï¼Œä¸ç„¶æ•´å€‹é »å¯¬æœƒå¡åœ¨ 250 Mbps</p>
<h4 id="q7-ulimit-n"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q7-ulimit-n">Q7: å¦‚ä½•èª¿æ•´ ulimit -n çš„å€¼?</a></h4>
<p>å¦‚æœä½ æ˜¯ç”¨ AKS çš„ä½¿ç”¨è€…ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¸ç”¨æ”¹ï¼Œé è¨­ä¸€é–‹å§‹éƒ½å¼„å¥½äº†</p>
<p>å¦‚æœä½ æ˜¯è‡ªæ¶ä½œæ¥­ç³»çµ±çš„ï¼Œå°±ç…§ä¸‹é¢çš„è¨­å®šå³å¯</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># å¦‚æœæ²’ç‰¹åˆ¥èª¿éçš„ï¼Œæ‡‰è©²éƒ½æ˜¯ 1024 ç‚ºä¸»ï¼Œè­¬å¦‚åƒ RHEL 9.2 å’Œ RHEL 8.8 å°±æ˜¯é€™æ¨£</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="m">1024</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="c1"># å…©è€…å–å…¶ä½</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>$<span class="w"> </span>vim<span class="w"> </span>/etc/security/limits.conf
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>*<span class="w"> </span>soft<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>*<span class="w"> </span>hard<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="c1"># ä¸ç”¨ rebootï¼Œç™»å‡ºå†ç™»å…¥å°±å¥½</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>$<span class="w"> </span>logout<span class="p">;</span><span class="w"> </span>login
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="m">1048576</span>
</code></pre></div>
<h3 id="reference"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#reference">Reference</a></h3>
<ul>
<li><a href="https://lotabout.me/2021/Linux-Available-Memory/">æˆ‘çš„å†…å­˜å‘¢ï¼ŸLinux MemAvailable å¦‚ä½•è®¡ç®—</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux">Guidance for mitigating silicon based micro-architectural and speculative execution side-channel vulnerabilities</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></li>
<li><a href="https://github.com/microsoft/CBL-Mariner">microsoft/CBL-Mariner</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#linux-kubelet-custom-configuration">è‡ªè¨‚ Azure Kubernetes Service (AKS) ç¯€é»é›†å€çš„ç¯€é»è¨­å®š - Linux Kubelet è‡ªè¨‚è¨­å®š</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a></li>
<li><a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a></li>
<li><a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a></li>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li><a href="https://time.geekbang.org/column/article/262085">ç¬¬315æœŸ | ä»€ä¹ˆæ˜¯C10Kï¼Ÿå¦‚ä½•åšåˆ°C1000Kï¼Ÿ</a></li>
<li><a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></li>
<li><a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">Green Software Practitioner - Increasing device utilization</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-13 00:00:00">October 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">äººå®¶éƒ½åœ¨æŠ“ç¥å¥‡å¯¶è²ï¼Œè€Œæˆ‘åœ¨æŠ“ Kubernetes å°åŒ…</a></h2>
<blockquote>
<p>Wireshark: Packet Don't Lie.</p>
</blockquote>
<p><img alt="" src="/images/life-is-hard.jpg" /></p>
<p>æ–‡ç«  <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a> æåˆ°å¦‚ä½•é ç«¯æŠ“å–®é«” VM å°åŒ…ï¼Œé‚£åŒæ¨£çš„æ‹›æ•¸å¯ä¸å¯ä»¥å»æŠ“ Azure Kubernetes Service ç‰¹å®š Pod è£¡é¢çš„å°åŒ…? ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œæ­é… ksniff ä¾†åšå°±å¥½</p>
<!--more-->

<h3 id="kubernetes_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#kubernetes_1">ä¾†æŠ“ Kubernetes å°åŒ…</a></h3>
<h4 id="_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_1">æ¶æ§‹åœ–</a></h4>
<p><img alt="" src="/images/w9.png" /></p>
<ol>
<li>å› ç‚ºæˆ‘ä¸èƒ½ç›´æ¥å¾å®¶è£¡é€£ç·šåˆ° Azure Kuberentes Serviceï¼Œæ‰€æœ‰æ“ä½œéƒ½éœ€è¦é€é Bastion VM é€²è¡Œæ“ä½œé€£ç·šï¼Œæ‰€ä»¥éœ€è¦å…ˆç”¨ SSH é€£ç·šåˆ° Bastion VM æ‰èƒ½åšäº‹</li>
<li>kubectl ä¸€å®šè¦èƒ½å° Private AKS æ“ä½œï¼Œä¸ç„¶ ksniff æˆ–ç¨‹å¼ä½ éƒ½ç„¡æ³•éƒ¨ç½²ä¸‹å»</li>
<li>æ•´å¼µåœ–æˆ‘æ²’æçš„éƒ¨åˆ†å°±æ˜¯ Private AKS å’Œ VM çš„ UDR è¨­å®šï¼Œä½†é€™å€‹å¤ª Azure Networking å…ˆè·³é</li>
<li>ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘æ˜¯å¼·çƒˆå»ºè­°äººäººéƒ½è¦æœ‰ä¸€å€‹ debug container å¥½å»åšä¸€äº›è§€è½é™°çš„äº‹æƒ…ï¼Œè©³è¦‹ <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a>ï¼Œé€™é‚Šä¸è´…è¿°</li>
</ol>
<h4 id="0-ksniff"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#0-ksniff">0. å®‰è£ ksniff</a></h4>
<p>è«‹ç›´æ¥åƒè€ƒ <a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a> æ–‡ä»¶ï¼Œå¦å¤–å®ƒçš„å‰ç½®ä½œæ¥­æ˜¯è¦è£ <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a>ï¼Œå‹™å¿…è¦æŠŠ krew PATH è¨­å®šå¥½</p>
<h4 id="1-httpbin-re"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#1-httpbin-re">1. éƒ¨ç½² httpbin-re æœå‹™</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># ç¢ºå®š kubectl é‹ä½œæ­£å¸¸ä¸”å¯ä»¥é€£ç·šåˆ° Private AKS</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Kubernetes<span class="w"> </span>control<span class="w"> </span>plane<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>CoreDNS<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>Metrics-server<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># è·‘ä¸€å€‹ http server æœå‹™èµ·ä¾†</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/httpbin-re/master/k8s/httpbin-re.yaml
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>deployment.apps/httpbin-re<span class="w"> </span>created
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>service/httpbin-re<span class="w"> </span>created
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="c1"># ç¢ºèªæœå‹™æœ‰æ­éœ²å‡ºä¾†</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>httpbin-rek
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>NAME<span class="w">         </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">    </span>AGE
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>httpbin-re<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.0.133.240<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">8080</span>/TCP<span class="w">   </span>7h26m
</code></pre></div>
<p>ä¸»è¦æ˜¯è¦éƒ¨ç½²ä¸€å€‹ HTTP Serverï¼Œå¾…æœƒè¦é€é Ksniff å»è§€å¯Ÿé€™å€‹æœå‹™çš„ç‹€æ³ï¼Œå¦‚æœä½ æœ‰å…¶ä»–æœå‹™ä¹Ÿå¯ä»¥è‡ªè¡Œæ›¿æ›ï¼Œé€™é‚Šå°±æ˜¯ Demo æ–¹ä¾¿</p>
<h4 id="2-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#2-pod">2. éƒ¨ç½²é™ªæ¸¬ç”¨ Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># éƒ¨ç½²é™ªæ¸¬ç”¨ Podï¼Œç”¨é †æ‰‹çš„å°±å¥½ï¼Œæˆ–è€…æ˜¯ä½ å¯ä»¥è€ƒæ…®ç”¨ nicolaka/netshoot</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/debug-container/master/debug-container.yaml
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>pod/debug-container<span class="w"> </span>created
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="c1"># æ¸¬è©¦å¯ä»¥è·Ÿ httpbin-re é€£ç·šï¼ŒåŒ namespaceï¼Œä¸åŒ Pod</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl http://&lt;svc name&gt;/path</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default.svc:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>&lt;!DOCTYPE<span class="w"> </span>html&gt;
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>&lt;html<span class="w"> </span><span class="nv">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span>&gt;
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>...omit...
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="c1"># æ¸¬è©¦å¯ä»¥è·Ÿ metrics-server é€£ç·šï¼Œä¸åŒ namespaceï¼Œä¸åŒ Pod</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl --insecure https://&lt;svc name&gt;.&lt;namespace&gt;:&lt;svc port&gt;/path</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system.svc:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="o">{</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">  </span><span class="s2">&quot;kind&quot;</span>:<span class="w"> </span><span class="s2">&quot;Status&quot;</span>,
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">  </span><span class="s2">&quot;apiVersion&quot;</span>:<span class="w"> </span><span class="s2">&quot;v1&quot;</span>,
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">  </span><span class="s2">&quot;metadata&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">  </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;Failure&quot;</span>,
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">  </span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/metrics\&quot;&quot;</span>,
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">  </span><span class="s2">&quot;reason&quot;</span>:<span class="w"> </span><span class="s2">&quot;Forbidden&quot;</span>,
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">  </span><span class="s2">&quot;details&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">  </span><span class="s2">&quot;code&quot;</span>:<span class="w"> </span><span class="m">403</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="o">}</span>%
</code></pre></div>
<p>é—œæ–¼é€™å€‹ä»¥ Pod ç‚ºå‡ºç™¼é»ï¼Œæœå‹™ä¹‹é–“çš„é€£ç·šè­°é¡Œï¼Œä»¥å‰æœ‰å¯«é<a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a> ä¸€æ–‡ï¼Œè£¡é¢æœ‰æ¯”è¼ƒä»”ç´°çš„èªªæ˜ï¼Œé€™é‚Šå°±ä¸è´…è¿°äº†</p>
<h4 id="3-httpbin-re-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#3-httpbin-re-pod">3. é ç«¯æŠ“ httpbin-re Pod çš„å°åŒ…</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># åˆ—èˆ‰å‡º httpbin-re Pod çš„åç¨±</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>-owide
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>NAME<span class="w">                          </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">     </span>IP<span class="w">            </span>NODE<span class="w">                                </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>debug-container<span class="w">               </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>15m<span class="w">     </span><span class="sb">`</span><span class="m">10</span>.0.129.18<span class="sb">`</span><span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>httpbin-re-866499b564-blc95<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="m">10</span>.0.129.6<span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>httpbin-re-866499b564-xl726<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="sb">`</span><span class="m">10</span>.0.129.9<span class="sb">`</span><span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>ksniff-grlzn<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>82s<span class="w">     </span><span class="m">10</span>.0.129.33<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>ksniff-n9ps6<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36m<span class="w">     </span><span class="m">10</span>.0.129.29<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># é€é ksniff ä¾†æŠ“å°åŒ…</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; &quot;/bin/bash --login -c &#39;kubectl sniff -n &lt;namespace&gt; &lt;pod name&gt; -p -o -&#39;&quot; | /mnt/c/Program\ Files/Wireshark/Wireshark.exe -k -i -</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span><span class="s2">&quot;/bin/bash --login -c &#39;kubectl sniff -n default httpbin-re-866499b564-xl726 -p -o -&#39;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p>é€™é‚Šè¦æ³¨æ„çš„æ˜¯ <code>/bin/bash --login -c</code>ï¼Œå› ç‚º SSH ç™»å…¥çš„æ™‚å€™åƒçš„ $PATH é è¨­æ˜¯ä¸æœƒå»åƒ ~/.bashrcï¼Œå¯ä»¥ç”¨ <code>env</code> é©—è­‰çœ‹çœ‹ï¼Œæ‰€ä»¥éœ€è¦å…ˆç”¨ <code>--login</code> å¾Œæ‰èƒ½æ­£ç¢ºå’¬åˆ° $PATH è£¡é¢çš„ krew è·¯å¾‘ï¼Œå…¶é¤˜å°±æ˜¯ pipeline å’Œ I/O çš„ä¸²æµè™•ç†äº†</p>
<p><img alt="" src="/images/w8.png" /></p>
<p>æ­¤å¤–ï¼ŒåŸå…ˆæ‡‰è©²è¦å¡« Ethernet Header (12 bytes) çš„æ¬„ä½ï¼Œæœƒè®Šæˆ <code>Linux cooked capture v2 (SLL_v2)</code>ï¼ŒæŒ‰ç…§ <a href="https://wiki.wireshark.org/SLL.md">Linux cooked-mode capture (SLL)</a> çš„èªªæ˜ï¼Œé€™æ˜¯ä¸€å€‹å½é€ å”è­°ï¼Œå°åˆ†æ Kubernetes ä¸Šçš„æœå‹™æ¯”è¼ƒæ²’ä»€éº¼å½±éŸ¿ï¼Œå› ç‚ºä¸»è¦éƒ½æ˜¯çœ‹ L3 / L4 å±¤ç´šå±…å¤šï¼ŒåŒ…å« Pod IP / Pod Port / Service IP / Service Port / Node Port ç­‰ï¼ŒåŒå ´åŠ æ˜ ä¸€ä¸‹ï¼Œ<a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">
HWCHIU å­¸ç¿’ç­†è¨˜ - Kubernetes ä¹‹å°åŒ…å»å“ªå…’</a></p>
<h4 id="4-ksniff-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#4-ksniff-pod">4. æ¸…é™¤ ksniff Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>NAME<span class="w">           </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>ksniff-g4bjz<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11m
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>ksniff-j7gnc<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>ksniff-kxfl5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m54s
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>ksniff-lb4xg<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>6m29s
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>ksniff-n9ps6<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>68m
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>ksniff-sph6l<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m17s
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>ksniff-v2vd5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>14m
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>ksniff-vl627<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-g4bjz&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-j7gnc&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-kxfl5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-lb4xg&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-n9ps6&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-sph6l&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-v2vd5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-vl627&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<p>é€€å‡ºçš„æ™‚å€™çœ‹èµ·ä¾†æ˜¯ä¸æœƒé †ä¾¿æŠŠ ksniff çš„ Pod ç§»é™¤æ‰ï¼Œè¨˜å¾—è¦æ‰‹å‹•ç§»é™¤ï¼Œä¸ç„¶æœƒæœ‰è³‡æºæµªè²»çš„å•é¡Œ</p>
<h3 id="_2"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_2">å¾Œè©±</a></h3>
<p>ksniff æ²’æœ‰åƒæ•¸å¯ä»¥è®“æˆ‘å»æå°åŒ…å¤§å°ï¼Œæ²’æ„å¤–çš„è©±ï¼Œé‚„éœ€è¦å†è·³æ¿æ©Ÿå¤šä¸€æ®µ tcpdump pipeline è™•ç†ï¼Œä½†é€™æ¨£å°±æœƒæ”¶åˆ°ä¸€å †æœ‰çš„æ²’çš„å°åŒ…ï¼Œé‚„æ²’æƒ³åˆ°æ€éº¼ç”¨</p>
<h3 id="qa"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#qa">Q&amp;A</a></h3>
<h4 id="q1-red-hat-openshift-container-platform-azure-red-hat-openshift"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#q1-red-hat-openshift-container-platform-azure-red-hat-openshift">Q1: å¦‚æœæˆ‘æ˜¯ Red Hat OpenShift Container Platform æˆ– Azure Red Hat OpenShift çš„ä½¿ç”¨è€…ï¼Œä½†æ¬Šé™é–è¶…åš´çš„æ€éº¼è¾¦?</a></h4>
<p>é€™å€‹åªèƒ½èªª Red Hat ä¸€å¦‚æ—¢å¾€åœ°å·²ç¶“å…ˆå¹«å¦³æ•´å¥½åˆ° oc å»äº†ï¼Œä½ ä¸ç”¨ç‰¹åˆ¥è£ ksniffï¼Œæ¬Šé™å°±æ˜¯ç…§ä½ æ‹¿åˆ°çš„ kubeconfig ç‚ºä¸»</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$ oc version
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Client Version: 4.12.36
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Kustomize Version: v4.5.7
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>Kubernetes Version: v1.27.3
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>$ oc sniff
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>Usage:
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>  sniff pod [-n namespace] [-c container] [-f filter] [-o output-file] [-l local-tcpdump-path] [-r remote-tcpdump-path] [flags]
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>Examples:
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>kubectl sniff hello-minikube-7c77b68cff-qbvsd -c hello-minikube
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>Flags:
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>  -c, --container string                container (optional)
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>  -x, --context string                  kubectl context to work on (optional)
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>  -f, --filter string                   tcpdump filter (optional)
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>  -h, --help                            help for sniff
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>      --image string                    the privileged container image (optional)
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>  -i, --interface string                pod interface to packet capture (optional) (default &quot;any&quot;)
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>  -l, --local-tcpdump-path string       local static tcpdump binary path (optional)
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>  -n, --namespace string                namespace (optional)
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>  -o, --output-file string              output file path, tcpdump output will be redirect to this file instead of wireshark (optional) (&#39;-&#39; stdout)
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>      --pod-creation-timeout duration   the length of time to wait for privileged pod to be created (e.g. 20s, 2m, 1h). A value of zero means the creation never times out. (default 1m0s)
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>  -p, --privileged                      if specified, ksniff will deploy another pod that have privileges to attach target pod network namespace
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>  -r, --remote-tcpdump-path string      remote static tcpdump binary path (optional) (default &quot;/tmp/static-tcpdump&quot;)
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>      --socket string                   the container runtime socket path (optional)
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>      --tcpdump-image string            the tcpdump container image (optional)
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>  -v, --verbose                         if specified, ksniff output will include debug information (optional)
</code></pre></div>
<h3 id="references"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a></li>
<li><a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a></li>
<li><a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a></li>
<li><a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a></li>
<li><a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">Kubernetes ä¹‹å°åŒ…å»å“ªå…’</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-13 00:00:00">July 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="distroless-container-kubectl-debug"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></h2>
<p>é€™ç¯‡åªæœ‰ Red Hat OpenShift ç‚ºä¸»çš„ä½¿ç”¨è€…ä¸ç”¨çœ‹ï¼Œé‚£å€‹æ—©åœ¨ v3.6 å¥½å¹¾å¹´å‰å°±å¼„äº†ä¸€å€‹ <code>oc debug</code> å‡ºä¾†äº†ï¼Œä½†ä½ è‹¥æ˜¯ä¸€èˆ¬ Kubernetes ç™¼è¡Œç‰ˆçš„ï¼Œä¾‹å¦‚ Tanzu Kubernetes Grid æˆ– Azure Kubernetes Service ç­‰ï¼Œå‰‡å¯ä»¥åƒè€ƒä¸€ä¸‹æ­¤ç¯‡ä½œæ³•ã€‚ä¸»è¦æ˜¯æœƒç”¨åˆ° <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a> å’Œ <a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">kubectl debug</a> é€™å…©å€‹ä¸»è¦èƒ½åŠ›ï¼Œè€Œç›®å‰éƒ½æ˜¯åœ¨ Kubernetes v1.25 æ¨™è¨» Stable ç©©å®šç‹€æ…‹</p>
<p><img alt="" src="/images/title-kubectl-debug.png" /></p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#_1">å…¸å‹ç‹€æ³</a></h3>
<p>æœ‰æ™‚å€™ä½ æœƒé‡åˆ°ä¸€å€‹ Container Images æ˜¯æ¡ Distroless çš„æ–¹å¼é‹è¡Œï¼Œç‰¹æ€§æ˜¯é™¤äº†ç¨‹å¼æœ¬èº«ä»¥å¤–ï¼Œä»€éº¼ Shell éƒ½æ²’æœ‰ï¼Œç„¡æ³•ç™»å…¥é€²å»ï¼Œæˆ–è€…æ˜¯ä½ é€²å¾—å»çœ‹èµ·ä¾†æœ‰å•é¡Œçš„ Pod æƒ³è¦é€²è¡Œä¸€äº›é™¤éŒ¯çš„å‹•ä½œï¼Œä½†å‰›å¥½æ²’æœ‰è£ä»»ä½•å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œé€™æ™‚å€™è©²æ€éº¼è¾¦å‘¢? å…¶å¯¦ä½ éœ€è¦è¦æº–å‚™ä¸€å€‹è‡ªå·±ç·¨è­¯å¥½çš„ <a href="https://github.com/pichuang/debug-container">debug-container</a> å’Œå­¸ç¿’ä¸€ä¸‹ <code>kubectl debug</code> çš„ç”¨æ³•</p>
<p>é€™é‚Šå‰›å¥½æœ‰ä¸€å€‹ Azure Kubernetes Service å¸¸è¦‹çš„ç‹€æ³ï¼Œå°±æ˜¯è‹¥æƒ³è¦ç™»å…¥åˆ° CoreDNS Pod è£¡é¢æŸ¥çœ‹ Corefile çš„å…§å®¹ï¼Œä½ æœƒç™¼ç¾åˆ°å®ƒæœƒä¸€ç›´å™´ <code>no such file or directory: unknown</code> ä¹‹é¡çš„éŒ¯èª¤ï¼Œå…¶å¯¦æ˜¯å› ç‚ºé€™å€‹ Pod è£¡é¢æ ¹æœ¬æ²’æœ‰ /bin/bash æˆ–è€…æ˜¯ /bin/cat çš„æŒ‡ä»¤å¯ä»¥ç”¨ï¼Œå¯ä»¥ç®—æ˜¯å¾ˆæ‰å¯¦çš„ Distroless Container å¯¦å‹™æ¡ˆä¾‹</p>
<p><img alt="" src="/images/coredns-error.png" /></p>
<div class="highlight"><span class="filename">before</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>kube-dns
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>coredns-6698ddd997-gx66m<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>coredns-6698ddd997-rxlsl<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;0f831ab9a9d243bb196e31d6578b19ea13088cdfeec57fb1953c3021a0463d12&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span>:<span class="w"> </span>stat<span class="w"> </span>/bin/bash:<span class="w"> </span>no<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory:<span class="w"> </span>unknown
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;7b5e958107188e3b7748a27138774775dbcebcb8c6bd178b357d187bda720bc9&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;cat&quot;</span>:<span class="w"> </span>executable<span class="w"> </span>file<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$PATH</span>:<span class="w"> </span>unknown
</code></pre></div>
<p>ä¸‹é¢æä¾›ç”¨ <a href="https://github.com/wagoodman/dive">dive</a> æ‰€åˆ†æçš„å®¹å™¨æ˜ åƒæª”å…§å®¹</p>
<p><img alt="" src="/images/dive.png" /></p>
<h3 id="2"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2">2 å€‹å‰ç½®æº–å‚™</a></h3>
<ol>
<li>æº–å‚™ä¸€å€‹å…·å‚™å¯ç”¨ Shell è·Ÿå…¶ä»–é™¤éŒ¯ç”¨å·¥å…·çš„ Ephemeral Container Imageï¼Œå¦‚æˆ‘è‡ªå·±ç·¨è­¯çš„ <a href="https://github.com/pichuang/debug-container">pichuang/debug-container:master</a>ï¼ŒåŸºæ–¼ CentOS Streamï¼Œæ¯æ—¥æ›´æ–°ï¼Œç°¡å–®ç›´è¦º</li>
<li>ä½¿ç”¨ <code>kubectl debug</code>ï¼Œç¢ºä¿ä½ çš„ kubectl ç‰ˆæœ¬æ˜¯å¤§æ–¼ v1.25ï¼Œç›®å‰é€™å€‹åŠŸèƒ½æ˜¯å…§å»ºåœ¨ kubectl è£¡é¢ï¼Œä¸éœ€è¦é¡å¤–è£ krew plugin å³å¯ä½¿ç”¨</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version<span class="w"> </span>--short
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.1
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.26.3
</code></pre></div>
<h3 id="2_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2_1">2 å€‹è§£æ±ºæ–¹å¼</a></h3>
<ol>
<li>ä½¿ç”¨ <code>--target</code>: ç›´æ¥å° Target Container é€²è¡Œæ“ä½œï¼Œå¸¸è¦‹å¦‚ Pod Running ä¸­æ²’ä»€éº¼å•é¡Œï¼Œä½†å‰›å¥½å®ƒæ˜¯ distroless imagesï¼Œç¼ºå°‘ä¸€å †å¯åŸ·è¡Œ binã€‚é€™æ™‚å€™è‹¥ä½ åªæ˜¯æƒ³è¦åšä¸€äº›åŸºæœ¬æ¸¬è©¦ï¼Œè­¬å¦‚ç¶²è·¯æ¸¬è©¦ç­‰ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ <code>--target</code> æ–¹å¼æŠŠè‡ªå·±æº–å‚™çš„ Ephemeral Container æ›é€²å»ä½¿ç”¨ï¼Œç„¡é ˆç‰¹åˆ¥ä¿®æ”¹ä¹Ÿç„¡é ˆé‡é–‹</li>
<li>ä½¿ç”¨ <code>--copy-to</code>: Copy ä¸€ä»½ Pod å‡ºå»å¦å¤–ç ”ç©¶ï¼Œæœ€å¸¸è¦‹çš„ä½¿ç”¨æ–¹å¼ï¼Œåèˆ‰é‡åˆ° Completed æˆ– CrashLoopBackOff ç­‰ç„¡æ³•ä½¿ç”¨ kubectl exec æ–¹å¼é€²å…¥çš„ Pod ä¸”æƒ³è¦çŸ¥é“åˆ°åº•æ­»åœ¨é‚£è£¡ï¼Œå¯ä»¥æ›ä¸€å€‹ Ephemeral Container ä¿®æ”¹é€²å…¥é»æˆ–å‘½ä»¤ç ”ç©¶çœ‹çœ‹</li>
</ol>
<h4 id="1-target"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#1-target">1. ä½¿ç”¨ <code>--target</code></a></h4>
<p><img alt="" src="/images/target-debug.png" /></p>
<div class="highlight"><span class="filename">target</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">#</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --target=&lt;TARGET CONTAINER NAME&gt;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1">#</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--target<span class="o">=</span>coredns
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>Targeting<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;coredns&quot;</span>.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>processes<span class="w"> </span>from<span class="w"> </span>this<span class="w"> </span>container<span class="w"> </span>it<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>because<span class="w"> </span>the<span class="w"> </span>container<span class="w"> </span>runtime<span class="w"> </span>doesnt<span class="w"> </span>support<span class="w"> </span>this<span class="w"> </span>feature.
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-pbsr4.
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>root<span class="w">           </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">762456</span><span class="w"> </span><span class="m">46012</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">07</span>:24<span class="w">   </span><span class="m">0</span>:01<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>root<span class="w">          </span><span class="m">63</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3284</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">07</span>:33<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>root<span class="w">          </span><span class="m">88</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">44708</span><span class="w">  </span><span class="m">3380</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">07</span>:35<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/1/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span>errors
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span>ready
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="c1">#</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="c1"># Qeury ephemeralContainerStatuses</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="c1">#</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="c1"># kubectl -n kube-system get pod coredns-6698ddd997-gx66m -o jsonpath=&#39;{range .status.ephemeralContainerStatuses[*]}{.name}{&quot;\t&quot;}{.ready}{&quot;\n&quot;}{end}&#39;</span>
</code></pre></div>
<p>å¦‚æœè¦æŸ¥ Ephmeral Container çš„ç‹€æ…‹ï¼Œè¦å¾ <code>.status.ephemeralContainerStatuses</code> æŸ¥è©¢ï¼Œå¯ä»¥å¾—çŸ¥ä½¿ç”¨çš„ image æ˜¯ä»€éº¼ï¼Œä»¥åŠæ˜¯å¦ Ready ç­‰è³‡è¨Š</p>
<h4 id="2-copy-to"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2-copy-to">2. ä½¿ç”¨ <code>--copy-to</code></a></h4>
<p><img alt="" src="/images/copy-to-debug.png" /></p>
<p>é€™é‚Šè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯è¦æŠŠ <code>--share-processes</code> å‹¾èµ·ä¾†ï¼Œä¸ç„¶é è¨­ç‹€æ³ä¸‹ Linux Namespace æ˜¯ç›¸äº’éš”é›¢çš„ï¼Œæœƒçœ‹ä¸åˆ°åŸå…ˆçš„ Process</p>
<div class="highlight"><span class="filename">copy-to</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">#</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --copy-to=&lt;NEW POD NAME&gt;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1">#</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--share-processes<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--copy-to<span class="o">=</span>copy-coredns
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-lkp2m.
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="m">65535</span><span class="w">          </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.0<span class="w">    </span><span class="m">972</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/pause
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>root<span class="w">           </span><span class="m">7</span><span class="w">  </span><span class="m">1</span>.0<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">761944</span><span class="w"> </span><span class="m">41720</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>root<span class="w">          </span><span class="m">21</span><span class="w">  </span><span class="m">0</span>.4<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3328</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>root<span class="w">          </span><span class="m">46</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">47656</span><span class="w">  </span><span class="m">3596</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span>errors
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span>ready
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="c1">#</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="c1"># Reattach empeheral container</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="c1">#</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>attach<span class="w"> </span>copy-coredns<span class="w"> </span>-c<span class="w"> </span>debugger-lkp2m<span class="w"> </span>-i<span class="w"> </span>-t
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="c1">#</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="c1"># Check copy-coredns status</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="c1">#</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>coredns
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>copy-coredns<span class="w">                                </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>2m29s
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>coredns-6698ddd997-gx66m<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>coredns-6698ddd997-rxlsl<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>coredns-autoscaler-7dbcd7d9c8-pnqtt<span class="w">         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>17h
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="c1">#</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="c1"># Wipe out copy-coredns</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="c1">#</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>copy-coredns
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>pod<span class="w"> </span><span class="s2">&quot;copy-coredns&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<h3 id="microsoft-defender-for-cloud"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#microsoft-defender-for-cloud">[æ’èŠ±] Microsoft Defender for Cloud</a></h3>
<p>å°±åœ¨æˆ‘å° Azure Kubernetes Service å…§çš„ CoreDNS ä¸Šä¸‹å…¶æ‰‹çš„æ™‚å€™...æˆ‘è¢«å¯„äº†å° <code>Security Alert: CoreDNS modification in Kubernetes detected</code>ï¼ŒçœŸ...è²¼å¿ƒçš„æé†’</p>
<div class="highlight"><span class="filename">Security Alert: CoreDNS modification in Kubernetes detected</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Kubernetes audit log analysis detected a modification of the CoreDNS configuration. The configuration of CoreDNS can be modified by overriding its configmap. While this activity can be legitimate, if attackers have permissions to modify the configmap, they can change the behavior of the cluster&#39;s DNS server and poison it.
</code></pre></div>
<p><img alt="" src="/images/coredns-security-alert.png" /></p>
<h3 id="refereneces"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#refereneces">Refereneces</a></h3>
<ul>
<li><a href="https://mcr.microsoft.com/en-us/product/cbl-mariner/distroless/base/about">CBL-Mariner Distroless Base</a></li>
<li><a href="https://github.com/pichuang/debug-container">pichuang/debug-container</a></li>
<li><a href="https://xie.infoq.cn/article/4372ef0ba18c49891b295de54">K8S æ•…éšœæ’é”™æ–°æ‰‹æ®µï¼škubectl debug å®æˆ˜</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a></li>
<li><a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">Debugging with an ephemeral debug container</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-29 00:00:00">May 29, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">Kubernetes Probe é¡å‹åŠå¯¦ä½œæ–¹å¼çš„ä½¿ç”¨èªªæ˜èˆ‡å°å»ºè­°</a></h2>
<p>æœ€è¿‘çœ‹åˆ°ä¸€å€‹å¾ˆæœ‰è¶£çš„ç¶²ç«™ <a href="https://kube-score.com/">kube-score</a>ï¼Œä½ æŠŠä½ çš„ Kubernetes Deployment ä¸Ÿé€²å»ä¹‹å¾Œï¼Œå®ƒå°±æœƒå„ç¨®ç„¡æƒ…åœ°è·Ÿä½ èªªå“ªè£¡ä¸å¥½ã€‚ç•¶ä¸­è£¡é¢æœ‰æåˆ°é‡å° Kubernetes Probe ç›¸é—œçš„å»ºè­°ï¼Œå‰›å¥½æœ€è¿‘æ¡ˆå­æœ‰éœ€è¦ç‰¹åˆ¥ç²¾ç®—æ™‚é–“ï¼Œæ•…ç‰¹åˆ¥å¯«äº†ç¯‡æ–‡ç« ä¾›å¤§å®¶åƒè€ƒã€‚é †ä¾¿é™„ä¸Šä¸€å¼µï¼Œå¾ Bing Creator æä¾›çš„ DALL.E æ¨¡å‹æ‰€ç†è§£åˆ°çš„ Kubernetes livenessProbeã€readinessProbe ä»¥åŠ startupProbe è¦–è¦ºåŒ–çš„æ¨£å­ï¼Œå¾ˆåƒ...å·¦ç´çƒèƒ½æºçµæ™¶</p>
<p><img alt="" src="/images/probe-k8s-bg.jpg" /></p>
<!--more-->

<h3 id="tldr"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tldr">TL;DR</a></h3>
<ul>
<li>Kubernetse Probe é¡å‹é‡è¦æ€§æ’åº: readinessProbe &gt; livenessProbe &gt; startupProbe</li>
<li>å‘ˆä¸Šï¼Œæ¯ä¸€å€‹ Kubernetes Probe éƒ½æœ‰å„è‡ªçš„ initialDelaySecondsã€periodSecondsã€successThresholdã€failureThresholdã€timeoutSeconds ä»¥åŠ Probe å¯¦ä½œæ–¹æ³•å¯ä»¥è¨­å®šï¼Œä¸¦ä¸é‡è¤‡</li>
<li>Probe å¸¸è¦‹å¯¦ä½œæ–¹æ³•æ’åº: HTTP Probe &gt; Exec Probe &gt; TCP Socket Probe</li>
</ul>
<h3 id="cloud-native-taiwan-user-group"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#cloud-native-taiwan-user-group">é—œæ–¼ Cloud Native Taiwan User Group</a></h3>
<p>åŸºæ–¼ CNCF æ²»ç†è¦ç¯„ï¼Œå‰é™£å­å°‡ç¤¾åœ˜æ‹†åˆ†æˆå…©å€‹ï¼Œåˆ†åˆ¥æ˜¯ <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">Cloud Native Taiwan User Group</a> å’Œ <a href="">Kubernetes Community Days Taiwan</a></p>
<p>æ­¡è¿å¤§å®¶å‹•å‹•æ‰‹åŠ å…¥ä¸€ä¸‹ CNCF ç¤¾ç¾¤æœƒå“¡ï¼Œä¸¦ä¸”é»æ“ŠåŠ å…¥ (Join)</p>
<p><img alt="" src="/images/cntug-membership.png" /></p>
<p>å¦å¤–æˆ‘å€‘ 2023/06 æœ‰ç¤¾ç¾¤æ´»å‹• <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cntug-202306-meetup/">CNTUG 2023/06 Meetup</a>ï¼Œéœ€é€éè©²ç³»çµ±å ±åï¼Œçµ±è¨ˆäººæ•¸ï¼Œæ­¡è¿å¤§å®¶åƒåŠ </p>
<p>Cloud Native Taiwan User Group 2023/06</p>
<ul>
<li>Kubernetes ä¼¸ç¸®è‡ªå¦‚çš„å·¥ä½œè² è¼‰! -  Phil Huang</li>
<li>Topic Scalable NATS architecture with JetStream - ä½•ç§‰è³¢</li>
</ul>
<h3 id="kubernetes-3-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#kubernetes-3-probe">Kubernetes èƒ½è¨­å®šçš„ 3 ç¨® Probe é¡å‹</a></h3>
<p>åŸºæ–¼ Kubernetes å®˜æ–¹æ–‡ä»¶æŒ‡å‡º</p>
<table>
<thead>
<tr>
<th>Probe</th>
<th>åŠŸèƒ½æè¿°</th>
<th>ç”¨é€”</th>
<th>ä½¿ç”¨å ´æ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Liveness Probe (å­˜æ´»æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Pod æ˜¯å¦åœ¨é‹è¡Œç‹€æ…‹ä¸‹</td>
<td>ç¢ºä¿æ‡‰ç”¨ç¨‹åºåœ¨å®¹å™¨å…§éƒ¨é‹è¡Œï¼Œå¦‚æœæª¢æ¸¬å¤±æ•—ï¼ŒKubernetes å°‡æœƒçµ‚æ­¢å®¹å™¨ä¸¦é‡æ–°å•Ÿå‹•å®ƒ</td>
<td>é€™å¯ç”¨æ–¼æª¢æ¸¬æ‡‰ç”¨ç¨‹åºçš„ç•°å¸¸ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼Œç•¶æ‡‰ç”¨ç¨‹åºæ­»æ‰æˆ–è™•æ–¼ä¸æ­£å¸¸ç‹€æ…‹æ™‚ï¼‰ï¼Œé¡ä¼¼æ–¼é›»è…¦å•Ÿå‹•å¾Œå¾å¤–éƒ¨ç›£æ§ BMC ç¢ºèªæ©Ÿå™¨é‹ä½œæ­£å¸¸</td>
</tr>
<tr>
<td>Readiness Probe (å°±ç·’æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Application æ˜¯å¦æº–å‚™å¥½æ¥å—ç¶²è·¯æµé‡</td>
<td>ç•¶å®¹å™¨å…§çš„æ‡‰ç”¨ç¨‹åºæ­£åœ¨å•Ÿå‹•æˆ–æ­£åœ¨é€²è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œæ™‚ï¼Œå¯ä»¥ä½¿ç”¨ Readiness Probeã€‚ç•¶æ‡‰ç”¨ç¨‹åºå°±ç·’æ™‚ï¼Œå®ƒå°‡è¿”å›æˆåŠŸçš„æ‡‰ç­”ï¼Œä¸¦ä¸” Kubernetes å¯ä»¥é–‹å§‹å°‡æµé‡è·¯ç”±åˆ°è©²å®¹å™¨ã€‚</td>
<td>æŒçºŒæ€§æœå‹™å¥åº·æª¢æŸ¥ï¼Œé¡ä¼¼æ–¼ä½œæ¥­ç³»çµ±é‹è¡Œæ­£å¸¸</td>
</tr>
<tr>
<td>Startup Probe (å•Ÿå‹•æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Pod çš„å•Ÿå‹•é€²åº¦</td>
<td>Startup Probe é¡ä¼¼æ–¼ Readiness Probeï¼Œå®ƒç”¨æ–¼æª¢æ¸¬å®¹å™¨æ˜¯å¦æ­£åœ¨é€²è¡Œå•Ÿå‹•éç¨‹ã€‚èˆ‡ Readiness Probe ä¸åŒï¼ŒStartup Probe å¯ä»¥åœ¨æ‡‰ç”¨ç¨‹åºå°±ç·’ä¹‹å‰åŸ·è¡Œå¤šæ¬¡æª¢æ¸¬ã€‚</td>
<td>App åˆå§‹åŒ–ï¼Œé¡ä¼¼æ–¼é›»è…¦å•Ÿå‹•çš„æ™‚å€™æœƒæœ‰ BIOS æª¢æŸ¥ç¨‹åº</td>
</tr>
</tbody>
</table>
<p>Liveness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-livenessae14.GIF" /></p>
<p>Readiness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-readiness6ktf.GIF" /></p>
<h3 id="probe-3"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#probe-3">æ¯ä¸€å€‹ Probe å¯ä»¥ç”¨ä¸‹åˆ— 3 ç¨®å¯¦ä½œæ–¹å¼é€²è¡Œæª¢æŸ¥</a></h3>
<h4 id="http-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#http-probe">HTTP Probe</a></h4>
<p>æœ€å¤§å®—çš„æª¢æŸ¥æ–¹å¼ï¼Œå¦‚æœ Kubernetes æ”¶åˆ° HTTP Status Code 200 ~ 300 çš„ç¯„åœï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>apiVersion: v1
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>kind: Pod
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>metadata:
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  labels:
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    test: http-probe
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>  name: http-probe
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>spec:
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>  containers:
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>  - name: http-probe
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    image: k8s.gcr.io/liveness
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    args:
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    - /server
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    livenessProbe:
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>      httpGet:
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        path: /healthz
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        port: 8080
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        httpHeaders:
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        - name: X-Custom-Header
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>          value: Awesome
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>      initialDelaySeconds: 3
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>      periodSeconds: 10
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    readinessProbe:
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>      httpGet:
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        path: /healthz
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>        port: 8080
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        httpHeaders:
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>        - name: X-Custom-Header
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>          value: Awesome
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>      initialDelaySeconds: 3
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>      periodSeconds: 10
</code></pre></div>
<p>å…¶å¯¦å¾ˆå¤š Framework æˆ– Library å…§å»ºéƒ½æœ‰é‡å°é€™å€‹éœ€æ±‚é€²è¡Œå¯¦ä½œï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</p>
<ul>
<li>Spring Boot: <a href="https://spring.io/blog/2020/03/25/liveness-and-readiness-probes-with-spring-boot">Liveness and Readiness Probes with Spring Boot</a></li>
<li>.NET Core: <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks">Health checks in ASP.NET Core</a></li>
<li>Python3: <a href="https://pypi.org/project/flask-healthz/">flask-healthz</a></li>
</ul>
<h4 id="exec-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#exec-probe">Exec Probe</a></h4>
<p>å¦‚æœ Kubernetes æ”¶åˆ° Exit Code ç‚º 0ï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>apiVersion: v1
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>kind: Pod
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>metadata:
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>  labels:
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    test: exec-probe
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>  name: exec-probe
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>spec:
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>  containers:
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>  - name: exec-probe
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    image: k8s.gcr.io/busybox
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    args:
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    - /bin/sh
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    - -c
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    livenessProbe:
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>      exec:
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        command:
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        - cat
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        - /tmp/healthy
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>      initialDelaySeconds: 5
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>      periodSeconds: 10
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    readinessProbe:
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>      exec:
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        command:
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        - cat
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        - /tmp/healthy
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>      initialDelaySeconds: 5
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>      periodSeconds: 10
</code></pre></div>
<h4 id="tcp-socket-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tcp-socket-probe">TCP Socket Probe</a></h4>
<p>å¦‚æœ Kubernetes èƒ½å»ºç«‹ TCP Establish connectionï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>apiVersion: v1
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>kind: Pod
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>metadata:
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  name: goproxy
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>  labels:
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    app: goproxy
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>spec:
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>  containers:
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>  - name: goproxy
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    image: k8s.gcr.io/goproxy:0.1
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    ports:
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    - containerPort: 8080
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    readinessProbe:
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>      tcpSocket:
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        port: 8080
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>      initialDelaySeconds: 5
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>      periodSeconds: 10
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>    livenessProbe:
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>      tcpSocket:
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        port: 8080
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>      initialDelaySeconds: 15
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>      periodSeconds: 20
</code></pre></div>
<h3 id="use-cases"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#use-cases">Use Cases</a></h3>
<table>
<thead>
<tr>
<th>åƒæ•¸</th>
<th>æè¿°</th>
<th>kubernetes é è¨­å€¼</th>
<th><a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a></th>
<th><a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/helm-charts/helm3/strimzi-kafka-operator/README.md">Strimzi Kafka Operator</a></th>
<th><a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L448-L478">kubernetes/ingress-nginx</a></th>
<th><a href="https://github.com/mysql/mysql-operator/blob/trunk/helm/mysql-operator/templates/deployment.yaml#LL60C1-L66C29">mysql/mysql-operator</a></th>
<th><a href="https://github.com/mariadb-operator/mariadb-operator/blob/main/deploy/charts/mariadb-operator/templates/webhook-deployment.yaml#L67-L72">mariadb-operator/mariadb-operator</a></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>livenessProbe.enabled</code></td>
<td>å•Ÿç”¨ Liveness probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.initialDelaySeconds</code></td>
<td>åˆå§‹åŒ– Liveness Probe å‰çš„å»¶é²æ™‚é–“</td>
<td>0</td>
<td>30</td>
<td>10</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.periodSeconds</code></td>
<td>å¤šä¹…é‡æ¸¬ä¸€æ¬¡</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.timeoutSeconds</code></td>
<td>å¤šä¹…æœƒè¶…æ™‚</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.failureThreshold</code></td>
<td>æˆåŠŸå¾Œè¢«è¦–ç‚ºå¤±æ•—çš„æ¢æ¸¬çš„æœ€å°é€£çºŒå¤±æ•—æ¬¡æ•¸</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>5</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.successThreshold</code></td>
<td>æ¢æ¸¬å¤±æ•—å¾Œè¢«è¦–ç‚ºæˆåŠŸçš„æœ€å°‘é€£çºŒæˆåŠŸæ¬¡æ•¸</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>livenessProbe HealthCheck</td>
<td>Liveness Probe æ¢é‡æ–¹å¼</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.enabled</code></td>
<td>å•Ÿç”¨ Readiness Probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td><code>readinessProbe.initialDelaySeconds</code></td>
<td>åˆå§‹åŒ– Readiness Probe å‰çš„å»¶é²æ™‚é–“</td>
<td>0</td>
<td>5</td>
<td>10</td>
<td>10</td>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td><code>readinessProbe.periodSeconds</code></td>
<td>å¤šä¹…é‡æ¸¬ä¸€æ¬¡</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>3</td>
<td>10</td>
</tr>
<tr>
<td><code>readinessProbe.timeoutSeconds</code></td>
<td>å¤šä¹…æœƒè¶…æ™‚</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.failureThreshold</code></td>
<td>æˆåŠŸå¾Œè¢«è¦–ç‚ºå¤±æ•—çš„æ¢æ¸¬çš„æœ€å°é€£çºŒå¤±æ•—æ¬¡æ•¸</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>3</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.successThreshold</code></td>
<td>æ¢æ¸¬å¤±æ•—å¾Œè¢«è¦–ç‚ºæˆåŠŸçš„æœ€å°‘é€£çºŒæˆåŠŸæ¬¡æ•¸</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>readinessProbe HealthCheck</td>
<td>Readiness Probe æ¢é‡æ–¹å¼</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>exec</td>
<td>httpGet</td>
</tr>
</tbody>
</table>
<h4 id="nats-operator"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#nats-operator">ä»¥ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> ç‚ºä¾‹</a></h4>
<p>åŸºæ–¼ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/templates/deployment.yaml#L67-L87">NATS-Operator Deployment</a> å’Œ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> é è¨­å€¼ï¼Œé€™é‚Šå› ç•«åœ–è§£é‡‹æ–¹ä¾¿ï¼Œæœ‰èª¿æ•´äº†ä¸€ä¸‹åƒæ•¸ã€‚æ•…å¯å¾—ä»¥ä¸‹æˆªå–è¨­å®š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>        livenessProbe:
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>          httpGet:
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>            path: /readyz
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>            port: readyz
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>          initialDelaySeconds: 30
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>          periodSeconds: 10
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>          timeoutSeconds: 5
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>          successThreshold: 6
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>          failureThreshold: 3
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        readinessProbe:
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>          httpGet:
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>            path: /readyz
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>            port: readyz
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>          initialDelaySeconds: 5
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>          periodSeconds: 10
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>          timeoutSeconds: 5
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>          successThreshold: 6
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>          failureThreshold: 2
</code></pre></div>
<h4 id="q1-kubernetes-pod-pod-restarted-unhealthy"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q1-kubernetes-pod-pod-restarted-unhealthy">Q1: å¦‚æœç¨‹å¼é‹è¡Œä¸€æ®µæ™‚é–“ï¼Œç„¶å¾Œ Kubernetes ç™¼ç¾ Pod è¦ Pod Restarted æˆ–è€…æ˜¯æ¨™è¨» Unhealthy æœ€çŸ­æ™‚é–“ç‚ºä½•?</a></h4>
<p><img alt="" src="/images/probe-k8s-1.png" /></p>
<p>é¦–å…ˆå› ç‚ºç¨‹å¼å·²ç¶“é‹è¡Œä¸€æ®µæ™‚é–“äº†ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ initialDelaySeconds çš„æ™‚é–“</p>
<p>æ•…æ­£ç¢ºçš„ç®—å¼ç‚º</p>
<ul>
<li>æœ€çŸ­é‡å•Ÿ Pod æ™‚é–“ = (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  ( 3 - 1 ) * 10 + 5 = 25</li>
<li>æœ€çŸ­ç§»é™¤ Endpoint List æ™‚é–“ = (<code>readinessProbe.failureThreshold</code> - 1) * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> =  ( 2 - 1 ) * 10 + 5 = 15</li>
</ul>
<h4 id="q2-pod-restart"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q2-pod-restart">Q2: å¦‚æœç¨‹å¼åˆå§‹é‹è¡Œï¼Œç„¶å¾Œå› ç‚ºç¨‹å¼è£¡é¢æ²’å¯«å¥½ï¼Œå°è‡´ Pod Restart é–‹å§‹åŸ·è¡Œçš„æœ€çŸ­å’Œæœ€é•·æ™‚é–“ç‚ºä½•?</a></h4>
<p>éœ€è¦æŠŠ <code>livenessProbe.initialDelaySeconds</code> æ™‚é–“æ”¾é€²å»è©•ä¼°</p>
<ul>
<li>æœ€çŸ­é‡å•Ÿ Pod æ™‚é–“ = <code>livenessProbe.initialDelaySeconds</code> + (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + ( 3 - 1 ) * 10 + 5 = 55</li>
<li>æœ€é•·é‡å•Ÿ Pod æ™‚é–“ = <code>livenessProbe.initialDelaySeconds</code> + <code>livenessProbe.failureThreshold</code> * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + 3 * 10 + 5 = 65</li>
</ul>
<p>å…©è€…æ™‚é–“å·®å…¶å¯¦å°±æ˜¯å·®ä¸€å€‹ livenessProbe.periodSeconds æ™‚é–“</p>
<h4 id="q3-pod-endpoint-list-endponit-list-kubernetes"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q3-pod-endpoint-list-endponit-list-kubernetes">Q3: å¦‚æœ Pod å¾ Endpoint list ç§»é™¤äº†ä¸€æ®µæ™‚é–“å¾Œï¼Œç•¶ç¨‹å¼æ­£ç¢ºé‹è¡Œæ™‚ï¼Œæœ€çŸ­éœ€èŠ±å¤šå°‘æ™‚é–“å¯ä»¥åŠ å›åˆ° Endponit list åŠ å›åˆ° Kubernetes æœå‹™çš„è¡Œåˆ—å…§?</a></h4>
<p><img alt="" src="/images/probe-k8s-2.png" /></p>
<p>ä¸»è¦è¦çœ‹ <code>readinessProbe.successThreshold</code></p>
<ul>
<li>æœ€çŸ­æ¢å¾©æœå‹™æ™‚é–“ = <code>readinessProbe.successThreshold</code> * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> = 6 * 10 + 5 = 65</li>
</ul>
<h4 id="q4-readinessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q4-readinessprobe">Q4: å¦‚æœæ²’è¨­å®š readinessProbe æœƒæ€æ¨£å—?</a></h4>
<p>æœ‰å¯èƒ½æœƒåœ¨ Pod é‚„æ²’å•Ÿå‹•çš„æ™‚å€™ï¼Œæµé‡å°± Kubernetes åˆ¤æ–·å¯ä»¥è¢«æ¨é€²å»ï¼Œæˆ–è€…æ˜¯ Pod æ­£åœ¨è·‘åœæ­¢ç¨‹åºçš„æ™‚å€™ï¼Œæµé‡é‚„æ˜¯è¢«æ¨é€²å»</p>
<h4 id="q5-livenessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q5-livenessprobe">Q5: å¦‚æœæ²’è¨­å®š livenessProbe æœƒæ€æ¨£å—?</a></h4>
<p>ä¸æœƒæ€æ¨£ï¼Œå¦‚æœä½ ä¸çŸ¥é“è¦è¨­å®šä»€éº¼ï¼Œä¸ç”¨ç‰¹åˆ¥è¨­å®šï¼Œkubelet æœƒæ ¹æ“š Pod çš„ restartPolicy é€²è¡Œæ­£ç¢ºçš„å‹•ä½œã€‚å¦‚æœæœ‰è¨­å®šçš„è©±ï¼Œç›¡é‡ä¸è¦è·Ÿ readinessProbe æª¢æŸ¥åŒä¸€å€‹åœ°æ–¹</p>
<h4 id="q6-startupprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q6-startupprobe">Q6: å¦‚æœæ²’è¨­å®š startupProbe æœƒæ€æ¨£å—?</a></h4>
<p>ä¸æœƒæ€æ¨£ï¼Œå¦‚æœä½ ä¸çŸ¥é“è¦è¨­å®šä»€éº¼ï¼Œä¸ç”¨ç‰¹åˆ¥è¨­å®šï¼Œå¯ä»¥ç”¨æ‹‰é•· <code>livenessProbe.initialDelaySeconds</code> äº’æ›ï¼ŒstartupProbe çš„ç‰¹æ€§æ˜¯åªè¦æˆåŠŸä¸€æ¬¡å°±æœƒæ›æ‰‹çµ¦ livenessProbe æˆ– readinessProbe é€²è¡Œæ¢æ¸¬</p>
<p>å…¬å¼ç‚º <code>livenessProbe.initialDelaySeconds</code> å¤§ç´„ç­‰æ–¼ <code>startupProbe.initialDelaySeconds</code> + <code>startupProbe.periodSeconds</code> * <code>startupProbe.failureThreshold</code>ï¼Œå¯ä»¥ç›¡æ—©å†åˆå§‹éšæ®µç™¼ç¾æœå‹™å•Ÿå‹•ä¸äº†</p>
<h3 id="_1"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#_1">å€‹äººå°å»ºè­°</a></h3>
<ul>
<li>
<p>é—œæ–¼ initialDelaySeconds</p>
<ul>
<li>é‡å° livenessProbe.initialDelaySeconds ç‰¹åˆ¥æœ‰ç”¨</li>
<li>æ¡ç”¨ P99 çš„å•Ÿå‹•æ™‚é–“ç‚ºä¸»ï¼Œä¸»è¦æ˜¯å› ç‚ºé€™å€‹æ•¸å­—é¡åŒæ–¼é–‹æ©Ÿéœ€è¦å¤šä¹…æ™‚é–“ï¼ŒåŸºæœ¬ä¸Šéƒ½ç›¸ç•¶å›ºå®š</li>
<li>å¤šæ•¸æœ‰ç”¨ Frameworkã€JVM ç­‰éƒ½æœƒæœ‰å•Ÿå‹•æ™‚é–“çš„çµ±è¨ˆå¯ä»¥åƒè€ƒ</li>
<li>å¦‚æœçœŸçš„æŠ“ä¸æº–çš„è©±ï¼Œå»ºè­°ä¸Š startupProbeï¼Œè€Œä¸è¦ç”¨ livenessProbe.initialDelaySeconds</li>
</ul>
</li>
<li>
<p>é—œæ–¼ periodSeconds</p>
<ul>
<li>çµ•å¤§éƒ¨åˆ†çš„ç‹€æ³ä¸‹ 10s ç›¸ç•¶è¶³å¤ </li>
<li>å¦‚æœè¨­å®šå¤ªçŸ­ï¼Œæœ‰å¯èƒ½ Pod åªæ˜¯æš«æ™‚æ€§å¾ˆå¿™ä¾†ä¸åŠå›æ‡‰ï¼Œä»–å°±è¢«æ­¸é¡åœ¨ Failure çš„ç‹€æ…‹ï¼Œå¦‚æœåœ¨æ•´é«”ç³»çµ±éƒ½æ˜¯å¾ˆå¿™çš„ç‹€æ³ä¸‹ï¼Œæœƒå°è‡´èºæ—‹å¼æ•ˆèƒ½ä¸‹é™ï¼Œèƒ½è€…éå‹</li>
<li>å¦‚æœè¨­å®šå¤ªé•·ï¼ŒPod çœŸçš„æœ‰äº‹æƒ…çš„æ™‚å€™ï¼Œè¦å¾ˆä¹…æ‰æœƒæœ‰åæ‡‰</li>
</ul>
</li>
<li>
<p>é—œæ–¼ timeoutSeconds</p>
<ul>
<li>æœ€å¤§å¤šæ•¸æŠ“ periodSeconds/2 æˆ–ä½æ–¼çš„æ•¸å­—</li>
<li>æœ€å°ç‚º 1s</li>
</ul>
</li>
<li>
<p>é—œæ–¼ failureThreshold</p>
<ul>
<li>å»ºè­° 3</li>
<li>è¨­å®šå¤ªé«˜ï¼ŒPod çœŸçš„å£æ‰çš„æ™‚å€™ï¼Œå°è‡´çœŸçš„è¦é‡å•Ÿæˆ–ç§»å‡ºçš„æ™‚é–“æ‹‰çš„å¤ªé•·</li>
<li>è¨­å®šå¤ªçŸ­ï¼ŒPod å¯èƒ½åªæ˜¯æš«æ™‚å¾ˆå¿™çš„æ™‚å€™ï¼Œå°±æœƒéæ—©çš„é‡å•Ÿæˆ–ç§»å‡ºï¼Œå°è‡´èºæ—‹å¼æ•ˆèƒ½ä¸‹é™ï¼Œèƒ½è€…éå‹</li>
</ul>
</li>
<li>
<p>é—œæ–¼ successThreshold</p>
<ul>
<li>å»ºè­° 1</li>
<li>é‡å° readinessProbe.successThreshold ç‰¹åˆ¥æœ‰ç”¨ï¼ŒlivenessProbe.successThreshold æ²’ä»€éº¼ç‰¹åˆ¥æ•ˆæœï¼Œå› ç‚ºå¾Œè€…æœƒæŠŠ Pod æ•´å€‹é‡å•Ÿæ‰ï¼Œæ•…æ²’æœ‰å›ä¾†çš„æ©Ÿæœƒ</li>
<li>å¦‚æœ Pod èˆ‡å…¶ä»–æœå‹™ç›¸é—œæœå‹™å¤šçš„è©±ï¼Œå¯ä»¥æ•¸å­—æ‹‰å¤§ä¸€é»ï¼Œ</li>
</ul>
</li>
<li>
<p>é—œæ–¼ livenessProbe</p>
<ul>
<li>å› ç‚ºæ¶‰åŠåˆ°é‡å•Ÿ Pod çš„èƒ½åŠ›ï¼Œæ•…éœ€è¦ä¿å®ˆçš„è¨­å®šè©²é …ç›®</li>
<li>æª¢æŸ¥åƒ…éœ€åƒ…æŸ¥è‡ªèº«å³å¯ï¼Œä¸æ‡‰è©²æ¶‰åŠæª¢æŸ¥å¤–éƒ¨ç›¸ä¾æ€§æœå‹™</li>
</ul>
</li>
<li>
<p>é—œæ–¼ readinessProbe</p>
<ul>
<li>å› ç‚ºæ¯”è¼ƒåå‘æœå‹™çš„ healthcheckï¼Œæ•…å¯ä»¥æ¯”è¼ƒå¯¬é¬†ä¸€é»çš„è¨­å®š</li>
</ul>
</li>
</ul>
<h3 id="references"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#references">References</a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">é…ç½®å­˜æ´»ã€å°±ç»ªå’Œå¯åŠ¨æ¢é’ˆ</a></li>
<li><a href="https://cloud.redhat.com/blog/liveness-and-readiness-probes">Liveness and Readiness Probes</a></li>
<li><a href="https://opensource.com/article/18/3/kubernetes-liveness-readiness-probes">Creating Kubernetes liveness and readiness probes</a></li>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">Kubernetes best practices: Setting up health checks with readiness and liveness probes</a></li>
<li><a href="https://blog.pichuang.com.tw/20221005-k8s-gracefulrestart-pod.html?h=term">å¯¦ç¾ä¸åœæ©Ÿçš„ Pod æ›´æ–°æ–¹å¼</a></li>
<li><a href="https://github.com/zegl/kube-score/blob/master/README_PROBES.md">Readiness and Liveness Probes</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-15 00:00:00">May 15, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sig-kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">SIG Kubernetes Scability å¤šç¶­åº¦åˆ†æ</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bxY5Q5Eoj0s" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<p>å‰é™£å­å‰›å¥½ Kubecon EU 2023 å‰›è¾¦å®Œï¼Œç›¸é—œçš„å½±ç‰‡ä¹Ÿé‡‹å‡ºåˆ° <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a> ä¸Šï¼Œå…±è¨ˆ 314 éƒ¨ï¼Œåœ¨ç•¶ç½å„æ—å…‹ç ´å£æµ·æ‹‰é­¯å¤§é™¸çš„åŒæ™‚ï¼Œè¨˜å¾—ä¹Ÿè¦ä¸å¿˜æŒçºŒå­¸ç¿’</p>
<!--more-->

<h3 id="kubernetes-communtiy-day-taiwan-2023"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-communtiy-day-taiwan-2023">Kubernetes Communtiy Day Taiwan 2023 å‰©ä¸‹ä¸€å‘¨å¯ä»¥æŠ•ç¨¿!!!</a></h3>
<p>COSCUP 2023 å°‡è‡³ï¼ŒCloud Native Taiwan User Group è·Ÿæ­·å¹´ä¸€æ¨£æˆ‘å€‘ä¹Ÿæœƒæ–¼ 2023/07/29 ~ 2023/07/30 å…§ï¼Œèˆ‰è¾¦ Kubernetes Communtiy Day Taiwan 2023</p>
<p>ç›®å‰åƒ…å‰©ä¸€å‘¨é—œé–‰å¾µç¨¿ï¼Œå¯æ–¼  <a href="https://pretalx.coscup.org/coscup-2023/cfp">COSCUP æŠ•ç¨¿ç³»çµ±</a> é€²è¡ŒæŠ•ç¨¿</p>
<ul>
<li>æ­£å¼æŠ•ç¨¿é–‹å§‹æ—¥æœŸï¼š2023 å¹´ 04 æœˆ 14 æ—¥</li>
<li><code>æ­£å¼æŠ•ç¨¿æˆªæ­¢æ—¥æœŸï¼š2023 å¹´ 05 æœˆ 22 æ—¥</code></li>
<li>é€šçŸ¥è¬›è€…ç¤¾ç¾¤è»ŒæŠ•ç¨¿çµæœï¼š2023 å¹´ 06 æœˆ 23 æ—¥</li>
</ul>
<p>æ­¤å¤–åŸºæ–¼ CNCF ç¤¾ç¾¤æ²»ç†è¦ç¯„ï¼Œå¾ KCD Taiwan å°‡ Communtiy Group å–®ç¨æ‹†åˆ†å‡ºä¾†ï¼Œ</p>
<ul>
<li>Kubernetes Community Days Taiwan (KCD Taiwan), åŸºæ–¼ <a href="https://github.com/cncf/kubernetes-community-days">Kubernetes Community Days</a> æ²»ç†è¦ç¯„ï¼Œç¶²ç«™ç‚º <a href="https://community.cncf.io/kcd-taiwan/">https://community.cncf.io/kcd-taiwan/</a>ï¼Œç‚ºå¹´åº¦åœ°å€æ´»å‹•</li>
<li>Cloud Native Taiwan User Group (CNTUG), åŸºæ–¼ <a href="https://github.com/cncf/communitygroups">CNCF Community groups</a> æ²»ç†è¦ç¯„ï¼Œç¶²ç«™ç‚º <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">https://community.cncf.io/cloud-native-taiwan-user-group/</a>ï¼Œç‚ºä¾‹è¡Œç¤¾ç¾¤æ´»å‹•</li>
</ul>
<p>æ­¡è¿æœ‰æƒ³è¦è´ŠåŠ©ã€æ¼”è¬›çš„å€‹äººæˆ–å» å•†å¯ä»¥ä¾éœ€æ±‚å„åˆ¥è¨è«–</p>
<h3 id="kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-scability">Kubernetes Scability å¤šç¶­åº¦åˆ†æ</a></h3>
<p><img alt="" src="/images/scale-1.png" /></p>
<p>Kubernetes Scalabilty æ˜¯ä¸€å€‹å¤šç¶­åº¦çš„å•é¡Œï¼Œä¸å–®å–®åªæ˜¯ç”¨ç¯€é»å€‹æ•¸ä¾†åšç‚ºè¡¡é‡å”¯ä¸€åŸºç¤ï¼Œå»ºè­°åƒé–± <a href="https://docs.google.com/presentation/d/1aWjxpY4YJ4KJQUTqaVHdR4sbhwqDiW30EF4_hGCc-gI/edit#slide=id.p3">Kubecon 2018 NA - Kubernetes Scalability: A multi-dimensional analysis</a></p>
<p>é€™é‚Šæå¹¾å€‹æˆ‘è¦ºå¾—æ¯”è¼ƒé‡è¦çš„</p>
<ul>
<li><code># Nodes v.s. # Pods/node</code>: Nodes è¶Šå¤šã€Pod æ–¼å–®ä¸€ Node ä¸Šè¶Šå°‘ï¼Œç¯€é»è¶Šå¤šã€Pod æ–¼å–®ä¸€ç¯€é»ä¸Šå¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œé€šå¸¸ <code># Pods/Node</code> æ˜¯å›ºå®šçš„ï¼Œèƒ½å‹•çš„éƒ½æ˜¯ä»¥ <code># Nodes</code> å±…å¤šï¼Œæ‰€ä»¥å¯ä»¥å›ºå®š <code># Pods/Node</code> å†æ›ç®—ç¸½æ•¸</li>
<li><code># Services v.s. # Endpoints/Service</code>: Service è¶Šå¤šã€Endpoints/svc è¶Šå°‘ï¼ŒService è¶Šå°‘ï¼ŒEndpoint/svc å¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œ<code># Endpoints/Service</code> é€™å€‹ä¸è¦è¶…é 250 æˆ–ä¸è¦è¶…é <code># Pods/node</code> çš„ä¸Šé™</li>
<li><code># Service/ns</code>: Service è¶Šå¤šã€Namespace è¶Šå°‘ï¼ŒService è¶Šå°‘ã€Namespace å¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œ<code># Service/ns</code> é€™å€‹ä¸è¦è¶…é 5000ï¼Œæœƒæœ‰ Pod Crash çš„ç‹€æ³ç™¼ç”Ÿ</li>
</ul>
<h3 id="2023-slisslos"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#2023-slisslos">2023 SLIs/SLOs çš„è®ŠåŒ–</a></h3>
<p>ç•¶å¹´ 2015 çš„å…¶ä¸­ä¸€æ¢é‡å° API å‘¼å«çš„å®šç¾© "99% of all our API calls return in less than 1 second" å› ç‚ºé€™å¥è©±çœ‹çš„äººæœ‰å„ç¨®ä¸ä¸€æ¨£çš„è§£è®€ï¼Œæ‰€ä»¥åˆ°äº†ä»Šå¹´ 2023 å°±æ›æˆä¸‹åˆ— 2 å€‹æ›´ç‚ºå¯¦éš›çš„ SLI / SLO å®šç¾©ï¼Œè©³ç´°å¯ä»¥åƒè€ƒé€™å€‹ <a href="https://github.com/kubernetes/community/commit/6f1cc290b977b1a1f45c5cb7c15132a152e40b8d">Git Diff</a></p>
<details class="info" open="open">
<summary>SLI</summary>
<p>"Latency of processing mutating API calls for single objects for every (resource, verb) pair, measured as 99th percentile over last 5 minutes"
"é‡å°å–®ä¸€ç‰©ä»¶è™•ç†è®Šæ›´ API å‘¼å«çš„å»¶é²ï¼Œå°æ–¼æ¯ä¸€å€‹ï¼ˆè³‡æºã€å‹•ä½œï¼‰é…å°ï¼Œä»¥éå» 5 åˆ†é˜å…§çš„ç¬¬ 99 ç™¾åˆ†ä½é€²è¡Œæ¸¬é‡ã€‚"</p>
</details>
<p>é€™æ¢ä¸»è¦æœ‰æ’é™¤è«‹æ±‚åœ¨ Queue ä¸­çš„ç­‰å¾…æ™‚é–“ï¼Œå› ç‚ºæ²’æœ‰è¾¦æ³•é ä¼° Control Plane çš„è² è¼‰ç‹€æ³ï¼Œæ•…ä¸è€ƒæ…®é€™éƒ¨åˆ†çš„æ™‚é–“æ¶ˆè€—</p>
<details class="info" open="open">
<summary>SLO</summary>
<p>"In default Kubernetes installation, for every (resource, verb) pair, excluding virtual and aggregated resources, 99th perccentile per cluster-day &lt;=1s"
"åœ¨é è¨­çš„ Kubernetes å®‰è£ä¸­ï¼Œå°æ–¼æ¯ä¸€å€‹ï¼ˆè³‡æºã€å‹•ä½œï¼‰é…å°ï¼Œæ’é™¤è™›æ“¬å’Œèšåˆè³‡æºï¼Œæ¯å€‹é›†ç¾¤æ¯å¤©çš„ç¬¬ 99 ç™¾åˆ†ä½å»¶é²æ‡‰è©²å°æ–¼ç­‰æ–¼ 1 ç§’ã€‚"</p>
</details>
<p>å…¶å¯¦é‚„æœ‰é¡å¤–å®˜æ–¹æ‰¿èªå’Œæ­£åœ¨è¢«è¨è«–çš„ SLIs/SLOsï¼Œå¯åƒè€ƒ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></p>
<ol>
<li>API call latency SLIs/SLOs details</li>
<li>API call extension points latency SLIs details</li>
<li>In-cluster dns latency SLIs/SLOs details</li>
<li>DNS programming latency SLIs/SLOs details</li>
<li>In-cluster network latency SLIs/SLOs details</li>
<li>Network programming latency SLIs/SLOs details</li>
<li>Pod startup latency SLI/SLO details</li>
<li>Watch latency SLI details</li>
</ol>
<h3 id="_1"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_1">å¯æ“´å±•æ€§çš„å·²æ¸¬è©¦ç¯„åœ</a></h3>
<p><img alt="" src="https://raw.githubusercontent.com/kubernetes/community/master/sig-scalability/configs-and-limits/scalability-envelope.png" /></p>
<p>æƒ³è¦ç²¾ç¢ºåœ°å®šç¾©å¯æ“´å±•æ€§ç¯„åœ (Scalability envelope) æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†å¯ä»¥æŠ“åˆ°å¤§ç´„ä¸”åˆç†çš„ç¯„åœï¼Œè­¬å¦‚ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a> æ‰€åˆ—çš„ç¯„åœï¼Œè£¡é¢å°‡ scope æ‹†åˆ†æˆ 2 å€‹ç¶­åº¦: namespace å’Œ cluster</p>
<p>ä¾æˆ‘å€‹äººç†è§£ï¼Œä¸€èˆ¬ä¾†èªªæ¶æ§‹å¸«æœƒé—œå¿ƒçš„éƒ½æ˜¯ä¸‹åˆ—é€™å¹¾å€‹ç¯„åœï¼Œä¸»è¦æœƒæ‰¯åˆ°ç¶²è·¯ï¼Œå…¶ä»–é¸é …è¦çˆ†æ‰çš„æ©Ÿæœƒå…¶å¯¦è »ä½çš„ï¼Œè‡³æ–¼å„åˆ¥æ•¸å­—çš„è§£è®€å°±å› äººè€Œç•°äº†</p>
<table>
<thead>
<tr>
<th>Quantity</th>
<th>Threshold scope=namespace</th>
<th>Threshold: scope=cluster</th>
</tr>
</thead>
<tbody>
<tr>
<td>#Nodes</td>
<td>n/a</td>
<td>5000</td>
</tr>
<tr>
<td>#Namespaces</td>
<td>n/a</td>
<td>10000</td>
</tr>
<tr>
<td>#Pods</td>
<td>3000</td>
<td>150000</td>
</tr>
<tr>
<td>#Pods per node</td>
<td>min(110, 10*#cores)</td>
<td>min(110, 10*#cores)</td>
</tr>
<tr>
<td>#Services</td>
<td>5000</td>
<td>10000</td>
</tr>
<tr>
<td>#All service endpoints</td>
<td>TBD</td>
<td>TBD</td>
</tr>
<tr>
<td>#Endpoints per service</td>
<td>250</td>
<td>n/a</td>
</tr>
<tr>
<td>#Deployments</td>
<td>2000</td>
<td>TBD</td>
</tr>
</tbody>
</table>
<p>å€‹äººç¶“é©—ä¸Šï¼Œä¸Šé¢çš„æ•¸å­—å¦‚ Nodes / Pods / Pods per node / Services éƒ½è·Ÿè¦è¨ˆç®—å‡ºç¶²æ®µè¦åˆ‡å¤šå°‘ã€ç¯€é»è¦å¤šå°‘å€‹ï¼Œå¯æ‰¿è¼‰å¤šå°‘å·¥ä½œè² è¼‰é‡å¾ˆæœ‰é—œä¿‚ï¼Œæ‰€ä»¥åœ¨è¦ç•«çš„æ™‚å€™å‹™å¿…è¦ç›¸ç•¶æ¸…æ¥šã€‚</p>
<h3 id="_2"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_2">å¯¦éš›å£“æ¸¬æ–¹å¼</a></h3>
<p>ä¸»è¦å£“æ¸¬å·¥å…·æœƒç”¨ <a href="https://github.com/kubernetes/perf-tests/">kubernetes/perf-tests</a> è£¡é¢çš„å·¥å…·:</p>
<ul>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/cmd/kubemark">Kubemark</a></li>
</ul>
<p>è€Œè·‘å®Œæ¸¬è©¦å‰‡æœƒç”¢ç”Ÿæ¸¬è©¦å ±è¡¨å¯ä»¥è§€å¯Ÿç¾æ³</p>
<p><img alt="" src="/images/scale-2.png" /></p>
<p>æ¯æ¬¡ Kubernetes Release éƒ½è¦é€šé Peformance 100 nodes / 500 nodes / Correctness 5000 nodesï¼Œæ¸¬è©¦å…§å®¹éƒ½æ˜¯ç”± <a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a> ä¾†å®šç¾©ï¼Œè€Œå ±è¡¨å¯ä»¥å¾ <a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">https://testgrid.k8s.io</a> é€™é‚Šç²å¾—ã€‚ä»Šå¹´å› ç‚ºå„å®¶é ç®—ç·Šç¸®ï¼Œç¾åœ¨é€ Kubernetes Code ä¸Šå»ï¼Œé è¨­åªæœƒè·‘ Performance 100 Nodes è€Œå·²ï¼Œè€Œå¤§éƒ¨åˆ†çš„æ“´å±•æ€§è­°é¡Œéƒ½æœƒå‡ºç¾åœ¨è¦æ¨¡åœ¨è¶…éä»¥å¾Œ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/governance/scalability-regressions-case-studies.md">100 Nodes</a></p>
<h3 id="_3"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_3">é æœŸæ”¹é€²æ–¹å‘</a></h3>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/flow-control/">Kubernetes v1.20 beta - API Priority &amp; Faireness</a></li>
<li><a href="https://github.com/kubernetes/enhancements/issues/3157">API Streaming Lists</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/114925">Gracefule shutdown</a></li>
<li>Kube-apiserver improvements</li>
<li>Improvements towards supporting higher throughput</li>
</ul>
<h3 id="qa"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#qa">Q&amp;A</a></h3>
<h4 id="q1-kubernetes-sig-autoscaling"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q1-kubernetes-sig-autoscaling">Q1: èˆ‡ Kubernetes SIG Autoscaling å·®ç•°æ˜¯?</a></h4>
<details class="note" open="open">
<summary>Note</summary>
<p>Not to confuse with SIG Autoscaling!</p>
</details>
<p>SIG Scalabilty é—œå¿ƒ Kubernetes æ•´é«”ç³»çµ±çš„æ¥µé™ï¼Œå¦‚æœä½ æ˜¯è² è²¬æä¾› Kubernetes å®‰è£å»ºç½®çš„æˆ–éœ€è¦åŸºæ–¼ä»¥ OSS Kubernetes ç‚ºåŸºç¤çš„è‡ªè¡Œç¶­è­·ç‰ˆæœ¬ï¼Œæœƒéœ€è¦é—œå¿ƒ Scalability è­°é¡Œ
SIG Autoscaling é—œå¿ƒ Horizontal Pod Autoscaling / Vertical Pod Autoscaling / Cluster Autoscalingï¼Œå¦‚æœä½ åªæ˜¯éœ€è¦ Kubernetes ä¸Šé¢çš„ç¨‹å¼éƒ¨ç½²ï¼Œå‰‡åƒ…éœ€è¦é—œå¿ƒ Autoscaling è­°é¡Œ</p>
<h4 id="q2-kubernetes-sig-scalability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q2-kubernetes-sig-scalability">Q2: Kubernetes SIG Scalability çš„ä¸»è¦ä»»å‹™æ˜¯?</a></h4>
<p>ä¸»è¦é é¢æ–¼ <a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability SIG (Special Interest Group)</a></p>
<p>5 å€‹ä¸»è¦çš„å·¥ä½œé ˜åŸŸ:</p>
<ol>
<li>å®šç¾©å’Œé©…å‹• (Define &amp; Drive): å®šç¾©å’Œé©…å‹•å¯æ“´å±•æ€§ç›®æ¨™</li>
<li>å”èª¿å’Œè²¢ç» (Coordinate &amp; Contribute): æ”¹é€² Performance æ›´æ¥è¿‘ç›®æ¨™</li>
<li>ç›£æ§å’Œé‡æ¸¬ (Montior &amp; Measure): é€éç›£æ§å’Œé‡æ¸¬ä¾†ç¢ºä¿å¯¦éš›ç³»çµ±è¡Œç‚ºæ¥è¿‘ç›®æ¨™</li>
<li>ä¿æŒå’Œä¿è­· (Preserve &amp; Protect): ç¢ºä¿ç³»çµ±å…å—å¯æ“´å±•æ€§å›æ­¸ (Scalability regressions) çš„å½±éŸ¿</li>
<li>è«®è©¢å’Œæ•™å­¸ (Consult &amp; Coach): é€éç¤¾ç¾¤å”ä½œç²å¾—æ›´å¤šçš„ä½¿ç”¨æ¡ˆä¾‹å’Œå›é¥‹ç¶“é©—</li>
</ol>
<h4 id="q3-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q3-kubernetes">Q3: Kubernetes æ•´é«”å£“åŠ›æ¸¬è©¦æœ€å¤§çš„é»åœ¨å“ªè£¡?</a></h4>
<p>Control Plane</p>
<h4 id="q4-5000"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q4-5000">Q4: æ¸¬è©¦ç¯€é» 5000 æ˜¯ä¸æ˜¯ä¸Šé™?</a></h4>
<p>ä¸æ˜¯ï¼Œè¬›è€…èªªä¸»è¦å¡åœ¨æ¸¬è©¦æˆæœ¬å¤ªé«˜ï¼Œæ­¤å¤–å¤šæ•¸ä½¿ç”¨è€…å°æ­¤æ²’æœ‰ä»€éº¼ç‰¹åˆ¥æœŸå¾…ï¼Œæ­£å¸¸è¦ç•«å¯ä»¥ä»¥ 100 Nodes ç‚ºåŸºç¤è¨­è¨ˆå°±å¥½</p>
<p>é—œæ–¼ç”¨ Azure Kubernetes Service è¨ˆç®— 5000 å€‹ç¯€é»çš„è¨ˆç®—æ–¹å¼ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰å¯«çš„æ‹™ä½œ <a href="https://blog.pichuang.com.tw/20230214-openai-scaling-kubernetes-to-7500-nodes.html#azure-cni">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›æ‹›å–š Kubernetes 7500 å°ç¯€é»!!!</a>ï¼Œæœ‰è©³ç´°çš„è¨ˆç®—éç¨‹</p>
<h4 id="q5-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q5-kubernetes">Q5: å¦‚ä½•é‡æ¸¬ Kubernetes æ•´é«”çš„æ•ˆèƒ½? ç¬¬ä¸€æ­¥æ˜¯?</a></h4>
<p>ä¸Š Grafana + Prometheus æœƒæ˜¯å¾ˆå¥½çš„èµ·æ­¥ï¼Œæˆ–è€…æ˜¯å¯ä»¥å¾ <a href="https://landscape.cncf.io/card-mode?category=observability-and-analysis">CNCF Observability</a> æŒ‘å‡ºé©åˆçš„å·¥å…·ã€‚
è‹¥æƒ³è¦é‡å° Observability æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œå»ºè­°å¯ä»¥åƒåŠ  <a href="https://github.com/cncf/tag-observability">CNCF TAG (Technical Advisory Group) Observability ğŸ”­âš™ï¸</a></p>
<h3 id="references"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#references">References</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=bxY5Q5Eoj0s">Intro + Deep Dive: Kubernetes SIG Scalability - Wojciech Tyczynski, Google</a></li>
<li><a href="https://www.youtube.com/watch?v=VTFmsD9odZ4">Intro + Deep Dive: SIG Scalability - Marcel ZiÄ™ba &amp; Wojciech TyczyÅ„ski, Google</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a></li>
<li><a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability Special Interest Group</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></li>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a></li>
<li><a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">testgrid.k8s.io</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-14 00:00:00">February 14, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openai-kubernetes-7500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›æ‹›å–š Kubernetes 7500 å°ç¯€é»!!!</a></h2>
<p><img alt="" src="/images/OpenAI_Logo.png" /></p>
<details class="quote" open="open">
<summary>Quote</summary>
<p>å¾ 2018 èµ·ï¼ŒOpenAI æ‰€æ¡ç”¨çš„ Kubernetes ç¯€é»æ•¸é‡æ–¼ 3 å¹´å…§æˆé•· 300%</p>
</details>
<ul>
<li>2017 <a href="https://kubernetes.io/case-studies/openai/">Kubernetes Case Study - OpenAI</a></li>
<li>2018/01/18 OpenAI ç™¼å¸ƒ <a href="https://openai.com/blog/scaling-kubernetes-to-2500-nodes/">Scaling Kubernetes to 2500 Nodes</a></li>
<li>2021/01/18 OpenAI ç™¼å¸ƒ <a href="https://openai.com/blog/scaling-kubernetes-to-7500-nodes/">Scaling Kubernetes to 7500 Nodes</a></li>
</ul>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_1">å‰è¨€</a></h3>
<p>OpenAI æ–¼ 2021 å¹´çš„æ™‚å€™å·²ç¶“ä¾†åˆ° 7,500 ç¯€é»æ•¸é‡è¦æ¨¡äº†ï¼Œæ›´ä½•æ³ç¾åœ¨ 2023 å¹´æœ‰è¶…å¿«é€Ÿã€æ›´èª‡å¼µçš„å…¨çƒç¸½é«”ä½¿ç”¨é‡ï¼Œæ ¹æœ¬æ˜¯ HPC/AI/ML on Kubernetes æ–¼ä¸€èº«æœ€ä½³æ¶æ§‹å…¸ç¯„ï¼Œå¦‚æœä½ å°é€™ç¨®è¶…å¤§è¦æ¨¡çš„ Kubernetes æœ‰èˆˆè¶£çš„è©±ï¼Œå‹™å¿…è¦æŠŠä¸Šé¢çš„æ–‡ç« éƒ½çœ‹éå¥½å¹¾éï¼Œå¯ä»¥é¿å…è¸©åˆ°åœ°é›·ï¼Œç•¢ç«Ÿ...é‚£äº›éƒ½æ˜¯ OpenAI ç”¨éˆ”èƒ½åŠ›æ›ä¾†çš„è¡€æ·šç¶“é©—å•Š...</p>
<p>é›–ç„¶æ²’æœ‰ç‰¹åˆ¥æåŠï¼Œä½†å°±æ–‡ç« è£¡é¢æè¿°çš„å…§å®¹ï¼Œæ‡‰è©²æ˜¯ç”¨ Azure Kubernetes Service (with Azure CNI) ä½œç‚ºåŸºåº•ï¼Œä¸‹é¢æœƒæœ‰ä¸€å€‹ç« ç¯€å°ˆé–€è¬› Azure Kubernetes Service çš„é—œéµè³‡è¨Šï¼Œæ•™å¤§å®¶æ€éº¼ç®— Pod / Node / Subnet æ•¸é‡å¤§å°</p>
<h3 id="tldr-openai-kubernetes-3"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#tldr-openai-kubernetes-3">TL;DR: OpenAI æ¡ç”¨ Kubernetes ä¸»è¦ 3 å¤§æ•ˆç›Š</a></h3>
<ol>
<li>æ˜“æ¬é· (Portability): åŸºæ–¼åŸºç¤æ¶æ§‹å³ä»£ç¢¼ (Infrastructure as Code, IaC)ã€Kubernetes ä¸€è‡´çš„ä¸”è²æ˜å¼ API (Consistent &amp; Declarative API)ã€å®¹å™¨æ˜ åƒæª”ä¸å¯è®Šå‹•æ€§ (Container Immutable Image) 3 å€‹ç‰¹æ€§ï¼Œè®“ä½ å¯ä»¥åœ¨ä¸åŒçš„é›²ç«¯å¹³å°ä¸Šé‹è¡Œä½ çš„é›²åŸç”Ÿç¨‹å¼</li>
<li>çœæˆæœ¬ (Cost Savings): åœ¨ä¸åŒé–‹ç™¼æƒ…å¢ƒçš„æ™‚å€™ï¼Œå¯ä»¥å®¹æ˜“ç§»å‹•ä½ çš„è³‡æºï¼Œä¾‹å¦‚ï¼šåœ¨é–‹ç™¼éšæ®µå¯ä»¥ä½¿ç”¨æœ¬åœ°çš„ Kubernetes ç’°å¢ƒï¼Œå¦‚ minikube, kind, kubeadm, Docker Desktop ç­‰ï¼Œè€Œåœ¨ç”Ÿç”¢éšæ®µå‰‡å¯ä»¥ä½¿ç”¨å¤§è¦æ¨¡ä¸”å—æ”¯æ´çš„ Kubernetes ç’°å¢ƒï¼Œå¦‚ Azure Kubernetes Service ç­‰ï¼Œå’Œ Kubernetes Cluster Autoscaler (CA) è‡ªå‹•èª¿æ•´é›†ç¾¤å¤§å°ï¼é€éå½ˆæ€§é¸æ“‡é©ç•¶çš„ç’°å¢ƒï¼Œé™ä½æ•´é«”æˆæœ¬ï¼Œæå‡åˆ©ç”¨ç‡ï¼Œç²å¾—æ›´å¤šç¡¬é«”è¨ˆç®—è³‡æº</li>
<li>å¢æ•ˆç‡ (Improved Efficiency): ä¸€åé–‹ç™¼åˆ†æ•£å¼ç³»çµ±ç³»çµ±çš„ç ”ç©¶å“¡ï¼Œå¯ä»¥åœ¨ 2 ~ 3 å¤©å…§è®“ä»–çš„ç¨‹å¼æ­£ç¢ºçš„é‹è¡Œï¼Œ1 ~ 2 é€±å¾Œå°±å¯ä»¥æ“´å¼µåˆ°å¥½å¹¾ç™¾å€‹ GPU ç¯€é»ï¼Œç›¸è¼ƒæ–¼ä»¥å‰å‰‡æ˜¯éœ€è¦ä»¥æœˆç‚ºå–®ä½çš„å·¥ä½œæ™‚é–“ï¼Œä¿æŒé–‹ç™¼å¿«é€Ÿè¿­ä»£çš„æ•ˆç›Š</li>
</ol>
<h3 id="openai-2500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#openai-2500">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›: 2,500 ç¯€é»è¦æ¨¡</a></h3>
<p>åŸºæ–¼ <a href="https://openai.com/blog/scaling-kubernetes-to-2500-nodes/">Scaling Kubernetes to 2500 Nodes</a>ï¼Œå»ºè­°å¯ä»¥åƒè€ƒ <a href="https://www.evanlin.com/til-openai-5000/">Evan Lin - Scaling Kubernetes to 2,500 Nodes</a> çš„æ–‡ç« æ•´ç†</p>
<h3 id="openai-7500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#openai-7500">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›: 7,500 ç¯€é»è¦æ¨¡</a></h3>
<p>ä¸‹é¢ç”±æˆ‘å€‹äººåŸºæ–¼ <a href="https://openai.com/blog/scaling-kubernetes-to-7500-nodes/">Scaling Kubernetes to 7500 Nodes</a> çš„æ–‡ç« æ•´ç†äº†ä¸‹åˆ—å¯ä»¥åƒè€ƒçš„å­¸ç¿’é»ï¼Œå¦å¤–è²æ˜ï¼Œé€™ä¸æ˜¯ç”¨ ChatGPT å¹«æˆ‘æ•´ç†çš„</p>
<ul>
<li>
<p>è¨ˆç®—ç›¸é—œ</p>
<ul>
<li>é‹è¡Œ MPI Jobs: ä»¥ MPI ä½œç‚ºèª¿åº¦åŸºç¤ï¼Œè€Œéå¤§é‡åˆ©ç”¨ Kubernetes å…§å»ºä¹‹ Scheduler</li>
<li>æœ€å¸¸è¦‹éŒ¯èª¤ç‚º Uncorrectable ECC error</li>
</ul>
</li>
<li>
<p>GPU ç›¸é—œ</p>
<ul>
<li>GPU é–“é€šè¨Šå¼·åŒ–: åˆ©ç”¨ <a href="https://www.nvidia.com/zh-tw/data-center/nvlink/">NVIDIA NVlink</a> äº¤å‰é€šè¨Šå’Œ <a href="https://docs.nvidia.com/cuda/gpudirect-rdma/">GPUDirect RDMA</a> èˆ‡ NIC ç›´æ¥é€šè¨Šä½¿æ•´é«”ç³»çµ±è¼¸é€é‡æ¥µå¤§åŒ–</li>
<li>å¤šæ•¸ 1 å€‹ç¯€é»æ”¾ 1 å€‹ Pod: å›  CPU / NUMA / PCI-E / Physical Server / Bandwidth ä¸¦éèª¿åº¦è³‡æºçš„ä¸»å› ï¼Œèª¿åº¦å£“åŠ›æ¥µä½ï¼Œä¸»è¦æ˜¯ GPU è³‡æº</li>
</ul>
</li>
<li>
<p>ç¶²è·¯ç›¸é—œ</p>
<ul>
<li>ç°¡åŒ–ç¶²è·¯è¤‡é›œæ€§: Pod å¯ä»¥ç›´æ¥é€é SSH é€£ç·šåˆ° Pod IP é€²è¡Œé€£ç·šï¼Œè€Œé Service Endpoint</li>
<li>Flannel CNI åœ¨å¤§è¦æ¨¡ä¸Šä½¿ç”¨æœƒæœ‰ Throughput å•é¡Œ</li>
<li>å¤§é‡æ¡ç”¨ iptables mangle è¦å‰‡: å°æµé‡æ–¹å‘é€²è¡Œæ¨™è¨˜ï¼Œä»¥ä¾¿é€²è¡Œæµé‡æ§åˆ¶ï¼Œè€Œéæ¡ç”¨ä¸€æ¢ä¸€æ¢è·¯ç”±è¦å‰‡ç®¡ç†</li>
<li>æ¡ç”¨ Prometheus çš„ iptables-exporter ä½œç‚ºç¶²è·¯æµé‡è¿½è¹¤åŸºç¤</li>
<li>æ¡ç”¨ Hub and Spoke ç¶²è·¯æ¶æ§‹: ç ”ç©¶äººå“¡å¯ä»¥å¾ Hub æœå‹™è¨ªå•åˆ°ä»»ä½• Spoke çš„æœå‹™ï¼Œå¦‚ AKS ç­‰ï¼Œä½†ä»»æ„ 2 å€‹ Spoke è£¡çš„ AKS æœå‹™å‰‡å›  Azure Virtual Network åŸç”Ÿä¸å…·å‚™è·¨ VNet Transit èƒ½åŠ›ï¼Œå‰‡ç„¡æ³•äº’ç›¸é€£æ¥ï¼Œä¿æŒæ•…éšœéš”é›¢åŸå‰‡ (Break Failure Isolation)</li>
<li>æ¡ç”¨è‡ªå»º NAT æœå‹™è™•ç† inbound DNAT æµé‡</li>
<li>å€‹åˆ¥ Pod ç¶²è·¯æµé‡åŠ ç¸½èµ·ä¾†ç›¸ç•¶é©šäºº</li>
</ul>
</li>
<li>
<p>å„²å­˜ç›¸é—œ</p>
<ul>
<li>æ¡ç”¨ Azure Blob Storage ä½œç‚ºä¸»è¦å„²å­˜ç³»çµ±: å› ç‚º Azure Blob Storage æ˜“æ–¼æ“´å±•ï¼Œä¸”ä¸éœ€è¦ slow detach/attach çš„é¡å¤–æ“ä½œ</li>
</ul>
</li>
<li>
<p>Kubernetes ç›¸é—œ</p>
<ul>
<li>ç„¡é€²è¡Œé etcd self-healing automationï¼Œæœ€å¤§çš„é›†ç¾¤å–®ç¨é‹è¡Œ 5 å€‹ API Server å’Œ 5 å€‹ etcd ç¯€é»</li>
<li>ç¯€é»æ•¸é‡å¤šï¼Œå°è‡´ API Server è¨˜æ†¶é«”åƒé‡: åŸºæ–¼ 7500 å°ç¯€é»é›†ç¾¤ï¼Œæ¯å€‹ API Servers éœ€è¦ 70GB çš„è¨˜æ†¶é«”</li>
<li>API Server å£“åŠ›æœ€å¤§ä¾†æºæ˜¯ Endpoints ä¸Šçš„ WATCH</li>
<li>Cluster Autoscaler æƒ…å¢ƒæ¸›å°‘ï¼Œå› ç‚ºé›†ç¾¤å·²ç¶“å¾ˆå¤§äº†</li>
<li>é‡å°åœ˜éšŠè³‡æºåˆ†é…å¯¦åš team-resource-manager</li>
<li>æ¡ç”¨ CPU &amp; GPU Balloons è®“ Cluster Autoscaler ä¸æœƒèªç‚ºç¯€é»é–’ç½®è€Œé€²è¡Œç§»é™¤ï¼Œé¿å…ç”¢ç”Ÿä¸å¿…è¦çš„èª¿åº¦å£“åŠ›</li>
<li>æ¡ç”¨ <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity">Pod Anti-affinity</a> ç¢ºä¿ Pod æœ€çµ‚æœƒè¢«å¹³å‡åœ°åˆ†ä½ˆåˆ°å„å€‹ç¯€é»ä¸Š</li>
<li>æ¡ç”¨ <a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/pkg/coscheduling/README.md">Coscheduling</a> æ‰¹æ¬¡è™•ç†ï¼Œé¿å… all or nothing çš„æƒ…æ³</li>
</ul>
</li>
<li>
<p>Monitoring ç›¸é—œ</p>
<ul>
<li>æ¡ç”¨ Promeheus å’Œ Grafana ä½œç‚ºç›£æ§ç³»çµ±</li>
<li>æ¡ç”¨ <a href="https://github.com/coreos/kube-prometheus">kube-prometheus</a>: å°æ–¼ HTTP 429 (Too Many Requests) å’Œ 5XX (Server Error) ç™¼é€è­¦å ±ç›¸ç•¶æœ‰æ•ˆæœ</li>
<li>æ¡ç”¨ <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config">Prometheus relabel</a> åŠŸèƒ½ï¼Œé¿å…æ”¶é›†åˆ°ä¸å¿…è¦çš„ Metricsï¼Œé™ä½å£“åŠ›</li>
<li>æ¡ç”¨ GOMAXPROCS=24 æ¸›ç·© WAL (Write-Ahead Log) é‡æ–°åŸ·è¡Œæ¬¡æ•¸</li>
<li>æ¡ç”¨ <a href="https://github.com/NVIDIA/gpu-monitoring-tools#dcgm-exporter">dcgm-exporter</a>ï¼Œè¨­å®š DCGM_FI_DEV_XID_ERRORSï¼ŒæŠ“å– XID Errorsï¼Œä¸¦ç™¼é€è­¦å ±</li>
<li>æ¡ç”¨ <a href="https://docs.nvidia.com/deploy/nvml-api/group__nvmlDeviceQueries.html#group__nvmlDeviceQueries">NVMLDevice Query API</a>: æä¾›æœ‰é—œ GPU çš„å¥åº·æƒ…æ³å’Œæ“ä½œçš„æ›´è©³ç´°ä¿¡æ¯</li>
<li>ä¸¦éæ‰€æœ‰ GPU éŒ¯èª¤éƒ½å¯ä»¥å¾ DCGM çœ‹åˆ° Error Code</li>
<li>Promtheus è‡ªå¸¶çš„ TSDB (Time Series Database) ä¸¦éæœ€ä½³é¸æ“‡ï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œé‡å•Ÿéœ€è¦å¾ˆé•·æ™‚é–“é‡æ–°åŸ·è¡Œ WAL</li>
</ul>
</li>
</ul>
<h3 id="_2"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_2">å€‹äººè§€é»</a></h3>
<ol>
<li>æ¯«ç„¡ç–‘å• Kubernetes æ¶æ§‹è¨­è¨ˆçš„ç¢ºé©åˆåšç‚ºå¤§è¦æ¨¡è¨ˆç®—éœ€æ±‚çš„åŸºç¤å¹³å°</li>
<li>æ¡ç”¨ Kubernetes ä¾ç„¶æœƒéœ€è¦è™•ç†ä¸å°‘æŠ€è¡“å•é¡Œï¼Œå¦‚ç¶²è·¯ã€ç›£æ§ã€è³‡æºèª¿åº¦ç­‰ï¼Œä¸¦ä¸æ˜¯åŸç”Ÿè¨­è¨ˆå°±èƒ½è§£æ±ºæ‰€æœ‰å•é¡Œ</li>
<li>é™¤ç‰¹å®šç”¢æ¥­ä»¥å¤–ï¼Œå°ç£å¤§å¤šæ•¸ä¼æ¥­å–®åº§ Kubernetes å¤šåŠéƒ½æ˜¯ä½æ–¼ 25 å°ç¯€é»é€™å€‹æ•¸é‡ç´šè·ï¼Œè‹¥æ˜¯æœ‰é¸æ“‡ç‰¹å®šå» å•†æ”¯æ´çš„ Kubernetes å¤šåŠä¸å¤ªæœƒé‡åˆ°ä¸Šé¢çš„å•é¡Œï¼Œå¦‚æœæ“”å¿ƒä¼°ç®—ä¸å¤ çš„è©±ï¼Œå€‹äººå»ºè­° Control Plane çš„ç¯€é»å¤§å°è¨ˆç®—å¯ä»¥ä»¥ 100 å°ç¯€é»æ‰¿è¼‰é‡åšç‚ºåŸºæº–ï¼Œä¸ç”¨ä»¥ 7,500 é€™å€‹è¦æ¨¡ç•¶ä½œåŸºç¤åƒè€ƒ</li>
<li>Control Plane é¡§å¾—å¥½ï¼Œæ™šä¸Šç¡è¦ºç¡å¾—è‘—</li>
<li>é€™æ–‡ç« æ²’ç‰¹åˆ¥è¬› Underlay Networking è¨­è¨ˆï¼ŒåŸºæ–¼å·²çŸ¥ Azure æ©Ÿæˆ¿ç¶²è·¯è¦åŠƒæ‡‰è©²æœƒæ˜¯ä»¥ Spine-Leaf Topology ç‚ºè¨­è¨ˆåŸºç¤ï¼Œä½†å…·é«” Switch æ˜¯ç”¨ä»€éº¼å°±ä¸çŸ¥é“äº†ï¼Œä¸»è¦åŸå› æ˜¯å› ç‚º GPUDirect RDMA éœ€è¦ Switch æ”¯æ´èƒ½åŠ›</li>
<li>æ‰¹æ¬¡è¨ˆç®—è™•ç†åŠè³‡æºåˆ†é…æ”ªå’Œåœ¨ä¸€èµ·ï¼Œæ˜¯ä¸€å€‹å¾ˆé‡è¦çš„ç ”ç©¶è­°é¡Œ</li>
</ol>
<h3 id="azure-kubernetes-sevices"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-kubernetes-sevices">Azure Kubernetes Sevices ä½ æ‡‰è©²è¦çŸ¥é“çš„é—œéµè³‡è¨Š</a></h3>
<details class="info" open="open">
<summary>Info</summary>
<p>2023/02/14 æ›´æ–°</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/quotas-skus-regions">Quotas, virtual machine size restrictions, and region availability in Azure Kubernetes Service (AKS)</a> æä¾›é—œéµè³‡è¨Šå¦‚ä¸‹:</p>
<p>ä»¥æ¡ç”¨ Azure Standard Load Balancer åŠ Standard Tier ç‚ºä¸»,</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Limit</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ–¼å–®ä¸€é›†ç¾¤å…§ä¹‹æœ€å¤§ç¯€é»æ•¸</td>
<td>ä¸Šé™ 5000 å°ç¯€é»ï¼Œç³»çµ±é è¨­ 1000 å°ç¯€é»</td>
</tr>
<tr>
<td>æ–¼å–®ä¸€ç¯€é»å…§ä¹‹æœ€å¤§ Pod æ•¸ ï¼ˆCNI æ¡ç”¨ kubenet)</td>
<td>æœ€å¤§ 250 å€‹ï¼Œç³»çµ±é è¨­ 110 å€‹</td>
</tr>
<tr>
<td>æ–¼å–®ä¸€ç¯€é»å…§ä¹‹æœ€å¤§ Pod æ•¸ ï¼ˆCNI æ¡ç”¨ Azure CNI)</td>
<td>æœ€å¤§ 250 å€‹ï¼Œç³»çµ±é è¨­ 30 å€‹</td>
</tr>
</tbody>
</table>
<h4 id="pod"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#pod">é—œæ–¼æœ€å¤§ Pod æ•¸é‡</a></h4>
<p>åŸºæ–¼ä¸Šé¢æ•¸æ“šå¯ä»¥æ›ç®—å‡º <mark>å–®ä¸€ AKS é›†ç¾¤å—æ”¯æ´çš„ç‹€æ³ä¸‹ï¼Œæœ€å¤šçš„ Pod æ•¸ç‚º 1,250,000 Pods</mark> ï¼ˆ= 5000 å€‹ç¯€é» * 250 å€‹ Pod)ï¼Œä½†é€™å€‹æ•¸å­—æ˜¯ä¼°ç®—å€¼ï¼Œå› ç‚ºå¯¦éš›å¯ç”¨ Pod æ•¸é‡æœƒå—åˆ°å¯¦éš›è¨ˆç®—è³‡æºåˆ†é…ã€Kubernetes Deployment æ’°å¯«æ–¹å¼ç­‰å› ç´ å½±éŸ¿</p>
<p>å¯¦å‹™ä¸Šï¼Œå–®ä¸€ç¯€é»ä¸Š Pod æ•¸é‡è¨­è¶…å¤§ï¼Œè€å¯¦èªªæ²’ä»€éº¼ç‰¹åˆ¥ç”¨è™•ï¼Œå¯èƒ½ä¸€å…©å€‹ Pod å°±æŠŠæ•´å€‹ç¯€é»è³‡æºåƒå®Œäº†ï¼Œçœ‹çœ‹ OpenAI çš„ç”¨æ³•ä¹Ÿæ˜¯ä¸€æ¨£ï¼Œ1 å€‹ç¯€é» 1 å€‹ Podï¼Œå› ç‚ºé—œéµç“¶é ¸åœ¨æ–¼ GPU è³‡æºï¼Œå¦‚æœä½ æƒ³è¦ç²¾ç®—çš„è©±ï¼Œå»ºè­°å¯åƒè€ƒä¹‹å‰çš„æ–‡ç«  <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a> é€²è¡Œç²¾ç´°è¨ˆç®—</p>
<h4 id="azure-subnet"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-subnet">é—œæ–¼ Azure Subnet è¨ˆç®—</a></h4>
<p>Kubernetes è¨­è¨ˆæœ€éº»ç…©çš„å°±æ˜¯ç¶²è·¯è¦åŠƒï¼Œå› ç‚ºå®ƒæ˜¯éƒ¨ç½²å¾Œä¸èƒ½æ”¹çš„åƒæ•¸ï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²ä¹‹å‰ä¸€å®šè¦å…ˆç®—å¥½ï¼Œé¿å…å¾ŒçºŒæ“´å……æœ‰å•é¡Œï¼è€Œæ¡ç”¨ä¸åŒ Kubernetes CNI æœƒå½±éŸ¿åˆ° Subnet è¨ˆç®—ï¼Œä¸‹é¢ä»¥ç¾è¡Œ AKS æ”¯æ´çš„ 2 ç¨® CNI ä¾†åšè¨ˆç®—ï¼š</p>
<ol>
<li>æ¡ç”¨ kubenet CNI</li>
<li>æ¡ç”¨ Azure CNI</li>
</ol>
<p>è‹¥ä½ å°æ–¼å…©è€… CNI æœ‰èˆˆè¶£æ¯”è¼ƒçš„è©±ï¼Œå¯ä»¥åƒè€ƒæ­¤æ–‡ <a href="https://learn.microsoft.com/en-us/azure/aks/concepts-network#compare-network-models">AKS - æ¯”è¼ƒç¶²è·¯æ¨¡å‹</a>ï¼Œé€™é‚Šä¸å†è´…è¿°</p>
<h5 id="kubenet-cni"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#kubenet-cni">æ¡ç”¨ kubenet CNI</a></h5>
<details class="note" open="open">
<summary>Note</summary>
<p>è‹¥æ¡ç”¨ kubenet CNI çš„è©±ï¼ŒPod ä¸æ”¯æ´ç›´æ¥å¾ Azure Subnet æ‹¿åˆ° IPï¼Œä¸­é–“æœƒé iptables é€²è¡Œ SNAT è½‰æ›</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/configure-azure-cni#plan-ip-addressing-for-your-cluster">Use kubenet networking with your own IP address ranges in Azure Kubernetes Service (AKS)
 - IP address availability and exhaustion</a> æ–‡ä»¶ï¼Œå› ç‚ºé€²è¡Œ AKS å‡ç´šçš„æ™‚å€™ï¼Œæœƒæ¡ç”¨å…ˆå»ºå¾Œæ‹†çš„æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦é ç•™ä¸€å€‹ç¯€é»çš„ IP ç©ºé–“ä¾›ä½¿ç”¨ï¼Œæ‰€ä»¥æ­£ç¢ºçš„ç¯€é»è¨ˆç®—åŸºç¤æœƒæ˜¯ <code>No. of Nodes + 1</code></p>
<p>ä¸‹åˆ—æä¾›è¨ˆç®—å…¬å¼</p>
<mark class="critic block">
<p>Minimum Subnet Size = Node IP = No. of Nodes + 1</p>
</mark>
<p>è©¦ç®— 1ï¼šä¸€åº§å…·å‚™ 50 å€‹ç¯€é»çš„ AKS æ¡ç”¨ kubenet CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 51 å€‹ = (50 å€‹ç¯€é» + 1)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /26ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 59 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 51</p>
<p>è©¦ç®— 2: ä¸€åº§å…·å‚™ 5,000 å€‹ç¯€é»çš„ AKS æ¡ç”¨ kubenet CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 5,000 å€‹ = (4999 å€‹ç¯€é» + 1)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /19ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 8,187 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 5,000</p>
<h5 id="azure-cni"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-cni">æ¡ç”¨ Azure CNI</a></h5>
<details class="note" open="open">
<summary>Note</summary>
<p>è‹¥æ¡ç”¨ Azure CNI çš„è©±ï¼Œæ¯ä¸€å€‹ Pod éƒ½èƒ½æ‹¿åˆ° Azure Subnet åˆ†é…åˆ°çš„ IPï¼Œèˆ‡å…¶å®ƒ Pod é€²è¡Œæºé€šæ™‚ä¸æœƒæœ‰é¡å¤–çš„ SNAT è½‰æ›æˆæœ¬</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/configure-azure-cni#plan-ip-addressing-for-your-cluster">Configure Azure CNI networking in Azure Kubernetes Service (AKS) - Plan IP addressing for your cluster</a> æ–‡ä»¶ï¼Œå› ç‚ºé€²è¡Œ AKS å‡ç´šçš„æ™‚å€™ï¼Œæœƒæ¡ç”¨å…ˆå»ºå¾Œæ‹†çš„æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦é ç•™ä¸€å€‹ç¯€é»çš„ IP ç©ºé–“ä¾›ä½¿ç”¨ï¼Œæ‰€ä»¥æ­£ç¢ºçš„ç¯€é»è¨ˆç®—åŸºç¤æœƒæ˜¯ <code>No. of Nodes + 1</code></p>
<p>æ•…ä¸‹åˆ—æä¾›ä¸€å€‹åˆç†çš„è¨ˆç®—å…¬å¼</p>
<mark class="critic block">
<p>Minimum Subnet Size = Node IP + Pod IP = (No. of Nodes + 1) + ((No. of Nodes + 1) * Maximum pods per nodes that you can configure)</p>
</mark>
<p>è©¦ç®— 1ï¼šä¸€åº§å…·å‚™ 50 å€‹ç¯€é»çš„ AKS æ¡ç”¨ Azure CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 12,801 å€‹ = (50 å€‹ç¯€é» + 1) + ((50 å€‹ç¯€é» + 1) * 250 Pods)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /18ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 16379 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 12,801</p>
<p>è©¦ç®— 2: ä¸€åº§å…·å‚™ 5000 å€‹ç¯€é»çš„ AKS æ¡ç”¨ Azure CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 1,255,000 å€‹ = (4999 å€‹ç¯€é» + 1) + ((4999 å€‹ç¯€é» + 1) * 250 Pods)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /11ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 2,097,147 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 1,255,000</p>
<h4 id="azure-vm"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-vm">é—œæ–¼ Azure VM å¤§å°</a></h4>
<ul>
<li>Azure VM å¤§å°ä¸èƒ½ä½æ–¼ 2 vCPUï¼Œä½æ–¼çš„è©±æœƒä¸èƒ½æ­£å¸¸é‹ä½œï¼Œè©³ç´° Azure Siez å¯åƒè€ƒ <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes">Azure Virtual Machines sizes</a></li>
<li>Container Images å¤§å°æœƒå½±éŸ¿åˆ° Kubernetes Node çš„å¤§å°ï¼Œç•¶æœ‰éå¤§çš„ Container Imagesï¼Œkubelet æœƒå› ç‚ºæ²’æœ‰è¶³å¤ çš„ç¡¬ç¢Ÿç©ºé–“è€Œç„¡æ³•æ­£å¸¸é‹ä½œï¼Œé€™å€‹åœ¨è·‘ AI æ¨¡çµ„å¯¦é©—çš„æ™‚å€™æœƒæ¯”è¼ƒå¸¸é‡åˆ°ï¼Œå› ç‚º AI æ¨¡çµ„çš„å®¹å™¨æ˜ åƒæª”é€šå¸¸éƒ½æœƒå¾ˆå¤§ï¼Œå¯åƒè€ƒ <a href="https://catalog.ngc.nvidia.com/containers">NVIDIA NGC Container Catalog</a> æ‰€æä¾›çš„å®¹å™¨æ˜ åƒæª”å¤§å°</li>
</ul>
<h3 id="_3"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_3">ç¸½çµ</a></h3>
<p>æœ‰äº›äº‹æƒ…åªèƒ½æ“æœ‰éˆ”èƒ½åŠ›æ‰æœƒçŸ¥é“</p>
<h3 id="_4"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_4">æ„Ÿè¬æ ¡ç¨¿</a></h3>
<ul>
<li><a href="https://linktr.ee/hwchiu">@hwchiu</a></li>
<li><a href="https://www.evanlin.com/">@Evan Lin</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-05 00:00:00">October 5, 2022</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pod"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/">å¯¦ç¾ä¸åœæ©Ÿçš„ Pod æ›´æ–°æ–¹å¼</a></h2>
<p><img alt="" src="https://learnk8s.io/a/55d21503055aaf9ef8a04d5e595ed505.png" />
Source from <a href="https://learnk8s.io/graceful-shutdown">Learnk8s - Graceful shutdown and zero downtime deployments in Kubernetes</a></p>
<!--more-->

<p>å¦‚æœä½ æœ‰ä¸€å€‹æŒçºŒä¸æ–·çš„æœå‹™ï¼Œå¦‚ Long-lived TCP connections æˆ–è€…æ˜¯æ‡‰ç”¨ç¨‹å¼é—œé–‰è¦è·‘å¾ˆä¹…çš„ï¼Œéœ€è¦ "Graceful shutdown Pod" çš„è©±</p>
<p>ä¸æ”¹ç¨‹å¼çš„ç‹€æ³ä¸‹ï¼Œæœ‰ä½ å¯ä»¥æœ‰ 2 å€‹æ²»æ¨™ä¸æ²»æœ¬çš„æ–¹å¼ä¾†é”æˆé€™ä»¶äº‹</p>
<ul>
<li>å»¶é² SIGTERM çš„è¨Šè™Ÿç™¼é€ï¼ŒpreStop Hook è¨­å®šä¹…ä¸€é»è®“ä»–ç¡ä¸€ä¸‹ (wait)</li>
</ul>
<div class="highlight"><span class="filename">preStop_sample</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>apiVersion: v1
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>kind: Pod
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>metadata:
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  name: lifecycle-demo
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>spec:
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>  containers:
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>  - name: lifecycle-demo-container
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    image: nginx
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    lifecycle:
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>      preStop:
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        exec:
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="hll">          command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;nginx -s quit; while killall -0 nginx; do sleep 10; done&quot;] # (1)
</span></code></pre></div>
<ol>
<li>
<p>Sleep for 10 seconds before sending SIGTERM to the main process</p>
</li>
<li>
<p>å»¶é² SIGKILL çš„ç™¼ç”Ÿï¼ŒæŠŠ terminationGracePeriodSeconds (default 30s) è¨­å®šé•·ä¸€é»ï¼Œè­¬å¦‚ä¸‹é¢çš„ç¯„ä¾‹</p>
</li>
</ol>
<div class="highlight"><span class="filename">terminationGracePeriodSeconds_sample</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>---
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>apiVersion: v1
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>kind: Pod
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>metadata:
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  name: pods-termination-grace-period-seconds
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>spec:
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>  containers:
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>      image: nginx
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>      name: pods-termination-grace-period-seconds
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>  terminationGracePeriodSeconds: 3600  # (1)
</code></pre></div>
<ol>
<li>Time to wait before moving from a TERM signal to the pod's main process to a KILL signal.</li>
</ol>
<p>å¦‚ä½•é¸æ“‡?</p>
<p>å¦‚æœä½ ç¨‹å¼é—œé–‰æ™‚ä¸éœ€è¦è™•ç†ä»»ä½•ç‹€æ…‹æˆ–åŒæ­¥è³‡æ–™ï¼Œé‚£å°±åªè¦è¨­å®š preStop å°±å¥½äº†ï¼Œå¦‚æœæ˜¯é‚£ç¨®å·²çŸ¥ç¨‹å¼é—œé–‰å·²çŸ¥è¦è·‘å¾ˆä¹… (&gt;30s) çš„ç¨‹å¼ï¼Œå»ºè­° preStop å’Œ terminationGracePeriodSeconds éƒ½è¦æ‹‰é•·ä¸€é»ï¼Œé€™æ¨£å°±èƒ½ç¢ºä¿ Pod é—œé–‰æ™‚ä¸æœƒæœ‰éˆç•°ç¾è±¡ç™¼ç”Ÿ</p>
<p>æ²»æœ¬ä½œæ³•æ˜¯: ç¨‹å¼æ”¶åˆ° SIGTERM è¨Šè™Ÿçš„æ™‚å€™ï¼Œç¨‹å¼è¦è‡ªå·±çŸ¥é“æ€éº¼é—œé–‰æœå‹™ï¼Œä¸è¦è®“åº•ä¸‹ Kubernetes å¹«ä½ ç¡¬é—œæ©Ÿ</p>
<h3 id="case-study-nginx-ingress-controller"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/#case-study-nginx-ingress-controller">Case Study: Nginx Ingress Controller</a></h3>
<p>ä¸‰ç®¡é½Šä¸‹: ä½¿ç”¨ preStop Hook + SIGTERM + terminationGracePeriodSeconds</p>
<p>é—œæ–¼ preStop çš„è™•ç†ï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L456-L460">ingress-nginx/deploy/static/provider/cloud/deploy.yaml#L456-L460</a>ï¼Œé€™é‚Šæœƒå»å‘¼å« waitshutdown é€™å€‹æŒ‡ä»¤ï¼Œå†è£¡é¢å»è™•ç† SIGTERM çš„è¨Šè™Ÿ</p>
<div class="highlight"><span class="filename">ingress-nginx/deploy/static/provider/cloud/deploy.yaml</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        lifecycle:
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>          preStop:
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>            exec:
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>              command:
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="hll">              - /wait-shutdown
</span></code></pre></div>
<p>é—œæ–¼ terminationGracePeriodSecondsï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L512">ingress-nginx/deploy/static/provider/cloud/deploy.yaml#L512</a></p>
<div class="highlight"><span class="filename">ingress-nginx/deploy/static/provider/cloud/deploy.yaml</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="hll">        terminationGracePeriodSeconds: 3600
</span></code></pre></div>
<p>é—œæ–¼ SIGTERM çš„è™•ç†ï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/cmd/waitshutdown/main.go#L28-L42">ingress-nginx/cmd/waitshutdown/main.go#L28-L42</a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ingress-nginx/cmd/waitshutdown/main.go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>func main() {
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="hll">    err := exec.Command(&quot;bash&quot;, &quot;-c&quot;, &quot;pkill -SIGTERM -f nginx-ingress-controller&quot;).Run()
</span><a id="__codelineno-9-3" name="__codelineno-9-3"></a>    if err != nil {
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>        klog.ErrorS(err, &quot;terminating ingress controller&quot;)
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>        os.Exit(1)
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>    }
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>    // wait for the NGINX process to terminate
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    timer := time.NewTicker(time.Second * 1)
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>    for range timer.C {
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>        if !nginx.IsRunning() {
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>            timer.Stop()
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>            break
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>        }
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>    }
</code></pre></div></td></tr></table></div>
<h3 id="references"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/#references">References</a></h3>
<ul>
<li><a href="https://engineering.rakuten.today/post/graceful-k8s-delpoyments/">Rakuten Developer - Zero-Downtime Rolling Deployments in Kubernetes</a></li>
<li><a href="https://www.facebook.com/groups/cloudnative.tw/posts/1470137983489532/">Facebook åŸæ–‡</a></li>
<li><a href="https://learnk8s.io/graceful-shutdown">Graceful shutdown and zero downtime deployments in Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/containers/container-lifecycle-hooks/">Kubernetes - Container Lifecycle Hooks</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-02-16 00:00:00">February 16, 2022</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="1-kubernetes-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/">æˆ‘è¦ 1 åº§ Kubernetes é‚„æ˜¯è¦å¤šåº§ Kubernetes? é‚„æ˜¯éƒ½å¯ä»¥?</a></h2>
<p>æ›¾ç¶“æ–¼ <a href="https://www.youtube.com/watch?v=-y-aycTxKBA">SDN x Cloud Native Meetup #42 OPA + å–®å¤šå¢é›†æ¶æ§‹æ¢è¨</a>ã€<a href="https://docs.google.com/presentation/d/1GBInjH45Vremz4_463T3Z5VK9CC_atpYSI-4yAY8QuE/edit#slide=id.p">ç°¡å ±</a> åˆ†äº«é <code>Kubernetes å¤šå¢é›†åŠå–®å¢é›†æ¶æ§‹é¸æ“‡æ¢è¨</code> çš„é¡Œç›®ï¼Œç•¶ä¸­æœ‰å¤šç§Ÿæˆ¶è­°é¡Œé‚„è »å—åˆ°é—œæ³¨çš„ï¼Œå‰›å¥½å› ç‚ºå·¥ä½œé—œä¿‚ä¹Ÿæœ‰è »å¤šå®¢æˆ¶åœ¨å•ç›¸åŒçš„é¡Œç›®ï¼Œé€™é‚Šæƒ³ç”¨æ–‡å­—çš„æ–¹å¼ç´€éŒ„ä¸€ä¸‹ï¼Œä¾›å¤§å®¶åƒè€ƒ</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-y-aycTxKBA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<!--more-->

<h3 id="q1-1-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q1-1-kubernetes">Q1: ä½•è¬‚ 1 åº§ Kubernetes?</a></h3>
<p><code>å¯å–®ç¨é‹è¡Œä¹‹ Kubernetes API ç‚ºæœ€å°ç®¡ç†å–®ä½</code>ï¼Œè·Ÿè©²åº§ Kubernetes åº•ä¸‹æœ‰å¤šå°‘ç¯€é»å®Œå…¨ç„¡é—œï¼Œç„¡è«–æ˜¯ Control Plane æˆ– Worker Planeã€‚å¯¦å‹™ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl cluster-info</code> ä¾†åšåˆ¤æ–·</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</code></pre></div>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå›  Kubernetes çš„è¨­è¨ˆæ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦è·Ÿ Kubernetes API Server é€²è¡Œï¼Œè©²æœå‹™é è¨­ä¸€å®šæœƒå»ºç«‹åœ¨ <code>Control Plane</code> ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>https://192.168.100.1:8443</code> ä¾†é€²è¡Œæºé€šï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ 2 å€‹ä»¥ä¸Šçš„ Kubernetes å¢é›†ï¼Œå‹¢å¿…æœƒç²å¾—åˆ°ä¸ä¸€æ¨£çš„ Kubernetes cluster-info è³‡è¨Š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="gp"># </span>ä½¿ç”¨å¢é›†<span class="w"> </span>Dev-and-Staging-Cluster
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">kubectl config use-c context Dev-and-Staging-Cluster</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="gp"># </span>Kubernetes<span class="w"> </span>å¢é›†<span class="w"> </span>Dev-and-Staging-Cluster
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="gp"># </span>åˆ‡æ›è‡³å¢é›†<span class="w"> </span>Prod-Cluster
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="go">kubectl config use-context Prod-Cluster</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="gp"># </span>Kubernetes<span class="w"> </span>å¢é›†<span class="w"> </span>Prod-Cluster
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="go">Kubernetes control plane is running at https://192.168.200.1:8443</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="go">CoreDNS is running at https://192.168.200.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</code></pre></div>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œé€é <code>kubectl config use-context</code> å¯ä»¥åˆ‡æ›è‡³å…¶ä»–å¢é›†é€²è¡Œæ“ä½œï¼Œä½ æœƒç™¼ç¾åˆ° 2 å€‹å¢é›†çš„ Control Plane ç¶²å€æ˜¯ä¸ä¸€æ¨£çš„ <code>https://192.168.100.1:8443</code> è·Ÿ <code>https://192.168.200.1:8443</code>ï¼Œé€™ä»£è¡¨ä½ åœ¨è·Ÿä¸åŒçš„å¢é›†åœ¨é€²è¡Œæ“ä½œ</p>
<p>ä¸Šè¿°æµç¨‹è‹¥ä½ æœ‰å»è€ƒé CNCF 3 å€‹è€ƒè©¦</p>
<ul>
<li>Certified Kubernetes Administrator (CKA)</li>
<li>Certified Kubernetes Application Developer (CKAD)</li>
<li>Certified Kubernetes Security Specialist (CKS)</li>
</ul>
<p>æ‡‰è©²æœƒè¦ºå¾—ç›¸ç•¶ç†Ÿæ‚‰ï¼Œå› ç‚ºè€ƒè©¦çš„æ™‚å€™ä¹Ÿæœƒè¦ä½ åˆ‡ä¾†åˆ‡å»ï¼Œå…¶å¯¦å°±æ˜¯é¿å…ä¸åŒçš„è€ƒé¡Œæ‰€éœ€çš„ç’°å¢ƒå½±éŸ¿åˆ°å½¼æ­¤ï¼Œå±¬æ–¼å¯¦é«”æ–¹å¼éš”é›¢ Kubernetes å¢é›†</p>
<h3 id="q2-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q2-kubernetes">Q2: Kubernetes å¤šç§Ÿæˆ¶éš”é›¢æ¶æ§‹æœ‰å¤šå°‘ç¨®é¡å‹?</a></h3>
<p>åŒ¯ç¸½ <a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">AKS</a>ã€<a href="https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/">EKS</a>ã€<a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">GKE</a> ä¸‰å®¶å…¬æœ‰é›²çš„å¯¦è¸ä½œæ³•ï¼Œæœƒå€åˆ†æˆ 2 å€‹æ–¹å‘ï¼Œ</p>
<ol>
<li>ä»¥é‚è¼¯æ–¹å¼éš”é›¢ Kubernetes å¢é›†ï¼Œä¹Ÿå°±æ˜¯è»Ÿå¤šç§Ÿæˆ¶ (Soft Multi-Tenancy)</li>
<li>ä»¥å¯¦é«”æ–¹å¼éš”é›¢ Kubernetes å¢é›†ï¼Œä¹Ÿå°±æ˜¯ç¡¬å¤šç§Ÿæˆ¶ (Hard Multi-Tenancy)</li>
</ol>
<p>é‚„æœ‰ä¸€ç¨®æ¯”è¼ƒç‰¹æ®Šçš„ç¡¬å¤šç§Ÿæˆ¶ï¼Œåƒ…æœƒå‡ºç¾åœ¨ Kubernetes å¹³å°ä¾›æ‡‰å•†æ–¹çš„è»Ÿé«”æ¶æ§‹è¨­è¨ˆï¼Œå› ç‚ºæˆ‘é€™ç¯‡ä¸»è¦æ˜¯å¯«çµ¦å–®ç´”çš„ Kubernetes ä½¿ç”¨è€…çœ‹ï¼Œæ‰€ä»¥ä¸åˆ—å…¥è¨è«–</p>
<h3 id="q3-soft-multi-tenancy"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q3-soft-multi-tenancy">Q3: è»Ÿå¤šç§Ÿæˆ¶ (Soft Multi-Tenancy) çš„é‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</a></h3>
<p>ä¸‹é¢å¼•ç”¨ <a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">åœ¨ Azure Kubernetes Service (AKS) ä¸­éš”é›¢å¢é›†çš„æœ€ä½³åšæ³•</a> çš„ç¤ºæ„åœ–</p>
<p><img alt="" src="/images/logical-isolation.png" /></p>
<p>ä»¥é€šé <a href="https://github.com/cncf/k8s-conformance">CNCF Conformance</a> ç‚ºä¸»çš„ Kubernetes å¢é›†ç‚ºä¸»ï¼Œé‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µä¸»è¦å€åˆ† 4 å€‹ä½œæ³•</p>
<ol>
<li>Kubernetes Namespaceï¼šå–®ä¸€å¢é›†å…§éƒ¨å‘½åç©ºé–“éš”é›¢</li>
<li>Kubernetes Network Policyï¼šå–®ä¸€å¢é›†å…§éƒ¨ç¶²è·¯éš”é›¢</li>
<li>Kubernetes RBACï¼šå–®ä¸€å¢é›†æ¬Šé™éš”é›¢</li>
<li>Resource Quotaï¼šå–®ä¸€å¢é›†å…§ä¹‹è¨ˆç®—è³‡æºéš”é›¢</li>
</ol>
<p>å¯¦éš›ä¸Šå°±æ˜¯æ‹¿åˆ° 1 åº§ Kubernetes å¢é›†å¾Œï¼Œé‡å°è©²å¢é›†é€²è¡Œä¸Šè¿° 4 å€‹ä½œæ³•çš„é‚è¼¯éš”é›¢ä¾†é€²è¡Œè³‡æºéš”é›¢ï¼Œä½†æœ€å°æ“ä½œå–®ä½æ˜¯ <code>Kubernetes Namespace</code> ç‚ºä¸»ï¼Œè€Œåº•å±¤è¨ˆç®—è³‡æºå¤§å®¶æ˜¯å…±ç”¨çš„ï¼Œå¦‚ä¸‹æ‰€åˆ—ï¼Œæˆ‘é€™åº§ <code>https://192.168.100.1:8443</code> å¢é›†è½„ä¸‹çš„ Kubernetes Namespace å¯é€é <code>kubectl create ns &lt;NAME&gt;</code> æ–°å¢ Namespaceï¼Œé™¤äº†ç³»çµ±å¿…è¦çš„ Namespace ä»¥å¤–ï¼Œå¦å¤–é‚„æ–°å¢äº† 3 å€‹é¢å‘å°ˆæ¡ˆæˆ–æ‡‰ç”¨çš„ DevTeam1ã€DevTeam2ã€Staging Namespace ä¾›å„åˆ¥æœå‹™ä½¿ç”¨</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="gp"># </span>ä»¥<span class="w"> </span>Dev<span class="w"> </span>and<span class="w"> </span>Staging<span class="w"> </span>Cluster<span class="w"> </span>ç‚ºä¾‹
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>namespace
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="go">NAME                        STATUS   AGE</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="go">default                     Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="go">DevTeam1                    Active   14s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="go">DevTeam2                    Active   14s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="go">kube-node-lease             Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="go">kube-public                 Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="go">kube-system                 Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="go">local-path-storage          Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="go">Staging                     Active   10s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="go">tanzu-package-repo-global   Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="go">tanzu-system-ingress        Active   10h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="go">tkg-system                  Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
</code></pre></div>
<p>é€™æ–¹å¼ä¹Ÿæ˜¯çµ•å¤§éƒ¨åˆ†åœ¨å­¸ Kubernetes çš„ç¶­é‹ç®¡ç†æ“ä½œçš„æ™‚å€™ï¼Œè‘—å¢¨æ¯”è¼ƒå¤šçš„å¸¸è¦‹è§’åº¦åŠå¸¸è¦‹å­¸ç¿’è·¯å¾‘</p>
<h3 id="q4-hard-multi-tenancy"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q4-hard-multi-tenancy">Q4: ç¡¬å¤šç§Ÿæˆ¶ (Hard Multi-Tenancy) çš„å¯¦é«”æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</a></h3>
<p>æ©...é€™å€‹å…¶å¯¦æ²’æœ‰ä»€éº¼è¨£ç«…ï¼Œå°±æ˜¯<code>å†å»ºç«‹ 1 åº§ Kubernetes</code>å°±å¥½ï¼Œæœ‰ç¨ç«‹çš„ Kubernetes APIã€ç¨ç«‹çš„è¨ˆç®—ç¶²è·¯å„²å­˜è³‡æºï¼Œè»Ÿå¤šç§Ÿæˆ¶çš„é‚è¼¯æ–¹å¼éš”é›¢ä¹Ÿå¯ä»¥å®Œå…¨ä½¿ç”¨</p>
<p><img alt="" src="https://docs.microsoft.com/zh-tw/azure/aks/media/operator-best-practices-cluster-isolation/physical-isolation.png" /></p>
<p>é æœŸæœ‰é€™éº¼å¤šçš„ Kubernetes å¢é›†è¢«éƒ¨ç½²å‡ºä¾†ï¼Œé‚„æ˜¯è¦èƒ½å¤ è¢«ç®¡ç†ï¼Œä»¥ç¾è¡Œå¸¸è¦‹çš„å¤šå¢é›†ç®¡ç†ä½œæ³•ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ä»¥ä¸‹ï¼š
- å¤šå¢é›†ç¶²è·¯è¦åŠƒï¼ŒåŒ…å«å°å¤–è² è¼‰å‡è¡¡ã€è·¨å¢é›†ç¶²è·¯
- å¤šå¢é›†ç­–ç•¥ç®¡ç†
- Single Sign On å–®ä¸€ç™»å…¥
- é›†ä¸­åŒ–æ—¥èªŒæ”¶é›†
- é›†ä¸­åŒ–è³‡æºç›£æ§
- ...</p>
<h3 id="q5"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q5">Q5: å…©è€…å¯ä¸å¯ä»¥æ··ç”¨?</a></h3>
<p>å¯ï¼Œå¤šå»ºå¹¾åº§ Kubernetes è£¡é¢å†ç”¨ Namespace ç­‰è»Ÿå¤šç§Ÿæˆ¶çš„éš”é›¢æ–¹å¼åˆ‡å‰²ï¼Œå¦‚åœ–æ‰€ç¤º</p>
<p><img alt="" src="https://docs.microsoft.com/zh-tw/azure/aks/media/operator-best-practices-cluster-isolation/logical-isolation.png" /></p>
<ul>
<li>è©³ç´°æè¿°å¦‚ä¸‹</li>
<li>2 åº§ Kubernetes å¢é›†ï¼Œåˆ†åˆ¥ç‚º Dev and Staging Cluster å’Œ Prod Cluster</li>
<li>ç•¶ä¸­ Dev and Staging Cluster å¢é›†å…§ï¼Œå…±æœ‰ 3 å€‹ Kubernets Namespaceï¼Œåˆ†åˆ¥ç‚º DevTeam1ã€DevTeam2ã€Staging</li>
<li>ç•¶ä¸­ Prod Cluster å¢é›†å…§ï¼Œå…±æœ‰ 3 å€‹ Kubernetes Namespace, åˆ†åˆ¥ç‚º Team1ã€Team2ã€Team3</li>
</ul>
<h3 id="q6"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q6">Q6: ç”¨æ§æ™‚æ©Ÿ?</a></h3>
<p>ä¸»è¦åˆ¤æ–·é»å°±æ˜¯ <code>Kubernetes API å¯ä¸å¯ä»¥å…±ç”¨å’Œè³‡æºéš”é›¢æ€§</code>çš„å–æ¨ï¼Œæ›å€‹è§’åº¦ä¾†è¬›ï¼Œå¦‚æœå–®åº§ Kubernetes çˆ†ç‚¸äº†ï¼Œä¸Šé¢çš„å°ˆæ¡ˆä½ èƒ½å¿å—å¤šå°‘æ˜¯æ›æ‰çš„ç‹€æ…‹ï¼Œå¦‚æœä½ ä¸èƒ½å¿å—ï¼Œæ‹†ï¼Œèƒ½å¿å—ï¼Œåˆ</p>
<p>ä¸‹é¢èˆ‰å¹¾å€‹æˆ‘å€‹äººé‡éæœƒå»ºè­°éœ€è¦å»ºå¤šåº§çš„ä¾‹å­ï¼š</p>
<ol>
<li>ä¸åŒç’°å¢ƒçš„ç¶²è·¯éš”é›¢ï¼Œå¦‚ DR / Staging / Dev / Prod //æŠ€è¡“ä¸Šæ²’å¾—è«‡</li>
<li>Kubernetes åˆè¦æ€§ï¼Œå¦‚ PCI-DSSã€HIPPA ç­‰ä¸èƒ½æ–¼åŒä¸€åº§ Kubernetes æ··ç”¨åˆè¦æª¢æ¸¬ //æŠ€è¡“ä¸Šæ²’å¾—è«‡</li>
<li>ä¸åŒå°ˆæ¡ˆæ€§è³ªï¼Œå¦‚æ—¢æœ‰å°æ–¼è³‡è¨Šç³»çµ±çš„æ³•è¦ã€æ ¸å¿ƒç³»çµ±ã€ä»¥ API Gateway ç‚ºä¸»çš„ MASA è¨­è¨ˆã€å…±äº«æœå‹™å¹³å° (CI/CD)ã€GPU åˆ†äº«ã€æŒ‡å®š Kubernetes ç‰ˆæœ¬ç­‰ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººå°æ–¼ç´”åœ°ç«¯å®¢æˆ¶çš„ç†è§£ç›¸ç•¶ä¸å»ºè­°</li>
<li>åº•å±¤ CPU æ¶æ§‹é›†ä¸åŒï¼Œå¦‚ x86_64ã€ppc ç­‰ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººåˆ¤æ–·ç›¸ç•¶ä¸å»ºè­°</li>
<li>ä¸åŒéƒ¨é–€ä¹‹é–“æŠ€è¡“è½å·® / æ¬Šé™ / å…§å¸³åˆ‡å‰²è­°é¡Œï¼Œå¦‚è«‡éŒ¢ä¿è­‰å‚·æ„Ÿæƒ…çš„æ™‚å€™ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººå°æ–¼ç´”åœ°ç«¯å®¢æˆ¶çš„ç†è§£ç›¸ç•¶ä¸å»ºè­°</li>
</ol>
<p>ä¸Šè¿°æœ‰äº›èªªæŠ€è¡“ä¸Šå¯ä»¥çš„ï¼Œå»ºè­°å¯ä»¥å˜—è©¦æŠŠå°å¼Ÿçš„æ‹™ä½œ <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a> çœ‹å®Œä¹‹å¾Œï¼Œè«‹æ‰€æœ‰è¦ä½åœ¨ä¸€èµ·çš„æœå‹™ä¼°ç®—ä¸€ä¸‹è³‡æºä½¿ç”¨é‡æœ‰è©•ä¼°ä¸‹ç½å®³çˆ†ç‚¸åŠå¾‘ (Blast Radius)ï¼Œå‰è€…è·ŸéŒ¢æœ‰é—œï¼Œå¾Œè€…è·Ÿ SLA æœ‰é—œ</p>
<p>æœ€å¾Œçµ¦å¼µæ¢—åœ–</p>
<p><img alt="" src="/images/haha.jpg" /></p>
<h3 id="q7-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q7-kubernetes">Q7: å¦‚æœå»ºå¤šåº§ Kubernetes ä¸å°±è¦è€—è²»å¾ˆå¤šè³‡æº?</a></h3>
<blockquote>
<p>å€‹äººè§€é»ï¼ŒKubernetes èˆ‡ Cloud OS ä¹‹æ–¼ Linux èˆ‡ OS çš„ç›¸å°é—œä¿‚</p>
</blockquote>
<p>å…¶å¯¦æŠŠ Kubernetes ç•¶ä½œä¸€å€‹é›²åŸç”Ÿä½œæ¥­ç³»çµ± (Cloud OS) çš„è§’åº¦ä¾†çœ‹ï¼Œæ‡‰å°ä¸åŒçš„å°ˆæ¡ˆéœ€æ±‚ï¼Œå¤§å®¶å°æ–¼ Kubernetes çš„è³‡æºå¤§å°ä¹Ÿæœƒæœ‰æ‰€ä¸åŒï¼Œé¡åŒæ–¼é–‹ç™¼äººå“¡è¦å¼„ä¸€å€‹å°ˆæ¡ˆç¸½æ˜¯è¦æå‡ºèªªï¼Œéœ€è¦ä»€éº¼ CPU / Memory / Disk / OS ç”¨å“ªå®¶çš„è³‡æºç”³è«‹ï¼Œé€™æ˜¯å¾ˆåˆç†çš„ï¼Œåªæ˜¯ Kubernetes æ¶æ§‹ä¸Šéœ€è¦å¤šè€ƒé‡ä¸€äº›äº‹æƒ…ï¼Œæ‰€ä»¥ä¿æœ‰ Kubernetes å¢é›†è³‡æºèª¿æ•´å½ˆæ€§åŠé¸æ“‡æ˜¯æ¶æ§‹ä¸Šéœ€è¦è€ƒé‡çš„åœ°æ–¹</p>
<p>æ‰€ä»¥å°å¼Ÿæ‰æœƒæä»¥ 2 å€‹æ–¹å‘çš„è§’åº¦ä¾†å”åŠ©å¤§å®¶å»ç§‘å­¸åœ°è©•ä¼°è³‡æºï¼Œè€Œä¸æ˜¯ä¸Ÿéª°å­çš„ä½œæ³•ï¼Œç•¶ä¸­ä¸€ç¯‡å·²ç¶“å¯«å¥½äº†ï¼Œå¯ä»¥åƒç…§åƒç…§</p>
<ul>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li>å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? Infra è§’åº¦ç¯‡ //é‚„æ²’å‹•åŠ›å¯«ï¼Œè«‹æŸæŸå®¢æˆ¶è´ŠåŠ©ä¸€ä¸‹å‹•åŠ›</li>
</ul>
<p>å¦å¤–é‚„æœ‰ä¸€ç¯‡å¤§æ¦‚ä¹Ÿå°± VMware æ‰æœ‰è³‡æ ¼å¯«çš„å¤šå¢é›† Kubernetes æ–¼è™›æ“¬åŒ–å¹³å°ä¹‹æ•ˆèƒ½å ±å‘Šæ›¸ <a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/vsphere-tanzu-kubernetes-perf.pdf">Performance Best Practices for Kubernetes with VMware Tanzu - Performance Study</a> ä¹Ÿå¯ä»¥åƒè€ƒä¸€ä¸‹ï¼Œå¯«å¾—ç›¸ç•¶é è­œå‹™å¯¦</p>
<h3 id="q8-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q8-kubernetes">Q8: å¦‚æœæˆ‘å°±æ˜¯åƒ…å»ºä¸€åº§ Kubernetes è£¡é¢æœå‹™å¡å¥½å¡æ»¿å¯ä¸å¯ä»¥?</a></h3>
<p>å¯ï¼Œä½†è¦ç¢ºä¿å°æ–¼ <code>Q3: è»Ÿå¤šç§Ÿæˆ¶çš„é‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</code> æ‰€æä¹‹é‚è¼¯éš”é›¢æ‰‹æ®µï¼Œæ‰€æœ‰åƒèˆ‡ä¹‹ä¸Šçš„ç§Ÿæˆ¶éƒ½è¦æœ‰ç›¸åŒçš„èªçŸ¥ï¼Œç„¶å¾Œè¨­è¨ˆè©² Kubernetes å¢é›†çš„æ¶æ§‹å¸«ï¼Œå‹™å¿…è¦ç›¸ç•¶ç†Ÿæ‚‰é€šç›¤çš„ç¶²è·¯æ¶æ§‹ï¼Œç„¡è«–æ˜¯ Kubernetes å…§éƒ¨æˆ–è€…æ˜¯å¤–éƒ¨</p>
<h3 id="references"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#references">References</a></h3>
<ul>
<li><a href="https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/">EKS Best Practices Guides - Tenant Isolation</a></li>
<li><a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">åœ¨ Azure Kubernetes Service (AKS) ä¸­éš”é›¢å¢é›†çš„æœ€ä½³åšæ³•</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/best-practices/enterprise-multitenancy#assumptions_and_requirements">GKE ä¼ä¸šçº§å¤šç§Ÿæˆ·æœ€ä½³åšæ³•</a></li>
<li><a href="https://github.com/cncf/k8s-conformance">cncf/k8s-conformance</a></li>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li><a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/vsphere-tanzu-kubernetes-perf.pdf">Performance Best Practices for Kubernetes with VMware Tanzu - Performance Study</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-29 00:00:00">November 29, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a></h2>
<p>æŸé€±ï¼Œä¸‹ç­å‰è‡¨æ™‚è¢« S å­¸å§ŠæŠ“å»çœ‹äº†ä¸€å€‹ Kubernetes æœå‹™ç‚ºä½•ä¸æœƒæ­£å¸¸ä½œå‹•ï¼Œæ•…èº«ç‚ºå­¸å¼Ÿçš„æˆ‘å‡ºäº†ç¯‡æŠ€è¡“æ–‡å¸Œæœ›è¨˜éŒ„ä¸€ä¸‹ç›¸é—œé™¤éŒ¯æ€è·¯çµ¦å„ä½åƒè€ƒ</p>
<blockquote>
<p>å‹äºº Aï¼šè¦ºå¾—æ¯”æ Kubernetes é‚„é›£çš„äº‹æƒ…ï¼Œå¤§æ¦‚å°±æ˜¯è«‡æˆ€æ„›é€™ä»¶äº‹äº†
å‹äºº Bï¼šKubernetes èµ·ç¢¼è·Ÿä»–å‘Šç™½ (a.k.a. è²æ˜å¼å®£å‘Š, Declarative)ï¼Œå®ƒæœƒæœ€å¤§æ»¿è¶³ä½ æœŸæœ›ç‹€æ…‹ (Desired State)ï¼Œä½†è·Ÿå¦¹å­å‘Šç™½å¯èƒ½æœƒè¢«æŠ“å»è­¦å¯Ÿå±€ï¼Œé †ä¾¿é€ä½ ä¸€å¼µè·Ÿé¨·æ³•
å‹äºº Cï¼šé€™æ¨£æƒ³æƒ³ Kubernetes å¥½åƒé‚„æ¯”è¼ƒå’Œè—¹å¯è¦ª</p>
</blockquote>
<!--more-->

<p><img alt="" src="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.png" /></p>
<p>é¦–å…ˆï¼Œå¾ˆä¹…ä»¥å‰ <a href="https://learnk8s.io/troubleshooting-deployments">Learnk8s A visual guide on troubleshooting Kubernetes deployments</a> æœ‰ç‚ºäº†å»£å¤§å—åˆ° Kubernetes ä½ˆç½²(è¼æ¯’)å¤±æ•—ä¹‹è‹¦çš„æœ‹å‹å‡ºäº†ä¸€ä»½ Troubleshooting Kubernetes deployments æµç¨‹åœ– <a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.pdf">ç°¡ä¸­ç‰ˆ</a> / <a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v2.pdf">è‹±æ–‡ç‰ˆ</a>ï¼Œæˆ‘å€‹äººè¦ºå¾—å¾ˆå…·å‚™åƒè€ƒåƒ¹å€¼ï¼Œå…§æ–‡ä¸»è¦ 3 å¤§éšæ®µæ˜¯ï¼š</p>
<ol>
<li>ç¢ºèª Pod é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 50%)</li>
<li>ç¢ºèª Service é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 25%)</li>
<li>ç¢ºèª Ingress é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 25%)</li>
</ol>
<p>é™¤äº†ç¢ºèª Pod é‹ä½œæ­£å¸¸æ˜¯æ¯”è¼ƒåå‘ App é–‹ç™¼åŠç¨‹å¼ä½ˆç½²è­°é¡Œï¼Œå…¶ä»–å…©å€‹çµ•å¤§éƒ¨åˆ†éƒ½è·Ÿç¶²è·¯è„«ä¸äº†å¤ªå¤§é—œä¿‚ï¼Œæ‰€ä»¥æˆ‘é€™é‚ŠåŸºæ–¼è©²æ–‡å°æ–¼ç¶²è·¯é™¤éŒ¯ï¼ŒåŒ…å« DNSã€IPã€HTTP æ¸¬è©¦æ–¹å¼é€²è¡Œä¸€äº›å€‹äººè£œå……å»ºè­°</p>
<h3 id="pod"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod">é™¤éŒ¯å‰çš„åŸºç¤çŸ¥è­˜: Pod</a></h3>
<p>Podï¼Œæ˜¯å¯¦éš›ä¸Šä½ çš„å®¹å™¨æ˜ åƒæª”é‹è¡Œåœ¨ Kubernetes çš„æœ€å°å–®ä½ï¼Œè£¡é¢å¯ä»¥æ˜¯ 1 å€‹æˆ–å¤šå€‹ Containers åœ¨è£¡é¢ï¼Œè€ŒåŒä¸€å€‹ Pod è£¡é¢æœƒå…±äº«åŒä¸€å€‹ Linux Namespace çš„è³‡æºï¼ŒåŒ…å« PID / NID ç­‰ã€‚æ–¼æœ¬ç¯‡æ–‡ç« å…§æ¯”è¼ƒé‡è¦çš„æ˜¯åŒä¸€å€‹ Pod è£¡é¢çš„ Linux Network Namesapce çš„ç¶²è·¯å…±äº«èƒ½åŠ›ï¼Œæ„æŒ‡æ¯ 1 å€‹ Pod ï¼Œç„¡è«–æœ‰å¤šå°‘å€‹ Containers åœ¨è£¡é¢é‹è¡Œï¼Œéƒ½æœƒå…±äº«æ–¼è©² Kubernetes å¢é›†å…§å”¯ä¸€çš„ IPï¼Œä¹Ÿå°±æ˜¯ <code>Pod IP</code></p>
<h3 id="1-debug-container"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#1-debug-container">ä¸€åˆ‡çš„èµ·é»ï¼Œ1 å€‹ Debug Container</a></h3>
<p>é¦–å…ˆï¼Œä½ éœ€è¦å…ˆæœ‰ä¸€å€‹å·²ç¶“å°è£å¥½<code>å…·å‚™é™¤éŒ¯å·¥å…·</code>çš„å®¹å™¨æ˜ åƒæª”ï¼Œå¾Œé¢ç°¡ç¨± <code>Debug Container</code></p>
<p>é€™å€‹ Debug Container çš„ä¾†æºï¼Œä¸»è¦æ˜¯ 2 å€‹ä¾†æºï¼Œå…¶ä¸€æ˜¯å¯ä»¥æ˜¯æ¡ç”¨ç¤¾ç¾¤å–„å¿ƒäººå£«ç·¨è­¯å¥½çš„å®¹å™¨æ˜ åƒæª”ï¼Œå¦‚ <code>docker.io/nicolaka/netshoot</code>ç­‰ï¼Œæˆ–å…¶äºŒæ˜¯éš¨è‡ªå®¶éœ€æ±‚ï¼Œå¾ <code>Base Image</code> è‡ªè¡Œå®‰è£ã€æ‰“åŒ…å®¹å™¨æ˜ åƒæª”ï¼Œå¦‚ <code>quay.io/pichuang/debug-container</code> ç­‰ï¼Œä¿æŒå®¹å™¨æ˜ åƒæª”å¯æ§ã€å¯è‡ªè¡Œç¶­è­·ç­‰å¥½è™•</p>
<p>æœ¬æ–‡æ¡ç”¨ <code>docker.io/nicolaka/netshoot</code> ä½œç‚ºä¸»è¦ Debug Container çš„åŸºç¤ï¼Œè©³ç´°åŒ…å«ä¹‹å·¥å…·å¯åƒè€ƒ <a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot</a></p>
<p>æŠŠé€™å€‹ Debug Container é‹è¡Œåœ¨ Kubernetes ä¸Šå¾Œï¼Œæœƒä»¥ Kubernetes Pod çš„å½¢å¼é‹ä½œæ–¼ä¸Šï¼Œæ‰€ä»¥ä¹Ÿæœƒæœ‰ 1 å€‹ Pod IP å¯ä»¥æ‹¿ä¾†è·Ÿå…¶ä»– Pod åšäº¤å‰æ¯”å°ä½¿ç”¨ï¼Œæ‰€ä»¥èº«ç‚ºä¸€å€‹ Kubernetes ä½¿ç”¨è€…ï¼Œæœ‰ä¸€å€‹å¥½ä¸Šæ‰‹çš„ Debug Container æ˜¯ä¸€å€‹å¾ˆåˆç†çš„äº‹æƒ…</p>
<h3 id="debug-container-2"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#debug-container-2">é‹è¡Œ Debug Container ä¹‹ 2 ç¨®æ–¹å¼</a></h3>
<p>è‡³æ–¼é‹è¡Œæ–¹å¼æ˜¯ä½¿ç”¨ kubectl é€²è¡Œæ“ä½œï¼Œä»¥<code>æŒ‡å®š namespace ç‚ºè§’åº¦</code>å‡ºç™¼é€²è¡Œæ“ä½œï¼Œä¸»è¦æœ‰ä¸‹åˆ— 2 ç¨®ä½œæ³•ä½†ä¸é™æ–¼ï¼š</p>
<ol>
<li>
<p>æ–¼æŒ‡å®š Namespace åŸ·è¡Œ Debug Container
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">#</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="c1"># Running debug container within the Kubernetes Namespace on Any Nodes</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1">#</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
</code></pre></div></p>
</li>
<li>
<p>æ–¼æŒ‡å®š Namespace å’ŒæŒ‡å®š Node åŸ·è¡Œ Debug Container
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>#
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a># Running debug container within the Kubernetes Namespace on Specific Node (ex: tkg-worker-1)
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>#
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a># List of all Kubernetes nodes
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>$ kubectl get nodes
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>NAME                           STATUS   ROLES                  AGE   VERSION
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>tkgm14-control-plane-pv76m     Ready    control-plane,master   38d   v1.21.2+vmware.1
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>tkgm14-md-0-66f85bf86b-wfjt7   Ready    &lt;none&gt;                 38d   v1.21.2+vmware.1
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>$ kubectl run -n default debug-container --rm -i --tty --overrides=&#39;{ &quot;apiVersion&quot;: &quot;v1&quot;, &quot;spec&quot;: {&quot;kubernetes.io/hostname&quot;:&quot;tkgm14-control-plane-pv76m&quot;}}&#39; --image docker.io/nicolaka/netshoot -- /bin/bash
</code></pre></div></p>
</li>
</ol>
<p>æ­£å¸¸ç‹€æ³ä¸‹ï¼Œä½ æ‡‰è©²ç›´æ¥ä½¿ç”¨æ–¹æ³• 1 å°±å¯ä»¥æ‰¾å‡ºå¾ˆå¤šå•é¡Œäº†ï¼Œé™¤éä½ æ‡·ç–‘ç‰¹å®šç¯€é»æ€ªæ€ªçš„ï¼Œå†ä½¿ç”¨æ–¹æ³• 2</p>
<h3 id="pod-5-5"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod-5-5">å¾ Pod å‡ºç™¼çš„ 5 ç¨®æµé‡èµ°æ³•ï¼Œ5 ç¨®é™¤éŒ¯æ–¹å‘</a></h3>
<p>æ•´é«”ä¸Šï¼ŒKubernetes å…§åˆ°å¤–ç¶²è·¯æµé‡ï¼Œç´„ç•¥å¯ä»¥æ¢åˆ—æˆç‚ºä¸‹åˆ— 5 ç¨®æµé‡èµ°æ³•ä½†ä¸é™ï¼š</p>
<ol>
<li>Container to Container</li>
<li>Pod to Pod in the same nodes</li>
<li>Pod to Pod across different nodes</li>
<li>Pod to Service</li>
<li>Pod to Internet</li>
</ol>
<p>è©³ç´°å¯åƒè€ƒå°å¼Ÿæ–¼é¦™æ¸¯é–‹æºäººå¹´æœƒä¹‹åˆ†äº« <a href="https://speakerdeck.com/pichuang/how-do-i-troubleshooting-on-container-more-than-docker">20200612, How I do troubleshooting on container, more than docker?, HKOSCon 2020</a></p>
<p>å› ç‚ºå¯¦éš›ä¸Šæ‰€æœ‰å¯¦éš›æœå‹™éƒ½æ˜¯è¢«åŒ…è£åœ¨ Pod è£¡é¢é‹è¡Œï¼Œæ•…ç•¶é‡åˆ°æœå‹™ä¸é€šæˆ–ç•°å¸¸çš„æ™‚å€™ï¼Œæƒ³è¦å¿«é€Ÿé€²è¡Œç¶²è·¯æµé‡é™¤éŒ¯ï¼Œå¯ä»¥ä»¥ <code>Pod IP è§’åº¦ä¸”ä»¥ Kubernetes Service å¸¸è¦‹åˆ†é¡ç‚ºä¸»</code>ä¹‹ 4 ç¨®é™¤éŒ¯æ–¹å‘:</p>
<ol>
<li>Pod IP to Pod IP</li>
<li>Pod IP to ClusterIP</li>
<li>Pod IP to NodePort IP</li>
<li>Pod IP to LoadBalancer IP (é›²ç«¯å¸¸è¦‹ï¼Œæˆ–ç‰¹å®š LB è»Ÿé«”æœ‰æä¾›æ•´åˆèƒ½åŠ›ï¼Œå¦‚ AVI Networks)</li>
</ol>
<p>å¦å¤–é‚„æœ‰ 1 å€‹ Kubernetes Service ç·¨åˆ¶å¤–ä½†å¸¸è¦‹çš„ Ingress Controller</p>
<ol>
<li>Pod IP to Ingress Hosts (åœ°ç«¯å¸¸è¦‹ï¼Œå¦‚ Contourã€Nginx)</li>
</ol>
<h4 id="_1"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#_1">æ”¶é›†é™¤éŒ¯å‰ä¹‹å¿…è¦è³‡è¨Š</a></h4>
<p>è¦é–‹å§‹ä½¿ç”¨ Debug Container é€²è¡Œé™¤éŒ¯ä¹‹å‰ï¼Œå‹™å¿…è¦å…ˆæ”¶é›†å¥½ç›¸é—œè³‡è¨Š <code>kubectl get pods,svc,nodes -owide</code>ï¼Œä¸»è¦æ˜¯è¦æœ‰ IP å’Œåå­—ä¹‹å…¶ç›¸é—œè³‡è¨Šï¼Œå¦‚ä»¥ä¸‹æ“ä½œï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods,svc,nodes,ingress<span class="w"> </span>-owide
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>NAME<span class="w">                                    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">   </span>IP<span class="w">            </span>NODE<span class="w">                           </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>pod/tanzu-deployment-5769f6c4df-2fl28<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.33<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>pod/tanzu-deployment-5769f6c4df-8jj87<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.35<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>pod/tanzu-deployment-5769f6c4df-nlcg8<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.34<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>NAME<span class="w">                     </span>TYPE<span class="w">         </span>CLUSTER-IP<span class="w">      </span>EXTERNAL-IP<span class="w">     </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">          </span>AGE<span class="w">   </span>SELECTOR
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>service/kubernetes<span class="w">       </span>ClusterIP<span class="w">    </span><span class="m">100</span>.64.0.1<span class="w">      </span>&lt;none&gt;<span class="w">          </span><span class="m">443</span>/TCP<span class="w">          </span>38d<span class="w">   </span>&lt;none&gt;
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>service/tanzu-service<span class="w">    </span>NodePort<span class="w">     </span><span class="m">100</span>.70.88.107<span class="w">   </span>&lt;none&gt;<span class="w">          </span><span class="m">3000</span>:30390/TCP<span class="w">   </span>60m<span class="w">   </span><span class="nv">app</span><span class="o">=</span>tkgm-deployment
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>service/tanzu-lb-service<span class="w"> </span>LoadBalancer<span class="w"> </span><span class="m">100</span>.70.88.108<span class="w">   </span><span class="m">172</span>.18.30.100<span class="w">   </span><span class="m">3000</span>:30340/TCP<span class="w">   </span>60m<span class="w">   </span><span class="nv">app</span><span class="o">=</span>tkgm-deployment
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>NAME<span class="w">                                </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">   </span>VERSION<span class="w">            </span>INTERNAL-IP<span class="w">    </span>EXTERNAL-IP<span class="w">    </span>OS-IMAGE<span class="w">             </span>KERNEL-VERSION<span class="w">     </span>CONTAINER-RUNTIME
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>node/tkgm14-control-plane-pv76m<span class="w">     </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>38d<span class="w">   </span>v1.21.2+vmware.1<span class="w">   </span><span class="m">172</span>.18.30.38<span class="w">   </span><span class="m">172</span>.18.30.38<span class="w">   </span>Ubuntu<span class="w"> </span><span class="m">20</span>.04.2<span class="w"> </span>LTS<span class="w">   </span><span class="m">5</span>.4.0-77-generic<span class="w">   </span>containerd://1.4.6
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>node/tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>Ready<span class="w">    </span>&lt;none&gt;<span class="w">                 </span>38d<span class="w">   </span>v1.21.2+vmware.1<span class="w">   </span><span class="m">172</span>.18.30.39<span class="w">   </span><span class="m">172</span>.18.30.39<span class="w">   </span>Ubuntu<span class="w"> </span><span class="m">20</span>.04.2<span class="w"> </span>LTS<span class="w">   </span><span class="m">5</span>.4.0-77-generic<span class="w">   </span>containerd://1.4.6
</code></pre></div>
<h4 id="1-pod-ip-to-pod-ip-traffic"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#1-pod-ip-to-pod-ip-traffic">1. Pod IP to Pod IP Traffic</a></h4>
<p>ä¸­ç­‰é›£åº¦çš„æ¸¬è©¦ï¼ŒåŒ…å« Ping / Curl éƒ½è¦èƒ½ç²å¾—é æœŸçš„åæ‡‰ï¼Œå¦‚æœæœ‰å•é¡Œçš„è©±ï¼Œå¯ä»¥åƒé–± <a href="https://learnk8s.io/troubleshooting-deployments">Learnk8s A visual guide on troubleshooting Kubernetes deployments</a> é€²è¡Œ Pod å…§éƒ¨é‹è¡Œçš„å•é¡Œé™¤éŒ¯ï¼Œé€™æ™‚å€™ä¸‹ <code>kubectl logs &lt;pod name&gt;</code> å’Œ <code>kubectl describe pod &lt;pod name&gt;</code> æ‡‰è©²éƒ½æœƒæœ‰äº›è››çµ²é¦¬è·¡</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.36
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="c1">#</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.35
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.34
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.33
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>PING<span class="w"> </span><span class="m">100</span>.96.1.33<span class="w"> </span><span class="o">(</span><span class="m">100</span>.96.1.33<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">100</span>.96.1.33:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.875<span class="w"> </span>ms
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="c1"># Curl web page</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.33:3000
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.34:3000
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.35:3000
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="2-pod-ip-to-clusterip-traffic"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#2-pod-ip-to-clusterip-traffic">2. Pod IP to ClusterIP Traffic</a></h4>
<p>æœ€æ ¸å¿ƒçš„æ¸¬è©¦ï¼Œé¦–å…ˆä½ éœ€è¦å…ˆå° Kubernetes Services é‹ä½œè¦æœ‰ä¸€å®šç¨‹åº¦ç†è§£ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ <a href="https://www.hwchiu.com/kubernetes-service-i.html">Hwchiu - Kubernetes What Is Service?</a> ä¸€æ–‡ï¼Œåœ¨é€™å€‹éšæ®µä¸»è¦æ¸¬è©¦ç›®æ¨™æ˜¯ï¼Œç¢ºèªå¯ä»¥é€é Kubernetes Cluster IP ç²å¾— Pod çš„å…§å®¹</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.37
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="c1">#</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="c1"># DNS Lookup</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="c1"># https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="c1">#</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="c1"># nslookup &lt;service name&gt;.&lt;namespace name&gt;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="c1"># nslookup &lt;service name&gt;.&lt;namespace name&gt;.svc.cluster.local</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>bash-5.1#<span class="w"> </span>nslookup<span class="w"> </span>tanzu-service.default
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>bash-5.1#<span class="w"> </span>nslookup<span class="w"> </span>tanzu-service.default.svc.cluster.local
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>Server:<span class="w">     </span><span class="m">100</span>.64.0.10
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>Address:<span class="w">    </span><span class="m">100</span>.64.0.10#53
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>Name:<span class="w">   </span>tanzu-service.default.svc.cluster.local
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>Address:<span class="w"> </span><span class="m">100</span>.70.88.107
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="c1">#</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="c1"># Ping (FAILED)</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># Ping doesn&#39;t work with service&#39;s cluster IPs like 100.70.88.107, as it is a virtual IP</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1"># You should be able to ping a specific pod, but no a service.</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.70.88.107
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>PING<span class="w"> </span><span class="m">100</span>.70.88.107<span class="w"> </span><span class="o">(</span><span class="m">100</span>.70.88.107<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>--<span class="w"> </span>Pending<span class="w"> </span>--
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="c1">#</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="c1"># Curl</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="c1">#</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="c1"># curl &lt;service name&gt;.&lt;namespace name&gt;:&lt;svc port&gt;</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="c1"># curl &lt;service name&gt;.&lt;namespace name&gt;.svc.cluster.local:&lt;svc port&gt;</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="c1"># curl &lt;cluster ip&gt;:&lt;svc port&gt;&gt;</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="c1"># Curl web page (OK)</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>tanzu-service.default:3000
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>tanzu-service.default.svc.cluster.local:3000
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.70.88.107:3000
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="c1"># Curl Kubernetes API Service (OK)</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://kubernetes.default:443
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="m">403</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://kubernetes.default.svc.cluster.local:443
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a><span class="m">403</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://100.64.0.1:443
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a><span class="m">403</span>
</code></pre></div>
<h4 id="3-pod-ip-to-nodeport-ip"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#3-pod-ip-to-nodeport-ip">3. Pod IP to NodePort IP</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Node IP ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="c1">#</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="c1"># Pod IP -&gt; Node IP</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="c1">#</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.18.30.39
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>PING<span class="w"> </span><span class="m">172</span>.18.30.39<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.30.39<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.18.30.39:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.463<span class="w"> </span>ms
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="c1">#</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="c1"># Curl</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="c1"># curl &lt;node ip&gt;:&lt;node port&gt;</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.30.39:30390
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="4-pod-ip-to-loadbalancer-ip"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#4-pod-ip-to-loadbalancer-ip">4. Pod IP to LoadBalancer IP</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Loadbalacner IP ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="c1">#</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="c1"># Pod IP -&gt; LoadBalancer IP</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="c1">#</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.18.30.100
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>PING<span class="w"> </span><span class="m">172</span>.18.30.100<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.30.100<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.18.30.100:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.3<span class="w"> </span>ms
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="c1">#</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="c1"># Curl</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="c1"># curl &lt;LoadBalancer ip&gt;:&lt;LB port&gt;</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.30.100:30340
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="5-pod-ip-to-ingress-hosts"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#5-pod-ip-to-ingress-hosts">5. Pod IP to Ingress Hosts</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Ingress Hosts ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">#</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>NAME<span class="w">                        </span>HOSTS<span class="w">                                                   </span>ADDRESS<span class="w">       </span>PORTS<span class="w">   </span>AGE
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>name-virtual-host-ingress<span class="w">   </span>tutum.training.boxboat.io,jwilder.training.boxboat.io<span class="w">   </span><span class="m">172</span>.17.0.58<span class="w">   </span><span class="m">80</span><span class="w">      </span>9m24s
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>path-ingress<span class="w">                </span>training.boxboat.io<span class="w">                                     </span><span class="m">172</span>.17.0.58<span class="w">   </span><span class="m">80</span><span class="w">      </span>9m2s
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="c1">#</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="c1"># Ping</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="c1">#</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.17.0.58
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>PING<span class="w"> </span><span class="m">172</span>.17.0.58<span class="w"> </span><span class="o">(</span><span class="m">172</span>.17.0.58<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.17.0.58:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">63</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.706<span class="w"> </span>ms
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># Curl</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="c1"># curl &lt;HOSTS&gt;:&lt;PORTS&gt;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>training.boxboat.io:80
</code></pre></div>
<h3 id="pod-to-ingress-vs-pod-to-loadbalancer"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod-to-ingress-vs-pod-to-loadbalancer">Pod to Ingress v.s. Pod to LoadBalancer</a></h3>
<p>å¦‚æœä½ æœ‰ä»”ç´°çœ‹ï¼Œæœƒç™¼ç¾ Kubernetes LoadBalacner è·Ÿ Kubernetes Ingress é™¤éŒ¯èµ·ä¾†å¥—è·¯å¾ˆåƒï¼Œç†ç”±æ˜¯ä»–å€‘éƒ½æ˜¯å¯¦éš›ä¸Šæ¥æ”¶åˆ° User Traffic æœ€å‰ç·šçš„æœå‹™ï¼Œè‡³æ–¼æƒ³è¦äº†è§£å…©è€…ç¶²è·¯æµé‡å·®ç•°å¯åƒè€ƒ <a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0">Kubernetes NodePort vs LoadBalancer vs Ingress? When should I use what?</a>ï¼ŒåŠ <a href="https://www.hwchiu.com/ingress-1.html">Hwchiu - Introduction to Kubernetes Ingress (Nginx)</a></p>
<blockquote>
<p>Kubernetes LoadBalacner æ˜¯ Kubernetes Service å…¶ä¸­ä¸€ç¨®é¡å‹ï¼Œå¤–é¢å¿…ç„¶æœƒæœ‰ä¸€å€‹ç¨ç«‹æ–¼ Kubernetes å®¹å™¨å¹³å°å¤–éƒ¨çš„ External LB å­˜åœ¨
Kubernetes Ingress ä¸¦ä¸æ˜¯ Kubernetes Serviceï¼Œå®ƒå—åˆ°ç‰¹å®š Ingress Controller ç®¡ç†ï¼Œå»ºç«‹æ–¼ Kubernetes å®¹å™¨å¹³å°å…§éƒ¨</p>
</blockquote>
<p>å¦‚æœä½ æ²’æœ‰ä»€éº¼ç‰¹å®š LB å¯ä»¥æä¾› Kubernetes Service å‘¼å«ä½¿ç”¨çš„è©±ï¼Œé‚£åŸºæœ¬ä¸Šä½ å¤§å¤šæ•¸éƒ½æ˜¯ç”¨ Kubernetes Ingress ä½œç‚ºä¸»è¦ä½¿ç”¨ï¼Œä½†å…©è€…ä¹Ÿå¯ä»¥ä¸¦ç”¨å°±æ˜¯äº†ï¼Œç›¡å¯èƒ½ä¸åœ¨åŒä¸€å€‹ç¯€é»ä¸Šå³å¯ï¼Œå› ç‚º hostNetwork æœ‰è »é«˜æ©Ÿæœƒæœƒè¡ Portï¼Œå¦‚ 80/443 ç­‰</p>
<h3 id="_2"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#_2">å¸¸è¦‹å•é¡Œ</a></h3>
<h4 id="q1-deploymentyml-kubernetes-api"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#q1-deploymentyml-kubernetes-api">Q1: deployment.yml è£¡çš„ Kubernetes API æ”¹ç‰ˆäº†ï¼Œè©²æ€éº¼ç„¡ç¸«åœ°ä¿®æ­£</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment.yml
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>error:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>recognize<span class="w"> </span><span class="s2">&quot;deployment.yml&quot;</span>:<span class="w"> </span>no<span class="w"> </span>matches<span class="w"> </span><span class="k">for</span><span class="w"> </span>kind<span class="w"> </span><span class="s2">&quot;Deployment&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>version<span class="w"> </span><span class="s2">&quot;extensions/v1beta1&quot;</span>
</code></pre></div>
<p>A1: 1. æ‰¾åˆ°æ­£ç¢ºçš„ API åå­—
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>api-resources<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>deployments
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>deployments<span class="w">                       </span>deploy<span class="w">       </span>apps/v1<span class="w">                                              </span><span class="nb">true</span><span class="w">         </span>Deployment
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>machinedeployments<span class="w">                </span>md<span class="w">           </span>cluster.x-k8s.io/v1alpha3<span class="w">                            </span><span class="nb">true</span><span class="w">         </span>MachineDeployment
</code></pre></div>
2. ä¿®æ­£ deployment.yaml å…§çš„æª”æ¡ˆï¼Œå¾ <code>apiVersion: extensions/v1beta1</code> åˆ° <code>apiVersion: apps/v1</code>ï¼Œé‡æ–°åŸ·è¡Œ
3. æ²’æ„å¤–æ‡‰è©²é‚„æœƒæœ‰éŒ¯èª¤ï¼Œå†æ ¹æ“šéŒ¯èª¤è¨Šæ¯ï¼Œé€²è¡Œæ¬„ä½çš„å¢åˆªä¿®</p>
<h4 id="q2-kubernetes-platform-administrator"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#q2-kubernetes-platform-administrator">Q2: å¦‚æœä½ æ˜¯ Kubernetes Platform Administrator æƒ³è¦å°ç‰¹å®šç¯€é»ä¹‹ä½œæ¥­ç³»çµ±é™¤éŒ¯é‚£è©²æ€éº¼è¾¦?</a></h4>
<p>A2: ä½ˆç½²çš„æ™‚å€™ï¼Œå¤šä¸€å€‹ <code>"hostNetwork": true</code> åƒæ•¸å³å¯</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--overrides<span class="o">=</span><span class="s1">&#39;{ &quot;apiVersion&quot;: &quot;v1&quot;, &quot;spec&quot;: {&quot;kubernetes.io/hostname&quot;:&quot;tkgm14-md-0-66f85bf86b-wfjt7&quot;, &quot;hostNetwork&quot;: true}}&#39;</span><span class="w"> </span>--image<span class="w"> </span>nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>eth0
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="m">2</span>:<span class="w"> </span>eth0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>mq<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span>link/ether<span class="w"> </span><span class="m">00</span>:50:56:9e:85:bb<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">172</span>.18.30.39/24<span class="w"> </span>brd<span class="w"> </span><span class="m">172</span>.18.30.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>dynamic<span class="w"> </span>eth0
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">       </span>valid_lft<span class="w"> </span>1059832sec<span class="w"> </span>preferred_lft<span class="w"> </span>1059832sec
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::250:56ff:fe9e:85bb/64<span class="w"> </span>scope<span class="w"> </span>link
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</code></pre></div>
    <nav class="md-post__action">
      <a href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-12 00:00:00">November 12, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-app"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></h2>
<p>ä»Šå¹´ 2021 å°å¼Ÿä¸ŠåŠå¹´éåº¦å¿™ç¢Œï¼ŒåŠ ä¸Šæ›çƒéšŠæ‰“çƒï¼Œå†åŠ ä¸Šæœ‰é»é‡åˆ°ä¸­å¹´å±æ©Ÿï¼Œå°è‡´ç™¼å»¢æ–‡é‡å¤§å¹…ä¸‹é™ï¼Œè«‹å¤§å®¶å¤šå¤šæ“”å¾…</p>
<blockquote>
<p>åœ°ä¸Šçˆ¬çš„æˆ‘ï¼šç®— Kubernetes Sizing å¥½ç´¯ï¼Œæˆ‘éƒ½ä»¥ç‚ºæˆ‘æ”¹è¡Œæˆç‚º Excel æ¶æ§‹å¸«äº†å‘¢
å¤©ä¸Šé£›çš„å­¸é•·ï¼šé›²åŸç”Ÿæœå‹™åˆ°åº•æ˜¯è¦ Sizing ä»€éº¼ =_= ? ä¸å¤ ä¸å°±çµ¦ä»–åŠ ä¸‹å»å°±å°äº†?
åœ°ä¸Šçˆ¬çš„æˆ‘ï¼šæˆ‘å€‘æ˜¯åœ°ç«¯...Q_Q
å¤©ä¸Šé£›çš„å­¸é•·ï¼šæ©...ä½ ä¿é‡</p>
</blockquote>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#_1">ç³»åˆ—æ–‡å‰è¨€</a></h3>
<p>æ—©åœ¨æœ¬ç¯‡é–‹å§‹ï¼Œå…¶å¯¦æ—©åœ¨å…ˆå‰ <a href="https://learnk8s.io/kubernetes-instance-calculator">Learnk8s Kubernetes Instance Calculator</a> å·²ç¶“æœ‰æ¨å‡ºéä¸€å€‹è »å¥½çœ‹çš„ç¶²é è³‡æºè¨ˆç®—æ©Ÿä¾›å¤§å®¶åƒè€ƒï¼Œä½†é€™å€‹çš„å•é¡Œæ˜¯ä»–æ²’æœ‰è€ƒé‡åˆ°å¤šå€‹ Kubernetes Namespace éƒ¨ç½²çš„ç‹€æ³ï¼Œç•¢ç«Ÿä¸å¯èƒ½æ¯ä¸€å€‹ Pod çš„è³‡æºéƒ½é•·ä¸€æ¨£ã€‚å…¶æ¬¡ï¼Œåœ°ç«¯è·Ÿé›²ç«¯ä¸ä¸€æ¨£ï¼Œå‰è€…æ¡è³¼ç¡¬é«”éœ€è¦äº‹å…ˆæº–å‚™ï¼Œå¾Œè€…å‰‡å…·å‚™<code>æœ‰é™çš„ç„¡é™è³‡æº</code>å¯ä¾›ä½¿ç”¨ï¼Œæ‰€ä»¥åªè¦å‰è€…ä¸€å€‹ä¼°ä¸æº–å°±æœƒå‡ºäº‹ã€‚ä½†èº«ç‚ºä¸€å Ops äººå“¡ï¼Œæˆ‘åˆæ‡‰è©²è¦å¦‚ä½•è«‹ App äººå“¡æä¾›æ•¸å­—çµ¦ä½ ä½œç‚ºåƒè€ƒï¼Ÿ</p>
<p>æ‰€ä»¥ç‚ºäº†å»£å¤§çš„é„‰æ°‘ï¼Œæˆ‘æä¾›é ä¼°è³‡æºè³‡æºä½œæ³•ï¼Œå¤§æ¦‚å¯ä»¥è§£æ±º<code>å…«æˆå·¦å³</code>çš„ç‹€æ³ (å…¶ä»–å…©æˆç‹€æ³ï¼Œè«‹æ´½æ¥­å‹™æ‰¾æˆ‘å»å¹«å¿™ç®— XD)ã€‚æ•…ä»¥ç‚ºäº†è¦ç®¡ç†å¥½å¤šå€‹ Kubernetes å¢é›†éœ€æ±‚ä¹‹ä¸‹ï¼Œéœ€è¦åœ¨æ¯ä¸€å€‹ Kubernetes æ‰€éƒ¨ç½²çš„ç¨‹å¼è³‡æº <a href="https://gist.github.com/pichuang/eb50ee49e4cdb64549df335216cc5290">Tanzu Mission Control Extension Manager</a> çš„é€™æ”¯ç¨‹å¼ä½œç‚ºä¼°ç®—ç¯„ä¾‹</p>
<p>ä¸»è¦åˆ†ç‚ºå…©å€‹æ–¹å‘å¤¾æ“ŠæŠ“è³‡æº</p>
<ol>
<li>Top-Downï¼šä»¥ App è§’åº¦å‡ºç™¼çš„ Kubernetes Application è³‡æºä¼°ç®—</li>
<li>Bottom-Upï¼šä»¥ Ops è§’åº¦å‡ºç™¼çš„ Hardware (or Cloud Provider) è³‡æºä¼°ç®—</li>
</ol>
<h3 id="app-kubernetes-application"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#app-kubernetes-application">ä»¥ App è§’åº¦å‡ºç™¼çš„ Kubernetes Application è³‡æºä¼°ç®—</a></h3>
<p>æƒ³å•å•å¤§å®¶ä¸€å€‹ Kubernetes è¦éƒ¨ç½²ä¸€å€‹ Application æœƒéœ€è¦ä»€éº¼æ±è¥¿? æ˜¯çš„ï¼Œä½ éœ€è¦å»æè¿°ä½ çš„æ‡‰ç”¨ç¨‹å¼è³‡æºå’Œç›¸é—œè³‡è¨Šï¼Œä¸¦ä¸”éƒ¨ç½²åœ¨ç‰¹å®šçš„ Kubernetes Namespaceï¼Œå¦‚ <code>vmware-system-tmc</code>ï¼Œæ‰€ä»¥èº«ç‚ºä¸€å€‹ App äººå“¡çš„ç›®æ¨™å°±æ˜¯æŠŠ <code>åŸºæ–¼ namespace ç‚ºä¸»çš„å…§éƒ¨æ‰€éœ€è³‡æºæ¢åˆ—å‡ºä¾†</code>ï¼Œæ“·å– <a href="https://gist.github.com/pichuang/eb50ee49e4cdb64549df335216cc5290#file-sample-tmc-deployment-yaml-L880-L957">Tanzu Mission Control Extension Manager L880-L957</a> å…§å®¹ï¼Œå¦‚ä¸‹</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nt">tmc.cloud.vmware.com/orphan-resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="nt">tmc-extension-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="nt">tmc.cloud.vmware.com/managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;vmware-system-tmc&#39;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">      </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">      </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">      </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100%</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">        </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">        </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">        </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="nt">tmc-extension-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/os</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beta.kubernetes.io/os</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/manager</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;extensions.vmware-cloud.tmc.cloud.vmware.com/extensions/extension-manager/extension-manager@sha256:&#39;</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9876</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webhook-server</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256Mi</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128Mi</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="w">          </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="w">          </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</code></pre></div>
<p>å°æ–¼ Kubernetes Application è³‡æºä¼°ç®—ä½ æ‡‰è©²è¦é—œå¿ƒä»¥ä¸‹å¹¾å€‹é»</p>
<ol>
<li>kind çš„é¡å‹ï¼šä¸»è¦å…ˆä»¥å¯æ¶µè“‹å¤§éƒ¨åˆ†éƒ¨ç½²å ´æ™¯ç‚ºä¸»ï¼Œå¸¸è¦‹æœ‰ 3 å¤§ Kindï¼ŒDeploymentã€StatefulSetã€DaemonSetï¼Œå¦‚æœ¬ç¯„ä¾‹ç‚ºä¾‹ <code>kind: Deployment</code></li>
<li>spec.replicas çš„æ•¸å­—ï¼šä¸»è¦æ˜¯è¦ç¢ºèªå¾…æœƒä¸‹é¢çš„ CPU / Memory æ˜¯è¦ä¹˜ä¸Šå¤šå°‘ï¼Œå¸¸è¦‹æ‡‰è©²éƒ½æ˜¯ä»¥ <code>1</code> ç‚ºä¸»ï¼Œè‡³æ–¼ç‚ºä»€éº¼å¯åƒé–±æˆ‘æ–¼ <a href="https://speakerdeck.com/pichuang/20210812-ru-he-cai-yong-yun-yuan-sheng-zuo-fa-velero-bei-fen-huan-yuan-ni-de-kubernetes-cong-ji?slide=8">ä¹‹å‰åœ¨ Microsoft DevDays 2021 æ¼”è¬›çš„å…§å®¹</a>ï¼Œå¦‚æœå¾®æœå‹™èƒ½å¤  Scale-Out çš„è©±ï¼Œå°±æ˜¯ <code>2</code> æˆ–ä»¥ä¸Šçš„æ•¸å­—</li>
<li>æ¯ä¸€å€‹ Pod æ‰€éœ€è¦çš„ CPU å’Œ Memory è³‡æºï¼šä¸»è¦æ˜¯ç¢ºå®šä¸€å€‹ Container æ‰€éœ€è¦çš„ CPU åŠ Memory çš„ä¸Šä¸‹é™ï¼Œè¦ç•™æ„ <code>1 å€‹ Pod è£¡é¢æœƒæœ‰ 1 å€‹æˆ–å¤šå€‹ Containers</code>ï¼Œå¯è©³é–±<a href="https://speakerdeck.com/pichuang/how-do-i-troubleshooting-on-container-more-than-docker?slide=17">ä¹‹å‰åœ¨ HKOSCon 2020 æ¼”è¬›å…§å®¹</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>        resources:
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>          limits:
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>            cpu: 100m
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>            memory: 256Mi
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>          requests:
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>            cpu: 100m
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>            memory: 128Mi
</code></pre></div></li>
<li>Storage çš„é¸å‹ï¼šä¸»è¦æ˜¯è¦ç¢ºå®šæ˜¯è¦é€é hostPath è‚šå­çš„ç¡¬ç¢Ÿé‚„æ˜¯ä½¿ç”¨ PV/PVC æ¡ç”¨åŸºæ–¼ CSI ä»‹é¢çš„å¤–æ›å„²å­˜æœå‹™ï¼Œå¸¸ç”¨å”å®šå¦‚ NFSã€iSCSI åŠ FC ç­‰ï¼Œé€™å€‹ä¸»è¦éƒ½æ˜¯ä»¥æœå‹™å°æ–¼ IOPS æˆ–å…¶ç‰¹æ€§çš„è€ƒé‡ç‚ºæ¡ç”¨æ¨™çš„ï¼Œä½†æœ¬æ–‡ä¸æ·±å…¥æ¢ç©¶</li>
</ol>
<p>æ‰€ä»¥æŠŠä¸Šé¢çš„è³‡è¨Šæ”¶é›†èµ·ä¾†ï¼Œæœƒå¾—åˆ°ä¸‹é¢é€™å¼µè¡¨</p>
<p><img alt="" src="/images/tmc-res.png" /></p>
<p>ä½†å¯¦éš›ä¸Šä½ å¡«å®Œï¼Œæœƒæ³¨æ„åˆ°ä¸€äº›äº‹æƒ…</p>
<ol>
<li>é€™æ¨£ç¸½è³‡æºæ˜¯å°çš„å—?</li>
<li>æœ‰äº›æ¬„ä½æ²’å¡«çš„æ€éº¼è¾¦?</li>
</ol>
<p>å›æ‡‰ç¬¬ä¸€é¡Œï¼Œä¸€å®šä¸å°ï¼Œå› ç‚ºä½ çœ‹ <code>Replicas</code> æœ‰äº›æ˜¯ 2ï¼Œæ‰€ä»¥å¯¦éš›ä¸Šä½ æ‡‰è©²è¦æŠŠå·¦é‚Šçš„è³‡æºå…¨éƒ¨ä¹˜ä¸Š <code>Replicas</code> æ•¸å­—ï¼Œèº«ç‚ºä¸€å€‹ App åœ˜éšŠä½ æ‡‰è©²æœƒå¾—åˆ°ä¸‹é¢é€™å¼µè¡¨</p>
<p><img alt="" src="/images/tmc-res-1.png" /></p>
<p>é€™æ™‚å€™ä½ æŠŠå…¨éƒ¨çš„è³‡è¨Šæ’ˆå‡ºä¾†ï¼Œå¯ä»¥ç²å¾—åˆ° <code>å¤§ç´„</code>é€™æ”¯æ•´å€‹ç¨‹å¼å†æ€éº¼è·‘ï¼Œé ‚å¤š <code>vmware-system-tmc</code> é€™å€‹ namesapceï¼Œå°±æ˜¯åƒæ‰ <code>4700m</code> CPU è·Ÿ <code>6382M</code> Memoryï¼Œè‡³æ–¼å°æ–¼ Kubernetes è¨ˆç®—å–®ä½ä¸ç†Ÿçš„å¯ä»¥åƒè€ƒ <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Kubernetes Managing Resources for Containers</a>ï¼Œå¦é™„ä¸Š <a href="https://docs.google.com/spreadsheets/d/1zQswfXuZhpKjsmmFvCHiGt19Ej6s6hpr5yiB1wnPR70/edit?usp=sharing">Google Sheet åƒè€ƒæ–‡ä»¶</a></p>
<p>å›æ‡‰ç¬¬äºŒé¡Œï¼Œå‘ˆä¸Šï¼Œå¦‚æœä½ æ²’å¯«è³‡æºï¼Œé€™ä¸æ˜¯ä»£è¡¨ä»–é‹ä½œä¸ç”¨è³‡æºï¼Œæ˜¯ä»£è¡¨é€™ä»½ Yaml æ²’æœ‰å®šç¾© limits / requests å…©å€‹æ•¸å­—å»é™åˆ¶ä»–çš„è³‡æºä½¿ç”¨ï¼Œè€Œæ˜¯æœƒç”¨ BestEffort çš„æ–¹å¼é‹è¡Œã€‚åœ¨é€™å€‹ç‹€æ³ä¸‹ï¼Œå¦‚æœçœŸçš„å¯«ä¸å‡ºä¾†ï¼ŒçœŸçš„æ˜¯åªèƒ½æ†‘ç¶“é©—å…ˆä¼°ä¸€å€‹æ•¸å­—çµ¦ requests ç¢ºä¿ä¸æœƒçˆ†ç‚¸ï¼Œå†ä¾†ç”¨ Metrics æœå‹™ï¼Œå¦‚è‡ªå»º Prometheusã€æˆ– SaaS æœå‹™ Tanzu Observability é•·æœŸè§€æ¸¬èª¿æ•´æ•¸å­—ç‚ºæ¯”è¼ƒå‹™å¯¦çš„ä½œæ³•ã€‚å€˜è‹¥ä½ å¦‚æœé¸ç”¨çš„ç¨‹å¼æ˜¯ Java JVM æˆ–è€…æ˜¯è‡ªå¸¶ç¨‹å¼èªè¨€è™›æ“¬æ©Ÿï¼Œæœƒç›¸ç•¶å¥½ä¼°ç®—ï¼Œä½†æœ¬æ–‡ä¸æ·±å…¥æ¢ç©¶</p>
<p>é‚£é¡å¤–å•é¡Œä¾†äº†ï¼Œå¦‚æœæˆ‘åœ¨è³‡æºè£¡é¢å¡« 0 çš„è©±æœƒæ€æ¨£?</p>
<h3 id="0"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#0">é—œæ–¼ 0 çš„é‚£äº›äº‹</a></h3>
<blockquote>
<p>å…ˆè¬›çµè«–ï¼Œå»ºè­°é‚„æ˜¯è¦è¨­å®š limits è·Ÿ requests çš„å€¼ä¸Šå»ï¼Œæœ€å°‘ä¹Ÿè¦æœ‰ limits</p>
</blockquote>
<p>ç•¶è³‡æºçœŸå¿ƒä¸è¶³çš„æ™‚å€™ï¼Œå‰‡ Kubernetes å‰‡æœ‰å…§å»ºæ”¯æ´ QoS æœå‹™ç®¡ç†èƒ½åŠ›ï¼Œä¸”æ”¯æ´ä½œæ¥­ç³»çµ±ç­‰ç´šçš„ OOM æ§åˆ¶ï¼Œæœ€å°è¨ˆç®—å–®ä½ç‚º Podã€‚<code>ä¸€èˆ¬ä¾†èªªï¼Œä¼°ç®—è¨ˆç®—è³‡æº limits æ¯”è¼ƒé‡è¦ï¼Œå¯¦éš›ä¸Šé‹è¡Œèª¿åº¦å‰‡æ˜¯ requests æ¯”è¼ƒé‡è¦</code></p>
<p>Kubernetes æœƒé–‹å§‹ä¾æ“š QoS ä¸‰ç¨®ç­‰ç´šï¼ˆç”±æœ€é«˜åˆ°æœ€ä½å„ªå…ˆæ¬Šæ’åºï¼‰ï¼šGuranted &gt; Bursatable &gt; BestEffort é€²è¡Œæ¬Šé‡æ’åºï¼Œé€šå¸¸æœƒç™¼ç”Ÿ OOM (Out-of-Memory) ä¹Ÿéƒ½æ˜¯å› ç‚ºæ’åˆ°è³‡æºä¸è¶³ï¼Œç„¶å¾Œå„ªå…ˆæ¬Šé‡åˆä½ï¼Œå°±è¢«å¹¹æ‰äº†ï¼Œå¸¸è¦‹å¦‚ AI/ML å®¹å™¨ç­‰æœƒåƒè³‡æºçš„å®¹å™¨æœå‹™ï¼Œç¢ºåˆ‡çš„è©³ç´°å…§å®¹è«‹åƒé–± <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/">Kubernetes - é…ç½® Pod çš„æœåŠ¡è´¨é‡</a></p>
<table>
<thead>
<tr>
<th style="text-align: center;">å„ªå…ˆæ¬Š</th>
<th style="text-align: center;">QoS é¡å‹</th>
<th style="text-align: center;">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1 (highest)</td>
<td style="text-align: center;">Guaranted</td>
<td style="text-align: center;">Pod è£¡é¢çš„æ¯ä¸€å€‹ Container éƒ½è¦è¨­å®š requests ç­‰æ–¼ limits (å…©å€‹å€¼çš†æœ‰è¨­å®šï¼Œä¸”ä¸ç­‰æ–¼ 0)</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Burstable</td>
<td style="text-align: center;">Pod è£¡é¢çš„ä»»ä¸€å€‹ Container å…·æœ‰ requests ä¸ç­‰æ–¼ limits æ•¸å€¼ï¼Œä¸”ä¸ç¬¦åˆ Guaranted æ¢ä»¶</td>
</tr>
<tr>
<td style="text-align: center;">3 (lowest)</td>
<td style="text-align: center;">BestEffort</td>
<td style="text-align: center;">æ²’æœ‰è¨­å®šä»»ä½•è³‡æºè«‹æ±‚å’Œé™åˆ¶</td>
</tr>
</tbody>
</table>
<p>ç•¶ç„¶ä½ çœ‹å®Œä¸Šé¢æ‡‰è©²æœƒéœ§å‚»å‚»ï¼Œæ‰€ä»¥èº«ç‚º Excel ç²¾ç®—å¸«çš„æˆ‘å¹«å¤§å®¶æ•´ç†äº†ä»¥ä¸‹åˆ—èˆ‰äº†å·²çŸ¥çµ„åˆï¼Œä¾›å¤§å®¶åƒè€ƒ</p>
<p><img alt="" src="/images/tmc-res-4.png" /></p>
<p>ä½ çœ‹å®Œä¸Šé¢çš„åœ–æ‡‰è©²æœƒçŸ¥é“ä¸€å€‹äº‹å¯¦ï¼Œ<code>0</code> åœ¨ Kubernetes ä¾†èªªæ˜¯æœ‰æ„ç¾©çš„ï¼Œæ‰€ä»¥è³‡æºä¼°ç®—è«‹ä¸è¦äº‚å¯«ï¼Œä»–ä¸ä»£è¡¨ç„¡é™å¤§è³‡æºçš„æ„æ€...å¦‚æœçœŸçš„ä¸çŸ¥é“è«‹ç•™ç©ºï¼Œè€Œä¸æ˜¯å¯« 0</p>
<h3 id="app"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#app">ä»¥ App è§’åº¦å‡ºç™¼çš„å¸¸è¦‹è³‡æºéŒ¯ä¼°èª¤å€</a></h3>
<p>ä½ æ˜¯ä¸æ˜¯è¦ºå¾—åˆ°é€™é‚Šå°±å¯ä»¥ä¼°ç®—çµæŸäº†ï¼Ÿ<code>å¾ˆæŠ±æ­‰æ²’æœ‰</code>ï¼Œä½ é‚„å°‘ç®—é‹è¡Œ Kubernetes æ‰€éœ€è¦çš„æœå‹™ï¼Œå¦‚ kubeletã€CNIã€kube-proxyã€OS æœ¬èº«æœå‹™ç­‰ç­‰é€™äº›ä¸å­˜åœ¨æ–¼ kubernetes çš„è³‡æºæ¸…å–®ä¸Šï¼Œä½†å¯¦éš›ä¸Šæ˜¯éœ€è¦é€™äº›æœå‹™æ‰èƒ½å¤ å¥½å¥½çš„é‹è¡Œ Kubernetes æœå‹™ï¼Œé‚£é€™æ˜¯ä»€éº¼æ„æ€å‘¢?</p>
<p>æ‹¿æˆ¿å­æ¬Šç‹€æ¯”å–»ï¼Œä»¥ä¸Šæ‰€åšçš„äº‹æƒ…éƒ½æ˜¯åœ¨ç®—å®¤å…§é¢ç©ï¼ˆå®¢å»³ã€æµ´å®¤ã€é™½å°ï¼‰ï¼Œå¯¦éš›ä¸Šä½ é‚„æœ‰å…¬è¨­ï¼ˆæ¨“æ¢¯ã€é›»æ¢¯ã€å¥èº«æˆ¿ï¼‰è¦ç®—å•Šï¼æ‰€ä»¥æœ€çµ‚ä¼°ç®— 1 å€‹ Kubernetes æ‰€éœ€è³‡æºçš„çµæœï¼Œä¸€å®šæœƒæ¯” App æ‰€å¯«çš„é‚„è¦ä¾†å¾—å¤§ä¸Šä¸€é»</p>
<p><img alt="" src="https://learnk8s.io/a/5505f01f0ed678a7ac42642b4dfd7b1c.svg" /></p>
<p>è€Œå„å¤§å» å•†ç‚ºäº†è¦é™ä½å…¬è¨­æ¯”ï¼Œç´›ç´›éƒ½æ¨å‡ºäº† Container OS é€²è¡Œè³‡æºå’Œæ•ˆèƒ½ä¸Šçš„æœ€ä½³åŒ–ï¼Œç•¢ç«Ÿèª°å¸Œæœ›æ‹¿åˆ° 1 å€‹ 4c/8g çš„ worker ç¯€é»ï¼ŒæŠŠä¸€å †è·Ÿ kubernetes æ²’é—œä¿‚çš„æœå‹™é–‹èµ·ä¾†å°±å‰©ä¸åˆ°ä¸€åŠè³‡æºå¯ä»¥ç”¨ï¼Œä½†å› ç‚ºå„å®¶å‡º Container OS ç³»çµ±éƒ½ä¸ç›¡ç›¸åŒï¼Œæ‰€ä»¥æœƒå¾ˆä»°è³´å„è‡ªå» å•†å·¥ç¨‹å¸«çš„ç²¾ç®—</p>
<h3 id="_2"><a class="toclink" href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#_2">çµèª</a></h3>
<p>çœ‹å®Œä»¥ä¸Šçš„æ–‡ç« ï¼Œç›¸ä¿¡å¤§å®¶ä¸€å®šæœƒè¦ºå¾—ç‚ºå•¥æˆ‘è¦å€‹ Kubernetes ç‚ºå•¥è¦æå¾—é€™éº¼è¤‡é›œï¼Œæ‰€ä»¥ä¸‹ç¯‡æœƒè¬›ï¼Œ<code>ä»¥ Ops è§’åº¦å‡ºç™¼çš„ Hardware (or Cloud Provider) è³‡æºä¼°ç®—</code>ï¼Œå°±æ˜¯å¯«ä¸å‡ºä¾†çš„ç‹€æ³ä¸‹èº«ç‚º Ops åˆ°åº•è©²æ€éº¼è¾¦ï¼Ÿ</p>
<p>å¸Œæœ›ä»Šå¹´èƒ½å¯«å¾—å‡ºä¾†...å¸Œæœ›...</p>
<p>ç‰¹åˆ¥æ„Ÿè¬ Gene Kuo å’Œ Hwchiu å¹«å¿™æ ¡ç¨¿ XD</p>
    <nav class="md-post__action">
      <a href="../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>