
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/page/2/">
      
      
      
        <link rel="next" href="../../author/url/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>Index - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel ğŸ¥ </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Index
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="index">Index</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-06 00:00:00">March 6, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/networking/" class="md-meta__link">networking</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="testinfra"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/">é‹ç”¨ Testinfra ä¾†ç¢ºä¿ç¶²è·¯é€£é€šæ€§æ¸¬è©¦</a></h2>
<p><img alt="Testinfra test your infrastructure" src="https://testinfra.readthedocs.io/en/latest/_static/logo.svg" /></p>
<p>èµ·æºæ˜¯å› ç‚ºåš Azure ç¶²è·¯æ¶æ§‹è¨­è¨ˆï¼Œç¶²è·¯ç·šæ‹‰å®Œ (ExpressRouteã€S2S VPNã€VNet Peering ç­‰) ä¹‹å¾Œï¼Œä¸‹ä¸€å€‹éœ€æ±‚å¤šåŠéƒ½æ˜¯è¦æŠŠ Firewall é–‹èµ·ä¾†ï¼Œå¸Œæœ›æ‰€æœ‰çš„é€£ç·šéƒ½è¦ç¶“é Azure Firewall ç¢ºä¿é€£ç·šå®‰å…¨æ€§ï¼Œä½†åŸºæ–¼ Azure Networking æœ¬èº«çš„ç‰¹æ€§å’Œä½¿ç”¨è€…çš„å°æ–¼ç¶²è·¯é€£é€š (Network Connectivity) çš„éœ€æ±‚ï¼Œèº«ç‚ºä¸€åè¨˜æ†¶åŠ›ä¸ç®—ç‰¹å¥½çš„æ¶æ§‹å¸«ï¼Œç‚ºäº†ç¢ºä¿ä½¿ç”¨è€…è¬›çš„è·Ÿå¯¦éš›ä¸Šé‹ä½œçš„çµæœæ˜¯ä¸€æ¨£çš„ï¼Œé€™æ™‚å€™å°±è¦æŠŠæ—©å¹´åœ¨ Edgecore Network æ™‚æœŸè¬›éçš„ <a href="https://speakerdeck.com/pichuang/netdevops-next-generation-network-engineer?slide=27">NetDevOps: Next-Generation Network Engineer</a> æ‹¿ä¾†ç”¨ç”¨äº†</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#_1">ä½ æ‡‰è©²è¦çŸ¥é“çš„å°çŸ¥è­˜</a></h3>
<h4 id="testinfra_1"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#testinfra_1">Testinfra</a></h4>
<p>Testinfra æ˜¯çŸ¥å Python æ¸¬è©¦é–‹ç™¼æ¡†æ¶ pytest è¡ç”Ÿçš„ä¸€å€‹æ¸¬è©¦å¼•æ“ï¼Œä¸»è¦å°æ¨™çš„åŠŸèƒ½æ˜¯å¦ä¸€å€‹ä»¥ Ruby ç‚ºåŸºç¤çš„ <a href="https://serverspec.org/">Serverspec</a>ï¼Œä½†ä¸»è¦ä¹Ÿä¸æ˜¯è¦ä½ æœƒå¯«ç¨‹å¼èªè¨€æ‰èƒ½ç”¨ï¼Œåæ­£ç”¨é †æ‰‹çš„å°±å¥½ï¼Œé‚è¼¯ä¸Šéƒ½å·®ä¸å¤š</p>
<p>é›–èªª Testinfra é è¨­æ˜¯ä½¿ç”¨ pytest ä½œç‚ºåŸºç¤ï¼Œä½†ä¹Ÿå¯ä»¥è·Ÿå¦ä¸€å€‹å¾ˆå¸¸è¦‹çš„ Python æ¸¬è©¦æ¡†æ¶ <a href="https://testinfra.readthedocs.io/en/latest/examples.html#using-unittest">unittest èå’Œåœ¨ä¸€èµ·</a>ï¼Œæˆ‘æ˜¯ä»¥é€™å€‹å¯«æ³•ç‚ºä¸»ï¼Œå¦‚æœä½ è¦ºå¾—ä¸å¤ªé †çœ¼å¯ä»¥çœ‹å®˜æ–¹çš„ examples è‡ªå·±ä¿®æ”¹ï¼Œé™„ä¸Šæœ¬æ–‡æœƒä½¿ç”¨åˆ°çš„ Code Snippet <a href="https://github.com/pichuang/testinfra-code-snippet/blob/main/testinfra-snippet.py">pichuang/testinfra-code-snippet</a></p>
<p>å€‹äººå¸¸ç”¨åˆ°çš„ 4 å€‹æ–·è¨€ (Assertion) æœ‰ä»¥ä¸‹å¹¾ç¨®ï¼Œä½†ä¸é™æ–¼ï¼Œå¯åƒè€ƒ<a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.debug">unittest - assert methods</a>:</p>
<table>
<thead>
<tr>
<th>Assert Methods</th>
<th>è¡¨é”å¼</th>
<th>è§£é‡‹</th>
<th>ç™½è©±æ–‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>assertEqual(a, b)</td>
<td>a == b</td>
<td>å¯ä»¥æ‹¿ä¾†æª¢æŸ¥ HTTP Status Code ç‚º 200</td>
<td>é€™å€‹ç¶²é å¾ˆæ­£å¸¸</td>
</tr>
<tr>
<td>assertNotEqual(a, b)</td>
<td>a != b</td>
<td>å¯ä»¥æ‹¿ä¾†æª¢æŸ¥ HTTP Status Code ä¸ç‚º 200</td>
<td>é€™å€‹ç¶²é ä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„</td>
</tr>
<tr>
<td>assertTrue(x)</td>
<td>bool(x) is True</td>
<td>å¯ä»¥æª¢æŸ¥ Boolen</td>
<td>é€™å€‹æœå‹™æˆ‘è¦é€£å¾—åˆ°</td>
</tr>
<tr>
<td>assertFalse(x)</td>
<td>bool(x) is False</td>
<td>å¯ä»¥æª¢æŸ¥ Boolen</td>
<td>é€™å€‹æœå‹™æˆ‘ä¸æ‡‰è©²é€£çš„åˆ°</td>
</tr>
</tbody>
</table>
<p>å¯¦éš›ä¸ŠåŸ·è¡Œæ–¹å¼è¦è¨˜å¾—åŠ  <code>-v</code> æ‰èƒ½çœ‹åˆ°ç™¾åˆ†æ¯”</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>pytest<span class="w"> </span>-v<span class="w"> </span>test*.py
</code></pre></div>
<p><img alt="All Pass" src="/images/allpass.gif" /></p>
<p>æ­¤å¤– testinfra é‚„æ”¯æ´å¤šç¨® connection backendï¼ŒåŒ…å«: kubectlã€openshiftã€sshã€ansibleã€dockerã€podman ç­‰ï¼Œå’Œå¤šç¨® Modules å¯ä»¥æª¢æŸ¥ï¼ŒåŒ…å«: fileã€groupã€hostã€packageã€processã€serviceã€user ç­‰ï¼Œå¯ä»¥åƒè€ƒ<a href="https://testinfra.readthedocs.io/en/latest/modules.html">å®˜æ–¹æ–‡ä»¶</a>ï¼Œæœ‰éœ€æ±‚çš„å¯ä»¥è‡ªè¡Œè©¦è©¦</p>
<h4 id="azure-firewall"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#azure-firewall">Azure Firewall</a></h4>
<p>Azure Firewall æ˜¯ Azure æä¾›çš„ PaaS æ‰€æä¾›çš„ä¼æ¥­ç´š Firewall èƒ½åŠ›ï¼Œå¯ä»¥é€é Azure Resource Manager å°‡æœå‹™å¸¶èµ·ä¾†ï¼Œæ‡‰å°ä¸åŒçš„ SKU å¯ä»¥æä¾›ä¸åŒå±¤ç´šçš„ä¿è­·èƒ½åŠ›ï¼Œéœ€è¦ Azure Firewall Policy æ‰èƒ½æ­£å¸¸ä½œå‹•ï¼Œæ²’è¨­å®šåŠæ¢ Policy çš„ç‹€æ³ä¸‹æ˜¯é è¨­ <code>DenyAll</code></p>
<p>å¦‚æœè¦åœ¨ Azure Firewall çœ‹åˆ°å…·é«”çš„ Log ç‹€æ…‹ï¼Œä½ éœ€è¦å¦å¤–è¨­å®š Log Analytics Workspaceï¼Œä¸¦ä¸”åœ¨ Diagnostic Setting è¨­å®šå¥½ Log Analytics Workspaceï¼Œæ‰èƒ½åœ¨ Azure Firewall çœ‹åˆ° Log</p>
<p><img alt="" src="/images/firewall-vaildation.png" /></p>
<h4 id="azure-firewall-policy"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#azure-firewall-policy">Azure Firewall Policy</a></h4>
<p>Azure Firewall å¯¦éš›ä¸Šéœ€è¦æ­é… Azure Firewall Policy é‡å°ä»¥ä¸‹ Rule Types é€²è¡Œè¨­å®š:</p>
<table>
<thead>
<tr>
<th>Rule Types</th>
<th>Default Priority</th>
<th>Protocols</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>DNAT</td>
<td>100</td>
<td>TCP, UDP</td>
<td>å¯ä»¥é€é DNAT å°‡ Inbound Traffic è½‰æ› Azure å…§éƒ¨çš„ Private IP</td>
</tr>
<tr>
<td>Network</td>
<td>200</td>
<td>Any, TCP, UDP, ICMP</td>
<td>å¯ä»¥åŸºæ–¼ L3/L4 IP, Port, Protocols é€²è¡Œæµé‡ç¯©é¸</td>
</tr>
<tr>
<td>Application</td>
<td>300</td>
<td>HTTP, HTTPS</td>
<td>å¯ä»¥åŸºæ–¼ FQDN, URL, HTTP, HTTPS é€²è¡Œæµé‡ç¯©é¸</td>
</tr>
</tbody>
</table>
<p>å¯¦å‹™ä¸Šè¦å‰‡æ‡‰è©²æœƒè¶Šå¯«è¶Šå¤šï¼Œç‚ºäº†ç¢ºä¿æ˜¯ä¸æ˜¯çœŸçš„æœ‰ç¬¦åˆé€™äº›è¦å‰‡ï¼Œç”Ÿå‘½æœ‰é™ï¼Œå¯ä»¥ç”¨ testinfra <code>å¾ä½¿ç”¨è€…è¦–è§’</code>ä¾†åè¦†ç¢ºä¿é€™äº›è¦å‰‡æ˜¯æ­£ç¢ºçš„</p>
<h3 id="unit-test"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#unit-test">Unit Test æ¡ˆä¾‹åˆ†æ</a></h3>
<p>å› ç‚ºæ‡¶å¾—å¾ Azure Firewall ç•«é¢æˆªåœ–ï¼Œæ•…ä»¥ <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy_rule_collection_group">Terraform azurerm_firewall_policy_rule_collection_group</a> ä¾†è¡¨ç¤º Azure Firewall Policy çš„è¦å‰‡å¯«æ³•ï¼Œå’Œå…¶å°æ‡‰çš„æ¸¬è©¦</p>
<h4 id="a-ping"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#a-ping">ä½¿ç”¨è€… A èªª: åº•ä¸‹æ‰€æœ‰æœå‹™éƒ½è¦å¯ä»¥äº’ç›¸ Ping åˆ°</a></h4>
<p>å› ç‚º Azure Firewall é è¨­æ˜¯ <code>DenyAll</code>ï¼Œæ‰€ä»¥é€™é‚Šè¦å…ˆé–‹æ”¾ ICMP çš„è¦å‰‡ï¼Œè®“æ‰€æœ‰çš„æµé‡éƒ½å¯ä»¥äº’ç›¸ Ping åˆ°</p>
<div class="copy select highlight"><span class="filename">network-icmp.tf</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_firewall_policy_rule_collection_group&quot;</span><span class="w"> </span><span class="nv">&quot;fprcg-for-transit&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="nb">network_rule_collection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;network-rule-collection-for-transit&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="hll"><span class="w">      </span><span class="na">name</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;network-rule-icmp-any-to-any&quot;</span>
</span><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="hll"><span class="w">      </span><span class="na">protocols</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ICMP&quot;</span><span class="p">]</span>
</span><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="hll"><span class="w">      </span><span class="na">source_addresses</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
</span><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="hll"><span class="w">      </span><span class="na">destination_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
</span><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="hll"><span class="w">      </span><span class="na">destination_ports</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
</span><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="p">}</span>
</code></pre></div>
<p>ä»¥ Testinfra æ’°å¯« Unittest å°±æœƒåƒä¸‹åˆ—é€™æ¨£ï¼Œå…¶ä¸­ <code>testinfra.get_host("local://")</code> æ˜¯è¡¨ç¤ºåœ¨æœ¬æ©ŸåŸ·è¡Œæ¸¬è©¦ï¼Œ<code>self.host.addr("10.73.30.164").is_reachable</code> ç­‰åƒ¹æ–¼ <code>ping -W 1 -c 10.73.30.164</code></p>
<div class="copy select highlight"><span class="filename">testinfra-icmp.py</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span> <span class="nc">TestNetworkRules</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">testinfra</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="s2">&quot;local://&quot;</span><span class="p">)</span>
</span><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="k">def</span> <span class="nf">test_to_hub_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;10.73.30.164&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span>
</span><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="k">def</span> <span class="nf">test_to_spoke1_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;10.73.31.4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span>
</span><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="k">def</span> <span class="nf">test_to_spoke2_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;10.73.33.4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="b-google-dns-8888-dns"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#b-google-dns-8888-dns">ä½¿ç”¨è€… B èªª: æˆ‘è¦èƒ½é€£åˆ° Google DNS 8.8.8.8 é€²è¡Œ DNS è§£æ</a></h4>
<p>é€™å€‹å°±æ˜¯ä¸€å€‹å¸¸è¦‹çš„è¦å‰‡éœ€æ±‚ï¼Œéœ€è¦èƒ½å¤ é€£åˆ°ç‰¹å®š IP çš„æŸå€‹ Port åšé»äº‹ï¼Œæ‰€ä»¥é€™é‚Šè¦æŒ‘é¸ Network Rule Collectionï¼Œé–‹æ”¾ 8.8.8.8 çš„ 53 Port</p>
<div class="copy select highlight"><span class="filename">network-dns.tf</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_firewall_policy_rule_collection_group&quot;</span><span class="w"> </span><span class="nv">&quot;fprcg-for-transit&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="nb">network_rule_collection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;network-rule-collection-for-google-dns&quot;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">201</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">      </span><span class="na">name</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;network-rule-icmp-any-to-any&quot;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="hll"><span class="w">      </span><span class="na">protocols</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;TCP&quot;, &quot;UDP&quot;</span><span class="p">]</span>
</span><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="hll"><span class="w">      </span><span class="na">source_addresses</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
</span><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="hll"><span class="w">      </span><span class="na">destination_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">]</span>
</span><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="hll"><span class="w">      </span><span class="na">destination_ports</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;53&quot;</span><span class="p">]</span>
</span><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="p">}</span>
</code></pre></div>
<p><code>google_dns.port(53).is_reachable</code> è‹¥æœ‰æŒ‡å®š Port å‰‡æœƒä½¿ç”¨ <code>nc -w 1 -z &lt;IP&gt; &lt;Port&gt;</code> ä¾†åšé©—è­‰ï¼Œè€Œä¸æ˜¯ pingã€‚é€™é‚Šä¹Ÿå¯ä»¥è§€å¯Ÿåˆ° 8.8.8.8ï¼Œå…¶å¯¦æ²’æœ‰é–‹ 80 å‡ºå‡ºä¾†ï¼Œåªæœ‰ 53 å’Œ 443 ä»¥åŠ ICMP</p>
<div class="copy select highlight"><span class="filename">testinfra-google-dns.py</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">class</span> <span class="nc">TestNetworkRules</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">testinfra</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="s2">&quot;local://&quot;</span><span class="p">)</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="k">def</span> <span class="nf">test_to_google_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="n">google_dns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">google_dns</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;ping -W 1 -c 1 8.8.8.8&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">google_dns</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z 8.8.8.8 53&quot;</span>
</span><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">google_dns</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z 8.8.8.8 80&quot;</span>
</span><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">google_dns</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">443</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z 8.8.8.8 443&quot;</span>
</span></code></pre></div>
<h4 id="c-githubcom-git-clone"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#c-githubcom-git-clone">ä½¿ç”¨è€… C èªª: æˆ‘è¦èƒ½é€£åˆ° github.com é€²è¡Œ git clone çš„æ“ä½œ</a></h4>
<p>å› ç‚ºæ˜¯é‡å°ç‰¹å®š FQDN, æ‰€ä»¥è¦ä½¿ç”¨ Application Rule Collectionï¼Œé–‹æ”¾ 443 Port</p>
<div class="copy select highlight"><span class="filename">application-github.tf</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_firewall_policy_rule_collection_group&quot;</span><span class="w"> </span><span class="nv">&quot;fprcg-for-transit&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nb">application_rule_collection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application-rule-collection-for-transit&quot;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application-rule-https-any-to-github&quot;</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="hll"><span class="w">      </span><span class="nb">protocols</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="hll"><span class="w">        </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Https&quot;</span>
</span><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="hll"><span class="w">        </span><span class="na">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">443</span>
</span><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="hll"><span class="w">      </span><span class="p">}</span>
</span><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">      </span><span class="na">source_addresses</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">      </span><span class="na">destination_fqdns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;github.com&quot;</span><span class="p">]</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span>
</code></pre></div>
<p>å› ç‚º Testinfra é‡å°ç¶²è·¯çš„éƒ¨åˆ†ï¼Œæ¯”è¼ƒé‡å° L3/L4 æœ‰è‘—å¢¨ï¼Œä½†æ²’æœ‰ç‰¹åˆ¥é‡å° L7 çš„æª¢æŸ¥ï¼Œæ•…è¦è‡ªå·±æ’ˆ <code>curl -o /dev/null -s -w %{http_code}</code> HTTP Status Code ä¾†åšæª¢æŸ¥ã€‚is_resolvable ä¸»è¦æ˜¯ç”¨ä¾†æª¢æŸ¥ DNS æ˜¯å¦æ­£å¸¸ï¼Œè‹¥æ­£å¸¸å‰‡æœƒå›å‚³ IPã€‚</p>
<div class="copy select highlight"><span class="filename">testinfra-github.py</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span> <span class="nc">TestApplicationRules</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">testinfra</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="s2">&quot;local://&quot;</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="k">def</span> <span class="nf">test_to_github</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="c1"># L3/L4 Check</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="n">github_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;github.com&quot;</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;ping -W 1 -c 1 github.com&quot;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z github.com 80&quot;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">443</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z github.com 443&quot;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">443</span><span class="p">)</span><span class="o">.</span><span class="n">is_resolvable</span><span class="p">)</span> <span class="c1"># Equal to &quot;getent ahosts github.com&quot;</span>
</span><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>        <span class="c1"># L7 Check</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="hll">        <span class="n">github_http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;curl --connect-timeout 3 -o /dev/null -s -w %</span><span class="si">{http_code}</span><span class="s2"> https://github.com&quot;</span><span class="p">)</span>
</span><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">)</span> <span class="c1"># Use HTTP Status Code to check if the website is up</span>
</code></pre></div>
<h4 id="d-azurearchiveubuntucom-apt-update-apt-upgrade"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#d-azurearchiveubuntucom-apt-update-apt-upgrade">ä½¿ç”¨è€… D èªª: æˆ‘è¦èƒ½é€£åˆ° azure.archive.ubuntu.com é€²è¡Œ apt update &amp;&amp; apt upgrade çš„æ“ä½œ</a></h4>
<p>Azure å…§æä¾›çš„ azure.archive.ubuntu.com æ˜¯çµ¦ Ubuntu ç³»åˆ—çš„ VM ä¾†é€²è¡Œ apt update &amp;&amp; apt upgrade çš„æ“ä½œï¼Œä½†åƒ…æœ‰ HTTP æ²’æœ‰ HTTPSï¼Œæ‰€ä»¥é€™é‚Šä¹Ÿè¦ä½¿ç”¨ Application Rule Collectionï¼Œé–‹æ”¾ HTTP/80</p>
<div class="copy select highlight"><span class="filename">application-ubuntu.tf</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_firewall_policy_rule_collection_group&quot;</span><span class="w"> </span><span class="nv">&quot;fprcg-for-transit&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nb">application_rule_collection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="na">name</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application-rule-collection-for-transit&quot;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="na">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">301</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="na">action</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;application-rule-https-any-to-ubuntu&quot;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="hll"><span class="w">      </span><span class="nb">protocols</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="hll"><span class="w">        </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Http&quot;</span>
</span><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="hll"><span class="w">        </span><span class="na">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
</span><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="hll"><span class="w">      </span><span class="p">}</span>
</span><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">      </span><span class="na">source_addresses</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">      </span><span class="na">destination_fqdns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;azure.archive.ubuntu.com&quot;</span><span class="p">]</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="p">}</span>
</code></pre></div>
<p>é€™é‚Šé‡å° HTTPS ä¸æ‡‰è©²å­˜åœ¨å›æ‡‰çš„ç‹€æ³é€²è¡Œæª¢æŸ¥ï¼Œä½¿ç”¨ <code>assertNotEqual</code> ä¾†æª¢æŸ¥ä¸æ‡‰è©²æœ‰ HTTP Status Code 200 çš„ç‹€æ³ç™¼ç”Ÿ</p>
<div class="copy select highlight"><span class="filename">testinfra-ubuntu.py</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">class</span> <span class="nc">TestApplicationRules</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">testinfra</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="s2">&quot;local://&quot;</span><span class="p">)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="k">def</span> <span class="nf">test_to_ubuntu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>        <span class="c1"># L3/L4 Check</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>        <span class="n">azure_ubuntu_repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">addr</span><span class="p">(</span><span class="s2">&quot;azure.archive.ubuntu.com&quot;</span><span class="p">)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">azure_ubuntu_repo</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;ping -W 1 -c 1 azure.archive.ubuntu.com&quot;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">azure_ubuntu_repo</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span>  <span class="c1"># Equal to &quot;nc -w 1 -z azure.archive.ubuntu.com 80&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">azure_ubuntu_repo</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">443</span><span class="p">)</span><span class="o">.</span><span class="n">is_reachable</span><span class="p">)</span> <span class="c1"># Equal to &quot;nc -w 1 -z azure.archive.ubuntu.com 443&quot;</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">azure_ubuntu_repo</span><span class="o">.</span><span class="n">is_resolvable</span><span class="p">)</span> <span class="c1"># Equal to &quot;getent ahosts azure.archive.ubuntu.com&quot;</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="c1"># L7 Check</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="hll">        <span class="n">azure_ubuntu_http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;curl --connect-timeout 3 -o /dev/null -s -w %</span><span class="si">{http_code}</span><span class="s2"> https://azure.archive.ubuntu.com&quot;</span><span class="p">)</span>
</span><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">azure_ubuntu_http</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">)</span> <span class="c1"># HTTPS is not supported</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="hll">        <span class="n">azure_ubuntu_http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;curl --connect-timeout 3 -o /dev/null -s -w %</span><span class="si">{http_code}</span><span class="s2"> http://azure.archive.ubuntu.com&quot;</span><span class="p">)</span>
</span><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">azure_ubuntu_http</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">)</span> <span class="c1"># HTTP is supported</span>
</code></pre></div>
<h3 id="qa"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#qa">Q&amp;A</a></h3>
<h4 id="q1-serverspec"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q1-serverspec">Q1: ç‚ºä½•ä¸ç”¨ Serverspec ä¾†å¯«æ¸¬è©¦?</a></h4>
<ol>
<li>Python åœ¨å¤šæ•¸çš„ Linux ç’°å¢ƒéƒ½æœ‰</li>
<li>æˆ‘å€‹äººçœ‹ä¸å¤ªæ‡‚ Ruby çš„ Source Codeï¼Œä½† Python å°±çœ‹å¾—æ‡‚äº†</li>
</ol>
<h4 id="q2-pytest-pytest-testinfra"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q2-pytest-pytest-testinfra">Q2: pytest è·Ÿ pytest-testinfra æœ‰ä»€éº¼å·®åˆ¥?</a></h4>
<ul>
<li>pytest: å¹«åŠ©ä½ å¯«å‡ºæ›´å¥½çš„ Python ç¨‹å¼</li>
<li>pytest-testinfra: åŸºæ–¼ pytest çš„åŸºç¤ï¼Œå¹«åŠ©ä½ æŒçºŒæª¢æŸ¥å‡ºä½ æ²’æ³¨æ„åˆ°çš„ Infrastructure åŠŸèƒ½æ€§å•é¡Œ</li>
</ul>
<h4 id="q3-azure"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q3-azure">Q3: æˆ‘ä¸€å®šè¦ä½¿ç”¨ Azure æ‰èƒ½å¯«æ¸¬è©¦å—?</a></h4>
<p>No. ä½ æ­¤æ™‚æ­¤åˆ»åªè¦æœ‰é‡åˆ°ç¶²è·¯æª¢æŸ¥å•é¡Œï¼ŒåŸºæœ¬ä¸Šéƒ½å¯ä»¥å¯«</p>
<h4 id="q4"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q4">Q4: æˆ‘ä¸çŸ¥é“æˆ‘ç‚ºä»€éº¼è¢«æª”äº†ï¼Œå¯«æ¸¬è©¦å¯ä»¥å¹«åŠ©æˆ‘å—?</a></h4>
<p>å…¶å¯¦å¯« Unit Test å°±æ˜¯å¹«åŠ©ä½ äº†è§£ä½ çš„ Firewall Rule åˆ°åº•æ˜¯æœ‰æ­£å¸¸é‹ä½œé‚„æ˜¯æ²’æ­£å¸¸é‹ä½œï¼Œå¦‚æœä½ æœ‰ä»”ç´°çœ‹ Azure Firewall Logï¼Œåœ¨ä¸Šé¢éƒ½æœƒå¾ˆæ¸…æ¥šé¡¯ç¤ºä½ é€™å€‹å‹•ä½œï¼Œæ˜¯å°æ‡‰åˆ°å“ªä¸€æ¢ Policy è€Œ Allow æˆ–è€…æ˜¯ Denyï¼Œå¯ä»¥ä»¥ä½¿ç”¨è€…çš„è§’åº¦ç¢ºä¿ä½ çš„èªçŸ¥ã€ä½¿ç”¨è€…çš„èªçŸ¥ä»¥åŠ Azure Firewall çš„è¨­å®šæ˜¯æ­£ç¢ºçš„</p>
<h4 id="q5"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q5">Q5: æˆ‘æ‡¶å¾—å¯«ï¼Œæœ‰æ²’æœ‰æ‡¶äººåŒ…</a></h4>
<p>è«‹åƒè€ƒ Code Snippet <a href="https://github.com/pichuang/testinfra-code-snippet/blob/main/testinfra-snippet.py">pichuang/testinfra-code-snippet</a> è¤‡è£½è²¼ä¸Šä¿®æ”¹</p>
<h4 id="q6"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q6">Q6: æ„Ÿè¦ºç¶²è·¯æ¸¬è©¦æ„Ÿè¦ºéƒ½æ˜¯æ­£é¢è¡¨åˆ—ï¼Œéƒ½æ²’æœ‰è² å‘è¡¨åˆ—çš„å—?</a></h4>
<p>å¤šä½¿ç”¨ assertFalse å’Œ assertNotEqual ä¾†ç¢ºä¿ä½ çš„æ¸¬è©¦æ˜¯æ­£ç¢ºçš„ï¼Œç„¶å¾Œä½ ä¸å¤ªå¯èƒ½çª®ç›¡æ‰€æœ‰çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥ä¸€é–‹å§‹ä»¥æ­£é¢è¡¨åˆ—çš„ Test Case å…ˆå‡ºç™¼ï¼Œåœ¨å¾ŒçºŒçš„æ¸¬è©¦å’Œå›é¥‹ä¸­ï¼Œå†ä¾ç…§ä½ çš„éœ€æ±‚ä¾†å¢åŠ  Unit Test Case</p>
<h4 id="q7"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q7">Q7: é€™å€‹æœ‰æ²’æœ‰ä»€éº¼æ–¹æ³•è«–</a></h4>
<p>TDD (Test Driven Development)ï¼Œåªæ˜¯å¤šåŠéƒ½æ˜¯ç”¨ TDD å¹«åŠ©ç¨‹å¼æ›´å¥½ï¼Œé€™é‚Šæ˜¯ç”¨ TDD å¹«åŠ©ä½ çš„ Firewall Policy è¨­è¨ˆçš„æ›´å¥½</p>
<h4 id="q8-ip-url"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q8-ip-url">Q8: çœ‹åˆ° IP å’Œ URL å»ºè­°æ¸¬è©¦é †åºç‚ºä½•?</a></h4>
<ul>
<li>
<p>ä½ å¦‚æœæ˜¯è¦æ¸¬è©¦ç‰¹å®š IP çš„è©±ï¼Œè­¬å¦‚ 8.8.8.8ï¼Œå»ºè­°æ¸¬è©¦é †åºç‚º</p>
<ol>
<li>ICMP é€šä¸é€š</li>
<li>ç‰¹å®š Port é€šä¸é€š</li>
</ol>
</li>
<li>
<p>ä½ å¦‚æœæ˜¯è¦æ¸¬è©¦ç‰¹å®š URL çš„è©±ï¼Œè­¬å¦‚ https://blog.pichuang.com.twï¼Œå»ºè­°æ¸¬è©¦é †åºç‚º</p>
<ol>
<li>ICMP é€šä¸é€š</li>
<li>ç‰¹å®š Port é€šä¸é€š</li>
<li>èƒ½ä¸èƒ½åš DNS Resolution</li>
<li>ä»¥ Curl è©² URL ç²å¾— HTTP Status Sode ä¾†åˆ¤æ–·æ­£ä¸æ­£å¸¸</li>
</ol>
</li>
</ul>
<h4 id="q9-pytest-unittest"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q9-pytest-unittest">Q9: æ—¢ç„¶éƒ½æ˜¯ç”¨ pytest ç‚ºä¸»ï¼Œé‚£å¹¹å˜›é‚„è¦ç”¨ unittest æ¡†æ¶?</a></h4>
<p>æ©...æˆ‘ä¸€é–‹å§‹å°±ç”¨ unitest æ¡†æ¶å¯«ï¼Œç„¶å¾Œå°±...æ‡¶å¾—é‡æ§‹äº†</p>
<h4 id="q10-github-copilot"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#q10-github-copilot">Q10: ç‚ºå•¥ä¸è¦å…¨éƒ¨ç›´æ¥ç”¨ GitHub Copilot è‡ªå‹•å¯«å…¨éƒ¨æ¸¬è©¦?</a></h4>
<p>GitHub Copilot ä¸æ‡‚ç¶²è·¯è³‡å®‰ã€æ³•è¦å’Œäººå¿ƒ :)</p>
<h3 id="references"><a class="toclink" href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/#references">References</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/firewall/policy-rule-sets">Azure Firewall Policy rule sets</a></li>
<li><a href="https://docs.pytest.org/en/7.2.x/">pytest: helps you write better programs</a></li>
<li><a href="https://github.com/pichuang/testinfra-code-snippet/blob/main/testinfra-snippet.py">pichuang/testinfra-code-snippet</a></li>
<li><a href="https://testinfra.readthedocs.io/en/latest/">Testinfra: Testinfra test your infrastructure</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/03/06/%E9%81%8B%E7%94%A8-testinfra-%E4%BE%86%E7%A2%BA%E4%BF%9D%E7%B6%B2%E8%B7%AF%E9%80%A3%E9%80%9A%E6%80%A7%E6%B8%AC%E8%A9%A6/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-01 00:00:00">March 1, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/linux/" class="md-meta__link">linux</a></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="iac"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/">é¸æ“‡ IaC å·¥å…·æ˜¯å¤šé¸é¡Œï¼Œè€Œä¸æ˜¯å–®é¸é¡Œ</a></h2>
<p><img alt="" src="/images/meme-iac.png" /></p>
<h3 id="_1"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#_1">å‰è¨€</a></h3>
<p>å¾ˆå¤šæœ‹å‹è¬›åˆ° Infrastructure as Code (IaC) çš„æ™‚å€™å¤šåŠéƒ½æœƒç›´æ¥è½åœ¨å–®ä¸€å·¥å…·é¸æ“‡çš„è¨è«–ï¼Œæƒ³è¦çª®èˆ‰å‡ºæœ€çµ‚é¸æ“‡ï¼Œä½†éš¨è‘—æ™‚é–“ä¹…äº†æˆ‘è¦ºå¾—é€™å€‹è­°é¡Œæ‡‰è©²è¦ä»¥å…±ç”Ÿå…±æ¦®çš„è§’åº¦çœ‹å¾…æ¯”è¼ƒå¥½</p>
<p>æ—©æœŸçš„æ™‚å€™éƒ½æ˜¯ Shell Script ç•¶é“å±…å¤šï¼Œç›´è‡³ 2012 å¹´å·¦å³ Ansible (2015 å¹´è¢« Red Hat æ”¶è³¼)ã€Puppet (2022 å¹´è¢« Perforce æ”¶è³¼)ã€Chef (2020 å¹´è¢« Progress æ”¶è³¼)ã€Saltstack (2020 å¹´è¢« VMware æ”¶è³¼) ç­‰ 4 å¤§å¤šæ•¸ä»¥ä½œæ¥­ç³»çµ±ç®¡ç†ç‚ºä¸»çš„çµ„æ…‹ç®¡ç† (Configuration Management) èˆˆç››ï¼Œåˆ°å„å¤§é›²å» å•†è¿…é€Ÿå´›èµ·å‡ºç¾ Hashicorp Terraform (2021 å¹´ IPO) é€™é¡ä»¥é›²å¹³å° (Cloud Provider) ç‚º IaC æ ¸å¿ƒçš„å·¥å…·ï¼Œå…·é«”ä¾†è¬›ï¼Œè¢«ç®¡ç†çš„å¹³å°ä¸åŒï¼Œé¸æ“‡çš„æ–¹å‘æœƒæœ‰é»ä¸ä¸€æ¨£ï¼Œä¸‹é¢æœƒæœ‰ä¸€äº›æˆ‘å€‹äººçš„ç¶“é©—åˆ†äº«</p>
<!--more-->

<h3 id="declarative-imperative"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#declarative-imperative">å®£å‘Šå¼ (Declarative) èˆ‡å‘½ä»¤å¼ (Imperative)</a></h3>
<p>çµ•å¤§éƒ¨åˆ†çš„ IT ç®¡ç†äººå“¡æ‡‰è©²éƒ½æ˜¯æ¯”è¼ƒç¿’æ…£å‘½ä»¤å¼ (Imperative) çš„æ“ä½œæ–¹å¼ï¼Œç•¢ç«Ÿèª°ä¸æ˜¯ç”¨ Bashã€CLI é•·å¤§çš„å‘¢? ä½†éš¨è‘—æœå‹™è¶Šä¾†è¶Šå¤šå’Œå·²çŸ¥çš„è³‡æºç›¸ä¾æ€§å•é¡Œï¼Œå¾Œä¾†æ¼¸æ¼¸åœ°å®£å‘Šå¼ (Declarative) ç®¡ç†æˆç‚ºä¸»æµï¼Œå…¶å¯¦æœ€ç¶“å…¸çš„æ¡ˆä¾‹å°±æ˜¯ Kubernetesï¼Œä½†å…¶å¯¦ä½ ä¸å¤ªéœ€è¦äº†è§£åˆ°é€™éº¼ç´°ï¼Œåæ­£éƒ½æ˜¯è¦ç®¡ç†ï¼Œç”¨æœ€æœ‰åˆ©æ–¼åœ˜éšŠçš„å·¥å…·ï¼Œé”åˆ°æœ€çµ‚ç›®çš„å°±å¥½</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>è§£é‡‹</th>
<th>å„ªé»</th>
<th>ç¼ºé»</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‘½ä»¤å¼ (Imperative)</td>
<td>æ˜ç¢ºé™³è¿°ç‚ºç”¢ç”Ÿæ‰€éœ€çµæœæ‰€åŸ·è¡Œçš„å‘½ä»¤</td>
<td>1. å°æ–¼æ“ä½œåå‘ Step by Step æ€§è³ªçš„ç›¸ç•¶å¥½ç”¨<br>2. å°æ–¼ä¸€æ¬¡æ€§å·¥ä½œå¥½ç”¨<br>3. æ‰€æœ‰ç³»çµ±ç®¡ç†çš„åŸºæœ¬åŠŸ</td>
<td>1. å¹³å°å±¤ç´šçš„ç›¸ä¾æ€§è™•ç†ä¸å¼·<br>2.éœ€è¦ä¸€å®šçš„ Coding æŠ€èƒ½ï¼Œå¦‚ Shell Scriptã€Powershell ç­‰ï¼Œè™•ç†éŒ¯èª¤å’Œ if-else åˆ¤æ–·<br>3. è¨­å®šé£„ç§»å¾ˆé›£ä¿®æ­£ï¼Œå¤šæ•¸éœ€è¦å€‹åˆ¥è™•ç†<br></td>
</tr>
<tr>
<td>å®£å‘Šå¼ (Declarative)</td>
<td>æŒ‡å®šæƒ³è¦çš„çµæœï¼Œè€Œä¸æ˜¯æŒ‡å®šè¦å¦‚ä½•å®Œæˆ</td>
<td>1. ä¸å¤ªéœ€è¦ Coding æŠ€èƒ½å³å¯ä½¿ç”¨<br>2. é«˜åº¦é‡è¤‡æ€§<br>3. å®¹æ˜“ä¿®æ­£è¨­å®šé£„ç§»å•é¡Œ</td>
<td>1. å°æ–¼æµç¨‹æ§åˆ¶è¼ƒä¸å½ˆæ€§<br>2. Day 2 Operation ä¸å¼·ï¼Œè­¬å¦‚èªªæ—¢æœ‰ OS æ”¹ IP<br></td>
</tr>
</tbody>
</table>
<h3 id="azure-red-hat-openshift"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#azure-red-hat-openshift">ä¾†å€‹ä¾‹å­: ä»¥éƒ¨ç½² Azure Red Hat OpenShift</a></h3>
<p>å› ä»Šå¹´ä¾† Microsoft Azure ä¸Šç­ï¼Œé…ä¸Šå‰›å¥½ä¹‹å‰åœ¨ Red Hat ä¸Šç­çš„ç¶“é©—ï¼Œæˆ‘ä¸‹é¢ä¸»è¦æœƒä»¥ Azure Red Hat OpenShift éƒ¨ç½²ç¶“é©—ç‚ºä¸»ï¼Œè©²æ’åˆ°çš„åœ°é›·æˆ‘å…¨éƒ¨éƒ½æ’åˆ°äº†ï¼Œåˆ†äº«æˆ‘å€‹äººåœ¨é¸æ“‡ IaC å·¥å…·æ™‚çš„ä¸€äº›ç¶“é©—</p>
<table>
<thead>
<tr>
<th>å·¥å…·</th>
<th>å±¬æ€§</th>
<th>è³‡æºç®¡ç†æ–¹å¼</th>
<th style="text-align: center;">å¯è®€æ€§</th>
<th style="text-align: center;">å¯æ“´å±•æ€§</th>
<th style="text-align: center;">å¯ç¶­è­·æ€§</th>
<th style="text-align: center;">ç®¡ç†é¡†ç²’åº¦</th>
<th>å„ªé»</th>
<th>ç¼ºé»</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure CLI</td>
<td>å‘½ä»¤å¼ (Imperative)</td>
<td>Azure Resource Manager</td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td>æŒ‡ä»¤ç›¸ç•¶ç›´è¦ºï¼Œä¸€æ¬¡æ€§çš„æ“ä½œå¥½ç”¨</td>
<td>Shell Script å‹•ä¸å‹•å°±ä¸€ç™¾è¡Œèµ·è·³ï¼Œæœ‰è€ƒæ…®è®Šæ•¸ã€ if-else åˆ¤æ–·ã€Error Handling çš„è©±æœƒæ›´è¤‡é›œ</td>
</tr>
<tr>
<td>Ansible Playbook</td>
<td>å®£å‘Šå¼ (Declarative)</td>
<td>Azure Resource Manager</td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td>è¬ç”¨è† èªè¨€</td>
<td>éœ€è¦å…ˆé€é Azure CLI ä¸€æ­¥ä¸€æ­¥äº†è§£æ“ä½œæµç¨‹æ‰èƒ½å¯«å‡º Ansible Playbook</td>
</tr>
<tr>
<td>ARM Template</td>
<td>å®£å‘Šå¼ (Declarative)</td>
<td>Azure Resource Manager</td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ " class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e0.svg" title=":orange_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td>ä¸€æ¬¡æ€§çš„æ“ä½œå¥½ç”¨ï¼Œå¯æ”¯æ´ Azure Portal ä¸Šå‘ˆç¾éœ€éƒ¨ç½²æ¬„ä½</td>
<td>æˆ‘å€‹äººè¦ºå¾—é›£è®€å’Œé›£æ”¹</td>
</tr>
<tr>
<td>Terraform</td>
<td>å®£å‘Šå¼ (Declarative)</td>
<td>Azure Resource Manager</td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td style="text-align: center;"><img alt="ğŸŸ¢" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f7e2.svg" title=":green_circle:" /></td>
<td>è³‡æºç›¸ä¾æ€§è™•ç†å¼·ï¼Œéƒ¨ç½² Cloud Provideer è³‡æºé¦–é¸</td>
<td>éœ€è¦çŸ¥é“ Terraform HCL æ€éº¼å¯«ï¼Œé€™å°è »å¤šäººæ˜¯å€‹é–€æª»çš„</td>
</tr>
</tbody>
</table>
<p>é€™é‚Šé‡å°éƒ¨ç½² Private Azure Red Hat OpenShift æä¾›åƒè€ƒç¯„ä¾‹ï¼Œ<a href="https://github.com/pichuang/compare-iac-implentation">pichuang/compare-iac-implementation</a></p>
<h3 id="_2"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#_2">å¹³å°åˆ†æå’Œå€‹äººå·¥å…·é¸æ“‡è¡¨</a></h3>
<p>åŸºæ–¼ä¸åŒå¹³å°ä¹‹ä¸‹ï¼Œä¸‹é¢æä¾›æˆ‘å€‹äººçŸ¥é“ï¼Œä¸”ç”¨éçš„ Infrastructure as Code çš„æ’åˆ—çµ„åˆ</p>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Consistent Management Layer</th>
<th>GUI</th>
<th>CLI</th>
<th>+ Ansible CLI Collections</th>
<th>Ansible Collections</th>
<th>Terraform Provider</th>
<th>Python SDK</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure</td>
<td>Azure Resource Manager</td>
<td>Azure Portal</td>
<td>Azure CLI / Azure PowerShell</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/azure/azcollection/index.html">ansible.azure.azcollection</a></td>
<td><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">hashicorp/azurerm</a></td>
<td><a href="https://github.com/Azure/azure-sdk-for-python">azure/azure-sdk-for-python</a></td>
</tr>
<tr>
<td>VMware vSphere</td>
<td>VMware vCenter (vc)</td>
<td>VMware vCenter WEB UI</td>
<td>govc / VMware PowerCLI</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td><a href="https://github.com/ansible-collections/community.vmware">ansible.community.vmware</a></td>
<td><a href="https://registry.terraform.io/providers/hashicorp/vsphere/latest/docs">hashicorp/vsphere</a>, å€‹äººå°‘ç”¨</td>
<td><a href="https://github.com/vmware/pyvmomi">vmware/pyvmomi</a></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>Kubernetes API Server</td>
<td>N/A</td>
<td>kubectl</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td><a href="https://github.com/ansible-collections/kubernetes.core">ansible.kubernetes.core</a></td>
<td><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">hashicorp/kubernetes</a>, å€‹äººå°‘ç”¨</td>
<td><a href="https://github.com/kubernetes-client/python">kubernetes-client/python</a></td>
</tr>
<tr>
<td>Red Hat OpenShift</td>
<td>Kubernetes API Server</td>
<td>OpenShift Web Console</td>
<td>oc / kubectl</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td>redhat.openshift, å€‹äººå°‘ç”¨</td>
<td>N/A</td>
<td><a href="https://github.com/openshift/openshift-client-python">openshift/openshift-client-python</a></td>
</tr>
<tr>
<td>VMware vSphere with Tanzu</td>
<td>VMware vCenter 7 (vc) + Custer API</td>
<td>VMware vCenter</td>
<td>kubectl vsphere</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>VMware Tanzu Kubernetes Grid 1.x</td>
<td>Kubernetes API Server + Custer API</td>
<td>N/A</td>
<td>tanzu / kubectl</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>Linux</td>
<td>N/A</td>
<td>X Windows</td>
<td>bash</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.builtin.shell</a></td>
<td>Depends on Linux Distribution</td>
<td>N/A</td>
<td>Built-in Python</td>
</tr>
<tr>
<td>Windows</td>
<td>N/A</td>
<td>Windows Desktop</td>
<td>PowerShell</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.windows.win_command</a></td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.windows.win_command</a></td>
<td>N/A</td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/index.html">ansible.windows</a></td>
</tr>
<tr>
<td>Cisco 2960 Switch</td>
<td>N/A</td>
<td>N/A</td>
<td>IOS CLI</td>
<td>N/A</td>
<td><a href="https://github.com/ansible-collections/cisco.ios">ansible.cisco.ios</a></td>
<td>N/A</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h4 id="azure"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#azure">Azure</a></h4>
<div class="admonition tip">
<p class="admonition-title">Azure Iac å°ç­–</p>
<p>å…ˆ Terraformï¼Œå¾Œ ansible.builtin.shell + Azure CLI</p>
</div>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/overview">What is Azure Resource Manager?</a> æ‰€è¿°ï¼ŒAzure Resource Manger æä¾›äº†å¦‚ä¸‹åœ–æ‰€å‘ˆç¾çš„çµ±ä¸€ç®¡ç†å±¤ (Consistent Management Layer)ï¼Œæä¾›çµ±ä¸€çš„ APIï¼Œç„¡è«–ä½ æ˜¯ä½¿ç”¨ Azure Portal (å±¬æ–¼ ARM Template ç¯„ç–‡)ã€Azure PowerShellã€Azure CLI æˆ–è€…æ˜¯ç”¨ Postman è‡ªå·±æ…¢æ…¢æ‰“ REST APIï¼Œå…¶å¯¦éƒ½æ˜¯å‘¼å«åˆ°åº•å±¤ç›¸åŒçš„ API Callï¼Œç†è«–ä¸Šä¸¦ä¸æœƒæœ‰ä¸ç›¸åŒçš„ç‹€æ³ç™¼ç”Ÿï¼Œä½†å¯¦å‹™ä¸Šä½ æœ‰æ™‚æœƒç™¼ç¾ä¸Šé¢å¹¾å€‹å·¥å…·æ“ä½œæœ‰é»ä¸ä¸€æ¨£ï¼Œä¸»è¦åŸå› åœ¨æ–¼ Azure Resource Manager ä¸Šé¢æ‰€æä¾› SDK å¯èƒ½é‚„æ²’å¯¦ä½œç›¸é—œåŠŸèƒ½ã€ API Version é‚„æ²’å‡ä¸Šå»æˆ–è€…æ˜¯æ ¹æœ¬ä¸Šå‘¼å«æ“ä½œçš„æ™‚å€™æ˜¯è€ƒæ…®ç‰¹å®šç‹€æ³è€Œå¯«æ­»ï¼Œé€™äº›éƒ½ç®—æ˜¯å¸¸è¦‹çš„ç‹€æ³</p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/media/overview/consistent-management-layer.png" /></p>
<p>é‡å° Azure Cloud Provider éƒ¨å±¬å’Œç®¡ç†ä¸Šï¼Œå¯ä»¥åˆ†ç‚º 2 å€‹éšæ®µ:</p>
<ol>
<li>å¹³å°éƒ¨ç½² (Infrastucture Provisioning): å¾ 0 åˆ° 1, æœå‹™å¾ç„¡åˆ°æœ‰ï¼ŒåŒ…å«ç¶²è·¯ã€è³‡æ–™åº«ã€è™›æ“¬æ©Ÿ VM Size ç­‰ç­‰</li>
<li>å¹³å°ç®¡ç† (Infrastructure Configurations): å¾ 1 åˆ° 2, æ—¢æœ‰æœå‹™æŒçºŒç¶­è­·ï¼Œä¸åšå¹³å°å±¤ç´šçš„è®Šæ›´</li>
</ol>
<h5 id="1-infrastucture-provisioning"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#1-infrastucture-provisioning">é—œæ–¼ 1. å¹³å°éƒ¨ç½² (Infrastucture Provisioning) éšæ®µ</a></h5>
<p>é¸æ“‡ä¸Šæœƒä½¿ç”¨åˆ°çš„å·¥å…·çµ„åˆæœ‰</p>
<ol>
<li>å–®ç¨ä½¿ç”¨ Terraform æ‰€æä¾›çš„ azurerm</li>
<li>ä»¥ Azure CLI åŠŸèƒ½ç‚ºä¸»ï¼ŒAnsible æˆ– Shell Script ç‚ºè¼”åŠ©ç®¡ç†æ“ä½œæµç¨‹</li>
</ol>
<p>é è¨­ç‹€æ³ä¸‹ï¼Œä½ æ‡‰è©²éƒ½è¦ç”¨ Terraform å®Œæˆå¾ç„¡åˆ°æœ‰çš„å¹³å°éƒ¨ç½²éšæ®µï¼Œè®“ AzureRM Terraform Provider ç›´æ¥å° Azure Resource Manager é€²è¡Œç®¡ç†ï¼Œæ–‡ä»¶å¯åƒè€ƒ <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">hashicorp/terraform-provider-azurerm</a>ï¼Œæ•…æŠŠ Terraform å¯«å¥½çš„ç¢ºå¯ä»¥åŠ é€Ÿå¹³å°éƒ¨ç½²é€Ÿåº¦å’Œç®¡ç†ï¼Œä½†...æœ‰æ™‚å€™ä½ æœƒé‡åˆ° Terraform æ‰€æä¾›çš„åŠŸèƒ½ä¸¦éæ˜¯å®Œå–„çš„ï¼Œè­¬å¦‚èªª Azure Red Hat OpenShift (aro) çš„éƒ¨ç½²èƒ½åŠ›ç›´è‡³ä»Šæ—¥é‚„åœ¨ <a href="https://github.com/hashicorp/terraform-provider-azurerm/pull/20266">hashicorp
/terraform-provider-azurerm - New Resource: azurerm_redhat_openshift_cluster #20266</a> èººè‘—ï¼Œä½ ç”¨å®˜æ–¹ azurerm æ˜¯å¯«ä¸å‡ºä¾†ç›¸é—œåŠŸèƒ½çš„ï¼Œé€™æ™‚å€™ä½ å°±éœ€è¦æ›ä¸‹ä¸€å€‹åšæ³•äº†</p>
<p>Azure CLI è·Ÿ Azure PowerShell ç•¢ç«Ÿæ˜¯ Azure è¦ªå…’å­ï¼Œç›¸é—œæŒ‡ä»¤å’Œæ¸¬è©¦éƒ½å¯«å¾—ç›¸ç•¶å®Œå–„ï¼Œå¦‚æœä½ çœ‹åˆ°æ–°çš„åŠŸèƒ½å‡ºçš„æ™‚å€™ï¼Œå¤šåŠæœ€æ–°çš„ Azure CLI ä¹Ÿéƒ½æœ‰æä¾›å°æ‡‰çš„æŒ‡ä»¤çµ¦ä½ æ“ä½œäº†ï¼Œæ‰€ä»¥åªè¦é‡åˆ°å¤ªæ–°çš„æœå‹™ï¼ŒTerraform æ¸¬ä¸å‡ºä¾†ï¼Œä½ å¯ä»¥ç›´æ¥æ›æˆç”¨ Azure CLI ç‚ºä¸»çš„æ–¹å¼ä¾†æ“ä½œï¼Œè¼”ä»¥ Shell Script æˆ–è€…æ˜¯ Ansible ä¾†å®Œæˆæ•´é«”çš„æ“ä½œæµç¨‹ï¼Œå¦‚æœä½ æ˜¯å–®ç´”ç”¨ Bash + Azure CLI çš„è©±ï¼Œé¢¨æ ¼å¦‚ç¯„ä¾‹ <a href="https://github.com/pichuang/compare-iac-implentation/blob/main/azcli-create-private-aro.azcli">Azure CLI + Bash - azcli-create-private-aro.azcli</a></p>
<p>ç‚ºä½•ä¸ä½¿ç”¨ ARM Template æˆ– Bicep? æˆ‘å€‹äººè¦ºå¾—æ˜¯å¾ˆé›£å¯«ï¼Œå¾ˆé›£å°‡å…·å‚™é‚è¼¯å’Œæµç¨‹ç›¸é—œçš„å…ƒç´ å¯«é€²å»ï¼Œä½†ä¸€æ¬¡éƒ¨ç½²çš„å¯ä»¥ç”¨ï¼Œä½†é€™å€‹å¤ªå®¹æ˜“è¢« Terraform è§’è‰²å–ä»£ï¼Œæˆ–è€…æ˜¯å¿˜è¨˜å°‡åŠŸèƒ½å¯«é€²å»ï¼Œçœ‹çœ‹ Azure Red Hat OpenShift åœ¨ Azure Portal ä¸Šä½ æ˜¯é»ä¸å‡º Private æ¶æ§‹çš„...é™¤éä½ è‡ªå·±æ‰‹å‹•åŒ¯å…¥ ARM Templateï¼Œå¦‚ç¯„ä¾‹ <a href="https://github.com/pichuang/compare-iac-implentation/blob/main/arm-template-create-private-aro.json">ARM Template - arm-template-create-private-aro.json</a></p>
<p>ç‚ºä½•ä¸ä½¿ç”¨ Anisble Module æä¾›çš„ <a href="https://docs.ansible.com/ansible/latest/collections/azure/azcollection/index.html">Ansible - Azure.Azcollection</a>? é€™å€‹è¦çœ‹ç‹€æ³ï¼Œå¤šæ•¸ä¸ä½¿ç”¨çš„ç†ç”±è·Ÿ Terraform æœ‰äº› Azure æœå‹™çœŸçš„æ²’å¯¦ä½œå‡ºä¾†ä¸€æ¨£ï¼ŒæŠ‘æˆ–è€…æ˜¯è©²æ¨¡çµ„å¤ªä¹…æ²’æ›´æ–°ï¼Œä»¥ Azure Red Hat OpenShift ç‚ºä¾‹ï¼Œ<a href="https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_openshiftmanagedcluster_module.html"><code>azure.azcollection.azure_rm_openshiftmanagedcluster</code></a> æ˜¯ Ansible Module åç¨±ï¼Œé›–ç„¶æ¨¡çµ„æœ‰æ˜¯æœ‰ï¼Œä½†æœ‰æ®µæ™‚é–“æ²’æ›´æ–°äº†ï¼Œå°è‡´æŸéƒ¨åˆ† API å‘¼å«æœƒå¤±æ•—ï¼Œå¯¦å‹™ä¸Šéƒ¨ç½²ä¸å‡ºä¾†ï¼Œæ‰€ä»¥æœ€çµ‚é‚„æ˜¯ç”¨ Azure CLI ä¾†å®Œæˆæ“ä½œã€‚</p>
<p>ä½†æˆ‘ä¸¦ä¸æ˜¯å¦å®š azure.azcollection æ‰€æœ‰çš„æ¨¡çµ„ï¼Œåªè¦æ˜¯å¸¸è¦‹çš„æœå‹™ï¼Œå¦‚ç¶²è·¯ã€éƒ¨ç½²è™›æ“¬æ©Ÿç­‰ç­‰ï¼Œä½¿ç”¨ä¸Šéƒ½ä¸æœƒæœ‰å¤ªå¤§å•é¡Œï¼Œæ‰€ä»¥æ­£ç¢ºç”¨æ³•æ˜¯ Azure Collection + Azure CLI æ··è‘—ç”¨ï¼Œè€Œä¸æ˜¯åªç”¨å–®ä¸€å€‹é¸æ“‡ï¼Œé¢¨æ ¼å¦‚ç¯„ä¾‹ <a href="https://github.com/pichuang/compare-iac-implentation/blob/main/ansible-create-private-aro.yml">Ansible Playbook - ansible-create-private-aro.yml</a>ï¼Œå¸¸ç”¨æœå‹™ç”¨ azure.azcollection æ¨¡çµ„ï¼Œä¸å¸¸ç”¨æˆ–æ–°æœå‹™ç”¨ Azure CLI + Ansible Module - shell, command ä¾†å®Œæˆæ•´é«”çš„æ“ä½œæµç¨‹</p>
<h5 id="2-infrastructure-configurations"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#2-infrastructure-configurations">é—œæ–¼ 2. å¹³å°ç®¡ç† (Infrastructure Configurations) éšæ®µ</a></h5>
<p>åˆ†ç‚ºå…©å€‹éƒ¨åˆ†çœ‹ï¼Œå¦‚æœä½ æ˜¯ç®¡ç† PaaS ä¹‹é¡çš„æœå‹™ï¼Œçš„ç¢ºä½ é‚„æ˜¯å¯ä»¥ç¹¼çºŒä½¿ç”¨ Terraform æˆ–è€…æ˜¯ç”¨ <code>az xxx update</code> ä¾†é€²è¡ŒåŸºæ–¼å¹³å°çš„è¨­å®šæ›´æ–°ç®¡ç†ï¼Œä½†å¦‚æœæ˜¯ VM å±¤ç´šçš„æœå‹™ï¼Œéœ€è¦å‹•åˆ°ä½œæ¥­ç³»çµ±è£¡çš„è¨­å®šï¼Œå¦‚ Ubuntu æƒ³è¦æ”¹ Interface IP, Red Hat Enterprise Linux éœ€è¦ä¸Š sysctlã€Windows Server Firewall Allow ICMP ç­‰ç­‰åå‘ä½œæ¥­ç³»çµ±å±¤ç´šçš„ç®¡ç†ï¼Œæ²’æ„å¤–å°±æ˜¯ä»¥ Ansible ç‚ºä¸»äº†ï¼ŒAnsible æœ€æœ‰å„ªå‹¢çš„åœ°æ–¹å°±æ˜¯ Agentless é€™å€‹ç‰¹æ€§ï¼Œæœ‰ SSH æˆ– WinRM å°±èƒ½åšå¾ŒçºŒçš„ä½œæ¥­ç³»çµ±ç®¡ç†äº†ï¼Œè©³ç´°å¯ä»¥åƒè€ƒå°å¼Ÿä¹‹å‰å¯«çš„ <a href="https://blog.pichuang.com.tw/20200309-ansible-30m.html">30 åˆ†é˜å…§å¾é–‹å§‹åˆ°å…¥é–€çš„ Ansible</a></p>
<h4 id="vmware-vsphere"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#vmware-vsphere">VMware vSphere</a></h4>
<div class="admonition tip">
<p class="admonition-title">VMware vSphere Iac å°ç­–</p>
<p>é¦–é¸ Ansible ä¸¦å¤§é‡ä½¿ç”¨ ansible.community.vmware</p>
</div>
<p>é›–ç„¶ VMware vSphere æ˜¯å€‹å¹³å°ï¼Œä¹Ÿæœ‰ Terraform Provider çš„æ¨¡çµ„ï¼Œä½†å¯¦å‹™ä¸Šå¦‚æœä½ ä¸æ˜¯æŠŠå®ƒç•¶ä½œ Cloud Provider çš„ä½¿ç”¨æ–¹å¼çš„è©±ï¼Œåå‘æ˜¯ä¸€æ­¥ä¸€æ­¥æ“ä½œçš„è©±ï¼Œå¯èƒ½ç”¨ VMware vCenter Web UI æ“ä½œå±…å¤š</p>
<p>å€˜è‹¥ä½ ä¸€å®šè¦åš IaC åˆä»¥ Ansible ç‚ºä¸»çš„è©±ï¼Œä½ ä¸€å®šæœƒå¤§é‡ç”¨åˆ° <a href="https://docs.ansible.com/ansible/latest/collections/community/vmware/vmware_guest_module.html#examples">community.vmware.vmware_guest</a>ï¼Œç„¡è«–æ˜¯è‡ªå‹•åŒ–å¾ VM Template éƒ¨ç½²ä¸€å°æ–°çš„ VMã€é‡å°æŒ‡å®šæ©Ÿå™¨é–‹é—œæ©Ÿã€ä¿®æ”¹ VM Instanceï¼Œä½†é€™æ¨¡çµ„ç®¡ç†çš„å±¤ç´šç†è«–ä¸Šæ˜¯ä¸æœƒæ·±å…¥åˆ° OS è£¡é¢çš„ï¼Œä¸»è¦éƒ½æ˜¯ä»¥ VMware VM instance è§’åº¦å†åšç®¡ç†ï¼Œä¸¦ä¸æ¶‰åŠåˆ°ä½œæ¥­ç³»çµ±å…§éƒ¨çš„è¨­å®šä¿®æ”¹ï¼Œè·Ÿ <code>az vm</code> å’Œ <code>govc vm.clone</code> æœ‰ç•°æ›²åŒå·¥ä¹‹å¦™</p>
<h4 id="kubernetes"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#kubernetes">Kubernetes</a></h4>
<p><img alt="" src="/images/kubectl.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Kubernetes Iac å°ç­–</p>
<p>é‡å° Kubernetes è£¡é¢çš„è³‡æºå°ç­– ansible.builtin.shell + kubectl/helm<br>
é‡å° Kubernetes å¤–éƒ¨çš„æœå‹™å°ç­–ï¼Œå›æ­¸åˆ°å„è‡ªå¹³å°çš„ç®¡ç†æ–¹å¼ï¼Œå¦‚ VMware vSphereã€Azureã€AWSã€GCP ç­‰ç­‰</p>
</div>
<p>Kubernetes å¹³å°åŒæ™‚é–“åŒ…å«äº†å¹³å°ç®¡ç†å’Œæ‡‰ç”¨ç¨‹å¼éƒ¨ç½²ï¼Œæœ€æ²’å•é¡Œçš„éƒ¨åˆ†å°±æ˜¯æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²ï¼Œäº‹æƒ…æœ€å–®ç´”ï¼Œä½ æ‰¾å“ªä¸€å®¶æˆ–è€…æ˜¯å“ªä¸€åº§éƒ½å·®ä¸å¤šè™•è£¡æ–¹å¼ï¼Œæœ€å¤§çš„è­°é¡Œæ˜¯åœ¨ Kubernetes å¹³å°ç®¡ç†ä¸Š</p>
<p>ç®¡ç† Kubernetes å¹³å°æœ‰ 2 å€‹å±¤é¢è¦è¨è«–</p>
<ol>
<li>åœ¨ Kubernetes è£¡é¢çš„è³‡æº (Resource): ä¸»è¦ç”¨ kubectl/helm æŒ‡ä»¤æ“ä½œå³å¯ï¼Œå¯ä»¥æ­è‘— Ansible <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html\">ansible.buitin.shell</a> ä¾†åšï¼Œé€™å€‹äº‹æƒ…ä¹Ÿç®—å°ï¼ŒåŸºæœ¬ä¸Šè·Ÿæ‡‰ç”¨ç¨‹å¼éƒ¨ç½²å·®ä¸å¤šå±¤ç´šï¼Œåªæ˜¯æ¯”è¼ƒåå‘ Kubernetes å…§éƒ¨è¦–é‡çš„å¹³å°ç®¡ç†ï¼ŒCNCF CKA / CKAD / CKS åŸºæœ¬ä¸Šéƒ½æ˜¯è€ƒé€™å€‹ç¯„åœçš„çŸ¥è­˜</li>
<li>åœ¨ Kubernetes å¤–é¢çš„æœå‹™ (Services/Provider): ä¸»è¦æ˜¯ç„¡æ³•ç”¨ kubectl æ“ä½œçš†å±¬æ­¤é¡ï¼Œå¤§å¤šæ•¸è­°é¡Œéƒ½è·Ÿ Kubernetes è­°é¡Œç„¡é—œï¼Œå¦‚ Underlay Networkingã€ç¯€é»å¤§å°ã€é–‹é—œæ©Ÿã€External Load Balancer ä»‹æ¥ã€NetAPP Trident CSI ä¸²æ¥ã€F5 BIG-IP CIS æ•´åˆã€Veritas Kubernetes å‚™ä»½ç­‰ç­‰ï¼Œé€™å€‹æ˜¯æœ€å…·æŒ‘æˆ°çš„åœ°æ–¹ï¼Œå› ç‚ºå¾ˆåƒæ—¢æœ‰æ–¹æ¡ˆå°æ¥ Kubernetes æ•´åˆçš„ç†è§£</li>
</ol>
<p>2 å€‹å•é¡Œå¯ä»¥è®“ä½ åˆ†æ¸…è­°é¡Œ</p>
<ul>
<li>
<p>æœ€æ ¸å¿ƒå•é¡Œæ˜¯<code>ä½ çš„ Kubernetes æ˜¯èª°å®¶çš„?</code> é€™å€‹æœƒå½±éŸ¿åˆ°ä½ è¦å¦‚ä½•ç®¡ç† Kubernetesï¼Œå¦‚å…¬æœ‰é›²æä¾›çš„ Kubernetesï¼Œå¦‚ AKSã€EKSã€GKE ç­‰ï¼Œé‚„æ˜¯å» å•†æä¾›ç‚ºä¸»çš„ Kubernetesï¼Œå¦‚ Red Hat OpenShift on Bare Metalã€Red Hat OpenShift on VMware vSphereã€VMware vSphere with Tanzuã€VMware Tanzu Kubernetes Gridã€Rancherã€Rancher ç­‰ï¼Œæˆ–è€…æ˜¯è‡ªæ¶ DIY çš„ Kubernetes</p>
</li>
<li>
<p>å…¶æ¬¡æ˜¯ <code>Cluster API æœ‰æ²’æœ‰ç”¨?</code> æœ‰ç”¨çš„è©±ï¼ŒKubernetes å¯ä»¥é€é Cluster API Provider çš„æ–¹å¼å»èª¿åº¦åº•å±¤è³‡æºï¼Œæ¶æ§‹è¨­è¨ˆå¾—ç•¶çš„ç‹€æ³ä¸‹ä½ ä¸å¤ªéœ€è¦æ’æ‰‹ï¼Œå¯åƒè€ƒ <a href="https://speakerdeck.com/pichuang/20211122-kubernetes-duo-cong-ji-ji-dan-cong-ji-jia-gou-xuan-ze-tan-tao?slide=14">20211122_Kubernetes å¤šå¢é›†åŠå–®å¢é›†æ¶æ§‹é¸æ“‡æ¢è¨</a>ï¼Œæ²’ç”¨çš„è©±å°±æ˜¯å›æ­¸åˆ°å„è‡ªåº•å±¤å¹³å°çš„ç®¡ç†æ–¹å¼ï¼Œåœ°ç«¯æˆ‘é‡åˆ°çš„æ¡ˆå­åŸºæœ¬ä¸Šéƒ½æ˜¯æ²’ç”¨çš„</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Kubernetes Solution</th>
<th>Platform</th>
<th style="text-align: center;">Cluster API Enabled?</th>
<th>Kubernetes å¤–éƒ¨æœå‹™è³‡æºç®¡ç†æ–¹å¼</th>
<th>Kubernetes å…§éƒ¨è³‡æºç®¡ç†æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure Kuberentes Service</td>
<td>Azure</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>1. az aks<br>2. Terraform</td>
<td>kubectl/helm</td>
</tr>
<tr>
<td>Red Hat OpenShift 4</td>
<td>Bare Metal</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/dellemc/openmanage/index.html">ansible.Dellemc.Openmanage</a> æˆ–è€…æ˜¯ <a href="https://github.com/HewlettPackard/ilo-ansible-collection">HPE iLo</a>, é€™å€‹æ¯”è¼ƒç‰¹æ®Šä¸€é»</td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>Red Hat OpenShift 4</td>
<td>Bare Metal</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/dellemc/openmanage/index.html">ansible.Dellemc.Openmanage</a> æˆ–è€…æ˜¯ <a href="https://github.com/HewlettPackard/ilo-ansible-collection">HPE iLo</a></td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>Red Hat OpenShift 4</td>
<td>VMware vSphere</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>VMware vCenter</td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>Red Hat OpenShift 4</td>
<td>VMware vSphere</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td><a href="https://docs.ansible.com/ansible/latest/collections/community/vmware/index.html">ansible.community.vmware</a></td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>Red Hat OpenShift 4</td>
<td>Azure</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>Terraform</td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>Azure Red Hat OpenShift</td>
<td>Azure</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>Azure CLI</td>
<td>kubectl/oc/helm</td>
</tr>
<tr>
<td>VMware vSphere with Tanzu</td>
<td>VMware vSphere</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>VMware vCenter</td>
<td>kubectl/kapp</td>
</tr>
<tr>
<td>VMware Tanzu Kubernetes Grid 1.x</td>
<td>VMware vSphere</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>tanzu</td>
<td>kubectl/kapp</td>
</tr>
<tr>
<td>VMware Tanzu Kubernetes Grid 1.x</td>
<td>Azure</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td>tanzu</td>
<td>kubectl/kapp</td>
</tr>
</tbody>
</table>
<p>é‡å° OpenShift 4 å…§éƒ¨è³‡æºç®¡ç†æ–¹å¼ï¼Œæˆ‘ä¹‹å‰æœ‰é‡å° OpenShift Day 2 Operations å¸¸é‡åˆ°çš„ç®¡ç†æƒ…å¢ƒï¼Œç”¨ Ansible å¯«äº†ä¸å°‘ç¯„ä¾‹ä¸‹ä¾†å¯ä»¥åƒè€ƒ <a href="https://github.com/pichuang/openshift4-toolbox">pichuang/openshift4-toolbox</a>ï¼Œä¾‹å¦‚ Etcd å‚™ä»½ã€æª¢æŸ¥ã€å¢é›†é–‹é—œæ©Ÿã€å®‰è£ Service Mesh çš†èƒ½å¯«</p>
<p>å¦å¤– VMware ç›¸é—œçš„è§£æ±ºæ–¹æ¡ˆ VMware vSphere with Tanzu å’Œ VMware Tanzu Kubernetes Gridï¼Œæœƒç›¸ç•¶è‘—é‡åœ¨ VMware vSphere å’Œ Tanzu Management Cluster (mc)/Supervisor Cluster(sc) çš„æ¶æ§‹è¨­è¨ˆä¸Šï¼Œä½†é€™å€‹è¶…å‡ºè¨è«–ç¯„åœï¼Œæœ¬æ–‡ä¸è¨è«–</p>
<h4 id="linux"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#linux">Linux ä½œæ¥­ç³»çµ±</a></h4>
<div class="admonition tip">
<p class="admonition-title">Linux IaC å°ç­–</p>
<p>ansible.builtin.shell + Ansible Collections + Shell Script</p>
</div>
<p>å¤ªå¤šäº†è¬›ä¸å®Œï¼Œç¶²è·¯ä¸Šåƒè€ƒæ–‡ç« éå¸¸å¤šï¼Œå¦‚æœä¸å«Œæ£„çš„è©±å¯åƒè€ƒ <a href="https://blog.pichuang.com.tw/20200309-ansible-30m.html">30 åˆ†é˜å…§å¾é–‹å§‹åˆ°å…¥é–€çš„ Ansible</a> å’Œ <a href="https://speakerdeck.com/pichuang/ansible-ji-shu-gai-guan-jie-shao-20190130?slide=12">Ansible æŠ€è¡“æ¦‚è§€ä»‹ç´¹_20190130</a>ï¼Œä¸»è¦å…ˆæœƒ 2 å€‹å°±å¥½ï¼Œå…¶ä»–éƒ½æ˜¯è®ŠåŒ–è€Œå·²</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># 1: å°å¤šå€‹ä¼ºæœå™¨ä¸‹ç›¸åŒæŒ‡ä»¤</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>ansible<span class="w"> </span>-i<span class="w"> </span>inventory<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-k<span class="w"> </span>-a<span class="w"> </span>&lt;æŒ‡ä»¤&gt;
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># 2: å°‡ä¸€å€‹æª”æ¡ˆæˆ–è³‡æ–™å¤¾å‚³é€åˆ°å¤šå€‹ä¼ºæœå™¨ä¸Š</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1"># æª”æ¡ˆ</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>ansible<span class="w"> </span>-i<span class="w"> </span>inventory<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>copy<span class="w"> </span>-k<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;src=/etc/motd dest=/etc/motd&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># è³‡æ–™å¤¾</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>ansible<span class="w"> </span>-i<span class="w"> </span>inventory<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>copy<span class="w"> </span>-k<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;src=/etc/yum.repos.d/ dest=/etc/yum.repos.d/&quot;</span>
</code></pre></div>
<p>ç‚ºä½•ä¸ä½¿ç”¨ Terraform? æ™®é Linux ä½œæ¥­ç³»çµ±éƒ½æ²’æœ‰ API å¯ä»¥è®“ä½ å‘¼å«ï¼Œæ‰€ä»¥ä¹Ÿè‡ªç„¶æ²’æœ‰ç›¸é—œæ¨¡çµ„å¯ä»¥ç”¨ï¼Œéƒ½æ˜¯æ»¿æ»¿çš„ CLI...</p>
<h4 id="windows"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#windows">Windows ä½œæ¥­ç³»çµ±</a></h4>
<div class="admonition tip">
<p class="admonition-title">Windows IaC å°ç­–</p>
<p><a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module">ansible.windows.win_command</a> + Ansible Collections + PowerShell Script</p>
</div>
<p>æ¡ç”¨é‚è¼¯è·Ÿç®¡ç† Linux ä½œæ¥­ç³»çµ±ä¸€æ¨£ï¼Œé€™é‚Šæä¾›å¹¾å€‹æˆ‘å¸¸ç”¨çš„ç¯„ä¾‹</p>
<ul>
<li><a href="https://github.com/pichuang/ansible-windows/blob/master/basic-allow-firewall.yaml">é‡å° Windows Firewall é–‹ ICMP request</a></li>
<li><a href="https://github.com/pichuang/ansible-windows/blob/master/copy-file.yaml">å‚³ç‰¹å®šæª”æ¡ˆåˆ°æ‰€æœ‰ Windows Server ä¸Š</a></li>
</ul>
<p>åªæ˜¯å› ç‚º Windows æ¬Šé™é è¨­é–‹å¾—å¾ˆä½ï¼Œåœ¨ä¸€é–‹å§‹ä½¿ç”¨çš„æ™‚å€™éœ€è¦å…ˆç‰¹åˆ¥æŠŠ Execution Policy è¨­å®šæˆ RemoteSignedï¼Œé€™æ¨£æ‰èƒ½è®“ Ansible é€é WinRM ä¾†åŸ·è¡Œ Powershell Script</p>
<div class="highlight"><span class="filename">set-remotesigned-policy.ps1</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Set-ExecutionPolicy RemoteSigned
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>Get-ExecutionPolicy
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>winrm quickconfig
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a># Enable WinRm Auth
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>winrm set winrm/config/service/auth &#39;@{Basic=&quot;true&quot;}&#39;
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a># Enable Allow Un-encrypt
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>winrm set winrm/config/service &#39;@{AllowUnencrypted=&quot;true&quot;}&#39;
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a># Verify WinRm Listener
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>winrm enumerate winrm/config/listener
</code></pre></div>
<p>ç‚ºä½•ä¸ä½¿ç”¨ Terraform? Windows åœ¨ä½œæ¥­ç³»çµ±å±¤ç´šä¸Šé›–èªªæœ‰ä¸€ç¥¨ API å¯ä»¥ç”¨ï¼Œä½†ç¾è¡Œæ²’äººé‡å° Windows æ’°å¯«å±¬æ–¼ä»–çš„ Terraform Providerï¼Œæˆ‘ç›¸ä¿¡ä»¥å¾Œä¹Ÿä¸æœƒæœ‰ã€‚ä½†å¦‚æœä½ æ˜¯èªª Hyper-v é–‹èµ·ä¾†çš„ç‹€æ³ï¼Œé‚£...é€™å€‹å°±æ˜¯å¦å¤–ä¸€å€‹è¨è«–äº†ï¼Œç¾è¡Œå…©é‚Šå®˜æ–¹æ˜¯æ²’æ”¯æ´å•¦...</p>
<h3 id="tldr"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#tldr">TL;DR</a></h3>
<ol>
<li>Terraform æ­å¹³å°æ ¹åŸº</li>
<li>Ansible ç®¡è‚šå­å’Œé»æœå‹™</li>
<li>GitHub Copilot + OpenAI ChatGPT ä¸Šé›™ Buff</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#qa">Q&amp;A</a></h3>
<h4 id="q1-shell-script-ansible"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q1-shell-script-ansible">Q1: è¦ç ”ç©¶ä¸€å€‹æ–°æœå‹™çš„æ™‚å€™ï¼Œæˆ‘æ‡‰è©²è¦å…ˆç”¨ Shell Script å¯«é‚„æ˜¯ Ansible æ¨¡çµ„å…œ?</a></h4>
<p>Shell Script å…ˆå¯«ï¼Œå› ç‚ºä½ æœƒæœ‰å¾ˆå¤§æ™‚é–“åœ¨ç ”ç©¶åˆ°åº•æ€éº¼æŠŠ CLI å…œèµ·ä¾†ï¼Œç­‰åˆ°å…œèµ·ä¾†ä¹‹å¾Œï¼Œå¦‚æœæœ‰éœ€è¦åˆ†äº«çµ¦å…¶ä»–äººåŸ·è¡Œçš„è©±ï¼Œå¯ä»¥æ”¹å¯«æˆ Ansible Playbookï¼Œæœƒæ›´å…·å¯è®€æ€§å’Œç¶­è­·æ€§</p>
<h4 id="q2-ansible-shell-script"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q2-ansible-shell-script">Q2: Ansible æ—¢ç„¶ä»€éº¼éƒ½å¯ä»¥åšï¼Œé‚£æ˜¯ä¸æ˜¯éƒ½ä¸ç”¨å­¸ Shell Script?</a></h4>
<p>ä¸ï¼ŒAnsible å¼·é …æ˜¯ Step by Step æµç¨‹æ§åˆ¶ï¼Œä½†å°æ–¼æ–‡å­—è™•ç†å’Œæª”æ¡ˆè™•ç†æˆ‘è¦ºå¾—è¶…ç´šå¼±ï¼Œè­¬å¦‚èªªä½ ç”¨ Ansible è™•ç† JSON/YAML æ ¼å¼è½‰æ›ä¿è­‰è½‰åˆ°åè¡€</p>
<p>è§£æ³•æ˜¯ç”¨ ansible.builtin.shell ç›´æ¥å‘¼å« Shell Scriptï¼Œç„¶å¾Œé‚£å€‹ Shell Script å¯ä»¥åœ¨è£¡é¢ç”¨ä½ å¸¸ç”¨çš„å·¥å…·åšæª”æ¡ˆè™•ç†</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Convert JSON to YAML using Shell Script</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="nt">json_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/input.json</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nt">yaml_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/output.yaml</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">covert_json_to_yaml.sh {{ json_file }} {{ yaml_file }}</span>
</code></pre></div>
<h4 id="q3-azureansible-ansibleazcollections-terraform"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q3-azureansible-ansibleazcollections-terraform">Q3: é‡å°ç®¡ç† Azureï¼ŒAnsible æ—¢ç„¶æœ‰ ansible.azcollectionsï¼Œé‚£ç‚ºä»€éº¼æˆ‘é‚„éœ€è¦ç”¨ Terraform ä¾†éƒ¨ç½²å‘¢?</a></h4>
<p>Ansible ä¸¦ä¸å…·å‚™è³‡æºç›¸ä¾æ€§è™•ç†èƒ½åŠ›ï¼Œå¦‚æœä½ éƒ¨ç½² AKS æœå‹™ï¼Œä½†ä½ æ²’æœ‰å…ˆæŠŠ VNet ä¹‹é¡çš„æœå‹™å…ˆå¼„å¥½ï¼Œä»–æ˜¯æ²’è¾¦æ³•çŸ¥é“é€™ä»¶äº‹ï¼Œä½† Terraform å¯ä»¥ï¼Œæ‰€ä»¥å¦‚æœä½ è¦ç”¨ Ansible å®Œæˆé¡åŒæ–¼ Terraform çš„äº‹æƒ…ï¼Œä½ å‹¢å¿…è¦èŠ±ä¸å°‘æ™‚é–“ç”¨ Azure CLI å…ˆç†è§£æ¯ä¸€æ­¥è³‡æºæ˜¯æ€éº¼è¢«å»ºç«‹èµ·ä¾†çš„ï¼Œç„¶å¾Œå†ç”¨ Ansible ä¾†å¯¦ä½œï¼Œæ™‚é–“æˆæœ¬ä¸å¤ªåˆï¼Œ</p>
<p>æ•…å€‹äººå»ºè­°å¯ä»¥å®šèª¿</p>
<ol>
<li>å¹³å°éƒ¨ç½² (Infrastucture Provisioning): Terraform</li>
<li>å¹³å°ç®¡ç† (Infrastructure Configurations): Ansible</li>
</ol>
<h4 id="q4-iac"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q4-iac">Q4: å¦‚æœåªæœ‰ä¸€å¥— IaC è¦é¸ï¼Œé¸å“ªå¥—?</a></h4>
<p>Ansible å§ï¼ŒAgenless ç‰¹æ€§å¯ä»¥å¾ˆç°¡å–®æŠŠä¸€å †å¥‡æ€ªæœå‹™åƒè† æ°´ä¸€æ¨£é»åœ¨ä¸€èµ·ï¼Œæ˜¯ä¸€å€‹è¬èƒ½è† ç­‰ç´š DSL</p>
<h4 id="q5-azure-3-azure-cliterraformansible"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q5-azure-3-azure-cliterraformansible">Q5: é‡å° Azureï¼Œèµ·ç¢¼æœ‰ 3 å€‹ä¸åŒçš„å·¥å…·å¯ä»¥é¸æ“‡ Azure CLIã€Terraformã€Ansibleï¼Œé‚£æˆ‘è¦æ€éº¼é¸?</a></h4>
<p>å…ˆ Terraformï¼Œå¯«ä¸å‡ºä¾†ç”¨ Azure CLI ç¡¬ä¸Šçœ‹çœ‹ï¼Œå¦‚æœè¦å°‡éç¨‹è‡ªå‹•åŒ–ï¼Œå†ç”¨ Ansible åŒ…èµ·ä¾†</p>
<p>ä¸»è¦åŸå› æ˜¯å› ç‚ºæ¨¡çµ„æ›´æ–°é »ç‡æ˜¯ REST API &gt; Azure CLI &gt; Terraform &gt;&gt;&gt; Ansible Collectionsï¼Œä½†å¤šæ•¸ç‹€æ³çš„ä½¿ç”¨å ´æ™¯éƒ½æ˜¯å¸¸è¦‹çš„æœå‹™ï¼Œæ‰€ä»¥å¯ä»¥ä»¥ Terraform ç‚ºä¸»ï¼Œå¤§å¤šæ•¸éƒ½æœ‰æ”¯æ´</p>
<h4 id="q6-docker-compose-iac"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q6-docker-compose-iac">Q6: é¡Œå¤–è©± docker-compose ç®—ä¸ç®— IaC å¯¦è¸çš„ä¸€ç’°?</a></h4>
<p>Yes. å¯é æ¸¬çµæœã€å¯é‡è¤‡æµç¨‹ã€å¯ç‰ˆæ§ç¨‹å¼ç¢¼ï¼Œæ˜¯ä¸€å€‹å¾ˆå¥½çš„ IaC å¯¦è¸</p>
<h4 id="q7-terraform-ansible-shell-script"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q7-terraform-ansible-shell-script">Q7: æˆ‘ä¸æœƒå¯« Terraform / Ansible / Shell Scriptï¼Œé‚£è¦æ€éº¼å¯«?</a></h4>
<p>æ‰¾å» å•†æœå‹™ (x)ï¼ŒGitHub Copilot ç”¨èµ·ä¾† (o)</p>
<p>GitHub Copilot èƒŒå¾ŒæŠ€è¡“æ˜¯ç”± OpenAI æ‰€æä¾›çš„ Codex æ¨¡å‹æ‰€æ”¯æ´çš„ï¼Œè€Œ Codex æ¨¡å‹æ˜¯åŸºæ–¼ GPT-3 æ‰€è¨“ç·´å‡ºä¾†çš„ï¼ŒGPT-3 æ˜¯ä¸€å€‹è‡ªç„¶èªè¨€è™•ç†æ¨¡å‹ï¼Œå¯ä»¥æ ¹æ“šè¼¸å…¥çš„æ–‡å­—æˆ– Commentsï¼Œè‡ªå‹•ç”¢ç”Ÿç¨‹å¼ç¢¼ï¼Œç›¸ç•¶å¼·æ‚å¥½ç”¨</p>
<p>ä½†å¯¦éš›ä¸Šä½ é‚„æ˜¯è¦å°é€™äº›èªè¨€æœ¬èº«è¦æœ‰ä¸€é»ç†è§£ï¼Œä¸ç„¶æœƒå¾ˆé›£åˆ¤æ–· GitHub Copilot å¯«å‡ºä¾†çš„æ±è¥¿åˆ°åº•æ˜¯å°é‚„æ˜¯éŒ¯</p>
<p>å¦‚æœçœŸçš„æƒ³è¦æœ‰å€‹ 24hr å°è€å¸«æ•™å­¸çš„è©±ï¼Œå°±æ˜¯è¦ç”¨ OpenAI ChatGPT äº†</p>
<h4 id="q8-ansible-puppet-saltstack-chef"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#q8-ansible-puppet-saltstack-chef">Q8: ä½ é€™éº¼æ¨ Ansibleï¼Œé‚£ Puppet / Saltstack / Chef æƒ…ä½•ä»¥å ª?</a></h4>
<p>æˆ‘å€‹äººå¤ªåƒ Agentless è¨­è¨ˆäº†ï¼Œå…¶ä»–ä¸‰å®¶å› ç‚ºéƒ½éœ€è¦å¡ Agent é€²å»ï¼Œæ‰€ä»¥å¾ˆæ—©æœŸå°±æ”¾æ£„ä¸å¤ªçœ‹</p>
<h3 id="references"><a class="toclink" href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/#references">References</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/overview">What is Azure Resource Manager?</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">hashicorp/terraform-provider-azurerm</a></li>
<li><a href="https://github.com/hashicorp/terraform-provider-azurerm/pull/20266">New Resource: azurerm_redhat_openshift_cluster #20266</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/azure/azcollection/index.html">Ansible - Azure.Azcollection</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/azure/azcollection/azure_rm_openshiftmanagedcluster_module.html">azure.azcollection.azure_rm_openshiftmanagedcluster module â€“ Manage Azure Red Hat OpenShift Managed Cluster instanceïƒ</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/03/01/%E9%81%B8%E6%93%87-iac-%E5%B7%A5%E5%85%B7%E6%98%AF%E5%A4%9A%E9%81%B8%E9%A1%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%96%AE%E9%81%B8%E9%A1%8C/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-14 00:00:00">February 14, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openai-kubernetes-7500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›æ‹›å–š Kubernetes 7500 å°ç¯€é»!!!</a></h2>
<p><img alt="" src="/images/OpenAI_Logo.png" /></p>
<details class="quote" open="open">
<summary>Quote</summary>
<p>å¾ 2018 èµ·ï¼ŒOpenAI æ‰€æ¡ç”¨çš„ Kubernetes ç¯€é»æ•¸é‡æ–¼ 3 å¹´å…§æˆé•· 300%</p>
</details>
<ul>
<li>2017 <a href="https://kubernetes.io/case-studies/openai/">Kubernetes Case Study - OpenAI</a></li>
<li>2018/01/18 OpenAI ç™¼å¸ƒ <a href="https://openai.com/blog/scaling-kubernetes-to-2500-nodes/">Scaling Kubernetes to 2500 Nodes</a></li>
<li>2021/01/18 OpenAI ç™¼å¸ƒ <a href="https://openai.com/blog/scaling-kubernetes-to-7500-nodes/">Scaling Kubernetes to 7500 Nodes</a></li>
</ul>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_1">å‰è¨€</a></h3>
<p>OpenAI æ–¼ 2021 å¹´çš„æ™‚å€™å·²ç¶“ä¾†åˆ° 7,500 ç¯€é»æ•¸é‡è¦æ¨¡äº†ï¼Œæ›´ä½•æ³ç¾åœ¨ 2023 å¹´æœ‰è¶…å¿«é€Ÿã€æ›´èª‡å¼µçš„å…¨çƒç¸½é«”ä½¿ç”¨é‡ï¼Œæ ¹æœ¬æ˜¯ HPC/AI/ML on Kubernetes æ–¼ä¸€èº«æœ€ä½³æ¶æ§‹å…¸ç¯„ï¼Œå¦‚æœä½ å°é€™ç¨®è¶…å¤§è¦æ¨¡çš„ Kubernetes æœ‰èˆˆè¶£çš„è©±ï¼Œå‹™å¿…è¦æŠŠä¸Šé¢çš„æ–‡ç« éƒ½çœ‹éå¥½å¹¾éï¼Œå¯ä»¥é¿å…è¸©åˆ°åœ°é›·ï¼Œç•¢ç«Ÿ...é‚£äº›éƒ½æ˜¯ OpenAI ç”¨éˆ”èƒ½åŠ›æ›ä¾†çš„è¡€æ·šç¶“é©—å•Š...</p>
<p>é›–ç„¶æ²’æœ‰ç‰¹åˆ¥æåŠï¼Œä½†å°±æ–‡ç« è£¡é¢æè¿°çš„å…§å®¹ï¼Œæ‡‰è©²æ˜¯ç”¨ Azure Kubernetes Service (with Azure CNI) ä½œç‚ºåŸºåº•ï¼Œä¸‹é¢æœƒæœ‰ä¸€å€‹ç« ç¯€å°ˆé–€è¬› Azure Kubernetes Service çš„é—œéµè³‡è¨Šï¼Œæ•™å¤§å®¶æ€éº¼ç®— Pod / Node / Subnet æ•¸é‡å¤§å°</p>
<h3 id="tldr-openai-kubernetes-3"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#tldr-openai-kubernetes-3">TL;DR: OpenAI æ¡ç”¨ Kubernetes ä¸»è¦ 3 å¤§æ•ˆç›Š</a></h3>
<ol>
<li>æ˜“æ¬é· (Portability): åŸºæ–¼åŸºç¤æ¶æ§‹å³ä»£ç¢¼ (Infrastructure as Code, IaC)ã€Kubernetes ä¸€è‡´çš„ä¸”è²æ˜å¼ API (Consistent &amp; Declarative API)ã€å®¹å™¨æ˜ åƒæª”ä¸å¯è®Šå‹•æ€§ (Container Immutable Image) 3 å€‹ç‰¹æ€§ï¼Œè®“ä½ å¯ä»¥åœ¨ä¸åŒçš„é›²ç«¯å¹³å°ä¸Šé‹è¡Œä½ çš„é›²åŸç”Ÿç¨‹å¼</li>
<li>çœæˆæœ¬ (Cost Savings): åœ¨ä¸åŒé–‹ç™¼æƒ…å¢ƒçš„æ™‚å€™ï¼Œå¯ä»¥å®¹æ˜“ç§»å‹•ä½ çš„è³‡æºï¼Œä¾‹å¦‚ï¼šåœ¨é–‹ç™¼éšæ®µå¯ä»¥ä½¿ç”¨æœ¬åœ°çš„ Kubernetes ç’°å¢ƒï¼Œå¦‚ minikube, kind, kubeadm, Docker Desktop ç­‰ï¼Œè€Œåœ¨ç”Ÿç”¢éšæ®µå‰‡å¯ä»¥ä½¿ç”¨å¤§è¦æ¨¡ä¸”å—æ”¯æ´çš„ Kubernetes ç’°å¢ƒï¼Œå¦‚ Azure Kubernetes Service ç­‰ï¼Œå’Œ Kubernetes Cluster Autoscaler (CA) è‡ªå‹•èª¿æ•´é›†ç¾¤å¤§å°ï¼é€éå½ˆæ€§é¸æ“‡é©ç•¶çš„ç’°å¢ƒï¼Œé™ä½æ•´é«”æˆæœ¬ï¼Œæå‡åˆ©ç”¨ç‡ï¼Œç²å¾—æ›´å¤šç¡¬é«”è¨ˆç®—è³‡æº</li>
<li>å¢æ•ˆç‡ (Improved Efficiency): ä¸€åé–‹ç™¼åˆ†æ•£å¼ç³»çµ±ç³»çµ±çš„ç ”ç©¶å“¡ï¼Œå¯ä»¥åœ¨ 2 ~ 3 å¤©å…§è®“ä»–çš„ç¨‹å¼æ­£ç¢ºçš„é‹è¡Œï¼Œ1 ~ 2 é€±å¾Œå°±å¯ä»¥æ“´å¼µåˆ°å¥½å¹¾ç™¾å€‹ GPU ç¯€é»ï¼Œç›¸è¼ƒæ–¼ä»¥å‰å‰‡æ˜¯éœ€è¦ä»¥æœˆç‚ºå–®ä½çš„å·¥ä½œæ™‚é–“ï¼Œä¿æŒé–‹ç™¼å¿«é€Ÿè¿­ä»£çš„æ•ˆç›Š</li>
</ol>
<h3 id="openai-2500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#openai-2500">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›: 2,500 ç¯€é»è¦æ¨¡</a></h3>
<p>åŸºæ–¼ <a href="https://openai.com/blog/scaling-kubernetes-to-2500-nodes/">Scaling Kubernetes to 2500 Nodes</a>ï¼Œå»ºè­°å¯ä»¥åƒè€ƒ <a href="https://www.evanlin.com/til-openai-5000/">Evan Lin - Scaling Kubernetes to 2,500 Nodes</a> çš„æ–‡ç« æ•´ç†</p>
<h3 id="openai-7500"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#openai-7500">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›: 7,500 ç¯€é»è¦æ¨¡</a></h3>
<p>ä¸‹é¢ç”±æˆ‘å€‹äººåŸºæ–¼ <a href="https://openai.com/blog/scaling-kubernetes-to-7500-nodes/">Scaling Kubernetes to 7500 Nodes</a> çš„æ–‡ç« æ•´ç†äº†ä¸‹åˆ—å¯ä»¥åƒè€ƒçš„å­¸ç¿’é»ï¼Œå¦å¤–è²æ˜ï¼Œé€™ä¸æ˜¯ç”¨ ChatGPT å¹«æˆ‘æ•´ç†çš„</p>
<ul>
<li>
<p>è¨ˆç®—ç›¸é—œ</p>
<ul>
<li>é‹è¡Œ MPI Jobs: ä»¥ MPI ä½œç‚ºèª¿åº¦åŸºç¤ï¼Œè€Œéå¤§é‡åˆ©ç”¨ Kubernetes å…§å»ºä¹‹ Scheduler</li>
<li>æœ€å¸¸è¦‹éŒ¯èª¤ç‚º Uncorrectable ECC error</li>
</ul>
</li>
<li>
<p>GPU ç›¸é—œ</p>
<ul>
<li>GPU é–“é€šè¨Šå¼·åŒ–: åˆ©ç”¨ <a href="https://www.nvidia.com/zh-tw/data-center/nvlink/">NVIDIA NVlink</a> äº¤å‰é€šè¨Šå’Œ <a href="https://docs.nvidia.com/cuda/gpudirect-rdma/">GPUDirect RDMA</a> èˆ‡ NIC ç›´æ¥é€šè¨Šä½¿æ•´é«”ç³»çµ±è¼¸é€é‡æ¥µå¤§åŒ–</li>
<li>å¤šæ•¸ 1 å€‹ç¯€é»æ”¾ 1 å€‹ Pod: å›  CPU / NUMA / PCI-E / Physical Server / Bandwidth ä¸¦éèª¿åº¦è³‡æºçš„ä¸»å› ï¼Œèª¿åº¦å£“åŠ›æ¥µä½ï¼Œä¸»è¦æ˜¯ GPU è³‡æº</li>
</ul>
</li>
<li>
<p>ç¶²è·¯ç›¸é—œ</p>
<ul>
<li>ç°¡åŒ–ç¶²è·¯è¤‡é›œæ€§: Pod å¯ä»¥ç›´æ¥é€é SSH é€£ç·šåˆ° Pod IP é€²è¡Œé€£ç·šï¼Œè€Œé Service Endpoint</li>
<li>Flannel CNI åœ¨å¤§è¦æ¨¡ä¸Šä½¿ç”¨æœƒæœ‰ Throughput å•é¡Œ</li>
<li>å¤§é‡æ¡ç”¨ iptables mangle è¦å‰‡: å°æµé‡æ–¹å‘é€²è¡Œæ¨™è¨˜ï¼Œä»¥ä¾¿é€²è¡Œæµé‡æ§åˆ¶ï¼Œè€Œéæ¡ç”¨ä¸€æ¢ä¸€æ¢è·¯ç”±è¦å‰‡ç®¡ç†</li>
<li>æ¡ç”¨ Prometheus çš„ iptables-exporter ä½œç‚ºç¶²è·¯æµé‡è¿½è¹¤åŸºç¤</li>
<li>æ¡ç”¨ Hub and Spoke ç¶²è·¯æ¶æ§‹: ç ”ç©¶äººå“¡å¯ä»¥å¾ Hub æœå‹™è¨ªå•åˆ°ä»»ä½• Spoke çš„æœå‹™ï¼Œå¦‚ AKS ç­‰ï¼Œä½†ä»»æ„ 2 å€‹ Spoke è£¡çš„ AKS æœå‹™å‰‡å›  Azure Virtual Network åŸç”Ÿä¸å…·å‚™è·¨ VNet Transit èƒ½åŠ›ï¼Œå‰‡ç„¡æ³•äº’ç›¸é€£æ¥ï¼Œä¿æŒæ•…éšœéš”é›¢åŸå‰‡ (Break Failure Isolation)</li>
<li>æ¡ç”¨è‡ªå»º NAT æœå‹™è™•ç† inbound DNAT æµé‡</li>
<li>å€‹åˆ¥ Pod ç¶²è·¯æµé‡åŠ ç¸½èµ·ä¾†ç›¸ç•¶é©šäºº</li>
</ul>
</li>
<li>
<p>å„²å­˜ç›¸é—œ</p>
<ul>
<li>æ¡ç”¨ Azure Blob Storage ä½œç‚ºä¸»è¦å„²å­˜ç³»çµ±: å› ç‚º Azure Blob Storage æ˜“æ–¼æ“´å±•ï¼Œä¸”ä¸éœ€è¦ slow detach/attach çš„é¡å¤–æ“ä½œ</li>
</ul>
</li>
<li>
<p>Kubernetes ç›¸é—œ</p>
<ul>
<li>ç„¡é€²è¡Œé etcd self-healing automationï¼Œæœ€å¤§çš„é›†ç¾¤å–®ç¨é‹è¡Œ 5 å€‹ API Server å’Œ 5 å€‹ etcd ç¯€é»</li>
<li>ç¯€é»æ•¸é‡å¤šï¼Œå°è‡´ API Server è¨˜æ†¶é«”åƒé‡: åŸºæ–¼ 7500 å°ç¯€é»é›†ç¾¤ï¼Œæ¯å€‹ API Servers éœ€è¦ 70GB çš„è¨˜æ†¶é«”</li>
<li>API Server å£“åŠ›æœ€å¤§ä¾†æºæ˜¯ Endpoints ä¸Šçš„ WATCH</li>
<li>Cluster Autoscaler æƒ…å¢ƒæ¸›å°‘ï¼Œå› ç‚ºé›†ç¾¤å·²ç¶“å¾ˆå¤§äº†</li>
<li>é‡å°åœ˜éšŠè³‡æºåˆ†é…å¯¦åš team-resource-manager</li>
<li>æ¡ç”¨ CPU &amp; GPU Balloons è®“ Cluster Autoscaler ä¸æœƒèªç‚ºç¯€é»é–’ç½®è€Œé€²è¡Œç§»é™¤ï¼Œé¿å…ç”¢ç”Ÿä¸å¿…è¦çš„èª¿åº¦å£“åŠ›</li>
<li>æ¡ç”¨ <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity">Pod Anti-affinity</a> ç¢ºä¿ Pod æœ€çµ‚æœƒè¢«å¹³å‡åœ°åˆ†ä½ˆåˆ°å„å€‹ç¯€é»ä¸Š</li>
<li>æ¡ç”¨ <a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/pkg/coscheduling/README.md">Coscheduling</a> æ‰¹æ¬¡è™•ç†ï¼Œé¿å… all or nothing çš„æƒ…æ³</li>
</ul>
</li>
<li>
<p>Monitoring ç›¸é—œ</p>
<ul>
<li>æ¡ç”¨ Promeheus å’Œ Grafana ä½œç‚ºç›£æ§ç³»çµ±</li>
<li>æ¡ç”¨ <a href="https://github.com/coreos/kube-prometheus">kube-prometheus</a>: å°æ–¼ HTTP 429 (Too Many Requests) å’Œ 5XX (Server Error) ç™¼é€è­¦å ±ç›¸ç•¶æœ‰æ•ˆæœ</li>
<li>æ¡ç”¨ <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config">Prometheus relabel</a> åŠŸèƒ½ï¼Œé¿å…æ”¶é›†åˆ°ä¸å¿…è¦çš„ Metricsï¼Œé™ä½å£“åŠ›</li>
<li>æ¡ç”¨ GOMAXPROCS=24 æ¸›ç·© WAL (Write-Ahead Log) é‡æ–°åŸ·è¡Œæ¬¡æ•¸</li>
<li>æ¡ç”¨ <a href="https://github.com/NVIDIA/gpu-monitoring-tools#dcgm-exporter">dcgm-exporter</a>ï¼Œè¨­å®š DCGM_FI_DEV_XID_ERRORSï¼ŒæŠ“å– XID Errorsï¼Œä¸¦ç™¼é€è­¦å ±</li>
<li>æ¡ç”¨ <a href="https://docs.nvidia.com/deploy/nvml-api/group__nvmlDeviceQueries.html#group__nvmlDeviceQueries">NVMLDevice Query API</a>: æä¾›æœ‰é—œ GPU çš„å¥åº·æƒ…æ³å’Œæ“ä½œçš„æ›´è©³ç´°ä¿¡æ¯</li>
<li>ä¸¦éæ‰€æœ‰ GPU éŒ¯èª¤éƒ½å¯ä»¥å¾ DCGM çœ‹åˆ° Error Code</li>
<li>Promtheus è‡ªå¸¶çš„ TSDB (Time Series Database) ä¸¦éæœ€ä½³é¸æ“‡ï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œé‡å•Ÿéœ€è¦å¾ˆé•·æ™‚é–“é‡æ–°åŸ·è¡Œ WAL</li>
</ul>
</li>
</ul>
<h3 id="_2"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_2">å€‹äººè§€é»</a></h3>
<ol>
<li>æ¯«ç„¡ç–‘å• Kubernetes æ¶æ§‹è¨­è¨ˆçš„ç¢ºé©åˆåšç‚ºå¤§è¦æ¨¡è¨ˆç®—éœ€æ±‚çš„åŸºç¤å¹³å°</li>
<li>æ¡ç”¨ Kubernetes ä¾ç„¶æœƒéœ€è¦è™•ç†ä¸å°‘æŠ€è¡“å•é¡Œï¼Œå¦‚ç¶²è·¯ã€ç›£æ§ã€è³‡æºèª¿åº¦ç­‰ï¼Œä¸¦ä¸æ˜¯åŸç”Ÿè¨­è¨ˆå°±èƒ½è§£æ±ºæ‰€æœ‰å•é¡Œ</li>
<li>é™¤ç‰¹å®šç”¢æ¥­ä»¥å¤–ï¼Œå°ç£å¤§å¤šæ•¸ä¼æ¥­å–®åº§ Kubernetes å¤šåŠéƒ½æ˜¯ä½æ–¼ 25 å°ç¯€é»é€™å€‹æ•¸é‡ç´šè·ï¼Œè‹¥æ˜¯æœ‰é¸æ“‡ç‰¹å®šå» å•†æ”¯æ´çš„ Kubernetes å¤šåŠä¸å¤ªæœƒé‡åˆ°ä¸Šé¢çš„å•é¡Œï¼Œå¦‚æœæ“”å¿ƒä¼°ç®—ä¸å¤ çš„è©±ï¼Œå€‹äººå»ºè­° Control Plane çš„ç¯€é»å¤§å°è¨ˆç®—å¯ä»¥ä»¥ 100 å°ç¯€é»æ‰¿è¼‰é‡åšç‚ºåŸºæº–ï¼Œä¸ç”¨ä»¥ 7,500 é€™å€‹è¦æ¨¡ç•¶ä½œåŸºç¤åƒè€ƒ</li>
<li>Control Plane é¡§å¾—å¥½ï¼Œæ™šä¸Šç¡è¦ºç¡å¾—è‘—</li>
<li>é€™æ–‡ç« æ²’ç‰¹åˆ¥è¬› Underlay Networking è¨­è¨ˆï¼ŒåŸºæ–¼å·²çŸ¥ Azure æ©Ÿæˆ¿ç¶²è·¯è¦åŠƒæ‡‰è©²æœƒæ˜¯ä»¥ Spine-Leaf Topology ç‚ºè¨­è¨ˆåŸºç¤ï¼Œä½†å…·é«” Switch æ˜¯ç”¨ä»€éº¼å°±ä¸çŸ¥é“äº†ï¼Œä¸»è¦åŸå› æ˜¯å› ç‚º GPUDirect RDMA éœ€è¦ Switch æ”¯æ´èƒ½åŠ›</li>
<li>æ‰¹æ¬¡è¨ˆç®—è™•ç†åŠè³‡æºåˆ†é…æ”ªå’Œåœ¨ä¸€èµ·ï¼Œæ˜¯ä¸€å€‹å¾ˆé‡è¦çš„ç ”ç©¶è­°é¡Œ</li>
</ol>
<h3 id="azure-kubernetes-sevices"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-kubernetes-sevices">Azure Kubernetes Sevices ä½ æ‡‰è©²è¦çŸ¥é“çš„é—œéµè³‡è¨Š</a></h3>
<details class="info" open="open">
<summary>Info</summary>
<p>2023/02/14 æ›´æ–°</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/quotas-skus-regions">Quotas, virtual machine size restrictions, and region availability in Azure Kubernetes Service (AKS)</a> æä¾›é—œéµè³‡è¨Šå¦‚ä¸‹:</p>
<p>ä»¥æ¡ç”¨ Azure Standard Load Balancer åŠ Standard Tier ç‚ºä¸»,</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Limit</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ–¼å–®ä¸€é›†ç¾¤å…§ä¹‹æœ€å¤§ç¯€é»æ•¸</td>
<td>ä¸Šé™ 5000 å°ç¯€é»ï¼Œç³»çµ±é è¨­ 1000 å°ç¯€é»</td>
</tr>
<tr>
<td>æ–¼å–®ä¸€ç¯€é»å…§ä¹‹æœ€å¤§ Pod æ•¸ ï¼ˆCNI æ¡ç”¨ kubenet)</td>
<td>æœ€å¤§ 250 å€‹ï¼Œç³»çµ±é è¨­ 110 å€‹</td>
</tr>
<tr>
<td>æ–¼å–®ä¸€ç¯€é»å…§ä¹‹æœ€å¤§ Pod æ•¸ ï¼ˆCNI æ¡ç”¨ Azure CNI)</td>
<td>æœ€å¤§ 250 å€‹ï¼Œç³»çµ±é è¨­ 30 å€‹</td>
</tr>
</tbody>
</table>
<h4 id="pod"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#pod">é—œæ–¼æœ€å¤§ Pod æ•¸é‡</a></h4>
<p>åŸºæ–¼ä¸Šé¢æ•¸æ“šå¯ä»¥æ›ç®—å‡º <mark>å–®ä¸€ AKS é›†ç¾¤å—æ”¯æ´çš„ç‹€æ³ä¸‹ï¼Œæœ€å¤šçš„ Pod æ•¸ç‚º 1,250,000 Pods</mark> ï¼ˆ= 5000 å€‹ç¯€é» * 250 å€‹ Pod)ï¼Œä½†é€™å€‹æ•¸å­—æ˜¯ä¼°ç®—å€¼ï¼Œå› ç‚ºå¯¦éš›å¯ç”¨ Pod æ•¸é‡æœƒå—åˆ°å¯¦éš›è¨ˆç®—è³‡æºåˆ†é…ã€Kubernetes Deployment æ’°å¯«æ–¹å¼ç­‰å› ç´ å½±éŸ¿</p>
<p>å¯¦å‹™ä¸Šï¼Œå–®ä¸€ç¯€é»ä¸Š Pod æ•¸é‡è¨­è¶…å¤§ï¼Œè€å¯¦èªªæ²’ä»€éº¼ç‰¹åˆ¥ç”¨è™•ï¼Œå¯èƒ½ä¸€å…©å€‹ Pod å°±æŠŠæ•´å€‹ç¯€é»è³‡æºåƒå®Œäº†ï¼Œçœ‹çœ‹ OpenAI çš„ç”¨æ³•ä¹Ÿæ˜¯ä¸€æ¨£ï¼Œ1 å€‹ç¯€é» 1 å€‹ Podï¼Œå› ç‚ºé—œéµç“¶é ¸åœ¨æ–¼ GPU è³‡æºï¼Œå¦‚æœä½ æƒ³è¦ç²¾ç®—çš„è©±ï¼Œå»ºè­°å¯åƒè€ƒä¹‹å‰çš„æ–‡ç«  <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a> é€²è¡Œç²¾ç´°è¨ˆç®—</p>
<h4 id="azure-subnet"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-subnet">é—œæ–¼ Azure Subnet è¨ˆç®—</a></h4>
<p>Kubernetes è¨­è¨ˆæœ€éº»ç…©çš„å°±æ˜¯ç¶²è·¯è¦åŠƒï¼Œå› ç‚ºå®ƒæ˜¯éƒ¨ç½²å¾Œä¸èƒ½æ”¹çš„åƒæ•¸ï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²ä¹‹å‰ä¸€å®šè¦å…ˆç®—å¥½ï¼Œé¿å…å¾ŒçºŒæ“´å……æœ‰å•é¡Œï¼è€Œæ¡ç”¨ä¸åŒ Kubernetes CNI æœƒå½±éŸ¿åˆ° Subnet è¨ˆç®—ï¼Œä¸‹é¢ä»¥ç¾è¡Œ AKS æ”¯æ´çš„ 2 ç¨® CNI ä¾†åšè¨ˆç®—ï¼š</p>
<ol>
<li>æ¡ç”¨ kubenet CNI</li>
<li>æ¡ç”¨ Azure CNI</li>
</ol>
<p>è‹¥ä½ å°æ–¼å…©è€… CNI æœ‰èˆˆè¶£æ¯”è¼ƒçš„è©±ï¼Œå¯ä»¥åƒè€ƒæ­¤æ–‡ <a href="https://learn.microsoft.com/en-us/azure/aks/concepts-network#compare-network-models">AKS - æ¯”è¼ƒç¶²è·¯æ¨¡å‹</a>ï¼Œé€™é‚Šä¸å†è´…è¿°</p>
<h5 id="kubenet-cni"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#kubenet-cni">æ¡ç”¨ kubenet CNI</a></h5>
<details class="note" open="open">
<summary>Note</summary>
<p>è‹¥æ¡ç”¨ kubenet CNI çš„è©±ï¼ŒPod ä¸æ”¯æ´ç›´æ¥å¾ Azure Subnet æ‹¿åˆ° IPï¼Œä¸­é–“æœƒé iptables é€²è¡Œ SNAT è½‰æ›</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/configure-azure-cni#plan-ip-addressing-for-your-cluster">Use kubenet networking with your own IP address ranges in Azure Kubernetes Service (AKS)
 - IP address availability and exhaustion</a> æ–‡ä»¶ï¼Œå› ç‚ºé€²è¡Œ AKS å‡ç´šçš„æ™‚å€™ï¼Œæœƒæ¡ç”¨å…ˆå»ºå¾Œæ‹†çš„æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦é ç•™ä¸€å€‹ç¯€é»çš„ IP ç©ºé–“ä¾›ä½¿ç”¨ï¼Œæ‰€ä»¥æ­£ç¢ºçš„ç¯€é»è¨ˆç®—åŸºç¤æœƒæ˜¯ <code>No. of Nodes + 1</code></p>
<p>ä¸‹åˆ—æä¾›è¨ˆç®—å…¬å¼</p>
<mark class="critic block">
<p>Minimum Subnet Size = Node IP = No. of Nodes + 1</p>
</mark>
<p>è©¦ç®— 1ï¼šä¸€åº§å…·å‚™ 50 å€‹ç¯€é»çš„ AKS æ¡ç”¨ kubenet CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 51 å€‹ = (50 å€‹ç¯€é» + 1)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /26ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 59 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 51</p>
<p>è©¦ç®— 2: ä¸€åº§å…·å‚™ 5,000 å€‹ç¯€é»çš„ AKS æ¡ç”¨ kubenet CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 5,000 å€‹ = (4999 å€‹ç¯€é» + 1)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /19ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 8,187 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 5,000</p>
<h5 id="azure-cni"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-cni">æ¡ç”¨ Azure CNI</a></h5>
<details class="note" open="open">
<summary>Note</summary>
<p>è‹¥æ¡ç”¨ Azure CNI çš„è©±ï¼Œæ¯ä¸€å€‹ Pod éƒ½èƒ½æ‹¿åˆ° Azure Subnet åˆ†é…åˆ°çš„ IPï¼Œèˆ‡å…¶å®ƒ Pod é€²è¡Œæºé€šæ™‚ä¸æœƒæœ‰é¡å¤–çš„ SNAT è½‰æ›æˆæœ¬</p>
</details>
<p>åŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/aks/configure-azure-cni#plan-ip-addressing-for-your-cluster">Configure Azure CNI networking in Azure Kubernetes Service (AKS) - Plan IP addressing for your cluster</a> æ–‡ä»¶ï¼Œå› ç‚ºé€²è¡Œ AKS å‡ç´šçš„æ™‚å€™ï¼Œæœƒæ¡ç”¨å…ˆå»ºå¾Œæ‹†çš„æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦é ç•™ä¸€å€‹ç¯€é»çš„ IP ç©ºé–“ä¾›ä½¿ç”¨ï¼Œæ‰€ä»¥æ­£ç¢ºçš„ç¯€é»è¨ˆç®—åŸºç¤æœƒæ˜¯ <code>No. of Nodes + 1</code></p>
<p>æ•…ä¸‹åˆ—æä¾›ä¸€å€‹åˆç†çš„è¨ˆç®—å…¬å¼</p>
<mark class="critic block">
<p>Minimum Subnet Size = Node IP + Pod IP = (No. of Nodes + 1) + ((No. of Nodes + 1) * Maximum pods per nodes that you can configure)</p>
</mark>
<p>è©¦ç®— 1ï¼šä¸€åº§å…·å‚™ 50 å€‹ç¯€é»çš„ AKS æ¡ç”¨ Azure CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 12,801 å€‹ = (50 å€‹ç¯€é» + 1) + ((50 å€‹ç¯€é» + 1) * 250 Pods)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /18ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 16379 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 12,801</p>
<p>è©¦ç®— 2: ä¸€åº§å…·å‚™ 5000 å€‹ç¯€é»çš„ AKS æ¡ç”¨ Azure CNI</p>
<p>æœ€å°å¯ç”¨ IP éœ€æ±‚ç‚º 1,255,000 å€‹ = (4999 å€‹ç¯€é» + 1) + ((4999 å€‹ç¯€é» + 1) * 250 Pods)
åŸºæ–¼ <a href="https://blog.pichuang.com.tw/azure-subnets.html">Visual Subnet Calculator (Azure Edition)</a>ï¼Œå¯ä»¥è¨ˆç®—å‡ºæœ€å° Subnet ç‚º /11ï¼Œç¶²æ®µå¯ç”¨ IP æ•¸é‡ç‚º 2,097,147 å€‹ï¼Œè©²æ•¸å­—å¤§æ–¼éœ€æ±‚ 1,255,000</p>
<h4 id="azure-vm"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#azure-vm">é—œæ–¼ Azure VM å¤§å°</a></h4>
<ul>
<li>Azure VM å¤§å°ä¸èƒ½ä½æ–¼ 2 vCPUï¼Œä½æ–¼çš„è©±æœƒä¸èƒ½æ­£å¸¸é‹ä½œï¼Œè©³ç´° Azure Siez å¯åƒè€ƒ <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes">Azure Virtual Machines sizes</a></li>
<li>Container Images å¤§å°æœƒå½±éŸ¿åˆ° Kubernetes Node çš„å¤§å°ï¼Œç•¶æœ‰éå¤§çš„ Container Imagesï¼Œkubelet æœƒå› ç‚ºæ²’æœ‰è¶³å¤ çš„ç¡¬ç¢Ÿç©ºé–“è€Œç„¡æ³•æ­£å¸¸é‹ä½œï¼Œé€™å€‹åœ¨è·‘ AI æ¨¡çµ„å¯¦é©—çš„æ™‚å€™æœƒæ¯”è¼ƒå¸¸é‡åˆ°ï¼Œå› ç‚º AI æ¨¡çµ„çš„å®¹å™¨æ˜ åƒæª”é€šå¸¸éƒ½æœƒå¾ˆå¤§ï¼Œå¯åƒè€ƒ <a href="https://catalog.ngc.nvidia.com/containers">NVIDIA NGC Container Catalog</a> æ‰€æä¾›çš„å®¹å™¨æ˜ åƒæª”å¤§å°</li>
</ul>
<h3 id="_3"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_3">ç¸½çµ</a></h3>
<p>æœ‰äº›äº‹æƒ…åªèƒ½æ“æœ‰éˆ”èƒ½åŠ›æ‰æœƒçŸ¥é“</p>
<h3 id="_4"><a class="toclink" href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/#_4">æ„Ÿè¬æ ¡ç¨¿</a></h3>
<ul>
<li><a href="https://linktr.ee/hwchiu">@hwchiu</a></li>
<li><a href="https://www.evanlin.com/">@Evan Lin</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/02/14/%E7%9C%8B-openai-%E4%BD%BF%E7%94%A8%E9%88%94%E8%83%BD%E5%8A%9B%E6%8B%9B%E5%96%9A-kubernetes-7500-%E5%8F%B0%E7%AF%80%E9%BB%9E/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-10 00:00:00">February 10, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/azure/" class="md-meta__link">azure</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-vm"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/">è®“ Azure VM å°å¤–é€£ç·šçš„å¤šç¨®èŠ±æ¨£</a></h2>
<p>æˆ–è¨±æœ‰äº›è®€è€…çŸ¥é“å°å¼Ÿä»¥å‰æ˜¯å°ˆæåœ°ç«¯ Infra æœå‹™çš„æ¶æ§‹å¸«ï¼Œèˆˆè¶£å°±æ˜¯å°ˆé–€çœ‹ Networking å’Œä»–ç›¸é—œé€£çš„æœå‹™ï¼Œæœ€è¿‘ä¾†åˆ°é›²ç«¯ä¹‹å¾Œï¼Œåªèƒ½èªªé›–ç„¶çœ‹èµ·ä¾†éƒ½æ˜¯ä¸€å° VM é€£ç·šå‡ºå»åˆ° Internetï¼Œä½†å¯¦éš›ä¸Šçœ‰è§’é‚„è »å¤šçš„...å€’æ˜¯å¦‚æœä½ æ˜¯åœ°ç«¯ç¶²è·¯å·¥ç¨‹å¸«çš„è©±ï¼Œå‰›æ¥è§¸ Azure ç¶²è·¯çš„è©±ï¼Œè »æ¨è–¦åŸºç¤å…ˆå¾ <a href="https://learn.microsoft.com/en-us/training/paths/design-implement-microsoft-azure-networking-solutions-az-700/">AZ-700 Designing and Implementing Microsoft Azure Networking Solutions</a> é–‹å§‹è‘—æ‰‹ï¼Œä¿è­‰ä½ å¯ä»¥ç ”ç©¶å¾ˆä¹…</p>
<p>å¦å¤–è¦ç‰¹åˆ¥æ„Ÿæ©åœ‹å¤–çš„å¤§ç¥ Toni Pasanen å¯«äº†ä¸€å †æ–‡ç« è®“æˆ‘æ›´æ¸…æ¥šç­è§£ Azure Networking æ¶æ§‹ <a href="https://nwktimes.blogspot.com/2023/01/Azure-Inet-Access.html">Toni Pasanen - Azure Networking Fundamentals: Internet Access with VM-Specific Public IP</a> ä¸€åœ–è§£é‡‹ Azure VM å°å¤–ç¶²è·¯é€£ç·šæ–¹å¼ï¼Œå¼·çƒˆæ¨è–¦çµ¦å¤§å®¶</p>
<p><img alt="" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPrrkanlUV66RmLukg_zajo1HRz2Mwtq108uPdWZ_uamYqWXmaoWdt1SSOKkH_jH036LzkpeaDklfeBJmBb3DQeBixjAOI35TV3AYD_iDEjpa7To2LDIXZmiaqiZLdgZJGcOL1S6-AvhfyT4EBuYtkS4_xN_pXdqMJ6VyJPgTg0ok7tbPOL2pYk3m_/w640-h310/1-new.jpg" /></p>
<!--more-->

<h3 id="inbound-traffic-outbound-traffic"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#inbound-traffic-outbound-traffic">Inbound Traffic å’Œ Outbound Traffic</a></h3>
<p>å…ˆäº†è§£ä¸€ä¸‹ç”¨è©å®šç¾©</p>
<ul>
<li>Inbound Traffic: ç‰¹å®š Azure VM å¯ä»¥æ¥æ”¶ä¾†è‡ª Internet çš„é€£ç·šï¼Œæ–¼ Azure å¯¦éš›ä¸Šçš„åšæ³•ï¼Œä¸å¤–ä¹ DNAT (Destination NAT)ã€ 1 to 1 NAT æˆ–ç›´æ¥å¾ Internet è·¯ç”±é€²ä¾†</li>
<li>Outbound Traffic: ç‰¹å®š Azure VM å¯ä»¥ç™¼é€é€£ç·šåˆ° Internetï¼Œæ–¼ Azure å¯¦éš›ä¸Šçš„åšæ³•å°±æ˜¯ SNAT (Source NAT) æˆ–ç›´æ¥è·¯ç”±åˆ° Internet</li>
</ul>
<p>æœ¬æ–‡æœƒè‘—é‡è¨è«– Outbound Traffic çš„ç‹€æ³</p>
<h3 id="azure-public-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#azure-public-ip">äº†è§£ Azure Public IP èƒ½å¤ çš„åˆ†é…ç¨®é¡</a></h3>
<p>ä¾æ“š <a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses#at-a-glance">Public IP addresses - At a glance</a> æŒ‡å‡ºï¼Œè‹¥ä½ çš„ Azure VM Instance å‰é¢æœ‰ <mark>Azure æœå‹™ä¸”å…·æœ‰ Azure Public IP</mark> çš„è©±ï¼Œæ˜¯å…·å‚™å¾ VM ç™¼é€é€£ç·šåˆ° Internet æˆ–é€£ç·šé€²ä¾†çš„èƒ½åŠ›ï¼Œä¸‹åˆ—æ¢åˆ—å¸¸è¦‹æœå‹™ä½†ä¸é™æ–¼:</p>
<table>
<thead>
<tr>
<th>Componets</th>
<th style="text-align: center;">IPv4 Static æŒ‡æ´¾</th>
<th style="text-align: center;">IPv4 Dynamic æŒ‡æ´¾</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure Firewall</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>Azure NAT Gateway</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>Azure Route Server</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>Azure Bastion</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>Azure Application Gateway</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /> (v2 only)</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /> (v1 only)</td>
</tr>
<tr>
<td>Azure Virtual Network Gateway</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
</tr>
<tr>
<td>Azure Load Balancer (Public)</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
</tr>
<tr>
<td>Network Interace Card (Public)</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
</tr>
</tbody>
</table>
<p>è‹¥ä½ æƒ³äº†è§£ Azure Public IP Static è·Ÿ Dynamic çš„å·®ç•°ï¼Œå¯ä»¥é»é¸æ­¤æ–‡åƒè€ƒ <a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses#sku">Azure Public IP - SKU</a>ï¼Œæœ¬æ–‡ä¸è´…è¿°</p>
<p>ä½†å°±ä¸€å€‹ Azure VM çš„è§’åº¦ä¾†è¬›ï¼Œä¸¦ä¸æ˜¯ä¸Šè¿°çš„æ‰€æœ‰æœå‹™éƒ½èƒ½å¤ è®“ VM ç›´æ¥é€£ç·šå‡ºå»ï¼Œè­¬å¦‚èªªä»Šå¤©ä¸€å° RHEL VM è¦é€²è¡Œ <code>dnf update</code> ä½ å‹¢å¿…è¦é€£ç·šåˆ° Red Hat çš„ Repos æ‰èƒ½ä¸‹è¼‰ï¼Œæ•…ä¸‹é¢å†å¾ä¸­æ•´ç†å‡ºèƒ½å¤ è®“ä¸€å° VM é€é Outbound Traffic é€£ç·šåˆ° Internet çš„å¤šç¨®é€£ç·šæ–¹å¼</p>
<h3 id="outbound-traffic-5"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#outbound-traffic-5">Outbound Traffic ä¹‹ 5 ç¨®é€£ç·šæ–¹å¼</a></h3>
<p>ä¾æ“š <a href="https://learn.microsoft.com/ZH-TW/azure/load-balancer/load-balancer-outbound-connections">Use Source Network Address Translation (SNAT) for outbound connections</a> æŒ‡å‡ºï¼Œ</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th style="text-align: center;">ç”Ÿç”¢ç’°å¢ƒç”¨?</th>
<th style="text-align: center;">æ¨è–¦ç­‰ç´š?</th>
<th style="text-align: left;">é©ç”¨ SKU</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½¿ç”¨ Azure Firewall é€é SNAT é€£ç·šåˆ° Internet</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;">æ¥µä½³</td>
<td style="text-align: left;">Basic / Standard / Premium å¯ç”¨</td>
</tr>
<tr>
<td>ä½¿ç”¨ Azure NAT Gateway é€é SNAT é€£ç·šåˆ° Internet</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;">æ¥µä½³</td>
<td style="text-align: left;">N/A</td>
</tr>
<tr>
<td>ä½¿ç”¨ Azure Load Balancer (Public) é€é Oubound rules é€£ç·šåˆ° Internet</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;">ä½³</td>
<td style="text-align: left;">Stanard å¯ç”¨ï¼ŒBasic ä¸å¯</td>
</tr>
<tr>
<td>ç›´æ¥å°‡ Public IP æ›åœ¨ NIC ä¸Šè®“ VM é€£ç·šåˆ° Internet</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;">ä½³</td>
<td style="text-align: left;">Standard / Basic å¯ç”¨</td>
</tr>
<tr>
<td>ä»€éº¼éƒ½ä¸åšï¼Œé è¨­æ¡ç”¨ Default Outbound Access IP é€£ç·šåˆ° Internet</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;">å·®</td>
<td style="text-align: left;">N/A</td>
</tr>
</tbody>
</table>
<p>é¦–å…ˆæ˜¯é—œæ–¼ Azure Firewall v.s. Azure NAT Gateway çš„é¸æ“‡ï¼Œå› ç‚ºéƒ½å¯ä»¥åš SNAT å‡ºå»ï¼Œæ¶æ§‹é¸æ“‡é—œéµåœ¨ 2 å€‹åœ°æ–¹</p>
<ul>
<li>é€£ç·šè¦ä¸è¦ Firewall ä¿è­·? é€™å€‹è »ç›´è¦ºçš„æˆ‘å°±ä¸è¬›äº†</li>
<li>è¦ä¸è¦åš DNAT? å› ç‚º Azure Firewall å¯ä»¥åš DNAT å’Œ SNATï¼Œä½† Azure NAT Gateway åªèƒ½åš SNATï¼Œä¸èƒ½ä½¿ç”¨ DNAT ç®¡ç† Inbound Traffic</li>
</ul>
<p>é€™é‚Šé‚„æœ‰ä¸€å€‹æ´¾ç”Ÿä½œæ³•å°±æ˜¯ Azure NAT Gateway with Azure Firewallï¼Œä¸»è¦ç”¨ Azure NAT Gateway å¯æ”¯æ´ 64,512 SNAT Port è§£æ±º Azure Firewall SNAT Port åƒ… 2,496 port ä¸è¶³å•é¡Œï¼Œè©³ç´°å¯ä»¥åƒè€ƒ <a href="https://azure.microsoft.com/zh-tw/blog/scale-azure-firewall-snat-ports-with-nat-gateway-for-large-workloads/">Scale Azure Firewall SNAT</a>ï¼Œæœ¬æ–‡ä¸è´…è¿°</p>
<p>å…¶æ¬¡æ˜¯ Azure NAT Gateway v.s Azure Load Balancerï¼Œé›–ç„¶å‰è€…æ˜¯ç”¨ SNAT å‡ºå»ï¼Œå¾Œè€…æ˜¯ç”¨ Outbound Policy å‡ºå»ï¼Œæ¶æ§‹é¸æ“‡é—œéµåœ¨</p>
<ul>
<li>æœå‹™é€£ç·šç‰¹æ€§éœ€ä¸éœ€è¦å¤§é‡çš„ Outbound Traffic? å¦‚æœæ˜¯çš„è©±ï¼Œå»ºè­°ä½¿ç”¨ Azure NAT Gatewayï¼Œå› ç‚ºé€™æœå‹™å°ˆç‚º Outbound Traffic è¨­è¨ˆï¼Œå®Œå…¨å—æ§ä¸”å…·æœ‰é«˜åº¦å¾©åŸæ€§ï¼Œå¯æœ€å¤§åŒ–é¿å… SNAT è€—ç›¡å•é¡Œ (SNAT Exhaustion Scenarios) æ˜¯ Outbound Traffic æœ€ä½³é¸æ“‡</li>
</ul>
<p>è‡³æ–¼ Azure Load Balancer æœå‹™æœ¬èº«æ˜¯ç‚ºäº† Inbound Traffic è€Œè¨­è¨ˆï¼Œè€Œé Outbound Trafficï¼Œä½†ä»–å‰›å¥½å…·å‚™ <code>Outbound Policy - Outbound source network address translation (SNAT)</code> çš„ç®¡ç†åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨æœ¬æ–‡ä¸­æ˜¯ä¸€å€‹é¸é …ï¼Œæ­£ä¹Ÿå› ç‚ºå¦‚æ­¤æœ‰ä¸€å€‹æ´¾ç”Ÿä½œæ³•å°±æ˜¯ Azure NAT Gateway with Azure Load Balancerï¼Œä½† Azure Load Balancer è™•ç† Inbound Trafficï¼Œè€Œ Azure NAt Gateway è™•ç† Outbound Trafficï¼Œè©³ç´°å¯ä»¥åƒè€ƒ <a href="https://learn.microsoft.com/en-us/azure/virtual-network/nat-gateway/nat-gateway-resource#nat-and-vm-with-a-standard-public-load-balancer">NAT and VM with a standard public load balancer</a>ï¼Œæœ¬æ–‡ä¸è´…è¿°</p>
<h3 id="default-outbound-access-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#default-outbound-access-ip">é—œæ–¼ Default outbound access IP !!!???</a></h3>
<h4 id="_1"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#_1">ä»€éº¼éƒ½ä¸åšä¹Ÿèƒ½é€£å‡ºå»!!??</a></h4>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/media/default-outbound-access/default-outbound-access.png" /></p>
<p>æ˜¯ï¼Œä»€éº¼éƒ½ä¸è¨­å®šçš„ç‹€æ³ä¸‹ï¼Œä¹Ÿå¯ä»¥é€£ç·šå‡ºå»ï¼ŒåŸºæ–¼ <a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/default-outbound-access#when-is-default-outbound-access-provided">When is default outbound access provided?</a>ï¼Œé€™æ˜¯ Azure å¹³å°ç‰¹æ€§ï¼Œé€™å€‹åŠŸèƒ½å«åš <mark>Default Outbound Access IP</mark>ï¼Œæ˜¯ä¸€å€‹éš±å« (Implicit) çš„è³‡æºï¼Œè©² Public IP <mark>ä¸¦ä¸æœƒ</mark> é¡¯ç¤ºåœ¨ Azure Portal ä¸Šï¼Œä¸”ä¸ç®— Subscription Cost çš„ä¸€ç’°ï¼Œè€Œé€™å€‹ Default Outbound Access IP çš„ç‰¹æ€§å¦‚ä¸‹:</p>
<ol>
<li>åªå‡ºä¸é€²: åªæœ‰ Outbound Traffic èƒ½åŠ›ï¼Œä¸å…·å‚™ Inbound Traffic èƒ½åŠ›</li>
<li>åƒ…æ”¯æ´ TCP/UDP é€£ç·šï¼Œä¸æ”¯æ´ ICMP: æ•…ä½ å¯ä»¥ä¸‹è¼‰ package ä½†ä¸èƒ½ ping å‡ºå»</li>
<li>IP æœƒè‡ªå·±è®Šå‹•: å› ç‚ºé€™å€‹ IP ä¸æ­¸å±¬å®¢æˆ¶ç®¡ç†ï¼Œæ•…ä¸æœƒé€šçŸ¥æ›´æ›ï¼Œæ•…å¦‚æœæœ‰ä»»ä½•è·Ÿé€™å€‹ IP æœ‰é—œé€£çš„æœå‹™ï¼Œæœƒç›´æ¥å—åˆ°å½±éŸ¿</li>
</ol>
<h4 id="vm-public-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#vm-public-ip">å¦‚ä½•é©—è­‰æˆ‘ç¾åœ¨çš„ VM æ˜¯ä¸æ˜¯æœ‰é€™ç¨®éš±å«çš„ Public IP è³‡æº?</a></h4>
<p>åŸºæ–¼ <a href="https://blog.pichuang.com.tw/wiki/howto/howto-public-ip-address-verification">How To: æŸ¥è©¢åŠé©—è­‰è‡ªèº« Public IP</a> æ‰€åˆ—ï¼Œå› ç‚º Default outbound access IP ä¸¦ä¸æ”¯æ´ ICMPï¼Œæˆ‘å€‘åƒ…æœ‰ TCP/UDP å¯ç”¨ï¼Œæ•…å¯ä»¥æ¡ç”¨ DNS æŸ¥è©¢çš„æ–¹å¼ä¾†é©—è­‰</p>
<div class="highlight"><span class="filename">command</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>dig myip.opendns.com @resolver1.opendns.com
</code></pre></div>
<h4 id="_2"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#_2">å¦‚ä½•é—œé–‰æˆ–é¿å…æ­¤ç‹€æ³?</a></h4>
<p>ç°¡å–®ä¾†èªªå°±æ˜¯è¦é‡å° Outbound Traffic åšé¡¯å¼ (Explicit) çš„è¨­å®šï¼Œä¹Ÿå°±æ˜¯æ˜é¡¯çš„å‘Šè¨´ Azure è¦ç”¨ä»€éº¼æ–¹å¼é€£ç·šå‡ºå»</p>
<ol>
<li>è¨­å®š NSG (Network Security Group) ä¾†é™åˆ¶ Outbound Traffic</li>
<li>æ¡ç”¨ <code>Outbound Traffic ä¹‹å¤šç¨®é€£ç·šæ–¹å¼</code> ç« ç¯€æ‰€åˆ—æ–¹å¼ä¹‹ä¸€ï¼Œæ˜ç¢ºè¡¨ç¤ºè¦æ€éº¼ä»‹æ¥å‡ºå»</li>
</ol>
<p>ä¸‹é¢æœƒé‡å°æ–¹å¼ 1 çš„ NSG ä¾†åšå¯¦æ¸¬å®Œå…¨é—œé–‰ Outbound Trafficï¼Œä¸¦ä¸”é©—è­‰ VM æ˜¯å¦èƒ½æ­£å¸¸é‹ä½œ</p>
<h4 id="default-outbound-access-ip_1"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#default-outbound-access-ip_1">å¦‚ä½•ä½¿ç”¨ Default outbound access IP?</a></h4>
<p>æ–¼ Create a Virtual Machine æ™‚ï¼Œé‡å° Networking é é¢ï¼Œä½¿ç”¨ä¸‹åˆ—åƒæ•¸:</p>
<table>
<thead>
<tr>
<th>é¸é …</th>
<th>åƒæ•¸</th>
</tr>
</thead>
<tbody>
<tr>
<td>Public IP</td>
<td>None</td>
</tr>
<tr>
<td>NIC network security group</td>
<td>None / Basic çš†å¯</td>
</tr>
<tr>
<td>Load Balancing</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><img alt="" src="/images/default-outbound-access-ip.png" /></p>
<h3 id="default-outbound-access-ip_2"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#default-outbound-access-ip_2">å¯¦æ¸¬ Default outbound access IP è¡Œç‚º</a></h3>
<h4 id="lab-1-vm-default-outbound-access-ip-outbound-traffic"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#lab-1-vm-default-outbound-access-ip-outbound-traffic">Lab 1: æ–°å¢ VM ä¸”ä½¿ç”¨ Default outbound access IP çš„ Outbound Traffic</a></h4>
<table>
<thead>
<tr>
<th>é¸é …</th>
<th style="text-align: center;">Outbound Traffic</th>
<th style="text-align: center;">Inbound Traffic</th>
</tr>
</thead>
<tbody>
<tr>
<td>ICMP</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>TCP</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>UDP</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>HTTP</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>DNS</td>
<td style="text-align: center;"><img alt="âœ…" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2705.svg" title=":white_check_mark:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
</tbody>
</table>
<div class="highlight"><span class="filename">output_without_nsg</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>repairman@black-vm:~$ ping -c 1 www.microsoft.com
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>PING e13678.dscb.akamaiedge.net (23.219.5.163) 56(84) bytes of data.
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>--- e13678.dscb.akamaiedge.net ping statistics ---
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>1 packets transmitted, 0 received, 100% packet loss, time 0ms
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>repairman@black-vm:~$ nc -zvw3 www.microsoft.com 80
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>Connection to www.microsoft.com 80 port [tcp/http] succeeded!
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>repairman@black-vm:~$ nc -zvw3 www.microsoft.com 443
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>Connection to www.microsoft.com 443 port [tcp/https] succeeded!
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>repairman@black-vm:~$ dig myip.opendns.com @resolver1.opendns.com
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; myip.opendns.com @resolver1.opendns.com
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>;; global options: +cmd
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>;; Got answer:
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20264
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>;; OPT PSEUDOSECTION:
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>; EDNS: version: 0, flags:; udp: 4096
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>;; QUESTION SECTION:
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>;myip.opendns.com.              IN      A
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>;; ANSWER SECTION:
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>myip.opendns.com.       0       IN      A       x.x.x.x
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>;; Query time: 4 msec
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>;; SERVER: 208.67.222.222#53(208.67.222.222)
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>;; WHEN: Fri Feb 10 02:15:56 UTC 2023
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>;; MSG SIZE  rcvd: 61
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>repairman@black-vm:~$ curl -s -o /dev/null -I -w &quot;%{http_code}&quot; http://www.microsoft.com/
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>200
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>repairman@black-vm:~$ sudo apt update -y
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>Hit:1 http://azure.archive.ubuntu.com/ubuntu focal InRelease
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>Get:2 http://azure.archive.ubuntu.com/ubuntu focal-updates InRelease [114 kB]
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>Get:3 http://azure.archive.ubuntu.com/ubuntu focal-backports InRelease [108 kB]
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>Get:4 http://azure.archive.ubuntu.com/ubuntu focal-security InRelease [114 kB]
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>Get:5 http://azure.archive.ubuntu.com/ubuntu focal/universe amd64 Packages [8628 kB]
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>Get:6 http://azure.archive.ubuntu.com/ubuntu focal/universe Translation-en [5124 kB]
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>Get:7 http://azure.archive.ubuntu.com/ubuntu focal/universe amd64 c-n-f Metadata [265 kB]
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>Get:8 http://azure.archive.ubuntu.com/ubuntu focal/multiverse amd64 Packages [144 kB]
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>Get:9 http://azure.archive.ubuntu.com/ubuntu focal/multiverse Translation-en [104 kB]
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>Get:10 http://azure.archive.ubuntu.com/ubuntu focal/multiverse amd64 c-n-f Metadata [9136 B]
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>Get:11 http://azure.archive.ubuntu.com/ubuntu focal-updates/main amd64 Packages [2377 kB]
</code></pre></div>
<p>é‹ä½œæˆªåœ–:</p>
<p><img alt="" src="/images/default-outbound-access-ip-lab1.png" /></p>
<h4 id="lab-2-lab1-nsg-nic-outbound-traffic"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#lab-2-lab1-nsg-nic-outbound-traffic">Lab 2: åŸºæ–¼ Lab1 çš„æƒ…æ³å°‡ NSG æ›è¼‰åˆ° NIC çš„ Outbound Traffic</a></h4>
<p><img alt="" src="/images/default-outbound-access-ip-lab2.png" /></p>
<p>æ–°å¢ä¸€å€‹ NSG ä¸”æ–¼ <code>Outbound Security rules</code> ä¸­è¨­å®š</p>
<table>
<thead>
<tr>
<th>Key</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source</td>
<td style="text-align: center;">Any</td>
</tr>
<tr>
<td>Source port ranges</td>
<td style="text-align: center;">*</td>
</tr>
<tr>
<td>Destination</td>
<td style="text-align: center;">Service Tag</td>
</tr>
<tr>
<td>Destination port ranges</td>
<td style="text-align: center;">Internet</td>
</tr>
<tr>
<td>Service</td>
<td style="text-align: center;">Custom</td>
</tr>
<tr>
<td>Protocol</td>
<td style="text-align: center;">Any</td>
</tr>
<tr>
<td>Action</td>
<td style="text-align: center;">Deny</td>
</tr>
<tr>
<td>Priority</td>
<td style="text-align: center;">100</td>
</tr>
<tr>
<td>Name</td>
<td style="text-align: center;">DenyInternetOutbound</td>
</tr>
</tbody>
</table>
<p>å»è¦†è“‹æ‰é è¨­ <code>65001 AllowInternetOutbound</code> çš„è¦å‰‡</p>
<p>åœ¨ Lab 1 çš„æƒ…æ³ä¸‹ï¼Œå°‡è©² NSG ä¸¦æ›è¼‰ (Associate) åˆ°é€™å€‹ VM NIC ä¸Šï¼Œå‰‡æ¸¬è©¦æ•ˆæœæœƒè®Šæˆå¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th>é¸é …</th>
<th style="text-align: center;">Outbound Traffic</th>
<th style="text-align: center;">Inbound Traffic</th>
</tr>
</thead>
<tbody>
<tr>
<td>ICMP</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>TCP</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>UDP</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>HTTP</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
<tr>
<td>DNS</td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
<td style="text-align: center;"><img alt="â›”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26d4.svg" title=":no_entry:" /></td>
</tr>
</tbody>
</table>
<div class="highlight"><span class="filename">output_with_nsg</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>repairman@black-vm:~$ ping -c 1 www.microsoft.com
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>PING e13678.dscb.akamaiedge.net (23.220.113.163) 56(84) bytes of data.
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>--- e13678.dscb.akamaiedge.net ping statistics ---
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>1 packets transmitted, 0 received, 100% packet loss, time 0ms
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>repairman@black-vm:~$ nc -zvw3 www.microsoft.com 80
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>nc: connect to www.microsoft.com port 80 (tcp) timed out: Operation now in progress
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>nc: connect to www.microsoft.com port 80 (tcp) failed: Network is unreachable
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>nc: connect to www.microsoft.com port 80 (tcp) failed: Network is unreachable
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>nc: connect to www.microsoft.com port 80 (tcp) failed: Network is unreachable
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>nc: connect to www.microsoft.com port 80 (tcp) failed: Network is unreachable
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>nc: connect to www.microsoft.com port 80 (tcp) failed: Network is unreachable
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>repairman@black-vm:~$ nc -zvw3 www.microsoft.com 443
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>nc: connect to www.microsoft.com port 443 (tcp) timed out: Operation now in progress
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>nc: connect to www.microsoft.com port 443 (tcp) failed: Network is unreachable
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>nc: connect to www.microsoft.com port 443 (tcp) failed: Network is unreachable
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>nc: connect to www.microsoft.com port 443 (tcp) failed: Network is unreachable
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>nc: connect to www.microsoft.com port 443 (tcp) failed: Network is unreachable
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>nc: connect to www.microsoft.com port 443 (tcp) failed: Network is unreachable
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>repairman@black-vm:~$ dig myip.opendns.com @resolver1.opendns.com
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; myip.opendns.com @resolver1.opendns.com
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>;; global options: +cmd
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>;; connection timed out; no servers could be reached
</code></pre></div>
<h4 id="_3"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#_3">å¯¦æ¸¬ç¸½çµ</a></h4>
<p>è¦é”åˆ°å° Outbound Traffic é€²è¡Œåš´æ ¼æ§ç®¡ï¼ŒåŒ…å« Default outbound access IP çš„ç¶²è·¯è¡Œç‚ºä¹Ÿåœ¨å…§ï¼Œéœ€è¦åšä¸‹åˆ—äº‹æƒ…</p>
<ul>
<li>ä½¿ç”¨ NSG é‡å° Subnet æˆ– NIC é€²è¡Œç¶å®š</li>
<li>NSG å…§çš„è¨­å®š Outbound Security rules è¦å‰‡ <code>DenyAllInternetOutbound</code> æ˜ç¢ºè¦ç¯„ Outbound æµé‡</li>
</ul>
<h3 id="outbound-traffic"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#outbound-traffic">å¦‚ä½•æ­£ç¢º Outbound Traffic é€£ç·šæ–¹å¼?</a></h3>
<ul>
<li>å¦‚æœä½ æ˜¯æœ‰ä¸€å †æœå‹™ (SNAT Port å¤§æ–¼ 2,496) åªæ˜¯æƒ³è¦æœ‰ 1 ~ N å€‹å—æ§ IP é€£å‡ºå¤–ç¶²çš„è©±ï¼Œå¯ä»¥ç”¨ Azure NAT Gateway ä¾†åš</li>
<li>å¦‚æœä½ æ˜¯æœ‰éƒ¨åˆ†æœå‹™ (SNAT Port å°æ–¼ 2,496) éœ€è¦é€£ç·šå‡ºå¤–ç¶²çš„è©±ï¼Œä½†æœ‰é‡åº¦è³‡å®‰éœ€æ±‚çš„è©±ï¼Œå¯ä»¥ç”¨ Azure Firewall ä¾†åš</li>
<li>å¦‚æœä½ æ˜¯æœ‰ä¸Šè¿°å…©å€‹éœ€æ±‚çš„ç¶œåˆéœ€æ±‚ï¼Œå¯ä»¥ç”¨ Azure Firewall + Azure NAT Firewall Gateway ä¾†åš</li>
<li>å¦‚æœä½ åªæ˜¯å–®å° VM æƒ³å‡ºç¶²çš„è©±ï¼Œç›´æ¥å°‡ Public IP æ›åœ¨ NIC æ­é… NSG é€²è¡Œç¶²è·¯æ§ç®¡å³å¯</li>
<li>å¦‚æœä½ è¦å®Œå…¨é—œé–‰ Default outbound access IP èƒ½åŠ›çš„è©±ï¼Œå¯ä»¥ç”¨ NSG å° Subnet ç¯„åœé€²è¡Œç¶²è·¯æ§ç®¡</li>
</ul>
<h3 id="q-a"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q-a">Q &amp; A</a></h3>
<h4 id="q1-nsg-rules"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q1-nsg-rules">Q1: é è¨­ç‹€æ³ä¸‹ï¼ŒNSG æä¾›çš„ Rules æœ‰å“ªä¸€äº›?</a></h4>
<p><img alt="" src="/images/nsg-rules.png" /></p>
<p>A1: è®“ VM å¯ä»¥é€é Default outbound access IP çš„æ–¹å¼é€£ç·šå‡ºçš„æ˜¯å› ç‚º <code>65001 AllowInternetOutbound</code> çš„è¦å‰‡</p>
<h4 id="q2-65001-allowinternetoutbound"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q2-65001-allowinternetoutbound">Q2: æˆ‘å¯ä¸å¯ä»¥ç›´æ¥æ‹¿æ‰ <code>65001 AllowInternetOutbound</code> çš„è¦å‰‡?</a></h4>
<p>A2: ä¸è¡Œï¼Œé€™æ˜¯ Azure é è¨­çš„è¦å‰‡ï¼Œå»ºè­°æ–°å¢ä¸€æ¢ <code>DenyAllInternetOutbound</code> çš„è¦å‰‡é€éè¼ƒé«˜çš„ Priority è¦†è“‹è¦å‰‡æˆ–æ–¼ OS Level é€²è¡Œé˜²ç«ç‰†ç®¡ç†ï¼Œå¦‚ Linux iptables, Windows Firewall</p>
<h4 id="q3-default-outbound-access-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q3-default-outbound-access-ip">Q3: æˆ‘å¯ä¸å¯ä»¥ä¸è¦æœ‰ Default outbound access IP?</a></h4>
<p>A3: ä¸è¡Œï¼Œé€™æ˜¯ Azure é è¨­çš„èƒ½åŠ›</p>
<h4 id="q4-default-outbound-access-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q4-default-outbound-access-ip">Q4: æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥ä¸€ç›´ç”¨ Default outbound access IP ä¾†é€£ç·š?</a></h4>
<p>A4: ä¸ä¿è­‰ï¼Œå› ä¸¦éæ­£å¼æœå‹™ï¼Œå»ºè­°æ›è¼‰ Azure Public IP ä¾†é€£ç·š</p>
<h4 id="q5-public-ip-vm-internet"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q5-public-ip-vm-internet">Q5: ç‚ºå•¥æˆ‘æ²’æŒ‡æ´¾ä»»ä½• Public IP çš„ VM å¯ä»¥é€£åˆ° Internet å»æ›´æ–°ç³»çµ±?</a></h4>
<p>A5: å› é è¨­ç‹€æ³ä¸‹æœ‰ Default outbound access IP çš„å­˜åœ¨ï¼Œå’Œ NSG é è¨­è¦å‰‡ <code>65001 AllowInternetOutbound</code> çš„å­˜åœ¨ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€£åˆ° Internet å»æ›´æ–°ç³»çµ±</p>
<h4 id="q6-default-outbound-access-ip"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q6-default-outbound-access-ip">Q6: é‚£æˆ‘å¯ä»¥ç”¨ Default outbound access IP é€£ç·šé€²ä¾†å—?</a></h4>
<p>A6: ä¸è¡Œï¼Œæ²’æœ‰çµ¦ Inbound Traffic èƒ½åŠ›ï¼ŒPing ä¸åˆ°ï¼Œé€£ä¸é€²ä¾†</p>
<h4 id="q7-tldr"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#q7-tldr">Q7: TL;DR çµ¦æˆ‘ä¸€å¥è©±</a></h4>
<p>A7: NSG è¦ç”¨ï¼Œç”¨äº†å¹³å®‰ï¼ŒIP å¾Œä¸Šï¼Œä¸Šç­é †é‚</p>
<h3 id="references"><a class="toclink" href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/#references">References</a></h3>
<ul>
<li><a href="https://nwktimes.blogspot.com/2023/01/Azure-Inet-Access.html">Toni Pasanen - Azure Networking Fundamentals: Internet Access with VM-Specific Public IP</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/default-outbound-access#when-is-default-outbound-access-provided">When is default outbound access provided?</a></li>
<li><a href="https://learn.microsoft.com/ZH-TW/azure/load-balancer/load-balancer-outbound-connections">Use Source Network Address Translation (SNAT) for outbound connections</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses#sku">Azure Public IP - SKU</a></li>
<li><a href="https://azure.microsoft.com/zh-tw/blog/scale-azure-firewall-snat-ports-with-nat-gateway-for-large-workloads/">Scale Azure Firewall SNAT ports with NAT Gateway for large workloads</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-network/nat-gateway/tutorial-nat-gateway-load-balancer-public-portal">Tutorial: Integrate a NAT gateway with a public load balancer using the Azure portal</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-network/nat-gateway/tutorial-nat-gateway-load-balancer-internal-portal">Tutorial: Integrate a NAT gateway with an internal load balancer using the Azure portal</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/02/10/azure-vm-%E5%B0%8D%E5%A4%96%E7%B6%B2%E8%B7%AF%E7%9A%84%E5%A4%9A%E7%A8%AE%E8%8A%B1%E6%A8%A3/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-03 00:00:00">February 3, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/azure/" class="md-meta__link">azure</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-openai-serivce"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/">ç§æœ‰ Azure OpenAI Serivce é æƒ³æ¶æ§‹è¦åŠƒ</a></h2>
<details class="info" open="open">
<summary>Info</summary>
<p>æ­¤æ–‡æ˜¯å¯«çµ¦å»£å¤§çš„ IT Infra èƒŒæ™¯ç¾¤çœ¾çœ‹çš„ï¼Œä¸»è¦æ˜¯æä¾›è½åœ°æ¶æ§‹è¨­è¨ˆåƒè€ƒï¼Œè‹¥ä½ æ˜¯æƒ³è¦çŸ¥é“ OpenAI æ€éº¼ç”¨çš„ï¼Œæ­¤æ–‡ä¸¦ç„¡æ¶‰åŠï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ <a href="https://techcommunity.microsoft.com/t5/educator-developer-blog/azure-openai-is-now-generally-available/ba-p/3719177">Azure OpenAI is now generally available</a></p>
</details>
<p>2022/11 æœ€é©šåš‡åˆ°æˆ‘çš„äº‹æƒ…å°±æ˜¯ ChatGPT é€™æœå‹™çš„èª•ç”Ÿï¼Œç°¡ç›´çœ‹åˆ° <mark>ç§‘æŠ€å¥‡ç•°é»</mark> ï¼Œç„¶å¾Œæ²’æƒ³åˆ°é€™æœå‹™çš„æ¯å…¬å¸ OpenAI å±…ç„¶æ˜¯ Microsoft æŠ•è³‡çš„ï¼Œæˆ‘åªèƒ½èªªçœŸçš„æ˜¯å¯å–œå¯è³€å’Œæ„Ÿåˆ°å“€å‚·ã€‚</p>
<p>å¯å–œå¯è³€æ˜¯æˆ‘å¯ä»¥åœ¨å¾ˆè¿‘çš„è·é›¢çœ‹åˆ°é€™æŠ€è¡“å°‡è¦å‰µé€ çš„æ­·å²ï¼Œæ„Ÿåˆ°å“€å‚·æ˜¯ ChatGPT æ¨¹ç«‹äº†ä¸€å€‹ç›¸ç•¶é©šäººçš„æŠ€è¡“å±éšœï¼Œéƒ½ä¸çŸ¥é“ä»¥å¾Œæ–°é€²æˆ–èœé³¥å·¥ç¨‹å¸«åˆ°åº•è¦æ€éº¼è·Ÿé€™å€‹ç«¶çˆ­ï¼Œä½†å¹¸å¥½è‹¥å•ä»–åšç‰¹åˆ¥éœ€è¦å°ˆæ¥­æ€§å•ç­”çš„äº‹æƒ…ï¼Œé€™æœå‹™ç›®å‰æœ‰å¯èƒ½æœƒå›ç­”éŒ¯èª¤æˆ–äº‚ç­”ï¼Œè­¬å¦‚èªªå•å®ƒç¶²è·¯é™¤éŒ¯æˆ–è¨­è¨ˆå•é¡Œå¾Œï¼Œçœ‹èµ·ä¾†æˆ‘é‚„ä¸æœƒå¤±æ¥­ :&gt;</p>
<p>ä¸‹åœ–æ˜¯æ¨™æº–å·¥ç¨‹å¸«ä½¿ç”¨ç¯„ä¾‹ï¼Œæœ¬äººå°æ–¼ HTML å’Œ CSS æ¯«ç„¡ç†è§£ï¼Œä¹Ÿä¸çŸ¥é“å¾ä½•æ”¹ï¼Œç„¶å¾Œæˆ‘å°±å»å• ChatGPT å¾Œï¼Œå°±æ”¹å¥½äº†...</p>
<p><img alt="" src="/images/chatgpt-demo.png" /></p>
<!--more-->

<h3 id="azure-openai-service-architecture-pre-design"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#azure-openai-service-architecture-pre-design">Azure OpenAI Service Architecture Pre Design</a></h3>
<details class="warning" open="open">
<summary>è²æ˜</summary>
<p>æ–¼æœ¬æ–‡æ’°å¯«çš„ä»Šå¤© 20220203 é›–èº«ç‚º Microsoft å“¡å·¥ï¼Œä½†æˆ‘ä¹Ÿé‚„æ²’æœ‰æ‹¿åˆ° Azure OpenAI çš„è¨‚é–±æ¬Šé™ï¼Œæ‰€ä»¥é‚„æ²’æœ‰å¯¦æ¸¬éé€™æ¶æ§‹ï¼Œæ•…æœ¬æ–‡æ˜¯ä¾æ“šæ—¢æœ‰ Azure æ–‡ä»¶å’Œæˆ‘å° Azure ç¶²è·¯çš„èªçŸ¥æä¾›é æƒ³æ¶æ§‹çµ¦å„ä½åƒè€ƒï¼Œåæ­£å¾ŒçºŒå¯ä»¥ä¿®ä¿®æ”¹æ”¹</p>
</details>
<p>ä¸»è¦æ˜¯çœ‹åˆ°å¼·è€…æˆ‘åŒäº‹ <a href="https://jimmyliao.net/post/2023-01-11-azure-openai/">Jimmy Liao - Azure OpenAI Part 1: åˆæ¢ OpenAI Studio</a> é€™æ–‡ç« ï¼Œçœ‹åˆ°è£¡é¢ Azure OpenAI å·¦å´çš„å…§å®¹ï¼Œæ‰æƒ³å…ˆæŠŠç¶²è·¯æ¶æ§‹å…ˆå¯«ä¸€å¯«çµ¦å¤§å®¶åƒè€ƒä¸€ä¸‹</p>
<p><img alt="" src="https://jimmyliao.net/images/2023/2023-01/2023-01-11/03.png" /></p>
<p>ç›®å‰é æƒ³ç§æœ‰æ¶æ§‹ä¸Šåˆ†ç‚º 2 å€‹æ–¹æ¡ˆ</p>
<ol>
<li>ç”Ÿç”¢ç’°å¢ƒè¦åŠƒ</li>
<li>PoC é©—è­‰ç’°å¢ƒè¦åŠƒ</li>
</ol>
<h4 id="1-production"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#1-production">æ–¹æ¡ˆ 1: Production ç”Ÿç”¢ç§æœ‰ç’°å¢ƒè¦åŠƒ</a></h4>
<p><img alt="" src="/images/openai-reference-architecture-full-ra-20230203-pinhuang.png" /></p>
<h4 id="2-poc"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#2-poc">æ–¹æ¡ˆ 2: PoC é©—è­‰ç§æœ‰ç’°å¢ƒè¦åŠƒ</a></h4>
<p><img alt="" src="/images/openai-reference-architecture-poc-20230203-pinhuang.png" /></p>
<h3 id="_1"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#_1">é æƒ³ç§æœ‰æ¶æ§‹è©³è§£</a></h3>
<p><img alt="" src="/images/openai-privateendpoint.png" /></p>
<p>æ•´é«”ç§æœ‰ç¶²è·¯çš„æ¶æ§‹é—œéµæ ¸å¿ƒæ˜¯ Azure Private Endpoint å’Œ Azure Private Link çš„ä½¿ç”¨ï¼Œæ ¹æ“šæ­¤æ–‡ <a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview">Private-link resource</a> æ•…å¯æä¾›ä»¥ä¸‹æœå‹™ Private Endpoint çµ¦ç§æœ‰é€£ç·šä½¿ç”¨ï¼Œæ­¤å¤–é€™å€‹æœå‹™æ˜¯åœ¨ Azure Cognitive Services åº•ä¸‹ï¼Œæ‰€ä»¥è‹¥ä½ æœ‰æ—¢æœ‰æ¶æ§‹çš„è©±å¯ä»¥ç›´æ¥æ²¿ç”¨</p>
<table>
<thead>
<tr>
<th>Private-link resource name</th>
<th>Resource type</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>Azure OpenAI Services</td>
<td>Microsoft.CognitiveServices/accounts</td>
<td>æ–‡ä»¶é‚„æ²’æœ‰å‡ºä¾†ï¼Œä½†åŠŸèƒ½æœ‰</td>
</tr>
<tr>
<td>Azure Key Vault</td>
<td>Microsoft.KeyVault/vaults</td>
<td>N/A</td>
</tr>
<tr>
<td>Azure Storage</td>
<td>Microsoft.Storage/storageAccounts</td>
<td>N/A</td>
</tr>
<tr>
<td>Azure Monitor</td>
<td>Microsoft.insights/privateLinkScopes</td>
<td>é€™å€‹æ˜¯ç”¨ Azure Monitor Private Link Scope (AMPLS)</td>
</tr>
<tr>
<td>Azure Cognitive Services</td>
<td>Microsoft.CognitiveServices/accounts</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p>é—œæ–¼ DNSï¼Œå¦‚æœæ˜¯å®Œå…¨æ–°å»ºæœå‹™çš„è©±ï¼Œé‚„è¦æ³¨æ„ Azure Private DNS è§£æå•é¡Œï¼Œä½†é€™æ˜¯å¦ä¸€å¡Šéœ€è¦é¡å¤–è¨è«–è™•ç†ï¼Œè§£æ³•ä¸å¤–ä¹ 2 ç¨®å¸¸è¦‹ä½œæ³•:</p>
<ol>
<li>Azure Private DNS Resovler: Azure PaaS æœå‹™ï¼Œæœ¬èº«æœ‰è·¨åœ‹æ¶æ§‹éœ€æ±‚ï¼Œæœ‰ Private DNS Zone ç®¡ç†éœ€æ±‚ç›¸ç•¶æ¨è–¦</li>
<li>Customer DNS Forwarder: Azure VM + çœ‹ä½ å–œæ­¡å“ªå®¶çš„ DNSï¼Œå¦‚ AD / Infoblox / Bind9 ç­‰ï¼Œåš Forwarder</li>
</ol>
<p>é—œæ–¼é›²åœ°é€£ç·šï¼Œå¾åœ°ç«¯ç’°å¢ƒé€£åˆ° Azureï¼Œä¸å¤–ä¹å°± 2 ç¨®å¸¸è¦‹åšæ³•</p>
<ol>
<li>Azure ExpressRoute å°ˆç·š</li>
<li>S2S VPN ä½¿ç”¨ IPSec Tunnel</li>
</ol>
<p>å¦‚æœåªæ˜¯åˆæœŸé–‹å•Ÿä¾†è©¦è©¦çš„è©±ï¼ŒS2S VPN èƒ½ç”¨ï¼Œå¾ŒçºŒè¨“ç·´è³‡æ–™é‡å¤§èµ·ä¾†çš„è©±ï¼Œæ˜¯è »æ¨è–¦ä½¿ç”¨ ExpressRoute ç¢ºä¿é€£ç·šç©©å®šå’Œä½å»¶é²ï¼Œè©³åƒ <a href="https://blog.pichuang.com.tw/20230202-azure-expressroute-cross-region.html">æ»‘é¼ é»é»ä¹‹è·¨åœ‹ Azure ExpressRoute ç¶²è·¯æ¶æ§‹
</a></p>
<details class="tip" open="open">
<summary>å»ºè­°å®Œæ•´æœå‹™</summary>
<p>ä¸‹è¿°çš„ API Management/Application Gateway è·Ÿ Azure OpenAI èƒ½åŠ›æä¾›ä¸¦ç„¡ç›´æ¥é—œä¿‚ï¼Œæ•…åˆæœŸæ¸¬è©¦å¯ä»¥å…ˆä»¥ PoC é©—è­‰ç’°å¢ƒè¦åŠƒæ¨£æ¿ç‚ºä¸»ï¼Œå†å¾ŒçºŒåŠ ä¸‹åˆ—æœå‹™ä¸Šå»å®Œå–„</p>
</details>
<p>æ­¤å¤–é—œæ–¼ API æ§ç®¡çš„éƒ¨åˆ†ï¼ŒAzure OpenAI æœ‰æä¾› <code>Azure OpenAI Service Swagger API</code> ä¾›ç¨‹å¼å‘¼å«ä½¿ç”¨ï¼Œå®ƒè§’è‰²å¦‚åŒå¸¸è¦‹çš„ Backend APIsï¼Œæœå‹™æœ¬èº«æ²’æœ‰åšä»€éº¼ç‰¹åˆ¥çš„ä¿è­·ï¼Œæ•…å‰é¢å¯ä»¥ä½¿ç”¨ <a href="https://learn.microsoft.com/zh-tw/azure/api-management/transform-api">API Management é€²è¡Œè½‰æ› API</a> å’Œç®¡åˆ¶ï¼Œè€Œ API Management å‰é¢é‚„å¯ä»¥ç”¨ <a href="https://learn.microsoft.com/zh-tw/azure/architecture/reference-architectures/apis/protect-apis">Application Gateway ä¿è­· API</a></p>
<p><img alt="" src="https://learn.microsoft.com/zh-tw/azure/architecture/reference-architectures/apis/images/protect-apis.png" /></p>
<h3 id="qa"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#qa">Q&amp;A</a></h3>
<h4 id="q1-private-endpoint-azure-openai-service"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#q1-private-endpoint-azure-openai-service">Q1: å¦‚æœæˆ‘ä¸ç”¨ä¸Šé¢ä»€éº¼ Private Endpoint é‚„æ˜¯æœ‰çš„æ²’çš„ï¼Œå¯ä»¥ç”¨ Azure OpenAI Service?</a></h4>
<p>A1: å¯ä»¥ï¼Œå¼·è€…æˆ‘åŒäº‹ <a href="https://jimmyliao.net/post/2023-01-11-azure-openai/">Jimmy Liao - Azure OpenAI Part 1: åˆæ¢ OpenAI Studio</a>æœ‰å¯«ç³»åˆ—æ–‡ï¼Œå¯ä»¥ç›´æ¥åƒè€ƒä»–çš„ç³»åˆ—æ–‡ç« </p>
<h4 id="q2-azure-openai-service"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#q2-azure-openai-service">Q2: ç¾åœ¨ç”³è«‹ä¸åˆ° Azure OpenAI Serviceï¼Œé›£é“æˆ‘å°±æ²’ä»€éº¼æ±è¥¿å¯ä»¥å…ˆè©•ä¼°äº†å—?</a></h4>
<p>A2: é›²åœ°ç¶²è·¯å¯ä»¥å…ˆè¨è«–å’Œå…ˆæ‹‰ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œæ­£å¸¸å°ç£å®¢æˆ¶è¨è«–åˆ°å¯¦éš›è½åœ°èµ·ä¾†éƒ½æœƒæ¯” Azure OpenAI Service æ¨å‡ºçš„æ™‚é–“é‚„è¦ä¹…ï¼Œå› ç‚ºå®ƒä¸æ˜¯å–®ç´”æ»‘é¼ é»é»å°±å¯ä»¥è§£æ±ºçš„äº‹æƒ…</p>
<p><img alt="" src="/images/hybridnetworking-600x400.jpg" /></p>
<p>å…¶æ¬¡å°±æ˜¯çœ‹ <mark>Production ç”Ÿç”¢ç§æœ‰ç’°å¢ƒè¦åŠƒ</mark> å…§å®¹ï¼Œäº†è§£ä¸€ä¸‹è£¡é¢çš„å…§å®¹å€‹åˆ¥åŠŸèƒ½</p>
<h4 id="q3-infra"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#q3-infra">Q3: ç„¡é—œé¡Œç›®ï¼Œèº«ç‚ºä¸€å Infra å·¥ç¨‹å¸«ï¼Œå°æ–¼é€™å€‹æœå‹™æœ‰ä»€éº¼æƒ³åƒåŠ›å—?</a></h4>
<p>A3: ä¿®ç¶²è·¯ï¼Œä¸Ÿçµ¦å®ƒä¸€å †è·¯ç”±è³‡è¨Šï¼Œç„¶å¾Œè·Ÿæˆ‘èªªä¸€ä¸‹åˆ°åº•å“ªä¸€æ¢æ˜¯æ“ºéŒ¯çš„æˆ–è€…æ˜¯å“ªè£¡æ€ªæ€ªçš„</p>
<h3 id="references"><a class="toclink" href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/#references">References</a></h3>
<ul>
<li><a href="https://jimmyliao.net/post/2023-01-11-azure-openai/">Jimmy Liao - Azure OpenAI Part 1: åˆæ¢ OpenAI Studio</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/educator-developer-blog/azure-openai-is-now-generally-available/ba-p/3719177">Azure OpenAI is now generally available</a></li>
<li><a href="https://github.com/MSUSAzureAccelerators/Conversational-Azure-OpenAI-Accelerator">Conversational Azure OpenAI (ChatGPT) Accelerator</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/02/03/%E7%A7%81%E6%9C%89-azure-openai-serivce-%E9%A0%90%E6%83%B3%E6%9E%B6%E6%A7%8B%E8%A6%8F%E5%8A%83/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-02-02 00:00:00">February 2, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/azure/" class="md-meta__link">azure</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-expressroute"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/">æ»‘é¼ é»é»(?)ä¹‹è·¨åœ‹ Azure ExpressRoute ç¶²è·¯æ¶æ§‹</a></h2>
<p>æœ€è¿‘æ‰“å·¥æ‰“åˆ°é›²ç«¯ä¾†äº†ï¼Œç›®å‰é †åˆ©æ´»éäº† 6 å€‹æœˆï¼Œæˆ‘åªèƒ½èªªæ ¹æœ¬å¤©å¤©çœ‹ç¶²è·¯æ¶æ§‹è­°é¡Œï¼Œå¦‚æœä½ æ˜¯ç´”é›²ç«¯ç›´æ¥ä½¿ç”¨çš„ï¼Œå®Œå…¨ä¸éœ€è¦è·Ÿåœ°ç«¯ç¶²è·¯æ¥å†ä¸€èµ·çš„ï¼Œä½ æ˜¯ä¸æœƒæœ‰æˆ‘é€™ç¨®ç…©æƒ±ï¼Œä½†å¦‚æœä½ è·Ÿæˆ‘ä¸€æ¨£çœ‹æ··åˆç¶²è·¯æ¶æ§‹ (å‚™è¨»:æ˜¯åœ°ç«¯+é›²ç«¯ï¼Œä¸æ˜¯é›²ç«¯+é›²ç«¯) çš„è©±ï¼Œä¼°è¨ˆä½ æ‡‰è©²è·Ÿæˆ‘ä¸€æ¨£éƒ½åœ¨æ»‘é¼ é»é»ï¼Œé–‹æœå‹™ï¼Œå°æµé‡</p>
<p>åˆ†äº«ä¸€ä¸‹ç•¶åˆé–‹å§‹çœ‹ Azure Networking çš„ç¬¬ä¸€ç¯‡æ–‡ç« å°±æ˜¯å‡ºè‡³æ–¼ <a href="https://purple.telstra.com.au/blog/hub-and-spoke-network-topology-in-azure">Telstra Purple - Hub and Spoke network topology in Azure</a>ï¼Œåˆ°ç¾åœ¨ç‚ºæ­¢ï¼Œè‹¥æ˜¯è¦ç”¨ Azure åšè·¨åœ‹ç¶²è·¯æ¶æ§‹åƒè€ƒæ€§é‚„æ˜¯éå¸¸é«˜çš„</p>
<p><img alt="" src="https://blog.kloud.com.au/wp-content/uploads/2020/03/0103.hub_.and_.spoke_.lucian.example.v1.png" /></p>
<!--more-->

<h3 id="azure-expressroute-3-1"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#azure-expressroute-3-1">Azure ExpressRoute 3 å€‹é—œéµçµ„ä»¶ + 1 å€‹å¿…è¦å‹•ä½œ</a></h3>
<p><img alt="" src="/images/vwan-1-er-1-region.png" /></p>
<h4 id="1-expressroute-er-circuit"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#1-expressroute-er-circuit">1. ExpressRoute (ER) Circuit</a></h4>
<p>é€™å€‹å¯ä»¥å…ˆé€é Azure Portal å…ˆæŠŠç›¸é—œè¨­å®šåšå¥½ï¼ŒåŒ…å« ER Provider / Peering Location / Bandwidth / SKU ç­‰ç­‰ï¼Œä½†ä¸­é–“æ¥ç·šé‚„æ˜¯éœ€è¦æ‰¾å„åœ°æ–¹çš„ ExpressRoute Provider (ERP) æ¥æ´½è™•ç†ï¼Œä¸‹é¢åˆ—èˆ‰å°ç£ ExpressRoute Provider å’Œèƒ½ Peering Location</p>
<table>
<thead>
<tr>
<th>ER Provider # (1)</th>
<th>Peering Location # (2)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChungHwa Telecom</td>
<td>Taipei</td>
</tr>
<tr>
<td>Chief Telecom</td>
<td>Taipei / HongKong</td>
</tr>
<tr>
<td>FarEasTone</td>
<td>Taipei</td>
</tr>
</tbody>
</table>
<ol>
<li>æä¾› ExpressRoute Circuit çš„ ISP æ¥­è€…</li>
<li>ISP å°‡æä¾› Circuit Connection çš„ Azure Location</li>
</ol>
<p>é€Ÿç‡ (Bandwidth) ç›®å‰å¯é¸ 8 ç¨®ï¼ŒåŒ…å« 50Mbp / 100Mbps / 200Mbps / 500Mbps / 1Gbps / 2Gbps / 5Gbps / 10Gbpsï¼Œç›®å‰é‡åˆ°å¤šåŠéƒ½åœ¨ 100Mbps ~ 1Gbps ä»¥å…§é¸æ“‡å±…å¤š</p>
<p>SKU æœ‰åˆ† 3 å€‹ï¼Œä½†å¯¦å‹™ä¸Šå°ç£ç¾åœ¨åªæœƒæœ‰ 2 å€‹å¯ä»¥ç”¨: Standard / Premiumï¼Œå·®ç•°åœ¨å¦‚æœè¦å¼„ ExpressRoute Global Reach æˆ–éœ€è¦ç§æœ‰å‚³è¼¸ Microsoft 365 å…§å®¹çš„è©±å°±å¿…é ˆè¦é¸ Premiumï¼Œå…¶ä»–é¸ Standard å³å¯</p>
<h4 id="2-expressroute-gateway"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#2-expressroute-gateway">2. ExpressRoute Gateway</a></h4>
<p>é€™æœå‹™å…¶å¯¦è—åœ¨ Virtual Network Gateway è£¡é¢ï¼Œè¦é¸ <code>Gateway Type: ExpressRoute</code> æ‰èƒ½æ­£ç¢ºä½¿ç”¨</p>
<p><img alt="" src="/images/vng-er-gw.png" /></p>
<p>è‡³æ–¼é¸æ“‡ä¸Šè·Ÿæœ‰å¤šå°‘æ¢ Azure ExpressRoute Circuit å’ŒåŠ ç¸½é€Ÿç‡æœ‰é—œä¿‚</p>
<p>é—œæ–¼ Azure ExpressRoute Circuit æ¢æ•¸ï¼Œè­¬å¦‚èªªæ—¥æœ¬/æ–°åŠ å¡/å°ç£/å¢¨è¥¿å“¥/æ·å…‹ 5 å€‹åœ°æ–¹éƒ½å„è‡ªæœ‰ 1 æ¢ 100Mbps çš„ç·šè·¯ï¼Œè‹¥éƒ½è¦æ¥åˆ°åŒä¸€å° ExpressRoute Gateway å…§çš„è©±ï¼Œé‚£é€™å€‹ ExpressRoute Gateway SKU å°±è¦é¸æ“‡èƒ½æ”¯æ´ 5 å€‹ Circuit Connections ä»¥ä¸Š</p>
<p>é—œæ–¼åŠ ç¸½é€Ÿç‡ï¼Œè­¬å¦‚èªªæ—¥æœ¬/å°ç£/å¢¨è¥¿å“¥éƒ½å„è‡ªæœ‰ 1 æ¢ 500Mbps çš„ Azure ExpressRoute Circuitï¼Œè‹¥éƒ½è¦æ¥åˆ°åŒä¸€å° ExpressRoute Gateway å…§çš„è©±ï¼Œé‚£é€™å€‹ ExpressRoute Gateway SKU å°±è¦é¸æ“‡ 1.5Gbps (= 500Mbps * 3) ä»¥ä¸Š</p>
<p>é€šå¸¸æ²’æœ‰ç‰¹åˆ¥è¤‡é›œçš„ç¶²è·¯è­°é¡Œçš„è©±ï¼Œå„å€åŸŸé¸ Standard å°±å¯ä»¥å°æ‡‰å¾ˆå¤šç‹€æ³äº†ï¼Œå¾ŒçºŒä¹Ÿå¯ä»¥åŸåœ°å‡ç´šï¼Œéœ€é‡é–‹ç´„ç•¥ 30 ~ 45 minsï¼Œå¯ä»¥ç”¨ S2S VPN åš DR åˆ‡æ›ï¼Œç¢ºä¿é€£ç·šé †æš¢</p>
<h4 id="3-circuit-connection"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#3-circuit-connection">3. Circuit Connection</a></h4>
<blockquote>
<p>Pen-Pineapple-Apple-Pen</p>
</blockquote>
<p>é€™å€‹æœå‹™çš„ä»»å‹™å°±å°‡æŒ‡å®šçš„ ExpressRoute Circuit å’Œ ExpressRoute Gateway æ¥å†ä¸€èµ·ï¼Œé€™æ¨£å°±å®Œæˆäº† ExpressRoute çš„è¨­å®šï¼Œæ²’æœ‰ä»€éº¼ç‰¹æ®Šé ˆæ³¨æ„çš„åœ°æ–¹</p>
<h4 id="4-last-mile"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#4-last-mile">4. Last Mile</a></h4>
<p>Last Mile æŒ‡çš„æ˜¯å¾ ISP åˆ° Customer Equipment æˆ– User çš„æœ€å¾Œä¸€æ®µç¶²è·¯</p>
<p>ExpressRoute Circuit é›–ç„¶å¯ä»¥ç›´æ¥åœ¨ Portal ä¸Šé–‹èµ·ä¾†ï¼Œä½†å¯¦éš›ä¸Šæ˜¯éœ€è¦è«‹ ExpressRoute Provider å» å•†å®Œæˆ Last Mile çš„ç•Œæ¥æ“ä½œï¼Œå°æ‡‰åˆ°ä¸åŒå®¢æˆ¶çš„ç¶²è·¯æ¶æ§‹éœ€æ±‚ï¼Œæœƒæœ‰ä¸åŒçš„æ¥æ³•å’Œå¯¦éš›éœ€æ±‚ï¼Œé€™æ®µçš„è²»ç”¨å°±æ˜¯ç”± Customer å° ExpressRoute Provider æ”¯ä»˜ç›¸é—œè²»ç”¨ï¼Œä¸¦ç„¡æ¶‰åŠ Azure</p>
<h3 id="azure-expressroute_1"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#azure-expressroute_1">Azure ExpressRoute è·¨åœ‹ç¶²è·¯æ¶æ§‹æ¡ˆä¾‹</a></h3>
<p>ä¸‹é¢åˆ†äº« 4 å€‹æˆ‘å¸¸é‡åˆ°å’Œå‰›å¥½æœ‰çœ‹åˆ°åˆ¥åœ‹åšçš„æ¨£å­</p>
<h4 id="1"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#1">1. å–®åœ°å–®å€åŸŸ</a></h4>
<p><img alt="" src="/images/vwan-1-er-1-region.png" /></p>
<p>ä¸€èˆ¬ç¶²è·¯ä¸Šæ–‡ç« å¸¸è¦‹ä»‹ç´¹æ¶æ§‹å°±æ˜¯é•·é€™æ¨£ï¼Œå¾ Taipei åœ°ç«¯å‡ºç™¼ï¼Œé€é ExpressRoute Provider å®¶çš„ç¶²è·¯ï¼Œæ¥åˆ° Azure ä»»æ„ Region ç„¶å¾Œé–‹å§‹ä½¿ç”¨ï¼Œç›¸ç•¶å–®ç´”</p>
<h4 id="2-provider"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#2-provider">2. å–®åœ°å–® Provider é›™å€åŸŸ</a></h4>
<p><img alt="" src="/images/vwan-1-er-2-region.png" /></p>
<p>é€™å€‹æ¶æ§‹åˆ†ç‚ºå…©å€‹ç‹€æ³</p>
<ol>
<li>Azure Region <mark>ä¹‹é–“æœ‰ Peering</mark>: ç¶²è·¯ç›´æ¥ Region to Regionï¼ŒèƒŒå¾Œèµ° MSBB</li>
<li>Azure Region <mark>ä¹‹é–“æ²’æœ‰ Peering</mark>: æµé‡éœ€è¦èµ°å›åœ°ç«¯ï¼Œå†é€éè·¯ç”±åˆ°å¦ä¸€å€‹ Region</li>
</ol>
<p>é—œæ–¼ Azure Region <mark>ä¹‹é–“æœ‰ Peering</mark>ï¼Œè‹¥å› ç‚ºæƒ³åš Region DR è­¬å¦‚èªª
åƒ RISE with SAP Production å’Œ DR ä¹‹é–“çš„ç¶²è·¯æˆ–åŒæ™‚å¯èƒ½æƒ³è·¨åœ‹ä½¿ç”¨ç‰¹å®š Azure Region å…§çš„æœå‹™ï¼Œå°±æœƒé€™æ¨£è¨­è¨ˆï¼Œé€™å€‹å¸¸è¦‹</p>
<p>é—œæ–¼ Azure Region <mark>ä¹‹é–“æ²’æœ‰ Peering</mark>ï¼Œè‹¥æœ‰æœå‹™æµé‡å¼·åˆ¶è¦å›åœ°ç«¯è·¯ç”±åœ¨ä¸Šåˆ°å…¶ä»– Azure Regionï¼Œæ¯”è¼ƒå®¹æ˜“å‡ºç¾é€™æ¶æ§‹ï¼Œè­¬å¦‚èªªæœ‰äº›é˜²ç«ç‰†æˆ–å°å¤–æœå‹™ä¸€å®šè¦ä¸‹åœ°ç«¯çš„ï¼Œæˆ–è€…æ˜¯æœ‰ç‰¹æ®ŠåŸå› å®Œå…¨ä¸èƒ½ä¹Ÿä¸çµ¦ Global VNet Peering (è·¨ Region åš VNet to VNet Peering)ï¼Œé€™å€‹å°‘è¦‹</p>
<h4 id="3-provider"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#3-provider">3. å–®åœ°é›™ Provider é›™å€åŸŸ</a></h4>
<p><img alt="" src="/images/vwan-2-er-1-region.png" /></p>
<p>å°‘è¦‹ï¼Œä¸»è¦æ“”å¿ƒæ€•å–®ä¸€ ExpressRoute Provider æ•´å€‹æ¶ˆå¤±ï¼Œçœä¸€é»ä½œæ³•æœƒæ­ S2S VPN èµ° 2nd ISP åš DR å’Œ Transit Network æ¶æ§‹</p>
<h4 id="4"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#4">4. é›™åœ°é›™å€åŸŸ (æ¨è–¦)</a></h4>
<p><img alt="" src="/images/vwan-2-er-2-region.png" /></p>
<p>Azure è·¨åœ‹ç¶²è·¯å‚³è¼¸ä¸€å®šæœƒé‡åˆ°çš„æ¶æ§‹ï¼Œè¦æ³¨æ„å°ç£è·Ÿç¾åœ‹åœ°ç«¯ç¶²è·¯æ˜¯æœ‰ç›¸é€šçš„ï¼Œç„¶å¾Œè¦åš Global Transit Network Architecture</p>
<p>æœ€å¸¸è¢«è¨è«–çš„å°±æ˜¯è¦ä¸è¦ ExpressRoute Circuit é¸é…å•Ÿç”¨ <a href="https://learn.microsoft.com/zh-tw/azure/expressroute/expressroute-global-reach">Azure ExpressRoute Global Reach</a> å€Ÿé“ MSBB ç¶²è·¯ï¼Œç„¶å¾Œèª¿ä½æ¬Šé‡å»ä¿æœ‰é€£ç·šèƒ½åŠ›ï¼Œä½†éä¸»è¦é€£ç·šæ–¹å¼ï¼Œç„¶å¾Œè¨è«–å¤–éƒ¨ç«™é»è¦ä¸è¦ä¸Š SD-WAN è§£æ±ºæ–¹æ¡ˆï¼Œå¦‚ VMware SD-WANã€Fortinet SD-WAN æˆ–è€…æ˜¯ IPSec Tunnel ä¸€æ¢ä¸€æ¢è¨­å®šåˆ° Azure VPN Gateway</p>
<p>æœ€å¾Œå°±æ˜¯å„ç¨®æ•´é«”è·¯ç”±æœ€ä½³åŒ–å’Œè³‡å®‰ Firewall çš„è¨è«–</p>
<h3 id="optimized-routing"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#optimized-routing">è·¯ç”±æœ€ä½³åŒ– (Optimized routing)</a></h3>
<p>å°æ–¼æœ‰ 2 æ¢ç·šè·¯ä»¥ä¸Šçš„æ¶æ§‹ï¼Œç„¡è«–æ˜¯ IPSec Tunnel é‚„æ˜¯ ExpressRoute Circuitï¼Œè‹¥æƒ³è¦æ§åˆ¶è·¯ç”±èµ°æ³•çš„è©±ï¼Œä¾åºæœ‰ 4 ç¨®æœ‰æ•ˆåšæ³•:</p>
<ol>
<li>æ–¼åœ°ç«¯è·¯ç”±å™¨ä¸Š Route advertising æŒ‡å®šåå¥½çš„ ExpressRoute Circuit</li>
<li>å°æ–¼åå¥½çš„ Expressroute Circuit è¨­å®šè¼ƒé«˜çš„è·¯ç”±æ¬Šé‡ (Connection Weight): å»ºè­°è¦ç”¨ï¼Œå› ç‚ºæ­ S2S VPN ä½œç‚ºå‚™ä»½ç·šè·¯æ™‚å€™ï¼Œå…©æ¢ç·šè·¯ç­‰é‡æ™‚ï¼Œæœ‰å¯èƒ½æ¢å¾©ä¹‹å¾Œæ²’åˆ‡å›ä¾†ï¼Œè©³åƒ <a href="https://learn.microsoft.com/zh-tw/azure/expressroute/expressroute-optimize-routing#path-selection-on-microsoft-and-public-peerings">Suboptimal routing from customer to Microsoft</a></li>
<li>å°æ–¼åå¥½çš„ Expressroute Circuit è¨­å®šè¼ƒå°‘çš„ BGP AS Path prepend: å…¶å¯¦é€™å¥è©±æ‡‰è©²è¦èªªï¼Œå°æ–¼éåå¥½çš„è¦è¨­å®š BGP AS Path prependï¼Œè©³åƒ <a href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-optimize-routing#solution-use-as-path-prepending">Solution: use AS PATH prepending</a></li>
<li>æ–¼åœ°ç«¯é‡å°åå¥½çš„è·¯ç”±å°ç‰¹å®šå€åŸŸçš„ BGP Community è¨­é«˜ Local Preferecne æ•¸å€¼ï¼Œè©³åƒ <a href="https://learn.microsoft.com/en-us/azure/expressroute/expressroute-optimize-routing#solution-use-bgp-communities">Solution: use BGP Communities</a></li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#qa">Q&amp;A</a></h3>
<h4 id="q1-expressroute-provider"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q1-expressroute-provider">Q1: ExpressRoute Provider è¦å»å“ªè£¡æŸ¥?</a></h4>
<p>A1: é€™é‚ŠæŸ¥ <a href="https://azure.microsoft.com/zh-tw/global-infrastructure/expressroute/">ExpressRoute Provider</a> å¸¸è¦‹å¤§æ¦‚å°±æ˜¯ Taipei çš„ä¸‰å®¶ ISP: ChungHwa Telecom, Chief Telecom, FarEasTone</p>
<h4 id="q2-azure-expressroute"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q2-azure-expressroute">Q2: æŠ€è¡“è§£é‡‹ä¸€ä¸‹ Azure ExpressRoute</a></h4>
<p>A2: å¾åœ°ç«¯ Customer Edge (CE) åˆ° Azure MSEE é€™æ®µæ˜¯èµ° <code>802.1ad (QinQ)</code> ï¼Œæ‰€ä»¥å¯¦å‹™ä¸Šéœ€è¦æº–å‚™ä¸€å€‹ VLAN ç•¶ä½œ c-tag ä½œç‚ºé€£ç·šä¹‹ç”¨ï¼Œå…¶ä»–é€£ç·šè¨­å®š Provider æœƒè™•ç†å¥½ï¼Œè€Œ MSEE ä¹‹å¾Œå°±æ˜¯ Microsoft Backbone (MSBB) éª¨å¹¹ç¶²è·¯ï¼Œé€™å€‹éª¨å¹¹ç¶²è·¯æ˜¯ Microsoft è‡ªå·±ç¶­è­·çš„ï¼Œå¯ä»¥ç¢ºä¿é«˜å¯é /é«˜å®‰å…¨/é€Ÿåº¦å¿«/ä½å»¶é²</p>
<h4 id="q3-azure-expressroute"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q3-azure-expressroute">Q3: ç™½è©±æ–‡è§£é‡‹ä¸€ä¸‹ Azure ExpressRoute</a></h4>
<p>A3: å°±æ˜¯...å°ˆç·š/é»å°ˆï¼Œåªæ˜¯æ˜¯å°ˆé–€é€£åˆ° MSBB å»çš„</p>
<h4 id="q4-azure-expressroute-global-reach"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q4-azure-expressroute-global-reach">Q4: ç™½è©±æ–‡è§£é‡‹ä¸€ä¸‹ Azure ExpressRoute Global Reach</a></h4>
<p>A4: å€Ÿé“ Microsoft Backbone (MSBB) éª¨å¹¹ç¶²è·¯ä¾†å‚³éè·¨åœ‹çš„æµé‡ï¼Œå¢åŠ ç¶²è·¯éŸŒæ€§ï¼Œå¯ä»¥é¸é€™å€‹</p>
<h4 id="q5-southeast-asia-pop-expressroute-gateway-southeast-asia-east-asia"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q5-southeast-asia-pop-expressroute-gateway-southeast-asia-east-asia">Q5: è‹¥ä¸»è¦æœå‹™åœ¨æ–°åŠ å¡ (Southeast Asia)ï¼Œä½†å»æ–°åŠ å¡çš„æµé‡æœƒå¾é¦™æ¸¯ PoP é€²å»ï¼Œé‚£é€™æ¨£ ExpressRoute Gateway è¦é¸å»ºç«‹åœ¨æ–°åŠ å¡ (Southeast Asia) é‚„æ˜¯é¦™æ¸¯ (East Asia)?</a></h4>
<p>A5: ExpressRoute Gateway è¦å»ºåœ¨æ–°åŠ å¡ (Southeast Asia)ï¼Œå› ç‚ºæµé‡å¯¦éš›ä¸‹è»Šé»åœ¨é‚£ï¼Œå¦‚æœå»ºç«‹åœ¨é¦™æ¸¯ (East Asia)ï¼Œå‰‡é‚„éœ€è¦é¡å¤–å»ºç«‹ Global VNet Peering åˆ°æ–°åŠ å¡æ‰æœ‰è¾¦æ³•é€£åˆ°é‚£é‚Šçš„æœå‹™</p>
<h4 id="q6-azure-expressroute-dr"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q6-azure-expressroute-dr">Q6: Azure ExpressRoute çš„ DR æ€éº¼åš?</a></h4>
<p>A6: æ¯å€‹ç«™é»å»ºè­°éƒ½å¤šé… S2S VPN ä½œç‚ºå‚™æ´æˆ–å…¶ä»–å¯è·¯ç”±çš„æ–¹å¼ä¾†ç¢ºä¿é€£ç·šï¼Œè©³æƒ… <a href="https://learn.microsoft.com/en-us/azure/expressroute/use-s2s-vpn-as-backup-for-expressroute-privatepeering">Using S2S VPN as a backup for ExpressRoute private peering</a></p>
<h4 id="q7-expressroute-vm-latency"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q7-expressroute-vm-latency">Q7: æˆ‘è¦æ€éº¼çŸ¥é“ç”¨ ExpressRoute åˆ°å¾æˆ‘å®¶åˆ°ç‰¹å®šå€åŸŸçš„ VM Latency æ˜¯å¤šå°‘?</a></h4>
<p>A7: é€™å€‹éœ€è¦ ExpressRoute Provider çš„é…åˆï¼Œå› ç‚ºæœ€å¾Œä¸€å“© (Last Mile) åªæœ‰ä»–å€‘çŸ¥é“å¾ä»–å€‘å®¶çš„è·¯ç”±é€² Microsoft PoP æ˜¯å¤šå°‘</p>
<p>ä½†å¦‚æœæ˜¯æƒ³çŸ¥é“ Azure Region to Azure Region RTT P50 çš„å€¼å€’æ˜¯å¯ä»¥åƒè€ƒ <a href="https://learn.microsoft.com/en-us/azure/networking/azure-network-latency">Azure network round-trip latency statistics</a>ï¼Œå€‹äººæœ‰ä¸‰åœ°å¯¦æ¸¬éç›¸ç•¶æº–</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HCJeuQIiLws" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<h4 id="q8-expressroute"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q8-expressroute">Q8: å¦‚æœæˆ‘æœå‹™åœ¨ä¸­åœ‹å¢ƒå…§è¦æ€éº¼é€é ExpressRoute æ¥åˆ°åœ‹éš›?</a></h4>
<p>A8: å¸¸è¦‹æ˜¯æŠŠ ExpressRoute æ¥åˆ° East Asia å…§ï¼Œä½†é€™é¡Œç›®æœ‰é»è¤‡é›œä¸æ˜¯ä¸€å¥è©±å¯ä»¥è§£æ±ºçš„ï¼Œå»ºè­°è¦è©¢å•ä¸€ä¸‹ Azure æ¶æ§‹å¸«</p>
<h4 id="q9-azure-cross-region-global-transit-network-architecture"><a class="toclink" href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/#q9-azure-cross-region-global-transit-network-architecture">Q9: å¦‚æœæˆ‘é€£ Azure Cross Region éƒ½è¦é€£åœ¨ä¸€èµ·ï¼Œé‚£æœ€çµ‚ Global Transit Network Architecture æœƒé•·æˆæ€æ¨£?</a></h4>
<p>A9: å»ºè­°æ¡ç”¨ Azure vWANï¼ŒåŠŸèƒ½å…¨é–‹çš„ç‹€æ³ä¹‹ä¸‹æœƒè®Šæˆä¸‹åœ–</p>
<p><img alt="" src="/images/enable-ergb-wih-bow-tie.png" /></p>
<p>é€™åœ–æœ‰ä¸€å †ç½å®³æƒ…å¢ƒå¯ä»¥è§£é‡‹è·¯ç”±è®ŠåŒ–ï¼Œä¸åœ¨æœ¬æ–‡è©³è¿°</p>
    <nav class="md-post__action">
      <a href="../../2023/02/02/%E6%BB%91%E9%BC%A0%E9%BB%9E%E9%BB%9E%E4%B9%8B%E8%B7%A8%E5%9C%8B-azure-expressroute-%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-10-05 00:00:00">October 5, 2022</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pod"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/">å¯¦ç¾ä¸åœæ©Ÿçš„ Pod æ›´æ–°æ–¹å¼</a></h2>
<p><img alt="" src="https://learnk8s.io/a/55d21503055aaf9ef8a04d5e595ed505.png" />
Source from <a href="https://learnk8s.io/graceful-shutdown">Learnk8s - Graceful shutdown and zero downtime deployments in Kubernetes</a></p>
<!--more-->

<p>å¦‚æœä½ æœ‰ä¸€å€‹æŒçºŒä¸æ–·çš„æœå‹™ï¼Œå¦‚ Long-lived TCP connections æˆ–è€…æ˜¯æ‡‰ç”¨ç¨‹å¼é—œé–‰è¦è·‘å¾ˆä¹…çš„ï¼Œéœ€è¦ "Graceful shutdown Pod" çš„è©±</p>
<p>ä¸æ”¹ç¨‹å¼çš„ç‹€æ³ä¸‹ï¼Œæœ‰ä½ å¯ä»¥æœ‰ 2 å€‹æ²»æ¨™ä¸æ²»æœ¬çš„æ–¹å¼ä¾†é”æˆé€™ä»¶äº‹</p>
<ul>
<li>å»¶é² SIGTERM çš„è¨Šè™Ÿç™¼é€ï¼ŒpreStop Hook è¨­å®šä¹…ä¸€é»è®“ä»–ç¡ä¸€ä¸‹ (wait)</li>
</ul>
<div class="highlight"><span class="filename">preStop_sample</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>apiVersion: v1
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>kind: Pod
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>metadata:
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  name: lifecycle-demo
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>spec:
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>  containers:
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>  - name: lifecycle-demo-container
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    image: nginx
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    lifecycle:
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>      preStop:
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        exec:
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="hll">          command: [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;nginx -s quit; while killall -0 nginx; do sleep 10; done&quot;] # (1)
</span></code></pre></div>
<ol>
<li>
<p>Sleep for 10 seconds before sending SIGTERM to the main process</p>
</li>
<li>
<p>å»¶é² SIGKILL çš„ç™¼ç”Ÿï¼ŒæŠŠ terminationGracePeriodSeconds (default 30s) è¨­å®šé•·ä¸€é»ï¼Œè­¬å¦‚ä¸‹é¢çš„ç¯„ä¾‹</p>
</li>
</ol>
<div class="highlight"><span class="filename">terminationGracePeriodSeconds_sample</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>---
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>apiVersion: v1
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>kind: Pod
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>metadata:
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  name: pods-termination-grace-period-seconds
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>spec:
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>  containers:
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>      image: nginx
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>      name: pods-termination-grace-period-seconds
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  terminationGracePeriodSeconds: 3600  # (1)
</code></pre></div>
<ol>
<li>Time to wait before moving from a TERM signal to the pod's main process to a KILL signal.</li>
</ol>
<p>å¦‚ä½•é¸æ“‡?</p>
<p>å¦‚æœä½ ç¨‹å¼é—œé–‰æ™‚ä¸éœ€è¦è™•ç†ä»»ä½•ç‹€æ…‹æˆ–åŒæ­¥è³‡æ–™ï¼Œé‚£å°±åªè¦è¨­å®š preStop å°±å¥½äº†ï¼Œå¦‚æœæ˜¯é‚£ç¨®å·²çŸ¥ç¨‹å¼é—œé–‰å·²çŸ¥è¦è·‘å¾ˆä¹… (&gt;30s) çš„ç¨‹å¼ï¼Œå»ºè­° preStop å’Œ terminationGracePeriodSeconds éƒ½è¦æ‹‰é•·ä¸€é»ï¼Œé€™æ¨£å°±èƒ½ç¢ºä¿ Pod é—œé–‰æ™‚ä¸æœƒæœ‰éˆç•°ç¾è±¡ç™¼ç”Ÿ</p>
<p>æ²»æœ¬ä½œæ³•æ˜¯: ç¨‹å¼æ”¶åˆ° SIGTERM è¨Šè™Ÿçš„æ™‚å€™ï¼Œç¨‹å¼è¦è‡ªå·±çŸ¥é“æ€éº¼é—œé–‰æœå‹™ï¼Œä¸è¦è®“åº•ä¸‹ Kubernetes å¹«ä½ ç¡¬é—œæ©Ÿ</p>
<h3 id="case-study-nginx-ingress-controller"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/#case-study-nginx-ingress-controller">Case Study: Nginx Ingress Controller</a></h3>
<p>ä¸‰ç®¡é½Šä¸‹: ä½¿ç”¨ preStop Hook + SIGTERM + terminationGracePeriodSeconds</p>
<p>é—œæ–¼ preStop çš„è™•ç†ï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L456-L460">ingress-nginx/deploy/static/provider/cloud/deploy.yaml#L456-L460</a>ï¼Œé€™é‚Šæœƒå»å‘¼å« waitshutdown é€™å€‹æŒ‡ä»¤ï¼Œå†è£¡é¢å»è™•ç† SIGTERM çš„è¨Šè™Ÿ</p>
<div class="highlight"><span class="filename">ingress-nginx/deploy/static/provider/cloud/deploy.yaml</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>        lifecycle:
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>          preStop:
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>            exec:
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>              command:
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="hll">              - /wait-shutdown
</span></code></pre></div>
<p>é—œæ–¼ terminationGracePeriodSecondsï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L512">ingress-nginx/deploy/static/provider/cloud/deploy.yaml#L512</a></p>
<div class="highlight"><span class="filename">ingress-nginx/deploy/static/provider/cloud/deploy.yaml</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="hll">        terminationGracePeriodSeconds: 3600
</span></code></pre></div>
<p>é—œæ–¼ SIGTERM çš„è™•ç†ï¼Œç¯€éŒ„ <a href="https://github.com/kubernetes/ingress-nginx/blob/main/cmd/waitshutdown/main.go#L28-L42">ingress-nginx/cmd/waitshutdown/main.go#L28-L42</a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ingress-nginx/cmd/waitshutdown/main.go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>func main() {
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="hll">    err := exec.Command(&quot;bash&quot;, &quot;-c&quot;, &quot;pkill -SIGTERM -f nginx-ingress-controller&quot;).Run()
</span><a id="__codelineno-14-3" name="__codelineno-14-3"></a>    if err != nil {
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>        klog.ErrorS(err, &quot;terminating ingress controller&quot;)
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>        os.Exit(1)
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>    }
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>    // wait for the NGINX process to terminate
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>    timer := time.NewTicker(time.Second * 1)
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>    for range timer.C {
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>        if !nginx.IsRunning() {
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>            timer.Stop()
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>            break
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>        }
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>    }
</code></pre></div></td></tr></table></div>
<h3 id="references"><a class="toclink" href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/#references">References</a></h3>
<ul>
<li><a href="https://engineering.rakuten.today/post/graceful-k8s-delpoyments/">Rakuten Developer - Zero-Downtime Rolling Deployments in Kubernetes</a></li>
<li><a href="https://www.facebook.com/groups/cloudnative.tw/posts/1470137983489532/">Facebook åŸæ–‡</a></li>
<li><a href="https://learnk8s.io/graceful-shutdown">Graceful shutdown and zero downtime deployments in Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/containers/container-lifecycle-hooks/">Kubernetes - Container Lifecycle Hooks</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2022/10/05/%E5%AF%A6%E7%8F%BE%E4%B8%8D%E5%81%9C%E6%A9%9F%E7%9A%84-pod-%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2022-02-16 00:00:00">February 16, 2022</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="1-kubernetes-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/">æˆ‘è¦ 1 åº§ Kubernetes é‚„æ˜¯è¦å¤šåº§ Kubernetes? é‚„æ˜¯éƒ½å¯ä»¥?</a></h2>
<p>æ›¾ç¶“æ–¼ <a href="https://www.youtube.com/watch?v=-y-aycTxKBA">SDN x Cloud Native Meetup #42 OPA + å–®å¤šå¢é›†æ¶æ§‹æ¢è¨</a>ã€<a href="https://docs.google.com/presentation/d/1GBInjH45Vremz4_463T3Z5VK9CC_atpYSI-4yAY8QuE/edit#slide=id.p">ç°¡å ±</a> åˆ†äº«é <code>Kubernetes å¤šå¢é›†åŠå–®å¢é›†æ¶æ§‹é¸æ“‡æ¢è¨</code> çš„é¡Œç›®ï¼Œç•¶ä¸­æœ‰å¤šç§Ÿæˆ¶è­°é¡Œé‚„è »å—åˆ°é—œæ³¨çš„ï¼Œå‰›å¥½å› ç‚ºå·¥ä½œé—œä¿‚ä¹Ÿæœ‰è »å¤šå®¢æˆ¶åœ¨å•ç›¸åŒçš„é¡Œç›®ï¼Œé€™é‚Šæƒ³ç”¨æ–‡å­—çš„æ–¹å¼ç´€éŒ„ä¸€ä¸‹ï¼Œä¾›å¤§å®¶åƒè€ƒ</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-y-aycTxKBA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<!--more-->

<h3 id="q1-1-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q1-1-kubernetes">Q1: ä½•è¬‚ 1 åº§ Kubernetes?</a></h3>
<p><code>å¯å–®ç¨é‹è¡Œä¹‹ Kubernetes API ç‚ºæœ€å°ç®¡ç†å–®ä½</code>ï¼Œè·Ÿè©²åº§ Kubernetes åº•ä¸‹æœ‰å¤šå°‘ç¯€é»å®Œå…¨ç„¡é—œï¼Œç„¡è«–æ˜¯ Control Plane æˆ– Worker Planeã€‚å¯¦å‹™ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl cluster-info</code> ä¾†åšåˆ¤æ–·</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</code></pre></div>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå›  Kubernetes çš„è¨­è¨ˆæ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦è·Ÿ Kubernetes API Server é€²è¡Œï¼Œè©²æœå‹™é è¨­ä¸€å®šæœƒå»ºç«‹åœ¨ <code>Control Plane</code> ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>https://192.168.100.1:8443</code> ä¾†é€²è¡Œæºé€šï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ 2 å€‹ä»¥ä¸Šçš„ Kubernetes å¢é›†ï¼Œå‹¢å¿…æœƒç²å¾—åˆ°ä¸ä¸€æ¨£çš„ Kubernetes cluster-info è³‡è¨Š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="gp"># </span>ä½¿ç”¨å¢é›†<span class="w"> </span>Dev-and-Staging-Cluster
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="go">kubectl config use-c context Dev-and-Staging-Cluster</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="gp"># </span>Kubernetes<span class="w"> </span>å¢é›†<span class="w"> </span>Dev-and-Staging-Cluster
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="gp"># </span>åˆ‡æ›è‡³å¢é›†<span class="w"> </span>Prod-Cluster
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="go">kubectl config use-context Prod-Cluster</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="gp"># </span>Kubernetes<span class="w"> </span>å¢é›†<span class="w"> </span>Prod-Cluster
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="go">Kubernetes control plane is running at https://192.168.200.1:8443</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="go">CoreDNS is running at https://192.168.200.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
</code></pre></div>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œé€é <code>kubectl config use-context</code> å¯ä»¥åˆ‡æ›è‡³å…¶ä»–å¢é›†é€²è¡Œæ“ä½œï¼Œä½ æœƒç™¼ç¾åˆ° 2 å€‹å¢é›†çš„ Control Plane ç¶²å€æ˜¯ä¸ä¸€æ¨£çš„ <code>https://192.168.100.1:8443</code> è·Ÿ <code>https://192.168.200.1:8443</code>ï¼Œé€™ä»£è¡¨ä½ åœ¨è·Ÿä¸åŒçš„å¢é›†åœ¨é€²è¡Œæ“ä½œ</p>
<p>ä¸Šè¿°æµç¨‹è‹¥ä½ æœ‰å»è€ƒé CNCF 3 å€‹è€ƒè©¦</p>
<ul>
<li>Certified Kubernetes Administrator (CKA)</li>
<li>Certified Kubernetes Application Developer (CKAD)</li>
<li>Certified Kubernetes Security Specialist (CKS)</li>
</ul>
<p>æ‡‰è©²æœƒè¦ºå¾—ç›¸ç•¶ç†Ÿæ‚‰ï¼Œå› ç‚ºè€ƒè©¦çš„æ™‚å€™ä¹Ÿæœƒè¦ä½ åˆ‡ä¾†åˆ‡å»ï¼Œå…¶å¯¦å°±æ˜¯é¿å…ä¸åŒçš„è€ƒé¡Œæ‰€éœ€çš„ç’°å¢ƒå½±éŸ¿åˆ°å½¼æ­¤ï¼Œå±¬æ–¼å¯¦é«”æ–¹å¼éš”é›¢ Kubernetes å¢é›†</p>
<h3 id="q2-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q2-kubernetes">Q2: Kubernetes å¤šç§Ÿæˆ¶éš”é›¢æ¶æ§‹æœ‰å¤šå°‘ç¨®é¡å‹?</a></h3>
<p>åŒ¯ç¸½ <a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">AKS</a>ã€<a href="https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/">EKS</a>ã€<a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">GKE</a> ä¸‰å®¶å…¬æœ‰é›²çš„å¯¦è¸ä½œæ³•ï¼Œæœƒå€åˆ†æˆ 2 å€‹æ–¹å‘ï¼Œ</p>
<ol>
<li>ä»¥é‚è¼¯æ–¹å¼éš”é›¢ Kubernetes å¢é›†ï¼Œä¹Ÿå°±æ˜¯è»Ÿå¤šç§Ÿæˆ¶ (Soft Multi-Tenancy)</li>
<li>ä»¥å¯¦é«”æ–¹å¼éš”é›¢ Kubernetes å¢é›†ï¼Œä¹Ÿå°±æ˜¯ç¡¬å¤šç§Ÿæˆ¶ (Hard Multi-Tenancy)</li>
</ol>
<p>é‚„æœ‰ä¸€ç¨®æ¯”è¼ƒç‰¹æ®Šçš„ç¡¬å¤šç§Ÿæˆ¶ï¼Œåƒ…æœƒå‡ºç¾åœ¨ Kubernetes å¹³å°ä¾›æ‡‰å•†æ–¹çš„è»Ÿé«”æ¶æ§‹è¨­è¨ˆï¼Œå› ç‚ºæˆ‘é€™ç¯‡ä¸»è¦æ˜¯å¯«çµ¦å–®ç´”çš„ Kubernetes ä½¿ç”¨è€…çœ‹ï¼Œæ‰€ä»¥ä¸åˆ—å…¥è¨è«–</p>
<h3 id="q3-soft-multi-tenancy"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q3-soft-multi-tenancy">Q3: è»Ÿå¤šç§Ÿæˆ¶ (Soft Multi-Tenancy) çš„é‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</a></h3>
<p>ä¸‹é¢å¼•ç”¨ <a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">åœ¨ Azure Kubernetes Service (AKS) ä¸­éš”é›¢å¢é›†çš„æœ€ä½³åšæ³•</a> çš„ç¤ºæ„åœ–</p>
<p><img alt="" src="/images/logical-isolation.png" /></p>
<p>ä»¥é€šé <a href="https://github.com/cncf/k8s-conformance">CNCF Conformance</a> ç‚ºä¸»çš„ Kubernetes å¢é›†ç‚ºä¸»ï¼Œé‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µä¸»è¦å€åˆ† 4 å€‹ä½œæ³•</p>
<ol>
<li>Kubernetes Namespaceï¼šå–®ä¸€å¢é›†å…§éƒ¨å‘½åç©ºé–“éš”é›¢</li>
<li>Kubernetes Network Policyï¼šå–®ä¸€å¢é›†å…§éƒ¨ç¶²è·¯éš”é›¢</li>
<li>Kubernetes RBACï¼šå–®ä¸€å¢é›†æ¬Šé™éš”é›¢</li>
<li>Resource Quotaï¼šå–®ä¸€å¢é›†å…§ä¹‹è¨ˆç®—è³‡æºéš”é›¢</li>
</ol>
<p>å¯¦éš›ä¸Šå°±æ˜¯æ‹¿åˆ° 1 åº§ Kubernetes å¢é›†å¾Œï¼Œé‡å°è©²å¢é›†é€²è¡Œä¸Šè¿° 4 å€‹ä½œæ³•çš„é‚è¼¯éš”é›¢ä¾†é€²è¡Œè³‡æºéš”é›¢ï¼Œä½†æœ€å°æ“ä½œå–®ä½æ˜¯ <code>Kubernetes Namespace</code> ç‚ºä¸»ï¼Œè€Œåº•å±¤è¨ˆç®—è³‡æºå¤§å®¶æ˜¯å…±ç”¨çš„ï¼Œå¦‚ä¸‹æ‰€åˆ—ï¼Œæˆ‘é€™åº§ <code>https://192.168.100.1:8443</code> å¢é›†è½„ä¸‹çš„ Kubernetes Namespace å¯é€é <code>kubectl create ns &lt;NAME&gt;</code> æ–°å¢ Namespaceï¼Œé™¤äº†ç³»çµ±å¿…è¦çš„ Namespace ä»¥å¤–ï¼Œå¦å¤–é‚„æ–°å¢äº† 3 å€‹é¢å‘å°ˆæ¡ˆæˆ–æ‡‰ç”¨çš„ DevTeam1ã€DevTeam2ã€Staging Namespace ä¾›å„åˆ¥æœå‹™ä½¿ç”¨</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="gp"># </span>ä»¥<span class="w"> </span>Dev<span class="w"> </span>and<span class="w"> </span>Staging<span class="w"> </span>Cluster<span class="w"> </span>ç‚ºä¾‹
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="gp">$ </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="go">Kubernetes control plane is running at https://192.168.100.1:8443</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="go">CoreDNS is running at https://192.168.100.1:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>namespace
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="go">NAME                        STATUS   AGE</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="go">default                     Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="go">DevTeam1                    Active   14s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="go">DevTeam2                    Active   14s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="go">kube-node-lease             Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="go">kube-public                 Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="go">kube-system                 Active   16h &lt;- Kubernetes é è¨­</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="go">local-path-storage          Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="go">Staging                     Active   10s &lt;- ä½¿ç”¨è€…è‡ªå·±å»ºçš„</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="go">tanzu-package-repo-global   Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="go">tanzu-system-ingress        Active   10h &lt;- ç‰¹å®šå» å•†é è¨­</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="go">tkg-system                  Active   16h &lt;- ç‰¹å®šå» å•†é è¨­</span>
</code></pre></div>
<p>é€™æ–¹å¼ä¹Ÿæ˜¯çµ•å¤§éƒ¨åˆ†åœ¨å­¸ Kubernetes çš„ç¶­é‹ç®¡ç†æ“ä½œçš„æ™‚å€™ï¼Œè‘—å¢¨æ¯”è¼ƒå¤šçš„å¸¸è¦‹è§’åº¦åŠå¸¸è¦‹å­¸ç¿’è·¯å¾‘</p>
<h3 id="q4-hard-multi-tenancy"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q4-hard-multi-tenancy">Q4: ç¡¬å¤šç§Ÿæˆ¶ (Hard Multi-Tenancy) çš„å¯¦é«”æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</a></h3>
<p>æ©...é€™å€‹å…¶å¯¦æ²’æœ‰ä»€éº¼è¨£ç«…ï¼Œå°±æ˜¯<code>å†å»ºç«‹ 1 åº§ Kubernetes</code>å°±å¥½ï¼Œæœ‰ç¨ç«‹çš„ Kubernetes APIã€ç¨ç«‹çš„è¨ˆç®—ç¶²è·¯å„²å­˜è³‡æºï¼Œè»Ÿå¤šç§Ÿæˆ¶çš„é‚è¼¯æ–¹å¼éš”é›¢ä¹Ÿå¯ä»¥å®Œå…¨ä½¿ç”¨</p>
<p><img alt="" src="https://docs.microsoft.com/zh-tw/azure/aks/media/operator-best-practices-cluster-isolation/physical-isolation.png" /></p>
<p>é æœŸæœ‰é€™éº¼å¤šçš„ Kubernetes å¢é›†è¢«éƒ¨ç½²å‡ºä¾†ï¼Œé‚„æ˜¯è¦èƒ½å¤ è¢«ç®¡ç†ï¼Œä»¥ç¾è¡Œå¸¸è¦‹çš„å¤šå¢é›†ç®¡ç†ä½œæ³•ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ä»¥ä¸‹ï¼š
- å¤šå¢é›†ç¶²è·¯è¦åŠƒï¼ŒåŒ…å«å°å¤–è² è¼‰å‡è¡¡ã€è·¨å¢é›†ç¶²è·¯
- å¤šå¢é›†ç­–ç•¥ç®¡ç†
- Single Sign On å–®ä¸€ç™»å…¥
- é›†ä¸­åŒ–æ—¥èªŒæ”¶é›†
- é›†ä¸­åŒ–è³‡æºç›£æ§
- ...</p>
<h3 id="q5"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q5">Q5: å…©è€…å¯ä¸å¯ä»¥æ··ç”¨?</a></h3>
<p>å¯ï¼Œå¤šå»ºå¹¾åº§ Kubernetes è£¡é¢å†ç”¨ Namespace ç­‰è»Ÿå¤šç§Ÿæˆ¶çš„éš”é›¢æ–¹å¼åˆ‡å‰²ï¼Œå¦‚åœ–æ‰€ç¤º</p>
<p><img alt="" src="https://docs.microsoft.com/zh-tw/azure/aks/media/operator-best-practices-cluster-isolation/logical-isolation.png" /></p>
<ul>
<li>è©³ç´°æè¿°å¦‚ä¸‹</li>
<li>2 åº§ Kubernetes å¢é›†ï¼Œåˆ†åˆ¥ç‚º Dev and Staging Cluster å’Œ Prod Cluster</li>
<li>ç•¶ä¸­ Dev and Staging Cluster å¢é›†å…§ï¼Œå…±æœ‰ 3 å€‹ Kubernets Namespaceï¼Œåˆ†åˆ¥ç‚º DevTeam1ã€DevTeam2ã€Staging</li>
<li>ç•¶ä¸­ Prod Cluster å¢é›†å…§ï¼Œå…±æœ‰ 3 å€‹ Kubernetes Namespace, åˆ†åˆ¥ç‚º Team1ã€Team2ã€Team3</li>
</ul>
<h3 id="q6"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q6">Q6: ç”¨æ§æ™‚æ©Ÿ?</a></h3>
<p>ä¸»è¦åˆ¤æ–·é»å°±æ˜¯ <code>Kubernetes API å¯ä¸å¯ä»¥å…±ç”¨å’Œè³‡æºéš”é›¢æ€§</code>çš„å–æ¨ï¼Œæ›å€‹è§’åº¦ä¾†è¬›ï¼Œå¦‚æœå–®åº§ Kubernetes çˆ†ç‚¸äº†ï¼Œä¸Šé¢çš„å°ˆæ¡ˆä½ èƒ½å¿å—å¤šå°‘æ˜¯æ›æ‰çš„ç‹€æ…‹ï¼Œå¦‚æœä½ ä¸èƒ½å¿å—ï¼Œæ‹†ï¼Œèƒ½å¿å—ï¼Œåˆ</p>
<p>ä¸‹é¢èˆ‰å¹¾å€‹æˆ‘å€‹äººé‡éæœƒå»ºè­°éœ€è¦å»ºå¤šåº§çš„ä¾‹å­ï¼š</p>
<ol>
<li>ä¸åŒç’°å¢ƒçš„ç¶²è·¯éš”é›¢ï¼Œå¦‚ DR / Staging / Dev / Prod //æŠ€è¡“ä¸Šæ²’å¾—è«‡</li>
<li>Kubernetes åˆè¦æ€§ï¼Œå¦‚ PCI-DSSã€HIPPA ç­‰ä¸èƒ½æ–¼åŒä¸€åº§ Kubernetes æ··ç”¨åˆè¦æª¢æ¸¬ //æŠ€è¡“ä¸Šæ²’å¾—è«‡</li>
<li>ä¸åŒå°ˆæ¡ˆæ€§è³ªï¼Œå¦‚æ—¢æœ‰å°æ–¼è³‡è¨Šç³»çµ±çš„æ³•è¦ã€æ ¸å¿ƒç³»çµ±ã€ä»¥ API Gateway ç‚ºä¸»çš„ MASA è¨­è¨ˆã€å…±äº«æœå‹™å¹³å° (CI/CD)ã€GPU åˆ†äº«ã€æŒ‡å®š Kubernetes ç‰ˆæœ¬ç­‰ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººå°æ–¼ç´”åœ°ç«¯å®¢æˆ¶çš„ç†è§£ç›¸ç•¶ä¸å»ºè­°</li>
<li>åº•å±¤ CPU æ¶æ§‹é›†ä¸åŒï¼Œå¦‚ x86_64ã€ppc ç­‰ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººåˆ¤æ–·ç›¸ç•¶ä¸å»ºè­°</li>
<li>ä¸åŒéƒ¨é–€ä¹‹é–“æŠ€è¡“è½å·® / æ¬Šé™ / å…§å¸³åˆ‡å‰²è­°é¡Œï¼Œå¦‚è«‡éŒ¢ä¿è­‰å‚·æ„Ÿæƒ…çš„æ™‚å€™ //æŠ€è¡“ä¸Šå¯ä»¥ï¼Œä½†æˆ‘å€‹äººå°æ–¼ç´”åœ°ç«¯å®¢æˆ¶çš„ç†è§£ç›¸ç•¶ä¸å»ºè­°</li>
</ol>
<p>ä¸Šè¿°æœ‰äº›èªªæŠ€è¡“ä¸Šå¯ä»¥çš„ï¼Œå»ºè­°å¯ä»¥å˜—è©¦æŠŠå°å¼Ÿçš„æ‹™ä½œ <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a> çœ‹å®Œä¹‹å¾Œï¼Œè«‹æ‰€æœ‰è¦ä½åœ¨ä¸€èµ·çš„æœå‹™ä¼°ç®—ä¸€ä¸‹è³‡æºä½¿ç”¨é‡æœ‰è©•ä¼°ä¸‹ç½å®³çˆ†ç‚¸åŠå¾‘ (Blast Radius)ï¼Œå‰è€…è·ŸéŒ¢æœ‰é—œï¼Œå¾Œè€…è·Ÿ SLA æœ‰é—œ</p>
<p>æœ€å¾Œçµ¦å¼µæ¢—åœ–</p>
<p><img alt="" src="/images/haha.jpg" /></p>
<h3 id="q7-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q7-kubernetes">Q7: å¦‚æœå»ºå¤šåº§ Kubernetes ä¸å°±è¦è€—è²»å¾ˆå¤šè³‡æº?</a></h3>
<blockquote>
<p>å€‹äººè§€é»ï¼ŒKubernetes èˆ‡ Cloud OS ä¹‹æ–¼ Linux èˆ‡ OS çš„ç›¸å°é—œä¿‚</p>
</blockquote>
<p>å…¶å¯¦æŠŠ Kubernetes ç•¶ä½œä¸€å€‹é›²åŸç”Ÿä½œæ¥­ç³»çµ± (Cloud OS) çš„è§’åº¦ä¾†çœ‹ï¼Œæ‡‰å°ä¸åŒçš„å°ˆæ¡ˆéœ€æ±‚ï¼Œå¤§å®¶å°æ–¼ Kubernetes çš„è³‡æºå¤§å°ä¹Ÿæœƒæœ‰æ‰€ä¸åŒï¼Œé¡åŒæ–¼é–‹ç™¼äººå“¡è¦å¼„ä¸€å€‹å°ˆæ¡ˆç¸½æ˜¯è¦æå‡ºèªªï¼Œéœ€è¦ä»€éº¼ CPU / Memory / Disk / OS ç”¨å“ªå®¶çš„è³‡æºç”³è«‹ï¼Œé€™æ˜¯å¾ˆåˆç†çš„ï¼Œåªæ˜¯ Kubernetes æ¶æ§‹ä¸Šéœ€è¦å¤šè€ƒé‡ä¸€äº›äº‹æƒ…ï¼Œæ‰€ä»¥ä¿æœ‰ Kubernetes å¢é›†è³‡æºèª¿æ•´å½ˆæ€§åŠé¸æ“‡æ˜¯æ¶æ§‹ä¸Šéœ€è¦è€ƒé‡çš„åœ°æ–¹</p>
<p>æ‰€ä»¥å°å¼Ÿæ‰æœƒæä»¥ 2 å€‹æ–¹å‘çš„è§’åº¦ä¾†å”åŠ©å¤§å®¶å»ç§‘å­¸åœ°è©•ä¼°è³‡æºï¼Œè€Œä¸æ˜¯ä¸Ÿéª°å­çš„ä½œæ³•ï¼Œç•¶ä¸­ä¸€ç¯‡å·²ç¶“å¯«å¥½äº†ï¼Œå¯ä»¥åƒç…§åƒç…§</p>
<ul>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li>å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? Infra è§’åº¦ç¯‡ //é‚„æ²’å‹•åŠ›å¯«ï¼Œè«‹æŸæŸå®¢æˆ¶è´ŠåŠ©ä¸€ä¸‹å‹•åŠ›</li>
</ul>
<p>å¦å¤–é‚„æœ‰ä¸€ç¯‡å¤§æ¦‚ä¹Ÿå°± VMware æ‰æœ‰è³‡æ ¼å¯«çš„å¤šå¢é›† Kubernetes æ–¼è™›æ“¬åŒ–å¹³å°ä¹‹æ•ˆèƒ½å ±å‘Šæ›¸ <a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/vsphere-tanzu-kubernetes-perf.pdf">Performance Best Practices for Kubernetes with VMware Tanzu - Performance Study</a> ä¹Ÿå¯ä»¥åƒè€ƒä¸€ä¸‹ï¼Œå¯«å¾—ç›¸ç•¶é è­œå‹™å¯¦</p>
<h3 id="q8-kubernetes"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#q8-kubernetes">Q8: å¦‚æœæˆ‘å°±æ˜¯åƒ…å»ºä¸€åº§ Kubernetes è£¡é¢æœå‹™å¡å¥½å¡æ»¿å¯ä¸å¯ä»¥?</a></h3>
<p>å¯ï¼Œä½†è¦ç¢ºä¿å°æ–¼ <code>Q3: è»Ÿå¤šç§Ÿæˆ¶çš„é‚è¼¯æ–¹å¼éš”é›¢æ‰‹æ®µæœ‰å“ªä¸€äº›?</code> æ‰€æä¹‹é‚è¼¯éš”é›¢æ‰‹æ®µï¼Œæ‰€æœ‰åƒèˆ‡ä¹‹ä¸Šçš„ç§Ÿæˆ¶éƒ½è¦æœ‰ç›¸åŒçš„èªçŸ¥ï¼Œç„¶å¾Œè¨­è¨ˆè©² Kubernetes å¢é›†çš„æ¶æ§‹å¸«ï¼Œå‹™å¿…è¦ç›¸ç•¶ç†Ÿæ‚‰é€šç›¤çš„ç¶²è·¯æ¶æ§‹ï¼Œç„¡è«–æ˜¯ Kubernetes å…§éƒ¨æˆ–è€…æ˜¯å¤–éƒ¨</p>
<h3 id="references"><a class="toclink" href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/#references">References</a></h3>
<ul>
<li><a href="https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/">EKS Best Practices Guides - Tenant Isolation</a></li>
<li><a href="https://docs.microsoft.com/zh-tw/azure/aks/operator-best-practices-cluster-isolation">åœ¨ Azure Kubernetes Service (AKS) ä¸­éš”é›¢å¢é›†çš„æœ€ä½³åšæ³•</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/best-practices/enterprise-multitenancy#assumptions_and_requirements">GKE ä¼ä¸šçº§å¤šç§Ÿæˆ·æœ€ä½³åšæ³•</a></li>
<li><a href="https://github.com/cncf/k8s-conformance">cncf/k8s-conformance</a></li>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource/">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li><a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/vsphere-tanzu-kubernetes-perf.pdf">Performance Best Practices for Kubernetes with VMware Tanzu - Performance Study</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2022/02/16/%E6%88%91%E8%A6%81-1-%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E8%A6%81%E5%A4%9A%E5%BA%A7-kubernetes-%E9%82%84%E6%98%AF%E9%83%BD%E5%8F%AF%E4%BB%A5/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-12-31 00:00:00">December 31, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2021"><a class="toclink" href="../../2021/12/31/2021-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/">2021 å¹´åº¦å€‹äººå›é¡§</a></h2>
<p>åˆä¸€å€‹å®Œæ•´çš„æ—¥æ›†å¹´éäº†ï¼Œä¾†å€‹å¹´åº¦å›é¡§ç´€éŒ„ï¼ŒéŸ³æ¨‚èµ·ï¼</p>
<p>{% youtube PlCbgZxonJs %}</p>
<!--more-->

<blockquote>
<p>æ‹œæ‹œ</p>
</blockquote>
<p>2021 é€™å¹´å¯ä»¥ç”¨ "æ™‚å…‰å›æº¯" ä¾†ç¸½çµï¼Œå¥½åƒè·Ÿæˆ‘å…©å¹´å‰çš„æ—¥å­æ²’å•¥ä¸ä¸€æ¨£å•Š...ç„¡è«–æ˜¯å·¥ä½œé‚„æ˜¯æ„Ÿæƒ…ï¼Œè€Œä¸”ä¸çŸ¥é“ç‚ºä»€éº¼éš¨è‘—å¹´ç´€å¢é•·ï¼Œä½œé¢¨å»è¶Šä¾†è¶Šé¾œï¼Œæ˜æ˜å¤§å­¸æ™‚ä»£å°±æ˜¯èµ°æµªå­è·¯ç·šçš„å•Šï¼æˆ‘è©²æ˜¯è¦ä¾†ä¿®æ­£ä¸€ä¸‹äººç”Ÿäº†...</p>
<h3 id="2021_1"><a class="toclink" href="../../2021/12/31/2021-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#2021_1">2021 å›é¡§</a></h3>
<ol>
<li>2021 ç”Ÿæ—¥ç•¶å¤©é›¢é–‹äº† 3y2m çš„ Red Hat æ›çƒéšŠå» VMware æ‰“çƒï¼Œ<a href="https://www.facebook.com/paulintoro/posts/4657972594217756">è©³åƒè²¼æ–‡</a></li>
<li><a href="https://blog.pichuang.com.tw/record/">2021 å¹´åº¦æ¼”è¬› 10 å ´</a>ï¼Œæ•´é«”æ¯” 2020 å¹´é™ä½ 9 å ´ï¼Œæˆ‘åªèƒ½èªªå‰åŠå¹´çœŸçš„æ˜¯ç¥å¿™ï¼Œå¾ŒåŠå¹´åº•æ‰å›é­‚</li>
<li><a href="https://blog.pichuang.com.tw/archives/">2021 å¹´åº¦æ–‡ç«  3 ç¯‡</a>ï¼Œæ¯” 2020 å¹´å¤§å¹…é™ä½äº† 32 ç¯‡ï¼Œæˆ‘åªèƒ½èªªå‰åŠå¹´çœŸçš„æ˜¯å¤ªå¿™ï¼Œå¾ŒåŠå¹´åº•æ‰å›é­‚</li>
<li><a href="https://www.youtube.com/channel/UCSDL3DA39lZh_qX6alaIwug/videos">2021 å¹´éŒ„äº† 23 å€‹ YouTube å½±ç‰‡</a>ï¼ŒçœŸæ²’æƒ³åˆ°æˆ‘éŒ„é€™éº¼å¤š...</li>
<li>2021 å¹´é–‹å§‹èªçœŸæ¥è§¸å…¬æœ‰é›²ä¸€èµ·å­¸ï¼ŒåŒ…å« 3 å®¶ Azure, GCP, AWSï¼Œæˆ‘åªèƒ½èªªé€™å¹´é ­æ•´é«”æŠ€è¡“ç™¼å±•å°åœ°ç«¯ Infra æŠ€èƒ½ç‚ºåŸºç¤çš„å®…å®…ç›¸ç•¶ä¸å‹å–„ = =</li>
<li>2021 æ¼”è¬› <a href="https://speakerdeck.com/pichuang/20210824-yun-yuan-sheng-ren-cai-xun-zhao-de-nan-chu-ji-chang-jian-wu-qu-tan-tao">é›²åŸç”Ÿäººæ‰? çœ‹å¾—åˆ°ï¼Œæ‰¾ä¸åˆ°</a> 4.3k äººé»é–±ï¼Œç›¸ç•¶ä»¤äººæ„å¤–åœ°ï¼Œæ¯”å»å¹´<a href="https://speakerdeck.com/pichuang/gong-cheng-shi-de-ni-xi">æ¸›è‚¥ç´€éŒ„æ–‡</a>é‚„å¤šäººçœ‹ï¼Œçœ‹èµ·ä¾†çœŸçš„æ˜¯æ™®éå¤§å®¶çš„ç—›ï¼Œæœ‰æ©Ÿæœƒå¯ä»¥åœ¨ 2022 å¹´åˆ†äº«ä¸€ä¸‹æˆ‘çš„çœ‹æ³•</li>
<li>2021 äººç”Ÿç¬¬ä¸€æ¬¡èªçœŸå»è€ƒ 4 å¼µè­‰ç…§ï¼ŒåŒ…å«ç‚ºäº†ç­è§£è€ƒè©¦é›£åº¦çš„ CKA / CKAD å’Œä¸Šç­ç”¨çš„ VCP-DCV 2021 / VCAP-DCV Design 2021</li>
<li>2021 é«”é‡ 80 KGï¼Œå¢åŠ  8 KGï¼Œä½†è‚Œè‚‰é‡æœ‰ä¸Šå‡ï¼Œå¹´ç´€åˆ°äº†çœŸçš„è¦é å¥èº«ä¿æŒèº«å¿ƒéˆå¥åº·</li>
<li>2021 æ„Ÿæƒ… "æœ‰çµ‚ç„¡å§‹" æ˜¯è »å¥½çš„è¨»è…³ï¼Œåªèƒ½æ®æ‰‹èªªæ‹œæ‹œ</li>
<li>ç•¶äº†å¤§ä¼¯ï¼Œå·²çŸ¥ä½œç”¨ï¼šç™¼ç´…åŒ…</li>
<li>å› ç‚ºå„ç¨®å› ç·£éš›æœƒä¹‹ä¸‹ï¼Œè«åå…¶å¦™å»åƒåŠ åˆ¥äººå®¶ 12/31 çš„å°¾ç‰™</li>
</ol>
<h3 id="2022"><a class="toclink" href="../../2021/12/31/2021-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#2022">2022 å±•æœ›</a></h3>
<ol>
<li>ä¾†å§ï¼è©²æ˜¯æ‹“å±•äº¤å‹åœˆçš„æ™‚å€™äº†ï¼è¦å»å±…é…’å±‹æˆ–é…’å§å–ç„¡é…’ç²¾é£²æ–™çš„è«‹æªæˆ‘ä¸€ä¸‹</li>
<li>æˆ‘æ‡‰è©²è¦å­¸é»è·Ÿ IT æŠ€è¡“ç„¡é—œçš„æŠ€èƒ½æˆ–èˆˆè¶£ï¼Œè­¬å¦‚èªªé‡£é­šã€ç¨®ç”°ã€èª¿é…’ç­‰</li>
<li>2021 æœ‰ä¸€ç¥¨è®Šå‹•ï¼Œæ‰€ä»¥å°è‡´æœ‰äº›é‡åŒ–æ•¸å­—ç›¸è¼ƒå»å¹´å¾ˆé›£çœ‹ï¼Œæ˜å¹´æ–‡ç« å’Œå½±ç‰‡æœƒå¤šéŒ„ä¸€é»</li>
<li>å¸Œæœ›æˆ¿åƒ¹å¯ä»¥æ­£å¸¸ä¸€é»ï¼Œ<a href="https://www.facebook.com/paulintoro/posts/5258007064214303">è‡ªå®…æ‰“å·¥æ—æ‚²æ­Œå¯¦éŒ„</a></li>
</ol>
<h3 id="_1"><a class="toclink" href="../../2021/12/31/2021-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#_1">ç¸½çµ</a></h3>
<p>æœ¬å¹´å¯¦åœ¨æœ‰é»éåº¦æ…˜çƒˆï¼Œæ‰€ä»¥å®¹è¨±æˆ‘æ”¾åœ¨å¿ƒä¸­å¥½äº†</p>
    <nav class="md-post__action">
      <a href="../../2021/12/31/2021-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-29 00:00:00">November 29, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a></h2>
<p>æŸé€±ï¼Œä¸‹ç­å‰è‡¨æ™‚è¢« S å­¸å§ŠæŠ“å»çœ‹äº†ä¸€å€‹ Kubernetes æœå‹™ç‚ºä½•ä¸æœƒæ­£å¸¸ä½œå‹•ï¼Œæ•…èº«ç‚ºå­¸å¼Ÿçš„æˆ‘å‡ºäº†ç¯‡æŠ€è¡“æ–‡å¸Œæœ›è¨˜éŒ„ä¸€ä¸‹ç›¸é—œé™¤éŒ¯æ€è·¯çµ¦å„ä½åƒè€ƒ</p>
<blockquote>
<p>å‹äºº Aï¼šè¦ºå¾—æ¯”æ Kubernetes é‚„é›£çš„äº‹æƒ…ï¼Œå¤§æ¦‚å°±æ˜¯è«‡æˆ€æ„›é€™ä»¶äº‹äº†
å‹äºº Bï¼šKubernetes èµ·ç¢¼è·Ÿä»–å‘Šç™½ (a.k.a. è²æ˜å¼å®£å‘Š, Declarative)ï¼Œå®ƒæœƒæœ€å¤§æ»¿è¶³ä½ æœŸæœ›ç‹€æ…‹ (Desired State)ï¼Œä½†è·Ÿå¦¹å­å‘Šç™½å¯èƒ½æœƒè¢«æŠ“å»è­¦å¯Ÿå±€ï¼Œé †ä¾¿é€ä½ ä¸€å¼µè·Ÿé¨·æ³•
å‹äºº Cï¼šé€™æ¨£æƒ³æƒ³ Kubernetes å¥½åƒé‚„æ¯”è¼ƒå’Œè—¹å¯è¦ª</p>
</blockquote>
<!--more-->

<p><img alt="" src="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.png" /></p>
<p>é¦–å…ˆï¼Œå¾ˆä¹…ä»¥å‰ <a href="https://learnk8s.io/troubleshooting-deployments">Learnk8s A visual guide on troubleshooting Kubernetes deployments</a> æœ‰ç‚ºäº†å»£å¤§å—åˆ° Kubernetes ä½ˆç½²(è¼æ¯’)å¤±æ•—ä¹‹è‹¦çš„æœ‹å‹å‡ºäº†ä¸€ä»½ Troubleshooting Kubernetes deployments æµç¨‹åœ– <a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.pdf">ç°¡ä¸­ç‰ˆ</a> / <a href="https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.en_en.v2.pdf">è‹±æ–‡ç‰ˆ</a>ï¼Œæˆ‘å€‹äººè¦ºå¾—å¾ˆå…·å‚™åƒè€ƒåƒ¹å€¼ï¼Œå…§æ–‡ä¸»è¦ 3 å¤§éšæ®µæ˜¯ï¼š</p>
<ol>
<li>ç¢ºèª Pod é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 50%)</li>
<li>ç¢ºèª Service é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 25%)</li>
<li>ç¢ºèª Ingress é‹ä½œæ­£å¸¸ (ç´„ç•¥ä½”æ¯” 25%)</li>
</ol>
<p>é™¤äº†ç¢ºèª Pod é‹ä½œæ­£å¸¸æ˜¯æ¯”è¼ƒåå‘ App é–‹ç™¼åŠç¨‹å¼ä½ˆç½²è­°é¡Œï¼Œå…¶ä»–å…©å€‹çµ•å¤§éƒ¨åˆ†éƒ½è·Ÿç¶²è·¯è„«ä¸äº†å¤ªå¤§é—œä¿‚ï¼Œæ‰€ä»¥æˆ‘é€™é‚ŠåŸºæ–¼è©²æ–‡å°æ–¼ç¶²è·¯é™¤éŒ¯ï¼ŒåŒ…å« DNSã€IPã€HTTP æ¸¬è©¦æ–¹å¼é€²è¡Œä¸€äº›å€‹äººè£œå……å»ºè­°</p>
<h3 id="pod"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod">é™¤éŒ¯å‰çš„åŸºç¤çŸ¥è­˜: Pod</a></h3>
<p>Podï¼Œæ˜¯å¯¦éš›ä¸Šä½ çš„å®¹å™¨æ˜ åƒæª”é‹è¡Œåœ¨ Kubernetes çš„æœ€å°å–®ä½ï¼Œè£¡é¢å¯ä»¥æ˜¯ 1 å€‹æˆ–å¤šå€‹ Containers åœ¨è£¡é¢ï¼Œè€ŒåŒä¸€å€‹ Pod è£¡é¢æœƒå…±äº«åŒä¸€å€‹ Linux Namespace çš„è³‡æºï¼ŒåŒ…å« PID / NID ç­‰ã€‚æ–¼æœ¬ç¯‡æ–‡ç« å…§æ¯”è¼ƒé‡è¦çš„æ˜¯åŒä¸€å€‹ Pod è£¡é¢çš„ Linux Network Namesapce çš„ç¶²è·¯å…±äº«èƒ½åŠ›ï¼Œæ„æŒ‡æ¯ 1 å€‹ Pod ï¼Œç„¡è«–æœ‰å¤šå°‘å€‹ Containers åœ¨è£¡é¢é‹è¡Œï¼Œéƒ½æœƒå…±äº«æ–¼è©² Kubernetes å¢é›†å…§å”¯ä¸€çš„ IPï¼Œä¹Ÿå°±æ˜¯ <code>Pod IP</code></p>
<h3 id="1-debug-container"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#1-debug-container">ä¸€åˆ‡çš„èµ·é»ï¼Œ1 å€‹ Debug Container</a></h3>
<p>é¦–å…ˆï¼Œä½ éœ€è¦å…ˆæœ‰ä¸€å€‹å·²ç¶“å°è£å¥½<code>å…·å‚™é™¤éŒ¯å·¥å…·</code>çš„å®¹å™¨æ˜ åƒæª”ï¼Œå¾Œé¢ç°¡ç¨± <code>Debug Container</code></p>
<p>é€™å€‹ Debug Container çš„ä¾†æºï¼Œä¸»è¦æ˜¯ 2 å€‹ä¾†æºï¼Œå…¶ä¸€æ˜¯å¯ä»¥æ˜¯æ¡ç”¨ç¤¾ç¾¤å–„å¿ƒäººå£«ç·¨è­¯å¥½çš„å®¹å™¨æ˜ åƒæª”ï¼Œå¦‚ <code>docker.io/nicolaka/netshoot</code>ç­‰ï¼Œæˆ–å…¶äºŒæ˜¯éš¨è‡ªå®¶éœ€æ±‚ï¼Œå¾ <code>Base Image</code> è‡ªè¡Œå®‰è£ã€æ‰“åŒ…å®¹å™¨æ˜ åƒæª”ï¼Œå¦‚ <code>quay.io/pichuang/debug-container</code> ç­‰ï¼Œä¿æŒå®¹å™¨æ˜ åƒæª”å¯æ§ã€å¯è‡ªè¡Œç¶­è­·ç­‰å¥½è™•</p>
<p>æœ¬æ–‡æ¡ç”¨ <code>docker.io/nicolaka/netshoot</code> ä½œç‚ºä¸»è¦ Debug Container çš„åŸºç¤ï¼Œè©³ç´°åŒ…å«ä¹‹å·¥å…·å¯åƒè€ƒ <a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot</a></p>
<p>æŠŠé€™å€‹ Debug Container é‹è¡Œåœ¨ Kubernetes ä¸Šå¾Œï¼Œæœƒä»¥ Kubernetes Pod çš„å½¢å¼é‹ä½œæ–¼ä¸Šï¼Œæ‰€ä»¥ä¹Ÿæœƒæœ‰ 1 å€‹ Pod IP å¯ä»¥æ‹¿ä¾†è·Ÿå…¶ä»– Pod åšäº¤å‰æ¯”å°ä½¿ç”¨ï¼Œæ‰€ä»¥èº«ç‚ºä¸€å€‹ Kubernetes ä½¿ç”¨è€…ï¼Œæœ‰ä¸€å€‹å¥½ä¸Šæ‰‹çš„ Debug Container æ˜¯ä¸€å€‹å¾ˆåˆç†çš„äº‹æƒ…</p>
<h3 id="debug-container-2"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#debug-container-2">é‹è¡Œ Debug Container ä¹‹ 2 ç¨®æ–¹å¼</a></h3>
<p>è‡³æ–¼é‹è¡Œæ–¹å¼æ˜¯ä½¿ç”¨ kubectl é€²è¡Œæ“ä½œï¼Œä»¥<code>æŒ‡å®š namespace ç‚ºè§’åº¦</code>å‡ºç™¼é€²è¡Œæ“ä½œï¼Œä¸»è¦æœ‰ä¸‹åˆ— 2 ç¨®ä½œæ³•ä½†ä¸é™æ–¼ï¼š</p>
<ol>
<li>
<p>æ–¼æŒ‡å®š Namespace åŸ·è¡Œ Debug Container
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">#</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="c1"># Running debug container within the Kubernetes Namespace on Any Nodes</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1">#</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
</code></pre></div></p>
</li>
<li>
<p>æ–¼æŒ‡å®š Namespace å’ŒæŒ‡å®š Node åŸ·è¡Œ Debug Container
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>#
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a># Running debug container within the Kubernetes Namespace on Specific Node (ex: tkg-worker-1)
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>#
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a># List of all Kubernetes nodes
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>$ kubectl get nodes
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>NAME                           STATUS   ROLES                  AGE   VERSION
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>tkgm14-control-plane-pv76m     Ready    control-plane,master   38d   v1.21.2+vmware.1
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>tkgm14-md-0-66f85bf86b-wfjt7   Ready    &lt;none&gt;                 38d   v1.21.2+vmware.1
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>$ kubectl run -n default debug-container --rm -i --tty --overrides=&#39;{ &quot;apiVersion&quot;: &quot;v1&quot;, &quot;spec&quot;: {&quot;kubernetes.io/hostname&quot;:&quot;tkgm14-control-plane-pv76m&quot;}}&#39; --image docker.io/nicolaka/netshoot -- /bin/bash
</code></pre></div></p>
</li>
</ol>
<p>æ­£å¸¸ç‹€æ³ä¸‹ï¼Œä½ æ‡‰è©²ç›´æ¥ä½¿ç”¨æ–¹æ³• 1 å°±å¯ä»¥æ‰¾å‡ºå¾ˆå¤šå•é¡Œäº†ï¼Œé™¤éä½ æ‡·ç–‘ç‰¹å®šç¯€é»æ€ªæ€ªçš„ï¼Œå†ä½¿ç”¨æ–¹æ³• 2</p>
<h3 id="pod-5-5"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod-5-5">å¾ Pod å‡ºç™¼çš„ 5 ç¨®æµé‡èµ°æ³•ï¼Œ5 ç¨®é™¤éŒ¯æ–¹å‘</a></h3>
<p>æ•´é«”ä¸Šï¼ŒKubernetes å…§åˆ°å¤–ç¶²è·¯æµé‡ï¼Œç´„ç•¥å¯ä»¥æ¢åˆ—æˆç‚ºä¸‹åˆ— 5 ç¨®æµé‡èµ°æ³•ä½†ä¸é™ï¼š</p>
<ol>
<li>Container to Container</li>
<li>Pod to Pod in the same nodes</li>
<li>Pod to Pod across different nodes</li>
<li>Pod to Service</li>
<li>Pod to Internet</li>
</ol>
<p>è©³ç´°å¯åƒè€ƒå°å¼Ÿæ–¼é¦™æ¸¯é–‹æºäººå¹´æœƒä¹‹åˆ†äº« <a href="https://speakerdeck.com/pichuang/how-do-i-troubleshooting-on-container-more-than-docker">20200612, How I do troubleshooting on container, more than docker?, HKOSCon 2020</a></p>
<p>å› ç‚ºå¯¦éš›ä¸Šæ‰€æœ‰å¯¦éš›æœå‹™éƒ½æ˜¯è¢«åŒ…è£åœ¨ Pod è£¡é¢é‹è¡Œï¼Œæ•…ç•¶é‡åˆ°æœå‹™ä¸é€šæˆ–ç•°å¸¸çš„æ™‚å€™ï¼Œæƒ³è¦å¿«é€Ÿé€²è¡Œç¶²è·¯æµé‡é™¤éŒ¯ï¼Œå¯ä»¥ä»¥ <code>Pod IP è§’åº¦ä¸”ä»¥ Kubernetes Service å¸¸è¦‹åˆ†é¡ç‚ºä¸»</code>ä¹‹ 4 ç¨®é™¤éŒ¯æ–¹å‘:</p>
<ol>
<li>Pod IP to Pod IP</li>
<li>Pod IP to ClusterIP</li>
<li>Pod IP to NodePort IP</li>
<li>Pod IP to LoadBalancer IP (é›²ç«¯å¸¸è¦‹ï¼Œæˆ–ç‰¹å®š LB è»Ÿé«”æœ‰æä¾›æ•´åˆèƒ½åŠ›ï¼Œå¦‚ AVI Networks)</li>
</ol>
<p>å¦å¤–é‚„æœ‰ 1 å€‹ Kubernetes Service ç·¨åˆ¶å¤–ä½†å¸¸è¦‹çš„ Ingress Controller</p>
<ol>
<li>Pod IP to Ingress Hosts (åœ°ç«¯å¸¸è¦‹ï¼Œå¦‚ Contourã€Nginx)</li>
</ol>
<h4 id="_1"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#_1">æ”¶é›†é™¤éŒ¯å‰ä¹‹å¿…è¦è³‡è¨Š</a></h4>
<p>è¦é–‹å§‹ä½¿ç”¨ Debug Container é€²è¡Œé™¤éŒ¯ä¹‹å‰ï¼Œå‹™å¿…è¦å…ˆæ”¶é›†å¥½ç›¸é—œè³‡è¨Š <code>kubectl get pods,svc,nodes -owide</code>ï¼Œä¸»è¦æ˜¯è¦æœ‰ IP å’Œåå­—ä¹‹å…¶ç›¸é—œè³‡è¨Šï¼Œå¦‚ä»¥ä¸‹æ“ä½œï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods,svc,nodes,ingress<span class="w"> </span>-owide
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>NAME<span class="w">                                    </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">   </span>IP<span class="w">            </span>NODE<span class="w">                           </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>pod/tanzu-deployment-5769f6c4df-2fl28<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.33<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>pod/tanzu-deployment-5769f6c4df-8jj87<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.35<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>pod/tanzu-deployment-5769f6c4df-nlcg8<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>60m<span class="w">   </span><span class="m">100</span>.96.1.34<span class="w">   </span>tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>NAME<span class="w">                     </span>TYPE<span class="w">         </span>CLUSTER-IP<span class="w">      </span>EXTERNAL-IP<span class="w">     </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">          </span>AGE<span class="w">   </span>SELECTOR
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>service/kubernetes<span class="w">       </span>ClusterIP<span class="w">    </span><span class="m">100</span>.64.0.1<span class="w">      </span>&lt;none&gt;<span class="w">          </span><span class="m">443</span>/TCP<span class="w">          </span>38d<span class="w">   </span>&lt;none&gt;
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>service/tanzu-service<span class="w">    </span>NodePort<span class="w">     </span><span class="m">100</span>.70.88.107<span class="w">   </span>&lt;none&gt;<span class="w">          </span><span class="m">3000</span>:30390/TCP<span class="w">   </span>60m<span class="w">   </span><span class="nv">app</span><span class="o">=</span>tkgm-deployment
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>service/tanzu-lb-service<span class="w"> </span>LoadBalancer<span class="w"> </span><span class="m">100</span>.70.88.108<span class="w">   </span><span class="m">172</span>.18.30.100<span class="w">   </span><span class="m">3000</span>:30340/TCP<span class="w">   </span>60m<span class="w">   </span><span class="nv">app</span><span class="o">=</span>tkgm-deployment
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>NAME<span class="w">                                </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">   </span>VERSION<span class="w">            </span>INTERNAL-IP<span class="w">    </span>EXTERNAL-IP<span class="w">    </span>OS-IMAGE<span class="w">             </span>KERNEL-VERSION<span class="w">     </span>CONTAINER-RUNTIME
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>node/tkgm14-control-plane-pv76m<span class="w">     </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>38d<span class="w">   </span>v1.21.2+vmware.1<span class="w">   </span><span class="m">172</span>.18.30.38<span class="w">   </span><span class="m">172</span>.18.30.38<span class="w">   </span>Ubuntu<span class="w"> </span><span class="m">20</span>.04.2<span class="w"> </span>LTS<span class="w">   </span><span class="m">5</span>.4.0-77-generic<span class="w">   </span>containerd://1.4.6
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>node/tkgm14-md-0-66f85bf86b-wfjt7<span class="w">   </span>Ready<span class="w">    </span>&lt;none&gt;<span class="w">                 </span>38d<span class="w">   </span>v1.21.2+vmware.1<span class="w">   </span><span class="m">172</span>.18.30.39<span class="w">   </span><span class="m">172</span>.18.30.39<span class="w">   </span>Ubuntu<span class="w"> </span><span class="m">20</span>.04.2<span class="w"> </span>LTS<span class="w">   </span><span class="m">5</span>.4.0-77-generic<span class="w">   </span>containerd://1.4.6
</code></pre></div>
<h4 id="1-pod-ip-to-pod-ip-traffic"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#1-pod-ip-to-pod-ip-traffic">1. Pod IP to Pod IP Traffic</a></h4>
<p>ä¸­ç­‰é›£åº¦çš„æ¸¬è©¦ï¼ŒåŒ…å« Ping / Curl éƒ½è¦èƒ½ç²å¾—é æœŸçš„åæ‡‰ï¼Œå¦‚æœæœ‰å•é¡Œçš„è©±ï¼Œå¯ä»¥åƒé–± <a href="https://learnk8s.io/troubleshooting-deployments">Learnk8s A visual guide on troubleshooting Kubernetes deployments</a> é€²è¡Œ Pod å…§éƒ¨é‹è¡Œçš„å•é¡Œé™¤éŒ¯ï¼Œé€™æ™‚å€™ä¸‹ <code>kubectl logs &lt;pod name&gt;</code> å’Œ <code>kubectl describe pod &lt;pod name&gt;</code> æ‡‰è©²éƒ½æœƒæœ‰äº›è››çµ²é¦¬è·¡</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.36
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="c1">#</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.35
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.34
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.96.1.33
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>PING<span class="w"> </span><span class="m">100</span>.96.1.33<span class="w"> </span><span class="o">(</span><span class="m">100</span>.96.1.33<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">100</span>.96.1.33:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.875<span class="w"> </span>ms
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="c1"># Curl web page</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.33:3000
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.34:3000
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.96.1.35:3000
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="2-pod-ip-to-clusterip-traffic"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#2-pod-ip-to-clusterip-traffic">2. Pod IP to ClusterIP Traffic</a></h4>
<p>æœ€æ ¸å¿ƒçš„æ¸¬è©¦ï¼Œé¦–å…ˆä½ éœ€è¦å…ˆå° Kubernetes Services é‹ä½œè¦æœ‰ä¸€å®šç¨‹åº¦ç†è§£ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ <a href="https://www.hwchiu.com/kubernetes-service-i.html">Hwchiu - Kubernetes What Is Service?</a> ä¸€æ–‡ï¼Œåœ¨é€™å€‹éšæ®µä¸»è¦æ¸¬è©¦ç›®æ¨™æ˜¯ï¼Œç¢ºèªå¯ä»¥é€é Kubernetes Cluster IP ç²å¾— Pod çš„å…§å®¹</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.37
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="c1">#</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="c1"># DNS Lookup</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="c1"># https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="c1">#</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="c1"># nslookup &lt;service name&gt;.&lt;namespace name&gt;</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="c1"># nslookup &lt;service name&gt;.&lt;namespace name&gt;.svc.cluster.local</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>bash-5.1#<span class="w"> </span>nslookup<span class="w"> </span>tanzu-service.default
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>bash-5.1#<span class="w"> </span>nslookup<span class="w"> </span>tanzu-service.default.svc.cluster.local
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>Server:<span class="w">     </span><span class="m">100</span>.64.0.10
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>Address:<span class="w">    </span><span class="m">100</span>.64.0.10#53
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>Name:<span class="w">   </span>tanzu-service.default.svc.cluster.local
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>Address:<span class="w"> </span><span class="m">100</span>.70.88.107
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="c1">#</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="c1"># Ping (FAILED)</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="c1"># Ping doesn&#39;t work with service&#39;s cluster IPs like 100.70.88.107, as it is a virtual IP</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="c1"># You should be able to ping a specific pod, but no a service.</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">100</span>.70.88.107
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>PING<span class="w"> </span><span class="m">100</span>.70.88.107<span class="w"> </span><span class="o">(</span><span class="m">100</span>.70.88.107<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>--<span class="w"> </span>Pending<span class="w"> </span>--
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="c1">#</span>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="c1"># Curl</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="c1">#</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="c1"># curl &lt;service name&gt;.&lt;namespace name&gt;:&lt;svc port&gt;</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="c1"># curl &lt;service name&gt;.&lt;namespace name&gt;.svc.cluster.local:&lt;svc port&gt;</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="c1"># curl &lt;cluster ip&gt;:&lt;svc port&gt;&gt;</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="c1"># Curl web page (OK)</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>tanzu-service.default:3000
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>tanzu-service.default.svc.cluster.local:3000
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">100</span>.70.88.107:3000
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>Hello<span class="w"> </span>World!
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="c1"># Curl Kubernetes API Service (OK)</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://kubernetes.default:443
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="m">403</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://kubernetes.default.svc.cluster.local:443
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="m">403</span>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>-o<span class="w"> </span>/dev/null<span class="w"> </span>-s<span class="w"> </span>-w<span class="w"> </span><span class="s2">&quot;%{http_code}\n&quot;</span><span class="w"> </span>--insecure<span class="w"> </span>https://100.64.0.1:443
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="m">403</span>
</code></pre></div>
<h4 id="3-pod-ip-to-nodeport-ip"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#3-pod-ip-to-nodeport-ip">3. Pod IP to NodePort IP</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Node IP ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c1">#</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1"># Pod IP -&gt; Node IP</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="c1">#</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.18.30.39
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>PING<span class="w"> </span><span class="m">172</span>.18.30.39<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.30.39<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.18.30.39:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.463<span class="w"> </span>ms
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="c1">#</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="c1"># Curl</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="c1"># curl &lt;node ip&gt;:&lt;node port&gt;</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.30.39:30390
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="4-pod-ip-to-loadbalancer-ip"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#4-pod-ip-to-loadbalancer-ip">4. Pod IP to LoadBalancer IP</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Loadbalacner IP ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="c1">#</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1"># Ping</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="c1"># Pod IP -&gt; LoadBalancer IP</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="c1">#</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.18.30.100
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>PING<span class="w"> </span><span class="m">172</span>.18.30.100<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.30.100<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.18.30.100:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.3<span class="w"> </span>ms
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="c1">#</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="c1"># Curl</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="c1"># curl &lt;LoadBalancer ip&gt;:&lt;LB port&gt;</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span><span class="m">172</span>.18.30.100:30340
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>Hello<span class="w"> </span>World!
</code></pre></div>
<h4 id="5-pod-ip-to-ingress-hosts"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#5-pod-ip-to-ingress-hosts">5. Pod IP to Ingress Hosts</a></h4>
<p>åŸ·è¡Œä¸€æ¬¡ <code>2. Pod IP to Cluster IP</code> æ¸¬è©¦ä»¥å¤–ï¼Œé‚„éœ€è¦å¦å¤–ç¢ºèªå°å¤–æœå‹™æ­éœ²çš„éƒ¨ä»½ï¼Œä¸»è¦ä»¥ Ingress Hosts ç‚ºåŸºç¤</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">#</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>ingress
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>NAME<span class="w">                        </span>HOSTS<span class="w">                                                   </span>ADDRESS<span class="w">       </span>PORTS<span class="w">   </span>AGE
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>name-virtual-host-ingress<span class="w">   </span>tutum.training.boxboat.io,jwilder.training.boxboat.io<span class="w">   </span><span class="m">172</span>.17.0.58<span class="w">   </span><span class="m">80</span><span class="w">      </span>9m24s
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>path-ingress<span class="w">                </span>training.boxboat.io<span class="w">                                     </span><span class="m">172</span>.17.0.58<span class="w">   </span><span class="m">80</span><span class="w">      </span>9m2s
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="c1"># Run debug container</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--image<span class="w"> </span>docker.io/nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="c1"># List of Routing Table</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>r
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">100</span>.96.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="m">100</span>.96.1.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">100</span>.96.1.40
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="c1">#</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="c1"># Ping</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="c1"># Test Connectivity</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="c1">#</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>bash-5.1#<span class="w"> </span>ping<span class="w"> </span><span class="m">172</span>.17.0.58
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>PING<span class="w"> </span><span class="m">172</span>.17.0.58<span class="w"> </span><span class="o">(</span><span class="m">172</span>.17.0.58<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">172</span>.17.0.58:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">63</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.706<span class="w"> </span>ms
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="c1"># Curl</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="c1"># curl &lt;HOSTS&gt;:&lt;PORTS&gt;</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>bash-5.1#<span class="w"> </span>curl<span class="w"> </span>training.boxboat.io:80
</code></pre></div>
<h3 id="pod-to-ingress-vs-pod-to-loadbalancer"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#pod-to-ingress-vs-pod-to-loadbalancer">Pod to Ingress v.s. Pod to LoadBalancer</a></h3>
<p>å¦‚æœä½ æœ‰ä»”ç´°çœ‹ï¼Œæœƒç™¼ç¾ Kubernetes LoadBalacner è·Ÿ Kubernetes Ingress é™¤éŒ¯èµ·ä¾†å¥—è·¯å¾ˆåƒï¼Œç†ç”±æ˜¯ä»–å€‘éƒ½æ˜¯å¯¦éš›ä¸Šæ¥æ”¶åˆ° User Traffic æœ€å‰ç·šçš„æœå‹™ï¼Œè‡³æ–¼æƒ³è¦äº†è§£å…©è€…ç¶²è·¯æµé‡å·®ç•°å¯åƒè€ƒ <a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0">Kubernetes NodePort vs LoadBalancer vs Ingress? When should I use what?</a>ï¼ŒåŠ <a href="https://www.hwchiu.com/ingress-1.html">Hwchiu - Introduction to Kubernetes Ingress (Nginx)</a></p>
<blockquote>
<p>Kubernetes LoadBalacner æ˜¯ Kubernetes Service å…¶ä¸­ä¸€ç¨®é¡å‹ï¼Œå¤–é¢å¿…ç„¶æœƒæœ‰ä¸€å€‹ç¨ç«‹æ–¼ Kubernetes å®¹å™¨å¹³å°å¤–éƒ¨çš„ External LB å­˜åœ¨
Kubernetes Ingress ä¸¦ä¸æ˜¯ Kubernetes Serviceï¼Œå®ƒå—åˆ°ç‰¹å®š Ingress Controller ç®¡ç†ï¼Œå»ºç«‹æ–¼ Kubernetes å®¹å™¨å¹³å°å…§éƒ¨</p>
</blockquote>
<p>å¦‚æœä½ æ²’æœ‰ä»€éº¼ç‰¹å®š LB å¯ä»¥æä¾› Kubernetes Service å‘¼å«ä½¿ç”¨çš„è©±ï¼Œé‚£åŸºæœ¬ä¸Šä½ å¤§å¤šæ•¸éƒ½æ˜¯ç”¨ Kubernetes Ingress ä½œç‚ºä¸»è¦ä½¿ç”¨ï¼Œä½†å…©è€…ä¹Ÿå¯ä»¥ä¸¦ç”¨å°±æ˜¯äº†ï¼Œç›¡å¯èƒ½ä¸åœ¨åŒä¸€å€‹ç¯€é»ä¸Šå³å¯ï¼Œå› ç‚º hostNetwork æœ‰è »é«˜æ©Ÿæœƒæœƒè¡ Portï¼Œå¦‚ 80/443 ç­‰</p>
<h3 id="_2"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#_2">å¸¸è¦‹å•é¡Œ</a></h3>
<h4 id="q1-deploymentyml-kubernetes-api"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#q1-deploymentyml-kubernetes-api">Q1: deployment.yml è£¡çš„ Kubernetes API æ”¹ç‰ˆäº†ï¼Œè©²æ€éº¼ç„¡ç¸«åœ°ä¿®æ­£</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment.yml
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>error:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>recognize<span class="w"> </span><span class="s2">&quot;deployment.yml&quot;</span>:<span class="w"> </span>no<span class="w"> </span>matches<span class="w"> </span><span class="k">for</span><span class="w"> </span>kind<span class="w"> </span><span class="s2">&quot;Deployment&quot;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>version<span class="w"> </span><span class="s2">&quot;extensions/v1beta1&quot;</span>
</code></pre></div>
<p>A1: 1. æ‰¾åˆ°æ­£ç¢ºçš„ API åå­—
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>api-resources<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>deployments
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>deployments<span class="w">                       </span>deploy<span class="w">       </span>apps/v1<span class="w">                                              </span><span class="nb">true</span><span class="w">         </span>Deployment
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>machinedeployments<span class="w">                </span>md<span class="w">           </span>cluster.x-k8s.io/v1alpha3<span class="w">                            </span><span class="nb">true</span><span class="w">         </span>MachineDeployment
</code></pre></div>
2. ä¿®æ­£ deployment.yaml å…§çš„æª”æ¡ˆï¼Œå¾ <code>apiVersion: extensions/v1beta1</code> åˆ° <code>apiVersion: apps/v1</code>ï¼Œé‡æ–°åŸ·è¡Œ
3. æ²’æ„å¤–æ‡‰è©²é‚„æœƒæœ‰éŒ¯èª¤ï¼Œå†æ ¹æ“šéŒ¯èª¤è¨Šæ¯ï¼Œé€²è¡Œæ¬„ä½çš„å¢åˆªä¿®</p>
<h4 id="q2-kubernetes-platform-administrator"><a class="toclink" href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/#q2-kubernetes-platform-administrator">Q2: å¦‚æœä½ æ˜¯ Kubernetes Platform Administrator æƒ³è¦å°ç‰¹å®šç¯€é»ä¹‹ä½œæ¥­ç³»çµ±é™¤éŒ¯é‚£è©²æ€éº¼è¾¦?</a></h4>
<p>A2: ä½ˆç½²çš„æ™‚å€™ï¼Œå¤šä¸€å€‹ <code>"hostNetwork": true</code> åƒæ•¸å³å¯</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>debug-container<span class="w"> </span>--rm<span class="w"> </span>-i<span class="w"> </span>--tty<span class="w"> </span>--overrides<span class="o">=</span><span class="s1">&#39;{ &quot;apiVersion&quot;: &quot;v1&quot;, &quot;spec&quot;: {&quot;kubernetes.io/hostname&quot;:&quot;tkgm14-md-0-66f85bf86b-wfjt7&quot;, &quot;hostNetwork&quot;: true}}&#39;</span><span class="w"> </span>--image<span class="w"> </span>nicolaka/netshoot<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>bash-5.1#<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>eth0
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="m">2</span>:<span class="w"> </span>eth0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>mq<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span>link/ether<span class="w"> </span><span class="m">00</span>:50:56:9e:85:bb<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">172</span>.18.30.39/24<span class="w"> </span>brd<span class="w"> </span><span class="m">172</span>.18.30.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>dynamic<span class="w"> </span>eth0
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">       </span>valid_lft<span class="w"> </span>1059832sec<span class="w"> </span>preferred_lft<span class="w"> </span>1059832sec
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::250:56ff:fe9e:85bb/64<span class="w"> </span>scope<span class="w"> </span>link
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</code></pre></div>
    <nav class="md-post__action">
      <a href="../../2021/11/29/%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E4%BD%88%E7%BD%B2%E7%9A%84-kubernetes-%E6%9C%8D%E5%8B%99%E4%B8%8D%E6%9C%83%E5%8B%95-%E5%80%8B%E4%BA%BA%E9%99%A4%E9%8C%AF%E6%80%9D%E8%B7%AF%E5%88%86%E4%BA%AB/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__current">2</span> <a class="md-pagination__link" href="../3/">3</a> <a class="md-pagination__link" href="../4/">4</a> <a class="md-pagination__link" href="../5/">5</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>