
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/page/5/">
      
      
      
        <link rel="next" href="../../author/url/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>Index - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel 🎥 </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Index
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="index">Index</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-16 00:00:00">November 16, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/homecloud/" class="md-meta__link">homecloud</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2019-3"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">2019 大改造宅宅雲架構系列文-3 宅宅雲網路架構設計</a></h2>
<p>2019 大改造宅宅雲系列文來到第 3 篇，有興趣想看前面兩篇的可以參考：
1. <a href="https://blog.pichuang.com.tw/20191114-homelcloud-high-level-design-1/">2019 大改造宅宅雲架構系列文-1</a>：介紹大多數用錢包君威力扛回家的硬體設備和架構設計總體目標
2. <a href="https://blog.pichuang.com.tw/20191115-homelcloud-high-level-design-2/">2019 大改造宅宅雲架構系列文-2</a>：介紹宅宅雲塔式伺服器硬體裝備</p>
<p>而第三篇要來承續第二篇，講一下關於下圖藍色區塊 vcenter.phil.lab 那塊虛擬網路我個人是怎麼設計的</p>
<p><img alt="" src="/images/homecloud-1.png" /></p>
<!--more-->

<h3 id="1-2"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-2">1 台 2 埠雙臂網路架構</a></h3>
<p>雙臂網路 (Two-Arm) 需使用 2 個網路介面，Inbound/Outbound 分別走不同介面；單臂網路則是 (One-Arm) 僅使用 1 個網路介面，Inbound/Outbound 都走同一個介面，裡面的網路隔離是採用 802.1Q VLAN Subinterface 進行劃分，所以後者相較前者，Overlay Switch (這邊指的就是 Synology RT2600ac ) 需要多支援 VLAN 能力才有辦法做，但可惜它沒有，就保持做 Two-Arm 網路。而我自己經驗基本都是做 Two-Arm，單純好理解</p>
<h4 id="port"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#port">最小 Port 數?</a></h4>
<p>關於服務器硬體規格可以看 <a href="https://blog.pichuang.com.tw/20191115-homelcloud-high-level-design-2/">2019 大改造宅宅雲架構系列文-2: 硬體菜單</a>，主要核心硬體需求是</p>
<blockquote>
<p>1 ~ 2 Port</p>
</blockquote>
<p>對...只要兩個 Port 就什麼都可以做，無論速率、無論架構皆可，但最小 1 Port 也可以做，只是雙臂架構概念會有點不太一樣，看角度，下面會詳細畫圖講一下。</p>
<p>基本相同概念適用於實體機直上、VMware vSphere、Linux KVM、Red Hat Virtualization、Proxmox、Red Hat OpenStack 等等虛擬化平台都可以做。</p>
<p>Q: Hyper-V 呢?</p>
<p>Sorry，這個我沒研究，無法評論</p>
<h4 id="vfw-vrouter"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#vfw-vrouter">vFW? vRouter?</a></h4>
<p>主要網路轉發核心功能需求是</p>
<blockquote>
<p>NAT + VLAN Subinterface</p>
</blockquote>
<p>這邊採用的 vFirewall 是 <a href="https://www.pfsense.org/">pfSense</a>，先前在 Edgecore Networks 機櫃環境是用 <a href="https://opnsense.org/">OPNsense</a>，而我個人是比較偏好 OPNsense。</p>
<p><img alt="" src="/images/pfsense.png" /></p>
<p>Q: 說好的 vRouter 不能搞嗎?</p>
<p>先前也有嘗試用 [VyOS][https://vyos.io/] 當做虛擬路由器，但三年前測試的時候，它沒有支援 NAT 啊啊啊啊啊！就放棄回到 pfSense / OPNsesne 的懷抱中，不知道現在有沒有支援，徵求勇者試試</p>
<p>Q: 疑? 這樣 iptables 土炮好像也很 ok 啊?</p>
<p>無論是 Linux iptables / FreeBSD pf 系列的都可以做，技術上沒什麼問題，只是我懶得每次都在想 iptables 的 <code>masquerade</code> 跟 <code>Port Forwarding</code> 怎麼下</p>
<h4 id="ip-design"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#ip-design">IP Design?</a></h4>
<p>想當爾，要提供 WAN IP 給對應的網路介面，這邊假設以下：</p>
<ol>
<li>WAN IP: 192.168.99.250/24</li>
<li>VLAN 100 Subnet: 10.100.0.0/24</li>
<li>VLAN 200 Subnet: 10.200.0.0/24</li>
<li>Rescue IP: 192.168.1.1/24</li>
</ol>
<p>目標上就是拿到 10.100.0.0/24 或 10.200.0.0/24 的 IP 都要能透過 WAN IP 走 SNAT 方式出去；反之，可以從 WAN IP 透過 DNAT 做 Port Forwarding 進 10.100.0.0/24 或 10.200.0.0/24  網段</p>
<p>Q: Rescure IP?? 這幹嘛的</p>
<p>關於 Rescue IP 的作用是救援用，假設我的 VLAN IP 或者是有什麼異常狀況不能透過正常設定好的網路進去修改，我會拔掉原先接在 LAN Port (eth1) 上的線，用自己筆電直連該 Port 進去修</p>
<h4 id="1-vfw"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-vfw">1 . vFW 雙臂直上實體機架構圖</a></h4>
<blockquote>
<p>一台 Server 直接裝 pfSense</p>
</blockquote>
<p><img alt="" src="/images/pfsense-1.png" /></p>
<p>這個架構缺點顯而易見，整台實體機資源都被 pfSense 咬走了，完全沒有用到任何虛擬化平台，但可以外接支援 VLAN Tagging/Untag 的交換器擴大可使用實體 Port 數</p>
<p><img alt="" src="/images/pfsense-3.png" /></p>
<p>Q: 我家沒有具備 VLAN 功能的 Switch...</p>
<p>如果家中有一台小小的電腦，剛好也有兩個 Port，就很適合做上圖， 而 eth1 不一定要用 VLAN Subinterface 處理，可以直接掛 IP 在上面使用，外面接 L2 Switch 起來用，擴大可使用實體 Port 數</p>
<h4 id="2-vfw-1-port"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#2-vfw-1-port">2. vFW 雙臂 + 虛擬化平台 + 1 實體 Port 架構圖</a></h4>
<blockquote>
<p>一台 Server 裝虛擬化平台，起 VM 裝 pfSense，網段用 VLAN Subinterface 切割，不考慮外接其他設備</p>
</blockquote>
<p>下圖是以 VMware vSphere 作為範例</p>
<p><img alt="" src="/images/pfsense-2.png" /></p>
<p>關於 Virtual Switch 的部分，無論是 vSS (virtual Standard Switch) /vDS (virtual Distributed Swtich) 皆可使用，詳細相關技術評估請洽友商 VMware。</p>
<p>Q:  <code>vDS: WAN</code> 端的設定示意圖?</p>
<p><img alt="" src="/images/vds-1.png" /></p>
<p>右邊那邊 Port Group 可以多加網卡做點事情，詳細功能請參考官方文件 <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.networking.doc/GUID-B15C6A13-797E-4BCB-B9D9-5CBC5A60C3A6.html">vSphere Distributed Switch Architecture</a>，左邊留意 <code>VLAN 識別碼</code> 為 <code>--</code>，但我不確定是不是代表是 <code>VLAN 1</code> 的意思，哪天遇到問題再研究</p>
<p>Q: <code>vDS: Trunk</code> 端的也來一下</p>
<p><img alt="" src="/images/vds-2.png" /></p>
<p>右邊留意 Port Group 是完全沒有實體網卡在裡面的，左邊則是針對 VLAN ID 設定個別的 <code>VM Network</code> (注：我忘記正確描述是什麼了，有錯請敲我更正)</p>
<p>Q: 多問一句...有魔鬼嗎?</p>
<p><img alt="" src="/images/vds-3.png" /></p>
<p>Of course！這個設定應該是有做過類似事情的朋友都會遇到的最大遺漏，那個被設定為 Trunk 的 VM Network... 要把混合模式 (Promiscuous Mode)開啟來，避免來自於各式各樣的網路的封包在 ESXi 層就被丟掉，具體技術文件請參照 <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.security.doc/GUID-92F3AB1F-B4C5-4F25-A010-8820D7250350.html">Promiscuous Mode Operation</a></p>
<p>下圖是採用 libvirt 為主的技術架構</p>
<p><img alt="" src="/images/pfsense-4.png" /></p>
<p>Q: 疑? 怎麼看起來都差不多?</p>
<p>其實簡單來說就是透過 Bridge 技術搭橋把實體網卡和虛擬網卡塞在同一個 Linux Bridge ( or OVS Bridge) 裡面，就很像是多台虛擬 L2 交換機在虛擬化平台裡面，概念就是這麼簡單，因為 VMware vSS/vDS 設定方式比較特別，所以特別拉出來講</p>
<h4 id="3-vfw-2-port"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#3-vfw-2-port">3. vFW 雙臂 + 虛擬化平台 + 2 實體 Port 架構圖</a></h4>
<blockquote>
<p>一台 Server 裝虛擬化平台，起 VM 裝 pfSense，網段用 VLAN Subinterface 切割，須考慮外接其他設備</p>
</blockquote>
<p><img alt="" src="/images/pfsense-5.png" /></p>
<p>這個就是先前在 Edgecore Networks Lab 最完整的架構，詳細投影片請參照 2017 年有一天不知道在哪裡講的 <a href="https://speakerdeck.com/pichuang/build-testing-infrastructure?slide=17">Build Testing Infrastructure</a> 投影片</p>
<p>Q:  為什麼要特別做雙臂?</p>
<p><img alt="" src="/images/rack.png" /></p>
<p>因為完全是為了管理這整櫃機櫃裡面設備使用的，那時候有另外接兩台 Cumulus Linux + AS4610-54T 做 CLAG，讓底下設備只要可以咬 IP 的全部配發一個 IP，網段全部切開做 VLAN Routing 避免被廣播封包打爆</p>
<p>Q: VLAN Routing !!! 是不是漏講了什麼? 那個 pfSense 裡面怎麼做的?</p>
<p>第四篇，我覺得也蠻有趣的部份，傳送門 <a href="https://blog.pichuang.com.tw/20191116-homelcloud-high-level-design-4/">2019 大改造宅宅雲架構系列文-4</a></p>
<h3 id="traffic"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#traffic">Traffic 分解圖</a></h3>
<h4 id="snat-traffic"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#snat-traffic">SNAT Traffic</a></h4>
<p><img alt="" src="/images/pfsense-6.png" /></p>
<p>這個很直覺，VLAN Routing + SNAT 搞定</p>
<h4 id="dnat-traffic"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#dnat-traffic">DNAT Traffic</a></h4>
<p><img alt="" src="/images/pfsense-7.png" /></p>
<p>這個也很直覺，DNAT 做 Port Forwarding，這邊提供一個小祕技，搭 <code>SSH ProxyCommand</code>蠻好用的，參照 <a href="https://speakerdeck.com/pichuang/20190720-better-practice-day-2-operaition-with-ansible?slide=12">20190720 Better Practice  Day 2 Operaition with Ansible</a></p>
<h3 id="_1"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#_1">總結</a></h3>
<p>其實這年頭看到虛擬網路技術不用感到特別害怕，畫點圖，上個 IP，想像一下網路怎麼流，其實很多問題就能解決了，平時可以多多做點 Lab 培養觀落陰能力</p>
    <nav class="md-post__action">
      <a href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-3-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%B6%B2%E8%B7%AF%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-16 00:00:00">November 16, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/homecloud/" class="md-meta__link">homecloud</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2019-4-pfsense"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/">2019 大改造宅宅雲架構系列文-4 pfSense</a></h2>
<p>先前工作太忙、失戀打擊過大，以致懷疑人生，導致有陣子沒寫文章，最近 Red Hat 贊助小弟來魚尾獅王國上課，趁空擋把長久以來用的一些技術經驗寫下來分享給大家，<a href="https://blog.pichuang.com.tw/categories/infra/">2019 大改造宅宅雲架構系列文 快速傳送門</a>，歡迎大家把自己 HomeLab/HomeCloud 的經驗分享出來蕉流蕉流</p>
<p><img alt="" src="/images/pfsense-logo.png" /></p>
<p>如 Logo 所示，本篇將會承襲上篇 <a href="https://blog.pichuang.com.tw/20191116-homelcloud-high-level-design-3/">2019 大改造宅宅雲架構系列文-3</a> 的結尾，到底 pfSense 放到 VM 裡面後是如何搞得?</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#_1">服務太多? 切網卡! 切網段!</a></h3>
<p><img alt="" src="/images/pfsense-8.png" /></p>
<p>上篇有人如果眼睛很尖的話，應該會發現我紅框那邊有好幾個網路介面，個別 VLAN 都會定義一個服務群，把相同性質的服務全部塞在一起，避免互相干擾</p>
<p>Q: 是不是一定要在 VM 外插多隻腳出來才能做?</p>
<p>這個如同 <a href="https://blog.pichuang.com.tw/20191116-homelcloud-high-level-design-3/">2019 大改造宅宅雲架構系列文-3</a> 的網路架構一樣，實際上我只有插兩張網卡在裡面，其他多張虛擬網卡都用 802.1q VLAN Subinterface 切出來</p>
<p><img alt="" src="/images/pfsense-9.png" /></p>
<p>上圖可以在 <code>Interfaces &gt; Interface Assignments &gt; VLANs</code> 裡面找到，所有透過 802.1q VLAN Subinterface 都會顯示在這邊</p>
<p><img alt="" src="/images/pfsense-10.png" /></p>
<p>以下我新增一個 <code>VLAN 104</code> 當作範例，記得要選正確的 Interface，這邊有兩張介面</p>
<ol>
<li>vmx0: WAN</li>
<li>vmx1: LAN &lt;-- 選他</li>
</ol>
<p>因為在 pfSense 安裝時會需要定義 WAN / LAN，所以這個理論上要知道，記得不要選錯，不然切出來的網路介面不會動，有一次眼殘選錯，看了足足一天才發現</p>
<p>Q: 這樣就搞定了嗎!?</p>
<p><img alt="" src="/images/pfsense-11.png" /></p>
<p>還要回到 <code>Interfaces &gt; Interface Assignments</code> 正式把這張虛擬網路介面卡加進去才算數</p>
<p><img alt="" src="/images/pfsense-12.png" /></p>
<p>把虛擬網路介面的設定填一填就搞定了第一階段，所以架構圖上就會像下圖一樣</p>
<p><img alt="" src="/images/pfsense-2.png" /></p>
<h3 id="nat"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#nat">還有 NAT 呢...</a></h3>
<p>在 pfSense 裡面關於 NAT 的部分，其實有<a href="https://docs.netgate.com/pfsense/en/latest/nat/index.html">不少功能介紹</a>，這邊體恤小弟是個懶人，主要會用到</p>
<ol>
<li>SNAT 懶人功能: <a href="https://docs.netgate.com/pfsense/en/latest/nat/automatic-nat-rules-generation.html">Automatic NAT Rules Generation</a></li>
<li>SNAT 正常功能: <a href="https://docs.netgate.com/pfsense/en/latest/nat/advanced-outbound-nat.html">Advanced Outbound NAT</a></li>
<li>DNAT 正常功能: <a href="https://docs.netgate.com/pfsense/en/latest/nat/forwarding-ports-with-pfsense.html">Forwarding Ports with pfSense</a></li>
</ol>
<p><img alt="" src="/images/pfsense-14.png" /></p>
<p>相關設定都在 <code>Firewall &gt; NAT &gt; Outbound</code> 裡面找得到，關於 <code>Outbound NAT Mode</code> 毫無懸念地開 <code>Hybrid Outbound NAT rule generation</code>，主要是因為 <code>Automatic NAT Rules Generation</code> 真的是一個<code>好棒棒</code>的功能 (我被我老闆影響了...) ，當你把上一個章節的虛擬網路加進去後，他會自動加一條 SNAT Rules 進去，啥都不用設定</p>
<p>關於 DNAT  Port Forward 的使用就是直接開 <code>Firewall &gt; NAT &gt; Port Forward</code> 裡面上 Rule 就完工了，詳細設定介紹 <a href="https://docs.netgate.com/pfsense/en/latest/nat/forwarding-ports-with-pfsense.html">Forwarding Ports with pfSense</a></p>
<h3 id="firewall"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#firewall">我知道你忘記了 Firewall 這件事</a></h3>
<p>Q: 為什麼照文章設定完之後，還是不會動!!!???</p>
<p><img alt="" src="/images/pfsense-15.png" /></p>
<p>魔鬼就在這張圖裡面，可以在 <code>Firewall &gt; Rules &gt; &lt;指定的網路介面&gt;</code>找到她，關於這個問題搞了半天是防火牆預設 Firewall Deny All...意思上圖的 Rules 是表示全部不給過</p>
<blockquote>
<p>All incoming connections on this interface will be BLOCKED until PASS RULES are ADDED</p>
</blockquote>
<p><img alt="" src="/images/pfsense-16.png" /></p>
<p>所以你需要多一條 Rule</p>
<ul>
<li>Family: IPv4</li>
<li>Protocol: any</li>
<li>Source: any</li>
<li>S Port: any</li>
<li>Destination: any</li>
<li>D Port: any</li>
</ul>
<p>基本上就會通了，其他 Rules 就是按照自己需求自己加就好</p>
<h3 id="dhcp"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#dhcp">DHCP 相關</a></h3>
<p>因為我個人 Lab 都不用 DHCP 都是手動配 IP，但最近 Red Hat OpenShift 4 安裝忽然要弄 DHCP，剛好 pfSense 也有支援 <a href="https://docs.netgate.com/pfsense/en/latest/dhcp/dhcp-server.html"><code>DHCP Static Mappings for this Interface</code></a>，所以做起來非常方便使用</p>
<h3 id="_2"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#_2">還有更多嗎?</a></h3>
<p>除了以上基本的功能，如果是以 pfSense 為核心的架構，你也可以把以下服務放在上面都沒什麼問題</p>
<ul>
<li>Time Synchronization: ntp</li>
<li>DNS: bind</li>
<li>VPN: OpenVPN</li>
</ul>
<h3 id="_3"><a class="toclink" href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/#_3">總結</a></h3>
<p>雖然用 pfSense 自架自己用沒什麼太大問題，但如果是給小公司 (~10) 使用或者是 SMB，訂閱他們提供<a href="https://store.netgate.com/Global-Support-C320.aspx">軟體支援</a> 或產品會是一個比較完善的保護，倘若如果是大型企業的話，還是建議乖乖看商用方案比較好</p>
<p>最後我想說，企業支持開源軟體的具體實踐，用原始碼或錢實際支持這些宅宅，幫助這些軟體永續經營，宅宅們也是需要吃飯喝水養家的</p>
    <nav class="md-post__action">
      <a href="../../2019/11/16/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-4-pfsense/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-15 00:00:00">November 15, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/homecloud/" class="md-meta__link">homecloud</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2019-2"><a class="toclink" href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/">2019 大改造宅宅雲架構系列文-2 宅宅雲硬體介紹</a></h2>
<p>承上篇 <a href="https://blog.pichuang.com.tw/20191114-homelcloud-high-level-design-1/">2019 大改造宅宅雲架構系列文-1 - Phil Workspace</a> 所提到一些關於核心裝備的列舉和使用理由，本篇會比較著重在宅宅雲塔式 Server 的介紹</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/#_1">宅宅雲: 自組塔式伺服器</a></h3>
<p>這台是我在 2018 年尾的時候採購的一台塔式伺服器，當初會買這台的理由非常簡單，<code>為了深刻理解 Red Hat OpenShift 3.11 on VMware vSphere 跑起來的樣子會長什麼樣子</code>，我自稱這個叫做 <code>客戶驅動部署 Customer Driven Deployment</code> (???)</p>
<p>但因為這台會放在我住宿的地方，所以我一開始的設計要求如下：</p>
<ol>
<li>安靜第一第二第三</li>
<li>效能第四</li>
<li>省電第五</li>
</ol>
<p>所以整體上的選擇就是<code>靜音</code>為優先的設計，實際上開機後也真的是蠻安靜的，比 Synolgy DS916+ 裡面硬碟運轉的聲音還小...</p>
<h4 id="_2"><a class="toclink" href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/#_2">硬體菜單</a></h4>
<p><img alt="" src="/images/tower-details.png" /></p>
<p>以前在 Mobile01 不知哪裡看到一篇開箱文，跟我需求蠻像的，所以拿來修改成如下：</p>
<ul>
<li>CPU: Intel Xeon E5-2620 v4 (8C/16T) / 2011 / 2.1G / 無內顯 * 1</li>
<li>MB: ASUS Z10PE-D16 WS (E-ATX / C612 / 雙 2011-V3.V4 / 16*DDR4 / M.2 / 2 * NIC) * 1</li>
<li>Memory: Samsung 16GB DDR 2133MHz ECC Reg * 16</li>
<li>OS Disk: HIKVISION E100NI 256G / M.2 SATA / R:500M / W 250M / TLC * 1</li>
<li>機箱: Corsair Obsidian 750D Airflow 顯卡長45 / CPU高17 / SSD x 8 (6共用) / 前面板網孔 /E-ATX  * 1</li>
<li>CPU 散熱器: Corsair H60 12cm冷排/ 扁平化幫浦/ (方)銅底冷頭/ 厚:5.2cm * 1</li>
<li>裝機顯卡: ASUS GT 710-1-SL / 954MHz / 1G DDR3 / 靜音版 / 13.5cm * 1</li>
<li>Power: be quiet! Straight Power 11(E11) 650W/金牌/全模/5年保/LLC+DC-DC/CPU主線:16AWG * 1</li>
<li>(Optional) 外掛網卡: Intel i350-T4 * 1</li>
</ul>
<p>Q: 該買?</p>
<p>光華歡迎你，最近記憶體便宜到爆炸錢包君覺得非常哀傷</p>
<h4 id="_3"><a class="toclink" href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/#_3">詳細說明</a></h4>
<p>關於計算資源，<a href="https://ark.intel.com/content/www/us/en/ark/products/92986/intel-xeon-processor-e5-2620-v4-20m-cache-2-10-ghz.html">Intel E5-2620 v4</a> 一顆很貴啊...錢包君真的會吃土，所以那時候先只買一顆，然後記憶體先買滿，但實際上只會用到一半而已。等人捐贈另一顆 E5-2620 v4 或等拋售 QQ。另外要注意的地方是，Memory Types 僅支援到 DDR4 2133 ECC Reg，所以一開始沒注意買 DDR4 2600 ECC Reg 當冤大頭。</p>
<p>關於機箱，直接看別人開箱文章 <a href="https://www.mobile01.com/topicdetail.php?f=299&amp;t=5074578">Corsair Obsidian 750D ATX機殼之裝機使用分享</a> 比較快，配上 Corsair H60 散熱整體上蠻安靜的，如果有點聲音的話拿吸塵器吸一吸風扇就好了。然後這個機箱給 E-ATX 主機板，所以真的是蠻大台的，相對擴充性也蠻好的，等待好心人捐 Nvidia V100 / T4 玩玩。</p>
<p><img alt="" src="/images/tower-view.jpg" /></p>
<p>關於電源，無愛好，我就是被 <code>be quiet!</code> 這名字打到，<strong>產品命名很重要</strong></p>
<p>關於網路，這個就蠻重要的，首先主機板 <a href="https://www.asus.com/tw/Motherboards/Z10PED16_WS/">ASUS Z10PE-D16 WS </a> 有加裝一個 BMC，支援相容於 <code>IPMI 2.0</code> 的 ASMB8-iKVM 晶片，所以就可以用 <code>ipmitool</code> 或 <a href="https://pypi.org/project/pyghmi/"><code>pyghmi</code></a> 來做 OOB 遠端伺服器管理，個人使用主要都是用 <a href="https://docs.ansible.com/ansible/latest/modules/ipmi_power_module.html#ipmi-power-module">ansible/ipmi_power</a> 這個模組為主。</p>
<p>Q: 如果主機板沒有 BMC，那有沒有替代 IPMI 的方案?</p>
<p>有，但我個人覺得不太好，PDU 遠端 IPMI 切開關電源的方式，或者是一些 IoT 有類似這種遠端開關電源的方案。這個要謹慎設計使用，因為跟直接拔電源沒啥兩樣 ，屬於冷關機，如果真要用的話，記得要先做熱關機，再切電源比較好。</p>
<blockquote>
<p>Ansible Workflow &lt;3 你</p>
</blockquote>
<p>另外主機板有提供兩個內建 1Gb 可以用，這邊選了一個當 WAN 使用，這應該是沒什麼懸念的</p>
<p><img alt="" src="/images/tower-nics.jpg" /></p>
<p>Q: 為什麼會有一個 Intel i350-T4 在那邊晾著?</p>
<p>完全是一個腦衝的結果，原先預期目標是要做以這台塔式 Server 為核心的架構設計，做 Two-Arm，但看了看覺得有點顧慮就不搞了。如果對網路處理吃重的，可以把 <code>SR-IOV</code> 開起來，可以直接有 8 VFs 可以使用，網路效率會蠻好的。</p>
<p>後面會有一篇解釋 {pfSense, OPNsense, ooxx UTM} on {vSphere, Proxmox, KVM Libvirt} 虛擬網路設計怎麼做 Two-Arm，自建 Lab 來說還蠻好用的架構</p>
<h3 id="_4"><a class="toclink" href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/#_4">總結</a></h3>
<p>整體上來說，IPMI 這個功能對於我從 Bastion 堡壘機上，透過 Ansible Tower 控制服務器來講非常重要，其他資源都是為了要承載 Lab 所需要的運算資源而生的，可以自行做刪減。</p>
    <nav class="md-post__action">
      <a href="../../2019/11/15/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-2-%E5%AE%85%E5%AE%85%E9%9B%B2%E7%A1%AC%E9%AB%94%E4%BB%8B%E7%B4%B9/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-14 00:00:00">November 14, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/homecloud/" class="md-meta__link">homecloud</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2019-1"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/">2019 大改造宅宅雲架構系列文-1 總綱及裝備清單</a></h2>
<p>最近這兩三年發現技術越變越快，而且還越變越多，等著別人給我資源學習，不如還是靠自己準備資源來做一些 Lab 性質的測試，但台北花費真的是太高了，薪水不太夠付電費，所以為了節省電費救救錢包君，所以把整個家裡的宅宅雲改造了一下。</p>
<p>本系列文還蠻適合想要嘗試在家裡土砲基礎架構做一些奇怪測試的人交流，雖然我覺得應該蠻多人都知道相關的技術了，只是整合在一起的樣子可能不是很多人看過，反正就當心路歷程看看吧。</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#_1">宅宅雲總體戰略目標</a></h3>
<ol>
<li>從世界各地的某個角落，遠端啟動或關閉<strong>整座</strong>宅宅雲</li>
<li>宅宅雲要支援多網段，方便將不同目的或專案在不同網段上切割實作</li>
<li>所有機器需具備 FQDN，宅宅雲內部的所有機器都可正反解</li>
<li>懶得每次都在那邊點例外處理的按鈕，所以自簽 SSL/TLS 而有用到的服務全都要上</li>
<li>所有服務，能虛擬化的全部採用虛擬化</li>
<li>因為沒錢，所以不考慮任何高可用性的問題</li>
<li>無聊的設定工作，做超過三次，考慮或使用 Ansible 自動化流程</li>
<li>建立 Chat Center，用 bot 跟自己聊天</li>
</ol>
<h3 id="hld"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#hld">HLD 架構圖</a></h3>
<p><img alt="" src="/images/homecloud-1.png" /></p>
<h3 id="_2"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#_2">核心硬體裝備</a></h3>
<p>打英雄聯盟的時候，每個角色都會有所謂的核心裝備，而相同的在做基礎架構，我個人推薦也真的有使用的核心裝備如下：</p>
<ol>
<li>SSL VPN: Synology RT2600ac</li>
<li>Bastion: Lenovo T480s (Red Hat Employee Special Edition)</li>
<li>Storage: Synology DS916+</li>
<li>宅宅雲: 自組塔式伺服器 (內建 IPMI)</li>
</ol>
<p>在平時沒用宅宅雲的狀態下，1/2/3 項次會保持全年全天開機常駐的狀態，有需要做 Lab 的時候才會把 4 開起來，因為最吃電</p>
<h4 id="ssl-vpn-synology-rt2600ac"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#ssl-vpn-synology-rt2600ac">SSL VPN: Synology RT2600ac</a></h4>
<p>有一天的晚上，發現 Synology RT2600ac 除了有一般 802.11ac / DHCP 等家用功能以外，還有 VPN Plus 的功能可以使用，所以就開啟了大改造宅宅雲之路。</p>
<p>Q: 為什麼會說改造呢?</p>
<p>因為一開始的時候 WAN 是走 4G USB Dongle 上網的，SSL VPN 不能用，後來退掉換成光世代，申請 1+7 固定 IP 方案，才能正常運作 SSL VPN。此外，Synology VPN Plus 預設只有授權一個人使用，要多人連線的話要另外採購授權，詳細請洽他們業務。</p>
<p><img alt="" src="/images/vpn-plus.png" /></p>
<p>Q: 那有沒有可以替代的方案呢?</p>
<p>答案是有的，只要有服務能支援 OpenVPN / IPSec (例: pfSense / OPNsense / ...) 能上 Public Static IP 都可以當作 VPN Server 使用，我個人先前是比較傾向用 OpenVPN on VM 為主，架構可參考以前寫的 <a href="https://speakerdeck.com/pichuang/build-testing-infrastructure?slide=17">Build Testing Infrastructure - Phil Huang</a>。家用因為還有其他設備需要無線上網 (手機 / 筆電 / Chromecast / PS4 / NS)，所以把主要網路核心放在 RT2600ac 身上。</p>
<h4 id="bastion-lenovo-t480s-red-hat-employee-special-edition"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#bastion-lenovo-t480s-red-hat-employee-special-edition">Bastion: Lenovo T480s (Red Hat Employee Special Edition)</a></h4>
<p>這台是入職 Red Hat 的時候配發的筆電，老闆說：<strong>身為一個 Red Hat Infra Solution Architect 就應該要灌 RHEL / Fedora...</strong>，恩...所以我把他當堡壘機用，沒事不關機。</p>
<p>既然身為一台堡壘機，就是期望在什麼狀況下都要屹立不搖，包含停電和瞬斷，剛好這台是個筆電，內建有電池，平時又插著電源，故入職後到進行大改造宅宅雲之前，累積了 386 天的 Uptime，上次養這麼久的 Server 應該是研究所的時代了... (菸</p>
<p><img alt="" src="/images/rhel7-poweron.jpg" /></p>
<p>Q: 他既然是個堡壘機，那幹嘛動它?</p>
<p>理由是資源使用率太低了，先前只是寫寫一些怪東西，跑幾個 Ansible Playbook，絕大部分時間空有 8C / 24G 在那邊閒置，不如讓他做點有意義的事情，所以改造如下：</p>
<h5 id="rhel-77-rhel-81"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#rhel-77-rhel-81">RHEL 7.7 重灌成 RHEL 8.1</a></h5>
<p><img alt="" src="/images/rhel8-1.jpg" /></p>
<p>剛好順便要開始熟悉 RHEL 8 系列了，所以趁機換裝練習看看，關於詳細的新功能條列可以參考 <a href="https://openingsource.org/6629/zh-tw/">Red Hat Enterprise Linux 8.0 正式發布 - 開源工場</a></p>
<h5 id="rhel-81-cockpit-vm"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#rhel-81-cockpit-vm">RHEL 8.1 裝備 Cockpit 管理 VM</a></h5>
<p><img alt="" src="/images/rhel8-2.jpg" /></p>
<p>基礎就是使用 KVM libvirt，所以只要建好 Linux Bridage 對接 Physical NIC 即可好好使用........................................</p>
<p>Q: 為什麼要點點點...</p>
<p>因為 RHEL 8 開始要開始宣揚 NetworkManager 的美好 (?) 了，所以如果你習慣開場把 NM 關掉的小夥伴 (小弟我)，會發現到一些神祕的現象，所以眾多考量下，還是學一下 <code>nmcli</code>。關於 Linux Bridge with nmcli 詳細步驟請參閱 <a href="https://computingforgeeks.com/how-to-create-a-linux-network-bridge-on-rhel-centos-8/">Create a Linux Network Bridge on RHEL 8 / CentOS 8 with nmcli</a>，步驟寫的很乾淨的一篇。</p>
<p>Q: VM 主要跑什麼?</p>
<p>最主要是<code>Ansible 自動化</code>，過往我都是寫完 Ansible Playbook 就直接在堡壘機上執行，但我後來實在是寫到花掉，忘記怎麼下，所以就動用了紅帽員工的神力建了 Red Hat Ansible Tower 起來，後來我的所有操作都在 Ansible Tower 上面，包含用 IPMI 去開關機宅宅雲...</p>
<p><img alt="" src="/images/homecloud-powerstate.png" /></p>
<p>[工商時間] 就在 2019/11/14 這天 Red Hat Ansible Tower 發佈了 3.6.1 版本，自帶 Approval 按紐啊啊啊啊啊啊!!!!</p>
<p><img alt="" src="/images/ansible-tower-approval.png" /></p>
<p>關於我之前未改造前的 Ansible Tower 的定位，後面會找個一篇講下，這服務對我個人使用來說跟 SSL VPN 同等重要。</p>
<h5 id="rhel-81-cockpit-container"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#rhel-81-cockpit-container">RHEL 8.1 裝備 Cockpit 管理 Container</a></h5>
<p><img alt="" src="/images/rhel8-3.jpg" /></p>
<p>這邊要特別講一下關於 Container 的事情，Red Hat 目前主要推行的容器專案是以 (下圖由左至右) Podman / Buildah / Skopeo 為主，不主推 Docker 為主的專案，但兩者都是支援 OCI (Open Container Initiative) Runtime 的標準規範，所以在使用上起來幾乎是大同小異，有興趣想要使用同一份 Dockerfile 自己用 podman 及 docker 編起來試試看的，可以參考 <a href="https://github.com/pichuang/debug-container">pichuang/debug-container</a> 內有 Makefile 方便理解；若想要理解關於 OCI 的兩三事，請參考 <a href="https://www.hwchiu.com/container-design-ii.html">[Day3] 淺談 Container 實現原理, 探討 OCI 實作 - hwchiu</a></p>
<p><img alt="" src="/images/buildah-podman-skopeo.png" /></p>
<h4 id="storage-synology-ds916"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#storage-synology-ds916">Storage: Synology DS916+</a></h4>
<p>NAS 理所當然地被我拿來當 NFS Server 裡面存一些特殊性資料</p>
<p>除了 NFS 的服務以外，全站的 DNS Server 我也是放在上面，不得不說...這個 S 社 GUI 真的做得還可以啊...DNS Entry 點點敲敲就有了。</p>
<p>回到架構面上，NAS 很少人在關機吧？個人判斷 NAS 被關機機會基本上還是會小於堡壘機 (斷電除外)，剛好宅宅雲的建置條件都有配置內部的 FQDN，我沒有習慣寫 <code>/etc/hosts</code>，基於 <code>/etc/nsswitch.conf</code> 內指示</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cat /etc/nsswitch.conf
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>...omit...
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>hosts:      files dns myhostname
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>...omit...
</code></pre></div>
<p>所以 DNS 對宅宅雲來說跟 NFS 服務一樣角色吃重，所以選擇放在跟 NAS 一起的位置。</p>
<h4 id="_3"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#_3">宅宅雲: 自組塔式伺服器</a></h4>
<p>這台資訊太多之後下一篇講 XD
傳送門: <a href="https://blog.pichuang.com.tw/20191115-homelcloud-high-level-design-2">2019 大改造宅宅雲架構系列文-2</a></p>
<h3 id="_4"><a class="toclink" href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/#_4">總結</a></h3>
<p>這篇主要是留個紀錄，基本架構都是基於先前在 Edgecore Network 工作時自建遠端環境的經驗 <a href="https://speakerdeck.com/pichuang/build-testing-infrastructure?slide=17">Build Testing Infrastructure - Phil Huang</a> 轉換情境到家中這種小規模時的架構紀錄，沒有絕對對錯 (有一些物理上的考量)，僅供參考</p>
    <nav class="md-post__action">
      <a href="../../2019/11/14/2019-%E5%A4%A7%E6%94%B9%E9%80%A0%E5%AE%85%E5%AE%85%E9%9B%B2%E6%9E%B6%E6%A7%8B%E7%B3%BB%E5%88%97%E6%96%87-1-%E7%B8%BD%E7%B6%B1%E5%8F%8A%E8%A3%9D%E5%82%99%E6%B8%85%E5%96%AE/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-06-18 00:00:00">June 18, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/automation/" class="md-meta__link">automation</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ansible"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/">Ansible 如何除錯? 誰可以救救我?</a></h2>
<p><img alt="" src="/images/ansible-logo.png" /></p>
<p>可喜可賀，恭喜一下 Ansible 來到了 2.8 版號啦! 有興趣可以參考一下 <a href="https://github.com/ansible/ansible/blob/stable-2.8/changelogs/CHANGELOG-v2.8.rst">Release Note</a></p>
<p>就個人經驗上，還蠻常遇到會寫 Ansible Playbook 的技術工程師，而他們的共通煩惱都是 Ansible 似乎疑難排解 (Trouble Shooting) 有些困難，常常遇到一個問題會看很久不知道怎麼下手開始除錯 (Debug)。本篇將分享一下筆者平時的作法，供廣大看倌們參考省下不少冤枉路。而如果你覺得我寫的看不太懂可以參考一下艦長的兩篇大作  <a href="https://medium.com/laraveldojo/%E8%AE%93%E6%82%A8%E5%AE%89%E5%BF%83%E5%9F%B7%E8%A1%8C-ansible-playbook-%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7-1-c634f2963bc9">讓您安心執行-ansible-playbook-的小技巧-1</a> 、<a href="https://medium.com/laraveldojo/%E8%AE%93%E6%82%A8%E5%AE%89%E5%BF%83%E5%9F%B7%E8%A1%8C-ansible-playbook-%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7-2-856a60b19898">讓您安心執行-ansible-playbook-的小技巧-2</a></p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#_1">經驗分享</a></h3>
<h4 id="_2"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#_2">改成工程師看得懂的除錯訊息：不打迷糊仗</a></h4>
<p>預設狀況下，Ansible 輸出的格式是以 JSON 格式為主，然後通常輸出的時候都會如下圖顯示變成一坨不知道在寫什麼的訊息，十分難以判讀</p>
<p><img alt="" src="/images/ansible-callback-debug-1.png" /></p>
<p>但 <a href="https://docs.ansible.com/ansible/latest/plugins/callback.html">Ansible Callback Plugins</a> 有支援一個外掛模組叫做 <a href="https://docs.ansible.com/ansible/latest/plugins/callback/debug.html"><code>debug</code></a>，主要是協助把上面那一坨東西的 stdout 及 stderr 格式化 (Format) 成下圖，讓你清晰地了解錯誤訊息在寫什麼</p>
<p><img alt="" src="/images/ansible-callback-debug-2.png" /></p>
<p>開起來的方式很簡單，開啟 <code>ansible.cfg</code>，填入以下內容即可</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>[default]
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>...
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>stdout_callback = debug
</code></pre></div>
<h4 id="debug"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#debug">愛用 debug 模組：其實就是多噴點資訊</a></h4>
<p>若在 Ansible 執行過程中，你想要了解某一個變數裡面的值是什麼，可以使用 <a href="https://docs.ansible.com/ansible/latest/modules/debug_module.html"><code>debug</code></a> 模組來獲取運行中的 Ansible 執行變數資訊。要留意的事情是，這邊的 debug 是一個 Ansible 模組 (Modules)，上面章節所提起的則是 Callback 外掛當中一個模組，兩者不一樣。</p>
<p>通常 <code>debug</code> 模組都會搭配 <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html?highlight=register#registering-variables"><code>register</code></a> 一併使用，<code>register</code> 最主要功用是將單一 Task 結果輸出指派給 <code>register</code> 所定義好的變數，如下程式碼</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>---
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>- hosts: all
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>  tasks:
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    - name: Test connectivity
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>      ping:
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>      register: result
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    - name: Print result
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>      debug:
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        msg: &quot;{{ result }}&quot;
</code></pre></div>
<p>可以很清楚的看到，第一個 Task 將會執行 <code>ping</code> 模組，而它產生出來的結果將會被指向 register 所定義的 <code>result</code> 變數裡面，而第二個 Task 將會執行 <code>debug</code> 模組，將裡面 <code>result</code> 的結果倒出來顯示在如下畫面</p>
<p><img alt="" src="/images/ansible-modules-debug.png" /></p>
<h4 id="dry-run"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#dry-run">實際執行前先跑 Dry Run 看看：永保安康</a></h4>
<p>蠻多工程師因為不熟 Ansible，很擔心會不會一執行錯誤的指令下去，就會導致災難這樣，所以 Ansible 提供一個檢查模式 <a href="https://docs.ansible.com/ansible/2.8/user_guide/playbooks_checkmode.html"><code>dry-run</code></a>，供工程師在正式執行前可以透過模擬指令的方式協助檢查一下當前執行的 Playbook 裡面打算要做什麼事</p>
<p>一般作法應該是在下 <code>ansible-playbook</code> 指令的後面多帶 <code>--check</code> 指令</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a># 起手式
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>$ ansible-playbook -i pichuang.yml --check
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a># 嫌資訊太少時
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>$ ansible-playbook -i pichuang.yml --check -v
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a># 想要一個一個 Tasks 慢慢看時
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>$ ansible-playbook -i pichuang.yml --step --check
</code></pre></div>
<img alt="" src="/images/ansible-dry-run.png" /></p>
<h4 id="playbook-debugger-ansible"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#playbook-debugger-ansible">Playbook Debugger：當你想要成為 Ansible 超高級寫手時...</a></h4>
<p>在先前的社群分享中，筆者有多次提到目前把 Ansible Playbook 寫的第一無敵複雜的範例就是 <a href="https://github.com/openshift/openshift-ansible">GitHub - openshift/openshift-ansible</a> 這個專案了，雖然整個安裝只需要跑兩三行指令，但只要變數寫錯或者是忘記寫，就要反覆跑好幾次，而跑一次大概就要花上好幾個半小時的光陰。</p>
<p>而先前為了抓 <code>openshift-ansible</code> 安裝時的其中一個很弔詭的問題，最後動用了 <code>debugger</code> 才找到一個神奇的字串問題。正常沒寫到這麼複雜的狀況下，其他上述所列的方式其實就很夠日常維運用了。</p>
<p>開啟 <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_debugger.html">Playbook Debugger</a> 的方式很簡單，開啟 <code>ansible.cfg</code>，填入以下內容即可</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>[default]
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>...
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>strategy = debug
</code></pre></div>
<p>開啟之後， debugger 會在遇到 <code>Task Failed</code> 的時候，自動切換到 debug mode，詳細操作可以參考一下 <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_debugger.html#available-commands">Available Commands</a></p>
<p><img alt="" src="/images/ansible-debugger.png" /></p>
<h3 id="_3"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#_3">後言</a></h3>
<p>Ansible 本質上是遵循三大要素：Simple、Agentless、Powerful，撰寫邏輯上是，能寫得簡單就盡量寫的單純，不要寫得太過複雜。依據不同的情境之下，相信大家都會將越來越多的情境考慮進去，以至於 Ansible Playbook 越來越大，不太容易進行基本除錯，故希望本篇能幫助到各位快速上手除錯技巧。而如果你對於其他 Ansible 撰寫技能有興趣的話，也可以參考一下去年拙作  <a href="https://blog.pichuang.com.tw/20180622-suggestions_to_improve_your_ansible_playbook/">幾個小建議改善你的 Ansible 技能 - Phil Huang</a>。</p>
<h3 id="references"><a class="toclink" href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/#references">References</a></h3>
<ul>
<li><a href="https://medium.com/laraveldojo/%E8%AE%93%E6%82%A8%E5%AE%89%E5%BF%83%E5%9F%B7%E8%A1%8C-ansible-playbook-%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7-1-c634f2963bc9">讓您安心執行-ansible-playbook-的小技巧-1 - Chengwei Chen</a></li>
<li><a href="https://medium.com/laraveldojo/%E8%AE%93%E6%82%A8%E5%AE%89%E5%BF%83%E5%9F%B7%E8%A1%8C-ansible-playbook-%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7-2-856a60b19898">讓您安心執行-ansible-playbook-的小技巧-2 - Chengwei Chen</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/plugins/callback.html">Ansible Callback Plugins List</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/plugins/callback/debug.html">Ansible Callback Plugins - Debug</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/modules/debug_module.html">Ansible Modules - Debug</a></li>
<li><a href="https://github.com/ansible/ansible/blob/stable-2.8/changelogs/CHANGELOG-v2.8.rst">Ansible 2.8 Release Note</a></li>
<li><a href="https://github.com/openshift/openshift-ansible">GitHub - openshift/openshif-ansible</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_debugger.html">Ansible Strategy - Playbook Debugger</a></li>
<li><a href="https://blog.pichuang.com.tw/20180622-suggestions_to_improve_your_ansible_playbook/">幾個小建議改善你的 Ansible 技能 - Phil Huang</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2019/06/18/ansible-%E5%A6%82%E4%BD%95%E9%99%A4%E9%8C%AF-%E8%AA%B0%E5%8F%AF%E4%BB%A5%E6%95%91%E6%95%91%E6%88%91/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-05-27 00:00:00">May 27, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/linux/" class="md-meta__link">linux</a></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="bandwidth-throughput"><a class="toclink" href="../../2019/05/27/bandwidth--throughput/">Bandwidth &amp; Throughput</a></h2>
<p><img alt="" src="/images/throughput-bandwidth.png" /></p>
<ul>
<li>頻寬 (Bandwidth)：水管的大小</li>
<li>吞吐量 (Throughput)：從水管實際流出的水量</li>
<li>延遲 (Latency)：水從一端到另一端所花費的時間</li>
</ul>
<!--more-->

<h3 id="bandwidth"><a class="toclink" href="../../2019/05/27/bandwidth--throughput/#bandwidth">理論值頻寬 (Bandwidth) 換算</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>1 Gbps = 1024 Mbps = 128 MBps = 0.125 GBps
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>7 Gbps = 7168 Mbps = 896 MBps = 0.875 GBps
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>10 Gbps = 10240 Mbps = 1280 MBps = 1.25 GBps
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>20 Gbps = 20480 Mbps = 2560 MBps = 2.5 GBps
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>25 Gbps = 25600 Mbps = 3200 MBps = 3.125 GBps
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>40 Gbps = 40960 Mbps = 5120 MBps = 5 GBps
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>50 Gbps = 51200 Mbps = 6400 MBps = 6.25 GBps
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>100 Gbps = 102400 Mbps = 12800 MBps = 12.5 GBps
</code></pre></div>
<h3 id="_1"><a class="toclink" href="../../2019/05/27/bandwidth--throughput/#_1">資料傳輸換算</a></h3>
<p>理論傳輸公式：Time (s) = File Size / Bandwidth
實際傳輸公式：Time (s) = File Size / Throughput</p>
    <nav class="md-post__action">
      <a href="../../2019/05/27/bandwidth--throughput/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-04-04 00:00:00">April 4, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/openshift/" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-v311"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/">Red Hat OpenShift v3.11 東西南北向網路探討</a></h2>
<h3 id="_1"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#_1">資料中心東西南北向網路流</a></h3>
<p>一般討論的資料中心資料流量，主要分為兩大流向
- 南北向 (North-South Traffic):  Client 與 Server 之間的網路流量
- 東西向 (East-West Traffic): Server 與 Server 之間的網路流量</p>
<p><img alt="" src="/images/network-traffic.png" /></p>
<p>那如果套用在 Red Hat OpenShift v3.11 容器平台架構下，那實際網路流量是如何對應?</p>
<!--more-->

<h3 id="red-hat-openshift-311"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#red-hat-openshift-311">Red Hat OpenShift 3.11 東西南北向網路流</a></h3>
<p>首先先來張常見的架構圖</p>
<p><img alt="" src="/images/openshift-network-traffic-1.png" /></p>
<p>以 Red Hat OpenShift 為核心視角，可以分為三段網路
1. 北向網路流 Ingress Traffic
2. 東西向網路流
3. 南向網路流 Egress Traffic</p>
<h4 id="ingress-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#ingress-traffic">北向: Ingress Traffic</a></h4>
<p>從 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">What is Ingress? - Kubernetes</a> 定義上來說，可以了解到 Ingress 主要的目的就是讓外部使用者可以透過 <code>Ingress Controller</code> 接觸到 Kubernestes 裡面的 Service，而在 Red Hat OpenShift 裡面的術語則是使用 <code>Router</code> 來做闡述</p>
<p>故在 <a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html">Routes - OpenShift Docs v3.11</a> 裡面所描述的內容，可以用下表進行術語上的對應</p>
<table>
<thead>
<tr>
<th>Kubernetes</th>
<th>OpenShift</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ingress resource (rules)</td>
<td>Route (rules)</td>
</tr>
<tr>
<td>Ingress controller (Nginx/Ambassador/...)</td>
<td>Router (HAProxy)</td>
</tr>
</tbody>
</table>
<p>而 Ingress Controller 其實是一個統稱，在 OpenShift Router 具體實踐上主要有<a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/assembly_available_router_plugins.html#architecture-additional-concepts-router-plugins">支援兩種類型</a>
1. OpenShift Router (預設)
2. F5 BIG-IP Controller (要搭 F5)</p>
<p>有些人會問說同一平台內，能不能存在多個 Ingress Controller? 答案是可以，但要留意各 Ingress Controller 的實作方式，譬如說 OpenShift Router 的方式是採用 <code>hostnetwork</code> 的走法，所以每一台 host 僅能安裝一個，詳細可參考 <a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods - Phil Workspace</a></p>
<h4 id="east-west-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#east-west-traffic">東西向: East-West Traffic</a></h4>
<p>在 Red Hat OpenShift 平台底下，無論是要跨 Pod / Service / Host 進行橫向的溝通，都是需要有 CNI (Cotainer Network Interface) 的實踐才能將不同主機之間的連線建立起來。CNI 本身是一套標準，實作上就會有百花齊放的專案可供使用，詳細可參考 <a href="https://www.hwchiu.com/cni-compare.html">常見 CNI (Container Network Interface) Plugin 介紹 - hwchiu</a></p>
<p>而預設上，Red Hat OpenShift 提供三個 CNI Plugin 可供使用
1. ovs-subnet: 單純 L2，類同 flat network
2. ovs-multitenant: 可針對不同的 namespace/project 進行隔離
3. ovs-networkpolicy: 控制細粒度最細，可以使用 <code>NetworkPolicy</code> object，類同於寫 iptables rules 一樣</p>
<p>當然如果遠遠覺得這三個功能不符合需求的話，還可以介接第三方廠商的 CNI Plugin，譬如 Juniper Contrail、VMWare NSX-T 等專業網路廠商的方案進行虛實整合 (Overlay + Underlay Integration)</p>
<h4 id="egress-traffic"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#egress-traffic">南向: Egress Traffic</a></h4>
<p>Egress 顧名思義可以了解到是從 OpenShift 的 Pod 向外去存取外部服務 (例: Database)，在沒有任何限制之下，在 OpenShift 底下的任何 Pod 當然是可以隨意地去存取外部服務，以下圖表接節錄 <a href="https://www.redhat.com/files/summit/session-assets/2018/Network-security-for-apps-on-OpenShift.pdf">Network Security for Apps on OpenShift - Red Hat Summit</a></p>
<p><img alt="" src="/images/egress-network.png" /></p>
<p>試想若你的外部服務有需要為了資安保護進行存取限制，而你的 Compute Node 卻有複數台以上的話，是不是要特別把這些 Compute Node 的 IP 收集起來後，在外部服務中設定白名單開啟? 倘若環境又是經常性變動的話，是不是每次變動都要進行一次修改呢? 所以這時候就會有針對 Egress Traffic 的三種做法</p>
<ol>
<li>OpenShift Egress Firewall</li>
<li>OpenShift Egress Routers</li>
<li>Egress static IP</li>
</ol>
<p><img alt="" src="/images/egress-firewall.png" />
<img alt="" src="/images/egress-router.png" />
<img alt="" src="/images/egress-static.png" /></p>
<p>其中 OpenShift Egress Routers 的技術細節跟上面所討論的 Ingress Controller: OpenShift Router 是很類似的，而模式上也有三種做法可以選擇，分別是 Redirect、HTTP Proxy、DNS Proxy</p>
<table>
<thead>
<tr>
<th>分類</th>
<th>Redirect mode</th>
<th>HTTP Proxy mode</th>
<th>DNS Proxy mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>Support Protocols</td>
<td>TCP/UDP</td>
<td>HTTP/HTTPS</td>
<td>TCP</td>
</tr>
<tr>
<td>Image</td>
<td>ose-pod</td>
<td>ose-egress-http-proxy</td>
<td>ose-egress-dns-proxy</td>
</tr>
<tr>
<td>Technology</td>
<td>Netfilter rules</td>
<td>Squid</td>
<td>HAProxy</td>
</tr>
</tbody>
</table>
<h3 id="summary"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#summary">Summary</a></h3>
<p>無論是 Kubernetes / OpenShift 一般在討論容器平台網路的不外乎都是在討論 Pod / Service / NodePort 等等的應用，但實際上使用的時候會蠻推薦用資料流 (Data Flow) 的觀點下去做每一個點的討論，這樣在技術選型上才不會思考太久，當然整體網路考慮不會只有單單這一篇文章就可以全部講完的，其實有非常多細節可以做探討，尤其是如何跟現有網路做對接、防火牆環境隔離等等都得一併考慮進去。</p>
<p>希望這篇能幫助大家用高視角的方式來理解整個 Red Hat OpenShift v3.11 網路流量走向</p>
<h3 id="appendix-openshift-v3-f5"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#appendix-openshift-v3-f5">Appendix: 針對 OpenShift v3 版本之 F5 設定</a></h3>
<p><img alt="" src="/images/ocp3_f5.png" /></p>
<h3 id="references"><a class="toclink" href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/#references">References</a></h3>
<ul>
<li><a href="https://www.cisco.com/c/en/us/products/collateral/switches/nexus-7000-series-switches/white-paper-c11-737022.html">Cisco Data Center Spine-and-Leaf Architecture: Design Overview White Paper</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress">What is Ingress? - Kubernetes</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/assembly_available_router_plugins.html#architecture-additional-concepts-router-plugins">Available router plug-ins - OpenShift Docs v3.11</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html">Routes - OpenShift Docs v3.11</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/sdn.html">OpenShift SDN - OpenShift Docs v3.11</a></li>
<li><a href="https://blog.pichuang.com.tw/20190321-reach-out-services-and-pods-from-outside-into-openshift/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></li>
<li><a href="https://www.hwchiu.com/cni-compare.html">常見 CNI (Container Network Interface) Plugin 介紹 - hwchiu</a></li>
<li><a href="https://www.redhat.com/files/summit/session-assets/2018/Network-security-for-apps-on-OpenShift.pdf">Network Security for Apps on OpenShift - Red Hat Summit</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/admin_guide/managing_networking.html#admin-guide-controlling-egress-traffic">Controlling Egress Traffic - OpenShift Docs v3.11</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2019/04/04/red-hat-openshift-v311-%E6%9D%B1%E8%A5%BF%E5%8D%97%E5%8C%97%E5%90%91%E7%B6%B2%E8%B7%AF%E6%8E%A2%E8%A8%8E/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-03-21 00:00:00">March 21, 2019</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/openshift/" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-services-pods"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/">從 Red Hat OpenShift 外部訪問 Services 或 Pods</a></h2>
<p>Red Hat OpenShift v3.11 架構裡網路主要分為三大塊:</p>
<ol>
<li>Hosts subnet</li>
<li>Service subnet</li>
<li>Pod subnet</li>
</ol>
<!--more-->

<p>Host subnet 毫無懸念指的就是主機所使用的 IP，也就是對外可以接觸到主機的網路; 而 Service 和 Pods subnet 在 OpenShift 裡面是一個虛擬概念，正常狀況下外部網路無法透過 Pod IP/Port 和 Service IP/Port 接觸到服務</p>
<p>那如果我想要讓 Pod 或 Service IP 可以被外面接觸到呢? 以下分為兩個層級來討論:
1. Pod mapping to host
2. Service mapping to host</p>
<h3 id="pod-port-mapping-to-host-port"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#pod-port-mapping-to-host-port">Pod port Mapping to Host port</a></h3>
<h4 id="hostnetworktrue"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#hostnetworktrue">使用 <code>hostNetwork=true</code></a></h4>
<p>若沒有特別指定的話，預設 <code>hostPort</code> 等於 <code>containerPort</code>，意思是說 Pod 裡面的容器開了什麼 Port 就會直接對應到 host 上面的 Port，而 Pod IP 則會理所當然地等於 Host IP</p>
<p>外面訪問服務的 IP/Port，請求會直接轉到和 Pod 相同的 IP/Port ，途中不經過 iptables 及 service 處理</p>
<p>優點: 直接可以從外面直接接觸到 Pod 層級服務，網路轉發效率會比 nodePort 好
缺點: 不能在同一台主機 (Host) 開啟第二個相同的 Pod，因為會有 Port 衝突的問題，也不能跨主機建立服務</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true &lt;----</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<h4 id="hostport"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#hostport">使用 <code>hostPort</code></a></h4>
<p>概念跟前者很像，差異會在可以指定特定的 <code>hostPort</code> 對應到 <code>containerPort</code>，但並不需要全部的 Pod Port 都跟 Host 做對應，可以有限度的開放出去</p>
<p>優點: 直接可以從外面直接接觸到 Pod 層級服務
缺點: 不能在同一台主機 (Host) 開啟第二個相同的 Pod，因為會有 Port 衝突的問題，也不能跨主機建立服務</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nn">---</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">      </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080 &lt;----</span>
</code></pre></div>
<h3 id="service-port-mapping-to-host-port"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#service-port-mapping-to-host-port">Service port Mapping to Host port</a></h3>
<h4 id="nodeport"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#nodeport">使用 <code>nodePort</code></a></h4>
<p>廣泛應用的服務揭露方式，在預設情況下，每啟動一個 Service 都會搭配一個 <code>ClusterIP</code>，而這個 <code>ClusterIP</code> 僅能在同一個集群內部被訪問，外面不能接觸到，倘若想要讓他被接觸的話，就要指定 <code>nodePort</code> 對外揭露</p>
<p>hostPort 跟 nodePort 的差異在，前者是針對單一主機裡的單一容器進行設定，後者則是以一個集群來看待，服務可以跨主機</p>
<p>優點: 可跨主機，直接可以從外面直接接觸到 Service 層級服務，且能透過所產生的 ClusterIP 對後端的 Pod 做負載均衡
缺點: 所有集群的 Port 都會同時被開起來，讓外部做接觸</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nn">---</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8086</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000 &lt;---</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
</code></pre></div>
<p>建議可以搭一個外部 Reverse Proxy 來做使用，譬如像是 F5 / A10 / HAProxy</p>
<h4 id="ingress-controller-openshift-router"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#ingress-controller-openshift-router">使用 Ingress Controller: OpenShift Router</a></h4>
<p>綜合 Pod 跟 Service 的優點的改良作法，也是普遍建立對外服務時的最佳實踐。你不需要自己對所有的 Service 去新增 <code>nodePort</code>，而可以直接在 OpenShift 上建立一個 Reverse Proxy 的服務，直接進行對外服務揭露及對內服務負載平衡，依據不同的 Ingress Controller 實作，通常功能都會包含 HTTP 路徑揭露、Session Sticky、SSL Transparent/Re-encrypt/Terminated 等等負載平衡的功能</p>
<p>OpenShift Router 是採用 <code>hostnetwork</code> 的方式建立，所以每一台主機至多只能安裝一個，同時 80 / 443 /1936 這三個 Port 會被預設佔走</p>
<p>想了解於 OpenShift 對於 Ingress Controller 的實作 <code>Router</code> 可以參考 <a href="https://docs.openshift.com/container-platform/3.11/install_config/router/index.html">Router Overview - OpenShift v3.11 Docs</a></p>
<h4 id="service-type-loadbalancer"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#service-type-loadbalancer">使用 Service Type: <code>LoadBalancer</code></a></h4>
<p>正常使用下，這功能僅限於公有雲，但在 OpenShift 裡面有支援一個功能叫做 <code>ingress IP</code>，效果就是給 OpenShift 僅一個特定的網段 (Subnet) 之後，可以從中選取任一 IP，並使用 <code>type: LoadBalancer</code> 對外揭露服務，詳細可以參考 <a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></p>
<h4 id="external-ingressip"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#external-ingressip">使用 External IngressIP</a></h4>
<p>倘若一定要走 non-HTTP/HTTPS 的服務，又想要有類似於使用 <code>Service Type: LoadBalancer</code>，那可以考慮使用 IngressIP 來做使用，<a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></p>
<p>可以做成下面的效果</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>openshift-ingress
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>NAME<span class="w">                      </span>TYPE<span class="w">           </span>CLUSTER-IP<span class="w">      </span>EXTERNAL-IP<span class="w">      </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">                      </span>AGE
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>router-default<span class="w">            </span>LoadBalancer<span class="w">   </span><span class="m">172</span>.30.16.119<span class="w">   </span><span class="m">52</span>.230.228.163<span class="w">   </span><span class="m">80</span>:30745/TCP,443:32561/TCP<span class="w">   </span>2d6h
</code></pre></div>
<h3 id="summary"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#summary">Summary</a></h3>
<p>在 OpenShift 的環境之下</p>
<ol>
<li>對於 http/https 的服務，對外透過 Ingress Controller: OpenShift Router 揭露 FQDN 讓外面使用</li>
<li>對於非 http/https 的服務，如 mysql，有下列兩種做法:</li>
<li>若不需要提供對外服務，僅使用 <code>ClusterIP</code> 在內部進行使用</li>
<li>若需要提供對外服務，有下列三種做法:<ol>
<li>Single Instance，不需要在多個 node 上面運行，使用 <code>hostnetwork</code> 或 <code>hostPort</code></li>
<li>Multiple Instance，需要在多個 node 上面運行，做到 scale-out 的效果，則使用 <code>ingress IP</code> 為佳</li>
</ol>
</li>
</ol>
<h3 id="references"><a class="toclink" href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/#references">References</a></h3>
<ul>
<li><a href="https://blog.csdn.net/huqigang/article/details/76428017">kubernetes学习记录（3）——集群外部访问Pod或Service</a></li>
<li><a href="https://www.slideshare.net/erhwenkuo/cncf-k8snetworkpart1/erhwenkuo/cncf-k8snetworkpart1">Kubernetes 網路是如何運作? Part 1- Erhwen Kuo</a></li>
<li><a href="https://www.slideshare.net/erhwenkuo/cncf-k8snetwork02-137938815">Kubernetes 網路是如何運作? Part 2- Erhwen Kuo</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/accessing-kubernetes-pods-from-outside-of-the-cluster.html">从外部访问Kubernetes中的Pod - JimmySong</a></li>
<li><a href="http://alesnosek.com/blog/2017/02/14/accessing-kubernetes-pods-from-outside-of-the-cluster/">Accessing Kubernetes Pods from Outside of the Cluster</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/install_config/router/index.html">Router Overview - OpenShift v3.11 Docs</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1101219">深度理解：Openshift端口方式全解析 - 大衛分享</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1375943">OpenShift 网络分析-(容器网络选型和方案建议) - 大衛分享</a></li>
<li><a href="http://v1.uncontained.io/playbooks/operationalizing/ingress.html">Using Ingress to Expose Services</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2019/03/21/%E5%BE%9E-red-hat-openshift-%E5%A4%96%E9%83%A8%E8%A8%AA%E5%95%8F-services-%E6%88%96-pods/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../3/">3</a> <a class="md-pagination__link" href="../4/">4</a> <span class="md-pagination__current">5</span>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>