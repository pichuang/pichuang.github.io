
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/author/url/page/3/">
      
      
        <link rel="prev" href="../../../..">
      
      
        <link rel="next" href="../../../../category/automation/">
      
      
        
      
      
      <link rel="icon" href="../../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>Phil Huang - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#phil-huang" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel 🎥 </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Phil Huang
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" checked>
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kubernetes-app" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何科學地估算 Kubernetes 所需的資源? App 角度篇
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2020" class="md-nav__link">
    <span class="md-ellipsis">
      
        2020 年度個人回顧
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes API 服務及跟各組件的交互關係
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespace-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何條列出單一 Namespace 內的 Kubernetes 計算資源?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes 部署在虛機好還是裸機好?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-4-etcd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之二
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-4-etcd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-pod-container" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift Pod 與 Container 的愛恨情仇
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift-rbac" class="md-nav__link">
    <span class="md-ellipsis">
      
        Red Hat OpenShift RBAC 最小權限實踐
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#red-hat-openshift" class="md-nav__link">
    <span class="md-ellipsis">
      
        當安裝完 Red Hat OpenShift 之後...
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="phil-huang">Phil Huang</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-11-12 00:00:00">November 12, 2021</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-app"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/">如何科學地估算 Kubernetes 所需的資源? App 角度篇</a></h2>
<p>今年 2021 小弟上半年過度忙碌，加上換球隊打球，再加上有點遇到中年危機，導致發廢文量大幅下降，請大家多多擔待</p>
<blockquote>
<p>地上爬的我：算 Kubernetes Sizing 好累，我都以為我改行成為 Excel 架構師了呢
天上飛的學長：雲原生服務到底是要 Sizing 什麼 =_= ? 不夠不就給他加下去就對了?
地上爬的我：我們是地端...Q_Q
天上飛的學長：恩...你保重</p>
</blockquote>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#_1">系列文前言</a></h3>
<p>早在本篇開始，其實早在先前 <a href="https://learnk8s.io/kubernetes-instance-calculator">Learnk8s Kubernetes Instance Calculator</a> 已經有推出過一個蠻好看的網頁資源計算機供大家參考，但這個的問題是他沒有考量到多個 Kubernetes Namespace 部署的狀況，畢竟不可能每一個 Pod 的資源都長一樣。其次，地端跟雲端不一樣，前者採購硬體需要事先準備，後者則具備<code>有限的無限資源</code>可供使用，所以只要前者一個估不準就會出事。但身為一名 Ops 人員，我又應該要如何請 App 人員提供數字給你作為參考？</p>
<p>所以為了廣大的鄉民，我提供預估資源資源作法，大概可以解決<code>八成左右</code>的狀況 (其他兩成狀況，請洽業務找我去幫忙算 XD)。故以為了要管理好多個 Kubernetes 叢集需求之下，需要在每一個 Kubernetes 所部署的程式資源 <a href="https://gist.github.com/pichuang/eb50ee49e4cdb64549df335216cc5290">Tanzu Mission Control Extension Manager</a> 的這支程式作為估算範例</p>
<p>主要分為兩個方向夾擊抓資源</p>
<ol>
<li>Top-Down：以 App 角度出發的 Kubernetes Application 資源估算</li>
<li>Bottom-Up：以 Ops 角度出發的 Hardware (or Cloud Provider) 資源估算</li>
</ol>
<h3 id="app-kubernetes-application"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#app-kubernetes-application">以 App 角度出發的 Kubernetes Application 資源估算</a></h3>
<p>想問問大家一個 Kubernetes 要部署一個 Application 會需要什麼東西? 是的，你需要去描述你的應用程式資源和相關資訊，並且部署在特定的 Kubernetes Namespace，如 <code>vmware-system-tmc</code>，所以身為一個 App 人員的目標就是把 <code>基於 namespace 為主的內部所需資源條列出來</code>，擷取 <a href="https://gist.github.com/pichuang/eb50ee49e4cdb64549df335216cc5290#file-sample-tmc-deployment-yaml-L880-L957">Tanzu Mission Control Extension Manager L880-L957</a> 內容，如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nt">tmc.cloud.vmware.com/orphan-resource</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="nt">tmc-extension-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="nt">tmc.cloud.vmware.com/managed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;vmware-system-tmc&#39;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">      </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">      </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">      </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100%</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">        </span><span class="nt">control-plane</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">        </span><span class="nt">controller-tools.k8s.io</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">        </span><span class="nt">tmc-extension</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">        </span><span class="nt">tmc-extension-name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/os</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beta.kubernetes.io/os</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/manager</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;extensions.vmware-cloud.tmc.cloud.vmware.com/extensions/extension-manager/extension-manager@sha256:&#39;</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9876</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webhook-server</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256Mi</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128Mi</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="w">          </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a><span class="w">          </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extension-manager</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</code></pre></div>
<p>對於 Kubernetes Application 資源估算你應該要關心以下幾個點</p>
<ol>
<li>kind 的類型：主要先以可涵蓋大部分部署場景為主，常見有 3 大 Kind，Deployment、StatefulSet、DaemonSet，如本範例為例 <code>kind: Deployment</code></li>
<li>spec.replicas 的數字：主要是要確認待會下面的 CPU / Memory 是要乘上多少，常見應該都是以 <code>1</code> 為主，至於為什麼可參閱我於 <a href="https://speakerdeck.com/pichuang/20210812-ru-he-cai-yong-yun-yuan-sheng-zuo-fa-velero-bei-fen-huan-yuan-ni-de-kubernetes-cong-ji?slide=8">之前在 Microsoft DevDays 2021 演講的內容</a>，如果微服務能夠 Scale-Out 的話，就是 <code>2</code> 或以上的數字</li>
<li>每一個 Pod 所需要的 CPU 和 Memory 資源：主要是確定一個 Container 所需要的 CPU 及 Memory 的上下限，要留意 <code>1 個 Pod 裡面會有 1 個或多個 Containers</code>，可詳閱<a href="https://speakerdeck.com/pichuang/how-do-i-troubleshooting-on-container-more-than-docker?slide=17">之前在 HKOSCon 2020 演講內容</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        resources:
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>          limits:
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>            cpu: 100m
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>            memory: 256Mi
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>          requests:
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>            cpu: 100m
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>            memory: 128Mi
</code></pre></div></li>
<li>Storage 的選型：主要是要確定是要透過 hostPath 肚子的硬碟還是使用 PV/PVC 採用基於 CSI 介面的外掛儲存服務，常用協定如 NFS、iSCSI 及 FC 等，這個主要都是以服務對於 IOPS 或其特性的考量為採用標的，但本文不深入探究</li>
</ol>
<p>所以把上面的資訊收集起來，會得到下面這張表</p>
<p><img alt="" src="/images/tmc-res.png" /></p>
<p>但實際上你填完，會注意到一些事情</p>
<ol>
<li>這樣總資源是對的嗎?</li>
<li>有些欄位沒填的怎麼辦?</li>
</ol>
<p>回應第一題，一定不對，因為你看 <code>Replicas</code> 有些是 2，所以實際上你應該要把左邊的資源全部乘上 <code>Replicas</code> 數字，身為一個 App 團隊你應該會得到下面這張表</p>
<p><img alt="" src="/images/tmc-res-1.png" /></p>
<p>這時候你把全部的資訊撈出來，可以獲得到 <code>大約</code>這支整個程式再怎麼跑，頂多 <code>vmware-system-tmc</code> 這個 namesapce，就是吃掉 <code>4700m</code> CPU 跟 <code>6382M</code> Memory，至於對於 Kubernetes 計算單位不熟的可以參考 <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Kubernetes Managing Resources for Containers</a>，另附上 <a href="https://docs.google.com/spreadsheets/d/1zQswfXuZhpKjsmmFvCHiGt19Ej6s6hpr5yiB1wnPR70/edit?usp=sharing">Google Sheet 參考文件</a></p>
<p>回應第二題，呈上，如果你沒寫資源，這不是代表他運作不用資源，是代表這份 Yaml 沒有定義 limits / requests 兩個數字去限制他的資源使用，而是會用 BestEffort 的方式運行。在這個狀況下，如果真的寫不出來，真的是只能憑經驗先估一個數字給 requests 確保不會爆炸，再來用 Metrics 服務，如自建 Prometheus、或 SaaS 服務 Tanzu Observability 長期觀測調整數字為比較務實的作法。倘若你如果選用的程式是 Java JVM 或者是自帶程式語言虛擬機，會相當好估算，但本文不深入探究</p>
<p>那額外問題來了，如果我在資源裡面填 0 的話會怎樣?</p>
<h3 id="0"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#0">關於 0 的那些事</a></h3>
<blockquote>
<p>先講結論，建議還是要設定 limits 跟 requests 的值上去，最少也要有 limits</p>
</blockquote>
<p>當資源真心不足的時候，則 Kubernetes 則有內建支援 QoS 服務管理能力，且支援作業系統等級的 OOM 控制，最小計算單位為 Pod。<code>一般來說，估算計算資源 limits 比較重要，實際上運行調度則是 requests 比較重要</code></p>
<p>Kubernetes 會開始依據 QoS 三種等級（由最高到最低優先權排序）：Guranted &gt; Bursatable &gt; BestEffort 進行權重排序，通常會發生 OOM (Out-of-Memory) 也都是因為撞到資源不足，然後優先權重又低，就被幹掉了，常見如 AI/ML 容器等會吃資源的容器服務，確切的詳細內容請參閱 <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/quality-service-pod/">Kubernetes - 配置 Pod 的服务质量</a></p>
<table>
<thead>
<tr>
<th style="text-align: center;">優先權</th>
<th style="text-align: center;">QoS 類型</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1 (highest)</td>
<td style="text-align: center;">Guaranted</td>
<td style="text-align: center;">Pod 裡面的每一個 Container 都要設定 requests 等於 limits (兩個值皆有設定，且不等於 0)</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Burstable</td>
<td style="text-align: center;">Pod 裡面的任一個 Container 具有 requests 不等於 limits 數值，且不符合 Guaranted 條件</td>
</tr>
<tr>
<td style="text-align: center;">3 (lowest)</td>
<td style="text-align: center;">BestEffort</td>
<td style="text-align: center;">沒有設定任何資源請求和限制</td>
</tr>
</tbody>
</table>
<p>當然你看完上面應該會霧傻傻，所以身為 Excel 精算師的我幫大家整理了以下列舉了已知組合，供大家參考</p>
<p><img alt="" src="/images/tmc-res-4.png" /></p>
<p>你看完上面的圖應該會知道一個事實，<code>0</code> 在 Kubernetes 來說是有意義的，所以資源估算請不要亂寫，他不代表無限大資源的意思...如果真的不知道請留空，而不是寫 0</p>
<h3 id="app"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#app">以 App 角度出發的常見資源錯估誤區</a></h3>
<p>你是不是覺得到這邊就可以估算結束了？<code>很抱歉沒有</code>，你還少算運行 Kubernetes 所需要的服務，如 kubelet、CNI、kube-proxy、OS 本身服務等等這些不存在於 kubernetes 的資源清單上，但實際上是需要這些服務才能夠好好的運行 Kubernetes 服務，那這是什麼意思呢?</p>
<p>拿房子權狀比喻，以上所做的事情都是在算室內面積（客廳、浴室、陽台），實際上你還有公設（樓梯、電梯、健身房）要算啊！所以最終估算 1 個 Kubernetes 所需資源的結果，一定會比 App 所寫的還要來得大上一點</p>
<p><img alt="" src="https://learnk8s.io/a/5505f01f0ed678a7ac42642b4dfd7b1c.svg" /></p>
<p>而各大廠商為了要降低公設比，紛紛都推出了 Container OS 進行資源和效能上的最佳化，畢竟誰希望拿到 1 個 4c/8g 的 worker 節點，把一堆跟 kubernetes 沒關係的服務開起來就剩不到一半資源可以用，但因為各家出 Container OS 系統都不盡相同，所以會很仰賴各自廠商工程師的精算</p>
<h3 id="_2"><a class="toclink" href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/#_2">結語</a></h3>
<p>看完以上的文章，相信大家一定會覺得為啥我要個 Kubernetes 為啥要搞得這麼複雜，所以下篇會講，<code>以 Ops 角度出發的 Hardware (or Cloud Provider) 資源估算</code>，就是寫不出來的狀況下身為 Ops 到底該怎麼辦？</p>
<p>希望今年能寫得出來...希望...</p>
<p>特別感謝 Gene Kuo 和 Hwchiu 幫忙校稿 XD</p>
    <nav class="md-post__action">
      <a href="../../../../2021/11/12/%E5%A6%82%E4%BD%95%E7%A7%91%E5%AD%B8%E5%9C%B0%E4%BC%B0%E7%AE%97-kubernetes-%E6%89%80%E9%9C%80%E7%9A%84%E8%B3%87%E6%BA%90-app-%E8%A7%92%E5%BA%A6%E7%AF%87/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-12-31 00:00:00">December 31, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2020"><a class="toclink" href="../../../../2020/12/31/2020-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/">2020 年度個人回顧</a></h2>
<p>又一個完整的日曆年過了，來個年度回顧紀錄</p>
<!--more-->

<p>雖然 2020 年是深受疫情滋擾的一年，感覺應該啥事都沒做，但透過回顧，發現我還做了不少事情...</p>
<h3 id="2020_1"><a class="toclink" href="../../../../2020/12/31/2020-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#2020_1">2020 回顧</a></h3>
<ol>
<li>在本年度最後一天去土城當證婚人，我以為結婚要找證婚人是常識 = =</li>
<li>正式工作總年資來到 4y 6m 了，但我覺得好像工作很久了...</li>
<li>在<a href="https://www.linkedin.com/in/phil-huang-09b09895/">Red Hat 精神時光屋度過 2y 8m</a> 了</li>
<li><a href="https://blog.pichuang.com.tw/record/">2020 年度演講 19 場</a>，完成年度兩岸三地演講全成就，包含 2 場香港及中國社群遠端演講，整體比 2019 年還增加 6 場</li>
<li><a href="https://blog.pichuang.com.tw/archives/">2020 年度文章 35 篇</a>，比 2019 年還增加 6 篇，但涵蓋技術廣度明顯不足 QQ</li>
<li><a href="https://speakerdeck.com/pichuang/gong-cheng-shi-de-ni-xi">扎扎實實地減肥 20 公斤</a>，比去年預設目標 1 公斤還多完成 19 公斤，光是這一條成就應該可以有效證明本人做事相當具備強大意志力和執行力 XD</li>
<li>呈上，<a href="https://www.facebook.com/paulintoro/posts/4061098773905144">常言道 ：適度健身吸引異性，過度健身吸引同性</a>，本年度累積被 5 個不認識男性搭訕及 0 個不認識女性搭訕紀錄</li>
<li>拿了一個 <a href="https://www.facebook.com/paulintoro/posts/4038305259517829">Red Hat APAC Office of Technology Team BU Advocates</a> 官方成就回來，雖然跟我目標還有段差距</li>
<li>憑一嘴之力，一年內請了 1+N 個人進 Red Hat，因為我怕被其他廠商抓去圍毆，所以不講數字了</li>
<li>因為疫情關係，創下連續 1 個月沒有進辦公室紀錄，但我居家設備 (雙螢幕、BenQ 檯燈、人體工學電腦椅、升降桌) 比較好，加上沒人吵我（或我沒人可以去吵），所以處理公事效率居然還比較高</li>
<li>2020 下半年因為某些原因度過人生有記憶以來最混沌 3 個月，感謝這段時間陪我度過混沌不明狀態的朋友們和前輩，有你們真好 QQ</li>
<li>今年沒失戀 1 次，也失戀 1 次</li>
<li>拍了人生第 1 次的<a href="https://www.facebook.com/paulintoro/posts/4080957481919273">西裝沙龍照</a></li>
<li>年度放大假去墾丁學了潛水，一次考到 3 張<a href="https://www.instagram.com/p/CHY64ORh-LI/?utm_source=ig_web_copy_link">潛水證照</a>，包含 PADI Open Water Driver、PADI Advanced Open Water Driver、PADI 高氧</li>
<li>連續遠端上課 2 週，然後也在同時連續流感 2 次，差點以為中大標要進大醫院</li>
<li>買了人生第 1 隻<a href="https://www.instagram.com/p/CIX__rFhcPj">機械錶 Hamilton Murph</a>，本人是諾蘭電影粉</li>
<li>去知名的 Gallup 測評了一下個人特質，獲得個人前 5 大主要天賦：<a href="https://lynnihlin.com/portfolio-posts/strategic/">戰略</a>、<a href="https://lynnihlin.com/portfolio-posts/maximizer/">完美</a>、<a href="https://lynnihlin.com/portfolio-posts/%e8%93%8b%e6%b4%9b%e6%99%ae%e5%a4%a9%e8%b3%a6%e4%b8%bb%e9%a1%8c%e8%a7%a3%e8%ae%801%ef%bc%9a%e6%88%90%e5%b0%b1achiever/">成就</a>、<a href="https://lynnihlin.com/portfolio-posts/intellection/">思維</a>、<a href="https://lynnihlin.com/portfolio-posts/positivity/">積極</a>，似乎人資界比較知道這個所代表的意義</li>
<li>榮獲"找死王"稱號</li>
<li>獲得 GitHub 給的 1 個小勛章 <a href="https://github.com/pichuang">Arctic Code Vault Contributor</a>，所以北極的某個土地有我的...遺跡？</li>
<li>以 2020/12/31 當日紀錄為止，2020 年貢獻了 9 個 GitHub Repository</li>
<li>第一次當審稿者，還是本長達 460 頁的英文書 <a href="https://www.facebook.com/paulintoro/posts/3849945331687157">Packt - The Kubernetes Workshop</a></li>
</ol>
<h3 id="2021"><a class="toclink" href="../../../../2020/12/31/2020-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#2021">2021 展望</a></h3>
<ol>
<li>活下去!!! 無論是工作還是生命</li>
<li>挑戰 1 場國外社群演講</li>
<li>瘦這麼多，參加個健美比賽不為過吧</li>
<li>多增加廣度寫點技術文章，明年挑戰個 Windows 跟公有雲系列的好了</li>
<li>希望房價能降下去讓我買個宅窩 QQ</li>
<li>該寫 1 本書了</li>
</ol>
<h3 id="_1"><a class="toclink" href="../../../../2020/12/31/2020-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/#_1">結語</a></h3>
<p>整體時間分配上，今年整體感覺是覺得專業技術略微下降，但多出的時間讓身體變得超級健康，沒因為疫情的關係導致自己的生活裹足不前，勉強可以接受</p>
<p>整體 $$ 分配上，因為疫情的關係導致一堆事情都在家裡做，也加強了一些個人能力 (英文、健身、飲食) 提升的教育訓練，比去年生活更花錢 = =</p>
<p>整體運氣上，今年學到，往後有任何人生難題，都去台北行天宮收個驚，然後抽個籤，快速調整一下心態蠻有效果的，今年人生最混沌的狀態下，抽到了一個<a href="https://www.instagram.com/p/CF4BwsjBUwg/?utm_source=ig_web_copy_link">大吉</a>和<a href="https://www.instagram.com/p/CFHYiNlhYyQ/?utm_source=ig_web_copy_link">上吉</a>的籤，還蠻穩的</p>
<p>下圖應該是本年度代表之作了</p>
<p><img alt="" src="/images/2020-personal-review-2.jpg" /></p>
    <nav class="md-post__action">
      <a href="../../../../2020/12/31/2020-%E5%B9%B4%E5%BA%A6%E5%80%8B%E4%BA%BA%E5%9B%9E%E9%A1%A7/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-09 00:00:00">October 9, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-api"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/">Kubernetes API 服務及跟各組件的交互關係</a></h2>
<p>前陣子客戶那邊有個問題需要先了解 Kubernetes 從部署 Deployment 到實際上跟這些主要組件溝通的流程，不然很難進行 Troubleshooting (a.k.a. 觀落陰)。幸好本次研究有 3 位大大的一起參與 Max、地瓜、喜德，最終找到了一個跟現象毫無關係的根本問題 =_=，但因為過程算蠻難得的，特別記錄下來給大家參考參考</p>
<p>照例講個雜事，Red Hat OpenShift 4.6 (等同 Kubernetes 1.19) 要出啦！這是一個可以一路用到 <code>2022 年 3 月</code> 的版本，各位 Infra 不用在為了更新和升級落淚了 Q_Q，有興趣者可以參考 <a href="https://speakerdeck.com/redhatopenshift/whats-new-in-openshift-container-platform-4-dot-6">What's New in OpenShift Container Platform 4.6</a></p>
<p><img alt="" src="/images/ocp4-6-eus.png" /></p>
<!--more-->

<p>按照我個人對於 Kubernetes 內部溝通理解，約略分為下列 11 個溝通步驟，當然我知道再更細分的話，還可以分更多步驟出來，但我這圖僅針對 Container 最終能運行為主截止</p>
<p><img alt="" src="/images/kube-api.png" /></p>
<p>如果有時候遇到一些不可知的神祕現象，可以思考一下整個系統，是位在哪一層卡住</p>
<h3 id="kubernetes-deployment"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/#kubernetes-deployment">Kubernetes Deployment 分解動作講解</a></h3>
<ol>
<li>使用者自行撰寫好或透過別人弄好的 <a href="https://k8syaml.com/">Kubernetes YAML Generator</a> 產生 Kubernetes Deployment YAML 檔案，且<a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/access-cluster-api/#%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE-rest-api">通过 Kubernetes API 访问集群</a>一文所列的方式：kubectl / RESTful API / <a href="https://github.com/kubernetes/client-go">client-go</a> / <a href="https://github.com/kubernetes-client/python">kubernetes-client/python</a> 等方式發送到 Kubernetes API Server 宣告進行部署應用程式。這個階段 Kubernetes API Server 會進行依序是 Authentication、Authorization、Admission Control 等驗證和檢查語法，詳細過程可參考 <a href="https://www.oreilly.com/library/view/kubernetes-best-practices/9781492056461/ch17.html">Chapter 17. Admission Control and Authorization</a>。如果都沒有問題的話，將會儲存 Deployment Object 至 etcd cluster</li>
<li>目前為止，Pod 還沒被啟動起來，但 Controller Manager 已經收到來自 Kubernetes API Server 的要求</li>
<li>Controller Manager 會去檢查是否有數量正確的副本 (Replicas) 且對應正確需求的 Pod 已經在運行</li>
<li>如果沒有正確數量的副本正在運行，則會發送基於 Pod Spec 的要求到 Kubernetes API Server 請求建立對應數量的 Pod 起來</li>
<li>Kubernetes API Server 寫入和讀取之前，會先經過兩關 Admission 和 Validation，前者 Admission 透過確認叢集全域設定來檢查是否可以新增或更新 Object，並可能依據叢集設定提供預設值，後者 Validation 則是在新增或更新過程中，來檢查傳入的 Object 是否合法，及是否僅包含有效參數，詳細可參考 <a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-2">Kubernetes Deep Dive: API Server – Part 2</a></li>
<li>Kubernetes API Server 持續會對 etcd 所存放的 Kuberentes Object 進行更新或移除，詳細可參考 <a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-2">Kubernetes Deep Dive: API Server – Part 2</a></li>
<li>雖然 etcd 內部已經存有 Pod 的資訊，但不過僅僅是一條紀錄而已，現實狀況是還沒有分配到 Worker Node 上。這時候 Kubernetes API Server 會通知 Kubernetes Scheduler：目前有新增 Pod 的需求，並且還沒有 Worker Node 可以運行它</li>
<li>Kubernetes Scheduler 會通過程式檢查現行資源使用狀況以及現有的 Pod 的分配，然後去計算出最適合擺放每ㄧ個新 Pod 的 Worker Node 位置。當決定出來之後，Kubernetes Scheduler 將會設定每一個 Pod 裡面的 <code>spec.nodeName</code>，將其轉換成 Worker Node 名稱 ，並將最終決定通知至 Kubernetes API Server 進行更新請求</li>
<li>直至本步驟為止，Pod 已經知道它應該要在哪一個 Worker Node 上面運行，但將通知位於需被分配的 Worker Node 上的 kubelet，並指示這些來自於 Kubernetes API Server 的新增 Pod 請求都應該要被 Kubelet 被遵照執行。然而，該 Worker Node 節點上的 Kubelet 將檢查自身是否已經將要運行的 Pod 運行起來。</li>
<li>一但 Kubelet 確定 Pod 應該要運行於該節點上之後，就會呼叫 High-Level Contianer Runtime (如: Docker、Containerd、CRI-O 等) 已啟動容器 (Container)。當一切都準備好之後，kubelet 會將其狀態報告回傳至 Kubernetes API Server</li>
<li>接下來就是依據 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">Pod Lifecycle - Kubernetes</a> 所述，建立 infra (pause) container 後，開始將Pod Spec 所要求的 Container 一個一個拉取並且啟動，並且與 Kube-proxy 協作將服務轉發出去</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/#qa">Q&amp;A</a></h3>
<h4 id="high-level-container-runtime-low-level-container-runtime"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/#high-level-container-runtime-low-level-container-runtime">High-Level Container Runtime 跟 Low-Level Container Runtime 差異是啥?</a></h4>
<p>Low-Level Container Runtime 主要專職運行容器或其特定環境，實際專案如，常見於各大專案的 runc 或者是 crun、runv 等，詳細可參考 <a href="https://github.com/opencontainers/runtime-spec/blob/master/implementations.md">opencontainers / runtime-spec - implementations.md</a></p>
<p>High-Level Container Runtime 主要負責管理各式容器映像檔以及負責跟 Low-Level Container Runtime 管理跟溝通，本身不處理實際運行容器的事情，一般都會有一個 Daemon 和 API 可以去監控底層狀態，譬如說 OpenShift 4 之後所使用的 CRI-O 或者是更多人比較知道 Dockerd 跟被拆分出來的 containerd 都同屬這類</p>
<h3 id="_1"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/#_1">文後感謝</a></h3>
<p>感謝地瓜、Davy 兩位大大的半夜協助和毫不知情照片被我拿來用的 <a href="https://www.hwchiu.com/">hwchiu</a></p>
<h3 id="references"><a class="toclink" href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/#references">References</a></h3>
<ul>
<li><a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-1">Kubernetes deep dive: API Server - part 1</a></li>
<li><a href="https://medium.com/@michalswi/introduction-to-kubernetes-api-the-way-to-understand-the-concept-of-kubernetes-operators-ed667385caf4">Introduction to Kubernetes API - the way to understand the concept of Kubernetes Operators.</a></li>
<li><a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-2">Kubernetes Deep Dive: API Server – Part 2</a></li>
<li><a href="https://k8syaml.com/">Kubernetes YAML Generator - Powered by Octopus.</a></li>
<li><a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/access-cluster-api/#%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE-rest-api">通过 Kubernetes API 访问集群</a></li>
<li><a href="https://github.com/kubernetes/client-go">kubernetes/client-go</a></li>
<li><a href="https://github.com/kubernetes-client/python">kubernetes-client/python</a></li>
<li><a href="https://www.oreilly.com/library/view/kubernetes-best-practices/9781492056461/ch17.html">Chapter 17. Admission Control and Authorization</a></li>
<li><a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-2">Kubernetes Deep Dive: API Server – Part 2</a></li>
<li><a href="https://developers.redhat.com/blog/2019/01/15/podman-managing-containers-pods">Podman: Managing pods and containers in a local container runtime</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">Pod Lifecycle - Kubernetes</a></li>
<li><a href="https://speakerdeck.com/redhatopenshift/whats-new-in-openshift-container-platform-4-dot-6">What's New in OpenShift Container Platform 4.6</a></li>
<li><a href="https://github.com/opencontainers/runtime-spec/blob/master/implementations.md">opencontainers / runtime-spec - implementations.md</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/10/09/kubernetes-api-%E6%9C%8D%E5%8B%99%E5%8F%8A%E8%B7%9F%E5%90%84%E7%B5%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92%E9%97%9C%E4%BF%82/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-28 00:00:00">August 28, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="namespace-kubernetes"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/">如何條列出單一 Namespace 內的 Kubernetes 計算資源?</a></h2>
<p>最近這一個月出了一些事，導致太久沒寫廢文。最近有個需求需要<code>逆向</code>研究出 Red Hat OpenShift 4 原生安裝後，它預設安裝一堆的 Namespace (在 OpenShift 稱作 Project，但在這邊可以視為一樣)，各自的 CPU / Memory / Storage 資源消耗多少，身為一位計算資源精算師，所以就有了下面這篇的紀錄</p>
<p>本月無心力，無梗圖呈現</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#_1">為什麼要這樣做?</a></h3>
<p>這件事跟 Kubernetes 計算資源估算有關係，基於<a href="https://blog.pichuang.com.tw/20200713-bm-and-vm-container-deployment-consideration/#Kubernetes-%E8%B3%87%E6%BA%90%E4%BC%B0%E7%AE%97%E6%96%B9%E5%BC%8F">前一篇</a>所提到的 <code>Kubernetes 資源估算方式</code>，若把實機或虛機的完整可用資源當作一個玻璃杯來看，若有服務需要使用 Kubernetes 計算資源的話，則視為往玻璃杯倒水進去，當水位滿的時候，就代表該實機或虛機不能在擺放其他的服務了，當水位比較低的時候，則代表可以較有餘裕放置其他服務在裡面</p>
<p><img alt="" src="/images/glass.png" /></p>
<h3 id="kubectl-view-allocations"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#kubectl-view-allocations">Kubectl-view-allocations</a></h3>
<p>這邊要推薦 <a href="https://github.com/davidB/kubectl-view-allocations">davidB/kubectl-view-allocations</a> 這個專案，相當好用，之前還沒找到這個專案之前，我都是用 <code>jsonpath</code> 慢慢爬，但我覺得不僅指令相當長 (如下指令)，而且輸出結果<a href="https://gist.github.com/pichuang/59c42de25991c516909c4736caa7893d">不明確</a>，加上很難閱讀，所以才又另外找了一下這個專案來用用</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{range .items[]}{range .spec.containers[]} {.name} CPU_Requests:{.resources.requests.cpu} CPU_Limites:{.resources.limits.cpu} Memory_Requests:{.resources.requests.memory} Memory_Limites:{.resources.limits.memory} {&#39;\n&#39;}{end}{&#39;\n&#39;}{end}&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>column<span class="w"> </span>-t
</code></pre></div>
<h4 id="kubectl-view-allocations_1"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#kubectl-view-allocations_1">超簡單安裝 Kubectl-view-allocations</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>curl<span class="w"> </span>https://raw.githubusercontent.com/davidB/kubectl-view-allocations/master/scripts/getLatest.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>sudo<span class="w"> </span>mv<span class="w"> </span>kubectl-view-allocations<span class="w"> </span>/usr/local/bin
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>kubectl-view-allocations<span class="w"> </span>-V
</code></pre></div>
<h3 id="use-cases"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#use-cases">Use Cases</a></h3>
<h4 id="namespace"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#namespace">條列 Namespace 內資源</a></h4>
<p>譬如說我想要查 <code>openshift-etcd</code> 裡面的資源預設消耗如何，可以用下列指令辦到</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>kubectl-view-allocations<span class="w"> </span>-n<span class="w"> </span>openshift-etcd
</code></pre></div>
<p><img alt="" src="/images/show-openshift-etcd.png" /></p>
<h4 id="_2"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#_2">概觀了解各節點資源</a></h4>
<p>類同於 <code>oc adm top node</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>kubectl-view-allocations<span class="w"> </span>-r<span class="w"> </span>cpu<span class="w"> </span>-g<span class="w"> </span>node
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>kubectl-view-allocations<span class="w"> </span>-r<span class="w"> </span>memory<span class="w"> </span>-g<span class="w"> </span>node
</code></pre></div>
<p><img alt="" src="/images/show-node-cpu-mem.png" /></p>
<h4 id="_3"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#_3">詳細了解各節點資源</a></h4>
<p>當你想要了解你的 master node 上面到底都放了什麼碗糕的東西，這個還蠻好用的...</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>kubectl-view-allocations<span class="w"> </span>-r<span class="w"> </span>cpu
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>kubectl-view-allocations<span class="w"> </span>-r<span class="w"> </span>memory
</code></pre></div>
<p><img alt="" src="/images/show-node-memory-details.png" /></p>
<h3 id="appendix"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#appendix">Appendix</a></h3>
<h4 id="environment-information"><a class="toclink" href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/#environment-information">Environment Information</a></h4>
<ul>
<li>Red Hat OpenShift 4.4.0</li>
<li>Kubernetes v1.18.3</li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/08/28/%E5%A6%82%E4%BD%95%E6%A2%9D%E5%88%97%E5%87%BA%E5%96%AE%E4%B8%80-namespace-%E5%85%A7%E7%9A%84-kubernetes-%E8%A8%88%E7%AE%97%E8%B3%87%E6%BA%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-07-13 00:00:00">July 13, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/">Kubernetes 部署在虛機好還是裸機好?</a></h2>
<p>這幾週常被問到一個問題</p>
<blockquote>
<p>以技術觀點來看，請問容器 (Container) 或者是容器平台 (Kubernetes) 比較適合部署在虛擬環境 (VM) 中還是裸機環境中 (Bare Metal)?</p>
</blockquote>
<p><img alt="" src="/images/vm-vs-bm.jpg" /></p>
<p>其實這個問題在十年前虛擬機技術剛出來的時候，也蠻多人做過架構及性能比較，時光快轉到現在的年代，來到容器的世代，相同的問題也被拿出來討論，本篇就是要特別講述一下關於這些架構上的比較分析、使用影響及建議採用的策略作法建議，這篇會採用比較中立的角度闡述，如果有觀點太偏頗的地方，可以私下跟我說及提供修改建議</p>
<p>不免俗的我還是要來講一下本次新發現，三個感覺不會同框的公司 Microsoft + Red Hat + HPE 一起出了本架構書 <a href="https://h20195.www2.hpe.com/V2/GetDocument.aspx?docname=a50001963enw">HPE Reference Architecture for delivering insight across all your data with Microsoft SQL Server 2019 Big Data Clusters</a> 我覺得實在太玄了 XD 分享給大家</p>
<!--more-->

<h3 id="4"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#4">4 個先備小知識</a></h3>
<p>在討論架構上的優劣之前，要先跟各位清楚地解釋這些架構的實際長相是有哪一些</p>
<h4 id="containers-are-linux"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#containers-are-linux">Containers are Linux</a></h4>
<blockquote>
<p>A linux container is nothing more than a process that runs on Linux</p>
</blockquote>
<p><img alt="" src="/images/container-performance.png" /></p>
<p>一開始要先對容器 (Container) 進行名詞說明，其實這個容器這個技術沒什麼特別的黑魔法，也不是相當前衛的東西，技術本質上就是一個或多個 Linux Process 的呈現，是的！你過往使用的 chroot / LXC / Jail 皆屬這類，所以你過往能對 Linux Process 進行一些深度控制的方式，譬如像是 secomp、cgroups、selinux 等操作，都能在 Container 裡面呈現，更甚至是常見的 Linux Performance Obsevability Tools 效能量測工具，也可以使用，實務上可以參考 <a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot - a Docker + Kubernetes network trouble-shooting swiss-army container</a></p>
<p>基於以上的理由，所以有時候你會看到下列幾種說法</p>
<ul>
<li>Container Security is Linux Security</li>
<li>Container Performance is Linux Performance</li>
<li>Container Reliability is Linux Reliability</li>
</ul>
<p><img alt="" src="/images/linux-arch.png" /></p>
<p>結論就是，你的容器穩不穩定、安不安全跟你所使用的作業系統其實是有 100% 的關係</p>
<h4 id="kubernetes-is-a-container-orchestration-platform"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#kubernetes-is-a-container-orchestration-platform">Kubernetes is a Container Orchestration Platform</a></h4>
<p><img alt="" src="/images/k8s-arch.png" /></p>
<blockquote>
<p>Kubernetes (K8s) is an open-source system for automating deployment, scaling, and management of containerized applications.</p>
</blockquote>
<p>從 <a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/">What is Kubernetes?</a> 可知，應用程式透過容器部署方式所帶來的優勢，具備輕量級資源隔離方式、可共用作業系統及資源可高效率及密集使用等眾多好處，但當我的 Container 數量一多，服務變得更大更多的時候，誰能負責幫這些 Container 找到一個適合的地方運行、持續的監控及故障處理? 所以這時候你會需要一個<code>負責管理容器運行的控制平台</code>，也就是現今最熱門的 Kubernetes。</p>
<p>Kubernetes 容器平台內建多種協助管理容器的機制，包含但不限於：</p>
<ol>
<li>內部服務發現和負載均衡</li>
<li>提出統一且標準的聲明式 (Declarative) API：這點應該是 Kubernetes 誕生後，對於整個 IT 界最大的影響了，有興趣想了解更多的可以參考此文 <a href="https://yq.aliyun.com/articles/713012">云原生时代， Kubernetes 多集群架构初探</a>，這篇真的寫得不錯</li>
<li>內建自我修復容器能力：承上，Kubernetes 中的聲明式 API 其實就是<em>指定該叢集所期望的運行狀態</em>，所以出現任何不一致的狀態的時候，Kubernetes 可以自行透過指定的 YAML 文件描述，來進行狀態遷移，作出合適於當下環境的操作</li>
<li>易於資源橫向擴充：以 Kubernetes 的角度進行的容器編排，已經將上層服務跟底層基礎設施脫離掛鉤，IT 人員僅需關心 Kuerbernets 所準備的資源夠不夠上層服務使用，進而形成一個資源池 (Resource Pool) 的觀念，包含 CPU Pool / Memory Pool / Storage Pool</li>
<li>可跨裸機、虛擬環境、公私有雲上使用：其實這個真正的理由是因為作業系統的關係，因為 Kubernetes 的運作是基於在作業系統之上，所以只要確保能在作業系統能在任一環境啟動即可使用</li>
</ol>
<p>而要讓 Kubernetes 控制平台有這些能力必然會需要另外安裝一些所需要的軟體，譬如說每一個 Worker 必然會需要安裝的作業系統、kubelet、CNI 網路套件等一些常駐軟體，所以一般來講最終能供應用程式所使用的資源不全然是等同於外面的規格，所以針對 Kubernetes 平台建置才會有一種趨勢是<code>作業系統盡量精簡到僅需可以乘載容器運作即可，其他多餘的都可以拿掉，以達到最大資源利用率</code>，進而誕生各式各樣的<code>容器作業系統 (Container OS)</code> 供大家選擇使用</p>
<p>若想要了解 CPU 和 Memory 的資源配置方式可以參考圖文並茂的 <a href="https://learnk8s.io/allocatable-resources">Allocatable memory and CPU in Kubernetes Nodes - learnk8s</a></p>
<h4 id="container-pod-kubernetes"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#container-pod-kubernetes">Container 跟 Pod 跟 Kubernetes 的關係</a></h4>
<p><img alt="" src="/images/container-pod-k8s.png" /></p>
<p>首先是，Pod 跟 Kubernetes</p>
<blockquote>
<p>Pods are the smallest deployable units in Kubernetes</p>
</blockquote>
<p>在 Kubernetes 的世界裡，最小調度單位是 <code>Pod</code>，而不是 Container，這點相當重要，所以我們所知道的資源調度及應用程式複製，全部都是以 Pod 為角度思考而不是以單ㄧ Container 為主，那有人就會問那 Container 跟 Pods 的關係又是什麼?</p>
<blockquote>
<p>A Pod is a group of one of more containers with shared storage and network</p>
</blockquote>
<p>在 Kubernetes 所定義最小單位 <code>Pod</code> 當中，可以<code>存在 1 個或多個</code>的 Container 運行在其中，並且共通分享同一個 Linux Namespace 所提供的資源，只要在同一個 Pod 裡面內，Container 互相的資源皆可以被存取，然而這些 Container 才是實際上包裝應用程式後所呈現的樣態，運行的環境毫不懷疑地就是跑在作業系統上面</p>
<p>有些人會很好奇為什麼很多時候都會把 Pod 跟 Container 混在一起描述呢? 這是因為絕大部分的實作，一個 Pod 裡面僅會放置一個 Container 在裡面，所以才會有這種錯覺產生</p>
<h4 id="kubernetes_1"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#kubernetes_1">Kubernetes 資源估算方式</a></h4>
<p>根據 <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Managing Resources for Containers - Kubernetes</a>，你會知道其所定義的 Resource Type 主要有下列兩個：</p>
<ol>
<li>CPU</li>
<li>Memory</li>
</ol>
<blockquote>
<p>One cpu, in Kubernetes, is equivalent to 1 vCPU/Core for cloud providers and 1 hyperthread on bare-metal Intel processors.</p>
</blockquote>
<p>前者 CPU 的換算方式，就是 <code>1 CPU = 1 Core = 1,000 millicores = 1,000m</code>，是採用<code>絕對數量</code>來進行計算，Kubernetes 要求 0.1 Core 就是需要完完整整的 0.1 Core，無論底下 CPU 是 Single Core、Dual-Core、32 Core 機器，還是透過 CPU Overcommitment 調整後，且 Kubernetes 計算資源時也無視時脈頻率 (clock rate) 的差異，下列特別列舉出所有跟 Kubernetes 1 CPU 所等價的資源清單，然而一般做 CPU 資源計算的時候都會以 vCPU 角度進行計算</p>
<table>
<thead>
<tr>
<th>1 Kubernetes CPU is equivalent to</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 Hyperthread on a bare-metal Intel processor with Hyperthreading</td>
</tr>
<tr>
<td>1 vSphere CPU</td>
</tr>
<tr>
<td>1 IBM vCPU</td>
</tr>
<tr>
<td>1 Azure vCore</td>
</tr>
<tr>
<td>1 GCP Core</td>
</tr>
<tr>
<td>1 AWS vCPU</td>
</tr>
<tr>
<td>1 Non-HT CPU</td>
</tr>
</tbody>
</table>
<p>後者 Memory 的計算方式，可以使用二進位表示或者是十進位表示，例如下列 3 個數值是等價關係：</p>
<blockquote>
<p>128974848 = 123 Mi (power of 2) = 129 M (power of 10)</p>
</blockquote>
<p>另外它也是採用<code>絕對數量</code>來進行計算，無論你底下是實體記憶體還是虛擬記憶體，或者是有經 VMM 平台所提供的 Memory overcommitment 能力擴張後的數字，一般很少遇到這類問題是因為大多數的人的記憶體用法都是 1:1 進行使用，然而做 Memory 資源計算的時候，建議都以 vRAM 角度進行計算</p>
<table>
<thead>
<tr>
<th>1 Kubernetes memory is equivalent to</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 physical RAM</td>
</tr>
<tr>
<td>1 virtual RAM</td>
</tr>
</tbody>
</table>
<h3 id="_1"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_1">容器部署在虛擬環境好還是實體環境好?</a></h3>
<p>若你有認真把上面的 4 個先備小知識看完之後，理應會有下列結論</p>
<ol>
<li>容器必然會運行於作業系統之上</li>
<li>Kubernetes 的運行是建立於作業系統之上，其本身還是需要消耗一定的資源運作</li>
<li>Kubernetes 對於資源的利用是無視虛擬環境、實體環境</li>
</ol>
<p>首先先把所有常見環境架構擺在一起，包含下列 4 種：</p>
<p><img alt="" src="/images/4-compare.png" /></p>
<ol>
<li>Bare Metal</li>
<li><code>Container on Bare Metal</code></li>
<li>VM on Bare Metal</li>
<li><code>Container on VM on Bare Metal</code></li>
</ol>
<p>當中 2、Container on Bare Metal 跟 4、Container on VM on Bare Metal 是本文需要討論的架構，一般需要考量容器是否要不要放在虛擬環境和實體環境，會有以下 5 大考量點</p>
<ol>
<li>管理性</li>
<li>資源隔離性</li>
<li>運算效能</li>
<li>是否具備特殊硬體</li>
<li>整體擁有成本</li>
</ol>
<h4 id="_2"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_2">管理性</a></h4>
<p><img alt="" src="/images/pets-cattle.jpeg" /></p>
<p>如果你是虛擬機環境使用為主的維運人員，就角度上來說，Kubernetes 就是一群 VM 所組成的，所以既有的 VM 管理方式或功能還是可以直接使用，譬如說 Overcommitment、Snapshot、虛擬網路卡新修刪、Migration，但這些功能對於 Kubernetes 本身運作來講並不是必要的選項，歸屬於技術可以實現但並不是必要的類別，比較常見的討論就是在 VM Migration 能力需要與否，以 Kubernetes 來講，透過內建的 Self Healing 或者是 Node Selector 的做法，可以輕易的辦到跨節點運行相同程式的需求</p>
<p>倘若是以裸機環境為主的維運人員，因為裸機上面直接套用作業系統，可以相當無腦地加入全機資源轉換成 Worker Node 提供給 Kubernetes 加入當中的計算資源池內使用，且所有管理操作皆由 Kubernetes 控制節點統一管理，相對來說減少了所需管理的層數，可以透過較少的硬體來運行相同數量的容器</p>
<p>結論是，如果你想要沿用既有虛擬環境的管理優勢，而不考慮優先使用 Kubernetes 內建管理機制，部署容器至虛擬環境是比較好的選擇；反之，你想要完全使用 Kubernetes 內建所帶來的管理機制，部署容器至裸機環境是最佳選</p>
<h4 id="_3"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_3">資源隔離性</a></h4>
<p><img alt="" src="/images/container-vm-isolation.png" /></p>
<p>無論是 VM 及 Container 其實皆有提供資源隔離能力給應用程式，只是技術角度不一樣。</p>
<p>若是以裸機環境來說，因為整台機器資源及控制權都交給了 Host OS，所以作業系統的安全性會直接影響到底層硬體的安全性與否，同時再搭配上 Container 本身自帶的資源隔離命名空間 - Linux Namespaces 及其相關的控制能力 seccomp、selinux、cgroups 等提供 <code>Linux Process 級別</code>之輕量級資源隔離</p>
<p>以虛擬環境 VMM Type 1 的架構為主，虛擬機具備完整的作業系統，包含記憶體管理和虛擬設備驅動程式，主要於<code>虛擬機級別</code>提供隔離能力，並為 Guest OS 提供擬真資源，可以阻止虛擬機執行可能損害主機平台完整性的指令，這種架構想當然而是對主機資源需要有較大的要求，來進行全虛擬化的保護，同時間也採用了 Container 本身所帶來的資源隔離能力，做到雙重隔離</p>
<p><img alt="" src="/images/vm-coontainer.png" /></p>
<p>結論是，倘若你單台設備有需要跟別的單位共用工作負載且作為不同用途的話，且並非是可以透過輕量級隔離能力可以辦到的資源隔離，那使用虛擬環境是比較好的選擇，反之，你是專門想要提供某個服務或某個部門，並未有共用其他工作覆載議題的話，裸機環境基本上是最佳選擇</p>
<h4 id="_4"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_4">運算效能</a></h4>
<p><img alt="" src="/images/vm-bm-latency.png" /></p>
<blockquote>
<p>Performance: Native &gt; Container &gt; VM</p>
</blockquote>
<p>其實這個不用特別討論也可以理解到，裸機整體效能會比虛擬環境好，畢竟裸機全部的資源都拿來使用，針對網路的部分，這篇文章 <a href="https://www.ctl.io/developers/blog/post/kubernetes-bare-metal-servers">Kubernetes on Bare Metal: When Low Network Latency is Key</a>，表明 Network Latency 差距是 3 倍左右，CPU 利用率差距大概是 10% - 15% 左右</p>
<p>有人會問說一般的 Kubernetes 壓力測試平時都是在什麼環境壓的? 答案是主要是在三大公有雲上的環境，因為計算資源公有雲都準備好了，主要測試也會以這些公有雲的環境為主，有趣的事情是三大雲所提供的環境雖然都是相同的量級的 CPU / Memory，但端看測試的時候會有效能上的顯著差異</p>
<h4 id="_5"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_5">具備特殊硬體</a></h4>
<p><img alt="" src="/images/pci-passthough.gif" /></p>
<p>倘若你是需要運行 GPU / SR-IOV NIC 或者是其他需要高性能運算或對實體網卡有特殊要求的，建議一律就是選擇裸機部署路線了，雖然虛擬環境可以透過 PCI Passthough 進行穿透使用，但現行於 Kubernetes 的使用上大多還是直接裸機環境使用，除了管理方便以外，其次的原因是通常會裝載特殊硬體，所需要的計算資源也是相當大的，大部分常見於醫療、製造、電信等對計算需求相對大的領域</p>
<h4 id="tco"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#tco">整體擁有成本 (TCO)</a></h4>
<p>從 <a href="https://climbcsblog.com/2019/03/11/five-reasons-you-should-run-containers-on-bare-metal-not-vms/">Five Reasons You Should Run Containers on Bare Metal, not Virtual Machines</a> 借圖</p>
<p><img alt="" src="/images/tco.png" /></p>
<blockquote>
<p>伺服器所能提供的資源上限就是完全依據硬體規格所提供的，並不會多也不會少</p>
</blockquote>
<p>於虛擬環境中，需要先扣除掉 Host OS + 運行 VMM Hypervisor Type 1 所需資源 + Guest OS 這三大計算資源之後，剩下的才是可用計算資源，按照 <a href="https://blogs.vmware.com/apps/files/2019/11/Best-Practices-for-Red-Hat-OpenShift-on-the-VMware-SDDC-Final01.pdf">Best Practices for Red Hat OpenShift on the VMware SDDC - VMware</a> 所述，約略會需要先<code>保留 15%</code>的資源供虛擬環境平台使用；而於裸機環境中，則僅需扣除掉 Host OS 的運作資源即可，可以用最大幅度可用計算資源去運行服務，正常狀況之下，每台伺服器能運行的容器數量，裸機環境會比虛擬環境來的還要高，也意味著更高的利用率、更低的功耗和更低的成本、近一步降低管理費用</p>
<p>基於虛擬環境的容器部署上，最多的成本考慮因素是虛擬化軟體所附帶的成本費用，稱作 vTAX，通常部署上會連帶產生為數可觀的費用，進而增加總體擁有成本</p>
<p>結論是，倘若你想要有最高的 C/P 值的話，底層硬體完全提供給容器運行的話，裸機環境部署是最佳選項，其次才是虛擬環境為主</p>
<h3 id="_6"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#_6">結語</a></h3>
<p>最近蠻多公司都在推廣 Kubernetes on Bare Metal 的架構，來獲得的資源最大使用效率、最低 TCO、最好效能、管理單純等好處，倘若今天有考慮要建立一個基於 Kubernetes 為主的私有雲服務，那的確是一個蠻好的選擇；倘若是要跟既有的環境混用或者是因既有管理需求等因素，則可以考慮以 VM 為主的 Kubernetes 服務；當然還有一種選擇是<code>混用</code>，我個人是比較推崇這種架構，依據情境不同提供不同資源，盡可能的有效利用各架構的優勢截長補短</p>
<p><img alt="" src="/images/vmware-vs-k8s.png" /></p>
<p>現實生活中，大部分的人還是會詢問說，VMware 跟 Kubernetes 的架構差異是什麼，我覺得 VMware 這篇比較文章寫得不錯 <a href="https://blogs.vmware.com/cloudnative/2017/10/25/kubernetes-introduction-vmware-users/">Kubernetes Introduction for VMware Users – Part 1: The Theory</a></p>
<h3 id="references"><a class="toclink" href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/#references">References</a></h3>
<ul>
<li><a href="https://searchservervirtualization.techtarget.com/tip/Bare-metal-vs-VM-container-deployment-considerations">Bare-metal vs. VM container deployment considerations</a></li>
<li><a href="https://climbcsblog.com/2019/03/11/five-reasons-you-should-run-containers-on-bare-metal-not-vms/">Five Reasons You Should Run Containers on Bare Metal, not Virtual Machines</a></li>
<li><a href="https://igene.tw/container-vs-vm#%E4%BD%BF%E7%94%A8%E6%99%82%E6%A9%9F">Container vs VM: When and Why? - Gene</a></li>
<li><a href="https://containerjournal.com/features/better-containers-bare-metal-virtual-machines/">Which is Better for Containers, Bare Metal or Virtual Machines?</a></li>
<li><a href="https://www.scitepress.org/papers/2018/66806/66806.pdf">Comparison Between Bare-metal, Container and VM using Tensorflow Image Classification Benchmarks for Deep Learning Cloud Platform - Paper</a></li>
<li><a href="https://lsalab.cs.nthu.edu.tw/home/publication/CLOSER18.pdf">Comparison Between Bare-metal, Container and VM using Tensorflow Image Classification Benchmarks for Deep Learning Cloud Platform - Slide</a></li>
<li><a href="https://www.openshift.com/blog/containers-are-linux">Containers are Linux</a></li>
<li><a href="https://medium.com/@jessgreb01/what-is-the-difference-between-a-process-a-container-and-a-vm-f36ba0f8a8f7">What is the difference between a process, a container, and a VM?</a></li>
<li><a href="https://github.com/nicolaka/netshoot">nicolaka/netshoot - GitHub</a></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/">What is Kubernetes?</a></li>
<li><a href="https://yq.aliyun.com/articles/713012">云原生时代， Kubernetes 多集群架构初探</a></li>
<li><a href="https://blogs.vmware.com/cloudnative/2017/10/25/kubernetes-introduction-vmware-users/">Kubernetes Introduction for VMware Users – Part 1: The Theory</a></li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Managing Resources for Containers - Kubernetes</a></li>
<li><a href="https://learnk8s.io/allocatable-resources">Allocatable memory and CPU in Kubernetes Nodes - learnk8s</a></li>
<li><a href="https://h20195.www2.hpe.com/V2/GetDocument.aspx?docname=a50001963enw">HPE Reference Architecture for delivering insight across all your data with Microsoft SQL Server 2019 Big Data Clusters</a></li>
<li><a href="https://blogs.vmware.com/apps/files/2019/11/Best-Practices-for-Red-Hat-OpenShift-on-the-VMware-SDDC-Final01.pdf">Best Practices for Red Hat OpenShift on the VMware SDDC - VMware</a></li>
<li><a href="https://www.ctl.io/developers/blog/post/kubernetes-bare-metal-servers">Kubernetes on Bare Metal: When Low Network Latency is Key</a></li>
<li><a href="https://www.dellemc.com/resources/en-us/asset/technical-guides-support-information/solutions/h18212-openshift-container-dpg.pdf">Dell EMC Ready Stack for Red Hat OpenShift Container Platform 4.3</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/07/13/kubernetes-%E9%83%A8%E7%BD%B2%E5%9C%A8%E8%99%9B%E6%A9%9F%E5%A5%BD%E9%82%84%E6%98%AF%E8%A3%B8%E6%A9%9F%E5%A5%BD/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-29 00:00:00">May 29, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/openshift/" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-4-etcd"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之二</a></h2>
<p>承襲上文 <a href="https://blog.pichuang.com.tw/20200528-openshift-etcd-operator-1/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a>，繼續針對硬碟的部分進行調整，畢竟 etcd 對<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/hardware.md#disks">硬碟</a> IOPS 相當要求，建議用 SSD 比較好</p>
<p>沒意外的，開場分享個 <a href="https://www.openshift.com/blog/deploying-openshift-4.4-to-vmware-vsphere-7">Deploying OpenShift 4.4 to VMware vSphere 7</a>，整體上比較重要的是利用 VMware vSphere 7 裡面的 DRS (Dynamic Resource Scheduler) 及 NSX-T 的部分，之後有機會再說</p>
<p>{% youtube PdyNQXpYknI %}</p>
<!--more-->

<h3 id="etcd"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#etcd">etcd 節點硬碟調教</a></h3>
<blockquote>
<p>ionice: set or get process I/O scheduling class and priority</p>
</blockquote>
<p>這邊使用 <a href="https://www.systutorials.com/docs/linux/man/1-ionice/">ionice (1) - Linux Man Pages</a> 來完成這件事，剛好 CoreOS 內建有支援這個指令 XD，差點就要包一個 Container 而且要蠻高的權限 (需要 root) 去定期執行了</p>
<h4 id="before"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#before">Before</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>pgrep<span class="w"> </span>etcd
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="m">740369</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="m">740441</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ps<span class="w"> </span>uax<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="m">740369</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>root<span class="w">      </span><span class="m">740369</span><span class="w">  </span><span class="m">7</span>.6<span class="w">  </span><span class="m">8</span>.4<span class="w"> </span><span class="m">9672968</span><span class="w"> </span><span class="m">1382392</span><span class="w"> </span>?<span class="w">     </span>Ssl<span class="w">  </span><span class="m">17</span>:05<span class="w">   </span><span class="m">4</span>:25<span class="w"> </span>etcd<span class="w"> </span>--initial-advertise-peer-urls<span class="o">=</span>https://10.0.97.3:2380<span class="w"> </span>--cert-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving/etcd-serving-control-plane-2.crt<span class="w"> </span>--key-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving/etcd-serving-control-plane-2.key<span class="w"> </span>--trusted-ca-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/configmaps/etcd-serving-ca/ca-bundle.crt<span class="w"> </span>--client-cert-auth<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--peer-cert-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.crt<span class="w"> </span>--peer-key-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.key<span class="w"> </span>--peer-trusted-ca-file<span class="o">=</span>/etc/kubernetes/static-pod-certs/configmaps/etcd-peer-client-ca/ca-bundle.crt<span class="w"> </span>--peer-client-cert-auth<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--advertise-client-urls<span class="o">=</span>https://10.0.97.3:2379<span class="w"> </span>--listen-client-urls<span class="o">=</span>https://0.0.0.0:2379<span class="w"> </span>--listen-peer-urls<span class="o">=</span>https://0.0.0.0:2380<span class="w"> </span>--listen-metrics-urls<span class="o">=</span>https://0.0.0.0:9978
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>core<span class="w">      </span><span class="m">901685</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12760</span><span class="w">  </span><span class="m">1076</span><span class="w"> </span>pts/0<span class="w">    </span>S+<span class="w">   </span><span class="m">18</span>:03<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span><span class="m">740369</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>ps<span class="w"> </span>uax<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>root<span class="w">      </span><span class="m">740441</span><span class="w">  </span><span class="m">0</span>.9<span class="w">  </span><span class="m">0</span>.1<span class="w"> </span><span class="m">124764</span><span class="w"> </span><span class="m">25288</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">17</span>:05<span class="w">   </span><span class="m">0</span>:32<span class="w"> </span>etcd<span class="w"> </span>grpc-proxy<span class="w"> </span>start<span class="w"> </span>--endpoints<span class="w"> </span>https://10.0.97.3:9978<span class="w"> </span>--metrics-addr<span class="w"> </span>https://0.0.0.0:9979<span class="w"> </span>--listen-addr<span class="w"> </span><span class="m">127</span>.0.0.1:9977<span class="w"> </span>--key<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.key<span class="w"> </span>--key-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving-metrics/etcd-serving-metrics-control-plane-2.key<span class="w"> </span>--cert<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-peer/etcd-peer-control-plane-2.crt<span class="w"> </span>--cert-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/secrets/etcd-all-serving-metrics/etcd-serving-metrics-control-plane-2.crt<span class="w"> </span>--cacert<span class="w"> </span>/etc/kubernetes/static-pod-certs/configmaps/etcd-peer-client-ca/ca-bundle.crt<span class="w"> </span>--trusted-ca-file<span class="w"> </span>/etc/kubernetes/static-pod-certs/configmaps/etcd-metrics-proxy-serving-ca/ca-bundle.crt
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>core<span class="w">      </span><span class="m">902165</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12760</span><span class="w">  </span><span class="m">1060</span><span class="w"> </span>pts/0<span class="w">    </span>S+<span class="w">   </span><span class="m">18</span>:03<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="c1"># Get priority and class</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-p<span class="w"> </span><span class="m">740369</span><span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>none:<span class="w"> </span>prio<span class="w"> </span><span class="m">4</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>none:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h4 id="tuning"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#tuning">Tuning</a></h4>
<p>我們可以直接登入 CoreOS 後下 <code>ionice</code> 對特定 PID 和硬碟處理權限拉高，可以搭配 ansible 來針對 master node 執行</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Set priority and class</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-c2<span class="w"> </span>-n0<span class="w"> </span>-p<span class="w"> </span><span class="sb">`</span>pgrep<span class="w"> </span>etcd<span class="sb">`</span>
</code></pre></div>
  - <code>-c2</code>: best-effort
  - <code>-n0</code>: the highest priority level</p>
<h4 id="after"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#after">After</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>pgrep<span class="w"> </span>etcd
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="m">740369</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="m">740441</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="o">[</span>core@control-plane-2<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>ionice<span class="w"> </span>-p<span class="w"> </span><span class="m">740369</span><span class="w"> </span><span class="m">740441</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>best-effort:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>best-effort:<span class="w"> </span>prio<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<h3 id="_1"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#_1">後話</a></h3>
<p>恩...反正裝 etcd 的那個節點之硬碟選用高 IOPS，例如用 SSD，效率和穩定性會提升不少</p>
<h3 id="references"><a class="toclink" href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/#references">References</a></h3>
<ul>
<li><a href="https://www.systutorials.com/docs/linux/man/1-ionice/">ionice (1) - Linux Man Pages</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/architecture/architecture-rhcos.html">machineconfig</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/111245626">etcd 性能测试与调优</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/nodes/jobs/nodes-pods-daemonsets.html">Running background tasks on nodes automatically with daemonsets</a></li>
<li><a href="https://rancher.com/docs/rancher/v2.x/en/installation/options/etcd/">Tuning etcd for Large Installations - Rancher</a></li>
<li><a href="https://blog.pichuang.com.tw/20200528-openshift-etcd-operator-1/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/hardware.md#disks">etcd - hardware</a></li>
<li><a href="https://www.openshift.com/blog/deploying-openshift-4.4-to-vmware-vsphere-7">Deploying OpenShift 4.4 to VMware vSphere 7</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/05/29/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%BA%8C/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-28 00:00:00">May 28, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/openshift/" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-4-etcd"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/">Red Hat OpenShift 4 的 etcd 之幾個你應該要知道的事之一</a></h2>
<p>打從 OpenShift 4 之後，etcd 的安裝變成是透過 <code>etcd-operator</code> 來進行安裝的，預設狀況下一次會建立 3 個 etcd instances，然後把他們弄成一個 etcd cluster，本文會記錄一些關於 OpenShift 跟 etcd 之間的一些操作記錄</p>
<p><img alt="" src="/images/etcd-operator-overview.png" /></p>
<!--more-->

<h3 id="oc-etcd"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#oc-etcd">透過 oc 檢查 etcd 狀態</a></h3>
<p>核心中的核心，正常狀態下一定是要好的，它的穩定性會直接關聯到 etcd 叢集的穩定性，兩點之間建議須低於 <code>&gt;100ms</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>openshift-etcd<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>etcd
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>etcd-control-plane-0<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.1<span class="w">     </span>control-plane-0<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>etcd-control-plane-1<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.2<span class="w">     </span>control-plane-1<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>etcd-control-plane-2<span class="w">                </span><span class="m">3</span>/3<span class="w">     </span>Running<span class="w">     </span><span class="m">0</span><span class="w">          </span>2d3h<span class="w">   </span><span class="m">10</span>.0.97.3<span class="w">     </span>control-plane-2<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<h3 id="etcd"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcd">檢查 etcd 叢集狀態</a></h3>
<p>採用跟前一篇介紹的方法 <a href="https://blog.pichuang.com.tw/20200521-openshift-with-coreos-part-7/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a> 進行 <code>etcdctl</code> 的基礎操作</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-n<span class="w"> </span>openshift-etcd<span class="w"> </span>etcd-control-plane-0
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>Defaulting<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>etcdctl.
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>Use<span class="w"> </span><span class="s1">&#39;oc describe pod/etcd-control-plane-0 -n openshift-etcd&#39;</span><span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>all<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>containers<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span>pod.
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>version
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>etcdctl<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3.18
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>API<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>status<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="p">|</span><span class="w">        </span>ENDPOINT<span class="w">        </span><span class="p">|</span><span class="w">        </span>ID<span class="w">        </span><span class="p">|</span><span class="w"> </span>VERSION<span class="w"> </span><span class="p">|</span><span class="w"> </span>DB<span class="w"> </span>SIZE<span class="w"> </span><span class="p">|</span><span class="w"> </span>IS<span class="w"> </span>LEADER<span class="w"> </span><span class="p">|</span><span class="w"> </span>RAFT<span class="w"> </span>TERM<span class="w"> </span><span class="p">|</span><span class="w"> </span>RAFT<span class="w"> </span>INDEX<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>8e7cdeadd4c04bd3<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>65124c220e1d1efa<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="nb">false</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span><span class="w"> </span>23675b8f347a5bea<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span>.3.18<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">168</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="nb">false</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">109</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="m">35522525</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>+------------------------+------------------+---------+---------+-----------+-----------+------------+
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>health<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="p">|</span><span class="w">        </span>ENDPOINT<span class="w">        </span><span class="p">|</span><span class="w"> </span>HEALTH<span class="w"> </span><span class="p">|</span><span class="w">    </span>TOOK<span class="w">     </span><span class="p">|</span><span class="w"> </span>ERROR<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">12</span>.52718ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">16</span>.830977ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">21</span>.484222ms<span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>+------------------------+--------+-------------+-------+
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>member<span class="w"> </span>list<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>+------------------+---------+-----------------+------------------------+------------------------+
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="p">|</span><span class="w">        </span>ID<span class="w">        </span><span class="p">|</span><span class="w"> </span>STATUS<span class="w">  </span><span class="p">|</span><span class="w">      </span>NAME<span class="w">       </span><span class="p">|</span><span class="w">       </span>PEER<span class="w"> </span>ADDRS<span class="w">       </span><span class="p">|</span><span class="w">      </span>CLIENT<span class="w"> </span>ADDRS<span class="w">      </span><span class="p">|</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>+------------------+---------+-----------------+------------------------+------------------------+
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="p">|</span><span class="w"> </span>23675b8f347a5bea<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-2<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.3:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="p">|</span><span class="w"> </span>65124c220e1d1efa<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.2:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="p">|</span><span class="w"> </span>8e7cdeadd4c04bd3<span class="w"> </span><span class="p">|</span><span class="w"> </span>started<span class="w"> </span><span class="p">|</span><span class="w"> </span>control-plane-0<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2380<span class="w"> </span><span class="p">|</span><span class="w"> </span>https://10.0.97.1:2379<span class="w"> </span><span class="p">|</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>+------------------+---------+-----------------+------------------------+------------------------+
</code></pre></div>
<h3 id="etcdctl"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcdctl">使用 etcdctl 原生效能檢查</a></h3>
<p>承上，你也可以直接使用 etcdctl 做一個 60 秒的檢測，
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>sh-4.2#<span class="w"> </span>etcdctl<span class="w"> </span>check<span class="w"> </span>perf<span class="w"> </span>-w<span class="w"> </span>table
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w"> </span><span class="m">60</span><span class="w"> </span>/<span class="w"> </span><span class="m">60</span><span class="w"> </span>Boooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo!<span class="w"> </span><span class="m">100</span>.00%1m0s
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>PASS:<span class="w"> </span>Throughput<span class="w"> </span>is<span class="w"> </span><span class="m">150</span><span class="w"> </span>writes/s
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>PASS:<span class="w"> </span>Slowest<span class="w"> </span>request<span class="w"> </span>took<span class="w"> </span><span class="m">0</span>.134647s
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>PASS:<span class="w"> </span>Stddev<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.003738s
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>PASS
</code></pre></div></p>
<h3 id="_1"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#_1">關於預設參數</a></h3>
<p>透過 <code>oc describe pod/etcd-control-plane-0 -n openshift-etcd</code> 可知，</p>
<ol>
<li>ETCD 選舉超時預設時間 (ETCD_ELECTION_TIMEOUT): 1000ms</li>
<li>ETCD 心跳間隔預設時間 (ETCD_HEARTBEAT_INTERVAL): 100ms</li>
</ol>
<p>etcd 的分散式一致性協定仰賴上述 2 個參數來保證節點之間能夠在部分節點斷線的狀況下依然能夠正確處理 Leader Node 的選舉。</p>
<p>依據 <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a> 及個人經驗可知，<code>ETCD_HEARTBEAT_INTERVAL</code>，即由 Leader 節點通知其他節點 <code>它還是 Leader</code> 的頻率，建議設定為 2 個節點之間 RTT 最大值時間 * 1 ~ 1.5 倍，若該值設定太短，etcd 會發送無用的心跳確認訊息，反而增加 CPU / Network / Disk 無謂的資源消耗；若該值設定太長，就會導致監控節點異常時間過長，會有重新選舉的事情發生。判斷 RTT 的最簡單方式就是使用 ping，如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># 登入節點</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>node/control-plane-0
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Starting<span class="w"> </span>pod/control-plane-0-debug<span class="w"> </span>...
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>To<span class="w"> </span>use<span class="w"> </span>host<span class="w"> </span>binaries,<span class="w"> </span>run<span class="w"> </span><span class="sb">`</span>chroot<span class="w"> </span>/host<span class="sb">`</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.0.97.1
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>sh-4.2#<span class="w"> </span>chroot<span class="w"> </span>/host
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>sh-4.4#<span class="w"> </span>ping<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span>-c60
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>PING<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span><span class="o">(</span><span class="m">10</span>.0.97.5<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.191<span class="w"> </span>ms
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.151<span class="w"> </span>ms
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.213<span class="w"> </span>ms
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>...omit...
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">59</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.142<span class="w"> </span>ms
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.5:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">60</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.204<span class="w"> </span>ms
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>---<span class="w"> </span><span class="m">10</span>.0.97.5<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="m">60</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">60</span><span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss,<span class="w"> </span><span class="nb">time</span><span class="w"> </span>59000ms
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>rtt<span class="w"> </span>min/avg/max/mdev<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.112/0.212/0.435/0.054<span class="w"> </span>ms
</code></pre></div>
<p>如上面數字表現，RTT 測試出來是 <code>0.435ms</code>，遠低於預設值 <code>100ms</code>，所以就不用特別改</p>
<p><code>ETCD_ELECTION_TIMEOUT</code>，則是表示如果節點等待多久沒收到 Leader 的心跳確認的話，就會開始嘗試去競選 Leader 的位子，建議設定為 2 個節點之間 RTT 最大值時間 * 10，以應對網路變化，故如果原有 RTT 為 100ms 的話，則選舉超時設定則為 1000ms。</p>
<p>另外選舉超時建議上限值為 50,000 ms，心跳間隔上限值為 5,000 ms</p>
<h3 id="etcd-database"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#etcd-database">備份 etcd database</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>core@control-plane-1<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa_ocp4_vcenter.pub
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>Last<span class="w"> </span>login:<span class="w"> </span>Wed<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">16</span>:49:17<span class="w"> </span><span class="m">2020</span><span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.0.97.100
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1"># Backup</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>sudo<span class="w"> </span>-E<span class="w"> </span>/usr/local/bin/cluster-backup.sh<span class="w"> </span>./assets/backup
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>385e44c057e47b6fe0b02d534dc4cb452056d33f9174271d1ecced45bc317e50
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>etcdctl<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3.18
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>API<span class="w"> </span>version:<span class="w"> </span><span class="m">3</span>.3
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-apiserver-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-apiserver-pod-131
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-controller-manager-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-controller-manager-pod-13
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>found<span class="w"> </span>latest<span class="w"> </span>kube-scheduler-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/kube-scheduler-pod-17
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>found<span class="w"> </span>latest<span class="w"> </span>etcd-pod:<span class="w"> </span>/etc/kubernetes/static-pod-resources/etcd-pod-139
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>Snapshot<span class="w"> </span>saved<span class="w"> </span>at<span class="w"> </span>./assets/backup/snapshot_2020-05-27_165016.db
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>snapshot<span class="w"> </span>db<span class="w"> </span>and<span class="w"> </span>kube<span class="w"> </span>resources<span class="w"> </span>are<span class="w"> </span>successfully<span class="w"> </span>saved<span class="w"> </span>to<span class="w"> </span>./assets/backup
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="c1"># Check</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>./assets/backup/
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>backup<span class="o">]</span>$<span class="w"> </span>ls
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>snapshot_2020-05-27_165016.db<span class="w">  </span>static_kuberesources_2020-05-27_165016.tar.gz
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="c1"># Copy to outside</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="o">[</span>core@control-plane-1<span class="w"> </span>backup<span class="o">]</span>$<span class="w"> </span>scp<span class="w"> </span>snapshot_2020-05-27_165016.db<span class="w"> </span>static_kuberesources_2020-05-27_165016.tar.gz<span class="w"> </span>root@bastion.ocp4.internal:~/
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>snapshot_2020-05-27_165016.db<span class="w">                                                                                                             </span><span class="m">100</span>%<span class="w">  </span>171MB<span class="w"> </span><span class="m">135</span>.1MB/s<span class="w">   </span><span class="m">00</span>:01
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>static_kuberesources_2020-05-27_165016.tar.gz<span class="w">                                                                                             </span><span class="m">100</span>%<span class="w">   </span>64KB<span class="w">  </span><span class="m">56</span>.1MB/s<span class="w">   </span><span class="m">00</span>:00
</code></pre></div>
<p>有圖有真相</p>
<p><img alt="" src="/images/etcd-backup.png" /></p>
<h3 id="_2"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#_2">後話</a></h3>
<p>下回待續</p>
<h3 id="references"><a class="toclink" href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20200521-openshift-with-coreos-part-7/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a></li>
<li><a href="https://www.huweihuang.com/kubernetes-notes/etcd/etcdctl-v3.html">etcdctl 常用命令</a></li>
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/tuning.md">etcd - tuning</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/backup_and_restore/backing-up-etcd.html">Backing up etcd</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.4/backup_and_restore/replacing-unhealthy-etcd-member.html#restore-replace-stopped-etcd-member_replacing-unhealthy-etcd-member">Replacing an unhealthy etcd member</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/05/28/red-hat-openshift-4-%E7%9A%84-etcd-%E4%B9%8B%E5%B9%BE%E5%80%8B%E4%BD%A0%E6%87%89%E8%A9%B2%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8B%E4%B9%8B%E4%B8%80/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-21 00:00:00">May 21, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/openshift/" class="md-meta__link">openshift</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-pod-container"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/">Red Hat OpenShift Pod 與 Container 的愛恨情仇</a></h2>
<p>這幾天有位客戶問了一個很不錯的問題</p>
<blockquote>
<p>如果在 1 個 Pod 裡面，有 2 個 Containers 的狀況下，OpenShift 該如何針對特定的 Container 進行操作?</p>
</blockquote>
<p>按照 Kuberentes 的設計，Kubernetes 最小單位是 Pod，而不是 Container，然而 1 個 Pod，可以有 1 個或多個的 Container 被包含在裡面，圖示可以參考 <a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking?slide=6">20190817 Container Bare Metal for Networking</a>，但實際上遇到多個 Container 被包含在 1 個 Pods 的時候，在 OpenShift 裡面是怎麼操作的呢? 秉持著本人遵循客戶驅動服務 (Customer Driven Service)，特別寫一篇記錄</p>
<p>因為最近太累，懶得想梗圖，所以附上一個近期我覺得相當不錯的 Demo，在 OpenShift 裡面開 Windows Server 2019 起來做使用</p>
<p>{% youtube Kx110kqoHo0 %}</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#_1">走馬看花之旅: 第七天</a></h3>
<h4 id="pods-container"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#pods-container">顯示一個 Pods 裡面所包含的 Container</a></h4>
<p>預設狀況下，其實內建的 <code>api-resources</code> 並沒有包含一個類型是 <code>container</code>，所以如果要知道一個 Pod 裡面有包含多少個 Container 能用下列 2 個方式找</p>
<ol>
<li>
<p>透過 oc 指令 filter 出來
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># 先獲得到 Pod 清單，這邊選擇 productpage-v1-597b74b4c-x2pgk</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>NAME<span class="w">                             </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>details-v1-6657b8bdf-mm4r4<span class="w">       </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>productpage-v1-597b74b4c-x2pgk<span class="w">   </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>ratings-v1-66cddbfb8f-wvpbz<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>reviews-v1-6788566f98-slm9q<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>reviews-v2-7c4bffdcc4-6wmg2<span class="w">      </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>reviews-v3-69b6d8786-rbhw5<span class="w">       </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>34m
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="c1"># oc get pods &lt;PDO NAME&gt; -o jsonpath=&#39;{.spec.containers[*].name}&#39;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>productpage-v1-597b74b4c-x2pgk<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.containers[*].name}&#39;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>productpage<span class="w"> </span>istio-proxy
</code></pre></div></p>
</li>
<li>
<p>透過 OpenShift Web Console</p>
</li>
</ol>
<p>這個做法是直接透過相當好用的 Web Console 直接觀察，直觀方便</p>
<p><img alt="" src="/images/show-containes.png" /></p>
<h4 id="container"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#container">登入其中一個 Container 裡面</a></h4>
<p>一樣也是 2 種方式</p>
<ol>
<li>透過 oc rsh 指令</li>
</ol>
<p>Red Hat OpenShift 有一個內建的指令可以做到 - <code>oc rsh</code></p>
<blockquote>
<p>oc rsh = Open a remote shell session to a container</p>
</blockquote>
<p>一般狀況下，<code>oc rsh &lt;PDO NAME&gt;</code> 都是直接連到<code>第一個</code> Container，如果要選擇裡面的第二個，更甚至是第三個的容器，則需要特別多一個 <code>--container</code> 指定，更多內容可以直接參考 <code>oc rsh -h</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Open a shell session on the container named &#39;index&#39; inside a pod</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1"># oc rsh -c &lt;CONTAINER NAME&gt; pod/&lt;PDO NAME&gt;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-c<span class="w"> </span>istio-proxy<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>sh-4.4$<span class="w"> </span>ls
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>bin<span class="w">   </span>dev<span class="w">  </span>home<span class="w">  </span>lib64<span class="w">       </span>media<span class="w">  </span>opt<span class="w">   </span>root<span class="w">  </span>sbin<span class="w">  </span>sys<span class="w">  </span>usr
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>boot<span class="w">  </span>etc<span class="w">  </span>lib<span class="w">   </span>lost+found<span class="w">  </span>mnt<span class="w">    </span>proc<span class="w">  </span>run<span class="w">   </span>srv<span class="w">   </span>tmp<span class="w">  </span>var
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>-c<span class="w"> </span>productpage<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>$<span class="w"> </span>ls
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>__pycache__<span class="w">       </span>productpage.py<span class="w">    </span>static<span class="w">      </span>stdout.log<span class="w">  </span>test_productpage.py
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>microservice.log<span class="w">  </span>requirements.txt<span class="w">  </span>stderr.log<span class="w">  </span>templates
</code></pre></div>
<p>好我知道各位一定看不懂，下面有截圖</p>
<p><img alt="" src="/images/rsh-container.png" /></p>
<ol>
<li>透過 OpenShift Web Console</li>
</ol>
<p>相當直觀就是直接對 Web Console 操作，如下圖示表現</p>
<p><img alt="" src="/images/terminal-container.gif" /></p>
<h4 id="container_1"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#container_1">針對其中一個 Container 除錯</a></h4>
<p>只有一個作法，透過 Red Hat OpenShift 內建的指令 - <code>oc debug</code></p>
<blockquote>
<p>oc debug = Launch a command shell to debug a running application</p>
</blockquote>
<p>一般狀況下，如同 <code>oc rsh</code>，使用 <code>oc debug</code> 時，都是直接連到<code>第一個</code> Container，如果要選擇裡面的第二個，更甚至是第三個的容器，則需要特別多一個 <code>--container</code> 指定，更多內容可以直接參考 <code>oc debug -h</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>-c<span class="w"> </span>istio-proxy<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Starting<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk-debug<span class="w"> </span>...
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.128.2.27
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>sh-4.4$<span class="w"> </span>ls
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>bin<span class="w">   </span>dev<span class="w">  </span>home<span class="w">  </span>lib64<span class="w">       </span>media<span class="w">  </span>opt<span class="w">   </span>root<span class="w">  </span>sbin<span class="w">  </span>sys<span class="w">  </span>usr
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>boot<span class="w">  </span>etc<span class="w">  </span>lib<span class="w">   </span>lost+found<span class="w">  </span>mnt<span class="w">    </span>proc<span class="w">  </span>run<span class="w">   </span>srv<span class="w">   </span>tmp<span class="w">  </span>var
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>sh-4.4$
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>$<span class="w"> </span>oc<span class="w"> </span>debug<span class="w"> </span>-c<span class="w"> </span>productpage<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>Starting<span class="w"> </span>pod/productpage-v1-597b74b4c-x2pgk-debug<span class="w"> </span>...
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>Pod<span class="w"> </span>IP:<span class="w"> </span><span class="m">10</span>.128.2.28
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>$<span class="w"> </span>ls
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>__pycache__<span class="w">       </span>productpage.py<span class="w">    </span>static<span class="w">     </span>test_productpage.py
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>microservice.log<span class="w">  </span>requirements.txt<span class="w">  </span>templates
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>$
</code></pre></div>
<p>一樣我知道各位還是看不懂，截圖如下</p>
<p><img alt="" src="/images/debug-container.png" /></p>
<h3 id="_2"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#_2">後話</a></h3>
<p>如果有仔細看內容的話，其實我的操作環境就是建好一個 bookinfo 之後，Service Mesh 自動注入 (inject) Sidecard 進去到每一個 Pod，所以才會有 1 個 Pod 會有 2 個 Container 的現象發生，除此之外，個人經驗還有如果需要整合網路廠商所提供的 CNI Plugin，也有機會會遇到這種等級的操作</p>
<p>結論上來說，雖然 Kubernetes 最小單位是 Pod，一般操作的層級都是在這個層級，但若想在 OpenShift 上針對特定的 Container 進行指令操作、除錯，都還是可以很輕鬆地辦到，也相當的直覺</p>
<p>最後，請大家多多訂閱 Red Hat 服務、分享開源技術及開啟技術友善好環境，我們宅宅們就靠各位客戶養了 XD</p>
<h3 id="references"><a class="toclink" href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/#references">References</a></h3>
<ul>
<li><a href="https://speakerdeck.com/pichuang/20190817-container-bare-metal-for-networking?slide=6">20190817 Container Bare Metal for Networking</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/05/21/red-hat-openshift-pod-%E8%88%87-container-%E7%9A%84%E6%84%9B%E6%81%A8%E6%83%85%E4%BB%87/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-02 00:00:00">May 2, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift-rbac"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/">Red Hat OpenShift RBAC 最小權限實踐</a></h2>
<p>繼<a href="https://blog.pichuang.com.tw/20200427-openshift-with-coreos-part-5/">上一篇</a>準備好了基礎的 OpenShift 4 超級管理員 <code>ocproot</code> 設定後，接下來就是比較針對 Project/Namespace 來進行比較細微的 RBAC 設定，盡可能讓 User 或 Group 適用於<code>最小權限原則</code></p>
<p><img alt="" src="/images/rbac-4.png" /></p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#_1">走馬看花之旅: 第六天</a></h3>
<h4 id="openshift-project"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#openshift-project">常見 OpenShift Project 權限指派</a></h4>
<p>OpenShift 基本上會有 Users/Groups/Projects 可以進行管理，以下參考 <a href="https://blog.csdn.net/weixin_43902588/article/details/103412127">OpenShift 4之设置用户/组对项目的访问权限</a> 的文章來實作</p>
<p>針對專案 <code>project-cicd</code>、<code>project-uat</code> 之 RBAC 權限分配如圖示</p>
<p><img alt="" src="/images/rbac-3.png" /></p>
<ul>
<li>Users</li>
<li>Administrators<ul>
<li>admin1/admin1</li>
<li>admin2/admin2</li>
</ul>
</li>
<li>Developers<ul>
<li>developer1/developer1</li>
<li>developer2/developer2</li>
</ul>
</li>
<li>Testers<ul>
<li>tester1/tester1</li>
<li>tester2/tester2</li>
</ul>
</li>
<li>Groups</li>
<li>admin-group: 對於 <code>project-cicd</code> 及 <code>project-uat</code>，具備最高權限</li>
<li>developer-group: 對於 <code>project-cicd</code> 專案具備設定權限，對 <code>project-uat</code> 僅有查看權限</li>
<li>tester-group: 對於 <code>project-uat</code> 專案具備設定權限，對 <code>project-cicd</code> 僅有查看權限</li>
<li>Projects</li>
<li>project-cicd: 開發用環境</li>
<li>
<p>project-uat: UAT 環境</p>
</li>
<li>
<p>如果沒存的話，撈出既有環境 <code>htpasswd</code> 檔案
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>local-htpasswd-secret<span class="w">  </span>-ojsonpath<span class="o">={</span>.data.htpasswd<span class="o">}</span><span class="w"> </span>-n<span class="w"> </span>openshift-config<span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>localuser-htpasswd
</code></pre></div></p>
</li>
<li>
<p>新增 6 個好漢進 <code>localuser-htpasswd</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># 管理人員 admin1、admin2 皆具備 project-cicd、project-uat 最高權限</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>admin1<span class="w"> </span>admin1
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>admin2<span class="w"> </span>admin2
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="c1"># 開發人員 developer1 設定單一專案 project-cicd 權限 且 檢視單一專案 project-uat 權限</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>developer1<span class="w"> </span>developer1
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="c1"># 開發人員 developer2 設定單一專案 project-cicd 權限 且 檢視單一專案 project-uat 權限</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>developer2<span class="w"> </span>developer2
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="c1"># 測試人員 tester1 設定單一專案 project-uat 權限 且 檢視單一專案 project-cicd 權限</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>tester1<span class="w"> </span>tester1
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="c1"># 測試人員 tester2 設定單一專案 project-uat 權限 且 檢視單一專案 project-cicd 權限</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>tester2<span class="w"> </span>tester2
</code></pre></div></p>
</li>
<li>
<p>檢查 localuser-htpasswd
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Show all user mapping</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>$<span class="w"> </span>cat<span class="w"> </span>localuser-htpasswd
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>ocproot:<span class="nv">$2</span>y<span class="nv">$05$pMTSySH</span>/qa.gTcom9q/Pd.WHoI8VMIpCHWgc9d7cnQuIbRuuPeMia
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>developer1:<span class="nv">$apr1$f7fpvHKb$X</span>.MnMay0USf0.SOg/4hm6.
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>developer2:<span class="nv">$apr1$FtL</span>.4QEj<span class="nv">$lQgfnYB42klWq5</span>.BYnUxx0
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>tester1:<span class="nv">$apr1$AuGDNNK</span>/<span class="nv">$U9Y0ytnT3qrakKat6jYkD1</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>tester2:<span class="nv">$apr1$z1H</span>./q7P<span class="nv">$cvi62jxjmDOyMHQ</span>/Gsx6R0
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>admin1:<span class="nv">$apr1$tUyAimmD$uXc2my4xMGitt</span>/hekx6SH/
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>admin2:<span class="nv">$apr1$rbFALSqT$6</span>emskSJsH8LD0ptM5eXlK1
</code></pre></div></p>
</li>
<li>
<p>更新既有的 <code>local-htpasswd-secret</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>$<span class="w"> </span>oc<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>local-htpasswd-secret<span class="w"> </span>--from-file<span class="w"> </span><span class="nv">htpasswd</span><span class="o">=</span>/root/user/localuser-htpasswd<span class="w"> </span>--dry-run<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>-n<span class="w"> </span>openshift-config<span class="w"> </span><span class="p">|</span><span class="w"> </span>oc<span class="w"> </span>replace<span class="w"> </span>-f<span class="w"> </span>-
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>secret/local-htpasswd-secret<span class="w"> </span>replaced
</code></pre></div></p>
</li>
</ul>
<h4 id="_2"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#_2">管理資源及賦予權限</a></h4>
<p>OpenShfit 預設權限控制能做到 3 種層級，分別是：
1. 指定 Roles 給 user 或 groups
  - role-to-user
  - role-to-group
2. 指定 Cluster Roles 給 users 或 groups
  - cluster-role-to-user
  - cluster-role-to-group
3. 指定 SCC (Security Context Constraints) 來管理 Pods 和 Containers 給 users 或 groups
  - scc-to-user
  - scc-to-group</p>
<p>如果想要查詢有什麼 Role 可以使用的話，可以用 <code>oc get clusterrole.rbac</code> 撈，相當多記得要 filter 一下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># Create Projects</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>$<span class="w"> </span>oc<span class="w"> </span>new-project<span class="w"> </span>project-cicd
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>$<span class="w"> </span>oc<span class="w"> </span>new-project<span class="w"> </span>project-uat
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># Create groups</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>new<span class="w"> </span>admin-group
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>new<span class="w"> </span>developer-group
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>new<span class="w"> </span>tester-group
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1"># Assgin Users and Groups</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>add-users<span class="w"> </span>admin-group<span class="w"> </span>admin1<span class="w"> </span>admin2
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>group.user.openshift.io/admin-group<span class="w"> </span>added:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;admin1&quot;</span><span class="w"> </span><span class="s2">&quot;admin2&quot;</span><span class="o">]</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>add-users<span class="w"> </span>developer-group<span class="w"> </span>developer1<span class="w"> </span>developer2
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>group.user.openshift.io/developer-group<span class="w"> </span>added:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;developer1&quot;</span><span class="w"> </span><span class="s2">&quot;developer2&quot;</span><span class="o">]</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>groups<span class="w"> </span>add-users<span class="w"> </span>tester-group<span class="w"> </span>tester1<span class="w"> </span>tester2
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>group.user.openshift.io/tester-group<span class="w"> </span>added:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;tester1&quot;</span><span class="w"> </span><span class="s2">&quot;tester2&quot;</span><span class="o">]</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="c1"># Assgin Role to Group within Project</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="c1"># For admin-group</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>admin<span class="w"> </span>admin-group<span class="w"> </span>-n<span class="w"> </span>project-cicd
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>admin<span class="w"> </span>admin-group<span class="w"> </span>-n<span class="w"> </span>project-uat
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="c1"># For developer-group</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>edit<span class="w"> </span>developer-group<span class="w"> </span>-n<span class="w"> </span>project-cicd
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>view<span class="w"> </span>developer-group<span class="w"> </span>-n<span class="w"> </span>project-uat
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="c1"># For tester-group</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>edit<span class="w"> </span>tester-group<span class="w"> </span>-n<span class="w"> </span>project-cicd
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-group<span class="w"> </span>view<span class="w"> </span>tester-group<span class="w"> </span>-n<span class="w"> </span>project-uat
</code></pre></div>
<h3 id="appendix"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#appendix">Appendix</a></h3>
<h4 id="rbac"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#rbac">了解 RBAC 角色權限</a></h4>
<p><img alt="" src="/images/rbac-6.png" /></p>
<p>依照 <a href="https://docs.openshift.com/container-platform/4.3/authentication/using-rbac.html#default-roles_using-rbac">OpenShift 預設 RBAC 角色定義</a>，我們新增以下帳號進去觀測，並且做個基本歸納
  - cluster-admin-user/cluster-admin
  - cluster-status-user/cluster-status
  - admin-user/admin
  - basic-user/basic-user
  - self-provisioner-user/self-provisioner
  - edit-user/edit
  - view-user/view</p>
<ol>
<li>
<p>新增帳號
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1"># cluster-admin，類同於 Linux root 在 OpenShift 中的超級管理員角色</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>cluster-admin-user<span class="w"> </span>cluster-admin
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># cluster-status，可以獲取基本的 Cluster 資訊</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>cluster-status-user<span class="w"> </span>cluster-status
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="c1"># admin，專案管理者，可以查看修改專案中任何資訊</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>admin-user<span class="w"> </span>admin
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="c1"># basic-user，可以檢視專案中任何資訊</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>basic-user<span class="w"> </span>basic-user
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="c1"># self-provisioner，可以自己開專案</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>self-provisioner-user<span class="w"> </span>self-provisioner
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="c1"># edit，可以修改資源，但不能看且修改 Role 綁定</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>edit-user<span class="w"> </span>edit
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="c1"># view，只能檢視資源，但不能進行任何修改</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>view-user<span class="w"> </span>view
</code></pre></div></p>
</li>
<li>
<p>更新既有的 <code>local-htpasswd-secret</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$<span class="w"> </span>oc<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>local-htpasswd-secret<span class="w"> </span>--from-file<span class="w"> </span><span class="nv">htpasswd</span><span class="o">=</span>/root/user/localuser-htpasswd<span class="w"> </span>--dry-run<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>-n<span class="w"> </span>openshift-config<span class="w"> </span><span class="p">|</span><span class="w"> </span>oc<span class="w"> </span>replace<span class="w"> </span>-f<span class="w"> </span>-
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>secret/local-htpasswd-secret<span class="w"> </span>replaced
</code></pre></div></p>
</li>
<li>
<p>各個顯示 User 狀態
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1"># https://docs.openshift.com/container-platform/4.3/authentication/using-rbac.html#default-roles_using-rbac</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="c1"># Cluster Level</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="c1"># 常用於集群管理員，類同於 Linux root 的存在</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-cluster-role-to-user<span class="w"> </span>cluster-admin<span class="w"> </span>cluster-admin-user
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac.authorization.k8s.io/cluster-admin
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-cluster-role-to-user<span class="w"> </span>cluster-status<span class="w"> </span>cluster-status-user
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>cluster-status
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="c1"># Project Level</span>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="c1"># 常用於指定 Project 具備 administrator 權限</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-user<span class="w"> </span>admin<span class="w"> </span>admin-user
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>admin
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="c1"># 常用於指定 Project 具備 edit 權限，例如開發人員</span>
<a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-user<span class="w"> </span>edit<span class="w"> </span>edit-user
<a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>edit
<a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
<a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="c1"># 常用於指定 Project 具備 view 權限，例如非開發，但具專案相關性之人員</span>
<a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-user<span class="w"> </span>view<span class="w"> </span>view-user
<a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>view
<a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>
<a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="c1"># Misc</span>
<a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="c1"># 遊客帳號</span>
<a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-user<span class="w"> </span>basic-user<span class="w"> </span>basic-user
<a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>basic-user
<a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>
<a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-role-to-user<span class="w"> </span>self-provisioner<span class="w"> </span>self-provisioner-user
<a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>$<span class="w"> </span>oc<span class="w"> </span>describe<span class="w"> </span>clusterrole.rbac<span class="w"> </span>self-provisioner
</code></pre></div></p>
</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#_3">後話</a></h3>
<p>依據 <a href="https://www.slideshare.net/chakrekevin/introduction-to-ethical-hacking-41597834">Introduction To Ethical Hacking</a> 中的安全 (Security), 功能 (Functionality) 和方便 (Usability) 大三角</p>
<p><img alt="" src="/images/rbac-5.png" /></p>
<p>這個大三角是代表，若你是要系統，比較安全及具備完整功能，那就不可能會很方便使用，反之，如果要安全又要方便使用，那功能就不會多。而 OpenShift 看起來是比較偏向安全和功能這邊，所以不熟悉基本操作的話，會覺得有點玄，你有沒有覺得這個跟當年學 Linux 作業系統非常像呢？</p>
<h3 id="references"><a class="toclink" href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/#references">References</a></h3>
<ul>
<li><a href="https://docs.openshift.com/container-platform/4.3/authentication/using-rbac.html#default-roles_using-rbac">Using RBAC - OpenShift 4.3</a></li>
<li><a href="https://blog.csdn.net/weixin_43902588/article/details/103412127">OpenShift 4之设置用户/组对项目的访问权限</a></li>
<li><a href="https://blog.csdn.net/weixin_43902588/article/details/103414273">OpenShift 4之访问权限分级授权</a></li>
<li><a href="https://blog.csdn.net/weixin_43902588/article/details/104470294">OpenShift 4 Hands-on Lab (9) 用户身份认证和资源访问限制</a></li>
<li><a href="https://blog.pichuang.com.tw/20200427-openshift-with-coreos-part-5/">愛的走馬看花 Red Hat CoreOS 與 Red Hat OpenShift Part 5</a></li>
<li><a href="https://www.slideshare.net/chakrekevin/introduction-to-ethical-hacking-41597834">Introduction To Ethical Hacking</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/05/02/red-hat-openshift-rbac-%E6%9C%80%E5%B0%8F%E6%AC%8A%E9%99%90%E5%AF%A6%E8%B8%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-04-27 00:00:00">April 27, 2020</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="red-hat-openshift"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/">當安裝完 Red Hat OpenShift 之後...</a></h2>
<p>如果有朋友剛弄好 OpenShift 4 可能對於很多預設機制感到有點狐疑，這篇文章就是要來解釋，安裝完 OpenShift 4 後，最重要的小事 - 帳號權限認證 (Authentication)</p>
<p>Red Hat OpenShift 的權限認證一如繼往都是採用角色型存取控制 (Role Based Access Control, RBAC)，這邊就要來準備開始務實一點的操作，本文先從簡單的把預設帳號置換開始做起</p>
<p><img alt="" src="/images/rbac.png" /></p>
<blockquote>
<p>圖片出處: 【最終幻想7：重製版】4K電影剪輯版(後篇) - 零收集、電影式運鏡、完整劇情 - PS4 Pro增強模式 - Final Fantasy VII: REMAKE - 太空戰士7- Semenix出品</p>
</blockquote>
<p>話說大家也可以多多支持一下 <a href="https://www.youtube.com/watch?v=4CS9KvnVFs0">Semenix Gaming</a> -  大大的影片，我的圖片都是截他的頻道，錄的影片相當有水準，最近都在看它的影片當作自己有在打太七 Q_Q</p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#_1">走馬看花之旅: 第五天</a></h3>
<p>預設剛裝完 OpenShift 4，應該都會拿到 3 個資訊</p>
<ul>
<li>Web Console: https://console-openshift-console.apps.ocp4.internal/dashboards</li>
<li>Username: <code>kubeadmin</code></li>
<li>Password: <code>XXXX-XXXX-XXXX-XXXX</code></li>
</ul>
<p>但因為預設帳號導致的資安議題，這個預設的 <code>kubeadmin</code> 及 <code>XXXX-XXXX-XXXX-XXXX</code> 不建議持續使用，建議是換成別的帳號替換它既有的角色 <code>cluster-admin</code>，詳請可參考 <a href="https://docs.openshift.com/container-platform/4.3/authentication/remove-kubeadmin.html">Removing the kubeadmin user - OpenShift 4.3</a></p>
<h4 id="htpasswd-identity-provider"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#htpasswd-identity-provider">準備 HTPasswd Identity Provider</a></h4>
<p>預計將 <code>kubeadmin</code> 置換成 <code>ocproot</code>，權限也要一併移轉，將透過 <code>HTPasswd Identity Porvider</code> 的方式將帳號設定好</p>
<h5 id="oauth"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#oauth">設定 OAuth 資源</a></h5>
<p>這邊先開啟一個檔案 <code>oauth.yaml</code>，新增 <code>identityProvider</code> 名字為 <code>local_htpasswd_provider</code>，形式為 <code>HTPasswd</code>，帳號密碼對照表放在 <code>local-htpasswd-secret</code> 裡面。</p>
<p>當中的 <code>local-htpasswd-secret</code> 將之後再新增，所以不用這時候先準備</p>
<p>```yaml oauth.yaml
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: local_htpasswd_provider
    challenge: true
    login: true
    mappingMethod: claim
    type: HTPasswd
    htpasswd:
      fileData:
        name: local-htpasswd-secret
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>```bash
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a># Update OAuth CRD
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>$ oc apply -f oauth.yaml
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>oauth.config.openshift.io/cluster configured
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a># Check
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>$ oc describe oauth cluster
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a># Update in the future if needed
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>$ oc get oauth cluster -o yaml &gt; oauth.yaml
</code></pre></div></p>
<h4 id="-ocproot"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#-ocproot">設定新的最高權限帳號 - ocproot</a></h4>
<p>這邊對照過往 Linux 操作系統的習慣，我自行取名 <code>ocproot</code>，如果你想要取別的也可以，請自行修改沒問題</p>
<ol>
<li>確保你有 <code>htpasswd</code> 可以使用</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Make sure you have htpasswd</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>httpd-tools<span class="w"> </span>-y
</code></pre></div>
<ol>
<li>新增 <code>local-htpasswd-secret</code> 檔案，新增 <code>ocproot/ocproot</code> 進去</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Create</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>-c<span class="w"> </span>-B<span class="w"> </span>-b<span class="w"> </span>localuser-htpasswd<span class="w"> </span>ocproot<span class="w"> </span>ocproot
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>Adding<span class="w"> </span>password<span class="w"> </span><span class="k">for</span><span class="w"> </span>user<span class="w"> </span>ocproot
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>$<span class="w"> </span>cat<span class="w"> </span>localuser-htpasswd
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>ocproot:<span class="nv">$2</span>y<span class="nv">$05$pMTSySH</span>/qa.gTcom9q/Pd.WHoI8VMIpCHWgc9d7cnQuIbRuuPeMia
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c1"># Update if needed</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="c1"># $ htpasswd -b localuser-htpasswd ocproot ocproot</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="c1"># Remove if needed</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="c1"># $ htpasswd -D localuser-htpasswd ocproot ocproot</span>
</code></pre></div>
<ol>
<li>新增 <code>HTpasswd</code> 進去到 OpenShift 裡面</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>$<span class="w"> </span>oc<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>local-htpasswd-secret<span class="w"> </span>--from-file<span class="w"> </span><span class="nv">htpasswd</span><span class="o">=</span>/root/user/localuser-htpasswd<span class="w"> </span>-n<span class="w"> </span>openshift-config
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>secret/local-htpasswd-secret<span class="w"> </span>created
</code></pre></div>
<ol>
<li>新增叢集最高權限 <code>cluster-admin</code> 給 <code>ocproot</code></li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>$<span class="w"> </span>oc<span class="w"> </span>adm<span class="w"> </span>policy<span class="w"> </span>add-cluster-role-to-user<span class="w"> </span>cluster-admin<span class="w"> </span>ocproot
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>clusterrole.rbac.authorization.k8s.io/cluster-admin<span class="w"> </span>added:<span class="w"> </span><span class="s2">&quot;ocproot&quot;</span>
</code></pre></div>
<ol>
<li>測試 <code>ocproot</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>$<span class="w"> </span>oc<span class="w"> </span>login<span class="w"> </span>-u<span class="w"> </span>ocproot
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>oc<span class="w"> </span>login<span class="w"> </span>-u<span class="w"> </span>ocproot
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>Authentication<span class="w"> </span>required<span class="w"> </span><span class="k">for</span><span class="w"> </span>https://api.ocp4.internal:6443<span class="w"> </span><span class="o">(</span>openshift<span class="o">)</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>Username:<span class="w"> </span>ocproot
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>Password:
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>Login<span class="w"> </span>successful.
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>$<span class="w"> </span>oc<span class="w"> </span>whoami
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>ocproot
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>users
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>NAME<span class="w">      </span>UID<span class="w">                                    </span>FULL<span class="w"> </span>NAME<span class="w">   </span>IDENTITIES
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>ocproot<span class="w">   </span>3635b015-3664-4836-a5a0-2aff1100d99c<span class="w">               </span>local_htpasswd_provider:ocproot
</code></pre></div></li>
</ol>
<p><img alt="" src="/images/ocproot.png" /></p>
<h5 id="kubeadmin"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#kubeadmin">移除 <code>kubeadmin</code> 帳號</a></h5>
<p>根據 <a href="https://docs.openshift.com/container-platform/4.3/authentication/remove-kubeadmin.html">Removing the kubeadmin user - OpenShift 4.3</a> 來移除預設帳號 <code>kubeadmin</code>，務必要記得，你的集群裡面一定要有</p>
<ul>
<li>一個以上的 <code>Identity Provider</code>，一般都是用 <code>HTpasswd</code></li>
<li>一個以上的帳號具備 <code>cluster-admin</code> 的權限</li>
</ul>
<p>不然你會登不進去集群 = =，這是不可逆的指令</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Remove it</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>$<span class="w"> </span>oc<span class="w"> </span>delete<span class="w"> </span>secrets<span class="w"> </span>kubeadmin<span class="w"> </span>-n<span class="w"> </span>kube-system
</code></pre></div>
<h5 id="_2"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#_2">修改自動登出時間</a></h5>
<p>根據 <a href="https://docs.openshift.com/container-platform/4.3/authentication/configuring-internal-oauth.html">Configuring the internal OAuth server - OpenShift 4.3</a>，跟 OpenShift 3 一樣，都是要修改 <code>accessTokenMaxAgeSeconds</code> 值，預設時間應該是 <code>86400</code>，也就是 24 小時後登出，因為太長了，所以改為 <code>3600</code>，也就是登入 1 小時後自動登出</p>
<p>```yaml oauth.yaml
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: local_htpasswd_provider
    challenge: true
    login: true
    mappingMethod: claim
    type: HTPasswd
    htpasswd:
      fileData:
        name: local-htpasswd-secret
  tokenConfig:
    accessTokenMaxAgeSeconds: 3600
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>如同修改 OAuth ㄧ樣，執行下列操作即可
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>```bash
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a># Update OAuth CRD
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>$ oc apply -f oauth.yaml
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>oauth.config.openshift.io/cluster configured
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a># Check
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>$ oc describe oauth cluster
</code></pre></div></p>
<h3 id="_3"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#_3">結語</a></h3>
<p>做完上面的步驟，只是剛剛好準備開始以正確且安全的姿勢操作 OpenShift 4，下一篇會提到更複雜的 Users/Groups/Projects 的 RBAC 控制操作</p>
<p>對 我知道你的血條就跟下圖ㄧ樣</p>
<p><img alt="" src="/images/rbac-2.png" /></p>
<h3 id="appendix"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#appendix">Appendix</a></h3>
<h4 id="q-error-x509-certificate-signed-by-unknown-authority"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#q-error-x509-certificate-signed-by-unknown-authority">Q: 登入時，遇到 <code>error: x509: certificate signed by unknown authority</code></a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>$<span class="w"> </span>oc<span class="w"> </span>login<span class="w"> </span>-u<span class="w"> </span>ocproot<span class="w"> </span>--insecure-skip-tls-verify<span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>error:<span class="w"> </span>x509:<span class="w"> </span>certificate<span class="w"> </span>signed<span class="w"> </span>by<span class="w"> </span>unknown<span class="w"> </span>authority
</code></pre></div>
<p>這問題是因為預設是自簽憑證 (Self-Signed)，系統沒有安裝這張自簽的 CA ，所以要特別拉出來安裝在系統或者是在你的筆電上</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>$<span class="w"> </span>oc<span class="w"> </span>project<span class="w"> </span>openshift-authentication
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="c1"># Same content</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>$<span class="w"> </span>oc<span class="w"> </span>get<span class="w"> </span>pods
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>NAME<span class="w">                               </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>oauth-openshift-74fbdf999f-6kpnn<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>10m
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>oauth-openshift-74fbdf999f-787cm<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>10m
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="c1"># Pick one and copy the cert to outside</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>$<span class="w"> </span>oc<span class="w"> </span>rsh<span class="w"> </span>oauth-openshift-74fbdf999f-6kpnn<span class="w"> </span>cat<span class="w"> </span>/run/secrets/kubernetes.io/serviceaccount/ca.crt<span class="w"> </span>&gt;<span class="w"> </span>ocp4-ingress-ca.crt
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="c1"># It work on RHEL 7.7</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>$<span class="w"> </span>cp<span class="w"> </span>ocp4-ingress-ca.crt<span class="w"> </span>/etc/pki/ca-trust/source/anchors/
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>$<span class="w"> </span>update-ca-trust<span class="w"> </span>extract
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="c1"># Verify Cert is working</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>$<span class="w"> </span>openssl<span class="w"> </span>verify<span class="w"> </span>ocp4-ingress-ca.crt
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>ocp4-ingress-ca.crt:<span class="w"> </span>OK
</code></pre></div>
<h4 id="systemadmin"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#systemadmin">切換回 <code>system:admin</code></a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>$<span class="w"> </span>oc<span class="w"> </span>whoami
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>ocproot
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>$<span class="w"> </span>oc<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>admin
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>Switched<span class="w"> </span>to<span class="w"> </span>context<span class="w"> </span><span class="s2">&quot;admin&quot;</span>.
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>$<span class="w"> </span>oc<span class="w"> </span>whoami
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>system:admin
</code></pre></div>
<h3 id="references"><a class="toclink" href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/#references">References</a></h3>
<ul>
<li><a href="https://access.redhat.com/solutions/1519813">KB1519813: How to install a CA certificate on Red Hat Enterprise Linux 6 and later</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/authentication/remove-kubeadmin.html">Removing the kubeadmin user - OpenShift 4.3</a></li>
<li><a href="https://blog.csdn.net/weixin_43902588/article/details/103412127">OpenShift 4之设置用户/组对项目的访问权限</a></li>
<li><a href="https://blog.csdn.net/weixin_43902588/article/details/103391438">OpenShift 4 之增加管理员用户</a></li>
<li><a href="https://docs.openshift.com/container-platform/4.3/authentication/configuring-internal-oauth.html">Configuring the internal OAuth server - OpenShift 4.3</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../../../2020/04/27/%E7%95%B6%E5%AE%89%E8%A3%9D%E5%AE%8C-red-hat-openshift-%E4%B9%8B%E5%BE%8C/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <span class="md-pagination__current">3</span> <a class="md-pagination__link" href="../4/">4</a> <a class="md-pagination__link" href="../5/">5</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>