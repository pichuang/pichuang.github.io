
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/archive/2023/">
      
      
        <link rel="prev" href="../../category/sustainability/">
      
      
        <link rel="next" href="../2022/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>2023 - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel ğŸ¥ </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#azure-kubernetes-services-c1000k" class="md-nav__link">
    <span class="md-ellipsis">
      
        æªç«Ÿ...Azure Kubernetes Services çš„ç¯€é»èƒ½ä¸èƒ½æä¾› C1000K çš„èƒ½åŠ›å‘¢?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        äººå®¶éƒ½åœ¨æŠ“ç¥å¥‡å¯¶è²ï¼Œè€Œæˆ‘åœ¨æŠ“ Kubernetes å°åŒ…
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distroless-container-kubectl-debug" class="md-nav__link">
    <span class="md-ellipsis">
      
        ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debian-ubuntu" class="md-nav__link">
    <span class="md-ellipsis">
      
        å®¹å™¨åŸºç¤æ˜ åƒæª”è¦é¸ Debian é‚„æ˜¯ Ubuntu?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-probe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Probe é¡å‹åŠå¯¦ä½œæ–¹å¼çš„ä½¿ç”¨èªªæ˜èˆ‡å°å»ºè­°
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sig-kubernetes-scability" class="md-nav__link">
    <span class="md-ellipsis">
      
        SIG Kubernetes Scability å¤šç¶­åº¦åˆ†æ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composite-slas" class="md-nav__link">
    <span class="md-ellipsis">
      
        è¨ˆç®—å‡ºæ­£ç¢ºçš„æœå‹™æ°´å¹³å”è­°ï¼šæ¢ç´¢ Composite SLAs è¨ˆç®—å’Œæ¶æ§‹è¨­è¨ˆ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-latency-slos-4" class="md-nav__link">
    <span class="md-ellipsis">
      
        å¦‚ä½•å®šç¾© Network Latency SLOs? 4 å€‹è¨­è¨ˆåŸå‰‡èˆ‡ç™¾åˆ†ä½æ•¸è§£æ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openai-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        ä½¿ç”¨ OpenAI API é–‹ç™¼ç¶“é©—åˆ†äº«
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2023">2023</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-17 00:00:00">October 17, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-kubernetes-services-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">æªç«Ÿ...Azure Kubernetes Services çš„ç¯€é»èƒ½ä¸èƒ½æä¾› C1000K çš„èƒ½åŠ›å‘¢?</a></h2>
<blockquote>
<p>Kubernetes is Cloud OS, Containers are Linux</p>
</blockquote>
<p><img alt="" src="/images/t2.jpg" /></p>
<p>æ—¢å‰ç¯‡æ–‡ç«  <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a> æœ‰æåˆ°é™ä½ä¸å¿…è¦ç¶²è·¯å‚³è¼¸æˆæœ¬å¯æœ‰æ•ˆæ¸›å°‘ç¢³æ’æ”¾ï¼Œé‚£æˆ‘ç¹¼çºŒåŸºæ–¼ Green Foundation æ‰€æå‡ºçš„<a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">ç¶ è‰²è»Ÿé«”å¯¦è¸è€… (Green Software Practitioner)</a> ç•¶ä¸­çš„åŸå‰‡æå‡è¨­å‚™åˆ©ç”¨ç‡ (Increasing device utilization) ä¾†ç¹¼çºŒå»¶ä¼¸é€™å€‹å¤§è­°é¡Œ</p>
<p>ç›¡åŠ›åœ°æå‡å–®å°ç¯€é»æ‰€èƒ½æœå‹™çš„é‡é«”ï¼Œæ¸›å°‘è³‡æºæµªè²»ï¼Œå¾é€™å€‹è§’åº¦çœ‹ï¼Œå…¶å¯¦å°±æ˜¯éœ€è¦ä¾†æ¢è¨ Azure Kuberenetes Service é è¨­æä¾›çš„é€™äº›ç¯€é»ï¼Œæœ¬é«”åˆ°åº•å¤ ä¸å¤ æä¾›æˆ‘å€‘åœ¨å¤§æµé‡å’Œé«˜æ€§èƒ½è¨ˆç®—ä¸Šæ‰€éœ€çš„è³‡æºå’Œèª¿æ•™ï¼Œé€™é‚Šå°±å¾ç¶“å…¸çš„ç™¾è¬ä¸¦è¡Œé€£ç·š C1000K (Concurrent 1000K Connections) ä¾†åšç‚ºåŸºæº–ä¾†æ¢è¨</p>
<!--more-->

<h3 id="cncf-sustainability-week-taiwan-x-green-software-foundation"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#cncf-sustainability-week-taiwan-x-green-software-foundation">[æ´»å‹•å®£å‚³] CNCF Sustainability Week - Taiwan x Green Software Foundation</a></h3>
<p><img alt="" src="/images/cnsw.png" /></p>
<p>æœ€è¿‘çš„æˆ‘è¦ºå¾—é€™å€‹é¡Œç›®æ¯”è¼ƒåœ¨è€ƒé©— Linux é«˜æ€§èƒ½èª¿æ•™ï¼Œæ­¡è¿å¤§å®¶å ±å <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">2023/10/24 18:30-21:30</a> ä¾†åƒåƒå–å–æ¢è¨</p>
<h3 id="azure-kubernetes-service"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#azure-kubernetes-service">ç™»å…¥ Azure Kubernetes Service ç•¶ä¸­çš„ä¸€å€‹ç¯€é»</a></h3>
<p>é€™é‚Šä½¿ç”¨ v1.25 å¾Œï¼Œé–‹å§‹å¯ä½¿ç”¨çš„ <code>kubectl debug</code> ä½œç‚ºä½¿ç”¨åŸºç¤ï¼Œä¹‹å‰æœ‰äº›éä¸€ç¯‡ <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a> æœ‰å°ˆæ–‡è§£é‡‹é€™å€‹æŒ‡ä»¤çš„æ•ˆæœï¼Œä½†ä»Šå¤©æ¯”è¼ƒç‰¹åˆ¥æ˜¯ï¼Œå°è±¡æ˜¯ Node è€Œé Pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.28.1
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.4-0.20230601165947-6ce0bf390ce3
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1"># ç²å¾— node åç¨±</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>NAME<span class="w">                                </span>STATUS<span class="w">   </span>ROLES<span class="w">   </span>AGE<span class="w">     </span>VERSION
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>aks-agentpool-14864487-vmss000000<span class="w">   </span>Ready<span class="w">    </span>agent<span class="w">   </span>6d14h<span class="w">   </span>v1.27.3
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c1"># kubectl debug node/&lt;node name&gt; -it --image-pull-policy=Always --quiet --image=&lt;image name&gt; -- &lt;command&gt;</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>debug<span class="w"> </span>node/aks-agentpool-14864487-vmss000000<span class="w"> </span>-it<span class="w"> </span>--image-pull-policy<span class="o">=</span>Always<span class="w"> </span>--quiet<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="c1"># å‹™å¿…è¦è¨˜å¾—ä½¿ç”¨ chroot /host åˆ‡åˆ°æ­£ç¢ºçš„ç’°å¢ƒå»</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="o">[</span>root@aks-agentpool-14864487-vmss000000<span class="w"> </span>/<span class="o">]</span><span class="c1"># chroot /host /bin/bash</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="c1"># ç¢ºä¿ä½ å¯ä»¥çœ‹åˆ°ä½œæ¥­ç³»çµ±è³‡è¨Š</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /etc/os-release</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="nv">NAME</span><span class="o">=</span><span class="s2">&quot;Common Base Linux Mariner&quot;</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="nv">VERSION</span><span class="o">=</span><span class="s2">&quot;2.0.20230924&quot;</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="nv">ID</span><span class="o">=</span>mariner
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&quot;CBL-Mariner/Linux&quot;</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="nv">ANSI_COLOR</span><span class="o">=</span><span class="s2">&quot;1;34&quot;</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
</code></pre></div>
<p><img alt="" src="/images/t1.png" /></p>
<h3 id="aks-node-cbl-mariner"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-node-cbl-mariner">è§£å‰– AKS Node è£¡çš„ CBL-Mariner ä½œæ¥­ç³»çµ±</a></h3>
<p>å…ˆè²æ˜ï¼Œä¸‹é¢çš„çœ¾å¤šæ“ä½œéƒ½å¯ä»¥é©ç”¨æ–¼ä»»ä½•ä¸€å®¶çš„ Kubernetes ç™¼è¡Œç‰ˆå’Œä»¥ Linux ç‚ºåŸºç¤çš„ç¯€é»ï¼Œä½†ç•¶ä¸­çš„è¨­å®šæœƒéš¨è‘—ä¸‹åˆ— 3 å€‹ç‹€æ³æœ‰æ‰€å·®ç•°ï¼Œä½†åŸºæœ¬ä¸Šå¤§åŒå°ç•°</p>
<ol>
<li>å» å•†ä¸åŒï¼Œå¦‚ Azure å’Œ Red Hat</li>
<li>OS é¸æ“‡ä¸åŒï¼Œå¦‚ Mariner 2.0ã€Red Hat CoreOSã€Ubuntu 20.04</li>
<li>Kernel ç‰ˆæœ¬ä¸åŒï¼Œå¦‚ 5.15.131ã€5.x.xã€3.11.x</li>
</ol>
<h4 id="aks-environment"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-environment">AKS Environment</a></h4>
<ul>
<li>Azure Kubernetes Service 1.27.3</li>
<li>VM Instance: Standard D4as v5 (4 vcpus, 16 GiB memory)</li>
<li>OS: <a href="https://github.com/microsoft/CBL-Mariner">CBL-Mariner 2.0</a>ï¼Œé€™å€‹æ˜¯ Azure è¦ªå¤§ç‹å­ï¼Œæœ€è¿‘é‚„æœ‰ä¸€å€‹ Azure Linux è¦ªå°ç‹å­å‡ºä¾†ï¼Œä½†é‚„æ²’æ­£å¼ç”¨é</li>
<li>CNI: Azure CNI</li>
<li>(Azure é™å®š) æœ‰ä½¿ç”¨ UDR å¼·åˆ¶æ§åˆ¶ Egress æ–¹å‘</li>
</ul>
<h4 id="1-cpu"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#1-cpu">1. CPU ç›¸é—œ</a></h4>
<h5 id="a-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-hardware">a. Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">#</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># CPU</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1">#</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="c1"># æŸ¥è©¢ CPU å‹è™Ÿ</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># Standard D4as v5 (4 vcpus, 16 GiB memory)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># https://azureprice.net/vm/Standard_D4as_v5</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;model name&quot; | cut -f2 -d: | uniq</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>AMD<span class="w"> </span>EPYC<span class="w"> </span><span class="m">7763</span><span class="w"> </span><span class="m">64</span>-Core<span class="w"> </span>Processor
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="c1"># æŸ¥è©¢ç‰©ç† CPU å€‹æ•¸</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;physical id&quot; | sort | uniq | wc -l</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="m">1</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1"># æŸ¥è©¢æ¯å€‹ç‰©ç† CPU çš„ Core æ•¸</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="c1"># è‹¥æ–¼ Azure Portal è¨­å®š `platformsettings.host_environment.disablehyperthreading: true` çš„è©±ï¼Œå‰‡ä¸æœƒé–‹å•Ÿ HT çš„èƒ½åŠ›</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="m">2</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="c1"># æŸ¥è©¢æ¯å€‹é‚è¼¯ vCPUs çš„å€‹æ•¸</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="c1"># é‚è¼¯ vCPUs å€‹æ•¸ = ç‰©ç† CPU å€‹æ•¸ * æ¯å€‹ç‰©ç† CPU çš„ Core å€‹æ•¸ * 2 (é è¨­ Azure VM æœƒé–‹å•Ÿ HTï¼Œæ„æ—¨é è¨­ç‹€æ³ä¸‹ï¼Œplatformsettings.host_environment.disablehyperthreading: false)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="c1"># https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="c1"># æ ¹æ“šåŠ ç¸½ processor æ•¸é‡ï¼Œæ•…çŸ¥é“è©² VM ç‚º 4 vcpus</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="m">4</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="c1"># https://www.amd.com/en/products/cpu/amd-epyc-7763</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="c1"># Base Clock 2.45GHz, Max. Boost Clock Up to 3.5GHz</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu MHz&quot; | uniq</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2946</span>.906
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
</code></pre></div>
<p>ä¸»è¦é€™é‚Šæ˜¯è¦è¬›æœ‰é–‹ HT å’Œæ²’é–‹ HT çš„ç‹€æ³ä¸‹ï¼ŒvCPU å‘ˆç¾æœƒä¸åŒï¼Œè€Œ Azure VM é è¨­ç‹€æ³ä¸‹éƒ½æ˜¯æœƒæŠŠ HT é–‹èµ·ä¾†çš„ã€‚å€˜è‹¥è¦è·‘ HPC æˆ–å…¶ä»–ä½ å°±æ˜¯è¦æŠŠé€™å°æ©Ÿå™¨æ•ˆèƒ½æ¦¨åˆ°æ¥µé™ï¼Œå‰‡è¦æŠŠ HT é—œæ‰ï¼Œå¯ä½¿ç”¨ <code>platformsettings.host_environment.disablehyperthreading=true</code></p>
<h5 id="b-numa-non-uniform-memeory-acces"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-numa-non-uniform-memeory-acces">b. NUMA (Non-uniform memeory acces)</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># numa</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># yum install numactl -y # é è¨­æ²’æœ‰ï¼Œéœ€è¦è£</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># å¦‚ä¸‹é¡¯ç¤ºï¼Œåªæœ‰ä¸€å€‹ NUMA Nodeï¼Œè£¡é¢æœ‰ 4 å€‹ vcpus ä¸”è¢«åˆ†é…åˆ° 15734 MB çš„ Memory</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl -H</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>available:<span class="w"> </span><span class="m">1</span><span class="w"> </span>nodes<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="o">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>cpus:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>size:<span class="w"> </span><span class="m">15734</span><span class="w"> </span>MB
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>free:<span class="w"> </span><span class="m">7277</span><span class="w"> </span>MB
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>node<span class="w"> </span>distances:
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>node<span class="w">   </span><span class="m">0</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span><span class="m">0</span>:<span class="w">  </span><span class="m">10</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl --show</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>policy:<span class="w"> </span>default
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>preferred<span class="w"> </span>node:<span class="w"> </span>current
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>physcpubind:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>cpubind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>nodebind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>membind:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>é †ä¾¿ä¸€æï¼Œé›–ç„¶è·Ÿç¯€é»æœ¬èº«æ²’å•¥é—œä¿‚ï¼Œé‡å° Kubernetes Pod å°æ–¼ CPU çš„å„ªåŒ–ï¼Œé™¤äº†èŠ±éŒ¢ç ¸è²·æ›´å¥½çš„ CPU ä»¥å¤–ï¼Œæ¯”è¼ƒæœ‰ç­–ç•¥æˆ–å¾ˆ Kubernetes çš„æ–¹å¼æ˜¯ï¼Œæ¡ç”¨ Topology Manager å˜—è©¦èª¿æ•´å‡ºæœ€ä½³åŒ– NUMAï¼Œ<a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a>ã€‚ç¾è¡Œå…±æœ‰ 4 å€‹ç­–ç•¥å¯ç”¨: none, best-effort, restricted, single-numa-nodeï¼ŒAKS é è¨­æ˜¯æ¡ç”¨ <code>none</code>ï¼Œè©²åŠŸèƒ½å¸¸è¦‹æ–¼ 5G / CNF ç­‰å°æ–¼ Pod ä¹‹æ–¼ NUMA çš„ä½¿ç”¨æ•ˆç‡æœ‰ç‰¹åˆ¥è¦æ±‚çš„å ´æ™¯ï¼Œå¦‚ UPF æœå‹™æœƒå‡ºç¾ï¼Œå¯åƒè€ƒ <a href="https://speakerdeck.com/pichuang/qian-tan-azure-private-5g-core-he-kubernetes?slide=15">20221028 æ·ºè«‡ Azure Private 5G Core å’Œ Kubernetes</a></p>
<h4 id="2-memory"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#2-memory">2. Memory ç›¸é—œ</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">#</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># Memory</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1">#</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># ä¾æ“š MemAvailable æ‰€ç¤ºï¼Œé€™å°æ©Ÿå™¨æœ‰ 13479504 kB çš„ Memory å¯ç”¨</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/meminfo</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>MemTotal:<span class="w">       </span><span class="m">16112256</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># æ‰€æœ‰ Memory å¤§å°, æ•…ç‚º 16 GB</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>MemFree:<span class="w">         </span><span class="m">7317172</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># å®Œå…¨æ²’åˆ°çš„ Memory å¤§å°ï¼Œå¾ˆé¡¯ç„¶æˆ‘é€™å°æ©Ÿå™¨é–‹å¤ªå¤§äº†ï¼Œå¤ªé–’</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>MemAvailable:<span class="w">   </span><span class="m">13479504</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># å¯¦éš›ä¸Šå¯ç”¨çš„ Memory å¤§å°ï¼ŒMemAvailable &lt;= MemFree + Active(file) + Inactive(file) + SReclaimable</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>Active<span class="o">(</span>file<span class="o">)</span>:<span class="w">    </span><span class="m">1067108</span><span class="w"> </span>kB
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>Inactive<span class="o">(</span>file<span class="o">)</span>:<span class="w">  </span><span class="m">5021812</span><span class="w"> </span>kB
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>Slab:<span class="w">             </span><span class="m">486692</span><span class="w"> </span>kB
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>SReclaimable:<span class="w">     </span><span class="m">334712</span><span class="w"> </span>kB
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>HugePages_Total:<span class="w">       </span><span class="m">0</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="c1"># MemTotal ç‚º 16112256 kB = 719104 kB + 15393152 kB</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/zoneinfo</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">    </span>DMA32
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">179568</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">179776</span><span class="w"> </span><span class="c1"># çµ¦ DMA32 ä½¿ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ç‚º 702.25 MB = 719104 KB = 179776 * 4 KB</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">   </span>Normal
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">1974218</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">3848288</span><span class="w"> </span><span class="c1"># çµ¦ Normal ä½¿ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ç‚º 14.68 GB = 15393152 KB = 3848288 * 4 KB</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># ä¸€å€‹ Slab page å¯ç”¨ç©ºé–“ 32768 Bytes = 4096 Bytes * pagesperslab 8</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1"># TCP å¯¦éš› Slab page å…§æœ‰ 31360 Bytes è¢«ä½¿ç”¨ = objsize 2240 Bytes * objperslab 14</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="c1"># Slab page ç¢ç‰‡ 1408 Bytes = 32768 - 31360</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="c1"># TCP å¯¦éš›å ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ 470400 Bytes = num_objs 210 * objsize 2240 Bytes</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/slabinfo | grep TCP</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="c1"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>TCP<span class="w">                  </span><span class="m">210</span><span class="w">    </span><span class="m">210</span><span class="w">   </span><span class="m">2240</span><span class="w">   </span><span class="m">14</span><span class="w">    </span><span class="m">8</span><span class="w"> </span>:<span class="w"> </span>tunables<span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span>slabdata<span class="w">     </span><span class="m">15</span><span class="w">     </span><span class="m">15</span><span class="w">      </span><span class="m">0</span>
</code></pre></div>
<p>è¨˜æ†¶é«”æ˜¯ä¸å¯è¢«å£“ç¸®è³‡æºï¼Œè·Ÿ CPU ä¸ä¸€æ¨£ï¼Œå¦‚æœ MemAvailable çœŸçš„ç”¨åˆ° 0 çš„ç‹€æ³ä¸‹ï¼Œå°±ä»£è¡¨ä½ çš„ç¯€é»è¨˜æ†¶é«”çœŸçš„æ˜¯å¤ªå°äº†ï¼Œå®Œå…¨ä¸å¤ åˆ†é…å‡ºå»ï¼Œä¸Šé¢çš„ Pod å¾ˆå®¹æ˜“æœ‰æ»¿æ»¿ OOM çš„ç‹€æ³ã€‚</p>
<p>å¦‚æœä½ æƒ³è¦ Pod æœ‰ä¿éšœçš„è³‡æºå¯ä»¥ç”¨ï¼Œä½ éœ€è¦å¾ k8s çš„è§’åº¦å»æ§åˆ¶ cpu.request / cpu.limit / memory.request / memory.limitï¼Œå¯åƒè€ƒå°å¼ŸèˆŠæ–‡ <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a>ï¼Œé€™ç¯‡ä¸æœƒç‰¹åˆ¥æ¶‰åŠï¼Œä¹‹å¾Œæœƒè¬›ä¸€ç¯‡ç”±ä¸‹è€Œä¸Šçš„ Node å’Œç”±ä¸Šè€Œä¸‹çš„ç®¡ç† Kubernetes è§’åº¦ä¸Šçš„è³‡æºå°ç…§</p>
<p>é †ä¾¿ä¸€æï¼Œç¶­æŒä¸€å€‹ Long Lived TCP Connection ï¼Œä¸”ä¸åŒ…å«å…¶ä»–çš„è³‡æ–™å‚³è¼¸ï¼Œæ¶ˆè€—çš„è¨˜æ†¶é«”å¤§ç´„ç‚º ~3.3 KBï¼Œè‹¥å…¨éƒ¨éƒ½æ˜¯ Long Lived TCP Connection ä¸”ç„¡å¯¦éš›è³‡æ–™é‹ä½œæˆ–å‚³è¼¸çš„è©±ï¼Œå¤§æ¦‚å°±æ˜¯æ¶ˆè€— 3.3 GB è¨˜æ†¶é«”å­˜é€™äº›è³‡è¨Šï¼Œå¯åƒè€ƒ <code>Q5: å–®å° C1000K æ˜¯æ€éº¼ç®—å‡ºä¾†çš„? é è¨­å•¥éƒ½æ²’åšçš„ç‹€æ³ä¸‹è¨˜æ†¶é«”æ¶ˆè€—ç‚ºä½•?</code> çš„å…§å®¹</p>
<h4 id="3-linux-kernel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#3-linux-kernel">3. Linux Kernel ç›¸é—œ</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">#</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1"># Kernel Paraemters</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1">#</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># uname -a</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>Linux<span class="w"> </span>aks-agentpool-14864487-vmss000000<span class="w"> </span><span class="m">5</span>.15.131.1-2.cm2<span class="w"> </span><span class="c1">#1 SMP Sun Sep 24 03:38:45 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="c1"># ä¸‹åˆ—éƒ½æ˜¯ CBL-Mariner çš„é è¨­å€¼</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># sysctl -a</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>net.ipv4.ip_local_port_range<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32768</span><span class="w">    </span><span class="m">60999</span><span class="w"> </span><span class="c1"># è©² VM å¯ä½¿ç”¨çš„ Port Rangeï¼Œé è¨­ç¯„åœç‚º 32768 ~ 60999ï¼Œå…± 28232 å€‹ Portï¼Œå¯èª¿æ•´</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>net.ipv4.tcp_syn_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>net.ipv4.tcp_synack_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>net.ipv4.tcp_syncookies<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># é è¨­å¯é˜²æ­¢éƒ¨åˆ† SYN Flood æ”»æ“Š</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>net.ipv4.tcp_tw_reuse<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>net.ipv4.tcp_max_syn_backlog<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>net.ipv4.tcp_max_tw_buckets<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">65536</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>net.core.somaxconn<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>fs.file-max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9223372036854775807</span><span class="w"> </span><span class="c1"># OS Levelï¼Œç‚º Int64.MaxValue æœ€å¤§ä½æ•¸ï¼Œåå…­é€²ä½0x7FFFFFFFFFFFFFFF</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>fs.nr_open<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1073741816</span><span class="w"> </span><span class="c1"># Progess Levelï¼Œéœ€è¦æ¯” * hard nofile (1048576) å¤§ï¼Œä¸ç„¶æœƒé–‹ä¸èµ·ä¾†</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>net.ipv4.tcp_congestion_control<span class="w"> </span><span class="o">=</span><span class="w"> </span>cubic
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>net.ipv4.tcp_mtu_probing<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>net.ipv4.tcp_fastopen<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># ulimit -a</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>real-time<span class="w"> </span>non-blocking<span class="w"> </span><span class="nb">time</span><span class="w">  </span><span class="o">(</span>microseconds,<span class="w"> </span>-R<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>core<span class="w"> </span>file<span class="w"> </span>size<span class="w">              </span><span class="o">(</span>blocks,<span class="w"> </span>-c<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>data<span class="w"> </span>seg<span class="w"> </span>size<span class="w">               </span><span class="o">(</span>kbytes,<span class="w"> </span>-d<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>scheduling<span class="w"> </span>priority<span class="w">                 </span><span class="o">(</span>-e<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>file<span class="w"> </span>size<span class="w">                   </span><span class="o">(</span>blocks,<span class="w"> </span>-f<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>pending<span class="w"> </span>signals<span class="w">                     </span><span class="o">(</span>-i<span class="o">)</span><span class="w"> </span><span class="m">62863</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>max<span class="w"> </span>locked<span class="w"> </span>memory<span class="w">           </span><span class="o">(</span>kbytes,<span class="w"> </span>-l<span class="o">)</span><span class="w"> </span><span class="m">64</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>max<span class="w"> </span>memory<span class="w"> </span>size<span class="w">             </span><span class="o">(</span>kbytes,<span class="w"> </span>-m<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>open<span class="w"> </span>files<span class="w">                          </span><span class="o">(</span>-n<span class="o">)</span><span class="w"> </span><span class="m">1048576</span><span class="w"> </span><span class="c1"># åŒæ™‚å¯æ‰“é–‹çš„æª”æ¡ˆæ•¸é‡ï¼ŒAzure æä¾›çš„ CBL-Mariner ä½œæ¥­ç³»çµ±é è¨­æ˜¯ 2^20 å€‹ï¼Œå–®å° VM å¸³é¢é è¨­æ•¸å­—æ˜¯æ”¯æ´åšåˆ° C1000K ç­‰ç´š</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>pipe<span class="w"> </span>size<span class="w">                </span><span class="o">(</span><span class="m">512</span><span class="w"> </span>bytes,<span class="w"> </span>-p<span class="o">)</span><span class="w"> </span><span class="m">8</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>POSIX<span class="w"> </span>message<span class="w"> </span>queues<span class="w">         </span><span class="o">(</span>bytes,<span class="w"> </span>-q<span class="o">)</span><span class="w"> </span><span class="m">819200</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>real-time<span class="w"> </span>priority<span class="w">                  </span><span class="o">(</span>-r<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>stack<span class="w"> </span>size<span class="w">                  </span><span class="o">(</span>kbytes,<span class="w"> </span>-s<span class="o">)</span><span class="w"> </span><span class="m">8192</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>cpu<span class="w"> </span><span class="nb">time</span><span class="w">                   </span><span class="o">(</span>seconds,<span class="w"> </span>-t<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>max<span class="w"> </span>user<span class="w"> </span>processes<span class="w">                  </span><span class="o">(</span>-u<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>virtual<span class="w"> </span>memory<span class="w">              </span><span class="o">(</span>kbytes,<span class="w"> </span>-v<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>file<span class="w"> </span>locks<span class="w">                          </span><span class="o">(</span>-x<span class="o">)</span><span class="w"> </span>unlimited
</code></pre></div>
<p>å‰é™£å­ CNCF æœ‰ä¸€ç¯‡éƒ¨è½æ ¼ <a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a> å°±åœ¨è¬›å¦‚ä½•èª¿æ•´ç¯€é»å…§çš„ Linux Kernel åƒæ•¸ä¾†é”åˆ° 1 ç™¾è¬ Concurrent Connections</p>
<p>é€™é‚Šä¾†æ¯”å°ä¸€ä¸‹ CBL-Mariner é è¨­åƒæ•¸è·Ÿ <a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a> çš„å·®ç•°</p>
<table>
<thead>
<tr>
<th style="text-align: center;">sysctl</th>
<th style="text-align: center;">CBL-Mariner 2.0</th>
<th style="text-align: center;">EMQX</th>
<th style="text-align: center;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">æ•´å€‹ OS æœ€å¤§é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">fs.fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">å–®ä¸€ç¨‹åºæœ€å¤§é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">net.core.somaxconn</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">32768</td>
<td style="text-align: center;">å…¨é€£æ¥ä½‡åˆ—é•·åº¦: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_syn_backlog</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">å…¨é€£æ¥ä½‡åˆ—é•·åº¦: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.core.netdev_max_backlog</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.ip_local_port_range</td>
<td style="text-align: center;">32768 60999</td>
<td style="text-align: center;">1000 65535</td>
<td style="text-align: center;">VM å¯ç”¨ Port ç¯„åœï¼Œä½†å–®ç´”ä»¥ Server ç«¯è§’åº¦ä¾†èªªèª¿é€™å€‹æ²’å•¥å¤ªå¤§ç”¨è™•ï¼Œå¤šåŠéƒ½ 80, 443 ç‚ºä¸»ï¼Œä½†ç•¶ Client ä¾†è¬›å°±æœ‰æ•ˆæœäº†ï¼Œè­¬å¦‚èªªä½ è¦å¤–é€£ DB é‚„æ˜¯æœ‰çš„æ²’çš„å¤–éƒ¨æœå‹™ä¹‹é¡çš„ï¼Œé€™å€‹èª¿å¤§æœƒæ¯”è¼ƒå¥½</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.optmem_max</td>
<td style="text-align: center;">20480</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">ç·©è¡å€å¤§å°</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_rmem</td>
<td style="text-align: center;">4096 131072 6291456</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">å› ç‚º MQï¼Œè¨Šæ¯é‡å°ï¼Œå¯ä»¥ 1KB å°±ç™¼é€ä¸€æ¬¡</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_wmem</td>
<td style="text-align: center;">4096 16384 4194304</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">å› ç‚º MQï¼Œè¨Šæ¯é‡å°ï¼Œå¯ä»¥ 1KB å°±ç™¼é€ä¸€æ¬¡</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_max</td>
<td style="text-align: center;">131072</td>
<td style="text-align: center;">1000000</td>
<td style="text-align: center;">èª¿é«˜ nf_conntrack_max çš„æ¥å—ä¸Šé™</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_tcp_timeout_time_wait</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">30</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_tw_buckets</td>
<td style="text-align: center;">65536</td>
<td style="text-align: center;">1048576</td>
<td style="text-align: center;">è¶…é TIME_WAIT è¨­å®šå€¼å‰‡æ¸…é™¤</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_fin_timeout</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">èª¿é™ TCP åœ¨ FIN-WAIT-2 çš„æ™‚é–“</td>
</tr>
</tbody>
</table>
<p>å¦‚æœè¦é‡å°ä¸Šè¿°çš„åƒæ•¸é€²è¡Œèª¿æ•´ï¼Œåœ¨ AKS è£¡é¢ï¼Œä½ éœ€è¦ä¾å¾ª <a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#os-configuration">è‡ªè¨‚ Azure Kubernetes Service (AKS) ç¯€é»é›†å€çš„ç¯€é»è¨­å®š</a> é€²è¡Œè¨­å®šï¼Œè€Œä¸æ˜¯ç›´æ¥é€²å»ç”¨ sysctl æ”¹æ•¸å€¼ï¼Œä½†ç›®å‰ az aks update æ²’æ”¯æ´ --linux-os-config</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>az<span class="w"> </span>aks<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>myAKSCluster<span class="w"> </span>--resource-group<span class="w"> </span>myResourceGroup<span class="w"> </span>--linux-os-config<span class="w"> </span>./linuxosconfig.json
</code></pre></div>
<p>å¦‚æœä½ æ˜¯è‡ªå»ºä½œæ¥­ç³»çµ±çš„è©±ï¼Œå°±å° /etc/sysctl.conf é€²è¡Œä¿®æ”¹å³å¯</p>
<h4 id="4-networking"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#4-networking">4. Networking</a></h4>
<h5 id="a-networking-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-networking-hardware">a. Networking Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">#</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1"># Networking Hardware</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1">#</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="c1"># é¡¯ç¤ºé è¨­ç¶²å¡ eth0 æ”¯æ´æœ€å¤§çš„ Channel å¤§å°å’Œç¾è¡Œè¨­å®šçš„å¤§å°</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -l eth0</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>Channel<span class="w"> </span>parameters<span class="w"> </span><span class="k">for</span><span class="w"> </span>eth0:
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>Pre-set<span class="w"> </span>maximums:
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>Combined:<span class="w">       </span><span class="m">4</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>Current<span class="w"> </span>hardware<span class="w"> </span>settings:
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>Combined:<span class="w">       </span><span class="m">4</span><span class="w"> </span><span class="c1"># ç”¨æ»¿äº†ï¼Œä»£è¡¨ RSS (Receive Side Scaling) æ²’å•é¡Œï¼Œåœ¨ CBL-Mariner ä¸Šå·²ç¶“æ˜¯ç¶²è·¯æœ€ä½³åŒ–ç”¨æ³•</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="c1"># ä¸‹é¢çš„ interrupts çµ±ä¸€æœƒç”± irqbalance è‡ªå‹•æ§åˆ¶ï¼Œæ­£å¸¸ç‹€æ³ä¸‹ä½ ä¸éœ€è¦æ‰‹å‹•å»ç¶­è­·ä¸‹é¢çš„ /proc/irq/25,26,27,28/smp_affinity è¨­å®š</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c1"># systemctl status irqbalance</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/interrupts | grep mlx5_comp</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">           </span>CPU0<span class="w">       </span>CPU1<span class="w">       </span>CPU2<span class="w">       </span>CPU3
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w"> </span><span class="m">25</span>:<span class="w">   </span><span class="m">14332354</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129153</span>-edge<span class="w">      </span>mlx5_comp0@pci:3ffc:00:02.0
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w"> </span><span class="m">26</span>:<span class="w">          </span><span class="m">0</span><span class="w">         </span><span class="m">14</span><span class="w">   </span><span class="m">13861183</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129154</span>-edge<span class="w">      </span>mlx5_comp1@pci:3ffc:00:02.0
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w"> </span><span class="m">27</span>:<span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">17419688</span><span class="w">         </span><span class="m">12</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129155</span>-edge<span class="w">      </span>mlx5_comp2@pci:3ffc:00:02.0
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w"> </span><span class="m">28</span>:<span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">10673131</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129156</span>-edge<span class="w">      </span>mlx5_comp3@pci:3ffc:00:02.0
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>...
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="c1"># é è¨­æ˜¯ä½¿ç”¨ GRO åœ¨ Linux Kernel ä¸ŠæŠŠåˆä½µå°åŒ…çš„äº‹æƒ…çµ¦è§£æ±ºäº†ï¼Œè€Œé LRO åœ¨ç¶²å¡ä¸ŠæŠŠåˆä½µå°åŒ…çš„äº‹æƒ…çµ¦è§£æ±ºäº†</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -k eth0</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>generic-receive-offload:<span class="w"> </span>on
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>large-receive-offload:<span class="w"> </span>off
</code></pre></div>
<h5 id="b-routing"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-routing">b. Routing</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">#</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1"># Linux Networking</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1">#</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1"># é¡¯ç¤ºé€™å°ç¯€é»ä¸Šçš„è·¯ç”±</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ip route</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># é€™é‚Šè¦æ³¨æ„çš„æ˜¯ï¼Œå…¶å¯¦æˆ‘æœ‰è¨­å®š UDR å¼·åˆ¶æŠŠ egress (a.k.a outbound traffic) æ‰€æœ‰æµé‡å°åˆ° Firewall (10.99.x.x) ä¸Šï¼Œä½†å¾è·¯ç”±è¡¨ä¸Šæœƒçœ‹ä¸å‡ºä¾†ï¼Œå¾—å¾ Azure Portal ä¸Šçœ‹</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c1"># ä»¥ä¸‹æ˜¯ Node IP çš„è·¯ç”± 10.0.128.0/24ï¼ŒDefault Gateway ç‚ºè©²ç¶²æ®µçš„ç¬¬ä¸€å€‹ IPï¼Œä¹Ÿå°±æ˜¯ 10.0.128.1</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="m">10</span>.0.128.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="c1"># ä»¥ä¸‹æ˜¯ Pod IP çš„è·¯ç”±ï¼Œ10.0.129.0/24</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="m">10</span>.0.129.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="m">10</span>.0.129.5<span class="w"> </span>dev<span class="w"> </span>azv7d24922a083<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="m">10</span>.0.129.8<span class="w"> </span>dev<span class="w"> </span>azv9da73473eb2<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="m">10</span>.0.129.9<span class="w"> </span>dev<span class="w"> </span>azv6f0c6f1ef57<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="m">10</span>.0.129.10<span class="w"> </span>dev<span class="w"> </span>azvaa6ccb05bb5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="m">10</span>.0.129.13<span class="w"> </span>dev<span class="w"> </span>azvcdfece9bfdf<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="m">10</span>.0.129.14<span class="w"> </span>dev<span class="w"> </span>azvf893453cbc5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="m">10</span>.0.129.15<span class="w"> </span>dev<span class="w"> </span>azv1f6d5d20426<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="m">10</span>.0.129.16<span class="w"> </span>dev<span class="w"> </span>azvf85308aa314<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="m">10</span>.0.129.17<span class="w"> </span>dev<span class="w"> </span>azva9b3f83744f<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="m">10</span>.0.129.21<span class="w"> </span>dev<span class="w"> </span>azv224fa8c56a6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="m">10</span>.0.129.22<span class="w"> </span>dev<span class="w"> </span>azvbb0334487e3<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="m">10</span>.0.129.25<span class="w"> </span>dev<span class="w"> </span>azvca12febb7ce<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="m">10</span>.0.129.27<span class="w"> </span>dev<span class="w"> </span>azv0867699d9ac<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="m">10</span>.0.129.28<span class="w"> </span>dev<span class="w"> </span>azva412bba2170<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="m">10</span>.0.129.29<span class="w"> </span>dev<span class="w"> </span>azvd4c029379b6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="m">10</span>.0.129.30<span class="w"> </span>dev<span class="w"> </span>azv9a46f9ec6ea<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="m">10</span>.0.129.35<span class="w"> </span>dev<span class="w"> </span>azvd96d575dd35<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="m">10</span>.0.129.36<span class="w"> </span>dev<span class="w"> </span>azvee4ae66e969<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="c1"># ä¸‹é¢æ˜¯é€™å°ç¯€é»èˆ‡ Azure å¹³å°è³‡æº 168.63.129.16 æºé€šç”¨çš„è·¯ç”±</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="m">168</span>.63.129.16<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="c1"># ä¸‹é¢æ˜¯è·Ÿ Azure Instance Metadata Service æºé€šç”¨çš„è·¯ç”±</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="m">169</span>.254.169.254<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p>çœ‹è·¯ç”±è¡¨ä¸»è¦çš„ç›®çš„æ˜¯è¨è«– Kubernetes Egressï¼Œä¹Ÿå°±æ˜¯ Pod å¾ç¯€é»å‡ºå»çš„è·¯å¾‘æ˜¯æ€éº¼èµ°çš„ã€‚å› ç‚ºæˆ‘ä½¿ç”¨çš„ CNI (Container Networking Interface) ç‚º Azure-CNIï¼Œè€Œéä½¿ç”¨ kubenet æˆ– overlay CNI ç­‰ï¼Œæ‰€ä»¥ Pod IP å…¶å¯¦å°±æ˜¯æˆ‘æŒ‡æ´¾çš„æŸä¸€æ®µ Azure Subnet ç¶²æ®µï¼ŒæŒ‰ç…§è©²è·¯ç”±ï¼Œæ˜¯å¯ä»¥å¾åˆ¥çš„ Azure Subnet æˆ–å·²é–‹å•Ÿ VNet Peering çš„æœå‹™ç›´æ¥æ‘¸åˆ° Pod IPã€‚</p>
<p>è‹¥ä½ çš„ kube-proxy æ˜¯èµ° iptables çš„è©±ï¼Œå…¶å¯¦æ˜¯å¯ä»¥å° Node å¥— iptables rule å½±éŸ¿ä¸Šé¢çš„ Pod è·¯ç”±ï¼Œè­¬å¦‚èªªæ‹¿ ansible å°æ‰€æœ‰ç¯€é»ç›´æ¥ä¸Šè·¯ç”±ï¼Œä½†é€™å·²ç¶“é Kubernetes èƒ½ç®¡æ§çš„ç¯„åœäº†ï¼Œæ‰€ä»¥æ­£å¸¸ç‹€æ³ä¸‹éƒ½ä¸å»ºè­°åœ¨ä¸æ¸…æ¥šä¸æ˜ç™½çš„ç‹€æ³ä¸‹é€²è¡Œé€™ä»¶äº‹</p>
<h3 id="_1"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#_1">å¾Œè©±</a></h3>
<ol>
<li>å…¶å¯¦ä¸€é–‹å§‹æˆ‘åªæ˜¯æƒ³è¦ç´€éŒ„ä¸€ä¸‹ AKS Node ä¸Šçš„ä¸€äº›é è¨­åƒæ•¸ï¼Œä¸çŸ¥é“ç‚ºå•¥è¶Šå¯«è¶Šå¤šã€‚</li>
<li>å¦‚æœä½ æœ‰çœ‹æ‡‚ä¸Šé¢çš„å…§å®¹ï¼Œä½ æœƒç™¼ç¾åˆ°å…¶å¯¦ç ”ç©¶ Kubernetes å°±è·Ÿç ”ç©¶ Linux ä½œæ¥­ç³»çµ±æ˜¯æ²’ä»€éº¼å¤ªå¤§å€åˆ¥çš„ï¼Œä¸å¦‚èªª Kubernetes å¹«ä½ æŠ½è±¡åŒ–äº†å¾ˆå¤šäº‹æƒ…ï¼Œè®“ä½ ä¸ç”¨çŸ¥é“å¾—å¤ªç´°ï¼Œé›–ç„¶è®Šç›¸ä½ éœ€è¦å­¸ç¿’çš„å°±æ˜¯ Kubernetes çš„èªè¨€ï¼Œå¾å­¸ç¿’ shell æ”¹æˆåˆ° kubectl çš„æ“ä½œ</li>
<li>çœ‹è‘—ä¸Šé¢çš„å…§å®¹ï¼Œæ‰€ä»¥æˆ‘å¹³æ™‚æ‰æœƒå¾ˆå¸¸èªªï¼Œä½œæ¥­ç³»çµ±çš„ç©©å®šèˆ‡å¦æœƒç›´æ¥å½±éŸ¿ Kubernetes çš„ç©©å®šæ€§ï¼Œæ»¿æ»¿åœ°ä½œæ¥­ç³»çµ±åƒæ•¸ç´°ç¯€</li>
<li>AKS Node æ˜¯æœ‰è€ƒæ…®åˆ°å¤§éƒ¨åˆ†çš„ä½¿ç”¨è€…éƒ½ä¸æœƒå»çœ‹é€™äº›åƒæ•¸ï¼Œèª¿æ•™æ˜¯ä»¥ C1000K ç‚ºç›®æ¨™åŸºæº–å…ˆå¹«å¤§å®¶èª¿å¥½äº†ï¼Œæ‰€ä»¥æ²’ç‰¹æ®Šç‹€æ³ä¸‹éƒ½å¯ä»¥é †é †ç”¨ï¼Œä¹Ÿä¸å¤ªæœƒæœ‰ç¯€é»ç¡¬é«”+ä½œæ¥­ç³»çµ±æ•ˆèƒ½å•é¡Œï¼Œè‡ªå»ºçš„å°±è¦è‡ªå·±åŠ æ²¹äº†</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#qa">Q&amp;A</a></h3>
<h4 id="q1-azure-vm-ht"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q1-azure-vm-ht">Q1: å¦‚ä½•é‡å° Azure VM é—œé–‰ HT åŠŸèƒ½?</a></h4>
<p>é‡é–‹æ‰æœƒç”Ÿæ•ˆ</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>az<span class="w"> </span>resource<span class="w"> </span>tag<span class="w"> </span>--ids<span class="w"> </span>/subscriptions/<span class="o">{</span>SubID<span class="o">}</span>/resourceGroups/<span class="o">{</span>ResourceGroup<span class="o">}</span>/providers/Microsoft.Compute/virtualMachines/<span class="o">{</span>VM<span class="o">}</span><span class="w"> </span>--tags<span class="w"> </span>platformsettings.host_environment.disablehyperthreading<span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>az<span class="w"> </span>vm<span class="w"> </span>restart<span class="w"> </span>-g<span class="w"> </span><span class="o">{</span>ResourceGroup<span class="o">}</span><span class="w"> </span>-n<span class="w"> </span><span class="o">{</span>VM<span class="o">}</span>
</code></pre></div>
<h4 id="q2-azure-vm-instance-metadata"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q2-azure-vm-instance-metadata">Q2: å¦‚ä½•ç²å–è©² Azure VM çš„ Instance Metadata?</a></h4>
<p>æ ¹æ“šæ­¤æ–‡ <a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a>ï¼Œå¯é€éä»¥ä¸‹æ–¹å¼ç²å–</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># curl -s -H Metadata:true --noproxy &quot;*&quot; &quot;http://169.254.169.254/metadata/instance?api-version=2021-02-01&quot; | jq</span>
</code></pre></div>
<h4 id="q3-eth0-channel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q3-eth0-channel">Q3: å¦‚æœæœ‰è¦èª¿æ•´ eth0 çš„ channel å¤§å°è©²æ€éº¼åš?</a></h4>
<p>å¦‚æœä½ æ˜¯ç”¨ AKS çš„ä½¿ç”¨è€…ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¸ç”¨æ”¹ï¼Œé è¨­ä¸€é–‹å§‹éƒ½å¼„å¥½äº†</p>
<p>æš«æ™‚è™•ç†æ–¹å¼ï¼Œå› ç‚ºé€™å€‹æ˜¯æš«æ™‚æ€§è¨­å®šï¼Œå¦‚æœè©² AKS ç¯€é»è¢«ç§»é™¤äº†ï¼Œæ–°å¢ç¯€é»æˆ–æ—¢æœ‰çš„ç¯€é»ä¸¦ä¸æœƒæœ‰é€™å€‹åŠŸèƒ½</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>$<span class="w"> </span>ethtool<span class="w"> </span>-L<span class="w"> </span>eth0<span class="w"> </span>combined<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<h4 id="q4-platformsettingshost_environmentdisablehyperthreading-true"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q4-platformsettingshost_environmentdisablehyperthreading-true">Q4: ä½•æ™‚æœƒé¸æ“‡æŠŠ <code>platformsettings.host_environment.disablehyperthreading: true</code> åƒæ•¸å¥—ä¸Šå»</a></h4>
<p>è·‘ HPC é«˜æ•ˆèƒ½è¨ˆç®—é¡å‹çš„éƒ½è »é©åˆçš„ï¼Œä½ æœƒéœ€è¦å®Œæ•´çš„æ ¸å¿ƒè¨ˆç®—èƒ½åŠ›ï¼Œè­¬å¦‚èªª EDA / ç®—åœ– ç­‰</p>
<h4 id="q5-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q5-c1000k">Q5: å–®å° C1000K æ˜¯æ€éº¼ç®—å‡ºä¾†çš„? é è¨­å•¥éƒ½æ²’åšçš„ç‹€æ³ä¸‹è¨˜æ†¶é«”æ¶ˆè€—ç‚ºä½•?</a></h4>
<p>Linux é–‹æª”é™åˆ¶ä¸»è¦å¡ 3 å€‹é»ï¼Œä¸‰è€…ç¼ºä¸€ä¸å¯ï¼Œä»¥ CBL-Mariner ä¾†çœ‹çš„è©±ï¼Œé è¨­å€¼å¦‚ä¸‹æ‰€åˆ—ï¼Œæ•…å–®å°æœ€å¤§å¯é–‹æª”æ•¸é‡ç‚º 1048576ï¼Œç´„ C1000K</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Level</th>
<th style="text-align: center;">Parameters</th>
<th style="text-align: center;">Value</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OS</td>
<td style="text-align: center;">sysctl -n fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td>ç•¶å‰ç³»çµ±æœ€å¤§å¯é–‹æª”æ•¸é‡</td>
</tr>
<tr>
<td style="text-align: center;">Process</td>
<td style="text-align: center;">sysctl -n fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td>å–®ä¸€ç¨‹åºå¯é–‹æª”æœ€å¤§æ•¸é‡ï¼Œä¸€å®šè¦æ¯” hard nofile å¤§</td>
</tr>
<tr>
<td style="text-align: center;">User</td>
<td style="text-align: center;">ulimit -n</td>
<td style="text-align: center;">1048576</td>
<td>ç•¶å‰ä½¿ç”¨è€…å¯é–‹æª”æœ€å¤§æ•¸é‡</td>
</tr>
</tbody>
</table>
<p>ç¶­æŒ 1 å€‹ TCP Connection ç´„ç•¥æ¶ˆè€— 3.3 KB çš„è¨˜æ†¶é«”ï¼Œæ•…å‡è¨­å…¨éƒ¨ 1048576 éƒ½é–‹èµ·ä¾†çš„è©±ï¼Œä¿æŒ Long Lived TCP Connectionï¼Œä½†éƒ½æ²’å‚³è¼¸å…¶ä»–æ±è¥¿çš„è©±ï¼Œå¤§æ¦‚å°± 3.3 GB = 1048576 * 3.3 KBï¼Œä½†é€™æ˜¯ç†æƒ³å€¼ï¼Œå¯¦éš›ä¸Šæœƒå¤§ä¸€é»ï¼Œç”±æ­¤å¯çŸ¥ï¼Œé€£ç·šæ•¸é‡çš„å¤šå¯¡å…¶å¯¦é‚„æœ‰å—é™æ–¼è¨˜æ†¶é«”çš„å¤šå¯¡ï¼Œè€Œéåƒ…å—ä¸Šè¿°çš„é–‹æª”æ•¸é‡é™åˆ¶</p>
<h4 id="q6-1048576-50-tcp-connection-tcp-connection-1-kbs"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q6-1048576-50-tcp-connection-tcp-connection-1-kbs">Q6: å¦‚æœ 1048576 æœ‰ 50% æ´»èº TCP Connectionï¼Œæ¯å€‹ TCP Connection éœ€è¦å‚³ 1 KB/s çš„è³‡æ–™ï¼Œé€™æ¨£ç¶²å¡éœ€è¦å¤šå¤§?</a></h4>
<p>é€™å€‹è¦ç®—é »å¯¬ (Bandwidth)ï¼Œä¹Ÿå°±æ˜¯è¦ç®—æ°´ç®¡çš„å¤§å°ï¼Œé€™ç¯‡æœ‰ä¸€å€‹å°å¼Ÿæ—©æœŸå¸¸ç”¨çš„è¡¨ <a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></p>
<p><img alt="" src="/images/throughput-bandwidth.png" /></p>
<p>[(1048576 TCP Connection * 50% * 1KB/s) / 1024] = 512 MB/s * 8 bits = 4096 Mbps = 4 Gbps</p>
<p>æœ€å°‘ä½ ä¹Ÿè¦æœ‰ 4 Gbps Bandwidth æ‰èƒ½æ‰¿å—é€™å€‹é‡é«”ï¼Œè€Œ Azure VM çš„ç¶²è·¯é »å¯¬æ˜¯åŸºæ–¼ Instance çš„é¸æ“‡ä¸åŒï¼Œè€Œä¸æ˜¯çœ‹å…§å»ºç¶²å¡çš„è¨­å®š (ethtool eth0)ï¼Œæ‰€ä»¥å¯å¾ <a href="https://learn.microsoft.com/zh-tw/azure/virtual-machines/dasv5-dadsv5-series">Dasv5 å’Œ Dadsv5 ç³»åˆ—</a> ä¸­çš„ <code>Standard_D4as_v5</code> çš„æœ€å¤§ç¶²è·¯é »å¯¬ (Max network bandwidth) å¯å¾—çŸ¥ç‚º 12500 Mbpsï¼Œé å¤§æ–¼æ‰€éœ€çš„ 4096 Mbpsï¼Œæ•…é€™å° Standard_D4as_v5 æ˜¯å¯ä»¥æ”¯æ´å•é¡Œæ‰€éœ€çš„è³‡æ–™å‚³è¼¸é‡</p>
<p>æ­¤å¤–ï¼Œå¦‚æœä½ åœ¨ AKS é›†ç¾¤å¤–é¢æœ‰ç”¨ UDR ä¸Ÿçµ¦ Azure Firewall çš„è©±ï¼Œæ ¹æ“š <a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a> çš„æ¯”è¼ƒè¡¨ï¼Œä½ éœ€è¦é¸æ“‡ SKU æœ€å°ç‚º Standard (30 Gbps) æˆ– Premium (100 Gbps)ï¼Œè€Œä¸èƒ½é¸ Basicï¼Œä¸ç„¶æ•´å€‹é »å¯¬æœƒå¡åœ¨ 250 Mbps</p>
<h4 id="q7-ulimit-n"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q7-ulimit-n">Q7: å¦‚ä½•èª¿æ•´ ulimit -n çš„å€¼?</a></h4>
<p>å¦‚æœä½ æ˜¯ç”¨ AKS çš„ä½¿ç”¨è€…ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¸ç”¨æ”¹ï¼Œé è¨­ä¸€é–‹å§‹éƒ½å¼„å¥½äº†</p>
<p>å¦‚æœä½ æ˜¯è‡ªæ¶ä½œæ¥­ç³»çµ±çš„ï¼Œå°±ç…§ä¸‹é¢çš„è¨­å®šå³å¯</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># å¦‚æœæ²’ç‰¹åˆ¥èª¿éçš„ï¼Œæ‡‰è©²éƒ½æ˜¯ 1024 ç‚ºä¸»ï¼Œè­¬å¦‚åƒ RHEL 9.2 å’Œ RHEL 8.8 å°±æ˜¯é€™æ¨£</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="m">1024</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="c1"># å…©è€…å–å…¶ä½</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>$<span class="w"> </span>vim<span class="w"> </span>/etc/security/limits.conf
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>*<span class="w"> </span>soft<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>*<span class="w"> </span>hard<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="c1"># ä¸ç”¨ rebootï¼Œç™»å‡ºå†ç™»å…¥å°±å¥½</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>$<span class="w"> </span>logout<span class="p">;</span><span class="w"> </span>login
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="m">1048576</span>
</code></pre></div>
<h3 id="reference"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#reference">Reference</a></h3>
<ul>
<li><a href="https://lotabout.me/2021/Linux-Available-Memory/">æˆ‘çš„å†…å­˜å‘¢ï¼ŸLinux MemAvailable å¦‚ä½•è®¡ç®—</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux">Guidance for mitigating silicon based micro-architectural and speculative execution side-channel vulnerabilities</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></li>
<li><a href="https://github.com/microsoft/CBL-Mariner">microsoft/CBL-Mariner</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#linux-kubelet-custom-configuration">è‡ªè¨‚ Azure Kubernetes Service (AKS) ç¯€é»é›†å€çš„ç¯€é»è¨­å®š - Linux Kubelet è‡ªè¨‚è¨­å®š</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a></li>
<li><a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a></li>
<li><a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a></li>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">å¦‚ä½•ç§‘å­¸åœ°ä¼°ç®— Kubernetes æ‰€éœ€çš„è³‡æº? App è§’åº¦ç¯‡</a></li>
<li><a href="https://time.geekbang.org/column/article/262085">ç¬¬315æœŸ | ä»€ä¹ˆæ˜¯C10Kï¼Ÿå¦‚ä½•åšåˆ°C1000Kï¼Ÿ</a></li>
<li><a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></li>
<li><a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">Green Software Practitioner - Increasing device utilization</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-13 00:00:00">October 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">äººå®¶éƒ½åœ¨æŠ“ç¥å¥‡å¯¶è²ï¼Œè€Œæˆ‘åœ¨æŠ“ Kubernetes å°åŒ…</a></h2>
<blockquote>
<p>Wireshark: Packet Don't Lie.</p>
</blockquote>
<p><img alt="" src="/images/life-is-hard.jpg" /></p>
<p>æ–‡ç«  <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a> æåˆ°å¦‚ä½•é ç«¯æŠ“å–®é«” VM å°åŒ…ï¼Œé‚£åŒæ¨£çš„æ‹›æ•¸å¯ä¸å¯ä»¥å»æŠ“ Azure Kubernetes Service ç‰¹å®š Pod è£¡é¢çš„å°åŒ…? ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œæ­é… ksniff ä¾†åšå°±å¥½</p>
<!--more-->

<h3 id="kubernetes_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#kubernetes_1">ä¾†æŠ“ Kubernetes å°åŒ…</a></h3>
<h4 id="_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_1">æ¶æ§‹åœ–</a></h4>
<p><img alt="" src="/images/w9.png" /></p>
<ol>
<li>å› ç‚ºæˆ‘ä¸èƒ½ç›´æ¥å¾å®¶è£¡é€£ç·šåˆ° Azure Kuberentes Serviceï¼Œæ‰€æœ‰æ“ä½œéƒ½éœ€è¦é€é Bastion VM é€²è¡Œæ“ä½œé€£ç·šï¼Œæ‰€ä»¥éœ€è¦å…ˆç”¨ SSH é€£ç·šåˆ° Bastion VM æ‰èƒ½åšäº‹</li>
<li>kubectl ä¸€å®šè¦èƒ½å° Private AKS æ“ä½œï¼Œä¸ç„¶ ksniff æˆ–ç¨‹å¼ä½ éƒ½ç„¡æ³•éƒ¨ç½²ä¸‹å»</li>
<li>æ•´å¼µåœ–æˆ‘æ²’æçš„éƒ¨åˆ†å°±æ˜¯ Private AKS å’Œ VM çš„ UDR è¨­å®šï¼Œä½†é€™å€‹å¤ª Azure Networking å…ˆè·³é</li>
<li>ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘æ˜¯å¼·çƒˆå»ºè­°äººäººéƒ½è¦æœ‰ä¸€å€‹ debug container å¥½å»åšä¸€äº›è§€è½é™°çš„äº‹æƒ…ï¼Œè©³è¦‹ <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a>ï¼Œé€™é‚Šä¸è´…è¿°</li>
</ol>
<h4 id="0-ksniff"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#0-ksniff">0. å®‰è£ ksniff</a></h4>
<p>è«‹ç›´æ¥åƒè€ƒ <a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a> æ–‡ä»¶ï¼Œå¦å¤–å®ƒçš„å‰ç½®ä½œæ¥­æ˜¯è¦è£ <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a>ï¼Œå‹™å¿…è¦æŠŠ krew PATH è¨­å®šå¥½</p>
<h4 id="1-httpbin-re"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#1-httpbin-re">1. éƒ¨ç½² httpbin-re æœå‹™</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># ç¢ºå®š kubectl é‹ä½œæ­£å¸¸ä¸”å¯ä»¥é€£ç·šåˆ° Private AKS</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Kubernetes<span class="w"> </span>control<span class="w"> </span>plane<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>CoreDNS<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>Metrics-server<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1"># è·‘ä¸€å€‹ http server æœå‹™èµ·ä¾†</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/httpbin-re/master/k8s/httpbin-re.yaml
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>deployment.apps/httpbin-re<span class="w"> </span>created
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>service/httpbin-re<span class="w"> </span>created
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="c1"># ç¢ºèªæœå‹™æœ‰æ­éœ²å‡ºä¾†</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>httpbin-rek
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>NAME<span class="w">         </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">    </span>AGE
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>httpbin-re<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.0.133.240<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">8080</span>/TCP<span class="w">   </span>7h26m
</code></pre></div>
<p>ä¸»è¦æ˜¯è¦éƒ¨ç½²ä¸€å€‹ HTTP Serverï¼Œå¾…æœƒè¦é€é Ksniff å»è§€å¯Ÿé€™å€‹æœå‹™çš„ç‹€æ³ï¼Œå¦‚æœä½ æœ‰å…¶ä»–æœå‹™ä¹Ÿå¯ä»¥è‡ªè¡Œæ›¿æ›ï¼Œé€™é‚Šå°±æ˜¯ Demo æ–¹ä¾¿</p>
<h4 id="2-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#2-pod">2. éƒ¨ç½²é™ªæ¸¬ç”¨ Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># éƒ¨ç½²é™ªæ¸¬ç”¨ Podï¼Œç”¨é †æ‰‹çš„å°±å¥½ï¼Œæˆ–è€…æ˜¯ä½ å¯ä»¥è€ƒæ…®ç”¨ nicolaka/netshoot</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/debug-container/master/debug-container.yaml
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>pod/debug-container<span class="w"> </span>created
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c1"># æ¸¬è©¦å¯ä»¥è·Ÿ httpbin-re é€£ç·šï¼ŒåŒ namespaceï¼Œä¸åŒ Pod</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl http://&lt;svc name&gt;/path</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default.svc:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>&lt;!DOCTYPE<span class="w"> </span>html&gt;
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>&lt;html<span class="w"> </span><span class="nv">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span>&gt;
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>...omit...
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c1"># æ¸¬è©¦å¯ä»¥è·Ÿ metrics-server é€£ç·šï¼Œä¸åŒ namespaceï¼Œä¸åŒ Pod</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl --insecure https://&lt;svc name&gt;.&lt;namespace&gt;:&lt;svc port&gt;/path</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system.svc:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="o">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">  </span><span class="s2">&quot;kind&quot;</span>:<span class="w"> </span><span class="s2">&quot;Status&quot;</span>,
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">  </span><span class="s2">&quot;apiVersion&quot;</span>:<span class="w"> </span><span class="s2">&quot;v1&quot;</span>,
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">  </span><span class="s2">&quot;metadata&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">  </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;Failure&quot;</span>,
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">  </span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/metrics\&quot;&quot;</span>,
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">  </span><span class="s2">&quot;reason&quot;</span>:<span class="w"> </span><span class="s2">&quot;Forbidden&quot;</span>,
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">  </span><span class="s2">&quot;details&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">  </span><span class="s2">&quot;code&quot;</span>:<span class="w"> </span><span class="m">403</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="o">}</span>%
</code></pre></div>
<p>é—œæ–¼é€™å€‹ä»¥ Pod ç‚ºå‡ºç™¼é»ï¼Œæœå‹™ä¹‹é–“çš„é€£ç·šè­°é¡Œï¼Œä»¥å‰æœ‰å¯«é<a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a> ä¸€æ–‡ï¼Œè£¡é¢æœ‰æ¯”è¼ƒä»”ç´°çš„èªªæ˜ï¼Œé€™é‚Šå°±ä¸è´…è¿°äº†</p>
<h4 id="3-httpbin-re-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#3-httpbin-re-pod">3. é ç«¯æŠ“ httpbin-re Pod çš„å°åŒ…</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># åˆ—èˆ‰å‡º httpbin-re Pod çš„åç¨±</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>-owide
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>NAME<span class="w">                          </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">     </span>IP<span class="w">            </span>NODE<span class="w">                                </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>debug-container<span class="w">               </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>15m<span class="w">     </span><span class="sb">`</span><span class="m">10</span>.0.129.18<span class="sb">`</span><span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>httpbin-re-866499b564-blc95<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="m">10</span>.0.129.6<span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>httpbin-re-866499b564-xl726<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="sb">`</span><span class="m">10</span>.0.129.9<span class="sb">`</span><span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>ksniff-grlzn<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>82s<span class="w">     </span><span class="m">10</span>.0.129.33<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>ksniff-n9ps6<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36m<span class="w">     </span><span class="m">10</span>.0.129.29<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># é€é ksniff ä¾†æŠ“å°åŒ…</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; &quot;/bin/bash --login -c &#39;kubectl sniff -n &lt;namespace&gt; &lt;pod name&gt; -p -o -&#39;&quot; | /mnt/c/Program\ Files/Wireshark/Wireshark.exe -k -i -</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span><span class="s2">&quot;/bin/bash --login -c &#39;kubectl sniff -n default httpbin-re-866499b564-xl726 -p -o -&#39;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p>é€™é‚Šè¦æ³¨æ„çš„æ˜¯ <code>/bin/bash --login -c</code>ï¼Œå› ç‚º SSH ç™»å…¥çš„æ™‚å€™åƒçš„ $PATH é è¨­æ˜¯ä¸æœƒå»åƒ ~/.bashrcï¼Œå¯ä»¥ç”¨ <code>env</code> é©—è­‰çœ‹çœ‹ï¼Œæ‰€ä»¥éœ€è¦å…ˆç”¨ <code>--login</code> å¾Œæ‰èƒ½æ­£ç¢ºå’¬åˆ° $PATH è£¡é¢çš„ krew è·¯å¾‘ï¼Œå…¶é¤˜å°±æ˜¯ pipeline å’Œ I/O çš„ä¸²æµè™•ç†äº†</p>
<p><img alt="" src="/images/w8.png" /></p>
<p>æ­¤å¤–ï¼ŒåŸå…ˆæ‡‰è©²è¦å¡« Ethernet Header (12 bytes) çš„æ¬„ä½ï¼Œæœƒè®Šæˆ <code>Linux cooked capture v2 (SLL_v2)</code>ï¼ŒæŒ‰ç…§ <a href="https://wiki.wireshark.org/SLL.md">Linux cooked-mode capture (SLL)</a> çš„èªªæ˜ï¼Œé€™æ˜¯ä¸€å€‹å½é€ å”è­°ï¼Œå°åˆ†æ Kubernetes ä¸Šçš„æœå‹™æ¯”è¼ƒæ²’ä»€éº¼å½±éŸ¿ï¼Œå› ç‚ºä¸»è¦éƒ½æ˜¯çœ‹ L3 / L4 å±¤ç´šå±…å¤šï¼ŒåŒ…å« Pod IP / Pod Port / Service IP / Service Port / Node Port ç­‰ï¼ŒåŒå ´åŠ æ˜ ä¸€ä¸‹ï¼Œ<a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">
HWCHIU å­¸ç¿’ç­†è¨˜ - Kubernetes ä¹‹å°åŒ…å»å“ªå…’</a></p>
<h4 id="4-ksniff-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#4-ksniff-pod">4. æ¸…é™¤ ksniff Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>NAME<span class="w">           </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>ksniff-g4bjz<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11m
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>ksniff-j7gnc<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>ksniff-kxfl5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m54s
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>ksniff-lb4xg<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>6m29s
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>ksniff-n9ps6<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>68m
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>ksniff-sph6l<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m17s
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>ksniff-v2vd5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>14m
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>ksniff-vl627<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-g4bjz&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-j7gnc&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-kxfl5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-lb4xg&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-n9ps6&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-sph6l&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-v2vd5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-vl627&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<p>é€€å‡ºçš„æ™‚å€™çœ‹èµ·ä¾†æ˜¯ä¸æœƒé †ä¾¿æŠŠ ksniff çš„ Pod ç§»é™¤æ‰ï¼Œè¨˜å¾—è¦æ‰‹å‹•ç§»é™¤ï¼Œä¸ç„¶æœƒæœ‰è³‡æºæµªè²»çš„å•é¡Œ</p>
<h3 id="_2"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_2">å¾Œè©±</a></h3>
<p>ksniff æ²’æœ‰åƒæ•¸å¯ä»¥è®“æˆ‘å»æå°åŒ…å¤§å°ï¼Œæ²’æ„å¤–çš„è©±ï¼Œé‚„éœ€è¦å†è·³æ¿æ©Ÿå¤šä¸€æ®µ tcpdump pipeline è™•ç†ï¼Œä½†é€™æ¨£å°±æœƒæ”¶åˆ°ä¸€å †æœ‰çš„æ²’çš„å°åŒ…ï¼Œé‚„æ²’æƒ³åˆ°æ€éº¼ç”¨</p>
<h3 id="qa"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#qa">Q&amp;A</a></h3>
<h4 id="q1-red-hat-openshift-container-platform-azure-red-hat-openshift"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#q1-red-hat-openshift-container-platform-azure-red-hat-openshift">Q1: å¦‚æœæˆ‘æ˜¯ Red Hat OpenShift Container Platform æˆ– Azure Red Hat OpenShift çš„ä½¿ç”¨è€…ï¼Œä½†æ¬Šé™é–è¶…åš´çš„æ€éº¼è¾¦?</a></h4>
<p>é€™å€‹åªèƒ½èªª Red Hat ä¸€å¦‚æ—¢å¾€åœ°å·²ç¶“å…ˆå¹«å¦³æ•´å¥½åˆ° oc å»äº†ï¼Œä½ ä¸ç”¨ç‰¹åˆ¥è£ ksniffï¼Œæ¬Šé™å°±æ˜¯ç…§ä½ æ‹¿åˆ°çš„ kubeconfig ç‚ºä¸»</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$ oc version
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Client Version: 4.12.36
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Kustomize Version: v4.5.7
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>Kubernetes Version: v1.27.3
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>$ oc sniff
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>Usage:
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  sniff pod [-n namespace] [-c container] [-f filter] [-o output-file] [-l local-tcpdump-path] [-r remote-tcpdump-path] [flags]
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>Examples:
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>kubectl sniff hello-minikube-7c77b68cff-qbvsd -c hello-minikube
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>Flags:
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>  -c, --container string                container (optional)
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>  -x, --context string                  kubectl context to work on (optional)
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>  -f, --filter string                   tcpdump filter (optional)
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>  -h, --help                            help for sniff
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>      --image string                    the privileged container image (optional)
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>  -i, --interface string                pod interface to packet capture (optional) (default &quot;any&quot;)
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>  -l, --local-tcpdump-path string       local static tcpdump binary path (optional)
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>  -n, --namespace string                namespace (optional)
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>  -o, --output-file string              output file path, tcpdump output will be redirect to this file instead of wireshark (optional) (&#39;-&#39; stdout)
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>      --pod-creation-timeout duration   the length of time to wait for privileged pod to be created (e.g. 20s, 2m, 1h). A value of zero means the creation never times out. (default 1m0s)
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>  -p, --privileged                      if specified, ksniff will deploy another pod that have privileges to attach target pod network namespace
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>  -r, --remote-tcpdump-path string      remote static tcpdump binary path (optional) (default &quot;/tmp/static-tcpdump&quot;)
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>      --socket string                   the container runtime socket path (optional)
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>      --tcpdump-image string            the tcpdump container image (optional)
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>  -v, --verbose                         if specified, ksniff output will include debug information (optional)
</code></pre></div>
<h3 id="references"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a></li>
<li><a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a></li>
<li><a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a></li>
<li><a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">ç‚ºä»€éº¼æˆ‘ä½ˆç½²çš„ Kubernetes æœå‹™ä¸æœƒå‹•!? å€‹äººé™¤éŒ¯æ€è·¯åˆ†äº«</a></li>
<li><a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">Kubernetes ä¹‹å°åŒ…å»å“ªå…’</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-12 00:00:00">October 12, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/sustainability/" class="md-meta__link">sustainability</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/">æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹: é ç«¯æŠ“å°åŒ…å¯¦éŒ„</a></h2>
<p><img alt="" src="/images/cnsw.png" /></p>
<p>æœ€è¿‘å› ç‚º 10/24 è¦è¾¦ <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">CNCF Sustainability Week - Taiwan x Green Software Foundation</a> æ´»å‹•ï¼Œçœ‹äº†ä¸€å † ESG ç›¸é—œçš„æ²»ç†æ–‡ç« å’ŒæŠ€è¡“æ›¸ï¼Œå› ç‚ºå‰›å¥½æœ‰äº›å®¢æˆ¶æ˜¯åšè·¨åœ‹ç”Ÿæ„çš„ï¼Œé²æ—©æœƒç¢°åˆ°å’Œè¢«å•åˆ°é€™å€‹è­°é¡Œï¼Œæ‰€ä»¥å°±å¾æ¯”è¼ƒå¸¸æ¥è§¸ç¶²è·¯è‘—æ‰‹çœ‹äº†ä¸€ä¸‹å¯¦å‹™ä¸Šæ€éº¼åšï¼Œç¯€èƒ½æ¸›ç¢³å…ˆå¾å°‘æ”¶å°åŒ…é–‹å§‹</p>
<!--more-->

<h3 id="cncf-sustainability-week-taiwan-x-green-software-foundation"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#cncf-sustainability-week-taiwan-x-green-software-foundation">[æ´»å‹•å®£å‚³] CNCF Sustainability Week - Taiwan x Green Software Foundation</a></h3>
<p>å¤§å®¶çŸ¥é“è¿‘å¹´ç¢³æ’æ”¾è­°é¡Œé¢¨é¢¨ç«ç«ï¼Œå¾æ—©æœŸä¸çŸ¥é“åœ¨å¹¹å˜›çš„ï¼Œåˆ°æ­ç›Ÿå¾ 2023/10 æœˆè©¦é‹è¡Œ<code>ç¢³é‚Šå¢ƒèª¿æ•´æ©Ÿåˆ¶ (Carbon Border Adjustment Mechanism, CBAM)</code>ï¼Œè€Œç¾åœ‹ 2024/1/1 è¦æ­£å¼å¯¦æ–½ <code>æ¸…æ½”ç«¶çˆ­æ³•æ¡ˆ (Clean Competition Act, CCA)</code>ï¼Œè¦æŠ½ç¢³é—œç¨…ï¼Œç›®å‰ç‰Œåƒ¹ 55 USD/Kg CO2eqï¼Œè¦ç”¨ä¾†æ¸›å°‘æ°£å€™æ±™æŸ“å•¦(æˆ–å…¶ä»–æˆ‘ä¹Ÿä¸çŸ¥é“çš„ç”¨é€”?)~</p>
<p>ä½ ä¸€å®šæƒ³èªªé€™è·ŸæŠ€è¡“æ‰“å·¥äººå“¡å•¥äº‹ï¼Œå°¤å…¶æ˜¯ Cloud Native é€™é‚Šï¼Œç•¶ä½ æœ‰é€™å€‹æƒ³æ³•çš„æ™‚å€™ï¼Œä¸å¦‚å°±è¶•å¿«<a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">å ±å 2023/10/24 ç·šä¸‹æ´»å‹•!!!</a>ï¼Œç•¶å¤©æœ‰å…¬å¸æœƒè´ŠåŠ© Pizzaï¼Œæ­¡è¿ä¾†åƒæ±è¥¿å…¼èŠå¤©</p>
<h3 id="_2"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_2">ç·£èµ·</a></h3>
<p>å› ç‚ºæˆ‘åœ¨ Target VM æ˜¯ç”¨ RHEL 9.2 é€²è¡Œæ—¥å¸¸å·¥ä½œï¼Œæ²’æœ‰ X.org / Gnome å¯ä»¥ç”¨ï¼Œæœ‰æ™‚å€™è¦åœ¨è‡ªå·±é›»è…¦ä¸Šç”¨ Wireshark çœ‹å°åŒ…è¦æ‹‰ä¾†æ‹‰å»å¾ˆä¸ç¯€èƒ½æ¸›ç¢³ï¼Œæ‰€ä»¥ç‚ºäº†æ–¹ä¾¿è‡ªå·±å’Œç¢ºä¿è³‡æ–™å‚³è¼¸å®‰å…¨ï¼Œå°±æ‹¿å‡º ssh tunnel + linux pipeline å¤§æ³•ä¾†åšã€‚é€™å€‹æ–¹å¼ä¸éœ€è¦ä½¿ç”¨ rpcapdï¼Œä½ åªè¦æœ‰ sshd + tcpdump å°±å¯ä»¥äº†</p>
<p>ä½†å› ç‚º Azure Egress æ–¹å‘è³‡æ–™å‚³è¼¸æœ‰ç®—è²»ç”¨ï¼Œé‚„æ˜¯è¦ç²¾æ‰“ç´°ç®—ï¼Œé †ä¾¿ç¯€èƒ½æ¸›ç¢³ï¼Œæ‰€ä»¥æ‰æœ‰é€™ç¯‡æ–‡ç« çš„èª•ç”Ÿ</p>
<p>é è¨­ç‹€æ³ä¸‹ï¼Œä¸€å€‹ TCP å°åŒ…ä¸Šé™æ˜¯çœ‹ Maximum Segment Size (MSS) æ­£å¸¸ç‹€æ³ä¸‹ä¸Šé™ç‚º 1460 (MTU 1500 - IP Header 20 - TCP Header 20)ï¼Œå…ˆä¸è€ƒæ…®ä¸­é–“è¢« MSS clampingï¼Œè­¬å¦‚ä»€éº¼ PPPoE é‚„æ˜¯æŸè¨­å‚™å·æ”¹çš„ç‹€æ³ã€‚è‹¥æˆ‘åªæ˜¯è¦å–®ç´”æŸ¥ä¿®ç¶²è·¯çš„è©±ï¼Œè­¬å¦‚åªæ˜¯è¦è§€æ¸¬ TCP Retransmission / Duplicated ACK ç­‰ï¼Œå…¶å¯¦æˆ‘ä¸éœ€è¦æŠŠå…¨éƒ¨ Frame æ”¶æ»¿æ”¶å¥½æ‰èƒ½çŸ¥é“ç‹€æ³ï¼Œæˆ‘åªè¦èƒ½æ”¶åˆ°å‰æ®µ TCP Header å°±å¯ä»¥çŸ¥é“ç¶²è·¯è¡Œç‚ºäº†ï¼Œæ‰€ä»¥é æœŸä¸Šåªè¦æ¯å€‹ Frame æ”¶ 74 bytes æˆ‘å°±å¯ä»¥è§€æ¸¬ç‹€æ³äº†ï¼Œå¯ä»¥ç¯€çœ 20.45 å€ (1512 / 74) çš„ç¶²è·¯å‚³è¼¸å’Œå„²å­˜æˆæœ¬</p>
<p>è©¦æƒ³å¦‚æœåŸå…ˆåªèƒ½ç›£æ§ 1 å°æ™‚ï¼Œé€éé™åˆ¶ Frameï¼ŒåŒæ¨£å‚³è¼¸å’Œå„²å­˜æˆæœ¬ï¼Œå¯ä»¥ç›£æ§ 20 å°æ™‚ä»¥ä¸Šï¼Œç›¸ç•¶å…·å‚™åŸ·è¡Œå‹•åŠ›</p>
<h4 id="_3"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_3">æ—¢æœ‰æ¶æ§‹åœ–åŠè¦é»æç¤º</a></h4>
<p><img alt="" src="/images/w5.png" /></p>
<ul>
<li>a. å…§éƒ¨ WSL2 èˆ‡å¤–éƒ¨ Windows 11 ç’°å¢ƒåƒæ•¸å’ŒåŸ·è¡Œ: å› ç‚º WSL å…§çš„ç’°å¢ƒå¯ä»¥è¦–åŒæ–¼åœ¨ä¸€å°è™›æ“¬æ©Ÿä¸Šé¢ï¼ŒåŒ…å«åƒ SSH ç’°å¢ƒè®Šæ•¸ã€ç­‰ PATH éƒ½æœƒè·Ÿå¤–éƒ¨çš„ Windows 11 ä¸åŒï¼Œæ•…å¾ WSL2 è¦å° Windows 11 åŸ·è¡Œ Wireshark åœ–å½¢ä»‹é¢çš„è©±ï¼Œå› ç‚ºé è¨­ WSL2 çš„ PATH ä¸¦æ²’æœ‰è·Ÿå¤–éƒ¨ Windows 11 æœ‰ç›¸é€šï¼Œæ‰€ä»¥æœ€å¿«çš„ä½œæ³•å°±æ˜¯è¦ç”¨çµ•å°è·¯å¾‘ä¸” Linux çœ‹å¾—æ‡‚ <code>/mnt/c/Program\ Files/Wireshark/Wireshark.exe</code> åŸ·è¡Œç¨‹å¼ï¼Œæˆ–è€…æ˜¯ä½ æŠŠ Windows 11 çš„é‚£ä¸€å † PATH å¡åˆ° WSL2 ä¹Ÿå¯ä»¥</li>
<li>b. æ„›ç”¨ SSH Key: é€™å€‹è€æ¢—äº†ï¼Œè«‹æ„›ç”¨ <code>ssh-copy-id</code> å¯¦è¸å…å¯†ç¢¼ç™»å…¥ï¼›å¦‚æœè¦åšåˆ°é›¶ä¿¡ä»»çš„è©±ï¼Œå°±æŠŠ AAD Identity æ›é€²å»</li>
<li>c. DNAT: åŸºæ–¼å®‰å…¨æ§ç®¡å’Œæˆæœ¬è€ƒé‡ï¼Œæˆ‘ç”¨ DNAT ç‚ºä¸»ï¼›å¦‚æœè¦åšåˆ°é›¶ä¿¡ä»»çš„è©±ï¼Œæ‡‰è©²è¦ç”¨ <code>Azure Bastion</code>ï¼Œä½†é€™ç’°å¢ƒæˆ‘è‡ªå·±ç”¨è€Œå·²ï¼Œæˆ‘ä¿¡ä»»æˆ‘è‡ªå·±</li>
<li>d. tcpdump éœ€è¦ root æ¬Šé™: tcpdump éœ€è¦ç‰¹æ¬Šæ‰èƒ½ä½¿ç”¨ï¼Œä¸ç„¶æœƒå™´ <code>tcpdump: eth0: You don't have permission to capture on that device</code> çµ¦ä½ çœ‹ï¼Œå› ç‚ºæˆ‘çš„ SSH Key æ˜¯ç¶ Normal Userï¼Œä¸¦æ²’æœ‰ç‰¹åˆ¥å° root åšä»€éº¼è¨­å®šï¼Œæˆ‘æ˜¯æ¡ç”¨ <code>NOPASSWD: ALL</code> è™•ç†ï¼Œä¸Šç­ä¸è¦å­¸</li>
</ul>
<h4 id="1"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#1">1. æˆ‘å…¨éƒ½è¦æ”¶ä¸‹ä¾†!!!</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s0 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s0<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p>é€™å€‹æ‡‰è©²æ˜¯æœ€ç›´è¦ºçš„åšæ³•ï¼Œä½†å¦‚æœä½ æ¸¬è©¦çš„æ–¹å¼æœ‰ä¸Šå‚³å’Œä¸‹è¼‰å¤§æª”å‚³è¼¸çš„æ™‚å€™ï¼Œä¿è­‰å‚³å‡ºä¾†è¶…å¤§è¶…èƒ–ï¼Œä¸ç¬¦åˆæœ¬æ–‡æ¸›ç¢³æ•ˆç›Šï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å°é€™å€‹å‚³è¼¸é€²è¡Œç²¾ç…‰ç˜¦èº«ï¼Œæœ€ç›´è¦ºçš„æ–¹å¼å°±æ˜¯ç”¨ tcpdump å…§å»ºçš„åƒæ•¸ <code>-s, --snapshot-length</code> é€²è¡Œæ§åˆ¶ï¼Œé è¨­ç‹€æ³ä¸‹ï¼Œ<code>-s0</code> æ˜¯å¯ä»¥æ”¶ä¸‹ 252144 bytesï¼Œç‚ºäº†ç›¸å®¹æ—©æœŸç‰ˆæœ¬çš„ tcpdump</p>
<h4 id="2-tcp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#2-tcp">2. å–®ç´”çœ‹ TCP äº¤æ¡ç‚ºä¸»</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s74 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s74<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w1.png" /></p>
<p>ä»¥ IPv4 + TCP ç‚ºä¾‹, ä¸€å€‹ Frame çµ„æˆå¦‚ä¸‹:</p>
<ul>
<li>Ethernet Header = 14 bytes (112 bits)</li>
<li>IP Header = 20 bytes (160 bits)</li>
<li>TCP Header = æœ€å° 20 bytes (160 bits)ï¼Œå»ºè­° 40 bytes (320 bits)ï¼Œå› ç‚º TCP Header æœ€å°ç®—åˆ° Urgent Pointer æ˜¯ 20 bytesï¼Œä½†æ˜¯é€šå¸¸éƒ½æœƒæœ‰ä¸€å † TCP Option çš†åœ¨å¾Œé¢ï¼Œè­¬å¦‚èªªåƒ Window Scaleã€SACKã€MSS éƒ½æœƒæ”¾åœ¨é€™é‚Šï¼Œæ‰€ä»¥æœ€å¤§å¯èƒ½æœƒåˆ° 40 bytes æˆ–è¶…é</li>
<li>TCP Payload å¦è¨ˆ</li>
</ul>
<p><img alt="" src="/images/w2.png" /></p>
<p>æ‰€ä»¥ä»¥ç¶²è·¯åœ˜éšŠï¼Œä¸è€ƒæ…®è§€æ¸¬ TCP Payloadï¼Œé•·æœŸæ”¶å°åŒ…åˆ†æ TCP Stream ç‹€æ³çš„è©±ï¼Œå»ºè­°è¨­å®šå€‹ 74 bytes (14 + 20 + 40) ä»¥ä¸Šï¼Œæ‰ä¸æœƒæœ‰ TCP Header è¢«æˆªæ–·çš„è­°é¡Œç™¼ç”Ÿï¼Œä¹Ÿä¸æœƒæ”¶äº†ä¸€å † TCP Payload ä½”æ“šå„²å­˜ç©ºé–“å’Œå‡ºç«™æµé‡ã€‚è€Œè¢«æˆªæ–·çš„å°åŒ…å…§å®¹åœ¨ Wireshark æœƒå‘ˆç¾ <code>Packet Size Limited during capture</code> é€™æ˜¯æ­£å¸¸ç‹€æ³</p>
<h4 id="3-http-header"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#3-http-header">3. æƒ³è¦çœ‹ HTTP Header</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s500 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s500<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w6.png" /></p>
<p>å–æè‡³ <a href="https://blog.bytebytego.com/p/how-does-https-work-episode-6">ByteByteGo - How does HTTPS work? (Episode 6)</a></p>
<p>æˆ‘ä¸æœƒç”¨ http filter å»éæ¿¾å†æ”¶ï¼Œé‚„æ˜¯æ”¶ tcp ç‚ºä¸»ï¼Œå¾Œé¢ç”¨ tcp.stream éæ¿¾ã€‚é€™åŸå› æ˜¯ filter å–®ç”¨ http çš„è©±ï¼Œæœƒçœ‹ä¸åˆ° <code>http GET / HTTP1.1</code> ä¹‹å‰çš„ TCP Handshake ä¸­ SYN / SYNACK / ACK çš„ç‹€æ³ï¼Œå¤§å¤šæ•¸ç‹€æ³éƒ½ä¸æ˜¯ç¨‹å¼æ²’å¯«å¥½ï¼Œéƒ½æ˜¯ TCP é‚£å±¤è¢«æŸå€‹é˜²ç«ç‰†æ“‹æ‰ï¼Œä½†çœ‹ L7 æˆ–åªçœ‹ HTTP æœƒçœ‹ä¸å‡ºä¾†ï¼Œå¦‚ä¸‹ No. 448, 449, 450 é‚£ä¸‰å€‹å°åŒ…</p>
<p><img alt="" src="/images/w7.png" /></p>
<p>è‡³æ–¼ HTTP Header è¦å¤šå¤§ï¼Œæˆ‘çš„ç†è§£æ˜¯å› æœå‹™è€Œå®šï¼Œæœ‰äº›æœå‹™æˆ– CDN æœƒå¡ä¸€å † Header å†å‰é¢ï¼Œå¯ä»¥è‡ªè¡Œèª¿æ•´å¤§å°ï¼Œæˆ‘é€™é‚Šå°±æŠ“ä¸€å€‹ 500 åŠ æ¸›çœ‹</p>
<h4 id="4-icmp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#4-icmp">4. å–®ç´”çœ‹ ICMP ç‚ºä¸»</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s98 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s98<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w3.png" /></p>
<p>ä»¥ IPv4 + ICMP ç‚ºä¾‹ï¼Œä¸€å€‹ Frame çµ„æˆå¦‚ä¸‹:</p>
<ul>
<li>Ethernet Header = 14 bytes (112 bits)</li>
<li>IP Header = 20 bytes (160 bits)</li>
<li>ICMP Header = 8 bytes</li>
<li>ICMP Data = æœ€å°é€å‡ºå» 56 bytesï¼ŒICMP Timestamp æ˜¯æ”¾åœ¨ ICMP Data è£¡é¢çš„å‰ 8 bytesï¼Œä½† Wireshark è£¡é¢çš„ Data æœƒé¡¯ç¤º 48 bytesï¼Œä½†å›ä¾†çš„è³‡è¨Šä¸ä¸€å®šæ˜¯ 56 Bytes è€Œå·²ï¼Œæœ‰å¯èƒ½æœƒæ”¶åˆ°æ€ªæ€ªçš„å°åŒ… (Malformed Packet) æœƒå¡è¶…éé€™å€‹æ•¸å­—ä»¥ä¸Š</li>
</ul>
<p><img alt="" src="/images/w4.png" /></p>
<p>é‘’æ–¼ä»¥ä¸Šå¥‡æ€ªçš„ç‹€æ³ç¸½å’Œï¼Œè‹¥è¦æ”¶åˆ°ç²¾ç°¡çš„ ICMP å°åŒ…çš„è©±ï¼Œæ‡‰è©²æ˜¯è¦è¨­å®š 98 bytes (14 + 20 + 8 + 56) ä»¥ä¸Šå¥½ä¸€é»</p>
<h3 id="_4"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_4">çµè«–</a></h3>
<ol>
<li>ssh çœŸçš„å¾ˆè¬ç”¨</li>
<li>æ”¶å°åŒ…é™åˆ¶å€‹ Frame Size 500ï¼Œå¯ä»¥ç¯€çœ 70% çš„æ¶ˆè€—ï¼Œé‚„æœ‰ä¸äºæ–¼å…¨æ”¶ (1512) çš„è§€æ¸¬æ•ˆæœ</li>
<li>ç¯€èƒ½æ¸›ç¢³ï¼Œå…ˆå¾åƒåŠ  <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">CNCF Sustainability Week - Taiwan x Green Software Foundation</a> é–‹å§‹</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#qa">Q&amp;A</a></h3>
<h4 id="q1-azure-windows-vmrdp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q1-azure-windows-vmrdp">Q1: ç‚ºä½•ä¸è¦åœ¨ Azure è£¡é¢é–‹ Windows VMï¼ŒRDP é€²å»å°±å¥½?</a></h4>
<p>å› ç‚º Windows Server æˆ‘ä¸ç®—ç†Ÿæ‚‰ï¼Œlinux æ¯”è¼ƒé¦™</p>
<h4 id="q2-sustainability-engineering-cloud-native-sustainability"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q2-sustainability-engineering-cloud-native-sustainability">Q2: æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹ (Sustainability Engineering) é‚„æ˜¯é›²åŸç”Ÿæ°¸çºŒæ€§ (Cloud Native Sustainability) é€™è·Ÿæˆ‘å•¥é—œä¿‚?</a></h4>
<p>ç›®å‰ä¾†çœ‹ï¼Œåèˆ‰ç‰½æ‰¯åˆ°æ°¸çºŒæ€§ (Sustainability) çš„è­°é¡Œï¼Œæœ€å¤§ç›®æ¨™å°±æ˜¯è¦ç›¡å¯èƒ½æ¸›å°‘ç¢³è¶³è·¡ï¼Œå°±ç®—æœƒé€ æˆæ•ˆèƒ½è®Šæ…¢ã€æˆ–è€…æ˜¯å»¶é²å¢åŠ ï¼Œéƒ½æ˜¯å¯ä»¥è¢«æ¥å—çš„ã€‚ä»¥ç¶²è·¯ä¾†çœ‹ï¼Œå°±æ˜¯ç›¡é‡æ¸›å°‘ä¸å¿…è¦çš„ç¶²è·¯å‚³è¼¸æˆ–è² è¼‰ï¼Œå®ƒçš„é™„å¸¶æ•ˆç›Šç›®å‰çœ‹èµ·ä¾†å°±æ˜¯é™ä½æˆæœ¬ã€å„ªåŒ–æ—¢æœ‰æŠ€è¡“</p>
<h4 id="q3-sustainability"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q3-sustainability">Q3: Sustainability ç­‰æ–¼æˆæœ¬é™ä½?</a></h4>
<p>åš´æ ¼ä¾†èªªï¼Œä¸æ˜¯å°ç­‰çš„ï¼Œç‚ºäº†è¦å»åš Sustainability å¯èƒ½è¦åœ¨åˆ¥çš„åœ°æ–¹æŠ•è³‡ä¸å°‘ï¼Œé›–ç„¶ä¸»è¦çœ‹èµ·ä¾†éƒ½æ˜¯è·Ÿç¶ é›»ç›¸é—œã€‚è­¬å¦‚èªªï¼ŒåŸå…ˆæœå‹™æ”¾åœ¨è€é çš„å€åŸŸï¼Œä½†ç‚ºäº†<code>æ¥µç«¯åŒ–</code>é”åˆ°æ°¸çºŒæ€§å·¥ç¨‹ï¼Œé™ä½ä¸å¿…è¦çš„ç¶²è·¯å‚³è¼¸ï¼Œé¸æ“‡æŠŠ CDN æœå‹™å…¨éƒ¨é–‹èµ·ä¾†ï¼Œé€™æˆæœ¬å°±æœƒèŠ±åœ¨åˆ¥çš„åœ°æ–¹äº†ã€‚ä½†ç›®å‰ç¢³é—œç¨…æœ‰å…¬é–‹ç‰Œåƒ¹å¯ä»¥æ¨ç®—ï¼Œèªªä¸å®šç®—ä¸€ç®—çœŸçš„æœ‰å€‹é»ƒé‡‘äº¤å‰ï¼Œåªæ˜¯æˆ‘ç¾åœ¨æ²’ç²¾ç®—çš„å¾ˆæ¸…æ™°</p>
<h3 id="references"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#references">References</a></h3>
<ul>
<li><a href="https://stackoverflow.com/questions/1097651/is-there-a-practical-http-header-length-limit/6160643#6160643">Is there a practical HTTP Header length limit?</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/aks/concepts-sustainable-software-engineering#reduce-network-traversal-between-nodes">Azure Kubernetes Service (AKS) ä¸­çš„æ°¸çºŒæ€§è»Ÿé«”å·¥ç¨‹åšæ³•</a></li>
<li><a href="https://principles.green/">Green Software Practitioner</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-13 00:00:00">July 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="distroless-container-kubectl-debug"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">ç•¶é‡åˆ° Distroless Container é™¤éŒ¯è¦ä»€éº¼æ²’ä»€éº¼è©²æ€éº¼è¾¦? ä½ çš„å¥½æœ‹å‹ kubectl debug</a></h2>
<p>é€™ç¯‡åªæœ‰ Red Hat OpenShift ç‚ºä¸»çš„ä½¿ç”¨è€…ä¸ç”¨çœ‹ï¼Œé‚£å€‹æ—©åœ¨ v3.6 å¥½å¹¾å¹´å‰å°±å¼„äº†ä¸€å€‹ <code>oc debug</code> å‡ºä¾†äº†ï¼Œä½†ä½ è‹¥æ˜¯ä¸€èˆ¬ Kubernetes ç™¼è¡Œç‰ˆçš„ï¼Œä¾‹å¦‚ Tanzu Kubernetes Grid æˆ– Azure Kubernetes Service ç­‰ï¼Œå‰‡å¯ä»¥åƒè€ƒä¸€ä¸‹æ­¤ç¯‡ä½œæ³•ã€‚ä¸»è¦æ˜¯æœƒç”¨åˆ° <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a> å’Œ <a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">kubectl debug</a> é€™å…©å€‹ä¸»è¦èƒ½åŠ›ï¼Œè€Œç›®å‰éƒ½æ˜¯åœ¨ Kubernetes v1.25 æ¨™è¨» Stable ç©©å®šç‹€æ…‹</p>
<p><img alt="" src="/images/title-kubectl-debug.png" /></p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#_1">å…¸å‹ç‹€æ³</a></h3>
<p>æœ‰æ™‚å€™ä½ æœƒé‡åˆ°ä¸€å€‹ Container Images æ˜¯æ¡ Distroless çš„æ–¹å¼é‹è¡Œï¼Œç‰¹æ€§æ˜¯é™¤äº†ç¨‹å¼æœ¬èº«ä»¥å¤–ï¼Œä»€éº¼ Shell éƒ½æ²’æœ‰ï¼Œç„¡æ³•ç™»å…¥é€²å»ï¼Œæˆ–è€…æ˜¯ä½ é€²å¾—å»çœ‹èµ·ä¾†æœ‰å•é¡Œçš„ Pod æƒ³è¦é€²è¡Œä¸€äº›é™¤éŒ¯çš„å‹•ä½œï¼Œä½†å‰›å¥½æ²’æœ‰è£ä»»ä½•å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œé€™æ™‚å€™è©²æ€éº¼è¾¦å‘¢? å…¶å¯¦ä½ éœ€è¦è¦æº–å‚™ä¸€å€‹è‡ªå·±ç·¨è­¯å¥½çš„ <a href="https://github.com/pichuang/debug-container">debug-container</a> å’Œå­¸ç¿’ä¸€ä¸‹ <code>kubectl debug</code> çš„ç”¨æ³•</p>
<p>é€™é‚Šå‰›å¥½æœ‰ä¸€å€‹ Azure Kubernetes Service å¸¸è¦‹çš„ç‹€æ³ï¼Œå°±æ˜¯è‹¥æƒ³è¦ç™»å…¥åˆ° CoreDNS Pod è£¡é¢æŸ¥çœ‹ Corefile çš„å…§å®¹ï¼Œä½ æœƒç™¼ç¾åˆ°å®ƒæœƒä¸€ç›´å™´ <code>no such file or directory: unknown</code> ä¹‹é¡çš„éŒ¯èª¤ï¼Œå…¶å¯¦æ˜¯å› ç‚ºé€™å€‹ Pod è£¡é¢æ ¹æœ¬æ²’æœ‰ /bin/bash æˆ–è€…æ˜¯ /bin/cat çš„æŒ‡ä»¤å¯ä»¥ç”¨ï¼Œå¯ä»¥ç®—æ˜¯å¾ˆæ‰å¯¦çš„ Distroless Container å¯¦å‹™æ¡ˆä¾‹</p>
<p><img alt="" src="/images/coredns-error.png" /></p>
<div class="highlight"><span class="filename">before</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>kube-dns
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>coredns-6698ddd997-gx66m<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>coredns-6698ddd997-rxlsl<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;0f831ab9a9d243bb196e31d6578b19ea13088cdfeec57fb1953c3021a0463d12&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span>:<span class="w"> </span>stat<span class="w"> </span>/bin/bash:<span class="w"> </span>no<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory:<span class="w"> </span>unknown
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;7b5e958107188e3b7748a27138774775dbcebcb8c6bd178b357d187bda720bc9&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;cat&quot;</span>:<span class="w"> </span>executable<span class="w"> </span>file<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$PATH</span>:<span class="w"> </span>unknown
</code></pre></div>
<p>ä¸‹é¢æä¾›ç”¨ <a href="https://github.com/wagoodman/dive">dive</a> æ‰€åˆ†æçš„å®¹å™¨æ˜ åƒæª”å…§å®¹</p>
<p><img alt="" src="/images/dive.png" /></p>
<h3 id="2"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2">2 å€‹å‰ç½®æº–å‚™</a></h3>
<ol>
<li>æº–å‚™ä¸€å€‹å…·å‚™å¯ç”¨ Shell è·Ÿå…¶ä»–é™¤éŒ¯ç”¨å·¥å…·çš„ Ephemeral Container Imageï¼Œå¦‚æˆ‘è‡ªå·±ç·¨è­¯çš„ <a href="https://github.com/pichuang/debug-container">pichuang/debug-container:master</a>ï¼ŒåŸºæ–¼ CentOS Streamï¼Œæ¯æ—¥æ›´æ–°ï¼Œç°¡å–®ç›´è¦º</li>
<li>ä½¿ç”¨ <code>kubectl debug</code>ï¼Œç¢ºä¿ä½ çš„ kubectl ç‰ˆæœ¬æ˜¯å¤§æ–¼ v1.25ï¼Œç›®å‰é€™å€‹åŠŸèƒ½æ˜¯å…§å»ºåœ¨ kubectl è£¡é¢ï¼Œä¸éœ€è¦é¡å¤–è£ krew plugin å³å¯ä½¿ç”¨</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version<span class="w"> </span>--short
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.1
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.26.3
</code></pre></div>
<h3 id="2_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2_1">2 å€‹è§£æ±ºæ–¹å¼</a></h3>
<ol>
<li>ä½¿ç”¨ <code>--target</code>: ç›´æ¥å° Target Container é€²è¡Œæ“ä½œï¼Œå¸¸è¦‹å¦‚ Pod Running ä¸­æ²’ä»€éº¼å•é¡Œï¼Œä½†å‰›å¥½å®ƒæ˜¯ distroless imagesï¼Œç¼ºå°‘ä¸€å †å¯åŸ·è¡Œ binã€‚é€™æ™‚å€™è‹¥ä½ åªæ˜¯æƒ³è¦åšä¸€äº›åŸºæœ¬æ¸¬è©¦ï¼Œè­¬å¦‚ç¶²è·¯æ¸¬è©¦ç­‰ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ <code>--target</code> æ–¹å¼æŠŠè‡ªå·±æº–å‚™çš„ Ephemeral Container æ›é€²å»ä½¿ç”¨ï¼Œç„¡é ˆç‰¹åˆ¥ä¿®æ”¹ä¹Ÿç„¡é ˆé‡é–‹</li>
<li>ä½¿ç”¨ <code>--copy-to</code>: Copy ä¸€ä»½ Pod å‡ºå»å¦å¤–ç ”ç©¶ï¼Œæœ€å¸¸è¦‹çš„ä½¿ç”¨æ–¹å¼ï¼Œåèˆ‰é‡åˆ° Completed æˆ– CrashLoopBackOff ç­‰ç„¡æ³•ä½¿ç”¨ kubectl exec æ–¹å¼é€²å…¥çš„ Pod ä¸”æƒ³è¦çŸ¥é“åˆ°åº•æ­»åœ¨é‚£è£¡ï¼Œå¯ä»¥æ›ä¸€å€‹ Ephemeral Container ä¿®æ”¹é€²å…¥é»æˆ–å‘½ä»¤ç ”ç©¶çœ‹çœ‹</li>
</ol>
<h4 id="1-target"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#1-target">1. ä½¿ç”¨ <code>--target</code></a></h4>
<p><img alt="" src="/images/target-debug.png" /></p>
<div class="highlight"><span class="filename">target</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">#</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --target=&lt;TARGET CONTAINER NAME&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1">#</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--target<span class="o">=</span>coredns
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Targeting<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;coredns&quot;</span>.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>processes<span class="w"> </span>from<span class="w"> </span>this<span class="w"> </span>container<span class="w"> </span>it<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>because<span class="w"> </span>the<span class="w"> </span>container<span class="w"> </span>runtime<span class="w"> </span>doesnt<span class="w"> </span>support<span class="w"> </span>this<span class="w"> </span>feature.
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-pbsr4.
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>root<span class="w">           </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">762456</span><span class="w"> </span><span class="m">46012</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">07</span>:24<span class="w">   </span><span class="m">0</span>:01<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>root<span class="w">          </span><span class="m">63</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3284</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">07</span>:33<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>root<span class="w">          </span><span class="m">88</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">44708</span><span class="w">  </span><span class="m">3380</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">07</span>:35<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/1/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span>errors
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span>ready
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="c1">#</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="c1"># Qeury ephemeralContainerStatuses</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="c1">#</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="c1"># kubectl -n kube-system get pod coredns-6698ddd997-gx66m -o jsonpath=&#39;{range .status.ephemeralContainerStatuses[*]}{.name}{&quot;\t&quot;}{.ready}{&quot;\n&quot;}{end}&#39;</span>
</code></pre></div>
<p>å¦‚æœè¦æŸ¥ Ephmeral Container çš„ç‹€æ…‹ï¼Œè¦å¾ <code>.status.ephemeralContainerStatuses</code> æŸ¥è©¢ï¼Œå¯ä»¥å¾—çŸ¥ä½¿ç”¨çš„ image æ˜¯ä»€éº¼ï¼Œä»¥åŠæ˜¯å¦ Ready ç­‰è³‡è¨Š</p>
<h4 id="2-copy-to"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2-copy-to">2. ä½¿ç”¨ <code>--copy-to</code></a></h4>
<p><img alt="" src="/images/copy-to-debug.png" /></p>
<p>é€™é‚Šè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯è¦æŠŠ <code>--share-processes</code> å‹¾èµ·ä¾†ï¼Œä¸ç„¶é è¨­ç‹€æ³ä¸‹ Linux Namespace æ˜¯ç›¸äº’éš”é›¢çš„ï¼Œæœƒçœ‹ä¸åˆ°åŸå…ˆçš„ Process</p>
<div class="highlight"><span class="filename">copy-to</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">#</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --copy-to=&lt;NEW POD NAME&gt;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1">#</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--share-processes<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--copy-to<span class="o">=</span>copy-coredns
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-lkp2m.
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="m">65535</span><span class="w">          </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.0<span class="w">    </span><span class="m">972</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/pause
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>root<span class="w">           </span><span class="m">7</span><span class="w">  </span><span class="m">1</span>.0<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">761944</span><span class="w"> </span><span class="m">41720</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>root<span class="w">          </span><span class="m">21</span><span class="w">  </span><span class="m">0</span>.4<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3328</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>root<span class="w">          </span><span class="m">46</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">47656</span><span class="w">  </span><span class="m">3596</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span>errors
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span>ready
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="c1">#</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="c1"># Reattach empeheral container</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="c1">#</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>attach<span class="w"> </span>copy-coredns<span class="w"> </span>-c<span class="w"> </span>debugger-lkp2m<span class="w"> </span>-i<span class="w"> </span>-t
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="c1">#</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="c1"># Check copy-coredns status</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="c1">#</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>coredns
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>copy-coredns<span class="w">                                </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>2m29s
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>coredns-6698ddd997-gx66m<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>coredns-6698ddd997-rxlsl<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>coredns-autoscaler-7dbcd7d9c8-pnqtt<span class="w">         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>17h
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="c1">#</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="c1"># Wipe out copy-coredns</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="c1">#</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>copy-coredns
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>pod<span class="w"> </span><span class="s2">&quot;copy-coredns&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<h3 id="microsoft-defender-for-cloud"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#microsoft-defender-for-cloud">[æ’èŠ±] Microsoft Defender for Cloud</a></h3>
<p>å°±åœ¨æˆ‘å° Azure Kubernetes Service å…§çš„ CoreDNS ä¸Šä¸‹å…¶æ‰‹çš„æ™‚å€™...æˆ‘è¢«å¯„äº†å° <code>Security Alert: CoreDNS modification in Kubernetes detected</code>ï¼ŒçœŸ...è²¼å¿ƒçš„æé†’</p>
<div class="highlight"><span class="filename">Security Alert: CoreDNS modification in Kubernetes detected</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Kubernetes audit log analysis detected a modification of the CoreDNS configuration. The configuration of CoreDNS can be modified by overriding its configmap. While this activity can be legitimate, if attackers have permissions to modify the configmap, they can change the behavior of the cluster&#39;s DNS server and poison it.
</code></pre></div>
<p><img alt="" src="/images/coredns-security-alert.png" /></p>
<h3 id="refereneces"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#refereneces">Refereneces</a></h3>
<ul>
<li><a href="https://mcr.microsoft.com/en-us/product/cbl-mariner/distroless/base/about">CBL-Mariner Distroless Base</a></li>
<li><a href="https://github.com/pichuang/debug-container">pichuang/debug-container</a></li>
<li><a href="https://xie.infoq.cn/article/4372ef0ba18c49891b295de54">K8S æ•…éšœæ’é”™æ–°æ‰‹æ®µï¼škubectl debug å®æˆ˜</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a></li>
<li><a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">Debugging with an ephemeral debug container</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-29 00:00:00">June 29, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/container/" class="md-meta__link">container</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="debian-ubuntu"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/">å®¹å™¨åŸºç¤æ˜ åƒæª”è¦é¸ Debian é‚„æ˜¯ Ubuntu?</a></h2>
<p>ä¾†å•å•å¤§å®¶ä¸€å€‹å•é¡Œï¼Œä»¥ Container Base Images ä¾†èªªï¼Œä»¥ Deb é«”ç³»ä¾†çœ‹ï¼Œä½ è¦ºå¾— Debian æ¯”è¼ƒå®‰å…¨é‚„æ˜¯ Ubuntu æ¯”è¼ƒå®‰å…¨?</p>
<p><img alt="" src="/images/debian-distroless-ubuntu.png" /></p>
<!--more-->

<h3 id="static-analysis"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#static-analysis">å®¹å™¨æ˜ åƒæª”çš„éœæ…‹æƒæ (Static Analysis) æ–¹å¼</a></h3>
<p>ä»¥ç¾è¡Œè³‡å®‰æœå‹™æƒ Container Imagesï¼Œçµ•å¤§éƒ¨åˆ†éƒ½æ˜¯ä»¥éœæ…‹æƒæç‚ºä¸» (å‹•æ…‹è·‘æ²™ç®±å…§çš„è«‹å®¹æˆ‘å…ˆè·³é)ï¼Œæƒçš„æ–¹å¼ä¸»è¦éƒ½æ˜¯çœ‹è£¡é¢çš„å®‰è£ä¸­å¥—ä»¶æœ‰æ²’æœ‰ä½¿ç”¨åˆ°æœ‰æ¼æ´çš„å¥—ä»¶ (å¯ç”¨ apt list --installed æ¢åˆ—å®‰è£ä¸­çš„å¥—ä»¶å’Œç‰ˆæœ¬) ç„¶å¾Œå°ä¸Šå·²çŸ¥çš„ CVE Databaseï¼Œä»¥ Harbor æä¾›çš„ <a href="https://goharbor.io/docs/2.8.0/install-config/harbor-compatibility-list/#scanner-adapters">Harbor Compatibility List- Scanner Adapters</a>ï¼Œç„¡è«–æ˜¯ clair / sysdig / aqua / trivy å¯¦ä½œæ‹›æ•¸éƒ½æ˜¯å·®ä¸å¤šçš„</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>date
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Thu<span class="w"> </span>Jun<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">23</span>:25:30<span class="w"> </span>CST<span class="w"> </span><span class="m">2023</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>--name<span class="w"> </span>debug<span class="w"> </span>docker.io/library/ubuntu:22.04<span class="w"> </span>/bin/bash
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>root@82f6bb20f606:/#<span class="w"> </span>apt<span class="w"> </span>list<span class="w"> </span>--installed<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>WARNING:<span class="w"> </span>apt<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>have<span class="w"> </span>a<span class="w"> </span>stable<span class="w"> </span>CLI<span class="w"> </span>interface.<span class="w"> </span>Use<span class="w"> </span>with<span class="w"> </span>caution<span class="w"> </span><span class="k">in</span><span class="w"> </span>scripts.
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>Listing...
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>adduser/now<span class="w"> </span><span class="m">3</span>.118ubuntu5<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>apt/now<span class="w"> </span><span class="m">2</span>.4.9<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>base-files/now<span class="w"> </span>12ubuntu4.3<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>base-passwd/now<span class="w"> </span><span class="m">3</span>.5.52build1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>bash/now<span class="w"> </span><span class="m">5</span>.1-6ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>bsdutils/now<span class="w"> </span><span class="m">1</span>:2.37.2-4ubuntu3<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>coreutils/now<span class="w"> </span><span class="m">8</span>.32-4.1ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>dash/now<span class="w"> </span><span class="m">0</span>.5.11+git20210903+057cd650a4ed-3build1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>debconf/now<span class="w"> </span><span class="m">1</span>.5.79ubuntu1<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>root@82f6bb20f606:/#<span class="w"> </span>cat<span class="w"> </span>/etc/os-release
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&quot;Ubuntu 22.04.2 LTS&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="nv">NAME</span><span class="o">=</span><span class="s2">&quot;Ubuntu&quot;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">&quot;22.04&quot;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="nv">VERSION</span><span class="o">=</span><span class="s2">&quot;22.04.2 LTS (Jammy Jellyfish)&quot;</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="nv">VERSION_CODENAME</span><span class="o">=</span>jammy
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="nv">ID</span><span class="o">=</span>ubuntu
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="nv">ID_LIKE</span><span class="o">=</span>debian
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&quot;https://www.ubuntu.com/&quot;</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://help.ubuntu.com/&quot;</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="nv">PRIVACY_POLICY_URL</span><span class="o">=</span><span class="s2">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="nv">UBUNTU_CODENAME</span><span class="o">=</span>jammy
</code></pre></div>
<h3 id="cve"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#cve">ä»¥ä½œæ¥­ç³»çµ±è§’åº¦æ¢åˆ—å·²çŸ¥ CVE</a></h3>
<p>å¯ä»¥è§€å¯Ÿå…©é‚Šçš„ Security Trackerï¼é¸ High å°±å¥½</p>
<ol>
<li><a href="https://security-tracker.debian.org/tracker/status/release/stable?filter=1&amp;filter=high_urgency&amp;filter=unassigned_urgency">Debian - Security Bug Tracker</a> ä»–æ‰€æœ‰ç‰ˆè™Ÿéƒ½æœƒåˆ—å‡ºä¾†ï¼Œbuster (10,oldoldstable,LTS) / bullseye (11,oldstable) / bookworm (stable) ä¸‰å€‹ç‰ˆæœ¬éƒ½å¯ä»¥çœ‹ä¸€ä¸‹</li>
<li><a href="https://ubuntu.com/security/cves?q=&amp;package=&amp;priority=high&amp;version=jammy&amp;status=">Ubuntu- CVE search results</a> ä»¥ 22.04 LTS ç‚ºä¸»</li>
</ol>
<p>å»ºè­°å¯ä»¥çœ‹å¸¸ä¸Š CVE åˆ—è¡¨çš„ linux* é–‹é ­çš„å¥—ä»¶ï¼Œä½ æœƒç™¼ç¾åˆ°å¹¾å€‹äº‹å¯¦</p>
<ol>
<li>ç„¡è«–æ˜¯ Ubuntu æˆ– Debianï¼Œä¸æ˜¯æ¯ä¸€å€‹ CVE æ¨™è¨» High åœ¨ä¸Šæ¸¸å¥—ä»¶éƒ½æœ‰è¢«ä¿®å¾©ï¼Œæ‰€ä»¥ä½ å°±ç®— <code>apt update &amp;&amp; apt upgrade</code> æ›´æ–°åˆ°æœ€æ–°ç‰ˆï¼Œä¸ä¸€å®šèƒ½æœƒé—œæ‰æ‰€æœ‰ CVE High çš„å•é¡Œ</li>
<li>
<p>CVE æœƒéš¨ä½ çš„ä½œæ¥­ç³»çµ± OS å’Œç™¼å¸ƒç‰ˆè™Ÿ <code>cat /etc/os-release</code> æœ‰ä¸‹åˆ— 4 å€‹ä¸åŒçš„å‘ˆç¾çµæœ</p>
<ol>
<li>èˆŠç‰ˆæ²’æœ‰é€™å€‹å•é¡Œï¼Œä½†æ–°ç‰ˆç™¼è¡Œç‰ˆæœ‰ï¼Œè­¬å¦‚ CVE-2023-35829</li>
<li>èˆŠç‰ˆä¸ä¿®ï¼Œä½†æ–°ç‰ˆä¿®äº†ï¼Œè­¬å¦‚ CVE-2023-23005</li>
<li>å‰›ç™¼ç¾é‚„ä¸çŸ¥é“æ€éº¼ä¿®ï¼Œè­¬å¦‚ CVE-2023-35827</li>
<li>çœ‹èµ·ä¾†æ˜¯æ²’äººæƒ³ä¿®ï¼Œè­¬å¦‚ CVE-2020-36694</li>
</ol>
</li>
</ol>
<p>ç¸½æ­¸ä¾†èªªï¼Œå¦‚æœä½ æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬ï¼Œç„¡è«–æ˜¯ Debian é‚„æ˜¯ Ubuntu ä½ éƒ½é‚„æ˜¯æœƒæœ‰å¹¾å€‹ CVE High çš„å•é¡Œæœƒäº®åœ¨ä½ çš„å ±å‘Šä¸Šï¼Œé‚£æ€éº¼è¾¦? åš´æ ¼ä¾†èªªä½ ä¹Ÿåªèƒ½ç­‰ç¤¾ç¾¤æŸå€‹äººå¹«å¿™åšå¥—ä»¶æ›´æ–°ï¼Œæˆ–è€…æ˜¯ç”¨å…¶ä»–<code>éæŠ€è¡“çš„æ–¹å¼</code>è§£æ±ºï¼Œç•¢ç«Ÿä¸æ˜¯æ¯å€‹ CVE éƒ½èƒ½è¢«åˆ©ç”¨æˆ–å¥½åˆ©ç”¨</p>
<h3 id="_1"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#_1">æ—¢ç„¶éƒ½æ²’è¾¦æ³•å®Œå…¨ä¿®åˆ°æ²’æœ‰ï¼Œé‚£è¦æ€éº¼é¸æ“‡?</a></h3>
<p>ä»¥ç¾åœ¨ 2023 é€™å€‹æ™‚é–“é»ä¾†èªªï¼Œä¸å¦‚å¹³å¿ƒè€Œè«–ï¼Œä¸»è¦å¯ä»¥å°æ¯”å…©é‚Š CVE çš„è™•ç†åæ‡‰é€Ÿåº¦å’Œèƒ½ä¸èƒ½åš backport (å‘å¾Œç§»æ¤)</p>
<ul>
<li><a href="https://www.debian.org/security/faq">Debian Security FAQ</a>: åŸºæœ¬ä¸Šæ¯”è¼ƒåç¤¾ç¾¤è‡ªä¸»é‹ä½œï¼Œä½ å¾—å›å ±åˆ°ï¼Œæˆ–è‡ªå·±æ²èµ·æ‰‹ä¿®å¾©ï¼Œè€Œä¸”æœ‰å•é¡Œä¿®å¾©çš„æ™‚å€™ï¼ŒæŒ‰ç…§ <a href="https://www.debian.org/security/faq#version"><code>Q: å¥—ä»¶çš„ç‰ˆæœ¬è™Ÿè¡¨æ˜æˆ‘ä»åœ¨é‹è¡Œå—æ¼æ´å½±éŸ¿çš„ç‰ˆæœ¬ï¼</code></a> çš„èªªæ³•æ˜¯ <code>A: æˆ‘å€‘å°‡å®‰å…¨è£œä¸å‘å¾Œç§»æ¤åˆ°ç©©å®šç™¼è¡Œç‰ˆ (Stable Release) ä¸­éš¨é™„çš„å¥—ä»¶ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯å‡ç´šåˆ°æ–°ç‰ˆæœ¬</code></li>
<li><a href="https://ubuntu.com/security/docker-images">Ubuntu - Long Term Supported OCI Images</a>: é€™å€‹å› ç‚ºæœ‰ Canonical å¾Œé¢æŠ•äººåŠ›ä¸‹å»ç¶­è­·ï¼ŒæŒ‰ç…§ <code>Is the LTS Docker Image Portfolio a free or a commercial offering?</code> çš„èªªæ³•ï¼Œæ‰€ä»¥æœ€å° 5y LTS æ›´æ–°ï¼Œæœ‰è¨‚é–±è²·æ”¯æ´çš„è©±æœ€é•· 10y çš„å®‰å…¨ä¿®è£œï¼Œå…¶å¯¦è·Ÿ Red Hat / SUSE éŠ·å”®æ¨¡å¼æ˜¯å¤§åŒå°ç•°ï¼Œé€™ç¨®æ¯”è¼ƒæœ‰äººåŠ›åš backportï¼Œæ„æ€æ˜¯èªªç¾åœ¨çš„ patch å¯ä»¥å›æœ”åˆ°å‰é¢çš„ç‰ˆæœ¬å»ä¿®å¾©</li>
</ul>
<p>æ•…å°±å•†ç”¨æ”¯æ´ä¾†èªªï¼ŒCanonical å› ç‚ºæœ‰æ—¢æœ‰çš„å•†æ¥­æ¨¡å¼æ”¯æ’ä»–å€‘é¤Šå·¥ç¨‹å¸«ï¼Œæ•…æ•´é«”æ¡ç”¨é¢¨éšªä¾†èªªï¼Œé‚„ç›¸å°æ¯” Debian ä½ä¸€é»ï¼Œæ›´ä½•æ³ Ubuntu çœŸçš„æ˜¯å¤ªå¤šå…¬å¸ (e.g. Cloud Provider / OEM) é è¨­æœ‰ç”¨ï¼Œç„¡è«–æ˜¯æœ‰æ²’æœ‰èµ° Partner Channel è¨‚é–±ï¼Œæˆ–è€…æ˜¯ OEM è·¯ç·š</p>
<h3 id="_2"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#_2">çµè«–</a></h3>
<p>çµè«–ä¾†èªªï¼Œå¦‚æœå«æˆ‘é¸æ“‡ Debian é«”ç³»çš„ Container Base Images ï¼Œä¸‹åˆ—æä¾›å€‹äººä¸»è§€åˆ¤æ–·...</p>
<p>æº–å‰‡å¦‚ä¸‹ï¼Œå¾å•†å‹™è§£åˆ°æŠ€è¡“è§£:</p>
<ol>
<li>é‡è¦– Security ä¿®å¾©èƒ½é‡</li>
<li>è·Ÿè‘—åº•å±¤ä½œæ¥­ç³»çµ± (Host OS) é¸: å› ç‚º Container æ˜¯å…±ç”¨ Host OS Kernelï¼Œå¦‚æœå‰›å¥½ä½ ç”¨åˆ°çš„åŠŸèƒ½æœ‰é€™ç¨®åç‰¹å®š Kernel çš„ lib æˆ–å¥—ä»¶ï¼Œé‚£å»ºè­°è·Ÿè‘— Host OS é¸ï¼Œå¦‚æœæ²’é€™ç¨®éœ€æ±‚ï¼Œé‚„æ˜¯å»ºè­°è·Ÿè‘— Host OS é¸ï¼Œå…¶æ¬¡æ‰é¸åˆ¥çš„</li>
<li>æ‹‰æœ€æ–°ç‰ˆæœ¬: dockerfile é–‹é ­è¨˜å¾—è¦å…ˆ apt update &amp;&amp; apt upgrade</li>
<li>èµ° Distroless: è£æœ€å°‘ä½†å¿…é ˆçš„å¥—ä»¶ï¼Œä¸è¦è£å¤šé¤˜å¥—ä»¶ï¼Œä½†é€™å€‹éœ€è¦å° Multi Stage Build æœ‰é«˜åº¦ç†è§£çš„å·¥ç¨‹åœ˜éšŠæ‰å¯ä»¥é¸çš„æŠ€è¡“è§£æ³•</li>
</ol>
<p>é †åºå¦‚ä¸‹:</p>
<ol>
<li><a href="https://hub.docker.com/_/ubuntu">docker.io/library/ubuntu:22.04</a></li>
<li><a href="https://github.com/GoogleContainerTools/distroless">Distroless é«”ç³»</a></li>
<li><a href="https://hub.docker.com/_/debian">docker.io/library/debian:bookworm</a></li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#qa">Q&amp;A</a></h3>
<h4 id="q1-debian-ubuntu"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q1-debian-ubuntu">Q1: å¯æ˜¯äººå®¶èªªä¸æ˜¯ Debian æ¯”è¼ƒç©©å®š? Ubuntu æ¯”è¼ƒä¸ç©©å®š?</a></h4>
<p>å…·é«”ä¾†èªªï¼Œå¯ä»¥å…ˆè©¦å•è‡ªå·±ï¼Œä½•è¬‚<code>ç©©å®š</code>çš„å®šç¾©? ä¸å¸¸æ›´æ–°çš„ç™¼è¡Œç‰ˆã€å°‘äººä½¿ç”¨çš„ç™¼è¡Œç‰ˆã€å°‘æ¼æ´çš„ç™¼è¡Œç‰ˆ? é€™äº›éƒ½æœ‰è½éï¼Œä½†é€™å€‹è·Ÿå•†å‹™ä½¿ç”¨ä¸Šçš„é—œä¿‚è¦æ€éº¼æ›å‹¾èµ·ä¾†ï¼Œå¯ä»¥ç”¨å¯¦å‹™é¢å•é¡Œä¾†è¨è«–ï¼Œ<code>CVE å¥—ä»¶å ±å‘Šå°±äº®åœ¨é‚£é‚Šï¼Œè«‹å•è¦æ‰¾èª°è™•ç†ä¿®å¾©?</code></p>
<p>é—œéµé‡é»æ˜¯èª° (Who) å»ä¿®ï¼Œåè€Œä¸æ˜¯ CVE Databaseï¼Œå› ç‚º CVE ä½ æ“‹äº†ä¸€å€‹æ˜å¤©é‚„æœƒæœ‰ä¸‹ä¸€å€‹ï¼ŒåŸºæœ¬ä¸Šæ²’ä»€éº¼ç‰¹åˆ¥å¯ä»¥è¨è«–ï¼Œçœ‹çœ‹ä»Šå¹´ 2023 æ‰éä¸€åŠ <a href="https://www.cvedetails.com/browse-by-date.php">CVE ç·¨è™Ÿå·²ç¶“ä¾†åˆ° 14141</a>ï¼Œä½†èª° (Who) è¦æä¾›è™•ç†æ–¹å¼æ˜¯ä¸€å€‹å¾ˆé‡è¦çš„äº‹æƒ…ï¼Œç„¡è«–æ˜¯ä¿®è£œ (Fixed) æˆ–è€…æ˜¯ç·©è§£ (Mitigation)</p>
<h4 id="q2-apt-update-apt-upgrade-cve"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q2-apt-update-apt-upgrade-cve">Q2: ä¸æ˜¯æŒ‰ apt update &amp;&amp; apt upgrade å°±å¯ä»¥ä¿®è£œå…¨éƒ¨ CVE çš„æ±è¥¿å—?</a></h4>
<p>ç´°åˆ†ä¾†è¬›ï¼Œå¥—ä»¶åº«é‚„æœ‰åˆ† Ubuntu / Debian å®˜æ–¹æ”¶ç·¨æ­£å¼æ”¯æ´çš„å¥—ä»¶åº«ï¼Œå’Œç¬¬ä¸‰æ–¹å¥—ä»¶åº« (e.g. PPA æˆ–å…¶ä»–æ› apt-repos / dpkg -i) çš„å®‰è£ï¼Œåƒè¬ä¸è¦æœŸæœ›å…¨éƒ¨å¥—ä»¶éƒ½èƒ½ä¸€ç™¼è§£æ±ºçš„ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä½  CVE äº®åŠå¤©ï¼Œæœ‰é«˜åº¦æ©Ÿæœƒç­‰åˆ°ä»–ç”Ÿå‘½å‘¨æœŸçµæŸé‚„æ˜¯æœƒç¹¼çºŒäº®è‘—</p>
<h4 id="q3"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q3">Q3: æˆ‘å°±æ˜¯ä¸æƒ³ä»˜éŒ¢ï¼Œä½†æˆ‘åˆè¦æœ‰è¼ƒé«˜çš„å®‰å…¨æ€§ï¼Œæ€éº¼è¾¦?</a></h4>
<p>æœ€ä½³åšæ³•å°±æ˜¯ "è«‹æŒçºŒä¿æŒæœ€æ–°ç‰ˆæœ¬"ï¼Œå› ç‚ºç¾è¡Œå¤šæ•¸ç™¼è¡Œç‰ˆï¼Œé®®å°‘æœƒæŒçºŒ backport å›å»åˆ°èˆŠæœ‰çš„ç‰ˆæœ¬ï¼Œä½ å¦‚æœæ˜¯æ€è€ƒå®Œå…¨ä¸æ›´æ–°ï¼Œä¸ä»£è¡¨å°±æ˜¯å®‰å…¨ï¼Œç„¶å¾Œå°±æ²’ä½ çš„äº‹äº†ï¼Œä½ åªæ˜¯é¸æ“‡æŠŠæŠ€è¡“å‚µç•™åˆ°ä¹‹å¾Œå†ä¾†è™•ç†ï¼Œä¸­é–“çš„æ™‚é–“å°±æ˜¯é¢¨éšªæ‰€åœ¨ï¼Œéœ€è¦è‡ªè¡Œè©•ä¼°</p>
<p>ä»¥ä¸€å€‹ç·šæ€§é–‹ç™¼çš„æ¨¡å¼ä¾†çœ‹ï¼Œä½ æƒ³æƒ³ä½ ä»¥å‰å¯«çš„ code å‡ºå•é¡Œäº†ï¼Œåœ¨ä¸å…·å‚™ä»»ä½• SLA å•†å‹™ä¿è­‰ä¸‹ï¼Œä½ æ˜¯æœƒä¿®åœ¨æœ€æ–°çš„ç‰ˆæœ¬ï¼Œé‚„æ˜¯è¦èŠ±å¤§é‡æ™‚é–“å¾€å›ä¿®? ç¶­è­·æ˜¯éœ€è¦äººåŠ›æˆæœ¬çš„</p>
<h4 id="q4"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q4">Q4: ç¤¾ç¾¤ä¸æ˜¯éƒ½æœƒè‡ªå‹•æä¾›ä¿®è£œæ–¹å¼å—?</a></h4>
<p>ç¤¾ç¾¤ï¼Œæ˜¯ç”±ä¸€å †å¿—é¡˜è€…èŠ±æ™‚é–“è²¢ç»æˆ–è€…æ˜¯æœ‰å—é›‡ç‰¹å®šå…¬å¸åšé™å®šç¯„åœçš„äº‹æƒ…ï¼Œæ¼æ´æœƒè¢«ä¿®è£œæ˜¯å› ç‚ºæœ‰åˆ¥çš„ç¶­è­·è€…æˆ–å…¬å¸å‰›å¥½æœ‰é€™å€‹éœ€æ±‚è²¢ç»å‡ºä¾†ï¼Œçµ•å°ä¸æ˜¯ç„¡ä¸­ç”Ÿæœ‰çš„</p>
<p>ä½†ä»¥å‰æˆ–è¨±ä½ ä¸ç”¨æƒ³é€™äº›å¥—ä»¶æ€éº¼ä¾†çš„ï¼Œç•¢ç«Ÿç”¨çš„äººä¸æ˜¯å¤§å®—ï¼Œä½†éš¨è‘—æ•¸ä½ç™¼å±•çš„æ™®åŠæ€§ï¼ŒLinux å’Œ OpenSource çš„æ¡ç”¨è·Ÿé™½å…‰ç©ºæ°£æ°´ä¸€æ¨£çš„è‡ªç„¶ï¼Œé€²è€Œç™¼ç”Ÿè »å¤šèµ·é–‹æºè»Ÿé«”ä¾›æ‡‰éˆæ”»æ“Š (Software Supply Chain Attacks)ï¼Œå„å€‹éƒ½æ˜¯åœ°åœ–ç‚®ç­‰ç´šï¼Œçœ‹çœ‹ä¹‹å‰çš„ NPMã€PyPI çš„æ”»æ“Šç¯„åœï¼Œé‚„æœ‰é‚£å€‹åŸºæœ¬ä¸Šäººäººéƒ½æœ‰ç”¨åˆ°ä½†æ¥µå°‘äººåœ¨ä¹ä»–åˆ°åº•æ€éº¼èª•ç”Ÿçš„ OpenSSLã€‚åš´é‡åˆ° 2021/5/21 ç¾åœ‹ç¸½çµ±éƒ½ç°½ç½²è¡Œæ”¿å‘½ä»¤ <a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">Executive Order 14028, â€œImproving the Nationâ€™s Cybersecurity</a> é€²è¡Œ SBOM å’Œ Software Supply Chain çš„è¦ç¯„</p>
<h4 id="q5-ubuntu-debian-base-images"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q5-ubuntu-debian-base-images">Q5: å¦‚æœç”¨ Ubuntu / Debian çš„ Base Images æˆ–ç›¸é—œå¥—ä»¶æ‹›è‡´æ”»æ“Šï¼Œé€™å€‹ç®—èª°çš„è²¬ä»»?</a></h4>
<p>ä½¿ç”¨è€…è²¬ä»»ï¼Œé¢¨éšªéœ€è‡ªè² </p>
<h4 id="q6"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q6">Q6: æˆ‘ä¸æƒ³è¦å‡ºäº‹çš„æ™‚å€™è‡ªå·±æ“”æ”¿æ²»è²¬ä»»ï¼Œé‚£æ€éº¼è¾¦?</a></h4>
<p>é¢¨éšªè½‰å« (a.k.a æ‰¾èƒŒé‹ä¿ )</p>
<ol>
<li>æ²»æœ¬çš„æ–¹å¼å°±æ˜¯æ‰¾æœ‰ SLA çš„å…¬å¸è² è²¬ï¼Œä¾‹å¦‚ Canonical / Red Hat / SUSE ç­‰ç­‰ï¼Œé€™äº›å…¬å¸éƒ½æœ‰æä¾›å•†æ¥­æ”¯æ´ï¼Œä½†é€™äº›éƒ½æ˜¯è¦ä»˜è²»çš„ï¼Œä¸æ˜¯å…è²»çš„</li>
<li>æ²»æ¨™çš„æ–¹å¼å°±æ˜¯è³‡å®‰è¨­å‚™ç”¨æ¶æ§‹é¢ç¯‰èµ·å¼·åŒ–é˜²è­·çš„èƒ½åŠ›ï¼Œä½†é‚„æ˜¯è¦èŠ±éŒ¢</li>
</ol>
<p>ä¸èŠ±éŒ¢çš„é¢¨éšªè½‰å«...å¦‚æœçŸ¥é“çš„äººï¼Œè«‹ç•™è¨€æˆ–ç§è¨Šæ•™æˆ‘ä¸€ä¸‹</p>
<h4 id="q7"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q7">Q7: ä¸Šè¿°è«–è¿°é©ç”¨æ–¼å–®ç´”åªæ˜¯è¦é¸æ“‡ä½œæ¥­ç³»çµ±ä¸Šå—?</a></h4>
<p>æ˜¯ï¼Œæœ¬æ–‡è«–è¿°ä¸åƒ…é™å®šæ–¼åœ¨ Base Images çš„é¸æ“‡ï¹ä¹Ÿå¯åŒ…å«å–®ç´” Deb é«”ç³»çš„ä½œæ¥­ç³»çµ±é¸æ“‡èªªæ˜</p>
<h4 id="q8-ubuntu-red-hat-suse"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q8-ubuntu-red-hat-suse">Q8: æ•æ„Ÿä¸€é»çš„å•é¡Œï¼ŒUbuntu / Red Hat / SUSE?</a></h4>
<p>æˆ‘å€‹äººæ”¯æŒæŠ•æ³¨å¾ˆå¤šç²¾åŠ›åœ¨ <code>è²¢ç» Upstream Open Source Project</code> çš„å…¬å¸ä¸Šï¼Œé€™æ‰æ˜¯æˆ‘èªçŸ¥æ¯”è¼ƒæ­£å¸¸çš„é–‹æºç”Ÿæ…‹ç³»ï¼Œæ‰€ä»¥è¦æˆ‘æ’çš„è©±å°±æ˜¯ Red Hat == SUSE &gt; Ubuntuï¼Œä½†é€™åªæ˜¯æˆ‘å€‹äººçš„çœ‹æ³•ï¼Œç•¢ç«Ÿæ¯”è¼ƒä»¥å‰å¸¸æ’åˆ°å‰å…©å®¶çš„äºº</p>
<h4 id="q9"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q9">Q9: ç‚ºå•¥é€™ä¸–ç•Œè·Ÿä»¥å‰å¥½åƒä¸å¤ªä¸€æ¨£?</a></h4>
<p>è½é¦–é™³å¥•è¿…çš„æ­Œåå¹´å›å‘³ä¸€ä¸‹ï¼Œæˆ‘å¤§æ¦‚æ˜¯åå¹´å¤šä»¥å‰æ¥è§¸ Linuxï¼Œç”¨æœ€ä¹…çš„ç‰ˆæœ¬æ˜¯ Ubuntu 10.04ï¼Œè€å¯¦èªªç•¶æ™‚çœŸå¿ƒæ²’é€™éº¼è¤‡é›œï¼Œä½†ç¾åœ¨å› ç‚ºæ¡ç”¨çš„äººå¤šï¼Œæ•´å€‹ç”Ÿæ…‹ç³»ç›¸ç•¶è“¬å‹ƒï¼Œåšæ³•ä¹Ÿæœƒç›¸å°å¤šæ¨£åŒ–ï¼Œæ‰€ä»¥æ‰æœƒæœ‰ä¸€ç¥¨é–‹æºå°ˆæ¡ˆçš„æ²»ç†æ¨¡å¼ (Governance)</p>
    <nav class="md-post__action">
      <a href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-29 00:00:00">May 29, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">Kubernetes Probe é¡å‹åŠå¯¦ä½œæ–¹å¼çš„ä½¿ç”¨èªªæ˜èˆ‡å°å»ºè­°</a></h2>
<p>æœ€è¿‘çœ‹åˆ°ä¸€å€‹å¾ˆæœ‰è¶£çš„ç¶²ç«™ <a href="https://kube-score.com/">kube-score</a>ï¼Œä½ æŠŠä½ çš„ Kubernetes Deployment ä¸Ÿé€²å»ä¹‹å¾Œï¼Œå®ƒå°±æœƒå„ç¨®ç„¡æƒ…åœ°è·Ÿä½ èªªå“ªè£¡ä¸å¥½ã€‚ç•¶ä¸­è£¡é¢æœ‰æåˆ°é‡å° Kubernetes Probe ç›¸é—œçš„å»ºè­°ï¼Œå‰›å¥½æœ€è¿‘æ¡ˆå­æœ‰éœ€è¦ç‰¹åˆ¥ç²¾ç®—æ™‚é–“ï¼Œæ•…ç‰¹åˆ¥å¯«äº†ç¯‡æ–‡ç« ä¾›å¤§å®¶åƒè€ƒã€‚é †ä¾¿é™„ä¸Šä¸€å¼µï¼Œå¾ Bing Creator æä¾›çš„ DALL.E æ¨¡å‹æ‰€ç†è§£åˆ°çš„ Kubernetes livenessProbeã€readinessProbe ä»¥åŠ startupProbe è¦–è¦ºåŒ–çš„æ¨£å­ï¼Œå¾ˆåƒ...å·¦ç´çƒèƒ½æºçµæ™¶</p>
<p><img alt="" src="/images/probe-k8s-bg.jpg" /></p>
<!--more-->

<h3 id="tldr"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tldr">TL;DR</a></h3>
<ul>
<li>Kubernetse Probe é¡å‹é‡è¦æ€§æ’åº: readinessProbe &gt; livenessProbe &gt; startupProbe</li>
<li>å‘ˆä¸Šï¼Œæ¯ä¸€å€‹ Kubernetes Probe éƒ½æœ‰å„è‡ªçš„ initialDelaySecondsã€periodSecondsã€successThresholdã€failureThresholdã€timeoutSeconds ä»¥åŠ Probe å¯¦ä½œæ–¹æ³•å¯ä»¥è¨­å®šï¼Œä¸¦ä¸é‡è¤‡</li>
<li>Probe å¸¸è¦‹å¯¦ä½œæ–¹æ³•æ’åº: HTTP Probe &gt; Exec Probe &gt; TCP Socket Probe</li>
</ul>
<h3 id="cloud-native-taiwan-user-group"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#cloud-native-taiwan-user-group">é—œæ–¼ Cloud Native Taiwan User Group</a></h3>
<p>åŸºæ–¼ CNCF æ²»ç†è¦ç¯„ï¼Œå‰é™£å­å°‡ç¤¾åœ˜æ‹†åˆ†æˆå…©å€‹ï¼Œåˆ†åˆ¥æ˜¯ <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">Cloud Native Taiwan User Group</a> å’Œ <a href="">Kubernetes Community Days Taiwan</a></p>
<p>æ­¡è¿å¤§å®¶å‹•å‹•æ‰‹åŠ å…¥ä¸€ä¸‹ CNCF ç¤¾ç¾¤æœƒå“¡ï¼Œä¸¦ä¸”é»æ“ŠåŠ å…¥ (Join)</p>
<p><img alt="" src="/images/cntug-membership.png" /></p>
<p>å¦å¤–æˆ‘å€‘ 2023/06 æœ‰ç¤¾ç¾¤æ´»å‹• <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cntug-202306-meetup/">CNTUG 2023/06 Meetup</a>ï¼Œéœ€é€éè©²ç³»çµ±å ±åï¼Œçµ±è¨ˆäººæ•¸ï¼Œæ­¡è¿å¤§å®¶åƒåŠ </p>
<p>Cloud Native Taiwan User Group 2023/06</p>
<ul>
<li>Kubernetes ä¼¸ç¸®è‡ªå¦‚çš„å·¥ä½œè² è¼‰! -  Phil Huang</li>
<li>Topic Scalable NATS architecture with JetStream - ä½•ç§‰è³¢</li>
</ul>
<h3 id="kubernetes-3-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#kubernetes-3-probe">Kubernetes èƒ½è¨­å®šçš„ 3 ç¨® Probe é¡å‹</a></h3>
<p>åŸºæ–¼ Kubernetes å®˜æ–¹æ–‡ä»¶æŒ‡å‡º</p>
<table>
<thead>
<tr>
<th>Probe</th>
<th>åŠŸèƒ½æè¿°</th>
<th>ç”¨é€”</th>
<th>ä½¿ç”¨å ´æ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Liveness Probe (å­˜æ´»æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Pod æ˜¯å¦åœ¨é‹è¡Œç‹€æ…‹ä¸‹</td>
<td>ç¢ºä¿æ‡‰ç”¨ç¨‹åºåœ¨å®¹å™¨å…§éƒ¨é‹è¡Œï¼Œå¦‚æœæª¢æ¸¬å¤±æ•—ï¼ŒKubernetes å°‡æœƒçµ‚æ­¢å®¹å™¨ä¸¦é‡æ–°å•Ÿå‹•å®ƒ</td>
<td>é€™å¯ç”¨æ–¼æª¢æ¸¬æ‡‰ç”¨ç¨‹åºçš„ç•°å¸¸ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼Œç•¶æ‡‰ç”¨ç¨‹åºæ­»æ‰æˆ–è™•æ–¼ä¸æ­£å¸¸ç‹€æ…‹æ™‚ï¼‰ï¼Œé¡ä¼¼æ–¼é›»è…¦å•Ÿå‹•å¾Œå¾å¤–éƒ¨ç›£æ§ BMC ç¢ºèªæ©Ÿå™¨é‹ä½œæ­£å¸¸</td>
</tr>
<tr>
<td>Readiness Probe (å°±ç·’æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Application æ˜¯å¦æº–å‚™å¥½æ¥å—ç¶²è·¯æµé‡</td>
<td>ç•¶å®¹å™¨å…§çš„æ‡‰ç”¨ç¨‹åºæ­£åœ¨å•Ÿå‹•æˆ–æ­£åœ¨é€²è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œæ™‚ï¼Œå¯ä»¥ä½¿ç”¨ Readiness Probeã€‚ç•¶æ‡‰ç”¨ç¨‹åºå°±ç·’æ™‚ï¼Œå®ƒå°‡è¿”å›æˆåŠŸçš„æ‡‰ç­”ï¼Œä¸¦ä¸” Kubernetes å¯ä»¥é–‹å§‹å°‡æµé‡è·¯ç”±åˆ°è©²å®¹å™¨ã€‚</td>
<td>æŒçºŒæ€§æœå‹™å¥åº·æª¢æŸ¥ï¼Œé¡ä¼¼æ–¼ä½œæ¥­ç³»çµ±é‹è¡Œæ­£å¸¸</td>
</tr>
<tr>
<td>Startup Probe (å•Ÿå‹•æ¢é‡)</td>
<td>ç”¨æ–¼æª¢æ¸¬ Pod çš„å•Ÿå‹•é€²åº¦</td>
<td>Startup Probe é¡ä¼¼æ–¼ Readiness Probeï¼Œå®ƒç”¨æ–¼æª¢æ¸¬å®¹å™¨æ˜¯å¦æ­£åœ¨é€²è¡Œå•Ÿå‹•éç¨‹ã€‚èˆ‡ Readiness Probe ä¸åŒï¼ŒStartup Probe å¯ä»¥åœ¨æ‡‰ç”¨ç¨‹åºå°±ç·’ä¹‹å‰åŸ·è¡Œå¤šæ¬¡æª¢æ¸¬ã€‚</td>
<td>App åˆå§‹åŒ–ï¼Œé¡ä¼¼æ–¼é›»è…¦å•Ÿå‹•çš„æ™‚å€™æœƒæœ‰ BIOS æª¢æŸ¥ç¨‹åº</td>
</tr>
</tbody>
</table>
<p>Liveness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-livenessae14.GIF" /></p>
<p>Readiness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-readiness6ktf.GIF" /></p>
<h3 id="probe-3"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#probe-3">æ¯ä¸€å€‹ Probe å¯ä»¥ç”¨ä¸‹åˆ— 3 ç¨®å¯¦ä½œæ–¹å¼é€²è¡Œæª¢æŸ¥</a></h3>
<h4 id="http-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#http-probe">HTTP Probe</a></h4>
<p>æœ€å¤§å®—çš„æª¢æŸ¥æ–¹å¼ï¼Œå¦‚æœ Kubernetes æ”¶åˆ° HTTP Status Code 200 ~ 300 çš„ç¯„åœï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>apiVersion: v1
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>kind: Pod
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>metadata:
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  labels:
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    test: http-probe
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>  name: http-probe
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>spec:
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  containers:
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  - name: http-probe
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    image: k8s.gcr.io/liveness
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    args:
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    - /server
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    livenessProbe:
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>      httpGet:
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        path: /healthz
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        port: 8080
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        httpHeaders:
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        - name: X-Custom-Header
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>          value: Awesome
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>      initialDelaySeconds: 3
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>      periodSeconds: 10
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    readinessProbe:
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>      httpGet:
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        path: /healthz
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        port: 8080
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        httpHeaders:
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        - name: X-Custom-Header
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>          value: Awesome
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>      initialDelaySeconds: 3
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>      periodSeconds: 10
</code></pre></div>
<p>å…¶å¯¦å¾ˆå¤š Framework æˆ– Library å…§å»ºéƒ½æœ‰é‡å°é€™å€‹éœ€æ±‚é€²è¡Œå¯¦ä½œï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</p>
<ul>
<li>Spring Boot: <a href="https://spring.io/blog/2020/03/25/liveness-and-readiness-probes-with-spring-boot">Liveness and Readiness Probes with Spring Boot</a></li>
<li>.NET Core: <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks">Health checks in ASP.NET Core</a></li>
<li>Python3: <a href="https://pypi.org/project/flask-healthz/">flask-healthz</a></li>
</ul>
<h4 id="exec-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#exec-probe">Exec Probe</a></h4>
<p>å¦‚æœ Kubernetes æ”¶åˆ° Exit Code ç‚º 0ï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>apiVersion: v1
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>kind: Pod
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>metadata:
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  labels:
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    test: exec-probe
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>  name: exec-probe
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>spec:
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  containers:
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  - name: exec-probe
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    image: k8s.gcr.io/busybox
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    args:
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    - /bin/sh
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    - -c
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    livenessProbe:
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>      exec:
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        command:
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        - cat
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        - /tmp/healthy
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>      initialDelaySeconds: 5
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>      periodSeconds: 10
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    readinessProbe:
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>      exec:
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        command:
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        - cat
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        - /tmp/healthy
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>      initialDelaySeconds: 5
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>      periodSeconds: 10
</code></pre></div>
<h4 id="tcp-socket-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tcp-socket-probe">TCP Socket Probe</a></h4>
<p>å¦‚æœ Kubernetes èƒ½å»ºç«‹ TCP Establish connectionï¼Œå‰‡æœƒæ¨™è¨»ç‚º Healthï¼Œåä¹‹å‰‡æœƒæ¨™è¨»ç‚º Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>apiVersion: v1
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>kind: Pod
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>metadata:
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  name: goproxy
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  labels:
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    app: goproxy
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>spec:
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>  containers:
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>  - name: goproxy
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    image: k8s.gcr.io/goproxy:0.1
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    ports:
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    - containerPort: 8080
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    readinessProbe:
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>      tcpSocket:
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        port: 8080
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>      initialDelaySeconds: 5
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>      periodSeconds: 10
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    livenessProbe:
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>      tcpSocket:
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        port: 8080
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>      initialDelaySeconds: 15
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>      periodSeconds: 20
</code></pre></div>
<h3 id="use-cases"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#use-cases">Use Cases</a></h3>
<table>
<thead>
<tr>
<th>åƒæ•¸</th>
<th>æè¿°</th>
<th>kubernetes é è¨­å€¼</th>
<th><a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a></th>
<th><a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/helm-charts/helm3/strimzi-kafka-operator/README.md">Strimzi Kafka Operator</a></th>
<th><a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L448-L478">kubernetes/ingress-nginx</a></th>
<th><a href="https://github.com/mysql/mysql-operator/blob/trunk/helm/mysql-operator/templates/deployment.yaml#LL60C1-L66C29">mysql/mysql-operator</a></th>
<th><a href="https://github.com/mariadb-operator/mariadb-operator/blob/main/deploy/charts/mariadb-operator/templates/webhook-deployment.yaml#L67-L72">mariadb-operator/mariadb-operator</a></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>livenessProbe.enabled</code></td>
<td>å•Ÿç”¨ Liveness probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.initialDelaySeconds</code></td>
<td>åˆå§‹åŒ– Liveness Probe å‰çš„å»¶é²æ™‚é–“</td>
<td>0</td>
<td>30</td>
<td>10</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.periodSeconds</code></td>
<td>å¤šä¹…é‡æ¸¬ä¸€æ¬¡</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.timeoutSeconds</code></td>
<td>å¤šä¹…æœƒè¶…æ™‚</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.failureThreshold</code></td>
<td>æˆåŠŸå¾Œè¢«è¦–ç‚ºå¤±æ•—çš„æ¢æ¸¬çš„æœ€å°é€£çºŒå¤±æ•—æ¬¡æ•¸</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>5</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.successThreshold</code></td>
<td>æ¢æ¸¬å¤±æ•—å¾Œè¢«è¦–ç‚ºæˆåŠŸçš„æœ€å°‘é€£çºŒæˆåŠŸæ¬¡æ•¸</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>livenessProbe HealthCheck</td>
<td>Liveness Probe æ¢é‡æ–¹å¼</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.enabled</code></td>
<td>å•Ÿç”¨ Readiness Probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td><code>readinessProbe.initialDelaySeconds</code></td>
<td>åˆå§‹åŒ– Readiness Probe å‰çš„å»¶é²æ™‚é–“</td>
<td>0</td>
<td>5</td>
<td>10</td>
<td>10</td>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td><code>readinessProbe.periodSeconds</code></td>
<td>å¤šä¹…é‡æ¸¬ä¸€æ¬¡</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>3</td>
<td>10</td>
</tr>
<tr>
<td><code>readinessProbe.timeoutSeconds</code></td>
<td>å¤šä¹…æœƒè¶…æ™‚</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.failureThreshold</code></td>
<td>æˆåŠŸå¾Œè¢«è¦–ç‚ºå¤±æ•—çš„æ¢æ¸¬çš„æœ€å°é€£çºŒå¤±æ•—æ¬¡æ•¸</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>3</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.successThreshold</code></td>
<td>æ¢æ¸¬å¤±æ•—å¾Œè¢«è¦–ç‚ºæˆåŠŸçš„æœ€å°‘é€£çºŒæˆåŠŸæ¬¡æ•¸</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>readinessProbe HealthCheck</td>
<td>Readiness Probe æ¢é‡æ–¹å¼</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>exec</td>
<td>httpGet</td>
</tr>
</tbody>
</table>
<h4 id="nats-operator"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#nats-operator">ä»¥ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> ç‚ºä¾‹</a></h4>
<p>åŸºæ–¼ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/templates/deployment.yaml#L67-L87">NATS-Operator Deployment</a> å’Œ <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> é è¨­å€¼ï¼Œé€™é‚Šå› ç•«åœ–è§£é‡‹æ–¹ä¾¿ï¼Œæœ‰èª¿æ•´äº†ä¸€ä¸‹åƒæ•¸ã€‚æ•…å¯å¾—ä»¥ä¸‹æˆªå–è¨­å®š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        livenessProbe:
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>          httpGet:
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>            path: /readyz
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>            port: readyz
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>          initialDelaySeconds: 30
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>          periodSeconds: 10
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>          timeoutSeconds: 5
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>          successThreshold: 6
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>          failureThreshold: 3
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        readinessProbe:
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>          httpGet:
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>            path: /readyz
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>            port: readyz
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>          initialDelaySeconds: 5
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>          periodSeconds: 10
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>          timeoutSeconds: 5
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>          successThreshold: 6
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>          failureThreshold: 2
</code></pre></div>
<h4 id="q1-kubernetes-pod-pod-restarted-unhealthy"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q1-kubernetes-pod-pod-restarted-unhealthy">Q1: å¦‚æœç¨‹å¼é‹è¡Œä¸€æ®µæ™‚é–“ï¼Œç„¶å¾Œ Kubernetes ç™¼ç¾ Pod è¦ Pod Restarted æˆ–è€…æ˜¯æ¨™è¨» Unhealthy æœ€çŸ­æ™‚é–“ç‚ºä½•?</a></h4>
<p><img alt="" src="/images/probe-k8s-1.png" /></p>
<p>é¦–å…ˆå› ç‚ºç¨‹å¼å·²ç¶“é‹è¡Œä¸€æ®µæ™‚é–“äº†ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ initialDelaySeconds çš„æ™‚é–“</p>
<p>æ•…æ­£ç¢ºçš„ç®—å¼ç‚º</p>
<ul>
<li>æœ€çŸ­é‡å•Ÿ Pod æ™‚é–“ = (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  ( 3 - 1 ) * 10 + 5 = 25</li>
<li>æœ€çŸ­ç§»é™¤ Endpoint List æ™‚é–“ = (<code>readinessProbe.failureThreshold</code> - 1) * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> =  ( 2 - 1 ) * 10 + 5 = 15</li>
</ul>
<h4 id="q2-pod-restart"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q2-pod-restart">Q2: å¦‚æœç¨‹å¼åˆå§‹é‹è¡Œï¼Œç„¶å¾Œå› ç‚ºç¨‹å¼è£¡é¢æ²’å¯«å¥½ï¼Œå°è‡´ Pod Restart é–‹å§‹åŸ·è¡Œçš„æœ€çŸ­å’Œæœ€é•·æ™‚é–“ç‚ºä½•?</a></h4>
<p>éœ€è¦æŠŠ <code>livenessProbe.initialDelaySeconds</code> æ™‚é–“æ”¾é€²å»è©•ä¼°</p>
<ul>
<li>æœ€çŸ­é‡å•Ÿ Pod æ™‚é–“ = <code>livenessProbe.initialDelaySeconds</code> + (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + ( 3 - 1 ) * 10 + 5 = 55</li>
<li>æœ€é•·é‡å•Ÿ Pod æ™‚é–“ = <code>livenessProbe.initialDelaySeconds</code> + <code>livenessProbe.failureThreshold</code> * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + 3 * 10 + 5 = 65</li>
</ul>
<p>å…©è€…æ™‚é–“å·®å…¶å¯¦å°±æ˜¯å·®ä¸€å€‹ livenessProbe.periodSeconds æ™‚é–“</p>
<h4 id="q3-pod-endpoint-list-endponit-list-kubernetes"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q3-pod-endpoint-list-endponit-list-kubernetes">Q3: å¦‚æœ Pod å¾ Endpoint list ç§»é™¤äº†ä¸€æ®µæ™‚é–“å¾Œï¼Œç•¶ç¨‹å¼æ­£ç¢ºé‹è¡Œæ™‚ï¼Œæœ€çŸ­éœ€èŠ±å¤šå°‘æ™‚é–“å¯ä»¥åŠ å›åˆ° Endponit list åŠ å›åˆ° Kubernetes æœå‹™çš„è¡Œåˆ—å…§?</a></h4>
<p><img alt="" src="/images/probe-k8s-2.png" /></p>
<p>ä¸»è¦è¦çœ‹ <code>readinessProbe.successThreshold</code></p>
<ul>
<li>æœ€çŸ­æ¢å¾©æœå‹™æ™‚é–“ = <code>readinessProbe.successThreshold</code> * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> = 6 * 10 + 5 = 65</li>
</ul>
<h4 id="q4-readinessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q4-readinessprobe">Q4: å¦‚æœæ²’è¨­å®š readinessProbe æœƒæ€æ¨£å—?</a></h4>
<p>æœ‰å¯èƒ½æœƒåœ¨ Pod é‚„æ²’å•Ÿå‹•çš„æ™‚å€™ï¼Œæµé‡å°± Kubernetes åˆ¤æ–·å¯ä»¥è¢«æ¨é€²å»ï¼Œæˆ–è€…æ˜¯ Pod æ­£åœ¨è·‘åœæ­¢ç¨‹åºçš„æ™‚å€™ï¼Œæµé‡é‚„æ˜¯è¢«æ¨é€²å»</p>
<h4 id="q5-livenessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q5-livenessprobe">Q5: å¦‚æœæ²’è¨­å®š livenessProbe æœƒæ€æ¨£å—?</a></h4>
<p>ä¸æœƒæ€æ¨£ï¼Œå¦‚æœä½ ä¸çŸ¥é“è¦è¨­å®šä»€éº¼ï¼Œä¸ç”¨ç‰¹åˆ¥è¨­å®šï¼Œkubelet æœƒæ ¹æ“š Pod çš„ restartPolicy é€²è¡Œæ­£ç¢ºçš„å‹•ä½œã€‚å¦‚æœæœ‰è¨­å®šçš„è©±ï¼Œç›¡é‡ä¸è¦è·Ÿ readinessProbe æª¢æŸ¥åŒä¸€å€‹åœ°æ–¹</p>
<h4 id="q6-startupprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q6-startupprobe">Q6: å¦‚æœæ²’è¨­å®š startupProbe æœƒæ€æ¨£å—?</a></h4>
<p>ä¸æœƒæ€æ¨£ï¼Œå¦‚æœä½ ä¸çŸ¥é“è¦è¨­å®šä»€éº¼ï¼Œä¸ç”¨ç‰¹åˆ¥è¨­å®šï¼Œå¯ä»¥ç”¨æ‹‰é•· <code>livenessProbe.initialDelaySeconds</code> äº’æ›ï¼ŒstartupProbe çš„ç‰¹æ€§æ˜¯åªè¦æˆåŠŸä¸€æ¬¡å°±æœƒæ›æ‰‹çµ¦ livenessProbe æˆ– readinessProbe é€²è¡Œæ¢æ¸¬</p>
<p>å…¬å¼ç‚º <code>livenessProbe.initialDelaySeconds</code> å¤§ç´„ç­‰æ–¼ <code>startupProbe.initialDelaySeconds</code> + <code>startupProbe.periodSeconds</code> * <code>startupProbe.failureThreshold</code>ï¼Œå¯ä»¥ç›¡æ—©å†åˆå§‹éšæ®µç™¼ç¾æœå‹™å•Ÿå‹•ä¸äº†</p>
<h3 id="_1"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#_1">å€‹äººå°å»ºè­°</a></h3>
<ul>
<li>
<p>é—œæ–¼ initialDelaySeconds</p>
<ul>
<li>é‡å° livenessProbe.initialDelaySeconds ç‰¹åˆ¥æœ‰ç”¨</li>
<li>æ¡ç”¨ P99 çš„å•Ÿå‹•æ™‚é–“ç‚ºä¸»ï¼Œä¸»è¦æ˜¯å› ç‚ºé€™å€‹æ•¸å­—é¡åŒæ–¼é–‹æ©Ÿéœ€è¦å¤šä¹…æ™‚é–“ï¼ŒåŸºæœ¬ä¸Šéƒ½ç›¸ç•¶å›ºå®š</li>
<li>å¤šæ•¸æœ‰ç”¨ Frameworkã€JVM ç­‰éƒ½æœƒæœ‰å•Ÿå‹•æ™‚é–“çš„çµ±è¨ˆå¯ä»¥åƒè€ƒ</li>
<li>å¦‚æœçœŸçš„æŠ“ä¸æº–çš„è©±ï¼Œå»ºè­°ä¸Š startupProbeï¼Œè€Œä¸è¦ç”¨ livenessProbe.initialDelaySeconds</li>
</ul>
</li>
<li>
<p>é—œæ–¼ periodSeconds</p>
<ul>
<li>çµ•å¤§éƒ¨åˆ†çš„ç‹€æ³ä¸‹ 10s ç›¸ç•¶è¶³å¤ </li>
<li>å¦‚æœè¨­å®šå¤ªçŸ­ï¼Œæœ‰å¯èƒ½ Pod åªæ˜¯æš«æ™‚æ€§å¾ˆå¿™ä¾†ä¸åŠå›æ‡‰ï¼Œä»–å°±è¢«æ­¸é¡åœ¨ Failure çš„ç‹€æ…‹ï¼Œå¦‚æœåœ¨æ•´é«”ç³»çµ±éƒ½æ˜¯å¾ˆå¿™çš„ç‹€æ³ä¸‹ï¼Œæœƒå°è‡´èºæ—‹å¼æ•ˆèƒ½ä¸‹é™ï¼Œèƒ½è€…éå‹</li>
<li>å¦‚æœè¨­å®šå¤ªé•·ï¼ŒPod çœŸçš„æœ‰äº‹æƒ…çš„æ™‚å€™ï¼Œè¦å¾ˆä¹…æ‰æœƒæœ‰åæ‡‰</li>
</ul>
</li>
<li>
<p>é—œæ–¼ timeoutSeconds</p>
<ul>
<li>æœ€å¤§å¤šæ•¸æŠ“ periodSeconds/2 æˆ–ä½æ–¼çš„æ•¸å­—</li>
<li>æœ€å°ç‚º 1s</li>
</ul>
</li>
<li>
<p>é—œæ–¼ failureThreshold</p>
<ul>
<li>å»ºè­° 3</li>
<li>è¨­å®šå¤ªé«˜ï¼ŒPod çœŸçš„å£æ‰çš„æ™‚å€™ï¼Œå°è‡´çœŸçš„è¦é‡å•Ÿæˆ–ç§»å‡ºçš„æ™‚é–“æ‹‰çš„å¤ªé•·</li>
<li>è¨­å®šå¤ªçŸ­ï¼ŒPod å¯èƒ½åªæ˜¯æš«æ™‚å¾ˆå¿™çš„æ™‚å€™ï¼Œå°±æœƒéæ—©çš„é‡å•Ÿæˆ–ç§»å‡ºï¼Œå°è‡´èºæ—‹å¼æ•ˆèƒ½ä¸‹é™ï¼Œèƒ½è€…éå‹</li>
</ul>
</li>
<li>
<p>é—œæ–¼ successThreshold</p>
<ul>
<li>å»ºè­° 1</li>
<li>é‡å° readinessProbe.successThreshold ç‰¹åˆ¥æœ‰ç”¨ï¼ŒlivenessProbe.successThreshold æ²’ä»€éº¼ç‰¹åˆ¥æ•ˆæœï¼Œå› ç‚ºå¾Œè€…æœƒæŠŠ Pod æ•´å€‹é‡å•Ÿæ‰ï¼Œæ•…æ²’æœ‰å›ä¾†çš„æ©Ÿæœƒ</li>
<li>å¦‚æœ Pod èˆ‡å…¶ä»–æœå‹™ç›¸é—œæœå‹™å¤šçš„è©±ï¼Œå¯ä»¥æ•¸å­—æ‹‰å¤§ä¸€é»ï¼Œ</li>
</ul>
</li>
<li>
<p>é—œæ–¼ livenessProbe</p>
<ul>
<li>å› ç‚ºæ¶‰åŠåˆ°é‡å•Ÿ Pod çš„èƒ½åŠ›ï¼Œæ•…éœ€è¦ä¿å®ˆçš„è¨­å®šè©²é …ç›®</li>
<li>æª¢æŸ¥åƒ…éœ€åƒ…æŸ¥è‡ªèº«å³å¯ï¼Œä¸æ‡‰è©²æ¶‰åŠæª¢æŸ¥å¤–éƒ¨ç›¸ä¾æ€§æœå‹™</li>
</ul>
</li>
<li>
<p>é—œæ–¼ readinessProbe</p>
<ul>
<li>å› ç‚ºæ¯”è¼ƒåå‘æœå‹™çš„ healthcheckï¼Œæ•…å¯ä»¥æ¯”è¼ƒå¯¬é¬†ä¸€é»çš„è¨­å®š</li>
</ul>
</li>
</ul>
<h3 id="references"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#references">References</a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">é…ç½®å­˜æ´»ã€å°±ç»ªå’Œå¯åŠ¨æ¢é’ˆ</a></li>
<li><a href="https://cloud.redhat.com/blog/liveness-and-readiness-probes">Liveness and Readiness Probes</a></li>
<li><a href="https://opensource.com/article/18/3/kubernetes-liveness-readiness-probes">Creating Kubernetes liveness and readiness probes</a></li>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">Kubernetes best practices: Setting up health checks with readiness and liveness probes</a></li>
<li><a href="https://blog.pichuang.com.tw/20221005-k8s-gracefulrestart-pod.html?h=term">å¯¦ç¾ä¸åœæ©Ÿçš„ Pod æ›´æ–°æ–¹å¼</a></li>
<li><a href="https://github.com/zegl/kube-score/blob/master/README_PROBES.md">Readiness and Liveness Probes</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-15 00:00:00">May 15, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sig-kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">SIG Kubernetes Scability å¤šç¶­åº¦åˆ†æ</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bxY5Q5Eoj0s" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<p>å‰é™£å­å‰›å¥½ Kubecon EU 2023 å‰›è¾¦å®Œï¼Œç›¸é—œçš„å½±ç‰‡ä¹Ÿé‡‹å‡ºåˆ° <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a> ä¸Šï¼Œå…±è¨ˆ 314 éƒ¨ï¼Œåœ¨ç•¶ç½å„æ—å…‹ç ´å£æµ·æ‹‰é­¯å¤§é™¸çš„åŒæ™‚ï¼Œè¨˜å¾—ä¹Ÿè¦ä¸å¿˜æŒçºŒå­¸ç¿’</p>
<!--more-->

<h3 id="kubernetes-communtiy-day-taiwan-2023"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-communtiy-day-taiwan-2023">Kubernetes Communtiy Day Taiwan 2023 å‰©ä¸‹ä¸€å‘¨å¯ä»¥æŠ•ç¨¿!!!</a></h3>
<p>COSCUP 2023 å°‡è‡³ï¼ŒCloud Native Taiwan User Group è·Ÿæ­·å¹´ä¸€æ¨£æˆ‘å€‘ä¹Ÿæœƒæ–¼ 2023/07/29 ~ 2023/07/30 å…§ï¼Œèˆ‰è¾¦ Kubernetes Communtiy Day Taiwan 2023</p>
<p>ç›®å‰åƒ…å‰©ä¸€å‘¨é—œé–‰å¾µç¨¿ï¼Œå¯æ–¼  <a href="https://pretalx.coscup.org/coscup-2023/cfp">COSCUP æŠ•ç¨¿ç³»çµ±</a> é€²è¡ŒæŠ•ç¨¿</p>
<ul>
<li>æ­£å¼æŠ•ç¨¿é–‹å§‹æ—¥æœŸï¼š2023 å¹´ 04 æœˆ 14 æ—¥</li>
<li><code>æ­£å¼æŠ•ç¨¿æˆªæ­¢æ—¥æœŸï¼š2023 å¹´ 05 æœˆ 22 æ—¥</code></li>
<li>é€šçŸ¥è¬›è€…ç¤¾ç¾¤è»ŒæŠ•ç¨¿çµæœï¼š2023 å¹´ 06 æœˆ 23 æ—¥</li>
</ul>
<p>æ­¤å¤–åŸºæ–¼ CNCF ç¤¾ç¾¤æ²»ç†è¦ç¯„ï¼Œå¾ KCD Taiwan å°‡ Communtiy Group å–®ç¨æ‹†åˆ†å‡ºä¾†ï¼Œ</p>
<ul>
<li>Kubernetes Community Days Taiwan (KCD Taiwan), åŸºæ–¼ <a href="https://github.com/cncf/kubernetes-community-days">Kubernetes Community Days</a> æ²»ç†è¦ç¯„ï¼Œç¶²ç«™ç‚º <a href="https://community.cncf.io/kcd-taiwan/">https://community.cncf.io/kcd-taiwan/</a>ï¼Œç‚ºå¹´åº¦åœ°å€æ´»å‹•</li>
<li>Cloud Native Taiwan User Group (CNTUG), åŸºæ–¼ <a href="https://github.com/cncf/communitygroups">CNCF Community groups</a> æ²»ç†è¦ç¯„ï¼Œç¶²ç«™ç‚º <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">https://community.cncf.io/cloud-native-taiwan-user-group/</a>ï¼Œç‚ºä¾‹è¡Œç¤¾ç¾¤æ´»å‹•</li>
</ul>
<p>æ­¡è¿æœ‰æƒ³è¦è´ŠåŠ©ã€æ¼”è¬›çš„å€‹äººæˆ–å» å•†å¯ä»¥ä¾éœ€æ±‚å„åˆ¥è¨è«–</p>
<h3 id="kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-scability">Kubernetes Scability å¤šç¶­åº¦åˆ†æ</a></h3>
<p><img alt="" src="/images/scale-1.png" /></p>
<p>Kubernetes Scalabilty æ˜¯ä¸€å€‹å¤šç¶­åº¦çš„å•é¡Œï¼Œä¸å–®å–®åªæ˜¯ç”¨ç¯€é»å€‹æ•¸ä¾†åšç‚ºè¡¡é‡å”¯ä¸€åŸºç¤ï¼Œå»ºè­°åƒé–± <a href="https://docs.google.com/presentation/d/1aWjxpY4YJ4KJQUTqaVHdR4sbhwqDiW30EF4_hGCc-gI/edit#slide=id.p3">Kubecon 2018 NA - Kubernetes Scalability: A multi-dimensional analysis</a></p>
<p>é€™é‚Šæå¹¾å€‹æˆ‘è¦ºå¾—æ¯”è¼ƒé‡è¦çš„</p>
<ul>
<li><code># Nodes v.s. # Pods/node</code>: Nodes è¶Šå¤šã€Pod æ–¼å–®ä¸€ Node ä¸Šè¶Šå°‘ï¼Œç¯€é»è¶Šå¤šã€Pod æ–¼å–®ä¸€ç¯€é»ä¸Šå¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œé€šå¸¸ <code># Pods/Node</code> æ˜¯å›ºå®šçš„ï¼Œèƒ½å‹•çš„éƒ½æ˜¯ä»¥ <code># Nodes</code> å±…å¤šï¼Œæ‰€ä»¥å¯ä»¥å›ºå®š <code># Pods/Node</code> å†æ›ç®—ç¸½æ•¸</li>
<li><code># Services v.s. # Endpoints/Service</code>: Service è¶Šå¤šã€Endpoints/svc è¶Šå°‘ï¼ŒService è¶Šå°‘ï¼ŒEndpoint/svc å¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œ<code># Endpoints/Service</code> é€™å€‹ä¸è¦è¶…é 250 æˆ–ä¸è¦è¶…é <code># Pods/node</code> çš„ä¸Šé™</li>
<li><code># Service/ns</code>: Service è¶Šå¤šã€Namespace è¶Šå°‘ï¼ŒService è¶Šå°‘ã€Namespace å¯ä»¥è¶Šå¤šã€‚å€‹äººå»ºè­°ï¼Œ<code># Service/ns</code> é€™å€‹ä¸è¦è¶…é 5000ï¼Œæœƒæœ‰ Pod Crash çš„ç‹€æ³ç™¼ç”Ÿ</li>
</ul>
<h3 id="2023-slisslos"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#2023-slisslos">2023 SLIs/SLOs çš„è®ŠåŒ–</a></h3>
<p>ç•¶å¹´ 2015 çš„å…¶ä¸­ä¸€æ¢é‡å° API å‘¼å«çš„å®šç¾© "99% of all our API calls return in less than 1 second" å› ç‚ºé€™å¥è©±çœ‹çš„äººæœ‰å„ç¨®ä¸ä¸€æ¨£çš„è§£è®€ï¼Œæ‰€ä»¥åˆ°äº†ä»Šå¹´ 2023 å°±æ›æˆä¸‹åˆ— 2 å€‹æ›´ç‚ºå¯¦éš›çš„ SLI / SLO å®šç¾©ï¼Œè©³ç´°å¯ä»¥åƒè€ƒé€™å€‹ <a href="https://github.com/kubernetes/community/commit/6f1cc290b977b1a1f45c5cb7c15132a152e40b8d">Git Diff</a></p>
<details class="info" open="open">
<summary>SLI</summary>
<p>"Latency of processing mutating API calls for single objects for every (resource, verb) pair, measured as 99th percentile over last 5 minutes"
"é‡å°å–®ä¸€ç‰©ä»¶è™•ç†è®Šæ›´ API å‘¼å«çš„å»¶é²ï¼Œå°æ–¼æ¯ä¸€å€‹ï¼ˆè³‡æºã€å‹•ä½œï¼‰é…å°ï¼Œä»¥éå» 5 åˆ†é˜å…§çš„ç¬¬ 99 ç™¾åˆ†ä½é€²è¡Œæ¸¬é‡ã€‚"</p>
</details>
<p>é€™æ¢ä¸»è¦æœ‰æ’é™¤è«‹æ±‚åœ¨ Queue ä¸­çš„ç­‰å¾…æ™‚é–“ï¼Œå› ç‚ºæ²’æœ‰è¾¦æ³•é ä¼° Control Plane çš„è² è¼‰ç‹€æ³ï¼Œæ•…ä¸è€ƒæ…®é€™éƒ¨åˆ†çš„æ™‚é–“æ¶ˆè€—</p>
<details class="info" open="open">
<summary>SLO</summary>
<p>"In default Kubernetes installation, for every (resource, verb) pair, excluding virtual and aggregated resources, 99th perccentile per cluster-day &lt;=1s"
"åœ¨é è¨­çš„ Kubernetes å®‰è£ä¸­ï¼Œå°æ–¼æ¯ä¸€å€‹ï¼ˆè³‡æºã€å‹•ä½œï¼‰é…å°ï¼Œæ’é™¤è™›æ“¬å’Œèšåˆè³‡æºï¼Œæ¯å€‹é›†ç¾¤æ¯å¤©çš„ç¬¬ 99 ç™¾åˆ†ä½å»¶é²æ‡‰è©²å°æ–¼ç­‰æ–¼ 1 ç§’ã€‚"</p>
</details>
<p>å…¶å¯¦é‚„æœ‰é¡å¤–å®˜æ–¹æ‰¿èªå’Œæ­£åœ¨è¢«è¨è«–çš„ SLIs/SLOsï¼Œå¯åƒè€ƒ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></p>
<ol>
<li>API call latency SLIs/SLOs details</li>
<li>API call extension points latency SLIs details</li>
<li>In-cluster dns latency SLIs/SLOs details</li>
<li>DNS programming latency SLIs/SLOs details</li>
<li>In-cluster network latency SLIs/SLOs details</li>
<li>Network programming latency SLIs/SLOs details</li>
<li>Pod startup latency SLI/SLO details</li>
<li>Watch latency SLI details</li>
</ol>
<h3 id="_1"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_1">å¯æ“´å±•æ€§çš„å·²æ¸¬è©¦ç¯„åœ</a></h3>
<p><img alt="" src="https://raw.githubusercontent.com/kubernetes/community/master/sig-scalability/configs-and-limits/scalability-envelope.png" /></p>
<p>æƒ³è¦ç²¾ç¢ºåœ°å®šç¾©å¯æ“´å±•æ€§ç¯„åœ (Scalability envelope) æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†å¯ä»¥æŠ“åˆ°å¤§ç´„ä¸”åˆç†çš„ç¯„åœï¼Œè­¬å¦‚ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a> æ‰€åˆ—çš„ç¯„åœï¼Œè£¡é¢å°‡ scope æ‹†åˆ†æˆ 2 å€‹ç¶­åº¦: namespace å’Œ cluster</p>
<p>ä¾æˆ‘å€‹äººç†è§£ï¼Œä¸€èˆ¬ä¾†èªªæ¶æ§‹å¸«æœƒé—œå¿ƒçš„éƒ½æ˜¯ä¸‹åˆ—é€™å¹¾å€‹ç¯„åœï¼Œä¸»è¦æœƒæ‰¯åˆ°ç¶²è·¯ï¼Œå…¶ä»–é¸é …è¦çˆ†æ‰çš„æ©Ÿæœƒå…¶å¯¦è »ä½çš„ï¼Œè‡³æ–¼å„åˆ¥æ•¸å­—çš„è§£è®€å°±å› äººè€Œç•°äº†</p>
<table>
<thead>
<tr>
<th>Quantity</th>
<th>Threshold scope=namespace</th>
<th>Threshold: scope=cluster</th>
</tr>
</thead>
<tbody>
<tr>
<td>#Nodes</td>
<td>n/a</td>
<td>5000</td>
</tr>
<tr>
<td>#Namespaces</td>
<td>n/a</td>
<td>10000</td>
</tr>
<tr>
<td>#Pods</td>
<td>3000</td>
<td>150000</td>
</tr>
<tr>
<td>#Pods per node</td>
<td>min(110, 10*#cores)</td>
<td>min(110, 10*#cores)</td>
</tr>
<tr>
<td>#Services</td>
<td>5000</td>
<td>10000</td>
</tr>
<tr>
<td>#All service endpoints</td>
<td>TBD</td>
<td>TBD</td>
</tr>
<tr>
<td>#Endpoints per service</td>
<td>250</td>
<td>n/a</td>
</tr>
<tr>
<td>#Deployments</td>
<td>2000</td>
<td>TBD</td>
</tr>
</tbody>
</table>
<p>å€‹äººç¶“é©—ä¸Šï¼Œä¸Šé¢çš„æ•¸å­—å¦‚ Nodes / Pods / Pods per node / Services éƒ½è·Ÿè¦è¨ˆç®—å‡ºç¶²æ®µè¦åˆ‡å¤šå°‘ã€ç¯€é»è¦å¤šå°‘å€‹ï¼Œå¯æ‰¿è¼‰å¤šå°‘å·¥ä½œè² è¼‰é‡å¾ˆæœ‰é—œä¿‚ï¼Œæ‰€ä»¥åœ¨è¦ç•«çš„æ™‚å€™å‹™å¿…è¦ç›¸ç•¶æ¸…æ¥šã€‚</p>
<h3 id="_2"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_2">å¯¦éš›å£“æ¸¬æ–¹å¼</a></h3>
<p>ä¸»è¦å£“æ¸¬å·¥å…·æœƒç”¨ <a href="https://github.com/kubernetes/perf-tests/">kubernetes/perf-tests</a> è£¡é¢çš„å·¥å…·:</p>
<ul>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/cmd/kubemark">Kubemark</a></li>
</ul>
<p>è€Œè·‘å®Œæ¸¬è©¦å‰‡æœƒç”¢ç”Ÿæ¸¬è©¦å ±è¡¨å¯ä»¥è§€å¯Ÿç¾æ³</p>
<p><img alt="" src="/images/scale-2.png" /></p>
<p>æ¯æ¬¡ Kubernetes Release éƒ½è¦é€šé Peformance 100 nodes / 500 nodes / Correctness 5000 nodesï¼Œæ¸¬è©¦å…§å®¹éƒ½æ˜¯ç”± <a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a> ä¾†å®šç¾©ï¼Œè€Œå ±è¡¨å¯ä»¥å¾ <a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">https://testgrid.k8s.io</a> é€™é‚Šç²å¾—ã€‚ä»Šå¹´å› ç‚ºå„å®¶é ç®—ç·Šç¸®ï¼Œç¾åœ¨é€ Kubernetes Code ä¸Šå»ï¼Œé è¨­åªæœƒè·‘ Performance 100 Nodes è€Œå·²ï¼Œè€Œå¤§éƒ¨åˆ†çš„æ“´å±•æ€§è­°é¡Œéƒ½æœƒå‡ºç¾åœ¨è¦æ¨¡åœ¨è¶…éä»¥å¾Œ <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/governance/scalability-regressions-case-studies.md">100 Nodes</a></p>
<h3 id="_3"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_3">é æœŸæ”¹é€²æ–¹å‘</a></h3>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/flow-control/">Kubernetes v1.20 beta - API Priority &amp; Faireness</a></li>
<li><a href="https://github.com/kubernetes/enhancements/issues/3157">API Streaming Lists</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/114925">Gracefule shutdown</a></li>
<li>Kube-apiserver improvements</li>
<li>Improvements towards supporting higher throughput</li>
</ul>
<h3 id="qa"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#qa">Q&amp;A</a></h3>
<h4 id="q1-kubernetes-sig-autoscaling"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q1-kubernetes-sig-autoscaling">Q1: èˆ‡ Kubernetes SIG Autoscaling å·®ç•°æ˜¯?</a></h4>
<details class="note" open="open">
<summary>Note</summary>
<p>Not to confuse with SIG Autoscaling!</p>
</details>
<p>SIG Scalabilty é—œå¿ƒ Kubernetes æ•´é«”ç³»çµ±çš„æ¥µé™ï¼Œå¦‚æœä½ æ˜¯è² è²¬æä¾› Kubernetes å®‰è£å»ºç½®çš„æˆ–éœ€è¦åŸºæ–¼ä»¥ OSS Kubernetes ç‚ºåŸºç¤çš„è‡ªè¡Œç¶­è­·ç‰ˆæœ¬ï¼Œæœƒéœ€è¦é—œå¿ƒ Scalability è­°é¡Œ
SIG Autoscaling é—œå¿ƒ Horizontal Pod Autoscaling / Vertical Pod Autoscaling / Cluster Autoscalingï¼Œå¦‚æœä½ åªæ˜¯éœ€è¦ Kubernetes ä¸Šé¢çš„ç¨‹å¼éƒ¨ç½²ï¼Œå‰‡åƒ…éœ€è¦é—œå¿ƒ Autoscaling è­°é¡Œ</p>
<h4 id="q2-kubernetes-sig-scalability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q2-kubernetes-sig-scalability">Q2: Kubernetes SIG Scalability çš„ä¸»è¦ä»»å‹™æ˜¯?</a></h4>
<p>ä¸»è¦é é¢æ–¼ <a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability SIG (Special Interest Group)</a></p>
<p>5 å€‹ä¸»è¦çš„å·¥ä½œé ˜åŸŸ:</p>
<ol>
<li>å®šç¾©å’Œé©…å‹• (Define &amp; Drive): å®šç¾©å’Œé©…å‹•å¯æ“´å±•æ€§ç›®æ¨™</li>
<li>å”èª¿å’Œè²¢ç» (Coordinate &amp; Contribute): æ”¹é€² Performance æ›´æ¥è¿‘ç›®æ¨™</li>
<li>ç›£æ§å’Œé‡æ¸¬ (Montior &amp; Measure): é€éç›£æ§å’Œé‡æ¸¬ä¾†ç¢ºä¿å¯¦éš›ç³»çµ±è¡Œç‚ºæ¥è¿‘ç›®æ¨™</li>
<li>ä¿æŒå’Œä¿è­· (Preserve &amp; Protect): ç¢ºä¿ç³»çµ±å…å—å¯æ“´å±•æ€§å›æ­¸ (Scalability regressions) çš„å½±éŸ¿</li>
<li>è«®è©¢å’Œæ•™å­¸ (Consult &amp; Coach): é€éç¤¾ç¾¤å”ä½œç²å¾—æ›´å¤šçš„ä½¿ç”¨æ¡ˆä¾‹å’Œå›é¥‹ç¶“é©—</li>
</ol>
<h4 id="q3-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q3-kubernetes">Q3: Kubernetes æ•´é«”å£“åŠ›æ¸¬è©¦æœ€å¤§çš„é»åœ¨å“ªè£¡?</a></h4>
<p>Control Plane</p>
<h4 id="q4-5000"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q4-5000">Q4: æ¸¬è©¦ç¯€é» 5000 æ˜¯ä¸æ˜¯ä¸Šé™?</a></h4>
<p>ä¸æ˜¯ï¼Œè¬›è€…èªªä¸»è¦å¡åœ¨æ¸¬è©¦æˆæœ¬å¤ªé«˜ï¼Œæ­¤å¤–å¤šæ•¸ä½¿ç”¨è€…å°æ­¤æ²’æœ‰ä»€éº¼ç‰¹åˆ¥æœŸå¾…ï¼Œæ­£å¸¸è¦ç•«å¯ä»¥ä»¥ 100 Nodes ç‚ºåŸºç¤è¨­è¨ˆå°±å¥½</p>
<p>é—œæ–¼ç”¨ Azure Kubernetes Service è¨ˆç®— 5000 å€‹ç¯€é»çš„è¨ˆç®—æ–¹å¼ï¼Œå¯ä»¥åƒè€ƒä¹‹å‰å¯«çš„æ‹™ä½œ <a href="https://blog.pichuang.com.tw/20230214-openai-scaling-kubernetes-to-7500-nodes.html#azure-cni">çœ‹ OpenAI ä½¿ç”¨éˆ”èƒ½åŠ›æ‹›å–š Kubernetes 7500 å°ç¯€é»!!!</a>ï¼Œæœ‰è©³ç´°çš„è¨ˆç®—éç¨‹</p>
<h4 id="q5-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q5-kubernetes">Q5: å¦‚ä½•é‡æ¸¬ Kubernetes æ•´é«”çš„æ•ˆèƒ½? ç¬¬ä¸€æ­¥æ˜¯?</a></h4>
<p>ä¸Š Grafana + Prometheus æœƒæ˜¯å¾ˆå¥½çš„èµ·æ­¥ï¼Œæˆ–è€…æ˜¯å¯ä»¥å¾ <a href="https://landscape.cncf.io/card-mode?category=observability-and-analysis">CNCF Observability</a> æŒ‘å‡ºé©åˆçš„å·¥å…·ã€‚
è‹¥æƒ³è¦é‡å° Observability æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œå»ºè­°å¯ä»¥åƒåŠ  <a href="https://github.com/cncf/tag-observability">CNCF TAG (Technical Advisory Group) Observability ğŸ”­âš™ï¸</a></p>
<h3 id="references"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#references">References</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=bxY5Q5Eoj0s">Intro + Deep Dive: Kubernetes SIG Scalability - Wojciech Tyczynski, Google</a></li>
<li><a href="https://www.youtube.com/watch?v=VTFmsD9odZ4">Intro + Deep Dive: SIG Scalability - Marcel ZiÄ™ba &amp; Wojciech TyczyÅ„ski, Google</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a></li>
<li><a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability Special Interest Group</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></li>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a></li>
<li><a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">testgrid.k8s.io</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-17 00:00:00">April 17, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/sla/" class="md-meta__link">sla</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="composite-slas"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">è¨ˆç®—å‡ºæ­£ç¢ºçš„æœå‹™æ°´å¹³å”è­°ï¼šæ¢ç´¢ Composite SLAs è¨ˆç®—å’Œæ¶æ§‹è¨­è¨ˆ</a></h2>
<p>æœ€è¿‘é€™å¹¾å‘¨æ”¶åˆ°å¹¾å€‹æƒ³è¦åš SLA 99.999% çš„æ¡ˆå­ï¼Œå› æ¶‰åŠçš„æœå‹™çœ¾å¤šï¼Œæ‰€ä»¥æ•…é‡å°å¦‚ä½•åˆç†è¨ˆç®— SLA å’Œå…¶æ¶æ§‹è¨­è¨ˆå…ˆåšä¸€å€‹ç´€éŒ„ï¼Œä½†é€™é‚Šä¸¦ä¸æ¶‰åŠè³‡æ–™æœ€çµ‚ä¸€è‡´æ€§å’Œå°å¤–ç¶²è·¯çš„è¨­è¨ˆè¨è«–</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3pSue9nm3Bg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<h3 id="tldr"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#tldr">TL;DR</a></h3>
<ol>
<li>ç›¸æ¯”å–®ä¸€æœå‹™ SLA è¨ˆç®—ï¼Œè¤‡åˆ SLA (Composite SLA) æ˜¯æ›´ç‚ºåˆç†çš„è¨ˆç®—æ–¹å¼</li>
<li>è¤‡åˆ SLA (Composite SLA) æœƒéš¨èªåˆ—ç¯„åœä¸åŒè€Œæœ‰æ‰€è®ŠåŒ–ï¼Œå°±ç®—æ˜¯åŒä¸€å¼µæ¶æ§‹åœ–</li>
<li>è‹¥ç›¸ä¾æ€§æœå‹™è¶Šå¤šï¼Œå› å¯èƒ½å¤±æ•—ç™¼ç”Ÿé»å¤šï¼Œå‰‡è¤‡åˆ SLA æœƒå¿…ç„¶ä½æ–¼å–®ä¸€æœå‹™ SLA</li>
<li>å–®å€åŸŸæ¶æ§‹æä¾›å¤šå€‹å‚™æ´ä½œæ³•å¯å°å¹…æå‡æ•´é«” SLA</li>
<li>å¤šå€åŸŸæ¶æ§‹è¨­è¨ˆå¯ä»¥å¤§å¹…æå‡æ•´é«” SLAï¼Œè‡³å°‘ 2 å€‹å€åŸŸï¼Œè‡³å¤š 3 å€‹å€åŸŸ</li>
</ol>
<!--more-->

<h3 id="kubernetes-communtiy-day-taiwan-2023"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#kubernetes-communtiy-day-taiwan-2023">Kubernetes Communtiy Day Taiwan 2023 é–‹æ”¾å¾µç¨¿!!!</a></h3>
<p>COSCUP 2023 å°‡è‡³ï¼ŒCloud Native Taiwan User Group è·Ÿæ­·å¹´ä¸€æ¨£æˆ‘å€‘ä¹Ÿæœƒæ–¼ 2023/07/29 ~ 2023/07/30 å…§ï¼Œèˆ‰è¾¦ Kubernetes Communtiy Day Taiwan 2023</p>
<p>ç›®å‰å·²æ­£å¼é–‹æ”¾å¾µç¨¿ï¼Œå¯æ–¼  <a href="https://pretalx.coscup.org/coscup-2023/cfp">COSCUP æŠ•ç¨¿ç³»çµ±</a> é€²è¡ŒæŠ•ç¨¿</p>
<ul>
<li>æ­£å¼æŠ•ç¨¿é–‹å§‹æ—¥æœŸï¼š2023 å¹´ 04 æœˆ 14 æ—¥</li>
<li>æ­£å¼æŠ•ç¨¿æˆªæ­¢æ—¥æœŸï¼š2023 å¹´ 05 æœˆ 22 æ—¥</li>
<li>é€šçŸ¥è¬›è€…ç¤¾ç¾¤è»ŒæŠ•ç¨¿çµæœï¼š2023 å¹´ 06 æœˆ 23 æ—¥</li>
</ul>
<p>å¾…æŠ•ç¨¿çµæœå‡ºçˆå¾Œï¼Œæˆ‘å€‘ä¹Ÿæœƒå°‡ç›¸é—œè³‡è¨ŠåŒæ­¥ç™¼å¸ƒè‡³ <a href="https://community.cncf.io/kcd-taiwan/">KCD Taiwan å®˜æ–¹é é¢</a></p>
<p>æ­¡è¿å¤§å®¶å¤šå¤šåƒåŠ </p>
<h3 id="sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-composite-sla">å–®å€åŸŸå…§çš„è¤‡åˆ SLA (Composite SLA) è¨ˆç®—</a></h3>
<p>ç„¡è«–æ˜¯å“ªä¸€å®¶å» å•†æ‰€æä¾›çµ¦ä½ çš„ SLAï¼Œéƒ½æ˜¯åŸºæ–¼ä¸€å€‹é™å®šç¯„åœæˆ–ç‰¹å®šç”¢å“å…§ï¼Œæ‰€è¨‚ç«‹çš„ SLAï¼Œä½†æ­£å¸¸ç‹€æ³ä¸‹ä½ ä¸å¤ªå¯èƒ½åªå–®ç¨ä½¿ç”¨ä¸€å€‹æœå‹™å°±èƒ½æ’èµ·å…¨éƒ¨çš„å°å¤–æœå‹™</p>
<p>è¤‡åˆ SLA (Composite SLA) ä¸»è¦å°±æ˜¯å°‡å¤šå€‹æœå‹™çš„ä¸åŒå±¤ç´šçš„å¯ç”¨æ€§é€²è¡Œæ··åˆè¨ˆç®—ï¼Œåˆ†ç‚ºå…©å€‹å ´æ™¯: æœ‰æœå‹™ç›¸ä¾æ€§å’Œç„¡æœå‹™ç›¸ä¾æ€§</p>
<h4 id="1-and"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-and">1. AND: æœå‹™ä¹‹é–“æœ‰ç›¸ä¾æ€§</a></h4>
<p><img alt="" src="/images/sla-5.png" /></p>
<p>ä»¥ä¸Šåœ–ç‚ºä¾‹ï¼Œè‹¥æœ‰å€‹å°å¤–æœå‹™éœ€è¦åŒæ™‚ä½¿ç”¨åˆ° Azure Red Hat OpenShift å’Œ Azure Cosomos DB å­˜æ”¾è³‡æ–™ï¼Œå…©è€…æœå‹™ç¼ºä¸€ä¸å¯ï¼Œå‰‡è©² SLA è¨ˆç®—æ–¹å¼ç‚ºå…©è€…ç›¸ä¹˜å³å¯ï¼Œå¯å¾—è©²åœ– SLA ç‚º 99.94900005%</p>
<ul>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
</ul>
<p>Composite SLA = <mark class="critic">99.94900005%</mark> = 99.95% * 99.999%</p>
<h4 id="2-or"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#2-or">2. OR: æœå‹™ä¹‹é–“ç„¡ç›¸ä¾æ€§</a></h4>
<p><img alt="" src="/images/sla-6.png" /></p>
<p>ä»¥ä¸Šåœ–ç‚ºä¾‹ï¼Œè‹¥æœ‰å€‹å°å¤–æœå‹™éœ€è¦åŒæ™‚ä½¿ç”¨åˆ° Azure Red Hat OpenShift å’Œ Azure Cosomos DB å­˜æ”¾è³‡æ–™ï¼Œä¸”å¤šè¨­å®š Azure Service Bus ç•¶ä½œ Queue ä¾†ä½¿ç”¨ï¼Œå³ä½¿é€£ç·šä¸åˆ° Azure Cosmos DB æ™‚ï¼Œå°å¤–æœå‹™é‚„æ˜¯å¯ä»¥æ­£å¸¸é‹è¡Œï¼Œä½† Azure Cosmos DB å’Œ Azure Service Bus åŒæ™‚å¤±æ•ˆçš„æ™‚å€™ï¼Œå°å¤–æœå‹™å°±æœƒä¸­æ–·ã€‚</p>
<ul>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
<li>Azure Service Bus: 99.9%</li>
</ul>
<p>é‡å°ç„¡ç›¸ä¾æ€§æœå‹™ Azure Cosmos DB å’Œ Azure Service Bus éœ€è¦å„ªå…ˆè¨ˆç®— SLAï¼Œ</p>
<p>Composite SLA = 99.999999% = 1 - å…©è€…åŒæ™‚å¤±æ•—æ©Ÿç‡ = 1 - ((1 - 99.999%) * (1 - 99.9%))</p>
<p>å…¶æ¬¡å†é‡å°å‰é¢å¿…è¦æœå‹™ Azure Red Hat OpenShift é€²è¡Œç›¸ä¾æ€§è¨ˆç®—ï¼Œæ•…å¯å¾—:</p>
<p>Total Composite SLA = <mark class="critic">99.949999%</mark> = 99.95% * 99.999999%</p>
<h4 id="_1"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#_1">å°çµ</a></h4>
<table>
<thead>
<tr>
<th>æ¯”è¼ƒ</th>
<th>ç„¡ Queue</th>
<th>æœ‰ Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td>SLA</td>
<td>99.94900005%</td>
<td>99.949999%</td>
</tr>
<tr>
<td>Daily</td>
<td>44s</td>
<td>43s</td>
</tr>
<tr>
<td>Weekly</td>
<td>5m 8.4s</td>
<td>5m 2.4s</td>
</tr>
<tr>
<td>Monthly</td>
<td>22m 10s</td>
<td>21m 44s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1h 6m 30s</td>
<td>1h 5m 12s</td>
</tr>
<tr>
<td>Yearly</td>
<td>4h 26m 1.9s</td>
<td>4h 20m 49s</td>
</tr>
</tbody>
</table>
<p>é€éæ–°å¢ Queue æˆ–å…¶ä»–å‚™æ´æœå‹™ï¼Œå‰‡å¯ä»¥<mark class="critic">å°å¹…åº¦</mark>æå‡ SLA çš„æ•¸å­—</p>
<h3 id="sla-composite-sla_1"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-composite-sla_1">å¤šå€åŸŸå…§çš„è¤‡åˆ SLA (Composite SLA) è¨ˆç®—</a></h3>
<p>å¦‚ä½•å¤§å¹…åº¦æå‡ SLA? ç°¡å–®ä¾†èªªå°±æ˜¯è·¨å€åŸŸåšé«˜å¯ç”¨æ¶æ§‹ï¼Œåˆ†æ•£å–®ä¸€å€åŸŸå´©å£é¢¨éšª</p>
<h4 id="1-sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-sla-composite-sla">1. è¨ˆç®—å–®å€åŸŸå…§çš„è¤‡åˆ SLA (Composite SLA)</a></h4>
<p><img alt="" src="/images/sla-3.png" /></p>
<ul>
<li>Azure Load Balancer: 99.99%</li>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
<li>Azure Storage Accounts: 99.99%</li>
</ul>
<p>Composite SLA for Japan East = <mark class="critic">99.929011%</mark> = 99.99% * 99.95% * 99.999% * 99.99%</p>
<p>ä»¥å–®ä¸€å€åŸŸæœå‹™ä¾†è¬›ï¼Œ99.929011% å·²ç¶“æ¯”å¸¸è¦‹åŸºæœ¬è¦æ±‚ 99.9% ä¾†çš„å¥½ä¸å°‘äº†ï¼Œæ‰€ä»¥å°æ–¼å¾ˆå¤šæœå‹™ä¾†èªªé‚„ç®—æ˜¯å¯ä»¥æ¥å—çš„ç¯„åœï¼Œä½†å¦‚æœå°æ–¼è¦åšå‡º 99.999% ç­‰ç´šæœå‹™ä¾†è¬›æ˜¯æœ‰ç›¸ç•¶è·é›¢çš„ï¼Œæ•…ä¸‹é¢ä¾†è¨è«–æå‡ SLA</p>
<h4 id="2-sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#2-sla-composite-sla">2. è¨ˆç®—å¤šå€åŸŸå…§çš„è¤‡åˆ SLA (Composite SLA)</a></h4>
<ul>
<li>Azure Traffic Manager: 99.99%</li>
<li>Composite SLA for Japan East: 99.929011%</li>
<li>Composite SLA for Japan West: 99.929011%</li>
</ul>
<p><img alt="" src="/images/sla-4.png" /></p>
<p>é¦–å…ˆå…ˆè¨ˆç®—æ‡‰ç”¨ç¨‹å¼åœ¨æ‰€æœ‰å€åŸŸçˆ†ç‚¸çš„æ©Ÿç‡</p>
<p>æ‡‰ç”¨ç¨‹å¼åœ¨å¤šå€‹å€åŸŸåˆä½µ SLA å…¬å¼ç‚º (1 - (1 - SLA) ^ R)</p>
<ul>
<li>R: æ˜¯å€åŸŸæ•¸é‡</li>
<li>SLA: æ˜¯å–®ä¸€å€åŸŸçš„ SLA å”è­°æ•¸å­—</li>
</ul>
<p>æ•…å¯å¾—çŸ¥ç¨‹å¼ä½ˆç½²åœ¨å…©å€‹å€åŸŸæ™‚ï¼Œå¯ç²å¾—ä¸‹åˆ— SLA ç­‰ç´š</p>
<p>Composite SLA for Azure Red Hat OpenShift in 2 regions = <mark class="critic">99.9999%</mark> = (1 - (1 - 0.99929011)^2)</p>
<p>ä½†å› å‰é¢éœ€è¦æ”¾ç½® Azure Traffic Manager æœå‹™ç¢ºä¿å‰ç½®æµé‡èƒ½å¤ å…©é‚Šå°æµï¼Œæ•…é‚„éœ€è¨ˆç®—ï¼Œæ•…å¯å¾—</p>
<p>Totla Composite SLA = <mark class="critic">99.9899%</mark> = 99.99% * 99.99%</p>
<p>é€™é‚Šæœ‰éœ€è¦è¨è«–çš„åœ°æ–¹æ˜¯æœ‰æ²’æœ‰è¦æŠŠ Azure Traffic Manager åˆ—ç‚º SLA è¨ˆç®—ç¯„åœå…§ï¼Œå› ç‚ºå®ƒå…¶å¯¦å¯ä»¥æ”¾åœ¨ç¬¬ä¸‰å€‹å€åŸŸï¼Œç„¶å¾Œè©²æœå‹™ç‰¹æ€§ï¼Œæ˜¯åš DNS Queryï¼Œå¯¦éš›ä¸Šä¸æœƒå½±éŸ¿åˆ°ï¼Œå–®ä¸€å€åŸŸçš„é‹è¡Œï¼Œä½†é€™å€‹å› ä¸åŒä½¿ç”¨è€…èªåˆ—ç¯„åœè€Œç•°ï¼Œä¸ç„¶ä»¥ Azure Red Hat OpenShift æœ¬èº«é‹ä½œä¸‹ï¼Œé€éç¬¬äºŒå€‹å€åŸŸçš„å»ºç½®ï¼Œå°±å¯ä»¥ä¾†åˆ° 6 å€‹ 9 çš„ç­‰ç´šï¼Œå› é«˜æ–¼å¸¸è½åˆ° 5 å€‹ 9ï¼Œå°æ–¼ç¶­é‹é›™å¢é›† Kubernetes é‹ä½œç‚ºç›®æ¨™ä¾†è¬›æ˜¯ç›¸ç•¶è¶³å¤ çš„</p>
<h4 id="_2"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#_2">å°çµ</a></h4>
<table>
<thead>
<tr>
<th>æ¯”è¼ƒ</th>
<th>å–®å€åŸŸ</th>
<th>é›™å€åŸŸ</th>
</tr>
</thead>
<tbody>
<tr>
<td>SLA</td>
<td>99.929011%</td>
<td>99.9999%</td>
</tr>
<tr>
<td>Daily</td>
<td>1m 1.3s</td>
<td>0.086s</td>
</tr>
<tr>
<td>Weekly</td>
<td>7m 9.3s</td>
<td>0.6s</td>
</tr>
<tr>
<td>Monthly</td>
<td>30m 51s</td>
<td>2.6s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1h 32m 34s</td>
<td>7.8s</td>
</tr>
<tr>
<td>Yearly</td>
<td>6h 10m 18s</td>
<td>31s</td>
</tr>
</tbody>
</table>
<p>é€éæ–°å¢ä¸€å€‹å€åŸŸçš„æœå‹™ï¼Œå‰‡å¯ä»¥<mark class="critic">å¤§å¹…åº¦</mark>æå‡ SLA çš„æ•¸å­—</p>
<h3 id="sla-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-sla">ä»¥ç‰¹å®š SLA ç‚ºç›®æ¨™ï¼Œå–®å€åŸŸæ‰€éœ€æœ€ä½ SLA</a></h3>
<p>ä»¥å–®ä¸€å€åŸŸä½†ä¸é™æ–¼å…¶å–®ä½ (å¦‚æœå‹™ã€å€‹é«”æ•¸ã€AZ) æ‰€éœ€æœ€ä½ SLA è¨ˆç®—æ–¹å¼å¦‚ä¸‹:</p>
<p>å–®ä¸€å€åŸŸæ‰€éœ€æœ€ä½ SLA = (1 - (1 - SLA)^(1/R))</p>
<ul>
<li>R: æ˜¯å€åŸŸæ•¸é‡</li>
<li>SLA: æ˜¯é æœŸé”åˆ°çš„ SLA å”è­°æ•¸å­—</li>
</ul>
<p>Makrdown ç‰ˆ:</p>
<table>
<thead>
<tr>
<th>Availability</th>
<th>Target SLA</th>
<th>æ–¼ 1 å€‹ Region ä¹‹ä¸‹ï¼Œå–® 1 Region æœ€å° SLA éœ€</th>
<th>æ–¼ 2 å€‹ Region ä¹‹ä¸‹ï¼Œå–® 1 Region æœ€å° SLA éœ€</th>
<th>æ–¼ 3 å€‹ Region ä¹‹ä¸‹ï¼Œå–® 1 Region æœ€å° SLA éœ€</th>
<th>æ–¼ 4 å€‹ Region ä¹‹ä¸‹ï¼Œå–® 1 Region æœ€å° SLA éœ€</th>
</tr>
</thead>
<tbody>
<tr>
<td>2 Nines</td>
<td>99%</td>
<td>99.0000000%</td>
<td>90.0000000%</td>
<td>78.4556531%</td>
<td>68.3772234%</td>
</tr>
<tr>
<td>3 Nines</td>
<td>99.9%</td>
<td>99.9000000%</td>
<td>96.8377223%</td>
<td>90.0000000%</td>
<td>82.2172059%</td>
</tr>
<tr>
<td>3 and a half nines</td>
<td>99.95%</td>
<td>99.9500000%</td>
<td>97.7639320%</td>
<td>92.0629947%</td>
<td>85.0465122%</td>
</tr>
<tr>
<td>4 Nines</td>
<td>99.99 %</td>
<td>99.9900000%</td>
<td>99.0000000%</td>
<td>95.3584112%</td>
<td>90.0000000%</td>
</tr>
<tr>
<td>5 Nines</td>
<td>99.999%</td>
<td>99.9990000%</td>
<td>99.6837722%</td>
<td>97.8455653%</td>
<td>94.3765867%</td>
</tr>
<tr>
<td>6 Nines</td>
<td>99.9999%</td>
<td>99.9999000%</td>
<td>99.9000000%</td>
<td>99.0000000%</td>
<td>96.8377223%</td>
</tr>
<tr>
<td>7 Nines</td>
<td>99.99999%</td>
<td>99.9999900%</td>
<td>99.9683772%</td>
<td>99.5358411%</td>
<td>98.2217206%</td>
</tr>
<tr>
<td>8 Nines</td>
<td>99.999999%</td>
<td>99.9999990%</td>
<td>99.9900000%</td>
<td>99.7845565%</td>
<td>99.0000000%</td>
</tr>
<tr>
<td>9 Nines</td>
<td>99.9999999%</td>
<td>99.9999999%</td>
<td>99.9968377%</td>
<td>99.9000000%</td>
<td>99.4376587%</td>
</tr>
</tbody>
</table>
<p>å½©è‰²å¥½è®€ç‰ˆ:</p>
<p><img alt="" src="/images/sla-2.png" /></p>
<h3 id="qa"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#qa">Q&amp;A</a></h3>
<h4 id="q1-sla-683772234-2-nines"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q1-sla-683772234-2-nines">Q1: æŸæŸå€‹æœå‹™è¶…çˆ›ï¼Œä¸€å¤©æœƒç•¶æ©Ÿä¸ƒå°æ™‚ä»¥ä¸Šï¼Œç´„ <a href="https://uptime.is/68.3772234">SLA 68.3772234%</a>ï¼Œæ˜¯ä¸æ˜¯æ°¸é é”ä¸åˆ° 2 nines?</a></h4>
<p>A1:</p>
<p>ä»¥ä¸Šé¢è¨ˆç®—å–®ä¸€å€åŸŸæ‰€éœ€æœ€ä½ SLA è¨ˆç®—ä¾†èªªï¼Œä¸è€ƒæ…®è³‡æ–™ä¸€è‡´æ€§åŠç¶²è·¯å¯é”æ€§ï¼Œä½ åªè¦åœ¨ 4 å€‹ä¸åŒå€åŸŸå»ºç«‹ç›¸åŒ SLA <a href="https://uptime.is/68.3772234">68.3772234%</a> æœå‹™ï¼Œæœ€å·®é‚„æ˜¯å¯ä»¥æ‹¿åˆ° SLA 99% çš„ç­‰ç´š</p>
<p>ä½†...ä½ æ‡‰è©²è¦åšçš„äº‹æƒ…æ˜¯ç ”ç©¶ä¸€ä¸‹ç‚ºå•¥ä¸€å€‹æœå‹™ä¸€å¤©æœƒå™´æ‰ä¸ƒå°æ™‚ä»¥ä¸Šï¼Œè€Œä¸æ˜¯åœ¨é€™é‚Šç®—æ•¸å­¸</p>
<h4 id="q2-5-9-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q2-5-9-sla">Q2: ç‚ºä½•ä½¿ç”¨è€…é–‹é ­éƒ½èªªè«‹æä¾›çµ¦æˆ‘ 5 å€‹ 9 çš„ SLA æ¶æ§‹è¨­è¨ˆ?</a></h4>
<p>A2:</p>
<p><a href="https://uptime.is/99.999">SLA 99.999%</a> å¯æ¥å—åœæ©Ÿæ™‚é–“å¦‚ä¸‹:</p>
<ul>
<li><mark class="critic">Daily: 0.86s</mark></li>
<li>Weekly: 6s</li>
<li>Monthly: 26s</li>
<li>Quarterly: 1m 18s</li>
<li>Yearly: 5m 13s</li>
</ul>
<p>ä¸»è¦æ˜¯ Daily é€™å€‹æ•¸å­—æ˜¯å‰›å¥½ä½æ–¼ 1s çš„ï¼Œæ‰€ä»¥æ™®éæ‰æœƒæœ‰é€™å€‹ç†è§£ï¼ŒåŸºæœ¬ä¸Šè¦è¾¦åˆ°å°±æ˜¯ä¸€å®šè¦åšåˆ°æ•´é«”æ¶æ§‹ä¸èƒ½åœæ©Ÿã€ç•°åœ°æŠ„å¯«ã€ç¶²è·¯å…¨çƒè² è¼‰ã€CDN éƒ½è¦æ‹¿å‡ºä¾†ç”¨ï¼Œæƒ³ç•¶ç„¶è€Œæˆæœ¬æœƒå¾ˆé«˜ï¼Œç™½è©±ä¾†è¬›å°±æ˜¯ï¼Œé€™å€‹æœå‹™ä¸èƒ½æ‰</p>
<h4 id="q3-99999-sla-99929011"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q3-99999-sla-99929011">Q3: å¦‚æœæˆ‘è·Ÿçµ‚ç«¯å®¢æˆ¶ç°½äº†ä¸€å€‹ 99.999% çš„ SLA å”è­°ï¼Œä½†æˆ‘çŸ¥é“è‡ªå®¶æœå‹™åªæœ‰ç®—å‡º 99.929011%ï¼Œé€™æ¨£å¯ä»¥å—?</a></h4>
<table>
<thead>
<tr>
<th>Target SLA</th>
<th><a href="https://uptime.is/99.999">99.999%</a></th>
<th><a href="https://uptime.is/99.929011">99.929011%</a></th>
</tr>
</thead>
<tbody>
<tr>
<td>Daily</td>
<td>0.86s</td>
<td>1m 1.3s</td>
</tr>
<tr>
<td>Weekly</td>
<td>6s</td>
<td>7m 9.3s</td>
</tr>
<tr>
<td>Monthly</td>
<td>26s</td>
<td>30m 51s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1m 18s</td>
<td>1h 32m 34s</td>
</tr>
<tr>
<td>Yearly</td>
<td>5m13s</td>
<td>6h 10m 18s</td>
</tr>
</tbody>
</table>
<p>SLA åªæ˜¯ä¸€ç´™æ‰¿è«¾ï¼Œè‹¥å·²çŸ¥ä¸­é–“é€™éº¼å¤§çš„é¢¨éšªï¼Œç°½ä¸‹å»ç•¶ç„¶å°±æ˜¯å¾—è¦è‡ªå·±æ‰›çš„ä½ï¼Œä¸ç„¶å°±æ˜¯å†æŠ•æ³¨æˆæœ¬æŠŠæ¶æ§‹æŒçºŒæ”¹å–„åˆ°æ¥è¿‘ç›®æ¨™</p>
<h4 id="q4-azure"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q4-azure">Q4: æœ‰å¦ Azure æ¨è–¦çš„å¤šå€åŸŸæ¶æ§‹èªªæ˜?</a></h4>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/high-availability/reference-architecture-traffic-manager-application-gateway">Multi-region load balancing with Traffic Manager and Application Gateway</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/high-availability/images/high-availability-multi-region-v-9.png" /></p>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/multitenant-saas">Multitenant SaaS on Azure</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/media/multitenant-saas.png" /></p>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/multi-region-sql-server">Multi-region N-tier application</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/images/multi-region-sql-server.png" /></p>
<h4 id="q5-azure-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q5-azure-sla">Q5: æœ‰å¦ Azure SLA å®˜æ–¹æ¸…å–®?</a></h4>
<ul>
<li>å¥½è®€ç‰ˆ: <a href="https://azurecharts.com/sla">Azure SLA Board</a></li>
<li>å®˜æ–¹æ–‡ä»¶ç‰ˆ: <a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">Service Level Agreements (SLA) for Online Services</a></li>
</ul>
<h4 id="q6-azure-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q6-azure-sla">Q6: é™¤äº† Azure éœ€è¦ç®—å‡º SLA ä»¥å¤–ï¼Œé‚„æœ‰æ²’æœ‰ä»€éº¼æ˜¯éœ€è¦è‡ªè¡Œè€ƒé‡çš„?</a></h4>
<p>A6:</p>
<p>æœ‰ï¼Œä½¿ç”¨è€…è‡ªå·±æ‡‰ç”¨ç¨‹å¼çš„ SLA</p>
<p>æ­£ç¢ºä½ æ‡‰è©²å¯ä»¥æä¾›å‡ºå»çš„ SLA ç†è«–ä¸Šæ˜¯ <mark class="critic">Composite SLA = æ‡‰ç”¨ç¨‹å¼ SLA * åŸºç¤æ¶æ§‹ SLA</mark> è€Œä¸æ˜¯åƒ…æä¾›ä¸€æ–¹çš„ SLA ä¿è­‰</p>
<p>å¦‚æœç¨‹å¼å¯«å¾—å¤ªçˆ›ï¼Œä¾‹å¦‚å¤©å¤© OOMã€Crashã€Query æ•ˆèƒ½å¤ªå·®ç­‰ç­‰ï¼ŒæŒ‰ç…§è²¬ä»»åŠƒåˆ†ï¼Œé€™å€‹æ˜¯å€‹åˆ¥ä½¿ç”¨è€…æ‡‰è©²è¦è‡ªå·±è² è²¬çš„ï¼Œè€ŒéåŸºç¤å¹³å°èƒ½æ‰›çš„</p>
<h3 id="referecens"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#referecens">Referecens</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=3pSue9nm3Bg">Composite SLA V2</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/architecture/framework/resiliency/business-metrics">ä½¿ç”¨å•†å‹™è¨ˆé‡ä¾†è¨­è¨ˆå…·å¾©åŸåŠŸèƒ½çš„ Azure æ‡‰ç”¨ç¨‹å¼</a></li>
<li><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">Service Level Agreements (SLA) for Online Services</a></li>
<li><a href="https://azurecharts.com/sla">Azure SLA Board</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/high-availability/reference-architecture-traffic-manager-application-gateway">Multi-region load balancing with Traffic Manager and Application Gateway</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/multitenant-saas">Multitenant SaaS on Azure</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/multi-region-sql-server">Multi-region N-tier application</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-11 00:00:00">April 11, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/o11y/" class="md-meta__link">o11y</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="network-latency-slos-4"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/">å¦‚ä½•å®šç¾© Network Latency SLOs? 4 å€‹è¨­è¨ˆåŸå‰‡èˆ‡ç™¾åˆ†ä½æ•¸è§£æ</a></h2>
<details class="note" open="open">
<summary>Note</summary>
<p>è¡¡é‡ä½ æƒ³è¦ç›£æ§çš„å…§å®¹æ„ç¾©ï¼Œä¸è¦åªç›£æ§æ‚¨ç¢°å·§èƒ½å¤ è¼•é¬†ç›£æ§çš„å…§å®¹</p>
</details>
<p>Service Level Objectives (SLO) å¯ä»¥è®“ä½ æ¸…æ¥šçš„ç†è§£ç¾åœ¨ç³»çµ±é‹ä½œçš„ç‹€æ³ï¼Œä½†å®ƒèƒŒå¾Œçš„æ•¸å­—ä»£è¡¨æ„ç¾©æ˜¯éœ€è¦é€éä¸€é€£ä¸²çš„æ•¸å­—çµ±è¨ˆå’Œè¨ˆç®—è€Œå¾—çš„ã€‚è€Œæœ€è¿‘ç„¡è«–æ˜¯è¨­è¨ˆè·¨åœ‹ç¶²è·¯ï¼Œé›²åœ°æ··åˆç¶²è·¯ï¼Œéƒ½æœƒé‡åˆ°ä¸€å€‹é—œéµå…ƒç´ : <code>Latency</code> å»¶é²ï¼Œå°æ–¼è³‡æ–™å‚³è¼¸ä¾†èªªï¼Œå»¶é²æ˜¯ä¸€å€‹å¾ˆé‡è¦çš„æŒ‡æ¨™ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦ä¸€å€‹æ–¹æ³•ä¾†å®šç¾©é€™å€‹æŒ‡æ¨™ï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯è¦ä¾†ä»‹ç´¹å¦‚ä½•å®šç¾© Network Latency SLOs</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lJ8ydIuPFeU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<!--more-->

<h3 id="4"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#4">4 å€‹è¨­è¨ˆåŸå‰‡</a></h3>
<ol>
<li>å–®ä½å¿…é ˆæ˜¯ <code>milliseconds (ms)</code></li>
<li>å»ºè­°è¦å‘ˆç¾ 6 å€‹ç™¾åˆ†ä½æ•¸ (P, Percentile) : <code>P50, P75, P90, P99, P99.9, P99.99</code></li>
<li>é™¤äº†ä¸Šè¿°çš„ç™¾åˆ†ä½æ•¸ï¼Œå¦‚æœè¦æ–°å¢æ–°çš„ç™¾åˆ†ä½æ•¸ï¼Œå‰‡éœ€è¦ä¸€å®šè¦ <code>&gt;= P50</code>ï¼Œè‹¥ä½æ–¼ P50 å‰‡æ²’æœ‰æ„ç¾©</li>
<li>SLO Target éœ€è¦åŒ…å«ä¸Šè¿°æœ€å°‘ 2 å€‹ç™¾åˆ†ä½æ•¸ï¼Œå…¶ä¸­ä¸€å€‹å¿…é ˆæ˜¯ <code>P99</code></li>
</ol>
<h3 id="network-latency-slo"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#network-latency-slo">Network Latency SLO å¸¸è¦‹æè¿°</a></h3>
<p>æ¡ç”¨ç™¾åˆ†ä½æ•¸è¡¨ç¤ºæ³•: æ–¼ç‰¹å®šæœå‹™ Xï¼Œç™¾åˆ†ä½æ•¸ % Latency åœ¨ ç‰¹å®šæ™‚é–“å€æ®µ P å…§ éœ€è¦å°æ–¼å¤šå°‘ T ms"</p>
<blockquote>
<p>â€œCompoents X report that % of latency in PERIOD are served in &lt; T msâ€</p>
</blockquote>
<p>åœ¨å¤šæ•¸ç‹€æ³ä¾†è¬›ï¼ŒLatency æ˜¯è¶Šä½è¶Šå¥½ (Lower is Better)ï¼Œæ‰€ä»¥å¾Œé¢çš„åˆ¤æ–·å¼ç‚º<code>å°æ–¼</code>ç‚ºä¸»</p>
<h3 id="_1"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#_1">ç™¾åˆ†ä½æ•¸è§£æ</a></h3>
<p>ä»¥ä¸‹åˆ—è³‡æ–™é›†ä½œç‚ºç¯„ä¾‹</p>
<div class="highlight"><span class="filename">data set</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>40, 38, 39.3, 120, 50, 78, 38.1, 37.2, 100, 39, 37, 37.3
</code></pre></div>
<p><img alt="" src="/images/latency-slo.png" /></p>
<h4 id="p50-median"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#p50-median">ç‚ºä½•è¦è¨­å®š P50 (ä¸­ä½æ•¸, Median)?</a></h4>
<blockquote>
<p>ç‰¹å®šæ™‚é–“å€æ®µä¸­ï¼Œ100 å€‹æ•¸å­—ä¸­ï¼Œå¾å°åˆ°å¤§é€²è¡Œæ’åºï¼Œç¬¬ 50% æ•¸å­—ï¼Œä»¥ä¸Šé¢ Data Set ç‚ºä¾‹ï¼ŒP50 = <code>39.15</code>ï¼Œä»£è¡¨ 50% çš„ Network Latency åœ¨ 39.15ms ä»¥ä¸‹æˆ–æ›´å°</p>
</blockquote>
<ol>
<li>é©åˆæƒ…å¢ƒ: é©åˆçœ‹å…¨ç«™ç¶²è·¯æ•ˆèƒ½ä¸‹é™æˆ–ä¸Šå‡ï¼Œæ•´é«”æ›²ç·šç©©å®š</li>
<li>ä¸é©åˆæƒ…å¢ƒ: ä½¿ç”¨è€…è·Ÿä½ èªªä»–<code>ç¾åœ¨é€£ç·š</code>å¾ˆæ…¢</li>
<li>èƒ½å¤ é¿å…: éå¸¸æ…‹åˆ†ä½ˆç‹€æ³ (Non-normal distributions) å’Œåå·®å€¼å½±éŸ¿</li>
</ol>
<p><a href="https://learn.microsoft.com/en-us/azure/networking/azure-network-latency">Azure network round-trip latency statistics</a> å…¶å¯¦å°±æ˜¯ä¸€å€‹æœ€å¥½çš„ç¯„ä¾‹ï¼Œä¸‹åœ–æä¾›äº†æ–¼ <code>2022/06 æ™‚é–“ 30 å¤©å€æ®µ P50 çš„ Latency è¡¨ç¾</code></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/networking/media/azure-network-latency/azure-network-latency-thmb-july-2022.png" /></p>
<h4 id="p99"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#p99">ç‚ºä½•è¦è¨­å®š P99 æˆ–æ›´é«˜ç™¾åˆ†ä½æ•¸?</a></h4>
<blockquote>
<p>ç‰¹å®šæ™‚é–“å€æ®µä¸­ï¼Œ100 å€‹æ•¸å­—ä¸­ï¼Œå¾å°åˆ°å¤§é€²è¡Œæ’åºï¼Œç¬¬ 99% çš„æ•¸å­—ï¼Œä»¥ä¸Šé¢ Data Set ç‚ºä¾‹ï¼ŒP99 = <code>119.98</code>ï¼Œä»£è¡¨ 99% çš„ Network Latency åœ¨ 119.98ms ä»¥ä¸‹æˆ–æ›´å°</p>
</blockquote>
<ol>
<li>é©åˆæƒ…å¢ƒ: è²¼è¿‘ä½¿ç”¨è€…ç•¶ä¸‹ä½¿ç”¨ç‹€æ³ï¼Œå¯ä»¥å……åˆ†åæ˜ ç•¶å‰ç¨‹å¼è¨­è¨ˆè®ŠåŒ–å°è‡´çš„å½±éŸ¿ï¼Œè­¬å¦‚èªªå¾Œç«¯æœå‹™å¯«å¤ªæ…¢æˆ–æ•ˆç‡ä¸å¥½å°è‡´å¾ˆæ…¢</li>
<li>ä¸é©åˆæƒ…å¢ƒ: æƒ³è¦çŸ¥é“å…¨ç«™å¸¸æ…‹ç©©å®šåº¦å¦‚ä½•</li>
<li>èƒ½å¤ é¿å…: å¸¸æ…‹åˆ†ä½ˆç‹€æ³ (Normal distributions) å°è‡´å¿½è¦–åå·®å€¼ç‹€æ³</li>
</ol>
<p>å¸¸è¦‹æœƒçœ‹åˆ° P99.9 æ¯”è¼ƒé©ç”¨æ–¼ Application ç«¯ï¼Œå¦‚æœä½ æ˜¯ä»¥ Infra è§’åº¦çœ‹ P99.9 çš„è©±ï¼Œç™¾åˆ†ä½æ•¸è¶Šé«˜æœ€ä½³åŒ–æˆæœ¬æœƒè¶…é«˜ï¼Œè­¬å¦‚èªªä½ æƒ³è¦é€™éº¼æ¥µç«¯é™ä½ Network Latency å’Œ Jitter çš„è©±ï¼Œæˆ‘çœ‹å¤§æ¦‚è¦å…‰çº–ç›´é€£ï¼Œæˆ–è€…æ˜¯ä¸­é–“è¨­å‚™éƒ½æ˜¯è¶…é«˜æª”çš„ Router å’Œ Switch å¯èƒ½æ¯”è¼ƒæœ‰æ©Ÿæœƒè¾¦åˆ°...å° Infra ä¸å¤ªç¾å¯¦</p>
<h4 id="average"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#average">ä¸è¦ä½¿ç”¨å¹³å‡å€¼ (Average)</a></h4>
<details class="note" open="open">
<summary>Note</summary>
<p>å¹³å‡å€¼ (Average) ä¸ç­‰æ–¼ P50 (ä¸­ä½æ•¸, Median)</p>
</details>
<p>å¹³å‡å€¼ (Average) å°±æ˜¯ç®—è¡“å¹³å‡æ•¸ï¼Œè¨ˆç®—æ–¹å¼ç‚ºä¸€çµ„æ•¸å­—ç›¸åŠ ï¼Œç„¶å¾Œå†é™¤æ–¼é€™çµ„æ•¸å­—çš„å€‹æ•¸ï¼Œä¸èƒ½åæ˜ ç•¶å‰ç‹€æ³ï¼Œå› ç‚ºå¹³å‡å€¼æœƒå—åˆ°æ¥µç«¯å€¼å½±éŸ¿ï¼Œè«‹ç”¨ä¸­ä½æ•¸ (P50) æ›¿ä»£</p>
<p>èˆ‰ä¾‹ä¸€å€‹æ¥µç«¯ä¾‹å­æŠŠ Fibonacci Series åˆ—å‡ºä¾†ï¼Œç®—å‡ºä¾†çš„å¹³å‡å€¼è·Ÿ P50 æœƒæœ‰ç›¸ç•¶å¤§çš„å·®è·ï¼Œå› å—åˆ°å¤§æ•¸å½±éŸ¿ï¼Œå¹³å‡å€¼æœƒé å¤§æ–¼ P50ã€‚æ›å€‹ç™½è©±ä¾†è¬›ï¼Œæˆ‘ã€å°ç£é¦–å¯Œã€å…¨çƒé¦–å¯Œ 3 ä½å¹³å‡èµ·ä¾†ï¼Œå¯ä»¥è²·ä¸‹ä¸€æ£Ÿ 101ï¼Œç›¸ç•¶ä¸æº–ç¢º...</p>
<p>æ ¹æ“š <a href="https://latencytipoftheday.blogspot.com/2014/06/latencytipoftheday-average-random.html">#LatencyTipOfTheDay: Average (def): a random number that falls somewhere between the maximum and 1/2 the median. Most often used to ignore reality.</a>ï¼ŒæŒ‡å‡º Average å› ä»‹æ–¼ç‚ºæœ€å¤§å€¼ (MAXIMUM) ~ ä¸­ä½æ•¸/2 ä¹‹é–“</p>
<p><img alt="" src="/images/fibonacci.png" /></p>
<p>æ•…ä½ è€é—†æˆ–ä½¿ç”¨è€…è¦æ±‚ä½ <code>æä¾›æŸæŸç³»çµ±çš„é‹è¡Œå¹³å‡ç‹€æ³</code>ï¼Œæ­£ç¢ºä¾†èªªæ‡‰è©²è¦è‡ªè¡Œç¿»è­¯æˆ<code>æä¾›æŸæŸç³»çµ±çš„ä¸­ä½æ•¸ (P50) ç‹€æ³</code> æ‰æ˜¯æ¯”è¼ƒæ­£ç¢º</p>
<h3 id="_2"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#_2">å€‹äººå»ºè­°</a></h3>
<p>åŸºæ–¼ <code>P50, P75, P90, P99, P99.9, P99.99</code>ï¼Œä»¥ P99 ç‚ºä¸­å¤®ä¼</p>
<ul>
<li>å¦‚æœä½ æ˜¯åå‘ Infrastructure ç›£æ§æˆ–è€…æ˜¯ååŸºç¤å»ºè¨­çš„ Administratorï¼Œå»ºè­°å¯ä»¥é•·æœŸè¿½è¹¤ P50, P75, P90, P99 é€™å››æ¢çš„è®ŠåŒ–ï¼Œå› ç‚ºé€™å››æ¢çš„è®ŠåŒ–ï¼Œå¯ä»¥åæ˜ å‡ºä½ çš„åŸºç¤å»ºè¨­æ˜¯å¦ç©©å®š</li>
<li>å¦‚æœä½ æ˜¯åå‘ Application ç›£æ§æˆ–è€…æ˜¯å API æ•ˆèƒ½çš„ Developerï¼Œå»ºè­°å¯ä»¥è¿½è¹¤ P99, P99.9, P99.99 é€™ä¸‰æ¢çš„è®ŠåŒ–ï¼Œæ¯”è¼ƒèƒ½å¤ åæ˜ å‡ºä½ çš„ç¨‹å¼æ˜¯å¦æœ‰ç‰¹æ®Šç‹€æ³</li>
<li>ä¸Šç­å¹³æ™‚ä¾‹è¡Œå ±å‘ŠæŠ“ P50 æ•¸å­—ï¼Œè‡¨æ™‚å‡ºäº‹æŠ“ P99 æˆ–æ›´é«˜æ•¸å­—æ¯”è¼ƒå¥½ç†è§£ç¾åœ¨ç™¼ç”Ÿå•¥äº‹</li>
</ul>
<h3 id="qa"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#qa">Q&amp;A</a></h3>
<h4 id="q1-ping-rtt-avg"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#q1-ping-rtt-avg">Q1: å¦‚æœæˆ‘è‡¨æ™‚ä½¿ç”¨ ping å°ç‰¹å®šæœå‹™åš RTT é‡æ¸¬ï¼Œé‚£ä»–åªæœ‰ avg. å‘ˆç¾ï¼Œé‚£é€™æ¨£æº–å—?</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$ ping www.microsoft.com.tw
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>PING microsoft.com.tw (20.112.52.29) 56(84) bytes of data.
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=1 ttl=108 time=134 ms
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=2 ttl=108 time=137 ms
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=3 ttl=108 time=139 ms
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=4 ttl=108 time=137 ms
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>^C
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>--- microsoft.com.tw ping statistics ---
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>4 packets transmitted, 4 received, 0% packet loss, time 10238ms
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>rtt min/avg/max/mdev = 133.904/136.817/138.914/1.855 ms
</code></pre></div>
<p>A1: ä»¥ä¸Šé¢çš„æ•¸å­—ä¾†çœ‹ï¼Œä»–çš„ P50 æ˜¯ 134ï¼Œèª å¦‚ä¸Šé¢è¬›ï¼Œçœ‹ avg. ä¸æº–ï¼Œ<code>åœ¨ç¶²è·¯ç›¸å°ç©©å®šçš„ç‹€æ³ä¸‹ï¼Œåªèƒ½èªªæœ‰é«˜åº¦æ©Ÿæœƒå¹³å‡å€¼è¿‘ä¼¼æ–¼ P50</code>ï¼Œä½†ä½ ç”¨ ping å·¥å…·ç›®çš„ä¸æ˜¯çœŸçš„è¦é•·æœŸç›£æ§æ•¸æ“šï¼Œä¸»è¦æ˜¯è‡¨æ™‚ç¶²è·¯é™¤éŒ¯ï¼Œè­¬å¦‚èªªæŠ“çˆ† pingã€æˆ–è€…æ˜¯è‡¨æ™‚æ”¶é›†ä¸€ä¸‹ç¶²è·¯ç‹€æ³ï¼Œä»¥é™¤éŒ¯ä¾†è¬›æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œæ‰€ä»¥å¤§å®¶é‚„æ˜¯å¯ä»¥åŠ æ¸›ç”¨ç”¨</p>
<h3 id="references-"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#references-">References-</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/networking/azure-network-latency">Azure network round-trip latency statistics</a></li>
<li><a href="https://latencytipoftheday.blogspot.com/">Latency Tip Of The Day</a></li>
<li><a href="https://www.circonus.com/2018/08/latency-slos-done-right/">Latency SLOs Done Right</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-16 00:00:00">March 16, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/openai/" class="md-meta__link">openai</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openai-api"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/">ä½¿ç”¨ OpenAI API é–‹ç™¼ç¶“é©—åˆ†äº«</a></h2>
<details class="note" open="open">
<summary>Note</summary>
<p>å›  OpenAI ç›¸é—œæŠ€è¡“ç™¼å±•ç¥é€Ÿï¼Œæœ¬æ–‡æœ‰æ•ˆæ™‚é–“å¯èƒ½ä¸ç®—å¤ªé•·ï¼Œé–±è®€å¾Œå‹™å¿…è¦è‡ªè¡Œå†ç”¨è‡ªèº«ç¶“é©—é©—è­‰</p>
</details>
<p>å¾ˆä¹…æ²’å¯« Pythonï¼Œä½†æˆ‘æœ¬ä¾†åªæ˜¯æƒ³è¦ç ”ç©¶ä¸€ä¸‹ APM (Application Performance Monitoring) æ€éº¼é †åˆ©åœ°è·‘åœ¨ AKS å’Œ ARO ä¸Šï¼Œç„¶å¾Œå°±ä¸å°å¿ƒå°±æŠŠ Line Bot ft. OpenAI å¯«ä¸€å¯«äº†ï¼Œæ—¢ç„¶å¯«äº†å°±é †ä¾¿ç´€éŒ„ä¸€ä¸‹</p>
<h3 id="tldr"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#tldr">TL;DR</a></h3>
<ol>
<li>Azure OpenAI Service å’Œ OpenAI çš„ API å‘¼å«æœ‰å¯èƒ½æœƒä¸ä¸€æ¨£ï¼Œå‹™å¿…è¦ç¢ºèª</li>
<li>Error Handling å»ºè­°è¦åšï¼Œä¸ç„¶ä½ æ°¸é åªæœƒæ”¶åˆ° 500 Internal Server Error</li>
<li>ç§æœ‰ç¶²è·¯é€£å…¥æ–¹å¼ï¼Œå”¯ä¸€é¸æ“‡ Azure OpenAI Service</li>
</ol>
<!--more-->

<h3 id="azure-openai-service-openai"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#azure-openai-service-openai">Azure OpenAI Service èˆ‡ OpenAI ç•°åŒä¹‹è™•</a></h3>
<p>åŸºæ–¼å°å¼Ÿè‡ªè¡Œå¯«éå…©é‚Šæœå‹™çš„ç¶“é©—å’Œå° Azure ç†Ÿæ‚‰ç¨‹åº¦ï¼Œåˆ—èˆ‰å‡ºä¸‹åˆ—çš„æ¯”è¼ƒ</p>
<table>
<thead>
<tr>
<th>Features</th>
<th>Azure OpenAI Service (AOAI)</th>
<th>OpenAI (OAI)</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœå‹™å®šä½</td>
<td>ç©©å®š</td>
<td>æœ€æ–°</td>
</tr>
<tr>
<td>API Endpoint</td>
<td>https://{your own endpoint}.openai.azure.com</td>
<td>https://api.openai.com</td>
</tr>
<tr>
<td>SLA</td>
<td><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">99.9%</a></td>
<td><a href="https://openai.com/pricing">æœªä¾†æœƒæ¨å‡º</a></td>
</tr>
<tr>
<td>æ¨¡å‹æ”¯æ´</td>
<td>GPT-3.5, DALL-E and Codex (including Codex Fine-Tuning)</td>
<td>GPT-3.5, Codex and DALL-E, ChatGPT API and Whisper API</td>
</tr>
<tr>
<td>Azure å¯ç”¨å€åŸŸ</td>
<td><a href="https://azure.microsoft.com/en-us/explore/global-infrastructure/products-by-region/?products=cognitive-services&amp;regions=all">3 å€‹</a>, West Europe/South Central US/East US</td>
<td>1 å€‹, US</td>
</tr>
<tr>
<td>ä¸»è¦æœå‹™çª—å£</td>
<td>Microsoft Azure</td>
<td>OpenAI</td>
</tr>
<tr>
<td>å®¢æˆ¶æ”¯æ´æ–¹å¼</td>
<td>åœ¨åœ° Azure åœ˜éšŠ</td>
<td>éœ€è‡ªè¡Œæ‰¾ OpenAI åœ˜éšŠ</td>
</tr>
<tr>
<td>æ”¯æ´ä»˜æ¬¾æ–¹å¼</td>
<td>ä½¿ç”¨ MACC (Microsoft Azure Consumption Commitment)</td>
<td>ä¿¡ç”¨å¡æˆ–å…¶ä»–æ–¹å¼</td>
</tr>
<tr>
<td>Public API Endpoint</td>
<td>å¯</td>
<td>å¯</td>
</tr>
<tr>
<td>Public API Endpoint è³‡å®‰æ©Ÿåˆ¶</td>
<td>å¯é™å®šç‰¹å®š IP æˆ–ç‰¹å®š Subnet é€£å…¥</td>
<td>ç„¡</td>
</tr>
<tr>
<td>Private API Endpoint</td>
<td>ä½¿ç”¨ Azure Private Endpoint / Private Link</td>
<td>ç„¡</td>
</tr>
<tr>
<td>Security</td>
<td>å¯æ²¿ç”¨ Azure æ—¢æœ‰è³‡å®‰æœå‹™</td>
<td>éœ€è‡ªè¡Œè™•ç†</td>
</tr>
<tr>
<td>RBAC</td>
<td>æ¡ç”¨ Azure Acitve Directory æˆ–è‡ªè¡Œæ•´åˆ 3rd SSO</td>
<td>OpenAI è‡ªå¸¶ SSO æˆ–è‡ªè¡Œæ•´åˆ 3rd SSO</td>
</tr>
</tbody>
</table>
<h3 id="_1"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#_1">å€‹äººç¶“é©—åˆ†äº«</a></h3>
<p>æ•´é«”æ¶æ§‹åœ–</p>
<p><img alt="" src="/images/openai-bot-arch.png" /></p>
<h4 id="bot"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#bot">Bot ä¸»ç¨‹å¼</a></h4>
<p>ä¸»è¦ç›®çš„æ˜¯å¸Œæœ›èƒ½è®“ Line å¯ä»¥ä¸²æ¥åˆ° OpenAI APIï¼Œç›´æ¥ä½¿ç”¨ Line é€²è¡Œå°è©±ï¼Œç›®å‰å·²å¯¦ä½œå‡ºä¸‹åˆ— 3 ç¨®æ–¹å¼ï¼Œä¸»è¦æœƒé‡å° 2 å’Œ 3 ä»¥ Python ç‚ºä¸»çš„æ–¹å¼ä½œæ¢è¨</p>
<ol>
<li>OpenAI API + Nodejs 11</li>
<li>OpenAI API + Python 3.9 + Flask</li>
<li>Azure OpenAI API + Python 3.9 + Flask</li>
</ol>
<p>è‹¥ä»¥ Python 3 ç‚ºä¸»çš„é–‹ç™¼èªè¨€ï¼Œä½ æœƒéœ€è¦çŸ¥é“ä¸‹åˆ—å¹¾å€‹ Python ç›¸é—œçš„è³‡è¨Šï¼ŒåŸºæœ¬ä¸Šå…¨éƒ¨éƒ½ä¸€æ¨£
ï¼Œè¦ç•™æ„ AOAI è·Ÿ OAI æ‰€ä½¿ç”¨åˆ°çš„ Python SDK <code>ç›®å‰</code>æ˜¯åŒä¸€å€‹</p>
<table>
<thead>
<tr>
<th>DX</th>
<th>Azure OpenAI Service (AOAI)</th>
<th>OpenAI (OAI)</th>
</tr>
</thead>
<tbody>
<tr>
<td>API Framework</td>
<td><a href="https://flask.palletsprojects.com/en/2.2.x/">Flask 2.x</a></td>
<td><a href="https://flask.palletsprojects.com/en/2.2.x/">Flask 2.x</a></td>
</tr>
<tr>
<td>Python Library</td>
<td><a href="https://github.com/openai/openai-python">OpenAI Python Library</a></td>
<td><a href="https://github.com/openai/openai-python">OpenAI Python Library</a></td>
</tr>
<tr>
<td>Line Bot Library</td>
<td><a href="https://github.com/line/line-bot-sdk-python">Line Bot SDK Python</a></td>
<td><a href="https://github.com/line/line-bot-sdk-python">Line Bot SDK Python</a></td>
</tr>
<tr>
<td>Python Version</td>
<td>Python 3.9</td>
<td>Python 3.9</td>
</tr>
<tr>
<td>Python Environment</td>
<td>venv</td>
<td>venv</td>
</tr>
</tbody>
</table>
<p>ç¨‹å¼é–‹ç™¼ä¸Šï¼Œå¯ä»¥åˆ†ä¸‹åˆ— 2 éšæ®µ:</p>
<ol>
<li>Flask + Line Message API ä¸²æ¥åŠæ¸¬è©¦: é€™å€‹ç¶²è·¯ä¸Šç›¸ç•¶å¤šæ”¯æ´ï¼ŒLine SDK ç¯„ä¾‹ä¹Ÿå¯«å¾—å¾ˆæ¸…æ¥šï¼Œé›£åº¦ä¸é«˜</li>
<li>
<p>Flask + Azure OpenAI æˆ– OpenAI ä¸²æ¥åŠæ¸¬è©¦: é€™å€‹è¦ç•™æ„åˆ°ï¼Œ<mark class="critic">å…©é‚Šæ‰€ä½¿ç”¨çš„ Funcionã€API Endpointã€å›å‚³å…§å®¹ç­‰ç­‰éƒ½ä¸ä¸€æ¨£</mark></p>
<ul>
<li>å¦‚æœä½ æ˜¯ä»¥ Azure OpenAI Service é–‹ç™¼ç‚ºä¸»çš„ï¼Œå‹™å¿…è¦æŠŠ Azure OpenAI Studio æ‰€æä¾›çš„ Playground å…ˆç©éä¸€æ¬¡ï¼Œæœƒçœä¸‹ç›¸ç•¶å¤šçš„è§€è½é™°æ™‚é–“</li>
<li>å¦‚æœä½ æ˜¯ä»¥ OpenAI Service é–‹ç™¼ç‚ºä¸»çš„ï¼Œå°±æ˜¯å…ˆçœ‹ <a href="https://github.com/openai/openai-cookbook/">OpenAI Cookbook</a> ç‚ºä¸»</li>
</ul>
</li>
</ol>
<p>ä¸»è¦éƒ½éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯åœ¨é€è¨Šæ¯å‡ºå»åˆ° AOAI/OAI API Endpoint çš„éƒ¨åˆ†ï¼Œä¸‹é¢æä¾› 2 å€‹å¯«æ³•ä¸Šçš„å·®ç•°</p>
<div class="highlight"><span class="filename">azure-openai-service.snippet</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="hll"><span class="n">gpt_response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">Completion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="hll">    <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;gpt35&quot;</span><span class="p">,</span>
</span><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="hll">    <span class="n">prompt</span><span class="o">=</span><span class="n">create_prompt</span><span class="p">(</span><span class="n">system_message</span><span class="p">,</span> <span class="n">messages</span><span class="p">),</span>
</span><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="hll">    <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&lt;|im_end|&gt;&quot;</span><span class="p">],</span>
</span><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">)</span>
</code></pre></div>
<div class="highlight"><span class="filename">openai-service.snippet</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="hll"><span class="n">gpt_response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="hll">    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>
</span><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="hll">    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="p">}</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="p">],</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="hll">    <span class="n">stop</span><span class="o">=</span><span class="kc">None</span>
</span><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">)</span>
</code></pre></div>
<p>æ“šæˆ‘å°ç¾è¡Œ SDK å’Œ API çš„ç†è§£æ˜¯ OpenAI æœƒå…ˆç•¶å‰å°é©—è­‰æ¸¬è©¦çš„è§’è‰²ï¼Œç­‰ä½¿ç”¨åˆ°å¤§éƒ¨åˆ†çš„å•é¡Œéƒ½è§£æ±ºäº†ä»¥å¾Œï¼Œæ‰æœƒä¸‹æ”¾åˆ° Azure OpenAPI ä¾†åšä¼æ¥­ç´šçš„å°å…¥å’Œä½¿ç”¨ï¼Œä½†å› ç‚ºé€™æŠ€è¡“é€²å±•å¾ˆå¿«</p>
<p>é—œæ–¼ Error Handlingï¼Œè™•ç†é€™æ®µç¨‹å¼ç¢¼çš„æ™‚å€™ï¼Œæœƒæœ‰è¶…é«˜æ©Ÿç‡æœƒæ”¶åˆ° 500 Internal Server Errorï¼Œæœ‰å„å¼å„æ¨£çš„ç†ç”±æœƒå°è‡´å‡ºç¾é€™å€‹ï¼Œåèˆ‰  InvalidRequestErrorã€APIConnectionErrorã€AuthError å’Œ<mark class="critic">ä½ è¼¸å…¥å®ƒè¦ºå¾—ä¸åˆè¦çš„æ–‡å­—</mark>ç­‰ç­‰ï¼Œéƒ½æœƒåç›¸åŒçš„ HTTP Status 500 çµ¦ä½ ï¼Œè©³ç´°å¯çœ‹ <a href="https://github.com/openai/openai-python/blob/main/openai/error.py">error.py</a>ï¼Œæ‰€ä»¥å»ºè­° Error Handling è¦åšå’Œä¸Š Logger ç´€éŒ„ä¸€ä¸‹</p>
<h4 id="bot_1"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#bot_1">Bot é‹è¡Œå¹³å°åŠéƒ¨ç½²æ–¹å¼</a></h4>
<p><img alt="" src="/images/azurewebapp1.png" /></p>
<p>é—œæ–¼é‹è¡Œå¹³å°ï¼Œæä¾›ä¸‹åˆ—åƒæ•¸</p>
<ul>
<li>
<p>Azure Web App Service</p>
<ul>
<li>App Service Plan: <code>B1</code></li>
<li>Operating System: <code>Linux</code></li>
<li>Language: <code>Python 3.9</code></li>
</ul>
</li>
</ul>
<p>å¦‚æœä½ æ˜¯å¯« NodeJS çš„è©±ï¼Œå¯ä»¥ç›´æ¥åŠ é–‹ Application Insight åš Auto-instrumentationï¼Œè¶…...æ–¹ä¾¿(å¦‚ä¸‹åœ–)ï¼Œå¯æƒœ Python æ²’æœ‰ï¼Œè¦è‡ªå·±å¯«</p>
<p><img alt="" src="/images/applicationinsight-sample.png" /></p>
<p>é—œæ–¼éƒ¨ç½²æ–¹å¼ï¼Œä¸»è¦æ¡ç”¨ GitHub å’Œ GitHub Actionsï¼Œè‡ªå‹•éƒ¨ç½²åˆ°æŒ‡å®šçš„ Azure Web App Service ä¸Šé‹è¡Œï¼ŒWorkflow æœƒè‡ªå·±ç”¢ç”Ÿå‡ºä¾†ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå°±æ²’æœ‰æ”¹ä»€éº¼å°±ä¸Šäº†</p>
<p><img alt="" src="/images/github-actions.png" /></p>
<h3 id="_2"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#_2">ä¸‹ä¸€æ­¥?</a></h3>
<ol>
<li>é›²åœ°ç¶²è·¯æ•´åˆ: å› ç‚ºåªæœ‰ Azure OpenAI Service å¯ä»¥æŠŠ API Endpoint èº²åœ¨ Private Network è£¡</li>
<li>å¼·åŒ– Application Performance Management (APM) èƒ½åŠ›: ä½¿ç”¨ Azure Application Insightï¼Œä¸»è¦æ˜¯æ”¶é›† Metrics æ¯”è¼ƒå¥½åˆ¤æ–· API ä¹‹é–“å‘¼å«çš„ç‹€æ³</li>
<li>å®¹å™¨åŒ–: Dockerfile å’Œ docker-compose æ’°å¯«</li>
<li>éƒ¨ç½²åˆ° Azure Kubernetes Service / Azure Red Hat OpenShift: å› ç‚ºé€™å€‹æœå‹™å‰›å¥½æ˜¯ Stateless Application çš„ä»£è¡¨ï¼Œæ‰€ä»¥ç›¸ç•¶é©åˆæ‹¿ä¾†ä¸Ÿåœ¨ K8s ä¸Šé¢æå¾ˆå¤šå¥‡æ€ªçš„ Demo</li>
</ol>
<h3 id="q-a"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q-a">Q &amp; A</a></h3>
<h4 id="q1-flask"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q1-flask">Q1: ç‚ºä½•ä½¿ç”¨ Flask?</a></h4>
<p>æˆ‘è¦ºå¾—çœ‹èµ·ä¾†æ¯”è¼ƒç›´è¦ºä¸€é»ï¼ŒVSCode åŸç”Ÿä¹Ÿæ”¯æ´ Flask Debuggerï¼Œè©³åƒ <a href="https://code.visualstudio.com/docs/python/tutorial-flask#_run-the-app-in-the-debugger">Flask Tutorial in Visual Studio Code</a>ï¼Œé‚„æˆ‘é’æ˜¥ï¼Œæ¸›å°‘è§€è½é™°æ™‚é–“</p>
<h4 id="q2-aoai-oai-flask-app"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q2-aoai-oai-flask-app">Q2: å¯ä¸å¯ä»¥å°‡ AOAI è·Ÿ OAI çš„å‘¼å«å¯«åœ¨åŒä¸€å€‹ flask app?</a></h4>
<p>æŠ€è¡“ä¸Šä¸€å®šå¯ä»¥ï¼Œä½†å› ç‚º AOAI è·Ÿ OAI ç„¡è«–æ˜¯å‡½å¼ã€API Endpointã€Parameterã€Key Formatï¼Œå…¶å¯¦é‚„æ˜¯æœ‰å·®ç•°ï¼Œç§‰æŒ KISS åŸå‰‡ï¼Œå»ºè­° AOAI å¯«ä¸€å€‹ appï¼ŒOAI è‡ªå·±å¯«ä¸€å€‹ appï¼Œä¸è¦æå¾—å¤ªè¤‡é›œ</p>
<h4 id="q3-model-azure-openai-service-openai"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q3-model-azure-openai-service-openai">Q3: ç”¨åŒä¸€å¥æ–‡å­—ï¼ŒåŒæ¨£çš„ Modelï¼Œå• Azure OpenAI Service è·Ÿ OpenAI æœƒæ˜¯ä¸€æ¨£çš„çµæœå—?</a></h4>
<p>ä¸ä¸€æ¨£ï¼Œå¦‚æœè© å”± (Prompt) å¤ªçŸ­çš„è©±ï¼ŒåŒä¸€å€‹å•é¡Œå•èµ·ä¾†æœƒå¤©å·®åœ°é ï¼Œè«‹åƒè€ƒä¸‹åˆ—ç¯„ä¾‹</p>
<p><img alt="" src="/images/msg-compare.png" /></p>
<h4 id="q4-api-endpoint"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q4-api-endpoint">Q4: å¦‚æœæˆ‘éœ€è¦ API Endpoint åœ¨ç§æœ‰ç¶²è·¯å…§ï¼Œè¦é¸ä»€éº¼?</a></h4>
<p>åªæœ‰ Azure OpenAI Serviceï¼Œå› ç‚ºæœ‰æ”¯æ´ Private Link / Private Endpointï¼ŒåŒæ™‚ä¹‹é–“ä¹Ÿæœ‰æ”¯æ´è·¨å€åŸŸé€£ç·šçš„æ–¹å¼ï¼Œä¸‹åœ–å°±æ˜¯ä¸€å€‹å¾ˆå…¸å‹çš„è¨­å®šï¼ŒAzure OpenAI Service é–‹åœ¨ South Central USï¼Œè€Œ Private Endpoint å’Œ Private Link å‰‡æ”¾åœ¨ Japan East</p>
<p><img alt="" src="/images/aoai-pel.png" /></p>
<h4 id="q5-api-endpoint-rate-limitquotaauth"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q5-api-endpoint-rate-limitquotaauth">Q5: å¦‚æœæˆ‘éœ€è¦ API Endpoint åœ¨å¤–ç¶²ï¼Œä½†åˆè¦æœ‰ Rate Limitã€Quotaã€Auth ç­‰ç­‰çš„ç®¡ç†æ©Ÿåˆ¶è©²æ€éº¼è¾¦?</a></h4>
<p>è«‹æ‰¾ API Management ç›¸é—œçš„è§£æ±ºæ–¹æ¡ˆï¼Œå¦‚æœä½ æ˜¯ Azure çš„è©±å°±æ˜¯ Azure API Management å¯ä»¥è¦åŠƒä½¿ç”¨</p>
    <nav class="md-post__action">
      <a href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>