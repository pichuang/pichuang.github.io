
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Open Knowledge, Open Source, Open Mind">
      
      
        <meta name="author" content="Phil Huang">
      
      
        <link rel="canonical" href="https://blog.pichuang.com.tw/archive/2023/">
      
      
        <link rel="prev" href="../../category/sustainability/">
      
      
        <link rel="next" href="../2022/">
      
      
        
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3+insiders-4.49.2">
    
    
      
        <title>2023 - Phil's Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.67c3bdf0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7COverpass+Mono+SemiBold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Overpass Mono SemiBold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-8MQRY98QB2"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-8MQRY98QB2",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-8MQRY98QB2",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
  <a href="https://www.youtube.com/@pichuang-tw" style="color:white;">
    For updates follow <strong>@pichuang-tw</strong> on
    <strong>YouTube Channel 🎥 </strong>
  </a>

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phil&#39;s Workspace" class="md-header__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wiki/" class="md-tabs__link">
          
  
    
  
  Wiki

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../azure-subnets/" class="md-tabs__link">
          
  
    
  
  Azure Visual Subnet Calculator

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../about/" class="md-tabs__link">
          
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phil&#39;s Workspace" class="md-nav__button md-logo" aria-label="Phil's Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.97 5.92a.967.967 0 0 0-1.18-.68l-3.4.91-4.44-4.12-1.23.33 2.66 4.59-3.19.85-1.26-.98-.93.25 1.66 2.88 10.62-2.84c.52-.15.82-.68.69-1.19M21 10l-1 2h-5l-1-2 1-1h2V7h1v2h2l1 1m1 10v2H2v-2h13v-7h5v7h2Z"/></svg>

    </a>
    Phil's Workspace
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pichuang/pichuang.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    blog.pichuang.com.tw
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#azure-kubernetes-services-c1000k" class="md-nav__link">
    <span class="md-ellipsis">
      
        揪竟...Azure Kubernetes Services 的節點能不能提供 C1000K 的能力呢?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        人家都在抓神奇寶貝，而我在抓 Kubernetes 封包
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        永續性軟體工程: 遠端抓封包實錄
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distroless-container-kubectl-debug" class="md-nav__link">
    <span class="md-ellipsis">
      
        當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debian-ubuntu" class="md-nav__link">
    <span class="md-ellipsis">
      
        容器基礎映像檔要選 Debian 還是 Ubuntu?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-probe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kubernetes Probe 類型及實作方式的使用說明與小建議
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sig-kubernetes-scability" class="md-nav__link">
    <span class="md-ellipsis">
      
        SIG Kubernetes Scability 多維度分析
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composite-slas" class="md-nav__link">
    <span class="md-ellipsis">
      
        計算出正確的服務水平協議：探索 Composite SLAs 計算和架構設計
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-latency-slos-4" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何定義 Network Latency SLOs? 4 個設計原則與百分位數解析
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openai-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用 OpenAI API 開發經驗分享
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    automation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    azure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/homecloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    homecloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/o11y/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    o11y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openai
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/openshift/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    openshift
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sla
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/sustainability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    sustainability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Authors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Authors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../author/url/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Phil Huang
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wiki/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Wiki
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Wiki
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Azure Visual Subnet Calculator
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure Visual Subnet Calculator
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../azure-subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Visual Subnet Calculator (Azure Edition)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Who is Phil Huang?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recording/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recording
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2023">2023</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-17 00:00:00">October 17, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="azure-kubernetes-services-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">揪竟...Azure Kubernetes Services 的節點能不能提供 C1000K 的能力呢?</a></h2>
<blockquote>
<p>Kubernetes is Cloud OS, Containers are Linux</p>
</blockquote>
<p><img alt="" src="/images/t2.jpg" /></p>
<p>既前篇文章 <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">永續性軟體工程: 遠端抓封包實錄</a> 有提到降低不必要網路傳輸成本可有效減少碳排放，那我繼續基於 Green Foundation 所提出的<a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">綠色軟體實踐者 (Green Software Practitioner)</a> 當中的原則提升設備利用率 (Increasing device utilization) 來繼續延伸這個大議題</p>
<p>盡力地提升單台節點所能服務的量體，減少資源浪費，從這個角度看，其實就是需要來探討 Azure Kuberenetes Service 預設提供的這些節點，本體到底夠不夠提供我們在大流量和高性能計算上所需的資源和調教，這邊就從經典的百萬並行連線 C1000K (Concurrent 1000K Connections) 來做為基準來探討</p>
<!--more-->

<h3 id="cncf-sustainability-week-taiwan-x-green-software-foundation"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#cncf-sustainability-week-taiwan-x-green-software-foundation">[活動宣傳] CNCF Sustainability Week - Taiwan x Green Software Foundation</a></h3>
<p><img alt="" src="/images/cnsw.png" /></p>
<p>最近的我覺得這個題目比較在考驗 Linux 高性能調教，歡迎大家報名 <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">2023/10/24 18:30-21:30</a> 來吃吃喝喝探討</p>
<h3 id="azure-kubernetes-service"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#azure-kubernetes-service">登入 Azure Kubernetes Service 當中的一個節點</a></h3>
<p>這邊使用 v1.25 後，開始可使用的 <code>kubectl debug</code> 作為使用基礎，之前有些過一篇 <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug</a> 有專文解釋這個指令的效果，但今天比較特別是，對象是 Node 而非 Pod</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.28.1
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.4-0.20230601165947-6ce0bf390ce3
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1"># 獲得 node 名稱</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>NAME<span class="w">                                </span>STATUS<span class="w">   </span>ROLES<span class="w">   </span>AGE<span class="w">     </span>VERSION
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>aks-agentpool-14864487-vmss000000<span class="w">   </span>Ready<span class="w">    </span>agent<span class="w">   </span>6d14h<span class="w">   </span>v1.27.3
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c1"># kubectl debug node/&lt;node name&gt; -it --image-pull-policy=Always --quiet --image=&lt;image name&gt; -- &lt;command&gt;</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>debug<span class="w"> </span>node/aks-agentpool-14864487-vmss000000<span class="w"> </span>-it<span class="w"> </span>--image-pull-policy<span class="o">=</span>Always<span class="w"> </span>--quiet<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="c1"># 務必要記得使用 chroot /host 切到正確的環境去</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="o">[</span>root@aks-agentpool-14864487-vmss000000<span class="w"> </span>/<span class="o">]</span><span class="c1"># chroot /host /bin/bash</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="c1"># 確保你可以看到作業系統資訊</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /etc/os-release</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="nv">NAME</span><span class="o">=</span><span class="s2">&quot;Common Base Linux Mariner&quot;</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="nv">VERSION</span><span class="o">=</span><span class="s2">&quot;2.0.20230924&quot;</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="nv">ID</span><span class="o">=</span>mariner
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&quot;CBL-Mariner/Linux&quot;</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="nv">ANSI_COLOR</span><span class="o">=</span><span class="s2">&quot;1;34&quot;</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://aka.ms/cbl-mariner&quot;</span>
</code></pre></div>
<p><img alt="" src="/images/t1.png" /></p>
<h3 id="aks-node-cbl-mariner"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-node-cbl-mariner">解剖 AKS Node 裡的 CBL-Mariner 作業系統</a></h3>
<p>先聲明，下面的眾多操作都可以適用於任何一家的 Kubernetes 發行版和以 Linux 為基礎的節點，但當中的設定會隨著下列 3 個狀況有所差異，但基本上大同小異</p>
<ol>
<li>廠商不同，如 Azure 和 Red Hat</li>
<li>OS 選擇不同，如 Mariner 2.0、Red Hat CoreOS、Ubuntu 20.04</li>
<li>Kernel 版本不同，如 5.15.131、5.x.x、3.11.x</li>
</ol>
<h4 id="aks-environment"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#aks-environment">AKS Environment</a></h4>
<ul>
<li>Azure Kubernetes Service 1.27.3</li>
<li>VM Instance: Standard D4as v5 (4 vcpus, 16 GiB memory)</li>
<li>OS: <a href="https://github.com/microsoft/CBL-Mariner">CBL-Mariner 2.0</a>，這個是 Azure 親大王子，最近還有一個 Azure Linux 親小王子出來，但還沒正式用過</li>
<li>CNI: Azure CNI</li>
<li>(Azure 限定) 有使用 UDR 強制控制 Egress 方向</li>
</ul>
<h4 id="1-cpu"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#1-cpu">1. CPU 相關</a></h4>
<h5 id="a-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-hardware">a. Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">#</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># CPU</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1">#</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="c1"># 查詢 CPU 型號</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># Standard D4as v5 (4 vcpus, 16 GiB memory)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># https://azureprice.net/vm/Standard_D4as_v5</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;model name&quot; | cut -f2 -d: | uniq</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>AMD<span class="w"> </span>EPYC<span class="w"> </span><span class="m">7763</span><span class="w"> </span><span class="m">64</span>-Core<span class="w"> </span>Processor
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="c1"># 查詢物理 CPU 個數</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;physical id&quot; | sort | uniq | wc -l</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="m">1</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1"># 查詢每個物理 CPU 的 Core 數</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="c1"># 若於 Azure Portal 設定 `platformsettings.host_environment.disablehyperthreading: true` 的話，則不會開啟 HT 的能力</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="m">2</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="c1"># 查詢每個邏輯 vCPUs 的個數</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="c1"># 邏輯 vCPUs 個數 = 物理 CPU 個數 * 每個物理 CPU 的 Core 個數 * 2 (預設 Azure VM 會開啟 HT，意旨預設狀況下，platformsettings.host_environment.disablehyperthreading: false)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="c1"># https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="c1"># 根據加總 processor 數量，故知道該 VM 為 4 vcpus</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="m">4</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="c1"># https://www.amd.com/en/products/cpu/amd-epyc-7763</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="c1"># Base Clock 2.45GHz, Max. Boost Clock Up to 3.5GHz</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep &quot;cpu MHz&quot; | uniq</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2946</span>.906
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>cpu<span class="w"> </span>MHz<span class="w">         </span>:<span class="w"> </span><span class="m">2445</span>.427
</code></pre></div>
<p>主要這邊是要講有開 HT 和沒開 HT 的狀況下，vCPU 呈現會不同，而 Azure VM 預設狀況下都是會把 HT 開起來的。倘若要跑 HPC 或其他你就是要把這台機器效能榨到極限，則要把 HT 關掉，可使用 <code>platformsettings.host_environment.disablehyperthreading=true</code></p>
<h5 id="b-numa-non-uniform-memeory-acces"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-numa-non-uniform-memeory-acces">b. NUMA (Non-uniform memeory acces)</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># numa</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># yum install numactl -y # 預設沒有，需要裝</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># 如下顯示，只有一個 NUMA Node，裡面有 4 個 vcpus 且被分配到 15734 MB 的 Memory</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl -H</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>available:<span class="w"> </span><span class="m">1</span><span class="w"> </span>nodes<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="o">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>cpus:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>size:<span class="w"> </span><span class="m">15734</span><span class="w"> </span>MB
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>free:<span class="w"> </span><span class="m">7277</span><span class="w"> </span>MB
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>node<span class="w"> </span>distances:
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>node<span class="w">   </span><span class="m">0</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span><span class="m">0</span>:<span class="w">  </span><span class="m">10</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># numactl --show</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>policy:<span class="w"> </span>default
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>preferred<span class="w"> </span>node:<span class="w"> </span>current
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>physcpubind:<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>cpubind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>nodebind:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>membind:<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>順便一提，雖然跟節點本身沒啥關係，針對 Kubernetes Pod 對於 CPU 的優化，除了花錢砸買更好的 CPU 以外，比較有策略或很 Kubernetes 的方式是，採用 Topology Manager 嘗試調整出最佳化 NUMA，<a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a>。現行共有 4 個策略可用: none, best-effort, restricted, single-numa-node，AKS 預設是採用 <code>none</code>，該功能常見於 5G / CNF 等對於 Pod 之於 NUMA 的使用效率有特別要求的場景，如 UPF 服務會出現，可參考 <a href="https://speakerdeck.com/pichuang/qian-tan-azure-private-5g-core-he-kubernetes?slide=15">20221028 淺談 Azure Private 5G Core 和 Kubernetes</a></p>
<h4 id="2-memory"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#2-memory">2. Memory 相關</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">#</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c1"># Memory</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1">#</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># 依據 MemAvailable 所示，這台機器有 13479504 kB 的 Memory 可用</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/meminfo</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>MemTotal:<span class="w">       </span><span class="m">16112256</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># 所有 Memory 大小, 故為 16 GB</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>MemFree:<span class="w">         </span><span class="m">7317172</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># 完全沒到的 Memory 大小，很顯然我這台機器開太大了，太閒</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>MemAvailable:<span class="w">   </span><span class="m">13479504</span><span class="w"> </span>kB<span class="w"> </span><span class="c1"># 實際上可用的 Memory 大小，MemAvailable &lt;= MemFree + Active(file) + Inactive(file) + SReclaimable</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>Active<span class="o">(</span>file<span class="o">)</span>:<span class="w">    </span><span class="m">1067108</span><span class="w"> </span>kB
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>Inactive<span class="o">(</span>file<span class="o">)</span>:<span class="w">  </span><span class="m">5021812</span><span class="w"> </span>kB
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>Slab:<span class="w">             </span><span class="m">486692</span><span class="w"> </span>kB
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>SReclaimable:<span class="w">     </span><span class="m">334712</span><span class="w"> </span>kB
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>HugePages_Total:<span class="w">       </span><span class="m">0</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="c1"># MemTotal 為 16112256 kB = 719104 kB + 15393152 kB</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/zoneinfo</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">    </span>DMA32
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">179568</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">179776</span><span class="w"> </span><span class="c1"># 給 DMA32 使用的記憶體空間為 702.25 MB = 719104 KB = 179776 * 4 KB</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>Node<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>zone<span class="w">   </span>Normal
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">  </span>pages<span class="w"> </span>free<span class="w">     </span><span class="m">1974218</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span>managed<span class="w">  </span><span class="m">3848288</span><span class="w"> </span><span class="c1"># 給 Normal 使用的記憶體空間為 14.68 GB = 15393152 KB = 3848288 * 4 KB</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># 一個 Slab page 可用空間 32768 Bytes = 4096 Bytes * pagesperslab 8</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1"># TCP 實際 Slab page 內有 31360 Bytes 被使用 = objsize 2240 Bytes * objperslab 14</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="c1"># Slab page 碎片 1408 Bytes = 32768 - 31360</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="c1"># TCP 實際占用的記憶體空間 470400 Bytes = num_objs 210 * objsize 2240 Bytes</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/slabinfo | grep TCP</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="c1"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>TCP<span class="w">                  </span><span class="m">210</span><span class="w">    </span><span class="m">210</span><span class="w">   </span><span class="m">2240</span><span class="w">   </span><span class="m">14</span><span class="w">    </span><span class="m">8</span><span class="w"> </span>:<span class="w"> </span>tunables<span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span>slabdata<span class="w">     </span><span class="m">15</span><span class="w">     </span><span class="m">15</span><span class="w">      </span><span class="m">0</span>
</code></pre></div>
<p>記憶體是不可被壓縮資源，跟 CPU 不一樣，如果 MemAvailable 真的用到 0 的狀況下，就代表你的節點記憶體真的是太小了，完全不夠分配出去，上面的 Pod 很容易有滿滿 OOM 的狀況。</p>
<p>如果你想要 Pod 有保障的資源可以用，你需要從 k8s 的角度去控制 cpu.request / cpu.limit / memory.request / memory.limit，可參考小弟舊文 <a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">如何科學地估算 Kubernetes 所需的資源? App 角度篇</a>，這篇不會特別涉及，之後會講一篇由下而上的 Node 和由上而下的管理 Kubernetes 角度上的資源對照</p>
<p>順便一提，維持一個 Long Lived TCP Connection ，且不包含其他的資料傳輸，消耗的記憶體大約為 ~3.3 KB，若全部都是 Long Lived TCP Connection 且無實際資料運作或傳輸的話，大概就是消耗 3.3 GB 記憶體存這些資訊，可參考 <code>Q5: 單台 C1000K 是怎麼算出來的? 預設啥都沒做的狀況下記憶體消耗為何?</code> 的內容</p>
<h4 id="3-linux-kernel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#3-linux-kernel">3. Linux Kernel 相關</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">#</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1"># Kernel Paraemters</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1">#</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># uname -a</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>Linux<span class="w"> </span>aks-agentpool-14864487-vmss000000<span class="w"> </span><span class="m">5</span>.15.131.1-2.cm2<span class="w"> </span><span class="c1">#1 SMP Sun Sep 24 03:38:45 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="c1"># 下列都是 CBL-Mariner 的預設值</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># sysctl -a</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>net.ipv4.ip_local_port_range<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32768</span><span class="w">    </span><span class="m">60999</span><span class="w"> </span><span class="c1"># 該 VM 可使用的 Port Range，預設範圍為 32768 ~ 60999，共 28232 個 Port，可調整</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>net.ipv4.tcp_syn_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>net.ipv4.tcp_synack_retries<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>net.ipv4.tcp_syncookies<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># 預設可防止部分 SYN Flood 攻擊</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>net.ipv4.tcp_tw_reuse<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>net.ipv4.tcp_max_syn_backlog<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>net.ipv4.tcp_max_tw_buckets<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">65536</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>net.core.somaxconn<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16384</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>fs.file-max<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9223372036854775807</span><span class="w"> </span><span class="c1"># OS Level，為 Int64.MaxValue 最大位數，十六進位0x7FFFFFFFFFFFFFFF</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>fs.nr_open<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1073741816</span><span class="w"> </span><span class="c1"># Progess Level，需要比 * hard nofile (1048576) 大，不然會開不起來</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>net.ipv4.tcp_congestion_control<span class="w"> </span><span class="o">=</span><span class="w"> </span>cubic
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>net.ipv4.tcp_mtu_probing<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>net.ipv4.tcp_fastopen<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>/<span class="w"> </span><span class="o">]</span><span class="c1"># ulimit -a</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>real-time<span class="w"> </span>non-blocking<span class="w"> </span><span class="nb">time</span><span class="w">  </span><span class="o">(</span>microseconds,<span class="w"> </span>-R<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>core<span class="w"> </span>file<span class="w"> </span>size<span class="w">              </span><span class="o">(</span>blocks,<span class="w"> </span>-c<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>data<span class="w"> </span>seg<span class="w"> </span>size<span class="w">               </span><span class="o">(</span>kbytes,<span class="w"> </span>-d<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>scheduling<span class="w"> </span>priority<span class="w">                 </span><span class="o">(</span>-e<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>file<span class="w"> </span>size<span class="w">                   </span><span class="o">(</span>blocks,<span class="w"> </span>-f<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>pending<span class="w"> </span>signals<span class="w">                     </span><span class="o">(</span>-i<span class="o">)</span><span class="w"> </span><span class="m">62863</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>max<span class="w"> </span>locked<span class="w"> </span>memory<span class="w">           </span><span class="o">(</span>kbytes,<span class="w"> </span>-l<span class="o">)</span><span class="w"> </span><span class="m">64</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>max<span class="w"> </span>memory<span class="w"> </span>size<span class="w">             </span><span class="o">(</span>kbytes,<span class="w"> </span>-m<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>open<span class="w"> </span>files<span class="w">                          </span><span class="o">(</span>-n<span class="o">)</span><span class="w"> </span><span class="m">1048576</span><span class="w"> </span><span class="c1"># 同時可打開的檔案數量，Azure 提供的 CBL-Mariner 作業系統預設是 2^20 個，單台 VM 帳面預設數字是支援做到 C1000K 等級</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>pipe<span class="w"> </span>size<span class="w">                </span><span class="o">(</span><span class="m">512</span><span class="w"> </span>bytes,<span class="w"> </span>-p<span class="o">)</span><span class="w"> </span><span class="m">8</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>POSIX<span class="w"> </span>message<span class="w"> </span>queues<span class="w">         </span><span class="o">(</span>bytes,<span class="w"> </span>-q<span class="o">)</span><span class="w"> </span><span class="m">819200</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>real-time<span class="w"> </span>priority<span class="w">                  </span><span class="o">(</span>-r<span class="o">)</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>stack<span class="w"> </span>size<span class="w">                  </span><span class="o">(</span>kbytes,<span class="w"> </span>-s<span class="o">)</span><span class="w"> </span><span class="m">8192</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>cpu<span class="w"> </span><span class="nb">time</span><span class="w">                   </span><span class="o">(</span>seconds,<span class="w"> </span>-t<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>max<span class="w"> </span>user<span class="w"> </span>processes<span class="w">                  </span><span class="o">(</span>-u<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>virtual<span class="w"> </span>memory<span class="w">              </span><span class="o">(</span>kbytes,<span class="w"> </span>-v<span class="o">)</span><span class="w"> </span>unlimited
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>file<span class="w"> </span>locks<span class="w">                          </span><span class="o">(</span>-x<span class="o">)</span><span class="w"> </span>unlimited
</code></pre></div>
<p>前陣子 CNCF 有一篇部落格 <a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a> 就在講如何調整節點內的 Linux Kernel 參數來達到 1 百萬 Concurrent Connections</p>
<p>這邊來比對一下 CBL-Mariner 預設參數跟 <a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a> 的差異</p>
<table>
<thead>
<tr>
<th style="text-align: center;">sysctl</th>
<th style="text-align: center;">CBL-Mariner 2.0</th>
<th style="text-align: center;">EMQX</th>
<th style="text-align: center;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">整個 OS 最大開檔數量</td>
</tr>
<tr>
<td style="text-align: center;">fs.fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td style="text-align: center;">2097152</td>
<td style="text-align: center;">單一程序最大開檔數量</td>
</tr>
<tr>
<td style="text-align: center;">net.core.somaxconn</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">32768</td>
<td style="text-align: center;">全連接佇列長度: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_syn_backlog</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;">全連接佇列長度: min(tcp_max_syn_backlog, somaxconn)</td>
</tr>
<tr>
<td style="text-align: center;">net.core.netdev_max_backlog</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">16384</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.ip_local_port_range</td>
<td style="text-align: center;">32768 60999</td>
<td style="text-align: center;">1000 65535</td>
<td style="text-align: center;">VM 可用 Port 範圍，但單純以 Server 端角度來說調這個沒啥太大用處，多半都 80, 443 為主，但當 Client 來講就有效果了，譬如說你要外連 DB 還是有的沒的外部服務之類的，這個調大會比較好</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.rmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Recieve Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_default</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">262144</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.wmem_max</td>
<td style="text-align: center;">212992</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">TCP Write Windows</td>
</tr>
<tr>
<td style="text-align: center;">net.core.optmem_max</td>
<td style="text-align: center;">20480</td>
<td style="text-align: center;">16777216</td>
<td style="text-align: center;">緩衝區大小</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_rmem</td>
<td style="text-align: center;">4096 131072 6291456</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">因為 MQ，訊息量小，可以 1KB 就發送一次</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_wmem</td>
<td style="text-align: center;">4096 16384 4194304</td>
<td style="text-align: center;">1024 262144 16777216</td>
<td style="text-align: center;">因為 MQ，訊息量小，可以 1KB 就發送一次</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_max</td>
<td style="text-align: center;">131072</td>
<td style="text-align: center;">1000000</td>
<td style="text-align: center;">調高 nf_conntrack_max 的接受上限</td>
</tr>
<tr>
<td style="text-align: center;">net.netfilter.nf_conntrack_tcp_timeout_time_wait</td>
<td style="text-align: center;">120</td>
<td style="text-align: center;">30</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_max_tw_buckets</td>
<td style="text-align: center;">65536</td>
<td style="text-align: center;">1048576</td>
<td style="text-align: center;">超過 TIME_WAIT 設定值則清除</td>
</tr>
<tr>
<td style="text-align: center;">net.ipv4.tcp_fin_timeout</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">調降 TCP 在 FIN-WAIT-2 的時間</td>
</tr>
</tbody>
</table>
<p>如果要針對上述的參數進行調整，在 AKS 裡面，你需要依循 <a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#os-configuration">自訂 Azure Kubernetes Service (AKS) 節點集區的節點設定</a> 進行設定，而不是直接進去用 sysctl 改數值，但目前 az aks update 沒支援 --linux-os-config</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>az<span class="w"> </span>aks<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>myAKSCluster<span class="w"> </span>--resource-group<span class="w"> </span>myResourceGroup<span class="w"> </span>--linux-os-config<span class="w"> </span>./linuxosconfig.json
</code></pre></div>
<p>如果你是自建作業系統的話，就對 /etc/sysctl.conf 進行修改即可</p>
<h4 id="4-networking"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#4-networking">4. Networking</a></h4>
<h5 id="a-networking-hardware"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#a-networking-hardware">a. Networking Hardware</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">#</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1"># Networking Hardware</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1">#</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="c1"># 顯示預設網卡 eth0 支援最大的 Channel 大小和現行設定的大小</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -l eth0</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>Channel<span class="w"> </span>parameters<span class="w"> </span><span class="k">for</span><span class="w"> </span>eth0:
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>Pre-set<span class="w"> </span>maximums:
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>Combined:<span class="w">       </span><span class="m">4</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>Current<span class="w"> </span>hardware<span class="w"> </span>settings:
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>RX:<span class="w">             </span>n/a
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>TX:<span class="w">             </span>n/a
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>Other:<span class="w">          </span>n/a
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>Combined:<span class="w">       </span><span class="m">4</span><span class="w"> </span><span class="c1"># 用滿了，代表 RSS (Receive Side Scaling) 沒問題，在 CBL-Mariner 上已經是網路最佳化用法</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="c1"># 下面的 interrupts 統一會由 irqbalance 自動控制，正常狀況下你不需要手動去維護下面的 /proc/irq/25,26,27,28/smp_affinity 設定</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c1"># systemctl status irqbalance</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># cat /proc/interrupts | grep mlx5_comp</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">           </span>CPU0<span class="w">       </span>CPU1<span class="w">       </span>CPU2<span class="w">       </span>CPU3
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w"> </span><span class="m">25</span>:<span class="w">   </span><span class="m">14332354</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129153</span>-edge<span class="w">      </span>mlx5_comp0@pci:3ffc:00:02.0
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w"> </span><span class="m">26</span>:<span class="w">          </span><span class="m">0</span><span class="w">         </span><span class="m">14</span><span class="w">   </span><span class="m">13861183</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129154</span>-edge<span class="w">      </span>mlx5_comp1@pci:3ffc:00:02.0
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w"> </span><span class="m">27</span>:<span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">17419688</span><span class="w">         </span><span class="m">12</span><span class="w">          </span><span class="m">0</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129155</span>-edge<span class="w">      </span>mlx5_comp2@pci:3ffc:00:02.0
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w"> </span><span class="m">28</span>:<span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">          </span><span class="m">0</span><span class="w">   </span><span class="m">10673131</span><span class="w">  </span>Hyper-V<span class="w"> </span>PCIe<span class="w"> </span>MSI<span class="w"> </span><span class="m">3758129156</span>-edge<span class="w">      </span>mlx5_comp3@pci:3ffc:00:02.0
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>...
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="c1"># 預設是使用 GRO 在 Linux Kernel 上把合併封包的事情給解決了，而非 LRO 在網卡上把合併封包的事情給解決了</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ethtool -k eth0</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>generic-receive-offload:<span class="w"> </span>on
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>large-receive-offload:<span class="w"> </span>off
</code></pre></div>
<h5 id="b-routing"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#b-routing">b. Routing</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">#</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1"># Linux Networking</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1">#</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1"># 顯示這台節點上的路由</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># ip route</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># 這邊要注意的是，其實我有設定 UDR 強制把 egress (a.k.a outbound traffic) 所有流量導到 Firewall (10.99.x.x) 上，但從路由表上會看不出來，得從 Azure Portal 上看</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c1"># 以下是 Node IP 的路由 10.0.128.0/24，Default Gateway 為該網段的第一個 IP，也就是 10.0.128.1</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="m">10</span>.0.128.0/24<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="c1"># 以下是 Pod IP 的路由，10.0.129.0/24</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="m">10</span>.0.129.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="m">10</span>.0.129.5<span class="w"> </span>dev<span class="w"> </span>azv7d24922a083<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="m">10</span>.0.129.8<span class="w"> </span>dev<span class="w"> </span>azv9da73473eb2<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="m">10</span>.0.129.9<span class="w"> </span>dev<span class="w"> </span>azv6f0c6f1ef57<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="m">10</span>.0.129.10<span class="w"> </span>dev<span class="w"> </span>azvaa6ccb05bb5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="m">10</span>.0.129.13<span class="w"> </span>dev<span class="w"> </span>azvcdfece9bfdf<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="m">10</span>.0.129.14<span class="w"> </span>dev<span class="w"> </span>azvf893453cbc5<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="m">10</span>.0.129.15<span class="w"> </span>dev<span class="w"> </span>azv1f6d5d20426<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="m">10</span>.0.129.16<span class="w"> </span>dev<span class="w"> </span>azvf85308aa314<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="m">10</span>.0.129.17<span class="w"> </span>dev<span class="w"> </span>azva9b3f83744f<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="m">10</span>.0.129.21<span class="w"> </span>dev<span class="w"> </span>azv224fa8c56a6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="m">10</span>.0.129.22<span class="w"> </span>dev<span class="w"> </span>azvbb0334487e3<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="m">10</span>.0.129.25<span class="w"> </span>dev<span class="w"> </span>azvca12febb7ce<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="m">10</span>.0.129.27<span class="w"> </span>dev<span class="w"> </span>azv0867699d9ac<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="m">10</span>.0.129.28<span class="w"> </span>dev<span class="w"> </span>azva412bba2170<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="m">10</span>.0.129.29<span class="w"> </span>dev<span class="w"> </span>azvd4c029379b6<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="m">10</span>.0.129.30<span class="w"> </span>dev<span class="w"> </span>azv9a46f9ec6ea<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="m">10</span>.0.129.35<span class="w"> </span>dev<span class="w"> </span>azvd96d575dd35<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="m">10</span>.0.129.36<span class="w"> </span>dev<span class="w"> </span>azvee4ae66e969<span class="w"> </span>proto<span class="w"> </span>static
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="c1"># 下面是這台節點與 Azure 平台資源 168.63.129.16 溝通用的路由</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="m">168</span>.63.129.16<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="c1"># 下面是跟 Azure Instance Metadata Service 溝通用的路由</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="m">169</span>.254.169.254<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.0.128.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.128.5<span class="w"> </span>metric<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p>看路由表主要的目的是討論 Kubernetes Egress，也就是 Pod 從節點出去的路徑是怎麼走的。因為我使用的 CNI (Container Networking Interface) 為 Azure-CNI，而非使用 kubenet 或 overlay CNI 等，所以 Pod IP 其實就是我指派的某一段 Azure Subnet 網段，按照該路由，是可以從別的 Azure Subnet 或已開啟 VNet Peering 的服務直接摸到 Pod IP。</p>
<p>若你的 kube-proxy 是走 iptables 的話，其實是可以對 Node 套 iptables rule 影響上面的 Pod 路由，譬如說拿 ansible 對所有節點直接上路由，但這已經非 Kubernetes 能管控的範圍了，所以正常狀況下都不建議在不清楚不明白的狀況下進行這件事</p>
<h3 id="_1"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#_1">後話</a></h3>
<ol>
<li>其實一開始我只是想要紀錄一下 AKS Node 上的一些預設參數，不知道為啥越寫越多。</li>
<li>如果你有看懂上面的內容，你會發現到其實研究 Kubernetes 就跟研究 Linux 作業系統是沒什麼太大區別的，不如說 Kubernetes 幫你抽象化了很多事情，讓你不用知道得太細，雖然變相你需要學習的就是 Kubernetes 的語言，從學習 shell 改成到 kubectl 的操作</li>
<li>看著上面的內容，所以我平時才會很常說，作業系統的穩定與否會直接影響 Kubernetes 的穩定性，滿滿地作業系統參數細節</li>
<li>AKS Node 是有考慮到大部分的使用者都不會去看這些參數，調教是以 C1000K 為目標基準先幫大家調好了，所以沒特殊狀況下都可以順順用，也不太會有節點硬體+作業系統效能問題，自建的就要自己加油了</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#qa">Q&amp;A</a></h3>
<h4 id="q1-azure-vm-ht"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q1-azure-vm-ht">Q1: 如何針對 Azure VM 關閉 HT 功能?</a></h4>
<p>重開才會生效</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>az<span class="w"> </span>resource<span class="w"> </span>tag<span class="w"> </span>--ids<span class="w"> </span>/subscriptions/<span class="o">{</span>SubID<span class="o">}</span>/resourceGroups/<span class="o">{</span>ResourceGroup<span class="o">}</span>/providers/Microsoft.Compute/virtualMachines/<span class="o">{</span>VM<span class="o">}</span><span class="w"> </span>--tags<span class="w"> </span>platformsettings.host_environment.disablehyperthreading<span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>az<span class="w"> </span>vm<span class="w"> </span>restart<span class="w"> </span>-g<span class="w"> </span><span class="o">{</span>ResourceGroup<span class="o">}</span><span class="w"> </span>-n<span class="w"> </span><span class="o">{</span>VM<span class="o">}</span>
</code></pre></div>
<h4 id="q2-azure-vm-instance-metadata"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q2-azure-vm-instance-metadata">Q2: 如何獲取該 Azure VM 的 Instance Metadata?</a></h4>
<p>根據此文 <a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a>，可透過以下方式獲取</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>root<span class="w"> </span><span class="o">[</span><span class="w"> </span>~<span class="w"> </span><span class="o">]</span><span class="c1"># curl -s -H Metadata:true --noproxy &quot;*&quot; &quot;http://169.254.169.254/metadata/instance?api-version=2021-02-01&quot; | jq</span>
</code></pre></div>
<h4 id="q3-eth0-channel"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q3-eth0-channel">Q3: 如果有要調整 eth0 的 channel 大小該怎麼做?</a></h4>
<p>如果你是用 AKS 的使用者，基本上都不用改，預設一開始都弄好了</p>
<p>暫時處理方式，因為這個是暫時性設定，如果該 AKS 節點被移除了，新增節點或既有的節點並不會有這個功能</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>$<span class="w"> </span>ethtool<span class="w"> </span>-L<span class="w"> </span>eth0<span class="w"> </span>combined<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<h4 id="q4-platformsettingshost_environmentdisablehyperthreading-true"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q4-platformsettingshost_environmentdisablehyperthreading-true">Q4: 何時會選擇把 <code>platformsettings.host_environment.disablehyperthreading: true</code> 參數套上去</a></h4>
<p>跑 HPC 高效能計算類型的都蠻適合的，你會需要完整的核心計算能力，譬如說 EDA / 算圖 等</p>
<h4 id="q5-c1000k"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q5-c1000k">Q5: 單台 C1000K 是怎麼算出來的? 預設啥都沒做的狀況下記憶體消耗為何?</a></h4>
<p>Linux 開檔限制主要卡 3 個點，三者缺一不可，以 CBL-Mariner 來看的話，預設值如下所列，故單台最大可開檔數量為 1048576，約 C1000K</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Level</th>
<th style="text-align: center;">Parameters</th>
<th style="text-align: center;">Value</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OS</td>
<td style="text-align: center;">sysctl -n fs.file-max</td>
<td style="text-align: center;">9223372036854775807</td>
<td>當前系統最大可開檔數量</td>
</tr>
<tr>
<td style="text-align: center;">Process</td>
<td style="text-align: center;">sysctl -n fs.nr_open</td>
<td style="text-align: center;">1073741816</td>
<td>單一程序可開檔最大數量，一定要比 hard nofile 大</td>
</tr>
<tr>
<td style="text-align: center;">User</td>
<td style="text-align: center;">ulimit -n</td>
<td style="text-align: center;">1048576</td>
<td>當前使用者可開檔最大數量</td>
</tr>
</tbody>
</table>
<p>維持 1 個 TCP Connection 約略消耗 3.3 KB 的記憶體，故假設全部 1048576 都開起來的話，保持 Long Lived TCP Connection，但都沒傳輸其他東西的話，大概就 3.3 GB = 1048576 * 3.3 KB，但這是理想值，實際上會大一點，由此可知，連線數量的多寡其實還有受限於記憶體的多寡，而非僅受上述的開檔數量限制</p>
<h4 id="q6-1048576-50-tcp-connection-tcp-connection-1-kbs"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q6-1048576-50-tcp-connection-tcp-connection-1-kbs">Q6: 如果 1048576 有 50% 活躍 TCP Connection，每個 TCP Connection 需要傳 1 KB/s 的資料，這樣網卡需要多大?</a></h4>
<p>這個要算頻寬 (Bandwidth)，也就是要算水管的大小，這篇有一個小弟早期常用的表 <a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></p>
<p><img alt="" src="/images/throughput-bandwidth.png" /></p>
<p>[(1048576 TCP Connection * 50% * 1KB/s) / 1024] = 512 MB/s * 8 bits = 4096 Mbps = 4 Gbps</p>
<p>最少你也要有 4 Gbps Bandwidth 才能承受這個量體，而 Azure VM 的網路頻寬是基於 Instance 的選擇不同，而不是看內建網卡的設定 (ethtool eth0)，所以可從 <a href="https://learn.microsoft.com/zh-tw/azure/virtual-machines/dasv5-dadsv5-series">Dasv5 和 Dadsv5 系列</a> 中的 <code>Standard_D4as_v5</code> 的最大網路頻寬 (Max network bandwidth) 可得知為 12500 Mbps，遠大於所需的 4096 Mbps，故這台 Standard_D4as_v5 是可以支援問題所需的資料傳輸量</p>
<p>此外，如果你在 AKS 集群外面有用 UDR 丟給 Azure Firewall 的話，根據 <a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a> 的比較表，你需要選擇 SKU 最小為 Standard (30 Gbps) 或 Premium (100 Gbps)，而不能選 Basic，不然整個頻寬會卡在 250 Mbps</p>
<h4 id="q7-ulimit-n"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#q7-ulimit-n">Q7: 如何調整 ulimit -n 的值?</a></h4>
<p>如果你是用 AKS 的使用者，基本上都不用改，預設一開始都弄好了</p>
<p>如果你是自架作業系統的，就照下面的設定即可</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># 如果沒特別調過的，應該都是 1024 為主，譬如像 RHEL 9.2 和 RHEL 8.8 就是這樣</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="m">1024</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="c1"># 兩者取其低</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>$<span class="w"> </span>vim<span class="w"> </span>/etc/security/limits.conf
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>*<span class="w"> </span>soft<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>*<span class="w"> </span>hard<span class="w"> </span>nofile<span class="w"> </span><span class="m">1048576</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="c1"># 不用 reboot，登出再登入就好</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>$<span class="w"> </span>logout<span class="p">;</span><span class="w"> </span>login
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-n
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="m">1048576</span>
</code></pre></div>
<h3 id="reference"><a class="toclink" href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/#reference">Reference</a></h3>
<ul>
<li><a href="https://lotabout.me/2021/Linux-Available-Memory/">我的内存呢？Linux MemAvailable 如何计算</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/mitigate-se#linux">Guidance for mitigating silicon based micro-architectural and speculative execution side-channel vulnerabilities</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/virtual-network/what-is-ip-address-168-63-129-16">Azure VM Instance instance-metadata-service</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug</a></li>
<li><a href="https://github.com/microsoft/CBL-Mariner">microsoft/CBL-Mariner</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/aks/custom-node-configuration?tabs=linux-node-pools#linux-kubelet-custom-configuration">自訂 Azure Kubernetes Service (AKS) 節點集區的節點設定 - Linux Kubelet 自訂設定</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Control Topology Management Policies on a node</a></li>
<li><a href="https://www.cncf.io/blog/2023/06/13/tuning-emqx-to-scale-to-one-million-concurrent-connections-on-kubernetes/">Tuning EMQX to scale to one million concurrent connections on Kubernetes</a></li>
<li><a href="https://www.emqx.io/docs/en/v4.4/tutorial/tune.html#turn-off-swap">EMQX Linux Kernel Tuning</a></li>
<li><a href="https://blog.pichuang.com.tw/20211112-how-to-sizing-kubernetes-resource-and-infra-resource.html">如何科學地估算 Kubernetes 所需的資源? App 角度篇</a></li>
<li><a href="https://time.geekbang.org/column/article/262085">第315期 | 什么是C10K？如何做到C1000K？</a></li>
<li><a href="https://blog.pichuang.com.tw/20190527-bandwidth-and-throughput.html">Bandwidth &amp; Throughput</a></li>
<li><a href="https://learn.greensoftware.foundation/hardware-efficiency#increasing-device-utilization">Green Software Practitioner - Increasing device utilization</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/firewall/choose-firewall-sku">Choose the right Azure Firewall SKU to meet your needs</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/17/%E6%8F%AA%E7%AB%9Fazure-kubernetes-services-%E7%9A%84%E7%AF%80%E9%BB%9E%E8%83%BD%E4%B8%8D%E8%83%BD%E6%8F%90%E4%BE%9B-c1000k-%E7%9A%84%E8%83%BD%E5%8A%9B%E5%91%A2/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-13 00:00:00">October 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">人家都在抓神奇寶貝，而我在抓 Kubernetes 封包</a></h2>
<blockquote>
<p>Wireshark: Packet Don't Lie.</p>
</blockquote>
<p><img alt="" src="/images/life-is-hard.jpg" /></p>
<p>文章 <a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">永續性軟體工程: 遠端抓封包實錄</a> 提到如何遠端抓單體 VM 封包，那同樣的招數可不可以去抓 Azure Kubernetes Service 特定 Pod 裡面的封包? 答案是可以，搭配 ksniff 來做就好</p>
<!--more-->

<h3 id="kubernetes_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#kubernetes_1">來抓 Kubernetes 封包</a></h3>
<h4 id="_1"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_1">架構圖</a></h4>
<p><img alt="" src="/images/w9.png" /></p>
<ol>
<li>因為我不能直接從家裡連線到 Azure Kuberentes Service，所有操作都需要透過 Bastion VM 進行操作連線，所以需要先用 SSH 連線到 Bastion VM 才能做事</li>
<li>kubectl 一定要能對 Private AKS 操作，不然 ksniff 或程式你都無法部署下去</li>
<li>整張圖我沒提的部分就是 Private AKS 和 VM 的 UDR 設定，但這個太 Azure Networking 先跳過</li>
<li>一如既往，我是強烈建議人人都要有一個 debug container 好去做一些觀落陰的事情，詳見 <a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug</a>，這邊不贅述</li>
</ol>
<h4 id="0-ksniff"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#0-ksniff">0. 安裝 ksniff</a></h4>
<p>請直接參考 <a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a> 文件，另外它的前置作業是要裝 <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a>，務必要把 krew PATH 設定好</p>
<h4 id="1-httpbin-re"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#1-httpbin-re">1. 部署 httpbin-re 服務</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># 確定 kubectl 運作正常且可以連線到 Private AKS</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>cluster-info
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Kubernetes<span class="w"> </span>control<span class="w"> </span>plane<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>CoreDNS<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>Metrics-server<span class="w"> </span>is<span class="w"> </span>running<span class="w"> </span>at<span class="w"> </span>https://dns-aoai.private.eastus2.azmk8s.io:443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1"># 跑一個 http server 服務起來</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/httpbin-re/master/k8s/httpbin-re.yaml
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>deployment.apps/httpbin-re<span class="w"> </span>created
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>service/httpbin-re<span class="w"> </span>created
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="c1"># 確認服務有揭露出來</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>httpbin-rek
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>NAME<span class="w">         </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">    </span>AGE
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>httpbin-re<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.0.133.240<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">8080</span>/TCP<span class="w">   </span>7h26m
</code></pre></div>
<p>主要是要部署一個 HTTP Server，待會要透過 Ksniff 去觀察這個服務的狀況，如果你有其他服務也可以自行替換，這邊就是 Demo 方便</p>
<h4 id="2-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#2-pod">2. 部署陪測用 Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># 部署陪測用 Pod，用順手的就好，或者是你可以考慮用 nicolaka/netshoot</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/pichuang/debug-container/master/debug-container.yaml
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>pod/debug-container<span class="w"> </span>created
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c1"># 測試可以跟 httpbin-re 連線，同 namespace，不同 Pod</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl http://&lt;svc name&gt;/path</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>http://httpbin-re.default.svc:8080<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>&lt;!DOCTYPE<span class="w"> </span>html&gt;
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>&lt;html<span class="w"> </span><span class="nv">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span>&gt;
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>...omit...
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c1"># 測試可以跟 metrics-server 連線，不同 namespace，不同 Pod</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="c1"># kubectl exec --it &lt;debug pod&gt; -- curl --insecure https://&lt;svc name&gt;.&lt;namespace&gt;:&lt;svc port&gt;/path</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--it<span class="w"> </span>debug-container<span class="w"> </span>--<span class="w"> </span>curl<span class="w"> </span>--insecure<span class="w"> </span>https://metrics-server.kube-system.svc:443/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="o">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">  </span><span class="s2">&quot;kind&quot;</span>:<span class="w"> </span><span class="s2">&quot;Status&quot;</span>,
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">  </span><span class="s2">&quot;apiVersion&quot;</span>:<span class="w"> </span><span class="s2">&quot;v1&quot;</span>,
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">  </span><span class="s2">&quot;metadata&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">  </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;Failure&quot;</span>,
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">  </span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/metrics\&quot;&quot;</span>,
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">  </span><span class="s2">&quot;reason&quot;</span>:<span class="w"> </span><span class="s2">&quot;Forbidden&quot;</span>,
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">  </span><span class="s2">&quot;details&quot;</span>:<span class="w"> </span><span class="o">{}</span>,
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">  </span><span class="s2">&quot;code&quot;</span>:<span class="w"> </span><span class="m">403</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="o">}</span>%
</code></pre></div>
<p>關於這個以 Pod 為出發點，服務之間的連線議題，以前有寫過<a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">為什麼我佈署的 Kubernetes 服務不會動!? 個人除錯思路分享</a> 一文，裡面有比較仔細的說明，這邊就不贅述了</p>
<h4 id="3-httpbin-re-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#3-httpbin-re-pod">3. 遠端抓 httpbin-re Pod 的封包</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># 列舉出 httpbin-re Pod 的名稱</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>default<span class="w"> </span>-owide
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>NAME<span class="w">                          </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">     </span>IP<span class="w">            </span>NODE<span class="w">                                </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>debug-container<span class="w">               </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>15m<span class="w">     </span><span class="sb">`</span><span class="m">10</span>.0.129.18<span class="sb">`</span><span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>httpbin-re-866499b564-blc95<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="m">10</span>.0.129.6<span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>httpbin-re-866499b564-xl726<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>7h38m<span class="w">   </span><span class="sb">`</span><span class="m">10</span>.0.129.9<span class="sb">`</span><span class="w">    </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>ksniff-grlzn<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>82s<span class="w">     </span><span class="m">10</span>.0.129.33<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>ksniff-n9ps6<span class="w">                  </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>36m<span class="w">     </span><span class="m">10</span>.0.129.29<span class="w">   </span>aks-agentpool-14864487-vmss000000<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># 透過 ksniff 來抓封包</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; &quot;/bin/bash --login -c &#39;kubectl sniff -n &lt;namespace&gt; &lt;pod name&gt; -p -o -&#39;&quot; | /mnt/c/Program\ Files/Wireshark/Wireshark.exe -k -i -</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span><span class="s2">&quot;/bin/bash --login -c &#39;kubectl sniff -n default httpbin-re-866499b564-xl726 -p -o -&#39;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p>這邊要注意的是 <code>/bin/bash --login -c</code>，因為 SSH 登入的時候吃的 $PATH 預設是不會去吃 ~/.bashrc，可以用 <code>env</code> 驗證看看，所以需要先用 <code>--login</code> 後才能正確咬到 $PATH 裡面的 krew 路徑，其餘就是 pipeline 和 I/O 的串流處理了</p>
<p><img alt="" src="/images/w8.png" /></p>
<p>此外，原先應該要填 Ethernet Header (12 bytes) 的欄位，會變成 <code>Linux cooked capture v2 (SLL_v2)</code>，按照 <a href="https://wiki.wireshark.org/SLL.md">Linux cooked-mode capture (SLL)</a> 的說明，這是一個偽造協議，對分析 Kubernetes 上的服務比較沒什麼影響，因為主要都是看 L3 / L4 層級居多，包含 Pod IP / Pod Port / Service IP / Service Port / Node Port 等，同場加映一下，<a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">
HWCHIU 學習筆記 - Kubernetes 之封包去哪兒</a></p>
<h4 id="4-ksniff-pod"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#4-ksniff-pod">4. 清除 ksniff Pod</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>NAME<span class="w">           </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>ksniff-g4bjz<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11m
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>ksniff-j7gnc<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>ksniff-kxfl5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m54s
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>ksniff-lb4xg<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>6m29s
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>ksniff-n9ps6<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>68m
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>ksniff-sph6l<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>9m17s
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>ksniff-v2vd5<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>14m
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>ksniff-vl627<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>16m
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>$<span class="w"> </span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>ksniff<span class="w"> </span>-A
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-g4bjz&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-j7gnc&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-kxfl5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-lb4xg&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-n9ps6&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-sph6l&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-v2vd5&quot;</span><span class="w"> </span>deleted
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>pod<span class="w"> </span><span class="s2">&quot;ksniff-vl627&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<p>退出的時候看起來是不會順便把 ksniff 的 Pod 移除掉，記得要手動移除，不然會有資源浪費的問題</p>
<h3 id="_2"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#_2">後話</a></h3>
<p>ksniff 沒有參數可以讓我去掐封包大小，沒意外的話，還需要再跳板機多一段 tcpdump pipeline 處理，但這樣就會收到一堆有的沒的封包，還沒想到怎麼用</p>
<h3 id="qa"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#qa">Q&amp;A</a></h3>
<h4 id="q1-red-hat-openshift-container-platform-azure-red-hat-openshift"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#q1-red-hat-openshift-container-platform-azure-red-hat-openshift">Q1: 如果我是 Red Hat OpenShift Container Platform 或 Azure Red Hat OpenShift 的使用者，但權限鎖超嚴的怎麼辦?</a></h4>
<p>這個只能說 Red Hat 一如既往地已經先幫妳整好到 oc 去了，你不用特別裝 ksniff，權限就是照你拿到的 kubeconfig 為主</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$ oc version
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Client Version: 4.12.36
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Kustomize Version: v4.5.7
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>Kubernetes Version: v1.27.3
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>$ oc sniff
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>Usage:
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  sniff pod [-n namespace] [-c container] [-f filter] [-o output-file] [-l local-tcpdump-path] [-r remote-tcpdump-path] [flags]
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>Examples:
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>kubectl sniff hello-minikube-7c77b68cff-qbvsd -c hello-minikube
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>Flags:
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>  -c, --container string                container (optional)
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>  -x, --context string                  kubectl context to work on (optional)
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>  -f, --filter string                   tcpdump filter (optional)
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>  -h, --help                            help for sniff
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>      --image string                    the privileged container image (optional)
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>  -i, --interface string                pod interface to packet capture (optional) (default &quot;any&quot;)
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>  -l, --local-tcpdump-path string       local static tcpdump binary path (optional)
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>  -n, --namespace string                namespace (optional)
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>  -o, --output-file string              output file path, tcpdump output will be redirect to this file instead of wireshark (optional) (&#39;-&#39; stdout)
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>      --pod-creation-timeout duration   the length of time to wait for privileged pod to be created (e.g. 20s, 2m, 1h). A value of zero means the creation never times out. (default 1m0s)
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>  -p, --privileged                      if specified, ksniff will deploy another pod that have privileges to attach target pod network namespace
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>  -r, --remote-tcpdump-path string      remote static tcpdump binary path (optional) (default &quot;/tmp/static-tcpdump&quot;)
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>      --socket string                   the container runtime socket path (optional)
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>      --tcpdump-image string            the tcpdump container image (optional)
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>  -v, --verbose                         if specified, ksniff output will include debug information (optional)
</code></pre></div>
<h3 id="references"><a class="toclink" href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/#references">References</a></h3>
<ul>
<li><a href="https://blog.pichuang.com.tw/20231012-sustainability-remote-capture-packets.html">永續性軟體工程: 遠端抓封包實錄</a></li>
<li><a href="https://github.com/eldadru/ksniff">eldadru/ksniff</a></li>
<li><a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">krew</a></li>
<li><a href="https://blog.pichuang.com.tw/20211129-kubernetes-service-troubleshoot.html">為什麼我佈署的 Kubernetes 服務不會動!? 個人除錯思路分享</a></li>
<li><a href="https://www.hwchiu.com/docs/2021/k8s-tcpdump">Kubernetes 之封包去哪兒</a></li>
<li><a href="https://blog.pichuang.com.tw/20230713-distroless-container-debug.html">當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/13/%E4%BA%BA%E5%AE%B6%E9%83%BD%E5%9C%A8%E6%8A%93%E7%A5%9E%E5%A5%87%E5%AF%B6%E8%B2%9D%E8%80%8C%E6%88%91%E5%9C%A8%E6%8A%93-kubernetes-%E5%B0%81%E5%8C%85/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-10-12 00:00:00">October 12, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/sustainability/" class="md-meta__link">sustainability</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/">永續性軟體工程: 遠端抓封包實錄</a></h2>
<p><img alt="" src="/images/cnsw.png" /></p>
<p>最近因為 10/24 要辦 <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">CNCF Sustainability Week - Taiwan x Green Software Foundation</a> 活動，看了一堆 ESG 相關的治理文章和技術書，因為剛好有些客戶是做跨國生意的，遲早會碰到和被問到這個議題，所以就從比較常接觸網路著手看了一下實務上怎麼做，節能減碳先從少收封包開始</p>
<!--more-->

<h3 id="cncf-sustainability-week-taiwan-x-green-software-foundation"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#cncf-sustainability-week-taiwan-x-green-software-foundation">[活動宣傳] CNCF Sustainability Week - Taiwan x Green Software Foundation</a></h3>
<p>大家知道近年碳排放議題風風火火，從早期不知道在幹嘛的，到歐盟從 2023/10 月試運行<code>碳邊境調整機制 (Carbon Border Adjustment Mechanism, CBAM)</code>，而美國 2024/1/1 要正式實施 <code>清潔競爭法案 (Clean Competition Act, CCA)</code>，要抽碳關稅，目前牌價 55 USD/Kg CO2eq，要用來減少氣候汙染啦(或其他我也不知道的用途?)~</p>
<p>你一定想說這跟技術打工人員啥事，尤其是 Cloud Native 這邊，當你有這個想法的時候，不如就趕快<a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">報名 2023/10/24 線下活動!!!</a>，當天有公司會贊助 Pizza，歡迎來吃東西兼聊天</p>
<h3 id="_2"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_2">緣起</a></h3>
<p>因為我在 Target VM 是用 RHEL 9.2 進行日常工作，沒有 X.org / Gnome 可以用，有時候要在自己電腦上用 Wireshark 看封包要拉來拉去很不節能減碳，所以為了方便自己和確保資料傳輸安全，就拿出 ssh tunnel + linux pipeline 大法來做。這個方式不需要使用 rpcapd，你只要有 sshd + tcpdump 就可以了</p>
<p>但因為 Azure Egress 方向資料傳輸有算費用，還是要精打細算，順便節能減碳，所以才有這篇文章的誕生</p>
<p>預設狀況下，一個 TCP 封包上限是看 Maximum Segment Size (MSS) 正常狀況下上限為 1460 (MTU 1500 - IP Header 20 - TCP Header 20)，先不考慮中間被 MSS clamping，譬如什麼 PPPoE 還是某設備偷改的狀況。若我只是要單純查修網路的話，譬如只是要觀測 TCP Retransmission / Duplicated ACK 等，其實我不需要把全部 Frame 收滿收好才能知道狀況，我只要能收到前段 TCP Header 就可以知道網路行為了，所以預期上只要每個 Frame 收 74 bytes 我就可以觀測狀況了，可以節省 20.45 倍 (1512 / 74) 的網路傳輸和儲存成本</p>
<p>試想如果原先只能監控 1 小時，透過限制 Frame，同樣傳輸和儲存成本，可以監控 20 小時以上，相當具備執行動力</p>
<h4 id="_3"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_3">既有架構圖及要點提示</a></h4>
<p><img alt="" src="/images/w5.png" /></p>
<ul>
<li>a. 內部 WSL2 與外部 Windows 11 環境參數和執行: 因為 WSL 內的環境可以視同於在一台虛擬機上面，包含像 SSH 環境變數、等 PATH 都會跟外部的 Windows 11 不同，故從 WSL2 要對 Windows 11 執行 Wireshark 圖形介面的話，因為預設 WSL2 的 PATH 並沒有跟外部 Windows 11 有相通，所以最快的作法就是要用絕對路徑且 Linux 看得懂 <code>/mnt/c/Program\ Files/Wireshark/Wireshark.exe</code> 執行程式，或者是你把 Windows 11 的那一堆 PATH 塞到 WSL2 也可以</li>
<li>b. 愛用 SSH Key: 這個老梗了，請愛用 <code>ssh-copy-id</code> 實踐免密碼登入；如果要做到零信任的話，就把 AAD Identity 掛進去</li>
<li>c. DNAT: 基於安全控管和成本考量，我用 DNAT 為主；如果要做到零信任的話，應該要用 <code>Azure Bastion</code>，但這環境我自己用而已，我信任我自己</li>
<li>d. tcpdump 需要 root 權限: tcpdump 需要特權才能使用，不然會噴 <code>tcpdump: eth0: You don't have permission to capture on that device</code> 給你看，因為我的 SSH Key 是綁 Normal User，並沒有特別對 root 做什麼設定，我是採用 <code>NOPASSWD: ALL</code> 處理，上班不要學</li>
</ul>
<h4 id="1"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#1">1. 我全都要收下來!!!</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s0 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s0<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p>這個應該是最直覺的做法，但如果你測試的方式有上傳和下載大檔傳輸的時候，保證傳出來超大超胖，不符合本文減碳效益，所以我們需要對這個傳輸進行精煉瘦身，最直覺的方式就是用 tcpdump 內建的參數 <code>-s, --snapshot-length</code> 進行控制，預設狀況下，<code>-s0</code> 是可以收下 252144 bytes，為了相容早期版本的 tcpdump</p>
<h4 id="2-tcp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#2-tcp">2. 單純看 TCP 交握為主</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s74 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s74<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w1.png" /></p>
<p>以 IPv4 + TCP 為例, 一個 Frame 組成如下:</p>
<ul>
<li>Ethernet Header = 14 bytes (112 bits)</li>
<li>IP Header = 20 bytes (160 bits)</li>
<li>TCP Header = 最小 20 bytes (160 bits)，建議 40 bytes (320 bits)，因為 TCP Header 最小算到 Urgent Pointer 是 20 bytes，但是通常都會有一堆 TCP Option 皆在後面，譬如說像 Window Scale、SACK、MSS 都會放在這邊，所以最大可能會到 40 bytes 或超過</li>
<li>TCP Payload 另計</li>
</ul>
<p><img alt="" src="/images/w2.png" /></p>
<p>所以以網路團隊，不考慮觀測 TCP Payload，長期收封包分析 TCP Stream 狀況的話，建議設定個 74 bytes (14 + 20 + 40) 以上，才不會有 TCP Header 被截斷的議題發生，也不會收了一堆 TCP Payload 佔據儲存空間和出站流量。而被截斷的封包內容在 Wireshark 會呈現 <code>Packet Size Limited during capture</code> 這是正常狀況</p>
<h4 id="3-http-header"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#3-http-header">3. 想要看 HTTP Header</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s500 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s500<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w6.png" /></p>
<p>取材至 <a href="https://blog.bytebytego.com/p/how-does-https-work-episode-6">ByteByteGo - How does HTTPS work? (Episode 6)</a></p>
<p>我不會用 http filter 去過濾再收，還是收 tcp 為主，後面用 tcp.stream 過濾。這原因是 filter 單用 http 的話，會看不到 <code>http GET / HTTP1.1</code> 之前的 TCP Handshake 中 SYN / SYNACK / ACK 的狀況，大多數狀況都不是程式沒寫好，都是 TCP 那層被某個防火牆擋掉，但看 L7 或只看 HTTP 會看不出來，如下 No. 448, 449, 450 那三個封包</p>
<p><img alt="" src="/images/w7.png" /></p>
<p>至於 HTTP Header 要多大，我的理解是因服務而定，有些服務或 CDN 會塞一堆 Header 再前面，可以自行調整大小，我這邊就抓一個 500 加減看</p>
<h4 id="4-icmp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#4-icmp">4. 單純看 ICMP 為主</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># ssh &lt;Target username&gt;@&lt;Target IP&gt; -p &lt;Target Port&gt; -i &lt;SSH Private Key if have&gt; sudo tcpdump -U -s98 -w - -i &lt;Target Interface&gt; | wireshark -k -i -</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>ssh<span class="w"> </span>pichuang@localhost.divecode.in<span class="w"> </span>-p<span class="w"> </span><span class="m">5566</span><span class="w"> </span>-i<span class="w"> </span>~/.ssh/wolala-rsa<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-U<span class="w"> </span>-s98<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-i<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>/mnt/c/Program<span class="se">\ </span>Files/Wireshark/Wireshark.exe<span class="w"> </span>-k<span class="w"> </span>-i<span class="w"> </span>-
</code></pre></div>
<p><img alt="" src="/images/w3.png" /></p>
<p>以 IPv4 + ICMP 為例，一個 Frame 組成如下:</p>
<ul>
<li>Ethernet Header = 14 bytes (112 bits)</li>
<li>IP Header = 20 bytes (160 bits)</li>
<li>ICMP Header = 8 bytes</li>
<li>ICMP Data = 最小送出去 56 bytes，ICMP Timestamp 是放在 ICMP Data 裡面的前 8 bytes，但 Wireshark 裡面的 Data 會顯示 48 bytes，但回來的資訊不一定是 56 Bytes 而已，有可能會收到怪怪的封包 (Malformed Packet) 會塞超過這個數字以上</li>
</ul>
<p><img alt="" src="/images/w4.png" /></p>
<p>鑒於以上奇怪的狀況總和，若要收到精簡的 ICMP 封包的話，應該是要設定 98 bytes (14 + 20 + 8 + 56) 以上好一點</p>
<h3 id="_4"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#_4">結論</a></h3>
<ol>
<li>ssh 真的很萬用</li>
<li>收封包限制個 Frame Size 500，可以節省 70% 的消耗，還有不亞於全收 (1512) 的觀測效果</li>
<li>節能減碳，先從參加 <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cncf-sustainability-week-taiwan-x-green-software-foundation/">CNCF Sustainability Week - Taiwan x Green Software Foundation</a> 開始</li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#qa">Q&amp;A</a></h3>
<h4 id="q1-azure-windows-vmrdp"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q1-azure-windows-vmrdp">Q1: 為何不要在 Azure 裡面開 Windows VM，RDP 進去就好?</a></h4>
<p>因為 Windows Server 我不算熟悉，linux 比較香</p>
<h4 id="q2-sustainability-engineering-cloud-native-sustainability"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q2-sustainability-engineering-cloud-native-sustainability">Q2: 永續性軟體工程 (Sustainability Engineering) 還是雲原生永續性 (Cloud Native Sustainability) 這跟我啥關係?</a></h4>
<p>目前來看，反舉牽扯到永續性 (Sustainability) 的議題，最大目標就是要盡可能減少碳足跡，就算會造成效能變慢、或者是延遲增加，都是可以被接受的。以網路來看，就是盡量減少不必要的網路傳輸或負載，它的附帶效益目前看起來就是降低成本、優化既有技術</p>
<h4 id="q3-sustainability"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#q3-sustainability">Q3: Sustainability 等於成本降低?</a></h4>
<p>嚴格來說，不是對等的，為了要去做 Sustainability 可能要在別的地方投資不少，雖然主要看起來都是跟綠電相關。譬如說，原先服務放在老遠的區域，但為了<code>極端化</code>達到永續性工程，降低不必要的網路傳輸，選擇把 CDN 服務全部開起來，這成本就會花在別的地方了。但目前碳關稅有公開牌價可以推算，說不定算一算真的有個黃金交叉，只是我現在沒精算的很清晰</p>
<h3 id="references"><a class="toclink" href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/#references">References</a></h3>
<ul>
<li><a href="https://stackoverflow.com/questions/1097651/is-there-a-practical-http-header-length-limit/6160643#6160643">Is there a practical HTTP Header length limit?</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/aks/concepts-sustainable-software-engineering#reduce-network-traversal-between-nodes">Azure Kubernetes Service (AKS) 中的永續性軟體工程做法</a></li>
<li><a href="https://principles.green/">Green Software Practitioner</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/10/12/%E6%B0%B8%E7%BA%8C%E6%80%A7%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B-%E9%81%A0%E7%AB%AF%E6%8A%93%E5%B0%81%E5%8C%85%E5%AF%A6%E9%8C%84/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-07-13 00:00:00">July 13, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="distroless-container-kubectl-debug"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">當遇到 Distroless Container 除錯要什麼沒什麼該怎麼辦? 你的好朋友 kubectl debug</a></h2>
<p>這篇只有 Red Hat OpenShift 為主的使用者不用看，那個早在 v3.6 好幾年前就弄了一個 <code>oc debug</code> 出來了，但你若是一般 Kubernetes 發行版的，例如 Tanzu Kubernetes Grid 或 Azure Kubernetes Service 等，則可以參考一下此篇作法。主要是會用到 <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a> 和 <a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">kubectl debug</a> 這兩個主要能力，而目前都是在 Kubernetes v1.25 標註 Stable 穩定狀態</p>
<p><img alt="" src="/images/title-kubectl-debug.png" /></p>
<!--more-->

<h3 id="_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#_1">典型狀況</a></h3>
<p>有時候你會遇到一個 Container Images 是採 Distroless 的方式運行，特性是除了程式本身以外，什麼 Shell 都沒有，無法登入進去，或者是你進得去看起來有問題的 Pod 想要進行一些除錯的動作，但剛好沒有裝任何工具可以使用，這時候該怎麼辦呢? 其實你需要要準備一個自己編譯好的 <a href="https://github.com/pichuang/debug-container">debug-container</a> 和學習一下 <code>kubectl debug</code> 的用法</p>
<p>這邊剛好有一個 Azure Kubernetes Service 常見的狀況，就是若想要登入到 CoreDNS Pod 裡面查看 Corefile 的內容，你會發現到它會一直噴 <code>no such file or directory: unknown</code> 之類的錯誤，其實是因為這個 Pod 裡面根本沒有 /bin/bash 或者是 /bin/cat 的指令可以用，可以算是很扎實的 Distroless Container 實務案例</p>
<p><img alt="" src="/images/coredns-error.png" /></p>
<div class="highlight"><span class="filename">before</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>kube-dns
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>coredns-6698ddd997-gx66m<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>coredns-6698ddd997-rxlsl<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>11s
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;0f831ab9a9d243bb196e31d6578b19ea13088cdfeec57fb1953c3021a0463d12&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span>:<span class="w"> </span>stat<span class="w"> </span>/bin/bash:<span class="w"> </span>no<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory:<span class="w"> </span>unknown
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-ti<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>error:<span class="w"> </span>Internal<span class="w"> </span>error<span class="w"> </span>occurred:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>container:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;7b5e958107188e3b7748a27138774775dbcebcb8c6bd178b357d187bda720bc9&quot;</span>:<span class="w"> </span>OCI<span class="w"> </span>runtime<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>failed:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>container<span class="w"> </span>process:<span class="w"> </span>exec:<span class="w"> </span><span class="s2">&quot;cat&quot;</span>:<span class="w"> </span>executable<span class="w"> </span>file<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$PATH</span>:<span class="w"> </span>unknown
</code></pre></div>
<p>下面提供用 <a href="https://github.com/wagoodman/dive">dive</a> 所分析的容器映像檔內容</p>
<p><img alt="" src="/images/dive.png" /></p>
<h3 id="2"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2">2 個前置準備</a></h3>
<ol>
<li>準備一個具備可用 Shell 跟其他除錯用工具的 Ephemeral Container Image，如我自己編譯的 <a href="https://github.com/pichuang/debug-container">pichuang/debug-container:master</a>，基於 CentOS Stream，每日更新，簡單直覺</li>
<li>使用 <code>kubectl debug</code>，確保你的 kubectl 版本是大於 v1.25，目前這個功能是內建在 kubectl 裡面，不需要額外裝 krew plugin 即可使用</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>version<span class="w"> </span>--short
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Client<span class="w"> </span>Version:<span class="w"> </span>v1.27.3
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Kustomize<span class="w"> </span>Version:<span class="w"> </span>v5.0.1
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>Server<span class="w"> </span>Version:<span class="w"> </span>v1.26.3
</code></pre></div>
<h3 id="2_1"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2_1">2 個解決方式</a></h3>
<ol>
<li>使用 <code>--target</code>: 直接對 Target Container 進行操作，常見如 Pod Running 中沒什麼問題，但剛好它是 distroless images，缺少一堆可執行 bin。這時候若你只是想要做一些基本測試，譬如網路測試等，可以考慮使用 <code>--target</code> 方式把自己準備的 Ephemeral Container 掛進去使用，無須特別修改也無須重開</li>
<li>使用 <code>--copy-to</code>: Copy 一份 Pod 出去另外研究，最常見的使用方式，反舉遇到 Completed 或 CrashLoopBackOff 等無法使用 kubectl exec 方式進入的 Pod 且想要知道到底死在那裡，可以掛一個 Ephemeral Container 修改進入點或命令研究看看</li>
</ol>
<h4 id="1-target"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#1-target">1. 使用 <code>--target</code></a></h4>
<p><img alt="" src="/images/target-debug.png" /></p>
<div class="highlight"><span class="filename">target</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">#</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --target=&lt;TARGET CONTAINER NAME&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1">#</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--target<span class="o">=</span>coredns
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Targeting<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;coredns&quot;</span>.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>processes<span class="w"> </span>from<span class="w"> </span>this<span class="w"> </span>container<span class="w"> </span>it<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>because<span class="w"> </span>the<span class="w"> </span>container<span class="w"> </span>runtime<span class="w"> </span>doesnt<span class="w"> </span>support<span class="w"> </span>this<span class="w"> </span>feature.
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-pbsr4.
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>root<span class="w">           </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">762456</span><span class="w"> </span><span class="m">46012</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">07</span>:24<span class="w">   </span><span class="m">0</span>:01<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>root<span class="w">          </span><span class="m">63</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3284</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">07</span>:33<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>root<span class="w">          </span><span class="m">88</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">44708</span><span class="w">  </span><span class="m">3380</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">07</span>:35<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="o">[</span>root@coredns-6698ddd997-gx66m<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/1/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span>errors
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span>ready
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="c1">#</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="c1"># Qeury ephemeralContainerStatuses</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="c1">#</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="c1"># kubectl -n kube-system get pod coredns-6698ddd997-gx66m -o jsonpath=&#39;{range .status.ephemeralContainerStatuses[*]}{.name}{&quot;\t&quot;}{.ready}{&quot;\n&quot;}{end}&#39;</span>
</code></pre></div>
<p>如果要查 Ephmeral Container 的狀態，要從 <code>.status.ephemeralContainerStatuses</code> 查詢，可以得知使用的 image 是什麼，以及是否 Ready 等資訊</p>
<h4 id="2-copy-to"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#2-copy-to">2. 使用 <code>--copy-to</code></a></h4>
<p><img alt="" src="/images/copy-to-debug.png" /></p>
<p>這邊要特別注意的是要把 <code>--share-processes</code> 勾起來，不然預設狀況下 Linux Namespace 是相互隔離的，會看不到原先的 Process</p>
<div class="highlight"><span class="filename">copy-to</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">#</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1"># kubectl -n kube-system debug -it &lt;TARGET POD NAME&gt; --image=&lt;DEBUGGER CONTAINER&gt; --copy-to=&lt;NEW POD NAME&gt;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1">#</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>debug<span class="w"> </span>-it<span class="w"> </span>coredns-6698ddd997-gx66m<span class="w"> </span>--share-processes<span class="w"> </span>--image<span class="o">=</span>ghcr.io/pichuang/debug-container:master<span class="w"> </span>--copy-to<span class="o">=</span>copy-coredns
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>Defaulting<span class="w"> </span>debug<span class="w"> </span>container<span class="w"> </span>name<span class="w"> </span>to<span class="w"> </span>debugger-lkp2m.
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># ps uax</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>USER<span class="w">         </span>PID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="m">65535</span><span class="w">          </span><span class="m">1</span><span class="w">  </span><span class="m">0</span>.1<span class="w">  </span><span class="m">0</span>.0<span class="w">    </span><span class="m">972</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/pause
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>root<span class="w">           </span><span class="m">7</span><span class="w">  </span><span class="m">1</span>.0<span class="w">  </span><span class="m">0</span>.2<span class="w"> </span><span class="m">761944</span><span class="w"> </span><span class="m">41720</span><span class="w"> </span>?<span class="w">        </span>Ssl<span class="w">  </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/coredns<span class="w"> </span>-conf<span class="w"> </span>/etc/coredns/Corefile
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>root<span class="w">          </span><span class="m">21</span><span class="w">  </span><span class="m">0</span>.4<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">12060</span><span class="w">  </span><span class="m">3328</span><span class="w"> </span>pts/0<span class="w">    </span>Ss<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/bin/bash<span class="w"> </span>-l
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>root<span class="w">          </span><span class="m">46</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">47656</span><span class="w">  </span><span class="m">3596</span><span class="w"> </span>pts/0<span class="w">    </span>R+<span class="w">   </span><span class="m">08</span>:27<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>ps<span class="w"> </span>uax
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>.:53<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span>errors
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span>ready
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span>health<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">      </span>lameduck<span class="w"> </span>5s
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="c1">#</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="c1"># Reattach empeheral container</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="c1">#</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>attach<span class="w"> </span>copy-coredns<span class="w"> </span>-c<span class="w"> </span>debugger-lkp2m<span class="w"> </span>-i<span class="w"> </span>-t
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>If<span class="w"> </span>you<span class="w"> </span>dont<span class="w"> </span>see<span class="w"> </span>a<span class="w"> </span><span class="nb">command</span><span class="w"> </span>prompt,<span class="w"> </span>try<span class="w"> </span>pressing<span class="w"> </span>enter.
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="o">[</span>root@copy-coredns<span class="w"> </span>/<span class="o">]</span><span class="c1"># cat /proc/7/root/etc/coredns/Corefile | head -n5</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="c1">#</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="c1"># Check copy-coredns status</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="c1">#</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>coredns
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>copy-coredns<span class="w">                                </span><span class="m">2</span>/2<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>2m29s
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>coredns-6698ddd997-gx66m<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>coredns-6698ddd997-rxlsl<span class="w">                    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>65m
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>coredns-autoscaler-7dbcd7d9c8-pnqtt<span class="w">         </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">            </span><span class="m">0</span><span class="w">                 </span>17h
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="c1">#</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="c1"># Wipe out copy-coredns</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="c1">#</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>repairman@vm-hub:~$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>copy-coredns
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>pod<span class="w"> </span><span class="s2">&quot;copy-coredns&quot;</span><span class="w"> </span>deleted
</code></pre></div>
<h3 id="microsoft-defender-for-cloud"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#microsoft-defender-for-cloud">[插花] Microsoft Defender for Cloud</a></h3>
<p>就在我對 Azure Kubernetes Service 內的 CoreDNS 上下其手的時候...我被寄了封 <code>Security Alert: CoreDNS modification in Kubernetes detected</code>，真...貼心的提醒</p>
<div class="highlight"><span class="filename">Security Alert: CoreDNS modification in Kubernetes detected</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Kubernetes audit log analysis detected a modification of the CoreDNS configuration. The configuration of CoreDNS can be modified by overriding its configmap. While this activity can be legitimate, if attackers have permissions to modify the configmap, they can change the behavior of the cluster&#39;s DNS server and poison it.
</code></pre></div>
<p><img alt="" src="/images/coredns-security-alert.png" /></p>
<h3 id="refereneces"><a class="toclink" href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/#refereneces">Refereneces</a></h3>
<ul>
<li><a href="https://mcr.microsoft.com/en-us/product/cbl-mariner/distroless/base/about">CBL-Mariner Distroless Base</a></li>
<li><a href="https://github.com/pichuang/debug-container">pichuang/debug-container</a></li>
<li><a href="https://xie.infoq.cn/article/4372ef0ba18c49891b295de54">K8S 故障排错新手段：kubectl debug 实战</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">Ephemeral Containers</a></li>
<li><a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#ephemeral-container">Debugging with an ephemeral debug container</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/07/13/%E7%95%B6%E9%81%87%E5%88%B0-distroless-container-%E9%99%A4%E9%8C%AF%E8%A6%81%E4%BB%80%E9%BA%BC%E6%B2%92%E4%BB%80%E9%BA%BC%E8%A9%B2%E6%80%8E%E9%BA%BC%E8%BE%A6-%E4%BD%A0%E7%9A%84%E5%A5%BD%E6%9C%8B%E5%8F%8B-kubectl-debug/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-06-29 00:00:00">June 29, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/container/" class="md-meta__link">container</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="debian-ubuntu"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/">容器基礎映像檔要選 Debian 還是 Ubuntu?</a></h2>
<p>來問問大家一個問題，以 Container Base Images 來說，以 Deb 體系來看，你覺得 Debian 比較安全還是 Ubuntu 比較安全?</p>
<p><img alt="" src="/images/debian-distroless-ubuntu.png" /></p>
<!--more-->

<h3 id="static-analysis"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#static-analysis">容器映像檔的靜態掃描 (Static Analysis) 方式</a></h3>
<p>以現行資安服務掃 Container Images，絕大部分都是以靜態掃描為主 (動態跑沙箱內的請容我先跳過)，掃的方式主要都是看裡面的安裝中套件有沒有使用到有漏洞的套件 (可用 apt list --installed 條列安裝中的套件和版本) 然後對上已知的 CVE Database，以 Harbor 提供的 <a href="https://goharbor.io/docs/2.8.0/install-config/harbor-compatibility-list/#scanner-adapters">Harbor Compatibility List- Scanner Adapters</a>，無論是 clair / sysdig / aqua / trivy 實作招數都是差不多的</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>date
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Thu<span class="w"> </span>Jun<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">23</span>:25:30<span class="w"> </span>CST<span class="w"> </span><span class="m">2023</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>--name<span class="w"> </span>debug<span class="w"> </span>docker.io/library/ubuntu:22.04<span class="w"> </span>/bin/bash
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>root@82f6bb20f606:/#<span class="w"> </span>apt<span class="w"> </span>list<span class="w"> </span>--installed<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>WARNING:<span class="w"> </span>apt<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>have<span class="w"> </span>a<span class="w"> </span>stable<span class="w"> </span>CLI<span class="w"> </span>interface.<span class="w"> </span>Use<span class="w"> </span>with<span class="w"> </span>caution<span class="w"> </span><span class="k">in</span><span class="w"> </span>scripts.
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>Listing...
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>adduser/now<span class="w"> </span><span class="m">3</span>.118ubuntu5<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>apt/now<span class="w"> </span><span class="m">2</span>.4.9<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>base-files/now<span class="w"> </span>12ubuntu4.3<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>base-passwd/now<span class="w"> </span><span class="m">3</span>.5.52build1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>bash/now<span class="w"> </span><span class="m">5</span>.1-6ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>bsdutils/now<span class="w"> </span><span class="m">1</span>:2.37.2-4ubuntu3<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>coreutils/now<span class="w"> </span><span class="m">8</span>.32-4.1ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>dash/now<span class="w"> </span><span class="m">0</span>.5.11+git20210903+057cd650a4ed-3build1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>debconf/now<span class="w"> </span><span class="m">1</span>.5.79ubuntu1<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,local<span class="o">]</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>root@82f6bb20f606:/#<span class="w"> </span>cat<span class="w"> </span>/etc/os-release
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&quot;Ubuntu 22.04.2 LTS&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="nv">NAME</span><span class="o">=</span><span class="s2">&quot;Ubuntu&quot;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">&quot;22.04&quot;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="nv">VERSION</span><span class="o">=</span><span class="s2">&quot;22.04.2 LTS (Jammy Jellyfish)&quot;</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="nv">VERSION_CODENAME</span><span class="o">=</span>jammy
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="nv">ID</span><span class="o">=</span>ubuntu
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="nv">ID_LIKE</span><span class="o">=</span>debian
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&quot;https://www.ubuntu.com/&quot;</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://help.ubuntu.com/&quot;</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="nv">PRIVACY_POLICY_URL</span><span class="o">=</span><span class="s2">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="nv">UBUNTU_CODENAME</span><span class="o">=</span>jammy
</code></pre></div>
<h3 id="cve"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#cve">以作業系統角度條列已知 CVE</a></h3>
<p>可以觀察兩邊的 Security Tracker．選 High 就好</p>
<ol>
<li><a href="https://security-tracker.debian.org/tracker/status/release/stable?filter=1&amp;filter=high_urgency&amp;filter=unassigned_urgency">Debian - Security Bug Tracker</a> 他所有版號都會列出來，buster (10,oldoldstable,LTS) / bullseye (11,oldstable) / bookworm (stable) 三個版本都可以看一下</li>
<li><a href="https://ubuntu.com/security/cves?q=&amp;package=&amp;priority=high&amp;version=jammy&amp;status=">Ubuntu- CVE search results</a> 以 22.04 LTS 為主</li>
</ol>
<p>建議可以看常上 CVE 列表的 linux* 開頭的套件，你會發現到幾個事實</p>
<ol>
<li>無論是 Ubuntu 或 Debian，不是每一個 CVE 標註 High 在上游套件都有被修復，所以你就算 <code>apt update &amp;&amp; apt upgrade</code> 更新到最新版，不一定能會關掉所有 CVE High 的問題</li>
<li>
<p>CVE 會隨你的作業系統 OS 和發布版號 <code>cat /etc/os-release</code> 有下列 4 個不同的呈現結果</p>
<ol>
<li>舊版沒有這個問題，但新版發行版有，譬如 CVE-2023-35829</li>
<li>舊版不修，但新版修了，譬如 CVE-2023-23005</li>
<li>剛發現還不知道怎麼修，譬如 CVE-2023-35827</li>
<li>看起來是沒人想修，譬如 CVE-2020-36694</li>
</ol>
</li>
</ol>
<p>總歸來說，如果你更新到最新的版本，無論是 Debian 還是 Ubuntu 你都還是會有幾個 CVE High 的問題會亮在你的報告上，那怎麼辦? 嚴格來說你也只能等社群某個人幫忙做套件更新，或者是用其他<code>非技術的方式</code>解決，畢竟不是每個 CVE 都能被利用或好利用</p>
<h3 id="_1"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#_1">既然都沒辦法完全修到沒有，那要怎麼選擇?</a></h3>
<p>以現在 2023 這個時間點來說，不如平心而論，主要可以對比兩邊 CVE 的處理反應速度和能不能做 backport (向後移植)</p>
<ul>
<li><a href="https://www.debian.org/security/faq">Debian Security FAQ</a>: 基本上比較偏社群自主運作，你得回報到，或自己捲起手修復，而且有問題修復的時候，按照 <a href="https://www.debian.org/security/faq#version"><code>Q: 套件的版本號表明我仍在運行受漏洞影響的版本！</code></a> 的說法是 <code>A: 我們將安全補丁向後移植到穩定發行版 (Stable Release) 中隨附的套件版本，而不是升級到新版本</code></li>
<li><a href="https://ubuntu.com/security/docker-images">Ubuntu - Long Term Supported OCI Images</a>: 這個因為有 Canonical 後面投人力下去維護，按照 <code>Is the LTS Docker Image Portfolio a free or a commercial offering?</code> 的說法，所以最小 5y LTS 更新，有訂閱買支援的話最長 10y 的安全修補，其實跟 Red Hat / SUSE 銷售模式是大同小異，這種比較有人力做 backport，意思是說現在的 patch 可以回朔到前面的版本去修復</li>
</ul>
<p>故就商用支援來說，Canonical 因為有既有的商業模式支撐他們養工程師，故整體採用風險來說，還相對比 Debian 低一點，更何況 Ubuntu 真的是太多公司 (e.g. Cloud Provider / OEM) 預設有用，無論是有沒有走 Partner Channel 訂閱，或者是 OEM 路線</p>
<h3 id="_2"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#_2">結論</a></h3>
<p>結論來說，如果叫我選擇 Debian 體系的 Container Base Images ，下列提供個人主觀判斷...</p>
<p>準則如下，從商務解到技術解:</p>
<ol>
<li>重視 Security 修復能量</li>
<li>跟著底層作業系統 (Host OS) 選: 因為 Container 是共用 Host OS Kernel，如果剛好你用到的功能有這種偏特定 Kernel 的 lib 或套件，那建議跟著 Host OS 選，如果沒這種需求，還是建議跟著 Host OS 選，其次才選別的</li>
<li>拉最新版本: dockerfile 開頭記得要先 apt update &amp;&amp; apt upgrade</li>
<li>走 Distroless: 裝最少但必須的套件，不要裝多餘套件，但這個需要對 Multi Stage Build 有高度理解的工程團隊才可以選的技術解法</li>
</ol>
<p>順序如下:</p>
<ol>
<li><a href="https://hub.docker.com/_/ubuntu">docker.io/library/ubuntu:22.04</a></li>
<li><a href="https://github.com/GoogleContainerTools/distroless">Distroless 體系</a></li>
<li><a href="https://hub.docker.com/_/debian">docker.io/library/debian:bookworm</a></li>
</ol>
<h3 id="qa"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#qa">Q&amp;A</a></h3>
<h4 id="q1-debian-ubuntu"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q1-debian-ubuntu">Q1: 可是人家說不是 Debian 比較穩定? Ubuntu 比較不穩定?</a></h4>
<p>具體來說，可以先試問自己，何謂<code>穩定</code>的定義? 不常更新的發行版、少人使用的發行版、少漏洞的發行版? 這些都有聽過，但這個跟商務使用上的關係要怎麼掛勾起來，可以用實務面問題來討論，<code>CVE 套件報告就亮在那邊，請問要找誰處理修復?</code></p>
<p>關鍵重點是誰 (Who) 去修，反而不是 CVE Database，因為 CVE 你擋了一個明天還會有下一個，基本上沒什麼特別可以討論，看看今年 2023 才過一半 <a href="https://www.cvedetails.com/browse-by-date.php">CVE 編號已經來到 14141</a>，但誰 (Who) 要提供處理方式是一個很重要的事情，無論是修補 (Fixed) 或者是緩解 (Mitigation)</p>
<h4 id="q2-apt-update-apt-upgrade-cve"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q2-apt-update-apt-upgrade-cve">Q2: 不是按 apt update &amp;&amp; apt upgrade 就可以修補全部 CVE 的東西嗎?</a></h4>
<p>細分來講，套件庫還有分 Ubuntu / Debian 官方收編正式支援的套件庫，和第三方套件庫 (e.g. PPA 或其他掛 apt-repos / dpkg -i) 的安裝，千萬不要期望全部套件都能一發解決的，所以有可能你 CVE 亮半天，有高度機會等到他生命周期結束還是會繼續亮著</p>
<h4 id="q3"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q3">Q3: 我就是不想付錢，但我又要有較高的安全性，怎麼辦?</a></h4>
<p>最佳做法就是 "請持續保持最新版本"，因為現行多數發行版，鮮少會持續 backport 回去到舊有的版本，你如果是思考完全不更新，不代表就是安全，然後就沒你的事了，你只是選擇把技術債留到之後再來處理，中間的時間就是風險所在，需要自行評估</p>
<p>以一個線性開發的模式來看，你想想你以前寫的 code 出問題了，在不具備任何 SLA 商務保證下，你是會修在最新的版本，還是要花大量時間往回修? 維護是需要人力成本的</p>
<h4 id="q4"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q4">Q4: 社群不是都會自動提供修補方式嗎?</a></h4>
<p>社群，是由一堆志願者花時間貢獻或者是有受雇特定公司做限定範圍的事情，漏洞會被修補是因為有別的維護者或公司剛好有這個需求貢獻出來，絕對不是無中生有的</p>
<p>但以前或許你不用想這些套件怎麼來的，畢竟用的人不是大宗，但隨著數位發展的普及性，Linux 和 OpenSource 的採用跟陽光空氣水一樣的自然，進而發生蠻多起開源軟體供應鏈攻擊 (Software Supply Chain Attacks)，各個都是地圖炮等級，看看之前的 NPM、PyPI 的攻擊範圍，還有那個基本上人人都有用到但極少人在乎他到底怎麼誕生的 OpenSSL。嚴重到 2021/5/21 美國總統都簽署行政命令 <a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">Executive Order 14028, “Improving the Nation’s Cybersecurity</a> 進行 SBOM 和 Software Supply Chain 的規範</p>
<h4 id="q5-ubuntu-debian-base-images"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q5-ubuntu-debian-base-images">Q5: 如果用 Ubuntu / Debian 的 Base Images 或相關套件招致攻擊，這個算誰的責任?</a></h4>
<p>使用者責任，風險需自負</p>
<h4 id="q6"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q6">Q6: 我不想要出事的時候自己擔政治責任，那怎麼辦?</a></h4>
<p>風險轉嫁 (a.k.a 找背鍋俠)</p>
<ol>
<li>治本的方式就是找有 SLA 的公司負責，例如 Canonical / Red Hat / SUSE 等等，這些公司都有提供商業支援，但這些都是要付費的，不是免費的</li>
<li>治標的方式就是資安設備用架構面築起強化防護的能力，但還是要花錢</li>
</ol>
<p>不花錢的風險轉嫁...如果知道的人，請留言或私訊教我一下</p>
<h4 id="q7"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q7">Q7: 上述論述適用於單純只是要選擇作業系統上嗎?</a></h4>
<p>是，本文論述不僅限定於在 Base Images 的選擇﹐也可包含單純 Deb 體系的作業系統選擇說明</p>
<h4 id="q8-ubuntu-red-hat-suse"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q8-ubuntu-red-hat-suse">Q8: 敏感一點的問題，Ubuntu / Red Hat / SUSE?</a></h4>
<p>我個人支持投注很多精力在 <code>貢獻 Upstream Open Source Project</code> 的公司上，這才是我認知比較正常的開源生態系，所以要我排的話就是 Red Hat == SUSE &gt; Ubuntu，但這只是我個人的看法，畢竟比較以前常撞到前兩家的人</p>
<h4 id="q9"><a class="toclink" href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/#q9">Q9: 為啥這世界跟以前好像不太一樣?</a></h4>
<p>聽首陳奕迅的歌十年回味一下，我大概是十年多以前接觸 Linux，用最久的版本是 Ubuntu 10.04，老實說當時真心沒這麼複雜，但現在因為採用的人多，整個生態系相當蓬勃，做法也會相對多樣化，所以才會有一票開源專案的治理模式 (Governance)</p>
    <nav class="md-post__action">
      <a href="../../2023/06/29/%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A4%8E%E6%98%A0%E5%83%8F%E6%AA%94%E8%A6%81%E9%81%B8-debian-%E9%82%84%E6%98%AF-ubuntu/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-29 00:00:00">May 29, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kubernetes-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">Kubernetes Probe 類型及實作方式的使用說明與小建議</a></h2>
<p>最近看到一個很有趣的網站 <a href="https://kube-score.com/">kube-score</a>，你把你的 Kubernetes Deployment 丟進去之後，它就會各種無情地跟你說哪裡不好。當中裡面有提到針對 Kubernetes Probe 相關的建議，剛好最近案子有需要特別精算時間，故特別寫了篇文章供大家參考。順便附上一張，從 Bing Creator 提供的 DALL.E 模型所理解到的 Kubernetes livenessProbe、readinessProbe 以及 startupProbe 視覺化的樣子，很像...左納烏能源結晶</p>
<p><img alt="" src="/images/probe-k8s-bg.jpg" /></p>
<!--more-->

<h3 id="tldr"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tldr">TL;DR</a></h3>
<ul>
<li>Kubernetse Probe 類型重要性排序: readinessProbe &gt; livenessProbe &gt; startupProbe</li>
<li>呈上，每一個 Kubernetes Probe 都有各自的 initialDelaySeconds、periodSeconds、successThreshold、failureThreshold、timeoutSeconds 以及 Probe 實作方法可以設定，並不重複</li>
<li>Probe 常見實作方法排序: HTTP Probe &gt; Exec Probe &gt; TCP Socket Probe</li>
</ul>
<h3 id="cloud-native-taiwan-user-group"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#cloud-native-taiwan-user-group">關於 Cloud Native Taiwan User Group</a></h3>
<p>基於 CNCF 治理規範，前陣子將社團拆分成兩個，分別是 <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">Cloud Native Taiwan User Group</a> 和 <a href="">Kubernetes Community Days Taiwan</a></p>
<p>歡迎大家動動手加入一下 CNCF 社群會員，並且點擊加入 (Join)</p>
<p><img alt="" src="/images/cntug-membership.png" /></p>
<p>另外我們 2023/06 有社群活動 <a href="https://community.cncf.io/events/details/cncf-cloud-native-taiwan-user-group-presents-cntug-202306-meetup/">CNTUG 2023/06 Meetup</a>，需透過該系統報名，統計人數，歡迎大家參加</p>
<p>Cloud Native Taiwan User Group 2023/06</p>
<ul>
<li>Kubernetes 伸縮自如的工作負載! -  Phil Huang</li>
<li>Topic Scalable NATS architecture with JetStream - 何秉賢</li>
</ul>
<h3 id="kubernetes-3-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#kubernetes-3-probe">Kubernetes 能設定的 3 種 Probe 類型</a></h3>
<p>基於 Kubernetes 官方文件指出</p>
<table>
<thead>
<tr>
<th>Probe</th>
<th>功能描述</th>
<th>用途</th>
<th>使用場景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Liveness Probe (存活探針)</td>
<td>用於檢測 Pod 是否在運行狀態下</td>
<td>確保應用程序在容器內部運行，如果檢測失敗，Kubernetes 將會終止容器並重新啟動它</td>
<td>這可用於檢測應用程序的異常狀態（例如，當應用程序死掉或處於不正常狀態時），類似於電腦啟動後從外部監控 BMC 確認機器運作正常</td>
</tr>
<tr>
<td>Readiness Probe (就緒探針)</td>
<td>用於檢測 Application 是否準備好接受網路流量</td>
<td>當容器內的應用程序正在啟動或正在進行一些初始化工作時，可以使用 Readiness Probe。當應用程序就緒時，它將返回成功的應答，並且 Kubernetes 可以開始將流量路由到該容器。</td>
<td>持續性服務健康檢查，類似於作業系統運行正常</td>
</tr>
<tr>
<td>Startup Probe (啟動探針)</td>
<td>用於檢測 Pod 的啟動進度</td>
<td>Startup Probe 類似於 Readiness Probe，它用於檢測容器是否正在進行啟動過程。與 Readiness Probe 不同，Startup Probe 可以在應用程序就緒之前執行多次檢測。</td>
<td>App 初始化，類似於電腦啟動的時候會有 BIOS 檢查程序</td>
</tr>
</tbody>
</table>
<p>Liveness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-livenessae14.GIF" /></p>
<p>Readiness Probe
<img alt="" src="https://storage.googleapis.com/gweb-cloudblog-publish/original_images/google-kubernetes-probe-readiness6ktf.GIF" /></p>
<h3 id="probe-3"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#probe-3">每一個 Probe 可以用下列 3 種實作方式進行檢查</a></h3>
<h4 id="http-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#http-probe">HTTP Probe</a></h4>
<p>最大宗的檢查方式，如果 Kubernetes 收到 HTTP Status Code 200 ~ 300 的範圍，則會標註為 Health，反之則會標註為 Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>apiVersion: v1
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>kind: Pod
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>metadata:
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  labels:
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    test: http-probe
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>  name: http-probe
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>spec:
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  containers:
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  - name: http-probe
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    image: k8s.gcr.io/liveness
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    args:
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    - /server
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    livenessProbe:
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>      httpGet:
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        path: /healthz
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        port: 8080
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        httpHeaders:
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        - name: X-Custom-Header
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>          value: Awesome
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>      initialDelaySeconds: 3
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>      periodSeconds: 10
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    readinessProbe:
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>      httpGet:
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        path: /healthz
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        port: 8080
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        httpHeaders:
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        - name: X-Custom-Header
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>          value: Awesome
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>      initialDelaySeconds: 3
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>      periodSeconds: 10
</code></pre></div>
<p>其實很多 Framework 或 Library 內建都有針對這個需求進行實作，可以直接使用</p>
<ul>
<li>Spring Boot: <a href="https://spring.io/blog/2020/03/25/liveness-and-readiness-probes-with-spring-boot">Liveness and Readiness Probes with Spring Boot</a></li>
<li>.NET Core: <a href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks">Health checks in ASP.NET Core</a></li>
<li>Python3: <a href="https://pypi.org/project/flask-healthz/">flask-healthz</a></li>
</ul>
<h4 id="exec-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#exec-probe">Exec Probe</a></h4>
<p>如果 Kubernetes 收到 Exit Code 為 0，則會標註為 Health，反之則會標註為 Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>apiVersion: v1
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>kind: Pod
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>metadata:
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  labels:
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    test: exec-probe
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>  name: exec-probe
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>spec:
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  containers:
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  - name: exec-probe
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    image: k8s.gcr.io/busybox
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    args:
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    - /bin/sh
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    - -c
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    livenessProbe:
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>      exec:
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        command:
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        - cat
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        - /tmp/healthy
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>      initialDelaySeconds: 5
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>      periodSeconds: 10
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    readinessProbe:
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>      exec:
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        command:
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        - cat
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        - /tmp/healthy
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>      initialDelaySeconds: 5
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>      periodSeconds: 10
</code></pre></div>
<h4 id="tcp-socket-probe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#tcp-socket-probe">TCP Socket Probe</a></h4>
<p>如果 Kubernetes 能建立 TCP Establish connection，則會標註為 Health，反之則會標註為 Unhealth</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>apiVersion: v1
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>kind: Pod
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>metadata:
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  name: goproxy
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  labels:
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    app: goproxy
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>spec:
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>  containers:
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>  - name: goproxy
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    image: k8s.gcr.io/goproxy:0.1
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    ports:
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    - containerPort: 8080
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    readinessProbe:
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>      tcpSocket:
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        port: 8080
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>      initialDelaySeconds: 5
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>      periodSeconds: 10
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    livenessProbe:
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>      tcpSocket:
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        port: 8080
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>      initialDelaySeconds: 15
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>      periodSeconds: 20
</code></pre></div>
<h3 id="use-cases"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#use-cases">Use Cases</a></h3>
<table>
<thead>
<tr>
<th>參數</th>
<th>描述</th>
<th>kubernetes 預設值</th>
<th><a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a></th>
<th><a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/helm-charts/helm3/strimzi-kafka-operator/README.md">Strimzi Kafka Operator</a></th>
<th><a href="https://github.com/kubernetes/ingress-nginx/blob/main/deploy/static/provider/cloud/deploy.yaml#L448-L478">kubernetes/ingress-nginx</a></th>
<th><a href="https://github.com/mysql/mysql-operator/blob/trunk/helm/mysql-operator/templates/deployment.yaml#LL60C1-L66C29">mysql/mysql-operator</a></th>
<th><a href="https://github.com/mariadb-operator/mariadb-operator/blob/main/deploy/charts/mariadb-operator/templates/webhook-deployment.yaml#L67-L72">mariadb-operator/mariadb-operator</a></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>livenessProbe.enabled</code></td>
<td>啟用 Liveness probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.initialDelaySeconds</code></td>
<td>初始化 Liveness Probe 前的延遲時間</td>
<td>0</td>
<td>30</td>
<td>10</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.periodSeconds</code></td>
<td>多久量測一次</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.timeoutSeconds</code></td>
<td>多久會超時</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.failureThreshold</code></td>
<td>成功後被視為失敗的探測的最小連續失敗次數</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>5</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>livenessProbe.successThreshold</code></td>
<td>探測失敗後被視為成功的最少連續成功次數</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>livenessProbe HealthCheck</td>
<td>Liveness Probe 探針方式</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.enabled</code></td>
<td>啟用 Readiness Probe</td>
<td>N/A</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td><code>readinessProbe.initialDelaySeconds</code></td>
<td>初始化 Readiness Probe 前的延遲時間</td>
<td>0</td>
<td>5</td>
<td>10</td>
<td>10</td>
<td>1</td>
<td>5</td>
</tr>
<tr>
<td><code>readinessProbe.periodSeconds</code></td>
<td>多久量測一次</td>
<td>10</td>
<td>10</td>
<td>30</td>
<td>10</td>
<td>3</td>
<td>10</td>
</tr>
<tr>
<td><code>readinessProbe.timeoutSeconds</code></td>
<td>多久會超時</td>
<td>1</td>
<td>5</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.failureThreshold</code></td>
<td>成功後被視為失敗的探測的最小連續失敗次數</td>
<td>3</td>
<td>6</td>
<td>N/A</td>
<td>3</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><code>readinessProbe.successThreshold</code></td>
<td>探測失敗後被視為成功的最少連續成功次數</td>
<td>1</td>
<td>1</td>
<td>N/A</td>
<td>1</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>readinessProbe HealthCheck</td>
<td>Readiness Probe 探針方式</td>
<td>N/A</td>
<td>httpGet</td>
<td>httpGet</td>
<td>httpGet</td>
<td>exec</td>
<td>httpGet</td>
</tr>
</tbody>
</table>
<h4 id="nats-operator"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#nats-operator">以 <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> 為例</a></h4>
<p>基於 <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/templates/deployment.yaml#L67-L87">NATS-Operator Deployment</a> 和 <a href="https://github.com/nats-io/k8s/blob/main/helm/charts/nats-operator/README.md">NATS-Operator</a> 預設值，這邊因畫圖解釋方便，有調整了一下參數。故可得以下截取設定</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        livenessProbe:
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>          httpGet:
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>            path: /readyz
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>            port: readyz
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>          initialDelaySeconds: 30
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>          periodSeconds: 10
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>          timeoutSeconds: 5
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>          successThreshold: 6
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>          failureThreshold: 3
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        readinessProbe:
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>          httpGet:
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>            path: /readyz
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>            port: readyz
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>          initialDelaySeconds: 5
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>          periodSeconds: 10
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>          timeoutSeconds: 5
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>          successThreshold: 6
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>          failureThreshold: 2
</code></pre></div>
<h4 id="q1-kubernetes-pod-pod-restarted-unhealthy"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q1-kubernetes-pod-pod-restarted-unhealthy">Q1: 如果程式運行一段時間，然後 Kubernetes 發現 Pod 要 Pod Restarted 或者是標註 Unhealthy 最短時間為何?</a></h4>
<p><img alt="" src="/images/probe-k8s-1.png" /></p>
<p>首先因為程式已經運行一段時間了，所以可以省略 initialDelaySeconds 的時間</p>
<p>故正確的算式為</p>
<ul>
<li>最短重啟 Pod 時間 = (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  ( 3 - 1 ) * 10 + 5 = 25</li>
<li>最短移除 Endpoint List 時間 = (<code>readinessProbe.failureThreshold</code> - 1) * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> =  ( 2 - 1 ) * 10 + 5 = 15</li>
</ul>
<h4 id="q2-pod-restart"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q2-pod-restart">Q2: 如果程式初始運行，然後因為程式裡面沒寫好，導致 Pod Restart 開始執行的最短和最長時間為何?</a></h4>
<p>需要把 <code>livenessProbe.initialDelaySeconds</code> 時間放進去評估</p>
<ul>
<li>最短重啟 Pod 時間 = <code>livenessProbe.initialDelaySeconds</code> + (<code>livenessProbe.failureThreshold</code> - 1) * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + ( 3 - 1 ) * 10 + 5 = 55</li>
<li>最長重啟 Pod 時間 = <code>livenessProbe.initialDelaySeconds</code> + <code>livenessProbe.failureThreshold</code> * <code>livenessProbe.periodSeconds</code> + <code>livenessProbe.timeoutSeconds</code> =  30 + 3 * 10 + 5 = 65</li>
</ul>
<p>兩者時間差其實就是差一個 livenessProbe.periodSeconds 時間</p>
<h4 id="q3-pod-endpoint-list-endponit-list-kubernetes"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q3-pod-endpoint-list-endponit-list-kubernetes">Q3: 如果 Pod 從 Endpoint list 移除了一段時間後，當程式正確運行時，最短需花多少時間可以加回到 Endponit list 加回到 Kubernetes 服務的行列內?</a></h4>
<p><img alt="" src="/images/probe-k8s-2.png" /></p>
<p>主要要看 <code>readinessProbe.successThreshold</code></p>
<ul>
<li>最短恢復服務時間 = <code>readinessProbe.successThreshold</code> * <code>readinessProbe.periodSeconds</code> + <code>readinessProbe.timeoutSeconds</code> = 6 * 10 + 5 = 65</li>
</ul>
<h4 id="q4-readinessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q4-readinessprobe">Q4: 如果沒設定 readinessProbe 會怎樣嗎?</a></h4>
<p>有可能會在 Pod 還沒啟動的時候，流量就 Kubernetes 判斷可以被推進去，或者是 Pod 正在跑停止程序的時候，流量還是被推進去</p>
<h4 id="q5-livenessprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q5-livenessprobe">Q5: 如果沒設定 livenessProbe 會怎樣嗎?</a></h4>
<p>不會怎樣，如果你不知道要設定什麼，不用特別設定，kubelet 會根據 Pod 的 restartPolicy 進行正確的動作。如果有設定的話，盡量不要跟 readinessProbe 檢查同一個地方</p>
<h4 id="q6-startupprobe"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#q6-startupprobe">Q6: 如果沒設定 startupProbe 會怎樣嗎?</a></h4>
<p>不會怎樣，如果你不知道要設定什麼，不用特別設定，可以用拉長 <code>livenessProbe.initialDelaySeconds</code> 互換，startupProbe 的特性是只要成功一次就會換手給 livenessProbe 或 readinessProbe 進行探測</p>
<p>公式為 <code>livenessProbe.initialDelaySeconds</code> 大約等於 <code>startupProbe.initialDelaySeconds</code> + <code>startupProbe.periodSeconds</code> * <code>startupProbe.failureThreshold</code>，可以盡早再初始階段發現服務啟動不了</p>
<h3 id="_1"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#_1">個人小建議</a></h3>
<ul>
<li>
<p>關於 initialDelaySeconds</p>
<ul>
<li>針對 livenessProbe.initialDelaySeconds 特別有用</li>
<li>採用 P99 的啟動時間為主，主要是因為這個數字類同於開機需要多久時間，基本上都相當固定</li>
<li>多數有用 Framework、JVM 等都會有啟動時間的統計可以參考</li>
<li>如果真的抓不準的話，建議上 startupProbe，而不要用 livenessProbe.initialDelaySeconds</li>
</ul>
</li>
<li>
<p>關於 periodSeconds</p>
<ul>
<li>絕大部分的狀況下 10s 相當足夠</li>
<li>如果設定太短，有可能 Pod 只是暫時性很忙來不及回應，他就被歸類在 Failure 的狀態，如果在整體系統都是很忙的狀況下，會導致螺旋式效能下降，能者過勞</li>
<li>如果設定太長，Pod 真的有事情的時候，要很久才會有反應</li>
</ul>
</li>
<li>
<p>關於 timeoutSeconds</p>
<ul>
<li>最大多數抓 periodSeconds/2 或低於的數字</li>
<li>最小為 1s</li>
</ul>
</li>
<li>
<p>關於 failureThreshold</p>
<ul>
<li>建議 3</li>
<li>設定太高，Pod 真的壞掉的時候，導致真的要重啟或移出的時間拉的太長</li>
<li>設定太短，Pod 可能只是暫時很忙的時候，就會過早的重啟或移出，導致螺旋式效能下降，能者過勞</li>
</ul>
</li>
<li>
<p>關於 successThreshold</p>
<ul>
<li>建議 1</li>
<li>針對 readinessProbe.successThreshold 特別有用，livenessProbe.successThreshold 沒什麼特別效果，因為後者會把 Pod 整個重啟掉，故沒有回來的機會</li>
<li>如果 Pod 與其他服務相關服務多的話，可以數字拉大一點，</li>
</ul>
</li>
<li>
<p>關於 livenessProbe</p>
<ul>
<li>因為涉及到重啟 Pod 的能力，故需要保守的設定該項目</li>
<li>檢查僅需僅查自身即可，不應該涉及檢查外部相依性服務</li>
</ul>
</li>
<li>
<p>關於 readinessProbe</p>
<ul>
<li>因為比較偏向服務的 healthcheck，故可以比較寬鬆一點的設定</li>
</ul>
</li>
</ul>
<h3 id="references"><a class="toclink" href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/#references">References</a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">配置存活、就绪和启动探针</a></li>
<li><a href="https://cloud.redhat.com/blog/liveness-and-readiness-probes">Liveness and Readiness Probes</a></li>
<li><a href="https://opensource.com/article/18/3/kubernetes-liveness-readiness-probes">Creating Kubernetes liveness and readiness probes</a></li>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">Kubernetes best practices: Setting up health checks with readiness and liveness probes</a></li>
<li><a href="https://blog.pichuang.com.tw/20221005-k8s-gracefulrestart-pod.html?h=term">實現不停機的 Pod 更新方式</a></li>
<li><a href="https://github.com/zegl/kube-score/blob/master/README_PROBES.md">Readiness and Liveness Probes</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/29/kubernetes-probe-%E9%A1%9E%E5%9E%8B%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E%E8%88%87%E5%B0%8F%E5%BB%BA%E8%AD%B0/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-05-15 00:00:00">May 15, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/kubernetes/" class="md-meta__link">kubernetes</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sig-kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">SIG Kubernetes Scability 多維度分析</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bxY5Q5Eoj0s" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<p>前陣子剛好 Kubecon EU 2023 剛辦完，相關的影片也釋出到 <a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a> 上，共計 314 部，在當災厄林克破壞海拉魯大陸的同時，記得也要不忘持續學習</p>
<!--more-->

<h3 id="kubernetes-communtiy-day-taiwan-2023"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-communtiy-day-taiwan-2023">Kubernetes Communtiy Day Taiwan 2023 剩下一周可以投稿!!!</a></h3>
<p>COSCUP 2023 將至，Cloud Native Taiwan User Group 跟歷年一樣我們也會於 2023/07/29 ~ 2023/07/30 內，舉辦 Kubernetes Communtiy Day Taiwan 2023</p>
<p>目前僅剩一周關閉徵稿，可於  <a href="https://pretalx.coscup.org/coscup-2023/cfp">COSCUP 投稿系統</a> 進行投稿</p>
<ul>
<li>正式投稿開始日期：2023 年 04 月 14 日</li>
<li><code>正式投稿截止日期：2023 年 05 月 22 日</code></li>
<li>通知講者社群軌投稿結果：2023 年 06 月 23 日</li>
</ul>
<p>此外基於 CNCF 社群治理規範，從 KCD Taiwan 將 Communtiy Group 單獨拆分出來，</p>
<ul>
<li>Kubernetes Community Days Taiwan (KCD Taiwan), 基於 <a href="https://github.com/cncf/kubernetes-community-days">Kubernetes Community Days</a> 治理規範，網站為 <a href="https://community.cncf.io/kcd-taiwan/">https://community.cncf.io/kcd-taiwan/</a>，為年度地區活動</li>
<li>Cloud Native Taiwan User Group (CNTUG), 基於 <a href="https://github.com/cncf/communitygroups">CNCF Community groups</a> 治理規範，網站為 <a href="https://community.cncf.io/cloud-native-taiwan-user-group/">https://community.cncf.io/cloud-native-taiwan-user-group/</a>，為例行社群活動</li>
</ul>
<p>歡迎有想要贊助、演講的個人或廠商可以依需求各別討論</p>
<h3 id="kubernetes-scability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#kubernetes-scability">Kubernetes Scability 多維度分析</a></h3>
<p><img alt="" src="/images/scale-1.png" /></p>
<p>Kubernetes Scalabilty 是一個多維度的問題，不單單只是用節點個數來做為衡量唯一基礎，建議參閱 <a href="https://docs.google.com/presentation/d/1aWjxpY4YJ4KJQUTqaVHdR4sbhwqDiW30EF4_hGCc-gI/edit#slide=id.p3">Kubecon 2018 NA - Kubernetes Scalability: A multi-dimensional analysis</a></p>
<p>這邊提幾個我覺得比較重要的</p>
<ul>
<li><code># Nodes v.s. # Pods/node</code>: Nodes 越多、Pod 於單一 Node 上越少，節點越多、Pod 於單一節點上可以越多。個人建議，通常 <code># Pods/Node</code> 是固定的，能動的都是以 <code># Nodes</code> 居多，所以可以固定 <code># Pods/Node</code> 再換算總數</li>
<li><code># Services v.s. # Endpoints/Service</code>: Service 越多、Endpoints/svc 越少，Service 越少，Endpoint/svc 可以越多。個人建議，<code># Endpoints/Service</code> 這個不要超過 250 或不要超過 <code># Pods/node</code> 的上限</li>
<li><code># Service/ns</code>: Service 越多、Namespace 越少，Service 越少、Namespace 可以越多。個人建議，<code># Service/ns</code> 這個不要超過 5000，會有 Pod Crash 的狀況發生</li>
</ul>
<h3 id="2023-slisslos"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#2023-slisslos">2023 SLIs/SLOs 的變化</a></h3>
<p>當年 2015 的其中一條針對 API 呼叫的定義 "99% of all our API calls return in less than 1 second" 因為這句話看的人有各種不一樣的解讀，所以到了今年 2023 就換成下列 2 個更為實際的 SLI / SLO 定義，詳細可以參考這個 <a href="https://github.com/kubernetes/community/commit/6f1cc290b977b1a1f45c5cb7c15132a152e40b8d">Git Diff</a></p>
<details class="info" open="open">
<summary>SLI</summary>
<p>"Latency of processing mutating API calls for single objects for every (resource, verb) pair, measured as 99th percentile over last 5 minutes"
"針對單一物件處理變更 API 呼叫的延遲，對於每一個（資源、動作）配對，以過去 5 分鐘內的第 99 百分位進行測量。"</p>
</details>
<p>這條主要有排除請求在 Queue 中的等待時間，因為沒有辦法預估 Control Plane 的負載狀況，故不考慮這部分的時間消耗</p>
<details class="info" open="open">
<summary>SLO</summary>
<p>"In default Kubernetes installation, for every (resource, verb) pair, excluding virtual and aggregated resources, 99th perccentile per cluster-day &lt;=1s"
"在預設的 Kubernetes 安裝中，對於每一個（資源、動作）配對，排除虛擬和聚合資源，每個集群每天的第 99 百分位延遲應該小於等於 1 秒。"</p>
</details>
<p>其實還有額外官方承認和正在被討論的 SLIs/SLOs，可參考 <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></p>
<ol>
<li>API call latency SLIs/SLOs details</li>
<li>API call extension points latency SLIs details</li>
<li>In-cluster dns latency SLIs/SLOs details</li>
<li>DNS programming latency SLIs/SLOs details</li>
<li>In-cluster network latency SLIs/SLOs details</li>
<li>Network programming latency SLIs/SLOs details</li>
<li>Pod startup latency SLI/SLO details</li>
<li>Watch latency SLI details</li>
</ol>
<h3 id="_1"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_1">可擴展性的已測試範圍</a></h3>
<p><img alt="" src="https://raw.githubusercontent.com/kubernetes/community/master/sig-scalability/configs-and-limits/scalability-envelope.png" /></p>
<p>想要精確地定義可擴展性範圍 (Scalability envelope) 是不可能的，但可以抓到大約且合理的範圍，譬如 <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a> 所列的範圍，裡面將 scope 拆分成 2 個維度: namespace 和 cluster</p>
<p>依我個人理解，一般來說架構師會關心的都是下列這幾個範圍，主要會扯到網路，其他選項要爆掉的機會其實蠻低的，至於各別數字的解讀就因人而異了</p>
<table>
<thead>
<tr>
<th>Quantity</th>
<th>Threshold scope=namespace</th>
<th>Threshold: scope=cluster</th>
</tr>
</thead>
<tbody>
<tr>
<td>#Nodes</td>
<td>n/a</td>
<td>5000</td>
</tr>
<tr>
<td>#Namespaces</td>
<td>n/a</td>
<td>10000</td>
</tr>
<tr>
<td>#Pods</td>
<td>3000</td>
<td>150000</td>
</tr>
<tr>
<td>#Pods per node</td>
<td>min(110, 10*#cores)</td>
<td>min(110, 10*#cores)</td>
</tr>
<tr>
<td>#Services</td>
<td>5000</td>
<td>10000</td>
</tr>
<tr>
<td>#All service endpoints</td>
<td>TBD</td>
<td>TBD</td>
</tr>
<tr>
<td>#Endpoints per service</td>
<td>250</td>
<td>n/a</td>
</tr>
<tr>
<td>#Deployments</td>
<td>2000</td>
<td>TBD</td>
</tr>
</tbody>
</table>
<p>個人經驗上，上面的數字如 Nodes / Pods / Pods per node / Services 都跟要計算出網段要切多少、節點要多少個，可承載多少工作負載量很有關係，所以在規畫的時候務必要相當清楚。</p>
<h3 id="_2"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_2">實際壓測方式</a></h3>
<p>主要壓測工具會用 <a href="https://github.com/kubernetes/perf-tests/">kubernetes/perf-tests</a> 裡面的工具:</p>
<ul>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/cmd/kubemark">Kubemark</a></li>
</ul>
<p>而跑完測試則會產生測試報表可以觀察現況</p>
<p><img alt="" src="/images/scale-2.png" /></p>
<p>每次 Kubernetes Release 都要通過 Peformance 100 nodes / 500 nodes / Correctness 5000 nodes，測試內容都是由 <a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a> 來定義，而報表可以從 <a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">https://testgrid.k8s.io</a> 這邊獲得。今年因為各家預算緊縮，現在送 Kubernetes Code 上去，預設只會跑 Performance 100 Nodes 而已，而大部分的擴展性議題都會出現在規模在超過以後 <a href="https://github.com/kubernetes/community/blob/master/sig-scalability/governance/scalability-regressions-case-studies.md">100 Nodes</a></p>
<h3 id="_3"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#_3">預期改進方向</a></h3>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/flow-control/">Kubernetes v1.20 beta - API Priority &amp; Faireness</a></li>
<li><a href="https://github.com/kubernetes/enhancements/issues/3157">API Streaming Lists</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/pull/114925">Gracefule shutdown</a></li>
<li>Kube-apiserver improvements</li>
<li>Improvements towards supporting higher throughput</li>
</ul>
<h3 id="qa"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#qa">Q&amp;A</a></h3>
<h4 id="q1-kubernetes-sig-autoscaling"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q1-kubernetes-sig-autoscaling">Q1: 與 Kubernetes SIG Autoscaling 差異是?</a></h4>
<details class="note" open="open">
<summary>Note</summary>
<p>Not to confuse with SIG Autoscaling!</p>
</details>
<p>SIG Scalabilty 關心 Kubernetes 整體系統的極限，如果你是負責提供 Kubernetes 安裝建置的或需要基於以 OSS Kubernetes 為基礎的自行維護版本，會需要關心 Scalability 議題
SIG Autoscaling 關心 Horizontal Pod Autoscaling / Vertical Pod Autoscaling / Cluster Autoscaling，如果你只是需要 Kubernetes 上面的程式部署，則僅需要關心 Autoscaling 議題</p>
<h4 id="q2-kubernetes-sig-scalability"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q2-kubernetes-sig-scalability">Q2: Kubernetes SIG Scalability 的主要任務是?</a></h4>
<p>主要頁面於 <a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability SIG (Special Interest Group)</a></p>
<p>5 個主要的工作領域:</p>
<ol>
<li>定義和驅動 (Define &amp; Drive): 定義和驅動可擴展性目標</li>
<li>協調和貢獻 (Coordinate &amp; Contribute): 改進 Performance 更接近目標</li>
<li>監控和量測 (Montior &amp; Measure): 透過監控和量測來確保實際系統行為接近目標</li>
<li>保持和保護 (Preserve &amp; Protect): 確保系統免受可擴展性回歸 (Scalability regressions) 的影響</li>
<li>諮詢和教學 (Consult &amp; Coach): 透過社群協作獲得更多的使用案例和回饋經驗</li>
</ol>
<h4 id="q3-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q3-kubernetes">Q3: Kubernetes 整體壓力測試最大的點在哪裡?</a></h4>
<p>Control Plane</p>
<h4 id="q4-5000"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q4-5000">Q4: 測試節點 5000 是不是上限?</a></h4>
<p>不是，講者說主要卡在測試成本太高，此外多數使用者對此沒有什麼特別期待，正常規畫可以以 100 Nodes 為基礎設計就好</p>
<p>關於用 Azure Kubernetes Service 計算 5000 個節點的計算方式，可以參考之前寫的拙作 <a href="https://blog.pichuang.com.tw/20230214-openai-scaling-kubernetes-to-7500-nodes.html#azure-cni">看 OpenAI 使用鈔能力招喚 Kubernetes 7500 台節點!!!</a>，有詳細的計算過程</p>
<h4 id="q5-kubernetes"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#q5-kubernetes">Q5: 如何量測 Kubernetes 整體的效能? 第一步是?</a></h4>
<p>上 Grafana + Prometheus 會是很好的起步，或者是可以從 <a href="https://landscape.cncf.io/card-mode?category=observability-and-analysis">CNCF Observability</a> 挑出適合的工具。
若想要針對 Observability 有更深入的了解，建議可以參加 <a href="https://github.com/cncf/tag-observability">CNCF TAG (Technical Advisory Group) Observability 🔭⚙️</a></p>
<h3 id="references"><a class="toclink" href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/#references">References</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=bxY5Q5Eoj0s">Intro + Deep Dive: Kubernetes SIG Scalability - Wojciech Tyczynski, Google</a></li>
<li><a href="https://www.youtube.com/watch?v=VTFmsD9odZ4">Intro + Deep Dive: SIG Scalability - Marcel Zięba &amp; Wojciech Tyczyński, Google</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/configs-and-limits/thresholds.md">Kubernetes Scalability thresholds</a></li>
<li><a href="https://github.com/kubernetes/community/tree/master/sig-scalability">Scalability Special Interest Group</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/sig-scalability/slos/slos.md#steady-state-slisslos">Steady state SLIs/SLOs</a></li>
<li><a href="https://github.com/kubernetes/perf-tests/tree/master/clusterloader2">ClusterLoader2</a></li>
<li><a href="https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml">kubernetes/sig-scalability/sig-scalability-periodic-jobs.yaml</a></li>
<li><a href="https://testgrid.k8s.io/sig-scalability-kubemark#Summary">testgrid.k8s.io</a></li>
<li><a href="https://www.youtube.com/playlist?list=PLj6h78yzYM2PyrvCoOii4rAopBswfz1p7">YouTube - KubeCon + CloudNativeCon Europe 2023</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/05/15/sig-kubernetes-scability-%E5%A4%9A%E7%B6%AD%E5%BA%A6%E5%88%86%E6%9E%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-17 00:00:00">April 17, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/sla/" class="md-meta__link">sla</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="composite-slas"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">計算出正確的服務水平協議：探索 Composite SLAs 計算和架構設計</a></h2>
<p>最近這幾周收到幾個想要做 SLA 99.999% 的案子，因涉及的服務眾多，所以故針對如何合理計算 SLA 和其架構設計先做一個紀錄，但這邊並不涉及資料最終一致性和對外網路的設計討論</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3pSue9nm3Bg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<h3 id="tldr"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#tldr">TL;DR</a></h3>
<ol>
<li>相比單一服務 SLA 計算，複合 SLA (Composite SLA) 是更為合理的計算方式</li>
<li>複合 SLA (Composite SLA) 會隨認列範圍不同而有所變化，就算是同一張架構圖</li>
<li>若相依性服務越多，因可能失敗發生點多，則複合 SLA 會必然低於單一服務 SLA</li>
<li>單區域架構提供多個備援作法可小幅提升整體 SLA</li>
<li>多區域架構設計可以大幅提升整體 SLA，至少 2 個區域，至多 3 個區域</li>
</ol>
<!--more-->

<h3 id="kubernetes-communtiy-day-taiwan-2023"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#kubernetes-communtiy-day-taiwan-2023">Kubernetes Communtiy Day Taiwan 2023 開放徵稿!!!</a></h3>
<p>COSCUP 2023 將至，Cloud Native Taiwan User Group 跟歷年一樣我們也會於 2023/07/29 ~ 2023/07/30 內，舉辦 Kubernetes Communtiy Day Taiwan 2023</p>
<p>目前已正式開放徵稿，可於  <a href="https://pretalx.coscup.org/coscup-2023/cfp">COSCUP 投稿系統</a> 進行投稿</p>
<ul>
<li>正式投稿開始日期：2023 年 04 月 14 日</li>
<li>正式投稿截止日期：2023 年 05 月 22 日</li>
<li>通知講者社群軌投稿結果：2023 年 06 月 23 日</li>
</ul>
<p>待投稿結果出爐後，我們也會將相關資訊同步發布至 <a href="https://community.cncf.io/kcd-taiwan/">KCD Taiwan 官方頁面</a></p>
<p>歡迎大家多多參加</p>
<h3 id="sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-composite-sla">單區域內的複合 SLA (Composite SLA) 計算</a></h3>
<p>無論是哪一家廠商所提供給你的 SLA，都是基於一個限定範圍或特定產品內，所訂立的 SLA，但正常狀況下你不太可能只單獨使用一個服務就能撐起全部的對外服務</p>
<p>複合 SLA (Composite SLA) 主要就是將多個服務的不同層級的可用性進行混合計算，分為兩個場景: 有服務相依性和無服務相依性</p>
<h4 id="1-and"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-and">1. AND: 服務之間有相依性</a></h4>
<p><img alt="" src="/images/sla-5.png" /></p>
<p>以上圖為例，若有個對外服務需要同時使用到 Azure Red Hat OpenShift 和 Azure Cosomos DB 存放資料，兩者服務缺一不可，則該 SLA 計算方式為兩者相乘即可，可得該圖 SLA 為 99.94900005%</p>
<ul>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
</ul>
<p>Composite SLA = <mark class="critic">99.94900005%</mark> = 99.95% * 99.999%</p>
<h4 id="2-or"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#2-or">2. OR: 服務之間無相依性</a></h4>
<p><img alt="" src="/images/sla-6.png" /></p>
<p>以上圖為例，若有個對外服務需要同時使用到 Azure Red Hat OpenShift 和 Azure Cosomos DB 存放資料，且多設定 Azure Service Bus 當作 Queue 來使用，即使連線不到 Azure Cosmos DB 時，對外服務還是可以正常運行，但 Azure Cosmos DB 和 Azure Service Bus 同時失效的時候，對外服務就會中斷。</p>
<ul>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
<li>Azure Service Bus: 99.9%</li>
</ul>
<p>針對無相依性服務 Azure Cosmos DB 和 Azure Service Bus 需要優先計算 SLA，</p>
<p>Composite SLA = 99.999999% = 1 - 兩者同時失敗機率 = 1 - ((1 - 99.999%) * (1 - 99.9%))</p>
<p>其次再針對前面必要服務 Azure Red Hat OpenShift 進行相依性計算，故可得:</p>
<p>Total Composite SLA = <mark class="critic">99.949999%</mark> = 99.95% * 99.999999%</p>
<h4 id="_1"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#_1">小結</a></h4>
<table>
<thead>
<tr>
<th>比較</th>
<th>無 Queue</th>
<th>有 Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td>SLA</td>
<td>99.94900005%</td>
<td>99.949999%</td>
</tr>
<tr>
<td>Daily</td>
<td>44s</td>
<td>43s</td>
</tr>
<tr>
<td>Weekly</td>
<td>5m 8.4s</td>
<td>5m 2.4s</td>
</tr>
<tr>
<td>Monthly</td>
<td>22m 10s</td>
<td>21m 44s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1h 6m 30s</td>
<td>1h 5m 12s</td>
</tr>
<tr>
<td>Yearly</td>
<td>4h 26m 1.9s</td>
<td>4h 20m 49s</td>
</tr>
</tbody>
</table>
<p>透過新增 Queue 或其他備援服務，則可以<mark class="critic">小幅度</mark>提升 SLA 的數字</p>
<h3 id="sla-composite-sla_1"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-composite-sla_1">多區域內的複合 SLA (Composite SLA) 計算</a></h3>
<p>如何大幅度提升 SLA? 簡單來說就是跨區域做高可用架構，分散單一區域崩壞風險</p>
<h4 id="1-sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#1-sla-composite-sla">1. 計算單區域內的複合 SLA (Composite SLA)</a></h4>
<p><img alt="" src="/images/sla-3.png" /></p>
<ul>
<li>Azure Load Balancer: 99.99%</li>
<li>Azure Red Hat OpenShift: 99.95%</li>
<li>Azure Cosmos DB: 99.999%</li>
<li>Azure Storage Accounts: 99.99%</li>
</ul>
<p>Composite SLA for Japan East = <mark class="critic">99.929011%</mark> = 99.99% * 99.95% * 99.999% * 99.99%</p>
<p>以單一區域服務來講，99.929011% 已經比常見基本要求 99.9% 來的好不少了，所以對於很多服務來說還算是可以接受的範圍，但如果對於要做出 99.999% 等級服務來講是有相當距離的，故下面來討論提升 SLA</p>
<h4 id="2-sla-composite-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#2-sla-composite-sla">2. 計算多區域內的複合 SLA (Composite SLA)</a></h4>
<ul>
<li>Azure Traffic Manager: 99.99%</li>
<li>Composite SLA for Japan East: 99.929011%</li>
<li>Composite SLA for Japan West: 99.929011%</li>
</ul>
<p><img alt="" src="/images/sla-4.png" /></p>
<p>首先先計算應用程式在所有區域爆炸的機率</p>
<p>應用程式在多個區域合併 SLA 公式為 (1 - (1 - SLA) ^ R)</p>
<ul>
<li>R: 是區域數量</li>
<li>SLA: 是單一區域的 SLA 協議數字</li>
</ul>
<p>故可得知程式佈署在兩個區域時，可獲得下列 SLA 等級</p>
<p>Composite SLA for Azure Red Hat OpenShift in 2 regions = <mark class="critic">99.9999%</mark> = (1 - (1 - 0.99929011)^2)</p>
<p>但因前面需要放置 Azure Traffic Manager 服務確保前置流量能夠兩邊導流，故還需計算，故可得</p>
<p>Totla Composite SLA = <mark class="critic">99.9899%</mark> = 99.99% * 99.99%</p>
<p>這邊有需要討論的地方是有沒有要把 Azure Traffic Manager 列為 SLA 計算範圍內，因為它其實可以放在第三個區域，然後該服務特性，是做 DNS Query，實際上不會影響到，單一區域的運行，但這個因不同使用者認列範圍而異，不然以 Azure Red Hat OpenShift 本身運作下，透過第二個區域的建置，就可以來到 6 個 9 的等級，因高於常聽到 5 個 9，對於維運雙叢集 Kubernetes 運作為目標來講是相當足夠的</p>
<h4 id="_2"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#_2">小結</a></h4>
<table>
<thead>
<tr>
<th>比較</th>
<th>單區域</th>
<th>雙區域</th>
</tr>
</thead>
<tbody>
<tr>
<td>SLA</td>
<td>99.929011%</td>
<td>99.9999%</td>
</tr>
<tr>
<td>Daily</td>
<td>1m 1.3s</td>
<td>0.086s</td>
</tr>
<tr>
<td>Weekly</td>
<td>7m 9.3s</td>
<td>0.6s</td>
</tr>
<tr>
<td>Monthly</td>
<td>30m 51s</td>
<td>2.6s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1h 32m 34s</td>
<td>7.8s</td>
</tr>
<tr>
<td>Yearly</td>
<td>6h 10m 18s</td>
<td>31s</td>
</tr>
</tbody>
</table>
<p>透過新增一個區域的服務，則可以<mark class="critic">大幅度</mark>提升 SLA 的數字</p>
<h3 id="sla-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#sla-sla">以特定 SLA 為目標，單區域所需最低 SLA</a></h3>
<p>以單一區域但不限於其單位 (如服務、個體數、AZ) 所需最低 SLA 計算方式如下:</p>
<p>單一區域所需最低 SLA = (1 - (1 - SLA)^(1/R))</p>
<ul>
<li>R: 是區域數量</li>
<li>SLA: 是預期達到的 SLA 協議數字</li>
</ul>
<p>Makrdown 版:</p>
<table>
<thead>
<tr>
<th>Availability</th>
<th>Target SLA</th>
<th>於 1 個 Region 之下，單 1 Region 最小 SLA 需</th>
<th>於 2 個 Region 之下，單 1 Region 最小 SLA 需</th>
<th>於 3 個 Region 之下，單 1 Region 最小 SLA 需</th>
<th>於 4 個 Region 之下，單 1 Region 最小 SLA 需</th>
</tr>
</thead>
<tbody>
<tr>
<td>2 Nines</td>
<td>99%</td>
<td>99.0000000%</td>
<td>90.0000000%</td>
<td>78.4556531%</td>
<td>68.3772234%</td>
</tr>
<tr>
<td>3 Nines</td>
<td>99.9%</td>
<td>99.9000000%</td>
<td>96.8377223%</td>
<td>90.0000000%</td>
<td>82.2172059%</td>
</tr>
<tr>
<td>3 and a half nines</td>
<td>99.95%</td>
<td>99.9500000%</td>
<td>97.7639320%</td>
<td>92.0629947%</td>
<td>85.0465122%</td>
</tr>
<tr>
<td>4 Nines</td>
<td>99.99 %</td>
<td>99.9900000%</td>
<td>99.0000000%</td>
<td>95.3584112%</td>
<td>90.0000000%</td>
</tr>
<tr>
<td>5 Nines</td>
<td>99.999%</td>
<td>99.9990000%</td>
<td>99.6837722%</td>
<td>97.8455653%</td>
<td>94.3765867%</td>
</tr>
<tr>
<td>6 Nines</td>
<td>99.9999%</td>
<td>99.9999000%</td>
<td>99.9000000%</td>
<td>99.0000000%</td>
<td>96.8377223%</td>
</tr>
<tr>
<td>7 Nines</td>
<td>99.99999%</td>
<td>99.9999900%</td>
<td>99.9683772%</td>
<td>99.5358411%</td>
<td>98.2217206%</td>
</tr>
<tr>
<td>8 Nines</td>
<td>99.999999%</td>
<td>99.9999990%</td>
<td>99.9900000%</td>
<td>99.7845565%</td>
<td>99.0000000%</td>
</tr>
<tr>
<td>9 Nines</td>
<td>99.9999999%</td>
<td>99.9999999%</td>
<td>99.9968377%</td>
<td>99.9000000%</td>
<td>99.4376587%</td>
</tr>
</tbody>
</table>
<p>彩色好讀版:</p>
<p><img alt="" src="/images/sla-2.png" /></p>
<h3 id="qa"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#qa">Q&amp;A</a></h3>
<h4 id="q1-sla-683772234-2-nines"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q1-sla-683772234-2-nines">Q1: 某某個服務超爛，一天會當機七小時以上，約 <a href="https://uptime.is/68.3772234">SLA 68.3772234%</a>，是不是永遠達不到 2 nines?</a></h4>
<p>A1:</p>
<p>以上面計算單一區域所需最低 SLA 計算來說，不考慮資料一致性及網路可達性，你只要在 4 個不同區域建立相同 SLA <a href="https://uptime.is/68.3772234">68.3772234%</a> 服務，最差還是可以拿到 SLA 99% 的等級</p>
<p>但...你應該要做的事情是研究一下為啥一個服務一天會噴掉七小時以上，而不是在這邊算數學</p>
<h4 id="q2-5-9-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q2-5-9-sla">Q2: 為何使用者開頭都說請提供給我 5 個 9 的 SLA 架構設計?</a></h4>
<p>A2:</p>
<p><a href="https://uptime.is/99.999">SLA 99.999%</a> 可接受停機時間如下:</p>
<ul>
<li><mark class="critic">Daily: 0.86s</mark></li>
<li>Weekly: 6s</li>
<li>Monthly: 26s</li>
<li>Quarterly: 1m 18s</li>
<li>Yearly: 5m 13s</li>
</ul>
<p>主要是 Daily 這個數字是剛好低於 1s 的，所以普遍才會有這個理解，基本上要辦到就是一定要做到整體架構不能停機、異地抄寫、網路全球負載、CDN 都要拿出來用，想當然而成本會很高，白話來講就是，這個服務不能掉</p>
<h4 id="q3-99999-sla-99929011"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q3-99999-sla-99929011">Q3: 如果我跟終端客戶簽了一個 99.999% 的 SLA 協議，但我知道自家服務只有算出 99.929011%，這樣可以嗎?</a></h4>
<table>
<thead>
<tr>
<th>Target SLA</th>
<th><a href="https://uptime.is/99.999">99.999%</a></th>
<th><a href="https://uptime.is/99.929011">99.929011%</a></th>
</tr>
</thead>
<tbody>
<tr>
<td>Daily</td>
<td>0.86s</td>
<td>1m 1.3s</td>
</tr>
<tr>
<td>Weekly</td>
<td>6s</td>
<td>7m 9.3s</td>
</tr>
<tr>
<td>Monthly</td>
<td>26s</td>
<td>30m 51s</td>
</tr>
<tr>
<td>Quarterly</td>
<td>1m 18s</td>
<td>1h 32m 34s</td>
</tr>
<tr>
<td>Yearly</td>
<td>5m13s</td>
<td>6h 10m 18s</td>
</tr>
</tbody>
</table>
<p>SLA 只是一紙承諾，若已知中間這麼大的風險，簽下去當然就是得要自己扛的住，不然就是再投注成本把架構持續改善到接近目標</p>
<h4 id="q4-azure"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q4-azure">Q4: 有否 Azure 推薦的多區域架構說明?</a></h4>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/high-availability/reference-architecture-traffic-manager-application-gateway">Multi-region load balancing with Traffic Manager and Application Gateway</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/high-availability/images/high-availability-multi-region-v-9.png" /></p>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/multitenant-saas">Multitenant SaaS on Azure</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/media/multitenant-saas.png" /></p>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/multi-region-sql-server">Multi-region N-tier application</a></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/images/multi-region-sql-server.png" /></p>
<h4 id="q5-azure-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q5-azure-sla">Q5: 有否 Azure SLA 官方清單?</a></h4>
<ul>
<li>好讀版: <a href="https://azurecharts.com/sla">Azure SLA Board</a></li>
<li>官方文件版: <a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">Service Level Agreements (SLA) for Online Services</a></li>
</ul>
<h4 id="q6-azure-sla"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#q6-azure-sla">Q6: 除了 Azure 需要算出 SLA 以外，還有沒有什麼是需要自行考量的?</a></h4>
<p>A6:</p>
<p>有，使用者自己應用程式的 SLA</p>
<p>正確你應該可以提供出去的 SLA 理論上是 <mark class="critic">Composite SLA = 應用程式 SLA * 基礎架構 SLA</mark> 而不是僅提供一方的 SLA 保證</p>
<p>如果程式寫得太爛，例如天天 OOM、Crash、Query 效能太差等等，按照責任劃分，這個是個別使用者應該要自己負責的，而非基礎平台能扛的</p>
<h3 id="referecens"><a class="toclink" href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/#referecens">Referecens</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=3pSue9nm3Bg">Composite SLA V2</a></li>
<li><a href="https://learn.microsoft.com/zh-tw/azure/architecture/framework/resiliency/business-metrics">使用商務計量來設計具復原功能的 Azure 應用程式</a></li>
<li><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">Service Level Agreements (SLA) for Online Services</a></li>
<li><a href="https://azurecharts.com/sla">Azure SLA Board</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/high-availability/reference-architecture-traffic-manager-application-gateway">Multi-region load balancing with Traffic Manager and Application Gateway</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/multi-saas/multitenant-saas">Multitenant SaaS on Azure</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/n-tier/multi-region-sql-server">Multi-region N-tier application</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/04/17/%E8%A8%88%E7%AE%97%E5%87%BA%E6%AD%A3%E7%A2%BA%E7%9A%84%E6%9C%8D%E5%8B%99%E6%B0%B4%E5%B9%B3%E5%8D%94%E8%AD%B0%E6%8E%A2%E7%B4%A2-composite-slas-%E8%A8%88%E7%AE%97%E5%92%8C%E6%9E%B6%E6%A7%8B%E8%A8%AD%E8%A8%88/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-11 00:00:00">April 11, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/o11y/" class="md-meta__link">o11y</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="network-latency-slos-4"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/">如何定義 Network Latency SLOs? 4 個設計原則與百分位數解析</a></h2>
<details class="note" open="open">
<summary>Note</summary>
<p>衡量你想要監控的內容意義，不要只監控您碰巧能夠輕鬆監控的內容</p>
</details>
<p>Service Level Objectives (SLO) 可以讓你清楚的理解現在系統運作的狀況，但它背後的數字代表意義是需要透過一連串的數字統計和計算而得的。而最近無論是設計跨國網路，雲地混合網路，都會遇到一個關鍵元素: <code>Latency</code> 延遲，對於資料傳輸來說，延遲是一個很重要的指標，因此我們需要一個方法來定義這個指標，這篇文章就是要來介紹如何定義 Network Latency SLOs</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lJ8ydIuPFeU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<!--more-->

<h3 id="4"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#4">4 個設計原則</a></h3>
<ol>
<li>單位必須是 <code>milliseconds (ms)</code></li>
<li>建議要呈現 6 個百分位數 (P, Percentile) : <code>P50, P75, P90, P99, P99.9, P99.99</code></li>
<li>除了上述的百分位數，如果要新增新的百分位數，則需要一定要 <code>&gt;= P50</code>，若低於 P50 則沒有意義</li>
<li>SLO Target 需要包含上述最少 2 個百分位數，其中一個必須是 <code>P99</code></li>
</ol>
<h3 id="network-latency-slo"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#network-latency-slo">Network Latency SLO 常見描述</a></h3>
<p>採用百分位數表示法: 於特定服務 X，百分位數 % Latency 在 特定時間區段 P 內 需要小於多少 T ms"</p>
<blockquote>
<p>“Compoents X report that % of latency in PERIOD are served in &lt; T ms”</p>
</blockquote>
<p>在多數狀況來講，Latency 是越低越好 (Lower is Better)，所以後面的判斷式為<code>小於</code>為主</p>
<h3 id="_1"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#_1">百分位數解析</a></h3>
<p>以下列資料集作為範例</p>
<div class="highlight"><span class="filename">data set</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>40, 38, 39.3, 120, 50, 78, 38.1, 37.2, 100, 39, 37, 37.3
</code></pre></div>
<p><img alt="" src="/images/latency-slo.png" /></p>
<h4 id="p50-median"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#p50-median">為何要設定 P50 (中位數, Median)?</a></h4>
<blockquote>
<p>特定時間區段中，100 個數字中，從小到大進行排序，第 50% 數字，以上面 Data Set 為例，P50 = <code>39.15</code>，代表 50% 的 Network Latency 在 39.15ms 以下或更小</p>
</blockquote>
<ol>
<li>適合情境: 適合看全站網路效能下降或上升，整體曲線穩定</li>
<li>不適合情境: 使用者跟你說他<code>現在連線</code>很慢</li>
<li>能夠避免: 非常態分佈狀況 (Non-normal distributions) 和偏差值影響</li>
</ol>
<p><a href="https://learn.microsoft.com/en-us/azure/networking/azure-network-latency">Azure network round-trip latency statistics</a> 其實就是一個最好的範例，下圖提供了於 <code>2022/06 時間 30 天區段 P50 的 Latency 表現</code></p>
<p><img alt="" src="https://learn.microsoft.com/en-us/azure/networking/media/azure-network-latency/azure-network-latency-thmb-july-2022.png" /></p>
<h4 id="p99"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#p99">為何要設定 P99 或更高百分位數?</a></h4>
<blockquote>
<p>特定時間區段中，100 個數字中，從小到大進行排序，第 99% 的數字，以上面 Data Set 為例，P99 = <code>119.98</code>，代表 99% 的 Network Latency 在 119.98ms 以下或更小</p>
</blockquote>
<ol>
<li>適合情境: 貼近使用者當下使用狀況，可以充分反映當前程式設計變化導致的影響，譬如說後端服務寫太慢或效率不好導致很慢</li>
<li>不適合情境: 想要知道全站常態穩定度如何</li>
<li>能夠避免: 常態分佈狀況 (Normal distributions) 導致忽視偏差值狀況</li>
</ol>
<p>常見會看到 P99.9 比較適用於 Application 端，如果你是以 Infra 角度看 P99.9 的話，百分位數越高最佳化成本會超高，譬如說你想要這麼極端降低 Network Latency 和 Jitter 的話，我看大概要光纖直連，或者是中間設備都是超高檔的 Router 和 Switch 可能比較有機會辦到...對 Infra 不太現實</p>
<h4 id="average"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#average">不要使用平均值 (Average)</a></h4>
<details class="note" open="open">
<summary>Note</summary>
<p>平均值 (Average) 不等於 P50 (中位數, Median)</p>
</details>
<p>平均值 (Average) 就是算術平均數，計算方式為一組數字相加，然後再除於這組數字的個數，不能反映當前狀況，因為平均值會受到極端值影響，請用中位數 (P50) 替代</p>
<p>舉例一個極端例子把 Fibonacci Series 列出來，算出來的平均值跟 P50 會有相當大的差距，因受到大數影響，平均值會遠大於 P50。換個白話來講，我、台灣首富、全球首富 3 位平均起來，可以買下一棟 101，相當不準確...</p>
<p>根據 <a href="https://latencytipoftheday.blogspot.com/2014/06/latencytipoftheday-average-random.html">#LatencyTipOfTheDay: Average (def): a random number that falls somewhere between the maximum and 1/2 the median. Most often used to ignore reality.</a>，指出 Average 因介於為最大值 (MAXIMUM) ~ 中位數/2 之間</p>
<p><img alt="" src="/images/fibonacci.png" /></p>
<p>故你老闆或使用者要求你<code>提供某某系統的運行平均狀況</code>，正確來說應該要自行翻譯成<code>提供某某系統的中位數 (P50) 狀況</code> 才是比較正確</p>
<h3 id="_2"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#_2">個人建議</a></h3>
<p>基於 <code>P50, P75, P90, P99, P99.9, P99.99</code>，以 P99 為中央伍</p>
<ul>
<li>如果你是偏向 Infrastructure 監控或者是偏基礎建設的 Administrator，建議可以長期追蹤 P50, P75, P90, P99 這四條的變化，因為這四條的變化，可以反映出你的基礎建設是否穩定</li>
<li>如果你是偏向 Application 監控或者是偏 API 效能的 Developer，建議可以追蹤 P99, P99.9, P99.99 這三條的變化，比較能夠反映出你的程式是否有特殊狀況</li>
<li>上班平時例行報告抓 P50 數字，臨時出事抓 P99 或更高數字比較好理解現在發生啥事</li>
</ul>
<h3 id="qa"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#qa">Q&amp;A</a></h3>
<h4 id="q1-ping-rtt-avg"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#q1-ping-rtt-avg">Q1: 如果我臨時使用 ping 對特定服務做 RTT 量測，那他只有 avg. 呈現，那這樣準嗎?</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$ ping www.microsoft.com.tw
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>PING microsoft.com.tw (20.112.52.29) 56(84) bytes of data.
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=1 ttl=108 time=134 ms
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=2 ttl=108 time=137 ms
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=3 ttl=108 time=139 ms
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>64 bytes from 20.112.52.29 (20.112.52.29): icmp_seq=4 ttl=108 time=137 ms
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>^C
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>--- microsoft.com.tw ping statistics ---
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>4 packets transmitted, 4 received, 0% packet loss, time 10238ms
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>rtt min/avg/max/mdev = 133.904/136.817/138.914/1.855 ms
</code></pre></div>
<p>A1: 以上面的數字來看，他的 P50 是 134，誠如上面講，看 avg. 不準，<code>在網路相對穩定的狀況下，只能說有高度機會平均值近似於 P50</code>，但你用 ping 工具目的不是真的要長期監控數據，主要是臨時網路除錯，譬如說抓爆 ping、或者是臨時收集一下網路狀況，以除錯來講是很好用的，所以大家還是可以加減用用</p>
<h3 id="references-"><a class="toclink" href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/#references-">References-</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/networking/azure-network-latency">Azure network round-trip latency statistics</a></li>
<li><a href="https://latencytipoftheday.blogspot.com/">Latency Tip Of The Day</a></li>
<li><a href="https://www.circonus.com/2018/08/latency-slos-done-right/">Latency SLOs Done Right</a></li>
</ul>
    <nav class="md-post__action">
      <a href="../../2023/04/11/%E5%A6%82%E4%BD%95%E5%AE%9A%E7%BE%A9-network-latency-slos-4-%E5%80%8B%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87%E8%88%87%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B8%E8%A7%A3%E6%9E%90/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/5253671" alt="Phil Huang">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-03-16 00:00:00">March 16, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/openai/" class="md-meta__link">openai</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openai-api"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/">使用 OpenAI API 開發經驗分享</a></h2>
<details class="note" open="open">
<summary>Note</summary>
<p>因 OpenAI 相關技術發展神速，本文有效時間可能不算太長，閱讀後務必要自行再用自身經驗驗證</p>
</details>
<p>很久沒寫 Python，但我本來只是想要研究一下 APM (Application Performance Monitoring) 怎麼順利地跑在 AKS 和 ARO 上，然後就不小心就把 Line Bot ft. OpenAI 寫一寫了，既然寫了就順便紀錄一下</p>
<h3 id="tldr"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#tldr">TL;DR</a></h3>
<ol>
<li>Azure OpenAI Service 和 OpenAI 的 API 呼叫有可能會不一樣，務必要確認</li>
<li>Error Handling 建議要做，不然你永遠只會收到 500 Internal Server Error</li>
<li>私有網路連入方式，唯一選擇 Azure OpenAI Service</li>
</ol>
<!--more-->

<h3 id="azure-openai-service-openai"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#azure-openai-service-openai">Azure OpenAI Service 與 OpenAI 異同之處</a></h3>
<p>基於小弟自行寫過兩邊服務的經驗和對 Azure 熟悉程度，列舉出下列的比較</p>
<table>
<thead>
<tr>
<th>Features</th>
<th>Azure OpenAI Service (AOAI)</th>
<th>OpenAI (OAI)</th>
</tr>
</thead>
<tbody>
<tr>
<td>服務定位</td>
<td>穩定</td>
<td>最新</td>
</tr>
<tr>
<td>API Endpoint</td>
<td>https://{your own endpoint}.openai.azure.com</td>
<td>https://api.openai.com</td>
</tr>
<tr>
<td>SLA</td>
<td><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=1">99.9%</a></td>
<td><a href="https://openai.com/pricing">未來會推出</a></td>
</tr>
<tr>
<td>模型支援</td>
<td>GPT-3.5, DALL-E and Codex (including Codex Fine-Tuning)</td>
<td>GPT-3.5, Codex and DALL-E, ChatGPT API and Whisper API</td>
</tr>
<tr>
<td>Azure 可用區域</td>
<td><a href="https://azure.microsoft.com/en-us/explore/global-infrastructure/products-by-region/?products=cognitive-services&amp;regions=all">3 個</a>, West Europe/South Central US/East US</td>
<td>1 個, US</td>
</tr>
<tr>
<td>主要服務窗口</td>
<td>Microsoft Azure</td>
<td>OpenAI</td>
</tr>
<tr>
<td>客戶支援方式</td>
<td>在地 Azure 團隊</td>
<td>需自行找 OpenAI 團隊</td>
</tr>
<tr>
<td>支援付款方式</td>
<td>使用 MACC (Microsoft Azure Consumption Commitment)</td>
<td>信用卡或其他方式</td>
</tr>
<tr>
<td>Public API Endpoint</td>
<td>可</td>
<td>可</td>
</tr>
<tr>
<td>Public API Endpoint 資安機制</td>
<td>可限定特定 IP 或特定 Subnet 連入</td>
<td>無</td>
</tr>
<tr>
<td>Private API Endpoint</td>
<td>使用 Azure Private Endpoint / Private Link</td>
<td>無</td>
</tr>
<tr>
<td>Security</td>
<td>可沿用 Azure 既有資安服務</td>
<td>需自行處理</td>
</tr>
<tr>
<td>RBAC</td>
<td>採用 Azure Acitve Directory 或自行整合 3rd SSO</td>
<td>OpenAI 自帶 SSO 或自行整合 3rd SSO</td>
</tr>
</tbody>
</table>
<h3 id="_1"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#_1">個人經驗分享</a></h3>
<p>整體架構圖</p>
<p><img alt="" src="/images/openai-bot-arch.png" /></p>
<h4 id="bot"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#bot">Bot 主程式</a></h4>
<p>主要目的是希望能讓 Line 可以串接到 OpenAI API，直接使用 Line 進行對話，目前已實作出下列 3 種方式，主要會針對 2 和 3 以 Python 為主的方式作探討</p>
<ol>
<li>OpenAI API + Nodejs 11</li>
<li>OpenAI API + Python 3.9 + Flask</li>
<li>Azure OpenAI API + Python 3.9 + Flask</li>
</ol>
<p>若以 Python 3 為主的開發語言，你會需要知道下列幾個 Python 相關的資訊，基本上全部都一樣
，要留意 AOAI 跟 OAI 所使用到的 Python SDK <code>目前</code>是同一個</p>
<table>
<thead>
<tr>
<th>DX</th>
<th>Azure OpenAI Service (AOAI)</th>
<th>OpenAI (OAI)</th>
</tr>
</thead>
<tbody>
<tr>
<td>API Framework</td>
<td><a href="https://flask.palletsprojects.com/en/2.2.x/">Flask 2.x</a></td>
<td><a href="https://flask.palletsprojects.com/en/2.2.x/">Flask 2.x</a></td>
</tr>
<tr>
<td>Python Library</td>
<td><a href="https://github.com/openai/openai-python">OpenAI Python Library</a></td>
<td><a href="https://github.com/openai/openai-python">OpenAI Python Library</a></td>
</tr>
<tr>
<td>Line Bot Library</td>
<td><a href="https://github.com/line/line-bot-sdk-python">Line Bot SDK Python</a></td>
<td><a href="https://github.com/line/line-bot-sdk-python">Line Bot SDK Python</a></td>
</tr>
<tr>
<td>Python Version</td>
<td>Python 3.9</td>
<td>Python 3.9</td>
</tr>
<tr>
<td>Python Environment</td>
<td>venv</td>
<td>venv</td>
</tr>
</tbody>
</table>
<p>程式開發上，可以分下列 2 階段:</p>
<ol>
<li>Flask + Line Message API 串接及測試: 這個網路上相當多支援，Line SDK 範例也寫得很清楚，難度不高</li>
<li>
<p>Flask + Azure OpenAI 或 OpenAI 串接及測試: 這個要留意到，<mark class="critic">兩邊所使用的 Funcion、API Endpoint、回傳內容等等都不一樣</mark></p>
<ul>
<li>如果你是以 Azure OpenAI Service 開發為主的，務必要把 Azure OpenAI Studio 所提供的 Playground 先玩過一次，會省下相當多的觀落陰時間</li>
<li>如果你是以 OpenAI Service 開發為主的，就是先看 <a href="https://github.com/openai/openai-cookbook/">OpenAI Cookbook</a> 為主</li>
</ul>
</li>
</ol>
<p>主要都需要注意的地方是在送訊息出去到 AOAI/OAI API Endpoint 的部分，下面提供 2 個寫法上的差異</p>
<div class="highlight"><span class="filename">azure-openai-service.snippet</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="hll"><span class="n">gpt_response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">Completion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="hll">    <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;gpt35&quot;</span><span class="p">,</span>
</span><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="hll">    <span class="n">prompt</span><span class="o">=</span><span class="n">create_prompt</span><span class="p">(</span><span class="n">system_message</span><span class="p">,</span> <span class="n">messages</span><span class="p">),</span>
</span><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="hll">    <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&lt;|im_end|&gt;&quot;</span><span class="p">],</span>
</span><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">)</span>
</code></pre></div>
<div class="highlight"><span class="filename">openai-service.snippet</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="hll"><span class="n">gpt_response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="hll">    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>
</span><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="hll">    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="p">}</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="p">],</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="hll">    <span class="n">stop</span><span class="o">=</span><span class="kc">None</span>
</span><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">)</span>
</code></pre></div>
<p>據我對現行 SDK 和 API 的理解是 OpenAI 會先當前導驗證測試的角色，等使用到大部分的問題都解決了以後，才會下放到 Azure OpenAPI 來做企業級的導入和使用，但因為這技術進展很快</p>
<p>關於 Error Handling，處理這段程式碼的時候，會有超高機率會收到 500 Internal Server Error，有各式各樣的理由會導致出現這個，反舉  InvalidRequestError、APIConnectionError、AuthError 和<mark class="critic">你輸入它覺得不合規的文字</mark>等等，都會吐相同的 HTTP Status 500 給你，詳細可看 <a href="https://github.com/openai/openai-python/blob/main/openai/error.py">error.py</a>，所以建議 Error Handling 要做和上 Logger 紀錄一下</p>
<h4 id="bot_1"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#bot_1">Bot 運行平台及部署方式</a></h4>
<p><img alt="" src="/images/azurewebapp1.png" /></p>
<p>關於運行平台，提供下列參數</p>
<ul>
<li>
<p>Azure Web App Service</p>
<ul>
<li>App Service Plan: <code>B1</code></li>
<li>Operating System: <code>Linux</code></li>
<li>Language: <code>Python 3.9</code></li>
</ul>
</li>
</ul>
<p>如果你是寫 NodeJS 的話，可以直接加開 Application Insight 做 Auto-instrumentation，超...方便(如下圖)，可惜 Python 沒有，要自己寫</p>
<p><img alt="" src="/images/applicationinsight-sample.png" /></p>
<p>關於部署方式，主要採用 GitHub 和 GitHub Actions，自動部署到指定的 Azure Web App Service 上運行，Workflow 會自己產生出來，所以我也就沒有改什麼就上了</p>
<p><img alt="" src="/images/github-actions.png" /></p>
<h3 id="_2"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#_2">下一步?</a></h3>
<ol>
<li>雲地網路整合: 因為只有 Azure OpenAI Service 可以把 API Endpoint 躲在 Private Network 裡</li>
<li>強化 Application Performance Management (APM) 能力: 使用 Azure Application Insight，主要是收集 Metrics 比較好判斷 API 之間呼叫的狀況</li>
<li>容器化: Dockerfile 和 docker-compose 撰寫</li>
<li>部署到 Azure Kubernetes Service / Azure Red Hat OpenShift: 因為這個服務剛好是 Stateless Application 的代表，所以相當適合拿來丟在 K8s 上面搞很多奇怪的 Demo</li>
</ol>
<h3 id="q-a"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q-a">Q &amp; A</a></h3>
<h4 id="q1-flask"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q1-flask">Q1: 為何使用 Flask?</a></h4>
<p>我覺得看起來比較直覺一點，VSCode 原生也支援 Flask Debugger，詳參 <a href="https://code.visualstudio.com/docs/python/tutorial-flask#_run-the-app-in-the-debugger">Flask Tutorial in Visual Studio Code</a>，還我青春，減少觀落陰時間</p>
<h4 id="q2-aoai-oai-flask-app"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q2-aoai-oai-flask-app">Q2: 可不可以將 AOAI 跟 OAI 的呼叫寫在同一個 flask app?</a></h4>
<p>技術上一定可以，但因為 AOAI 跟 OAI 無論是函式、API Endpoint、Parameter、Key Format，其實還是有差異，秉持 KISS 原則，建議 AOAI 寫一個 app，OAI 自己寫一個 app，不要搞得太複雜</p>
<h4 id="q3-model-azure-openai-service-openai"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q3-model-azure-openai-service-openai">Q3: 用同一句文字，同樣的 Model，問 Azure OpenAI Service 跟 OpenAI 會是一樣的結果嗎?</a></h4>
<p>不一樣，如果詠唱 (Prompt) 太短的話，同一個問題問起來會天差地遠，請參考下列範例</p>
<p><img alt="" src="/images/msg-compare.png" /></p>
<h4 id="q4-api-endpoint"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q4-api-endpoint">Q4: 如果我需要 API Endpoint 在私有網路內，要選什麼?</a></h4>
<p>只有 Azure OpenAI Service，因為有支援 Private Link / Private Endpoint，同時之間也有支援跨區域連線的方式，下圖就是一個很典型的設定，Azure OpenAI Service 開在 South Central US，而 Private Endpoint 和 Private Link 則放在 Japan East</p>
<p><img alt="" src="/images/aoai-pel.png" /></p>
<h4 id="q5-api-endpoint-rate-limitquotaauth"><a class="toclink" href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/#q5-api-endpoint-rate-limitquotaauth">Q5: 如果我需要 API Endpoint 在外網，但又要有 Rate Limit、Quota、Auth 等等的管理機制該怎麼辦?</a></h4>
<p>請找 API Management 相關的解決方案，如果你是 Azure 的話就是 Azure API Management 可以規劃使用</p>
    <nav class="md-post__action">
      <a href="../../2023/03/16/%E4%BD%BF%E7%94%A8-openai-api-%E9%96%8B%E7%99%BC%E7%B6%93%E9%A9%97%E5%88%86%E4%BA%AB/">
        Continue reading
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pichuang" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/phil-huang-09b09895" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/@pichuang-tw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="http://speakerdeck.com/pichuang" target="_blank" rel="noopener" title="speakerdeck.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M213.86 296H100a100 100 0 0 1 0-200h132.84a40 40 0 0 1 0 80H98c-26.47 0-26.45 40 0 40h113.82a100 100 0 0 1 0 200H40a40 40 0 0 1 0-80h173.86c26.48 0 26.46-40 0-40zM298 416a120.21 120.21 0 0 0 51.11-80h64.55a19.83 19.83 0 0 0 19.66-20V196a19.83 19.83 0 0 0-19.66-20H296.42a60.77 60.77 0 0 0 0-80h136.93c43.44 0 78.65 35.82 78.65 80v160c0 44.18-35.21 80-78.65 80z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.copy", "content.code.annotate", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.path", "navigation.sections", "navigation.indexes", "navigation.expand", "navigation.prune", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "header.autohide"], "search": "../../assets/javascripts/workers/search.1e90e0fb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8e8db93a.min.js"></script>
      
    
  </body>
</html>